{


"2021-12-16-frontend-developer-html": {
"title": "Frontend Developer",
"lang": "pl",
"tags": "frontend pogadajmy",
"content": "Ostatnio ktoÅ› mnie zapytaÅ‚ o naszÄ… ofertÄ™ na Frontend Developera sÅ‚owami â€œTo co, robicie stronki?â€.Czy Frontend Developer w Consdata robi stronki? #takÅ¼etego ğŸ˜€KorzystajÄ…c z okazji, chciaÅ‚bym przybliÅ¼yÄ‡ trochÄ™ projekty, ktÃ³rymi siÄ™ zajmujemy i opowiedzieÄ‡, jak wyglÄ…da przeciÄ™tny sprint frontend/fullstack developera. PrzeÅ‚om roku to dla wielu moment postanowieÅ„ i zmian - moÅ¼e poniÅ¼szy opis to impuls, ktÃ³rego wÅ‚aÅ›nie szukasz? ğŸ˜‰Frontend developer, czyli kto?Czym wÅ‚aÅ›ciwie zajmuje siÄ™ frontend developer w Consdata? JeÅ¼eli obstawiaÅ‚eÅ›, Å¼e praca na froncie to gÅ‚Ã³wnie pisanie CSSkÃ³w to muszÄ™ CiÄ™ rozczarowaÄ‡ (albo uspokoiÄ‡, rÃ³Å¼nie ludzie na to patrzÄ… ğŸ˜‰). Wielu naszych developerÃ³w moÅ¼e przez caÅ‚e sprinty nie dotykaÄ‡ HTMLa czy CSSÃ³w, a nadal byÄ‡ pewnym, Å¼e robiÄ… zadania na froncie.JakieÅ› 15 lat temu Å›wiat byÅ‚ prosty. Jak siÄ™ chciaÅ‚o mieÄ‡ aplikacjÄ™ web to zapewne byÅ‚a to statycznie generowana strona HTML+CSS podparta backendem i jakÄ…Å› formÄ… budowania HTMLa po stronie serwera. Wtedy wiÄ™kszoÅ›Ä‡ z nas ignorowaÅ‚a caÅ‚y obszar frontu, zostawiajÄ…c to komuÅ› kto jest â€œgdzieÅ›â€ i zajmuje siÄ™ takimi rzeczami. Dobrze byÅ‚o, jak ktoÅ› od frontu byÅ‚ w ogÃ³le na miejscu, rÃ³wnie czÄ™sto mogÅ‚a byÄ‡ to osoba spoza firmy wskakujÄ…ca na praktycznie gotowy fragment systemu. Powiedzmy, Å¼e â€œktoÅ› pÃ³Åºniej wpadnie zrobiÄ‡ CSSkiâ€ ğŸ˜‰Kolejne kilka lat i okazaÅ‚o siÄ™, Å¼e Å›wiat nie koÅ„czy siÄ™ na uÅ¼ytkownikach oglÄ…dajÄ…cych biaÅ‚e ekrany w oczekiwaniu na zaÅ‚adowanie kolejnej strony. CzÄ™Å›Ä‡ z nas odkryÅ‚a, Å¼e w przeglÄ…darce da siÄ™ wykonaÄ‡ kod i istnieje coÅ› takiego jak JavaScript. OczywiÅ›cie na naukÄ™ nowych rzeczy szkoda nam byÅ‚o czasu, a JavaScript coÅ› podobnie brzmi jak Java i radoÅ›nie wskoczyliÅ›my w GWT. Niby to fronty ale jednak w wiÄ™kszoÅ›ci programiÅ›ci Java nie specjalnie przejmowali siÄ™ czy to Swing, czy GWT, w koÅ„cu autorzy postarali siÄ™ o zbliÅ¼one API i wszystko byÅ‚o po staremu. Frontendowiec nadal byÅ‚ gdzieÅ› obok, tylko miaÅ‚ trudniej. Trudniej uruchomiÄ‡, trudniej ogarnÄ…Ä‡ strukturÄ™, trudniej dopisaÄ‡ wstawkÄ™ w JSie. Nadal moÅ¼na byÅ‚o funkcjonowaÄ‡ w modelu â€œktoÅ› pÃ³Åºniej wpadnie zrobiÄ‡ CSSkiâ€ ğŸ˜‰Zapewne domyÅ›lasz siÄ™ jaki jest efekt takiego podziaÅ‚u? Backend developerzy produkujÄ… coÅ›, co nie jest do koÅ„ca tym czym miaÅ‚o byÄ‡, a frontend developerzy radzÄ… sobie z tym jak mogÄ…, osiÄ…gajÄ…c jedynie fragment jakoÅ›ci potencjalnego rozwiÄ…zania. Brak komunikacji, zrozumienia potrzeb i ograniczeÅ„ â€œdrugiej stronyâ€ wprost prowadzi do systemÃ³w niskiej jakoÅ›ci. Z obu stron â€œcoÅ› wyszÅ‚oâ€ i jakoÅ› trzeba to zgraÄ‡ w ramach QA ğŸ˜‰To co, do trzech razy sztuka? Za trzecim podejÅ›ciem w koÅ„cu pogodziliÅ›my siÄ™, Å¼e z tematem naleÅ¼y siÄ™ zmierzyÄ‡ i nie taki diabeÅ‚ straszny jak go malujÄ…. Obecnie aplikacje webowe mogÄ… mieÄ‡ znacznie wiÄ™cej kodu niÅ¼ wspierajÄ…ce je usÅ‚ugi. Od rozbudowanego backendu ze szczÄ…tkowym UI dochodzimy do miejsca, w ktÃ³rym to UI jest rozbudowany, a usÅ‚ugi sÄ… upraszczane i sÅ‚uÅ¼Ä… jedynie zaspokojeniu potrzeb frontu.ZÅ‚oÅ¼onoÅ›Ä‡ aplikacji doprowadziÅ‚a nawet do dalszego rozrÃ³Å¼niania specjalizacji!  programista (java/type/coffe/â€¦)script, frontend developer,  programista ui,Tak, to te stanowiska potocznie nazywane frontendem i backendem frontendu. Dinozaury z serwerowymi korzeniami nie odpuszczajÄ… Å‚atwo swoich nazw stanowisk ğŸ˜‰Skuteczny frontend developer Å‚Ä…czy nie tylko te dwie funkcje, ale teÅ¼ potrafi siÄ™gnÄ…Ä‡ gÅ‚Ä™biej i pracowaÄ‡ z backendem. Takie holistyczne podejÅ›cie pozwala mu swobodnie podejmowaÄ‡ decyzje dÄ…Å¼Ä…ce do optymalnej realizacji oraz Å›wiadomie wybieraÄ‡ konkretne rozwiÄ…zania, znajÄ…c ich konsekwencje i zalety. DziÄ™ki temu swobodnie Å¼ongluje technikami backendu i frontendu, Å¼eby osiÄ…gnÄ…Ä‡ zamierzony efekt i nigdy nie da sobie powiedzieÄ‡ â€œtak musi byÄ‡â€ czy â€œnie da siÄ™ inaczejâ€. Mimo lekkiego tonu, warto jednak zapamiÄ™taÄ‡ tÄ™ myÅ›l, bo zdarza siÄ™, Å¼e znajÄ…c tylko jednÄ… stronÄ™ rÃ³wnania dÄ…Å¼ymy do rozwiÄ…zywania wszystkiego znanymi sobie narzÄ™dziami. Tak jak ten cieÅ›la, ktÃ³ry majÄ…c mÅ‚otek wszÄ™dzie widzi gwoÅºdzie, tak i nam zdarzyÅ‚o siÄ™ wszÄ™dzie widzieÄ‡ fabryki obiektÃ³w zamiast po prostu zmieniÄ‡ interfejs DTO ğŸ˜‰OdpowiedzialnoÅ›ci Frontend developera w Å›wiecie Full-StackÃ³wCzyli muszÄ™ znaÄ‡ UI, architekturÄ™ aplikacji i jeszcze backend? PrzecieÅ¼ mamy teÅ¼ full-stackÃ³w, to jaka jest rÃ³Å¼nica?Bycie full-stackiem oznacza bycie wszechstronnym i zdolnym do podjÄ™cia wszystkich wyzwaÅ„ stawianych przed zespoÅ‚em (w uproszczeniu, bo taki wÄ…tek poboczny zdominowaÅ‚by caÅ‚y wpis, a juÅ¼ byÅ‚em goÅ›ciem podcastu na ten temat ğŸ™‚).To znaczy, Å¼e w zaleÅ¼noÅ›ci od specjalizacji i zainteresowaÅ„, full-stack swobodnie porusza siÄ™ we froncie w zakresie pracy, nazwijmy to, uÅ¼ytkowej. UmiejÄ™tnoÅ›Ä‡ rozwoju zastanego kodu, realizacja tematÃ³w o znanym sposobie rozwiÄ…zania czy okazjonalne rozwiÄ…zywanie problemÃ³w z gatunku x-files, o ile szalenie waÅ¼na dla samodzielnoÅ›ci zespoÅ‚u, nadal nie zapewnia kompletu kompetencji.Frontend developer to osoba specjalizujÄ…ca siÄ™ w tworzeniu aplikacji web. Potrafi wyznaczyÄ‡ dÅ‚ugoterminowÄ… roadmapÄ™ rozwoju, okreÅ›liÄ‡ kierunek technologiczny i dobraÄ‡ najlepsze rozwiÄ…zania do napotkanych problemÃ³w. W gestii frontend developera jest dbanie o ciÄ…gÅ‚y rozwÃ³j technologiczny, budowanie rozwiÄ…zaÅ„ referencyjnych i wskazywanie innym sposobu pracy tam, gdzie koÅ„czÄ… siÄ™ znane przykÅ‚ady i rozwiÄ…zania.To, czego moÅ¼emy nauczyÄ‡ siÄ™ z krÃ³tkiej historii frontendu z poczÄ…tku artykuÅ‚u to to, Å¼e silne rozdzielanie odpowiedzialnoÅ›ci i stawianie jasnej granicy miÄ™dzy frontend a backend developerami nie jest najlepszym pomysÅ‚em. Dlatego frontend-developer w Consdata w praktyce jest stanowiskiem zbieÅ¼nym z full-stackiem, jednak o nacisku poÅ‚oÅ¼onym na czÄ™Å›Ä‡ â€œponad RESTemâ€. Tak jak od full-stacka oczekujemy, Å¼e poradzi sobie z typowymi tematami frontu, tak samo liczymy, Å¼e frontendowiec nie bÄ™dzie siÄ™ czuÅ‚ zagubiony przy przeciÄ™tnych zagadnieniach backendu.Zrozumienie obu stron problemu jest kluczowe w zapobieganiu przerzucania siÄ™ â€œu mnie dziaÅ‚aâ€ (ew. unikania sytuacji â€œszach mat frontendowcyâ€ ;)).Ok, nie CSSki, to co?PadÅ‚o juÅ¼ wiele okrÄ…gÅ‚ych zdaÅ„ prÃ³bujÄ…cych opisowo wytÅ‚umaczyÄ‡ kontekst i motywacjÄ™, pora zatem na kilka reprezentatywnych przykÅ‚adÃ³w typowych zadaÅ„.  Rozbudowa aplikacji o wspÃ³Å‚dzielony pomiÄ™dzy komponentami stan:          integracja biblioteki NgRx z aplikacjÄ… Angular,      przygotowanie konfiguracji lokalnej i produkcyjnej,      referencyjna implementacja obsÅ‚ugi stanu w jednym z moduÅ‚Ã³w funkcjonalnych,      wypracowanie utili i wytycznych okreÅ›lajÄ…cych zalecany sposÃ³b implementacji i dobre praktyki,      przedstawienie implementacji zespoÅ‚om i wskazanie materiaÅ‚Ã³w poszerzajÄ…cych wiedzÄ™.        Wsparcie rÃ³wnolegÅ‚ej pracy wielu uÅ¼ytkownikÃ³w nad pojedynczym elementem domeny:          zbudowanie mechanizmu wprowadzania zmian sterowanego zdarzeniami,      przygotowanie synchronizacji delt zmian klient-serwer,      podsystemu redukowania zdarzeÅ„ do projekcji bieÅ¼Ä…cego stanu po stronie aplikacji klienckiej,      propagowanie wiedzy i edukacja zespoÅ‚u w zakresie wykorzystania rozwiÄ…zania.        MoÅ¼liwoÅ›Ä‡ rozbudowy aplikacji rozszerzeniami funkcjonalnymi dostarczanymi przez klienta w runtime:          okreÅ›lenie api i specyfikacji osadzania webcomponentÃ³w,      implementacja Å‚adowania i obsÅ‚ugi cyklu Å¼ycia komponentÃ³w klienta,      rekomendacje i wspÃ³Å‚praca w budowaniu gateway dla webcomponentÃ³w z uwzlÄ™dnieniem modelu uprawnieÅ„,      przygotowanie przykÅ‚adÃ³w komponentÃ³w w oparciu o LitElement,      eksponowanie elementÃ³w UI aplikacji nadrzÄ™dnej jako webcomponenty dostÄ™pne dla komponentÃ³w rozszerzeÅ„.        Budowanie kreatora wieloetapowej akceptacji operacji asynchronicznych:          przygotowanie generycznego mechanizmu wieloetapowej akceptacji na wiele rÄ…k,      referencyjna implementacja funkcjonalnoÅ›ci potwierdzania paczek transakcji,      uogÃ³lnienie kodu na potrzeby przyszÅ‚ych funkcjonalnoÅ›ci i przygotowanie funkcjonalnych prototypÃ³w Storybook.        Komponent tworzenia wiadomoÅ›ci oferujÄ…cy funkcjonalnoÅ›Ä‡ formatowania treÅ›ci:          opracowanie komponentu edytora WYSIWYG z przykÅ‚adami w UI guideline,      wykorzystanie komponentu na ekranie tworzenia wiadomoÅ›ci,      integracja wysyÅ‚ki z istniejÄ…cÄ… usÅ‚ugÄ…Â REST z uwzglÄ™dnieniem praktyk UI/UX i optymistycznego potwierdzania operacji.      I tak dalej. To tylko kilka z przykÅ‚adÃ³w kompetencji i umiejÄ™tnoÅ›ci ktÃ³rych szukamy u osÃ³b specjalizujÄ…cych siÄ™ w obszarze Frontend Developer.Czym moÅ¼na siÄ™ zajÄ…Ä‡ w Consdata?W Consdata, w zaleÅ¼noÅ›ci od zespoÅ‚u, moÅ¼esz pracowaÄ‡ przy jednej lub kilku z naszych kluczowych aplikacji web. W kolejnych punktach przejrzymy razem co, i w jakiej skali, budujemy dla naszych klientÃ³w.W zaleÅ¼noÅ›ci od wybranego projektu, pojawiajÄ…ce siÄ™ w nim wyzwania bÄ™dÄ… bliÅ¼ej domeny lub stosowanej technologii.Projekty Consdata z uwzglÄ™dnieniem charakterystyki nacisku na domenÄ™ lub technologiÄ™iBiznesiBiznes to zÅ‚oÅ¼ony system bankowoÅ›ci elektronicznej do obsÅ‚ugi klienta korporacyjnego. GÅ‚Ã³wnym wyznacznikiem projektu jest jego zÅ‚oÅ¼onoÅ›Ä‡ biznesowa.Mimo Å¼e dziedzina stanowi gÅ‚Ã³wne wyzwanie, to jednak nie brakuje w nim wyzwaÅ„ technologicznych, takich jak np. wielomoduÅ‚owa architektura zbudowana z myÅ›lÄ… o niezaleÅ¼nych wdroÅ¼eniach obszarÃ³w funkcjonalnych, rÃ³wnoczesna praca wielu klientÃ³w nad pojedynczymi obiektami domeny czy optymalizacja z badaniami UX/UI i dbanie o czytelnoÅ›Ä‡ zÅ‚oÅ¼onych biznesowo operacji.JeÅ¼eli szukasz wyzwania w projekcie, ktÃ³ry skupia siÄ™ na domenie i jego zÅ‚oÅ¼onoÅ›Ä‡ leÅ¼y w implementowanych funkcjonalnoÅ›ciach, to iBiznes jest wÅ‚aÅ›nie dla Ciebie!iBiznes w liczbach to ~300k linii kodu TypeScript i ~30k linii SASS samego frontendu napisanego w Angularze!MailboxSkÅ‚aniasz siÄ™ bardziej w stronÄ™ cutting edge technologii, o ktÃ³rych tyle sÅ‚yszysz na konferencjach? TwÃ³j wzrok powinien paÅ›Ä‡ na projekty Mailbox. Nie da siÄ™ mÃ³wiÄ‡ o Mailbox nie mÃ³wiÄ…c o skali! Codzienna komunikacja z milionami klientÃ³w uczy nowego spojrzenia na nawet najprostsze problemy (zdziwiÅ‚byÅ› siÄ™ ile daje optymalizacja aktualizacji licznika nieprzeczytanych wiadomoÅ›ci o, w praktyce, nieograniczonej liczbie uÅ¼ytkownikÃ³w).UdziaÅ‚ w projekcie Mailbox oferuje zrÃ³wnowaÅ¼onÄ… dawkÄ™ zÅ‚oÅ¼onoÅ›ci biznesowej i wyzwaÅ„ technologicznych.Dodatkowym atutem jest moÅ¼liwoÅ›Ä‡ pochwalenia siÄ™ znajomym i rodzinie co siÄ™ ostatnio robiÅ‚o, wystarczy, Å¼e sÄ… klientami jednego z naszych klientÃ³w, a Å¼e klienci duzi to i szansa na bycie ich klientem spora ğŸ˜‰~45k linii TypeScript z ~8k linii SASS stojÄ…cych na froncie przed klastrem Kafki i Solara brzmi kuszÄ…co? Mailbox jest dla Ciebie!EximeePraca z domenÄ… CiÄ™ nie krÄ™ci? Zawsze od tematÃ³w biznesowych bardziej krÄ™ciÅ‚y CiÄ™ wyzwania czysto technologiczne?MoÅ¼e warto spojrzeÄ‡ na nasz system obsÅ‚ugi wnioskÃ³w i procesÃ³w? Eximee na kaÅ¼dym kroku projektowane jest jako framework, z ktÃ³rego nasi klienci korzystajÄ… budujÄ…c wÅ‚asne rozwiÄ…zania biznesowe.W Eximee nigdy nie ma jednego sÅ‚usznego rozwiÄ…zania problemu, wszystko jest warunkowe, â€œzaleÅ¼yâ€ i â€œoczywiÅ›cie, Å¼e moÅ¼na zrobiÄ‡ inaczejâ€. PodstawÄ… pracy jest, z jednej stronie naginanie tego co zaÅ‚oÅ¼yli twÃ³rcy, a z drugiej projektowanie systemu podatnego na naginanie. Skala systemu leÅ¼y w jego generycznoÅ›ci i rozszerzalnoÅ›ci. Samo Eximee jest uruchomione w kilkunastu wariantach wdroÅ¼eniowych u rÃ³Å¼nych klientÃ³w, czÄ™sto w wielu kanaÅ‚ach rÃ³wnolegle!Wszystko to sprawia, Å¼e Eximee to gÅ‚Ã³wnie wyzwanie technologiczne i poligon nowych rozwiÄ…zaÅ„ testowanych u klientÃ³w w publicznie dostÄ™pnych systemach!Ale to nie wszystko, w projekcie budujemy teÅ¼ narzÄ™dzia graficznego projektowania procesÃ³w i wnioskÃ³w, obsÅ‚ugi backoffice i inne. Poznaj potrzeby systemu speÅ‚niajÄ…cego oczekiwania od klienta, przez obsÅ‚ugÄ™ backoffice, po pracÄ™ programistÃ³w oraz projektantÃ³w tworzÄ…cych biznesowe rozwiÄ…zania oparte o dostarczanÄ… przez Ciebie platformÄ™.Twoi znajomi pewnie juÅ¼ korzystali z systemu ktÃ³ry tworzysz, zapewne nie raz ğŸ˜‰ByÄ‡ moÅ¼e Eximee z ~250k linii TypeScript i ~130k linii SASS frameworku to coÅ› dla Ciebie.Consdata OSSGdy nabierzesz ochoty na eksperymenty, prototypu i ogÃ³lnie luÅºniejsze podejÅ›cie, zawsze moÅ¼esz zaplanowaÄ‡ swÃ³j czas na rozwÃ³j lub budÅ¼et chapterowy na wsparcie jednego z naszych projektÃ³w open source skupionych na GitHub: https://github.com/orgs/Consdata/repositories.Tylko z nazwy warto wspomnieÄ‡ o:  kouncil - ui do Kafki zbudowany na bazie doÅ›wiadczeÅ„ naszych i naszych klientÃ³w,  sonarqube-companion - agregat naruszeÅ„ SonarQube rozumiejÄ…cy strukturÄ™ zespoÅ‚Ã³w i Å›ledzÄ…cy trendy analizy statycznej,  inne narzÄ™dzia jak logger, aplikacje intranetowe do newsletterÃ³w, rezerwacji parkingu, czy Å›ledzenia feedbacku i zbierania ankiet.W Open Source nie ograniczamy siÄ™ Å¼adnymi wytycznymi, to nasze poligony. Firebase? Angular czy React? Node czy Java? Spring czy Quarkus? Nie ma znaczenia! Zrealizuj funkcjonalnoÅ›Ä‡ i powiedz innym jak poszÅ‚o.DoÅ‚Ä…czysz?Czujesz, Å¼e frontend to moÅ¼e byÄ‡ miejsce dla Ciebie? ZainteresowaÅ‚ CiÄ™ ktÃ³ryÅ› z naszych projektÃ³w? Czujesz, Å¼e podoÅ‚asz? Chcesz uczestniczyÄ‡ w wyznaczaniu architektury i projektowaniu aplikacji web z szerokiego portoflio?SprawdÅº nasze oferty, u nas kaÅ¼dy znajdzie coÅ› dla siebie ğŸ˜‰Prowadzimy obecnie rekrutacjÄ™ na stanowisko Frontend Developer. Poszukujemy osÃ³b biegÅ‚ych w tworzeniu aplikacji web, ktÃ³re pomogÄ… nam wyznaczyÄ‡ dalszy kierunek rozwoju i rozpÄ™dziÄ‡ toczÄ…ce siÄ™ juÅ¼ zmiany w naszych aplikacjach. Kluczowa jest dla nas wiedza z poziomu projektowania aplikacji, wierzymy, Å¼e braki w tworzeniu komponentÃ³w czy jedynie ogÃ³lne wyczucie â€œtych backendÃ³wâ€ to tematy, nad ktÃ³rymi moÅ¼emy juÅ¼ pracowaÄ‡ razem.JeÅ›li tylko czujesz siÄ™ na siÅ‚ach, a w backendzie chociaÅ¼ â€œwiesz co piszczyâ€, to nie czekaj dÅ‚uÅ¼ej, daj mi siÄ™ zaprosiÄ‡ na rozmowÄ™ rekrutacyjnÄ… ;)https://consdata.com/pl/kariera/trwajace-rekrutacje/poznan/senior-frontend-fullstack-developer-angularPS. JeÅ›li masz jakiekolwiek pytania - nie wahaj siÄ™ znaleÅºÄ‡ mnie LinkedIn i pisaÄ‡ w dowolnej sprawie.",
"url": "/2021/12/16/frontend-developer.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2021-12-17-frontend-developer/frontend.webp",
"date": "16-12-2021",
"path": "pl/2021-12-17-frontend-developer"
}
,


"2021-12-07-json-vs-jsonb-postgresql-html": {
"title": "Czy wiesz czym rÃ³Å¼niÄ… siÄ™ json i jsonb w PostgreSQL?",
"lang": "pl",
"tags": "PostgreSQL",
"content": "Podstawowe rÃ³Å¼nicePodstawowÄ… rÃ³Å¼nicÄ… pomiÄ™dzy json a jsonb jest sposÃ³b ich przechowywania. Typ json jest przechowywany jako tekst, natomiast typ jsonb w postaci binarnej. Typ, na jaki siÄ™ zdecydujemy, json czy jsonb, ma wpÅ‚yw na kilka czynnikÃ³w:  zapis danych w postaci jsonb trwa dÅ‚uÅ¼ej,  operacje wykonywane na typie jsonb trwajÄ… krÃ³cej, gdyÅ¼ nie trzeba ich dodatkowo parsowaÄ‡.Ze sposobu przechowywania wynikajÄ… kolejne rÃ³Å¼nice. Zobaczmy poniÅ¼szy przykÅ‚ad:SELECT &#39;{&quot;c&quot;:0, &quot;a&quot;:2,&quot;a&quot;:1}&#39;::json, &#39;{&quot;c&quot;:0, &quot;a&quot;:2,&quot;a&quot;:1}&#39;::jsonb;          json          |        jsonb------------------------+--------------------- {&quot;c&quot;:0,   &quot;a&quot;:2,&quot;a&quot;:1} | {&quot;a&quot;: 1, &quot;c&quot;: 0}  Json zachowuje formatowanie - dlatego w przykÅ‚adzie widaÄ‡ spacje przed kluczem a, natomiast jsonb nie zachowuje formatowania - usuwa whitespaceâ€™y.  Json pozwala dodawaÄ‡ powielone klucze (w przykÅ‚adzie widaÄ‡, Å¼e klucz â€œaâ€ wystÄ™puje 2 razy), natomiast jsonb zachowuje tylko ostatniÄ… wartoÅ›Ä‡.  Json zachowuje kolejnoÅ›Ä‡ kluczy, natomiast jsonb przechowuje posortowane alfabetycznie klucze.  Jsonb przechowuje obiekty w postaci binarnej, natomiast json przechowuje dane jako tekst.  Jsonb pozwala zakÅ‚adaÄ‡ indexy na kluczach.Operatory wspierane tylko przez jsonbW celu zobrazowania dodatkowych operatorÃ³w dla typu jsonb, zacznijmy od utworzenia prostej tabeli, ktÃ³rÄ… wykorzystamy w przykÅ‚adachCREATE TABLE orders (    id serial NOT NULL PRIMARY KEY,    data jsonb NOT NULL);oraz zainicjujmy jÄ… prostymi danymi w formacie json.INSERT INTO orders (data) VALUES (&#39;{ &quot;customer&quot;: &quot;Anna Kowalczyk&quot;, &quot;items&quot;: {&quot;product&quot;: &quot;Pieluchy&quot;,&quot;qty&quot;: 24} }&#39;),    (&#39;{ &quot;customer&quot;: &quot;Zofia WiÅ›niewska&quot;, &quot;items&quot;: {&quot;product&quot;: &quot;Zabawka samochÃ³d&quot;,&quot;qty&quot;: 1} }&#39;),    (&#39;{ &quot;customer&quot;: &quot;Wojciech Nowak&quot;, &quot;items&quot;: {&quot;product&quot;: &quot;Klocki LEGO&quot;,&quot;qty&quot;: &quot;1&quot;}, &quot;regular_customer&quot;: true}&#39;),    (&#39;{ &quot;customer&quot;: &quot;Jan Kowalski&quot;, &quot;items&quot;: {&quot;product&quot;: &quot;Piwo&quot;,&quot;qty&quot;: 6}}&#39;);Operator @&amp;gt; pozwala na sprawdzenie, czy json zawiera na tym poziomie pole wraz z podanÄ… wartoÅ›ciÄ….SELECT (data -&amp;gt; &#39;items&#39;) @&amp;gt; &#39;{&quot;qty&quot;: 6}&#39; from orders;  contains----------fffOperator ? pozwala na sprawdzenie, czy json posiada okreÅ›lone pole. Przydatne, jeÅ›li jsony nie trzymajÄ… siÄ™ restrykcyjnie okreÅ›lonego schematu i obiekty mogÄ… posiadaÄ‡ rÃ³Å¼ne zestawy pÃ³l.SELECT data ? &#39;regular_customer&#39; from orders;  field_exists----------fftfPoza tym typ jsonb wspiera kilka operatorÃ³w, ktÃ³re pozwalajÄ… na skutecznÄ… modyfikacjÄ™ jsonÃ³w trzymanych w bazie.  || - Pozwala zÅ‚Ä…czyÄ‡ ze sobÄ… dwa obiekty typu jsonb w jeden nowy obiekt typu jsonb, przykÅ‚adowo dodaÄ‡ nowe wartoÅ›ci do istniejÄ…cej tablicy.  -  - Pozwala na usuniÄ™cie pary klucz-wartoÅ›Ä‡ lub teÅ¼ okreÅ›lonego elementu z tablicy, przykÅ‚adowo â€˜[â€œaâ€, â€œbâ€]â€™::jsonb - 1. ZwrÃ³ci to tablicÄ™ zawierajÄ…cÄ… wyÅ‚Ä…cznie element â€œaâ€.  #- - Pozwala na usuniÄ™cie pola lub elementu znajdujÄ…cego siÄ™ pod okreÅ›lonÄ… Å›cieÅ¼kÄ….Kiedy stosowaÄ‡ typ json, a kiedy jsonb?JeÅ¼eli potrzebujemy jedynie zapisywaÄ‡ i odczytywaÄ‡ dane w formacie json i dalsze operacje na tych danych nie bÄ™dÄ… konieczne, to moÅ¼emy zastosowaÄ‡ typ json.Kiedy jednak wykonujemy wiele operacji na jsonie albo potrzebujemy indexu na kluczu, wtedy lepszym wyborem bÄ™dzie zastosowanie typu jsonb.W dokumentacji PostgreSQL znajdziemy rekomendacjÄ™ uÅ¼ywania typu jsonb. PamiÄ™tajmy jednak o sytuacjach, w ktÃ³rych typ json moÅ¼e siÄ™ sprawdziÄ‡ lepiej. Dobrym przykÅ‚adem sÄ… systemy legacy, w ktÃ³rych polegamy na kolejnoÅ›ci zapisu danych.Przeczytaj wiÄ™cej tutaj:  https://www.postgresql.org/docs/9.5/datatype-json.html  https://www.compose.com/articles/faster-operations-with-the-jsonb-data-type-in-postgresql/",
"url": "/2021/12/07/json-vs-jsonb-postgresql.html",
"author": "Katarzyna Kur",
"authorUrl": "/authors/kkur.html",
"image": "kkur.png",
"highlight": "/assets/img/posts/2021-11-23-json-vs-jsonb-postgresql/json.jpg",
"date": "07-12-2021",
"path": "pl/2021-11-23-json-vs-jsonb-postgresql"
}
,


"2021-11-16-shadow-dom-html": {
"title": "Czy wiesz, czym jest Shadow DOM?",
"lang": "pl",
"tags": "javascript",
"content": "Pewnie czytajÄ…c o Web Componentach dane byÅ‚o Ci sÅ‚yszeÄ‡ o Shadow DOM. Pozwala on na przyczepienie siÄ™ do istniejÄ…cych elementÃ³w DOM (ktÃ³re stajÄ… siÄ™ Shadow Hostem) i wyjÅ›cie z nich z nowym drzewem DOM.Jak korzystaÄ‡ z Shadow DOMAby to zrobiÄ‡, potrzebujemy utworzyÄ‡ uchwyt do elementu z DOM, np.:var host = document.getElementById(&quot;host&quot;);a nastÄ™pnie przypiÄ…Ä‡ do niego Shadow Root, czyli miejsce, z ktÃ³rego bÄ™dziemy mogli wyjÅ›Ä‡ z Shadow DOMem:var root = host.attachShadow({&#39;mode&#39;: &#39;open&#39;});mode pozwala ustaliÄ‡, czy z zewnÄ…trz Shadow DOM bÄ™dziemy mogli mieÄ‡ do niego dostÄ™p. MoÅ¼e on przyjÄ…Ä‡ wartoÅ›Ä‡ open lub closed.Na sam koniec do Shadow Root przypinamy kawaÅ‚ek HTMLa:root.innerHTML = &quot;jestem w shadow DOM!&quot;;PrzykÅ‚adCaÅ‚oÅ›Ä‡ moÅ¼na zobaczyÄ‡ na przykÅ‚adzie:  See the Pen   Shadow DOM by Porkite (@Porkite)  on CodePen.PrzykÅ‚ad ten pokazuje rÃ³wnieÅ¼, Å¼e z Shadow DOM moÅ¼na korzystaÄ‡ jako z samodzielnego feature, bez udziaÅ‚u Web Componentu.Co nam to wszystko daje?UmoÅ¼liwia nam to pisaÄ‡ Web Componenty (lub jak widaÄ‡ na przykÅ‚adzie - niezaleÅ¼ne dodatkowe struktury DOM), ktÃ³re ukrywajÄ… swojÄ… strukturÄ™, aby uÅ‚atwiÄ‡ czytanie html utworzonej strony.DziÄ™ki nim moÅ¼emy teÅ¼ enkapsulowaÄ‡ stylizacjÄ™: style dla naszej aplikacji nie bÄ™dÄ… wpÅ‚ywaÄ‡ na nasze Shadow DOM-y, a style zadeklarowane w ich wnÄ™trzu nie zmieniÄ… wyglÄ…du tego, co znajduje siÄ™ na zewnÄ…trz.",
"url": "/2021/11/16/shadow-dom.html",
"author": "Piotr Grobelny",
"authorUrl": "/authors/pgrobelny.html",
"image": "pgrobelny.webp",
"highlight": "/assets/img/posts/2021-09-01-shadow-dom/shadow.webp",
"date": "16-11-2021",
"path": "pl/2021-09-01-shadow-dom"
}
,


"2021-11-08-bucket-pattern-html": {
"title": "Czy wiesz, jak dziaÅ‚a Bucket Pattern w MongoDB i czemu sprawdziÅ‚ siÄ™ w implementacji IoT Boscha albo w apkach bankowych?",
"lang": "pl",
"tags": "mongoDB",
"content": "NajwiÄ™ksze korzyÅ›ci z uÅ¼ywania odpowiedniego wzorca grupowania danych, czyli Bucket Pattern w MongoDB, to m.in. zwiÄ™kszenie wydajnoÅ›ci indeksÃ³w czy uproszczenie zapytaÅ„. Przeczytaj jak to wszystko zrealizowaÄ‡.Jaki problem prÃ³bujemy rozwiÄ…zaÄ‡?Zacznijmy od prostego przykÅ‚adu - pomiarÃ³w czujnika wykonywanych bardzo czÄ™sto, np. co sekundÄ™, kaÅ¼dego dnia. MoÅ¼na by je zapisywaÄ‡ nastÄ™pujÄ…co:{   sensor_id: 12345,   timestamp: ISODate(&quot;2019-01-31T10:00:00.000Z&quot;),   temperature: 40} {   sensor_id: 12345,   timestamp: ISODate(&quot;2019-01-31T10:01:00.000Z&quot;),   temperature: 40} {   sensor_id: 12345,   timestamp: ISODate(&quot;2019-01-31T10:02:00.000Z&quot;),   temperature: 41}Oczywiste jest, Å¼e dokumentÃ³w w takiej kolekcji bÄ™dzie bardzo duÅ¼o i w zwiÄ…zku z tym, problemem moÅ¼e byÄ‡ szybki dostÄ™p do tych danych. W celu zwiÄ™kszenia wydajnoÅ›ci zdecydujemy siÄ™ zastosowaÄ‡ indeksy, najprawdopodobniej na polach sensor_id i timestamp. WÃ³wczas sam rozmiar indeksÃ³w stanie siÄ™ sporym wyzwaniem w kontekÅ›cie niezbÄ™dnej do tego pamiÄ™ci.Na czym polega Bucket Pattern?Wzorzec polega na odpowiednim pogrupowaniu danych. PamiÄ™tajÄ…c o naszym przykÅ‚adzie z czujnikami, moÅ¼emy pogrupowaÄ‡ dane z jednego czujnika w interesujÄ…cym nas przedziaÅ‚ach czasu, np. przedziaÅ‚ach 1-godzinnych. Przejdziemy wÃ³wczas z modelu danych odpowiadajÄ…cemu relacyjnemu podejÅ›ciu na model z zagnieÅ¼dÅ¼onymi dokumentami.Te same dane wyglÄ…daÅ‚yby nastÄ™pujÄ…co:{    sensor_id: 12345,    start_date: ISODate(&quot;2019-01-31T10:00:00.000Z&quot;),    end_date: ISODate(&quot;2019-01-31T10:59:59.000Z&quot;),    measurements: [       {       timestamp: ISODate(&quot;2019-01-31T10:00:00.000Z&quot;),       temperature: 40       },       {       timestamp: ISODate(&quot;2019-01-31T10:01:00.000Z&quot;),       temperature: 40       },       ...       {       timestamp: ISODate(&quot;2019-01-31T10:42:00.000Z&quot;),       temperature: 42       }    ],   transaction_count: 42,   sum_temperature: 2413}DokumentÃ³w w kolekcji bÄ™dzie mniej i zwiÄ™kszymy wydajnoÅ›Ä‡ zapytaÅ„. WiedzÄ…c, jakie bÄ™dzie zastosowanie danych, moÅ¼emy rÃ³wnieÅ¼ dodaÄ‡ do naszego â€œwiaderkaâ€ dodatkowe informacje. Czy faktycznie potrzebujemy do wiÄ™kszoÅ›ci zapytaÅ„ kaÅ¼dego pojedynczego pomiaru? ByÄ‡ moÅ¼e ciekawszÄ… informacjÄ… bÄ™dzie Å›rednia temperatura z godziny w danym miejscu? WÃ³wczas moÅ¼emy zapisaÄ‡ takie zagregowane dane w Bucket Pattern i uproÅ›ciÄ‡ pÃ³Åºniejsze zapytania.W naszym przykÅ‚adzie, jeÅ›li dojdzie nowy pomiar z czujnika w tym zakresie, zwiÄ™kszymy liczbÄ™ transaction_count i sum_temperature. Zapytanie o Å›redniÄ… temperaturÄ™ w danym dniu lub godzinie, bÄ™dzie wtedy nawet prostsze niÅ¼ gdybyÅ›my korzystali z pojedynczych pomiarÃ³w.I na koniec jeszcze jedna wskazÃ³wka. Dobrym pomysÅ‚em moÅ¼e siÄ™ okazaÄ‡ zarchiwizowanie czÄ™Å›ci danych historycznych. Dane spÅ‚ywajÄ… wÃ³wczas na bieÅ¼Ä…co i wiemy, Å¼e konkretny dokument nie bÄ™dzie pÃ³Åºniej modyfikowany, a dostÄ™p do starych danych moÅ¼e byÄ‡ niezwykle rzadki.Praktyczne przypadki uÅ¼yciaTwÃ³rcy Mongo chwalÄ… siÄ™, Å¼e takie zastosowania to nie tylko teoria. Bosch korzysta z Bucket Pattern w MongoDB w aplikacji z branÅ¼y automotive, zbierajÄ…c dane z wielu czujnikÃ³w w pojeÅºdzie. RÃ³wnieÅ¼ niektÃ³re banki skorzystaÅ‚y z tego wzorca, grupujÄ…c transakcje.KorzyÅ›ci, o ktÃ³rych warto pamiÄ™taÄ‡  redukcja liczby dokumentÃ³w w kolekcji,  zwiÄ™kszenie wydajnoÅ›ci indeksÃ³w,  uproszczenie zapytaÅ„ dotyczÄ…cych zagregowanych danych.Przeczytaj wiÄ™cej tutaj:  https://developer.mongodb.com/how-to/bucket-pattern/  https://www.mongodb.com/customers/bosch",
"url": "/2021/11/08/bucket-pattern.html",
"author": "Barbara Mitan",
"authorUrl": "/authors/bmitan.html",
"image": "bmitan.jpg",
"highlight": "/assets/img/posts/2021-09-16-bucket-pattern/bucket.jpeg",
"date": "08-11-2021",
"path": "pl/2021-09-16-bucket-pattern"
}
,


"2021-10-13-zarzadzanie-stanem-aplikacji-frontendowej-html": {
"title": "ZarzÄ…dzanie stanem aplikacji frontendowej na przykÅ‚adzie NgRx",
"lang": "pl",
"tags": "frontend redux state management zarzÄ…dzanie stanem store reducer action effect angular react",
"content": "W miarÄ™ rozwijania zÅ‚oÅ¼onych aplikacji webowych waÅ¼nym i nieoczywistym zagadnieniem staje siÄ™ projektowanie przepÅ‚ywu informacji pomiÄ™dzy komponentami. CzÄ™sto mamy do czynienia z wieloma ÅºrÃ³dÅ‚ami danych. MogÄ… to byÄ‡ na przykÅ‚ad najrÃ³Å¼niejsze zewnÄ™trzne serwisy czy interakcje uÅ¼ytkownika z systemem. Nierzadko dane z tych ÅºrÃ³deÅ‚ potrzebne sÄ… w rÃ³Å¼nych obszarach aplikacji, wpÅ‚ywajÄ… na wiele aspektÃ³w jej dziaÅ‚ania czy wyglÄ…du. W zwiÄ…zku z powyÅ¼szym muszÄ… zostaÄ‡ rozpropagowane do miejsc, w ktÃ³rych zostanÄ… uÅ¼yte. MoÅ¼na siÄ™ jednak zastanowiÄ‡, czy â€œprzepychanieâ€ parametrÃ³w po caÅ‚ej aplikacji jest szczytem naszych moÅ¼liwoÅ›ci. W przypadku rozbudowanych projektÃ³w jest to doÅ›Ä‡ Å¼mudne zadanie, a w efekcie bardzo szybko moÅ¼e zabaÅ‚aganiÄ‡ nasz kod, pomieszaÄ‡ orkiestracjÄ™ z prezentacjÄ…, nie wspominajÄ…c juÅ¼ o wprowadzeniu trudnoÅ›ci w testowaniu logiki opartej o przekazywane dane.Jeden z pomysÅ‚Ã³w adresujÄ…cych miÄ™dzy innymi powyÅ¼sze problemy wyglÄ…da nastÄ™pujÄ…co:  stwÃ³rzmy dostÄ™pne tylko do odczytu, pojedyncze ÅºrÃ³dÅ‚o danych wejÅ›ciowych,  wyraÅºnie rozgraniczmy logikÄ™ aplikacji od jej prezentacji,  sprawmy, Å¼eby dane wynikaÅ‚y z historii pewnych zdarzeÅ„ zachodzÄ…cych w aplikacji,  nie przechowujmy danych, ktÃ³re mogÄ… zostaÄ‡ wyliczone na podstawie juÅ¼ przechowywanych - ewaluujmy je w locie.Te i kilka innych koncepcji zebrano i wymyÅ›lono w ten sposÃ³b architekturÄ™ zwanÄ… Redux. MajÄ…c na uwadze problem, ktÃ³ry chcemy rozwiÄ…zaÄ‡ oraz ogÃ³lny zarys rozwiÄ…zania, postaram siÄ™ przedstawiÄ‡ jej skÅ‚adowe oraz implementacjÄ™ w bibliotece NgRx.Czy na pewno potrzebujesz zarzÄ…dzania stanem aplikacji?Zanim zaczniemy, zwrÃ³Ä‡my uwagÄ™, Å¼e nie kaÅ¼da aplikacja jest tak rozbudowana i zÅ‚oÅ¼ona, Å¼eby potrzebowaÄ‡ caÅ‚ego mechanizmu zarzÄ…dzania stanem. JeÅ›li â€œprzepychanie parametrÃ³wâ€ odbywa siÄ™ pomiÄ™dzy niewielkÄ… liczbÄ… komponentÃ³w, to nie musimy wytaczaÄ‡ przysÅ‚owiowych armat, Å¼eby ustrzeliÄ‡ komara. W ustaleniu, czy dobrze byÅ‚oby sobie pomÃ³c zewnÄ™trznym rozwiÄ…zaniem, pomaga zasada SHARI zaprezentowana, chociaÅ¼by, w oficjalnej dokumentacji NgRx. Warto sobie odpowiedzieÄ‡, czy potrzebujemy stanu, ktÃ³ry jest:  Shared - wspÃ³Å‚dzielony pomiÄ™dzy wiele komponentÃ³w i serwisÃ³w.  Hydrated - trwaÅ‚y i z moÅ¼liwoÅ›ciÄ… ponownego zasilenia z zewnÄ™trznego ÅºrÃ³dÅ‚a jak np. local storage.  Available - dostÄ™pny caÅ‚y czas, niezaleÅ¼nie od sposobu nawigacji po aplikacji, np. podczas przechodzenia i cofania siÄ™ w aplikacji prezentujÄ…cej zÅ‚oÅ¼ony wniosek.  Retrieved - zdolny do przechowywania danych pochodzÄ…cych z zewnÄ™trznych ÅºrÃ³deÅ‚, co pozwala na przykÅ‚ad zapisaÄ‡ wynik Å¼Ä…dania HTTP i nie wykonywaÄ‡ go po raz kolejny w celu otrzymania tych samych informacji.  Impacted - zdolny do zmieniania siÄ™ pod wpÅ‚ywem akcji wykonywanych przez komponenty i serwisy.Architektura ReduxSpÃ³jrzmy zatem co tak naprawdÄ™ kryje siÄ™ pod tym, byÄ‡ moÅ¼e na razie doÅ›Ä‡ enigmatycznym, pojÄ™ciem â€œReduxâ€. PosÅ‚uÅ¼Ä™ siÄ™ tutaj obrazkiem zaczerpniÄ™tym z dokumentacji NgRx.Architektura Redux z lotu ptaka. Å¹rÃ³dÅ‚o: dokumentacja NgRxNa razie powyÅ¼szy diagram moÅ¼e wydawaÄ‡ siÄ™ nieco tajemniczy. Dla bardziej zaprawionych w bojach po stronie backendowej moÅ¼e siÄ™ skojarzyÄ‡ z CQRS. Niemniej juÅ¼ spieszÄ™ z wyjaÅ›nieniami.  Architektura Redux zakÅ‚ada istnienie globalnego, niemutowalnego bytu, przechowujÄ…cego stan aplikacji - store. Fizycznie jest to obiekt w formacie JSON, ktÃ³rego struktura definiowana jest przez programistÄ™.  Podstawowym mechanizmem komunikacji sÄ… akcje (ang. actions). ReprezentujÄ… one konkretne zdarzenia zachodzÄ…ce w systemie i niosÄ… ze sobÄ… okreÅ›lone informacje.  Akcje mogÄ… byÄ‡ przechwytywane przez reducery (ang. reducers). Reducerem nazywamy czystÄ… funkcjÄ™ (ang. pure function), ktÃ³ra konsumuje akcjÄ™ i, w zaleÅ¼noÅ›ci od jej przeznaczenia oraz zgodnie z logikÄ… reducera, zastÄ™puje store nowym, z uwzglÄ™dnionÄ… zmianÄ….  Dane ze store do komponentÃ³w trafiajÄ… poprzez selektory (ang. selectors). Selektory powinny otrzymywaÄ‡ wyÅ‚Ä…cznie dane potrzebne do dziaÅ‚ania komponentÃ³w, w ktÃ³rych sÄ… uÅ¼ywane.  W przypadkach, kiedy wywoÅ‚anie akcji powinno pociÄ…gnÄ…Ä‡ za sobÄ… dowolne dziaÅ‚anie niezwiÄ…zane bezpoÅ›rednio z aplikacjÄ… (np. zapytanie do bazy danych, czy Å¼Ä…danie do zewnÄ™trznej usÅ‚ugi) - do gry wchodzi middleware, ktÃ³re dalej, ze wzglÄ™du na nomenklaturÄ™ stosowanÄ… w NgRx, nazywaÄ‡ bÄ™dziemy efektami (ang. effects). Podobnie jak reducery, middleware potrafi reagowaÄ‡ na konkretne akcje i wykonaÄ‡ przypisane im zadanie, jak rÃ³wnieÅ¼ wywoÅ‚aÄ‡ kolejne akcje.Implementacja Redux w NgRxPrzy pierwszym kontakcie wszystkie powyÅ¼sze pojÄ™cia i pomysÅ‚y mogÄ… wydawaÄ‡ siÄ™ nieco skomplikowane i nadmiarowe, zatem na prostym przykÅ‚adzie pokaÅ¼Ä™, jak wyglÄ…dajÄ… fragmenty aplikacji pisanej przy pomocy NgRx. Na koÅ„cu wpisu znajduje siÄ™ link do repozytorium, w ktÃ³rym widaÄ‡, jak wyglÄ…da caÅ‚a aplikacja oraz jej konfiguracja. RÃ³wnieÅ¼ z tego powodu pomijam instrukcje instalacji biblioteki i konfiguracji Å›rodowiska.ZaÅ‚Ã³Å¼my, Å¼e chcemy stworzyÄ‡ prosty program pozwalajÄ…cy na zapisywanie sposobÃ³w na pokonanie nudy. Jednym z moÅ¼liwych do podjÄ™cia dziaÅ‚aÅ„ bÄ™dzie wywoÅ‚anie API, ktÃ³re na kaÅ¼de Å¼Ä…danie odpowie pomysÅ‚em na jakÄ…Å› aktywnoÅ›Ä‡. DrugÄ… opcjÄ… bÄ™dzie dodanie wÅ‚asnej koncepcji poprzez prosty formularz. Zacznijmy zatem.StoreNa samym poczÄ…tku procesu, warto uzmysÅ‚owiÄ‡ sobie, co tak naprawdÄ™ chcemy zapisywaÄ‡ w naszym store, a potem powiedzieÄ‡ to Typescriptowi tworzÄ…c interfejs. W naszej aplikacji bÄ™dziemy przechowywali w nim jedynie listÄ™ czynnoÅ›ci potencjalnie zabijajÄ…cych nudÄ™, jednak nawet w tak prostym przypadku warto zwrÃ³ciÄ‡ uwagÄ™ na to, jakÄ… strukturÄ™ planujemy nadaÄ‡ storeâ€™owi. PoczÄ…tkowo najproÅ›ciej jest operowaÄ‡ na pÅ‚askiej strukturze, w ktÃ³rej wszystkie dane znajdujÄ… siÄ™ na tym samym poziomie.Niestety przy rozwijaniu aplikacji takie podejÅ›cie staje siÄ™ bardzo nieefektywne, zarÃ³wno pod wzglÄ™dem organizacji, jak i, z czasem, rÃ³wnieÅ¼ wydajnoÅ›ci. Zdecydowanie lepiej jest podzieliÄ‡ store na tak zwane â€œsliceâ€™yâ€, czyli wycinki danych, na przykÅ‚ad dzielÄ…c store wedÅ‚ug funkcjonalnoÅ›ci aplikacji. Zobaczmy takie podejÅ›cie na przykÅ‚adzie:export interface State {    activitiesState: ActivityItemsState;}export interface ActivityItemsState {    activities: ActivityItemModel[];}export interface ActivityItemModel {    name: string;    participants: number;}PrzejdÅºmy po powyÅ¼szych interfejsach po kolei. Pierwszy z nich mÃ³wi, Å¼e spodziewamy siÄ™ mieÄ‡ jeden wycinek danych (slice) typu ActivityItemsState, w ktÃ³rym bÄ™dÄ… przechowywane wszystkie informacje dotyczÄ…ce aktywnoÅ›ci dodanych do aplikacji. Innymi sÅ‚owy jest to logicznie wydzielony fragment domeny. NastÄ™pnie definiujemy, co tak naprawdÄ™ znajduje siÄ™ w tym wycinku danych - jest to tablica obiektÃ³w typu ActivityItemModel, czyli informacji o rÃ³Å¼nych aktywnoÅ›ciach. Ostatni interfejs to juÅ¼ wyÅ‚Ä…cznie definicja modelu biznesowego - w naszej aplikacji bÄ™dziemy mieli do czynienia z nazwÄ… czynnoÅ›ci oraz moÅ¼liwÄ… liczbÄ… jej uczestnikÃ³w.Taki podziaÅ‚ store zapewnia bardzo Å‚atwÄ… jego rozszerzalnoÅ›Ä‡, gdyÅ¼ w przypadku dodania nowej funkcjonalnoÅ›ci wystarczy dopisaÄ‡ nowy wycinek danych do store. W bardzo duÅ¼ych aplikacjach, gdzie obiekt stanu aplikacji jest juÅ¼ doÅ›Ä‡ potÄ™Å¼ny, to podejÅ›cie ma jeszcze jednÄ… zaletÄ™ - pozwala wykorzystaÄ‡ lazy loading, to znaczy wczytywaÄ‡ tylko konkretne wycinki store, potrzebne do aktualnie przetwarzanej czÄ™Å›ci aplikacji.AkcjePotrzebujemy teraz opcji wywoÅ‚ywania akcji, Å¼eby mÃ³c zgÅ‚aszaÄ‡ zajÅ›cie pewnych faktÃ³w w systemie. W naszej aplikacji zakÅ‚adamy moÅ¼liwoÅ›Ä‡ wystÄ…pienia dwÃ³ch zdarzeÅ„ - wystosowania Å¼Ä…dania do API po pomysÅ‚ na jakieÅ› zajÄ™cie oraz dodania aktywnoÅ›ci do listy.export const activityAddedType = &#39;[activity] Activity added&#39;;export const activitiesRetrievedType = &#39;[activity] Activities retrieved&#39;;export const activityAdded = createAction(activityAddedType, props&amp;lt;ActivityItemModel&amp;gt;());export const activitiesRetrieved = createAction(activitiesRetrievedType);KaÅ¼da akcja musi mieÄ‡ zdefiniowany swÃ³j typ. NgRx uÅ¼ywa do tego tzw. literal type, czyli po prostu uÅ¼ywa typu string do identyfikacji akcji (u nas odpowiednio [activity] Activity added oraz [activity] Activities retrieved). W nazywaniu akcji mamy peÅ‚nÄ… dowolnoÅ›Ä‡. Dodatkowo w przypadku dodawania nowej aktywnoÅ›ci do listy musimy jÄ… przekazaÄ‡ w ciele akcji przy pomocy metody props&amp;lt;&amp;gt;(). DziÄ™ki wykorzystaniu funkcji createAction z biblioteki NgRx tworzenie akcji, jak widaÄ‡, jest bardzo proste.EfektJak wspomniaÅ‚em, bÄ™dziemy korzystaÄ‡ z zewnÄ™trznego API. W tym celu napiszemy efekt, ktÃ³ry bÄ™dzie reagowaÅ‚ na akcjÄ™ [activity] Activities retrieved, nastÄ™pnie wystosowywaÅ‚ Å¼Ä…danie HTTP, a po otrzymaniu odpowiedzi - dodawaÅ‚ jÄ… do listy.Pojawia siÄ™ tutaj doÅ›Ä‡ duÅ¼o zagadnieÅ„, zatem spÃ³jrzmy na ten fragment nieco inaczej. ZastanÃ³wmy siÄ™ najpierw jak, uÅ¼ywajÄ…c dotychczas znanych nam narzÄ™dzi (na  przykÅ‚ad RxJs), moglibyÅ›my napisaÄ‡ logikÄ™ wywoÅ‚ujÄ…cÄ… Å¼Ä…danie na kaÅ¼de klikniÄ™cie przycisku i przekazaÄ‡ je dalej. JeÅ›li zaÅ‚oÅ¼ymy, Å¼e zdarzenie klikniÄ™cia pojawia siÄ™ w Observable click$, a strumieÅ„, na ktÃ³ry ma trafiÄ‡ odpowiedÅº zostaÅ‚ nazwany response$, wÃ³wczas kod mÃ³gÅ‚by wyglÄ…daÄ‡ tak:this.response$ = this.click$.pipe(    switchMap(() =&amp;gt; this.http.get&amp;lt;ActivityItemModel&amp;gt;(&#39;https://www.boredapi.com/api/activity&#39;)      .pipe(        catchError(() =&amp;gt; EMPTY)      )));JeÅ›li na tym etapie potrzebujesz chwili przerwy na zrozumienie co dzieje siÄ™ w tym kodzie, to polecam wpis o RxJs dostÄ™pny na Å‚amach naszego bloga.WracajÄ…c do naszego efektu - w zasadzie wiÄ™kszoÅ›Ä‡ mamy juÅ¼ napisanÄ…! Pozostaje nam tylko kilka rzeczy:  efekt jest tak naprawdÄ™ serwisem, jakie znamy z codziennego pisania w Angularze, tworzymy zatem klasÄ™ ActivityEffect i dekorujemy jÄ… przy pomocy @Injectable().  nie powinniÅ›my reagowaÄ‡ bezpoÅ›rednio na zdarzenie klikniÄ™cia przycisku, a na zgÅ‚oszone wczeÅ›niej akcjÄ™ typu activitiesRetrievedType. Mamy do dyspozycji serwis Actions, ktÃ³ry moÅ¼emy traktowaÄ‡ jak swoistÄ… szynÄ™, na ktÃ³rÄ… trafiajÄ… wywoÅ‚ane akcje. Wstrzykujemy go wiÄ™c przez konstruktor do efektu. ChcÄ…c reagowaÄ‡ wyÅ‚Ä…cznie na okreÅ›lony typ akcji korzystamy z operatora ofType.  wynik Å¼Ä…dania w naszym wypadku nie powinien trafiaÄ‡ do Å¼adnego strumienia, tylko spowodowaÄ‡ wywoÅ‚anie akcji activityAdded. Wystarczy dodaÄ‡  mapowanie w operatorze pipe().CaÅ‚y efekt wyglÄ…da wÃ³wczas tak:@Injectable()export class ActivityEffect {  constructor(private actions$: Actions, private http: HttpClient) {  }  getActivity$ = createEffect(() =&amp;gt; this.actions$.pipe(    ofType(activitiesRetrievedType),    switchMap(() =&amp;gt; this.http.get&amp;lt;ActivityItemModel&amp;gt;(&#39;https://www.boredapi.com/api/activity&#39;)      .pipe(        map(response =&amp;gt; (activityAdded(response))),        catchError(() =&amp;gt; EMPTY)      ))  ));}PodsumowujÄ…c: w wyniku dziaÅ‚ania tego efektu kaÅ¼de wywoÅ‚anie akcji [activity] Activities retrieved przy poprawnej odpowiedzi z API wywoÅ‚a akcjÄ™ [activity] Activity added z otrzymanÄ… czynnoÅ›ciÄ…. MoÅ¼na oczywiÅ›cie tworzyÄ‡ efekty obsÅ‚ugujÄ…ce inne operacje, nie trzeba ograniczaÄ‡ siÄ™ do Å¼Ä…daÅ„ HTTP.ReducerW reducerach zazwyczaj znajduje siÄ™ najwiÄ™cej logiki ze wszystkich komponentÃ³w NgRx. To tutaj trzeba zdecydowaÄ‡ jak dodawaÄ‡ do store kolejne dane. Warto pamiÄ™taÄ‡, Å¼e reducery to czyste funkcje, ktÃ³re przyjmujÄ… jako parametr akcjÄ™ i obecny stan aplikacji, a nastÄ™pnie zwracajÄ… nowy stan, dziÄ™ki czemu zachowujemy jego niemutowalnoÅ›Ä‡. W naszym przypadku wyglÄ…da to tak:const initialState: ActivityItemsState = {activities: []};export const activityReducer = createReducer(    initialState,    on(addActivity, (state, payload) =&amp;gt; ({        ...state,        activities: state.activities.concat({activity: payload.activity, participants: payload.participants} as ActivityItemModel)    })));W pierwszej linii definiujemy, w jaki sposÃ³b ma zostaÄ‡ zainicjowany store (lub - jak ma to miejsce powyÅ¼ej - jego wycinek). W naszym przypadku bÄ™dzie to pusta tablica. NastÄ™pnie wywoÅ‚ujemy funkcjÄ™ createReducer, ktÃ³ra w pierwszym parametrze przyjmuje wspomniany stan poczÄ…tkowy, a w drugim (i kaÅ¼dym kolejnym) odpowiednie handlery. W tym przypadku reducer reaguje na akcjÄ™ [activity] Activity added poprzez dodanie do dotychczasowej tablicy activities nowego elementu i zwrÃ³cenie caÅ‚oÅ›ci jako wynik wywoÅ‚ania funkcji.Reducer jest czÄ™Å›ciÄ… caÅ‚ej architektury, ktÃ³rÄ… moÅ¼na w bardzo Å‚atwy sposÃ³b przetestowaÄ‡ i upewniÄ‡ siÄ™, Å¼e dziaÅ‚a poprawnie. W tym przypadku moÅ¼emy napisaÄ‡ taki test:describe(&#39;Activity reducer test&#39;, () =&amp;gt; {  function createState(activities: ActivityItemModel[]): ActivityItemsState {    return {activities: [...activities]};  }  it(&#39;should add new activity&#39;, () =&amp;gt; {    // given    const state = createState([]);    const newActivityName = &#39;New activity&#39;;    const newActivityParticipants = 2;    const action = activityAdded({activity: newActivityName, participants: newActivityParticipants});    // when    const newState = activityReducer(state, action);    // then    expect(newState.activities.length).toBe(1);    expect(newState.activities[0].activity).toEqual(newActivityName);    expect(newState.activities[0].participants).toEqual(newActivityParticipants);  });});Test przebiega nastÄ™pujÄ…co:  w sekcji given tworzymy sztuczny, pusty store oraz akcjÄ™ activityAdded,  w sekcji when wywoÅ‚ujemy interesujÄ…cy nas reducer i przypisujemy wynik do zmiennej newState  w sekcji then sprawdzamy czy w store znajduje siÄ™ jeden, dodany przez nas element i czy jego wÅ‚aÅ›ciwoÅ›ci zgadzajÄ… sie z tym, co przekazaliÅ›my w akcji.JeÅ›li wszystkie trzy asercje zostanÄ… speÅ‚nione, wÃ³wczas wiemy, Å¼e mechanizm dodawania nowej aktywnoÅ›ci do store dziaÅ‚a.SelektorOstatniÄ… czÄ™Å›ciÄ… ukÅ‚adanki w przepÅ‚ywie sÄ… selektory. Podobnie jak reducery sÄ… one czystymi funkcjami, ktÃ³rych zadaniem jest obserwowanie wycinkÃ³w store i dostarczanie informacji o ich zmianach do komponentÃ³w. Warto tu wspomnieÄ‡, Å¼e sÄ… one dobrym miejscem na to, by dane te odpowiednio przygotowaÄ‡, tak, by po trafieniu do komponentu mogÅ‚y byÄ‡ â€wygodnieâ€ uÅ¼yte. DziÄ™ki temu komponent moÅ¼e caÅ‚kowicie abstrahowaÄ‡ od struktury store. W naszej aplikacji selektor zdefiniowany jest nastÄ™pujÄ…co:const getActivitiesFeatureState = createFeatureSelector&amp;lt;ActivityItemsState&amp;gt;(&#39;activitiesState&#39;);export const getActivities = createSelector(getActivitiesFeatureState, state =&amp;gt; state.activities);Najpierw, przy pomocy funkcji createFeatureSelector tworzymy tzw. feature selector pozwalajÄ…cy na wyciÄ…gniÄ™cie pojedynczego wycinka (slice) danych, nazwanego przez nas activitiesState. NastÄ™pnie uÅ¼ywamy go tworzÄ…c wÅ‚aÅ›ciwy selektor przy pomocy funkcji createSelector i wskazujÄ…c go w pierwszym jej argumencie. Drugim parametrem jest funkcja wskazujÄ…ca, ktÃ³re dane chcemy otrzymaÄ‡ w wyniku dziaÅ‚ania selektora. W naszym przypadku jest to tablica czynnoÅ›ci, o nazwie activities. Tak zbudowany selektor jest gotowy do uÅ¼ycia w komponencie.Na poczÄ…tku tego punktu wspomniaÅ‚em, Å¼e selektory sÄ… czystymi funkcjami, co miÄ™dzy innymi oznacza, Å¼e przy zachowaniu tego samego stanu i dla tych samych parametrÃ³w wielu wywoÅ‚aÅ„ zawsze zwrÃ³cÄ… ten sam wynik. Ta wÅ‚aÅ›ciwoÅ›Ä‡ zostaÅ‚a wykorzystana w mechanizmie nazywanym â€memoizationâ€ (zapamiÄ™tywanie). DziÄ™ki niemu NgRx zapamiÄ™tuje, z jakimi argumentami ostatnio wywoÅ‚ywany byÅ‚ dany selektor. JeÅ›li nie ulegÅ‚y one zmianie, wÃ³wczas zwraca wynik poprzedniego wywoÅ‚ania selektora, nie wykonujÄ…c logiki pobierania danych ze store.SpiÄ™cie caÅ‚oÅ›ciMamy juÅ¼ wszystkie potrzebne czÄ™Å›ci logiki NgRx, z ktÃ³rych chcemy skorzystaÄ‡. Pozostaje juÅ¼ tylko dowiedzieÄ‡ siÄ™, jak ich uÅ¼yÄ‡. PokaÅ¼Ä™ sytuacjÄ™, w ktÃ³rej uÅ¼ytkownik klika przycisk odpowiadajÄ…cy za pobranie przykÅ‚adowej aktywnoÅ›ci z API, przechodzÄ…c jednoczeÅ›nie przez odpowiednie miejsca w kodzie. W trakcie czytania zachÄ™cam do spoglÄ…dania na zamieszczony wczeÅ›niej w poÅ›cie diagram przepÅ‚ywu.  Zacznijmy od komponentu wywoÅ‚ujÄ…cego poczÄ…tkowÄ… akcjÄ™ typu [activity] Activities retrieved. Budowa klasy tego komponentu moÅ¼e wyglÄ…daÄ‡ nastÄ™pujÄ…co (pomijam template):    export class ActivityApiComponent { constructor(private store: Store&amp;lt;State&amp;gt;) { } getActivity(): void {     this.store.dispatch(getActivity()); }}        Jak widaÄ‡ w konstruktorze, wstrzykujemy obiekt Store, na ktÃ³rym wykonujemy metodÄ™ dispatch podajÄ…c w jej argumencie typ akcji. Na tym koÅ„czy siÄ™ odpowiedzialnoÅ›Ä‡ komponentu.    WysÅ‚anÄ… akcjÄ™ przechwytuje efekt, ktÃ³ry, zgodnie z kodem zaprezentowanym wczeÅ›niej, wysyÅ‚a Å¼Ä…danie do API, a otrzymawszy odpowiedÅº przekazuje jÄ… jako argument nowej akcji [activity] Activity added.  Akcja typu [activity] Activity added jest przechwytywana przez reducer, ktÃ³ry wyÅ‚uskuje z niej przekazanÄ… z API odpowiedÅº i dodaje do store.  W ostatniej kolejnoÅ›ci do gry wchodzi selektor, ktÃ³ry wykrywa zmianÄ™ store wynikajÄ…cÄ… z dziaÅ‚ania reducera. UÅ¼ycie selektora w komponencie moÅ¼e wyglÄ…daÄ‡ nastÄ™pujÄ…co:export class ActivityListComponent implements OnInit {    activities$: Observable&amp;lt;ActivityItemModel[]&amp;gt;;    constructor(private store: Store&amp;lt;State&amp;gt;) {    }    ngOnInit(): void {        this.activities$ = this.store.select(getActivities);    }}W metodzie ngOnInit wskazujemy, Å¼e chcemy reagowaÄ‡ na zmiany store przy pomocy selektora getActivities. Zmiennej activities$ moÅ¼emy nastÄ™pnie uÅ¼yÄ‡ w ciele komponentu przy pomocy async pipe, na przykÅ‚ad:&amp;lt;div *ngFor=&quot;let activity of activities$ | async&quot;&amp;gt;    &amp;lt;!-- wnÄ™trze komponentu listy --&amp;gt;&amp;lt;/div&amp;gt;Tym samym caÅ‚y proces dobiega koÅ„ca, a kolejne klikniÄ™cie przycisku wywoÅ‚a go od nowa.Inne podejÅ›ciaWarto wspomnieÄ‡, Å¼e tak, jak dla Angulara istnieje biblioteka NgRx, tak rÃ³wnieÅ¼ dla pozostaÅ‚ych frameworkÃ³w z tzw. wielkiej trÃ³jcy znajdziemy implementacje architektury Redux:  Redux dla Reacta  Vuex dla VueNaleÅ¼y rÃ³wnieÅ¼ zaznaczyÄ‡, Å¼e Redux nie jest jedynym sposobem na zarzÄ…dzanie stanem. MoÅ¼na tutaj wymieniÄ‡ takie alternatywy, jak:  MobX  Cycle.js  Flux - warto wiedzieÄ‡, Å¼e Flux byÅ‚ protoplastÄ… Reduxa  ApolloPodsumowanieÅatwo zauwaÅ¼yÄ‡, Å¼e na pierwszy ogieÅ„ NgRx, czy szerzej - Redux - potrafiÄ… nieco przytÅ‚oczyÄ‡ iloÅ›ciÄ… kodu, ktÃ³rÄ… trzeba napisaÄ‡, by nawet drobne funkcjonalnoÅ›ci dziaÅ‚aÅ‚y. Jest to jeden z najwiÄ™kszych zarzutÃ³w wobec tego rozwiÄ…zania, wiÄ™c jeÅ›li takie byÅ‚y Twoje odczucia podczas czytania tego artykuÅ‚u - gratulujÄ™ krytycznego myÅ›lenia! ZauwaÅ¼my jednak, Å¼e po przebrniÄ™ciu przez poczÄ…tkowe trudnoÅ›ci zostajemy z aplikacjÄ…, ktÃ³rÄ… bardzo Å‚atwo moÅ¼emy przetestowaÄ‡, rozszerzaÄ‡ i ktÃ³rej dziaÅ‚anie jest jasno zdefiniowane. ChcÄ™ teÅ¼ zwrÃ³ciÄ‡ uwagÄ™, Å¼e przytaczane tutaj przykÅ‚ady byÅ‚y trywialne, w zwiÄ…zku z czym stosunek tzw. boilerplate kodu do faktycznej logiki jest duÅ¼y. W przypadku zÅ‚oÅ¼onych aplikacji, w ktÃ³rych sens uÅ¼ycia bibliotek takich jak NgRx jest znacznie wiÄ™kszy, narzut ten staje siÄ™ duÅ¼o bardziej akceptowalny.Mam nadziejÄ™, Å¼e tym artykuÅ‚em zainspirowaÅ‚em nieco do zainteresowania siÄ™ tematem zarzÄ…dzania stanem aplikacji frontendowych. Serdecznie zapraszam do rozpoznawania tematu we wÅ‚asnym zakresie, gdyÅ¼ przedstawiÅ‚em tu zaledwie namiastkÄ™ moÅ¼liwoÅ›ci, jakie zapewnia Redux i NgRx.Linki  Repozytorium z projektem  Dokumentacja NgRx",
"url": "/2021/10/13/zarzadzanie-stanem-aplikacji-frontendowej.html",
"author": "Marcin Chrapkowicz",
"authorUrl": "/authors/mchrapkowicz.html",
"image": "mchrapkowicz.jpg",
"highlight": "/assets/img/posts/2021-09-31-zarzadzanie-stanem-aplikacji-frontendowej/ngrx.jpeg",
"date": "13-10-2021",
"path": "pl/2021-09-31-zarzadzanie-stanem-aplikacji-frontendowej"
}
,


"2021-09-13-kafka-retry-dlq-html": {
"title": "Reliable event delivery in Apache Kafka based on retry and DLQ",
"lang": "en",
"tags": "kouncil programming kafka event sourcing tool dlq",
"content": "Any complex information system may break at some point and this is why you need to have a plan for when something goes wrong while working with one. If you are lucky, the system you have chosen will provide you with ready-made solutions to deal with emergencies but if you are unfortunate enough to have ended up working with Kafka you will have to find other ways to fix problems. In this blog post you will learn why there is no DLQ (Dead Letter Queue) in Kafka and how to handle a situation that calls for such a mechanism.Why is there no DLQ in Kafka?Most popular queueing systems such as RabbitMQ or ActiveMQ have built-in systems responsible for reliable message delivery. So why doesnâ€™t Kafka offer one? The answer to this question is closely related to one of the architectural patterns underlying Kafka: dumb broker / smart consumer. This pattern boils down to the burden of logic associated with handling readings being shifted to the consumer. The consequence of this approach is the lack of a ready-made solution that can help the consumer in case of a problem during message processing. The broker is only interested in one piece of information: the position at which the consumer has committed an offset. Of course, you can always say that in this situation you should choose the right tool for the problem and use a queuing system with such support, however, you do not always have the freedom to implement multiple solutions in one system. If, like me, you have chosen Kafka as your event logging engine, then in case of the described problem you have to deal with it on your own and program it accordingly.How to deal with errors?Imagine a situation in which the event handling process involves communication with an external system. You have to decide how the consumer should behave when the external system responds in a different way than expected, or worse - does not respond at all. There are many strategies for handling such a situation. I have chosen four for the purpose of this article.Lack of error handlingA very popular and frequently used strategy for handling emergencies is lack of response, which all programmers of the world have surely faced. In the figure above, the rectangles denote consecutive messages in the topic. When a consumer encounters a problem processing the offset 4 message, it ignores it and moves on to the next one. Although this approach seems like a not very sensible solution, there are situations where losing some messages does not carry any risk. As an example, consider any solution that stores and analyzes user behavior in an application. Since the task of such a system is to collect statistical data, the loss of single events will not significantly affect the results. However, it is important to have effective monitoring which can detect a situation when the loss of messages exceeds some arbitrarily determined level.Infinite retryWhen you canâ€™t afford to lose messages, the simplest approach is to retry until the delivery succeeds. The obvious consequence is the so-called world stopping, where no further messages will be processed until the error is fixed or the external system is unblocked. Such a solution is necessary if you want to keep the order of processing events in the system. In this scenario, having constant monitoring is even more important.Finite retry at the point of an errorThe strategies discussed so far preserve the processing order of events. This is extremely important when events are interdependent and the consistency of your system relies on the order of processing. However, events do not always have this property and not having to preserve the order opens up new possibilities. Imagine what happens when you loosen the requirement for absolute sequentiality a bit. Letâ€™s assume that you keep retrying for a while, because statistics and experience tell you that 99% of problems with message processing are temporary and resolve themselves after some time. Additionally, you copy messages that failed to process to a separate topic treated as DLQ. As a result you have immediately identified problematic messages and you can run a separate consumer group on them. The problematic message 4 stops processing for a moment and then is copied to the topic of broken DLQ events. On the other hand, message 7 is only retried for a short time and after it succeeds, processing is resumed. But why are messages copied and not moved? The answer is very simple - they cannot be moved. This is due to another architectural foundation of Kafka, namely topic immutability. No matter what the cause of the error was, the message will be stored forever. There are ways to deal with this issue and we will come back to this later.Finite retry on a separate topicWe hereby come to our final solution. Since there is a separate topic for broken messages, it might be a good idea to introduce another one, where duplication takes place. In this model, you loosen the necessity of keeping the order even more, but you get the possibility of uninterrupted processing of the main topic in return. Consequently, you do not stop the world, and the messages are cascaded first to the topic of the retried messages, and in case of failure - to the topic DLQ. Theoretically we should call it DLT, but letâ€™s stick to the acronym DLQ, as it is well associated with this kind of technique. All four of the described options for dealing with an emergency apply to the system that this blog post is concerned with. The challenge is to match the appropriate method to the nature of the data being processed in the topic. It is also worth noting that one should learn from the greatest and that the last two models are heavily inspired by the way Kafka is used by Uber in their systems.Event trackingWhatever solution you choose, one thing is for sure: you need a tool that will allow you to track and see how events behave on topics. Kouncil (demo), which we have been developing for some time now, fits especially well in a situation involving the strategy with the retry topic and DLQ. Using track view and having a correlating identifier, you can quickly verify the event processing path. For example, you know that the event with the identifier h57z2z has been correctly processed, i.e. has passed through the events-in and events-out topics, which can be seen in the screenshot below.It may happen that you get a notification regarding non-delivery of a message with identifier oCvD19i . A quick glance allows you to confirm that the event first went to the topic for a retry, and eventually landed in DLQ.You can read more about event tracking in Marcin Mergoâ€™s article Event Tracking - finding a needle in a haystackDLQ and consumer groupsOne more important aspect remains, i.e. how to implement this solution when multiple consumer groups are involved. At first glance it might seem that, similarly to RabbitMQ, the retry topic and DLQ are closely related to the main topic but nothing could be further from the truth. The concept of consumer groups running in Kafka on the same topic but having a different implementation generates the need for the retry mechanism to be tied to a specific group. In particular, different groups may have different paging and error handling logic. The situation becomes even more complicated when consumer groups are dependent on each other in some way. One group may depend on whether another group has correctly processed a given message. In such a case, you have to carefully adjust the retry and error handling mechanisms so that the consistency of message processing is maintained.CleanupFinally, letâ€™s address the problem of data redundancy resulting from messages being copied between topics. In the case of the main topic, every message that eventually made it to the DLQ is considered corrupted. If it is possible to reprocess the message stream in your application, you need to handle this situation somehow. There are at least two solutions:  A log of corrupted messages, which can be built automatically based on the messages going to the DLQ. It consists of the offsets of messages from the main topic. During reprocessing the consumer, aware of the log, ignores all messages marked in it.  Compacting a topic - I mentioned that there is no way of changing or deleting messages from a topic. There is an exception to the above rule - the mechanism of compacting a topic. In a nutshell, it works this way: the broker runs a recurring task which browses the topic, collects messages with the same key and leaves only the newest messages. The trick is to insert into the stream a message with the same key as the corrupted one, but with empty content. The consumer must be prepared beforehand to handle such messages. Both techniques can be used at the same time, but it must be remembered that the offsets of compacted messages will disappear irretrievably from the topic.Topic retry contains messages that have no value after processing, so in this case it is enough to configure retention, i.e. message lifetime. You just have to remember that retention should not be shorter than the longest possible processing time of a single message.Topic DLQ should contain messages until they are diagnosed and the system is corrected. As this time is not easy to determine, retention is not an option. Hence the trick with date-based keys. If you consider incidents from a certain date to have been resolved, enter an empty message into DLQ with a key in the form of the date, and all messages will be removed from DLQ at the next compacting session.SummaryI hope that I managed to show on this simple example that an iterative approach to the problem can lead to interesting and effective solutions.",
"url": "/2021/09/13/kafka-retry-dlq.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2021-09-13-kafka-retry-dlq/kafka-retry-dlq4.png",
"date": "13-09-2021",
"path": "en/2021-09-13-kafka-retry-dlq"
}
,


"2021-09-08-kouncil-event-tracking-kafka-html": {
"title": "Event Tracking - finding a needle in a haystack",
"lang": "en",
"tags": "kouncil kafka event tracking",
"content": "Systems based on Apache Kafka generally use more than one topic, with events that are part of a single process often flowing between them. In some cases the events remain unchanged but the records on consecutive topics can also be modified, e.g. by adding data that is needed at further steps of the process. Event Tracking enables monitoring and visualizing the path of a given event or process by means of Kafka topics.As an example letâ€™s look at the system for sending notifications to users. Before a given notification is ready to be sent, it might have to go through several topics where more information could be added, e.g. the notificationâ€™s content or channel that will be used to send it.An example flow on KafkaSo how can you track the path of a single process among millions of them?I have seen it somewhereThe problem is not new and goes back to the time of microservices. A scenario in which more than one microservice is involved in handling a given HTTP request requires an easy way to track logs related to the processing of the request irrespective of how many microservices are involved in this process. There is a well-known solution to this problem - when the request appears in the system, e.g. when it reaches the API Gateway, all you need is to generate a random string of characters, put it into the HTTP header and then make sure that the header is passed between the microservices as well as inject its values into the logging context.Tracking logs between microservicesThanks to this solution all logs related to the request will be related by means of the identifier generated at the beginning. All you need to do is to search for this identifier in one of the popular logs aggregators, such as Splunk (as long as this kind of tool is available to you), and as a result you will get logs related with the searched request.But what does it have to do with Kafka?Headers to the rescueIt turns out that the experience from correlating logs from the realm of microservices will come in handy for event tracking on Kafka. Similarly to HTTP messages, records on Kafka can be tied to headers, which are key-value metadata.Using the pattern known from microservices where a record appears in the system for the first time, you generate a unique identifier and place it in the header. Next, analogically to how it is done in the case of microservices, when the event is travelling from one topic onto another you also pass the correlation header that is tied to it. Ideally, the value of the header is injected into the logging context as well.Passing the header between topics on KafkaHowever, it is clear that mere passing of the headers between topics is still far from the result we are trying to achieve here.So how should you go about it? Answering the following questions will be a good starting point:  What? - What are you really looking for? What header and with what values?  Where? - Which topics are you going to consider? Searching all topics might be too much, as usually you can limit the search to those with a particular functionality or flow.  When? - If there are millions of records on Kafka, searching all of them would take ages. However, in many cases the processes need a couple of seconds or minutes to fully go through Kafka, which means that generally you can narrow down the searching scope to 5, 15 minutes or e.g. an hour.Naturally, the narrower the search scope, the faster it will execute.So how can you use these three questions and practically track the path of a process through Kafka?Event Tracking in practiceThere are no out-of-the-box mechanisms in Kafka that would allow you to do that in a simple way. However, the tool that we have developed - Kouncil - provides this exact functionality as well as additional features and optimizations. By going to the Track tab, you will find filters that will give you answers to the three questions above.  First of all, you can specify what content in a header you are looking for. You can also select the way of matching the headline value with the actual value - it doesnâ€™t have to be a 1-to-1 match. You can choose from operators such as equal to, not equal to, is included, is not included, and even regular expressions.  Also, there is an option to specify the set of topics to be searched - in case there are hundreds or thousands of topics on the cluster, there is no need to search for them manually in the list - the topic selection component supports filtering.  On top of that, it is possible to specify the time interval you are interested in.Filters on the Track tabFilling those boxes manually each time might prove inconvenient but thereâ€™s a solution to this, which I will describe using the example of sending notifications from the beginning of the article. Letâ€™s assume that there are topics on the cluster which are responsible for the process of sending notifications: notification-input, where the notifications are generated, as well as other topics, through which events pass depending on the use case. These topics could be notification-content, -channel, -template, -delivery etc., on which events could be complemented with the required data. For example, events for which a notification channel needs to be set will go onto the notification-channel topic.Letâ€™s have a look inside the notification-input topic:Notification-input topicLetâ€™s assume that you want to track the path of a record with a vFeYAx key. What you need to do is simply click the record to view its details and then click the header that you are interested in.Selecting headerYou will be automatically redirected to the Event Tracking tab where the filter boxes will be already filled in on the basis of the selected record. You only have to add the required topics because by default only the one with the event whose path you want to track will be selected.Automatically filled Event Tracking filterNow you need to click Track events and monitor in real time how Kouncil is retrieving records with a given header. By sorting the results by time you can not only see when and through which topics a given process was passed, but you can also view the record at every stage of the process.Event Tracking resultsThis way of analyzing the process flow on Kafka enables you to save a lot of time, especially in the case of more complex processes where records can return to a topic that they were located on before, or while analyzing erroneous scenarios in which a process could have found itself on topics that serve errors. Searching analogous information in application logs is possible but usually turns out more time-consuming, especially if a given process involves modules belonging to various systems, with no easy way of a collective search of their logs.Whatâ€™s important is that you can start event tracking at any point of the process - it could be its beginning, as in the case of the notification-input topic, as well as the very end of the topicâ€™s flow - the result will be exactly the same.KouncilKouncil is free and its sources along with instructions are available on our GitHub. It is very easy to run and boils down to a single command, i.e. docker run, where you just need to point to any of the Kafka cluster nodes. The only thing Kouncil requires to support the Event Tracking is to ensure the existence of headers in the messages, while everything else related to searching the topics will be taken care of by our tool.",
"url": "/2021/09/08/kouncil-event-tracking-kafka.html",
"author": "Marcin Mergo",
"authorUrl": "/authors/mmergo.html",
"image": "mmergo.webp",
"highlight": "/assets/img/posts/2021-09-08-kouncil-event-tracking-kafka/route.jpeg",
"date": "08-09-2021",
"path": "en/2021-09-08-kouncil-event-tracking-kafka"
}
,


"2021-08-30-kouncil-introduction-html": {
"title": "Kouncil - a modern Kafka frontend",
"lang": "en",
"tags": "kouncil programming kafka event sourcing tool",
"content": "Less than two years ago I wrote about a tool we created while developing a system based on event sourcing on Kafka. Kafka Companion is gone but this is good news because its place has been taken by Kouncil. The new version of the tool offers all the features its predecessor had, while introducing some new ones. In addition to the eye-catching redesign of the application, there are new features which will be described in detail in upcoming posts on this blog.The rationale described in the previous article has not changed. We still feel that none of the available free GUIs for Kafka meet our expectations, despite quite a few of them being out there. Over the past years of working with Kafka we have developed a number of patterns and good practices that Kouncil allows us to oversee. I will now outline the various functionalities, placing particular emphasis on what has changed compared to its predecessor.Cluster health overviewThe screen allows you to preview the list of nodes in the cluster. It has been expanded to include basic statistics of the machine on which the node is embedded. Moreover, after selecting an item from the list, it is possible to review the values of all configuration parameters. It is also worth noting at this point the ability to support multiple clusters, which can be switched in the upper right corner.Viewing and adding messages to the topical directoryThe tabular presentation of messages in a topic is what we started building the tool with. Not surprisingly, there is still a lot of emphasis on the functionality and usability of this view. This is where the features awaited by many Kouncil users have been introduced, namely:  paging,  the ability to go to any offset,  support for native message headers.Consumer group status previewThis screen was functionally complete in the previous version, so not much has changed here, other than a clearer presentation of the rate at which message consumption is happening.Message trackingMessage tracking is a brand new feature that definitely sets us apart from the competition. More information about the rationale and features of this screen will be available in the next post.SummaryI am very pleased to showcase the result of our intensive work. Kouncil is still free and available on our GitHub. I have left one more surprise at the end in case the screenshots are not inviting enough: we have prepared a demo tool embedded in the GCP infrastructure, which you are welcome to download, test, and provide feedback on.",
"url": "/2021/08/30/kouncil-introduction.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2021-08-30-kouncil-introduction/kouncil_dashboard.png",
"date": "30-08-2021",
"path": "en/2021-08-30-kouncil-introduction"
}
,


"2021-08-20-stun-server-html": {
"title": "Czy wiesz, Å¼e WebRTC korzysta z serwera STUN, aby umoÅ¼liwiÄ‡ poÅ‚Ä…czenie P2P?",
"lang": "pl",
"tags": "webrtc stun p2p",
"content": "Czy wiesz Å¼e WebRTC korzysta z serwera STUN, aby umoÅ¼liwiÄ‡ poÅ‚Ä…czenie P2P, a w ostatecznoÅ›ci z serwera TURN aby przepuÅ›ciÄ‡ ruch przez niego i umoÅ¼liwiÄ‡ poÅ‚Ä…czenie?Rzadko kiedy zwykÅ‚y uÅ¼ytkownik posiada na swoim komputerze publiczne IP, przez co przekazanie informacji drugiej osobie â€œmoje ip to 192.168.0.Xâ€ nie umoÅ¼liwi poÅ‚Ä…czenia P2P.Nieudane poÅ‚Ä…czenie P2PÅºrÃ³dÅ‚o: MDN - dostÄ™p: 2020-08-20Dopiero wykorzystanie serwera STUN do okreÅ›lenia publicznego IP oraz ewentualnych ograniczeÅ„ moÅ¼e, w wiÄ™kszoÅ›ci przypadkÃ³w, pomÃ³c przy zestawieniu poÅ‚Ä…czenia P2P.Wykorzystanie serwera STUNÅºrÃ³dÅ‚o: MDN - dostÄ™p: 2020-08-20DziÄ™ki temu uÅ¼ytkownik A i B mogÄ… przesÅ‚aÄ‡ do siebie adresy przez serwer poÅ›redniczÄ…cy (tzw. signaling) i ustanowiÄ‡ poÅ‚Ä…czenie P2P.Niestety w niektÃ³rych przypadkach samo wykorzystanie STUN nie umoÅ¼liwia poÅ‚Ä…czenia P2P (np. kiedy uÅ¼ytkownik jest za symetrycznym NATem).Wtedy moÅ¼liwe jest wykorzystanie serwera TURN, ktÃ³ry bÄ™dzie dziaÅ‚aÅ‚ jak proxy dla przesyÅ‚anych pakietÃ³w.Niestety wiÄ…Å¼e siÄ™ to z wiÄ™kszym wykorzystaniem zasobÃ³w oraz Å‚Ä…cza sieciowego przy przesyÅ‚aniu pakietÃ³w przez dostawcÄ™ usÅ‚ugi WebRTC.Wykorzystanie serwera TURNÅºrÃ³dÅ‚o: MDN - dostÄ™p: 2020-08-20W tym wariancie poÅ‚Ä…czenie bezpoÅ›rednie nie byÅ‚o moÅ¼liwe, ale przesyÅ‚anie pakietÃ³w przez TURN pozwala uÅ¼ytkownikom nadal siÄ™ poÅ‚Ä…czyÄ‡ z przez WebRTC.PoÅ‚Ä…czenie w tym wypadku nadal bÄ™dzie bezpieczne, poniewaÅ¼ pakiety sÄ… szyfrowane i TURN nie ma moÅ¼liwoÅ›ci ich odczytania, sÅ‚uÅ¼y tylko jako poÅ›rednik.Darmowym serwerem STUN/TURN jest coTURN (https://github.com/coturn/coturn). A jeÅ›li chcesz zobaczyÄ‡, pod jakim adresem CiÄ™ widaÄ‡ z zewnÄ…trz moÅ¼esz wykorzystaÄ‡ to narzÄ™dzie online: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/.Å¹rÃ³dÅ‚ahttps://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Protocolshttps://blog.ivrpowers.com/post/technologies/what-is-stun-turn-server/https://www.html5rocks.com/en/tutorials/webrtc/infrastructure/",
"url": "/2021/08/20/stun-server.html",
"author": "Jakub Goszczurny",
"authorUrl": "/authors/jgoszczurny.html",
"image": "jgoszczurny.jpg",
"highlight": "/assets/img/posts/2021-08-20-stun-server/handshake.jpeg",
"date": "20-08-2021",
"path": "pl/2021-08-20-stun-server"
}
,


"2021-08-02-sredniki-w-js-html": {
"title": "Czy wiesz co siÄ™ dzieje, kiedy nie stawiasz Å›rednikÃ³w w JS?",
"lang": "pl",
"tags": "javascript",
"content": "KaÅ¼demu zdarza siÄ™ czasem zapomnieÄ‡ postawiÄ‡ Å›rednika na koÅ„cu linijki. Powinny to wyÅ‚apywaÄ‡ reguÅ‚y zawarte w narzÄ™dziach takich jak TSLint, ESList, lecz czasami mimo ich pomocy zapominamy o tym. I co wtedy? Niby nic siÄ™ nie dzieje, a kod dalej dziaÅ‚a wedÅ‚ug naszej myÅ›li, tylko dlaczego z jakiegoÅ› powodu wszyscy kaÅ¼Ä… stawiaÄ‡ te Å›redniki?Automatic Semicolon InsertionJavaScript nie wymaga od nas stawiania Å›rednikÃ³w. Posiada automat (Automatic Semicolon Insertion, w skrÃ³cie ASI), ktÃ³ry interpretuje nasz kod i wstawia je za nas. Opiera siÄ™ w skrÃ³cie na kilku zasadach: kiedy koÅ„czymy linijkÄ™ uÅ¼ywajÄ…c â€œ}â€, kiedy jest to koniec pliku, kiedy w linijce uÅ¼yjemy ktÃ³regoÅ› z sÅ‚Ã³w kluczowych: return, break, throw, continue oraz kiedy nowa linijka powoduje bÅ‚Ä…d w poÅ‚Ä…czeniu z nastÄ™pnÄ….Nie powinniÅ›my jednak opieraÄ‡ w peÅ‚ni na tych zasadach, bo Å‚atwo moÅ¼na popeÅ‚niÄ‡ bÅ‚Ä…d, ktÃ³ry ASI zinterpretuje w zaskakujÄ…cy sposÃ³b:const test = 12[&#39;c&#39;,&#39;d&#39;].forEach((letter) =&amp;gt; console.log(letter))// Cannot read property &#39;forEach&#39; of undefinedDzieje siÄ™ tak, poniewaÅ¼ JS sprÃ³bowaÅ‚ poÅ‚Ä…czyÄ‡ ze sobÄ… 12 i [â€˜câ€™,â€™dâ€™].Podobny przykÅ‚ad:var a = 1var b = a(a+b).toString()// Uncaught TypeError: a is not a functionCo powinniÅ›my w takim razie robiÄ‡? Nie opieraÄ‡ siÄ™ na ASI poniewaÅ¼, nie jesteÅ›my w stanie caÅ‚kowicie zdaÄ‡ siÄ™ na niego. Stawiajmy wszÄ™dzie Å›redniki, Å¼eby uniknÄ…Ä‡ niekonsekwencji w naszym kodzie.Po wiÄ™cej informacji odsyÅ‚am do dokumentacji.",
"url": "/2021/08/02/sredniki-w-js.html",
"author": "Piotr Grobelny",
"authorUrl": "/authors/pgrobelny.html",
"image": "pgrobelny.webp",
"highlight": "/assets/img/posts/2021-08-02-sredniki-w-js/semicolon.jpg",
"date": "02-08-2021",
"path": "pl/2021-08-02-sredniki-w-js"
}
,


"2021-07-16-zarzadzanie-dostepem-przy-uzyciu-access-control-list-html": {
"title": "ZarzÄ…dzanie dostÄ™pem przy uÅ¼yciu ACL (Access Control List)",
"lang": "pl",
"tags": "acl access control list spring security acl access control list authorization",
"content": "W Å›wiecie programistÃ³w Java, od wielu lat prym wiedzie Spring Framework, ktÃ³ry bÅ‚yskawicznie dostosowuje siÄ™ do panujÄ…cych trendÃ³w. Trudno sobie wyobraziÄ‡ programistÄ™ Java, szczegÃ³lnie aplikacji internetowych, ktÃ³ry nie znaÅ‚by tego projektu, lub precyzyjniej, zbioru projektÃ³w. Jednym z popularnych i bardzo dojrzaÅ‚ych elementÃ³w ekosystemu, jest Spring Security, ktÃ³ry dostarcza gotowe rozwiÄ…zania dla rÃ³Å¼nych zawiÅ‚ych zagadnieÅ„ w zakresie bezpieczeÅ„stwa.Kilka lat temu, kiedy zaczynaÅ‚em przygodÄ™ z programowaniem, moim pierwszym komercyjnym projektem do wykonania, byÅ‚o zaimplementowanie aplikacji internetowej, ktÃ³ra miaÅ‚a sÅ‚uÅ¼yÄ‡ do zarzÄ…dzania zadaniami. Zadania te byÅ‚y przypisane do konkretnych uÅ¼ytkownikÃ³w, ktÃ³rzy nie mogli sobie ich nawzajem przeglÄ…daÄ‡. Problem wydawaÅ‚ siÄ™ byÄ‡ powszechny. Po krÃ³tkim poszukiwaniu, natknÄ…Å‚em siÄ™ na koncepcjÄ™ znanÄ… jako Access Control List oraz jego realizacjÄ… w Spring Security ACL, ktÃ³ra jest rozszerzeniem Spring Security. To byÅ‚o to, czego szukaÅ‚em!W tym artykule wyjaÅ›niÄ™, dlaczego Spring Security jest niewystarczajÄ…cy do zrealizowania wspomnianego wymagania, i dlaczego potrzebujemy rozszerzenia Spring Security ACL. Dodatkowo przedstawiÄ™ fragmenty kodu, ktÃ³re sÄ… istotne w naszym projekcie.PeÅ‚ny kod jest dostÄ™pny pod adresem https://github.com/pawelwalaszek/spring-security-acl.Czym wÅ‚aÅ›ciwie jest Access Control List?KrÃ³tka definicja brzmi:Access Control List (ACL) jest listÄ… uprawnieÅ„ skojarzonych z obiektem.W naszym przypadku obiektem jest zadanie. Natomiast lista uprawnieÅ„ jest przechowywana w specjalnych strukturach tabelarycznych znajdujÄ…cych siÄ™ w bazie danych, w ktÃ³rej sÄ… zdefiniowane relacje miÄ™dzy obiektem, a uÅ¼ytkownikiem.Dlaczego Spring Security jest niewystarczajÄ…cy?Spring Security pozwala okreÅ›liÄ‡ dostÄ™p na poziomie Å¼Ä…dania HTTP lub wywoÅ‚ania metody.PrzykÅ‚ad:@PreAuthorize(&quot;hasRole(&#39;TASK&#39;)&quot;)public List&amp;lt;Task&amp;gt; getTasksWithoutAcl() {    return taskRepository.findAll();}W powyÅ¼szym przykÅ‚adzie uÅ¼ytkownik z rolÄ… TASK otrzyma peÅ‚nÄ… listÄ™ obiektÃ³w Task. Nie jest to zgodne z naszym wymaganiem, poniewaÅ¼ chcemy, aby uÅ¼ytkownik otrzymaÅ‚ wyselekcjonowanÄ… listÄ™ obiektÃ³w Task, dokÅ‚adniej, listÄ™ obiektÃ³w do ktÃ³rych zostaÅ‚ przypisany.Spring Security ACL pozwala okreÅ›liÄ‡ dostÄ™p na poziomie obiektÃ³w.PrzykÅ‚ad:@PreAuthorize(&quot;hasRole(&#39;TASK&#39;)&quot;)@PostFilter(&quot;hasPermission(filterObject, &#39;READ&#39;)&quot;)public List&amp;lt;Task&amp;gt; getTasksWithAcl() {    return taskRepository.findAll();}W powyÅ¼szym przykÅ‚adzie uÅ¼ytkownik z rolÄ… TASK otrzyma listÄ™ obiektÃ³w Task, ale tylko tych, do ktÃ³rych otrzymaÅ‚ uprawnienie odczytu.@PreAuthorize â€“ sprawdza, czy uÅ¼ytkownik posiada rolÄ™ TASK, a w przypadku jej braku generuje wyjÄ…tek, ktÃ³ry tworzy odpowiedÅº HTTP ze statusem 403.@PostFilter â€“ usuwa obiekty z kolekcji, do ktÃ³rych uÅ¼ytkownik nie ma uprawnieÅ„.Kombinacja adnotacji @PreAuthorize i @PostFilter jest bardzo wygodna, ale Å¼eby taka byÅ‚a, naleÅ¼y odpowiednio przygotowaÄ‡ konfiguracjÄ™ w naszej aplikacji zarÃ³wno dla Spring Security jak i dla Spring Security ACL.Konfiguracjaa) Konfiguracja dla Spring Security:@Configuration@EnableWebSecuritypublic class SecurityConfig extends WebSecurityConfigurerAdapter {    @Override    public void configure(WebSecurity webSecurity) throws Exception {        webSecurity.ignoring().antMatchers(&quot;/h2-console/**&quot;);    }    @Override    protected void configure(HttpSecurity http) throws Exception {        http.csrf().disable()            .authorizeRequests()            .anyRequest().authenticated()            .and()            .formLogin()            .and()            .httpBasic();    }    @Override    protected void configure(AuthenticationManagerBuilder auth) throws Exception {        auth.inMemoryAuthentication()                .withUser(&quot;admin&quot;).password(passwordEncoder().encode(&quot;admin&quot;)).roles(&quot;ADMINISTRATION&quot;)                .and()                .withUser(&quot;user1&quot;).password(passwordEncoder().encode(&quot;user1&quot;)).roles(&quot;TASK&quot;)                .and()                .withUser(&quot;user2&quot;).password(passwordEncoder().encode(&quot;user2&quot;)).roles(&quot;TASK&quot;);    }    @Bean    public PasswordEncoder passwordEncoder() {        return new BCryptPasswordEncoder();    }}b) Konfiguracja dla Spring Security ACL. W tym punkcie dokÅ‚adniej przyjrzyjmy siÄ™ konfiguracji.Pierwszym istotnym krokiem jest dodanie klasy DefaultMethodSecurityExpressionHandler, ktÃ³ra jest wzbogacona o obsÅ‚ugÄ™ wyraÅ¼eÅ„ ACL.W tym miejscu dochodzi do zaÅ‚adowania przydzielonych uprawnieÅ„ oraz skonfrontowanie ich z zabezpieczonymi obiektami. Na potrzeby wspomnianejklasy naleÅ¼y dodaÄ‡ klasÄ™ JdbcMutableAclService, ktÃ³ra wchodzi w interakcjÄ™ z bazÄ… danych. To w tej klasie sÄ… zdefiniowane zapytania SQL.Dodatkowa klasa BasicLookupStrategy okreÅ›la strategiÄ™, ktÃ³ra optymalizuje zapytania. W naszym przypadku optymalizacja jest wykonanaprzy zaÅ‚oÅ¼eniu, Å¼e uÅ¼yta baza danych jest zgodna z ANSI SQL.@Autowiredprivate MethodSecurityExpressionHandler defaultMethodSecurityExpressionHandler;@Overrideprotected MethodSecurityExpressionHandler createExpressionHandler() {    return defaultMethodSecurityExpressionHandler;}@Beanpublic MethodSecurityExpressionHandler defaultMethodSecurityExpressionHandler(DataSource dataSource) {    DefaultMethodSecurityExpressionHandler expressionHandler = new DefaultMethodSecurityExpressionHandler();    AclPermissionEvaluator permissionEvaluator = new AclPermissionEvaluator(aclService(dataSource));    expressionHandler.setPermissionEvaluator(permissionEvaluator);    return expressionHandler;}@Beanpublic JdbcMutableAclService aclService(DataSource dataSource) {    return new JdbcMutableAclService(dataSource, lookupStrategy(dataSource), aclCache());}@Beanpublic LookupStrategy lookupStrategy(DataSource dataSource) {    return new BasicLookupStrategy(dataSource, aclCache(), aclAuthorizationStrategy(), new ConsoleAuditLogger());}Klasa AclAuthorizationStrategyImpl definiujÄ™ strategiÄ™, ktÃ³ra okreÅ›la, w jakich warunkach jest przydzielane uprawnienie.JeÅ›li jesteÅ›my wÅ‚aÅ›cicielem obiektu lub mamy uprawnienie administracyjne, wtedy otrzymujemy dostÄ™p do obiektu.@Beanpublic AclAuthorizationStrategy aclAuthorizationStrategy() {    return new AclAuthorizationStrategyImpl(new SimpleGrantedAuthority(&quot;ROLE_TASK&quot;));}Klasa DefaultPermissionGrantingStrategy definujÄ™ dodatkowÄ… strategiÄ™, ktÃ³ra okreÅ›la, czy jest przydzielane uprawnienie. JeÅ›li nie jesteÅ›mywÅ‚aÅ›cicielem obiektu i nie mamy uprawnienia administracyjnego, ale posiadamy wpisy w bazie definiujÄ…ce uprawnienie do obiektu,to otrzymujemy dostÄ™p do obiektu.@Beanpublic PermissionGrantingStrategy permissionGrantingStrategy() {    return new DefaultPermissionGrantingStrategy(new ConsoleAuditLogger());}W repozytorium, w konfiguracji ACL znajdujÄ… siÄ™ dodatkowe klasy odpowiedzialne za cache, ktÃ³ry zmniejsza iloÅ›Ä‡ zapytaÅ„ do bazy danych.c) Struktura schematu dla poszczegÃ³lnych baz danych jest dostÄ™pna w kodach ÅºrÃ³dÅ‚owych Spring Security tutaj. W naszym przypadku DDL jest dla bazy danych H2:-- App schemasCREATE TABLE IF NOT EXISTS tasks (  id bigint(20) NOT NULL AUTO_INCREMENT,  chapter varchar(100) NOT NULL,  title varchar(100) NOT NULL,  description varchar(1000),  creation_date TIMESTAMP WITH TIME ZONE NOT NULL,  PRIMARY KEY (id));-- ACL schemasCREATE TABLE IF NOT EXISTS acl_sid (  id bigint(20) NOT NULL AUTO_INCREMENT,  principal tinyint(1) NOT NULL,  sid varchar(100) NOT NULL,  PRIMARY KEY (id),  UNIQUE KEY unique_uk_1 (sid,principal));CREATE TABLE IF NOT EXISTS acl_class (  id bigint(20) NOT NULL AUTO_INCREMENT,  class varchar(255) NOT NULL,  PRIMARY KEY (id),  UNIQUE KEY unique_uk_2 (class));CREATE TABLE IF NOT EXISTS acl_entry (  id bigint(20) NOT NULL AUTO_INCREMENT,  acl_object_identity bigint(20) NOT NULL,  ace_order int(11) NOT NULL,  sid bigint(20) NOT NULL,  mask int(11) NOT NULL,  granting tinyint(1) NOT NULL,  audit_success tinyint(1) NOT NULL,  audit_failure tinyint(1) NOT NULL,  PRIMARY KEY (id),  UNIQUE KEY unique_uk_4 (acl_object_identity,ace_order));CREATE TABLE IF NOT EXISTS acl_object_identity (  id bigint(20) NOT NULL AUTO_INCREMENT,  object_id_class bigint(20) NOT NULL,  object_id_identity bigint(20) NOT NULL,  parent_object bigint(20) DEFAULT NULL,  owner_sid bigint(20) DEFAULT NULL,  entries_inheriting tinyint(1) NOT NULL,  PRIMARY KEY (id),  UNIQUE KEY unique_uk_3 (object_id_class,object_id_identity));ALTER TABLE acl_entryADD FOREIGN KEY (acl_object_identity) REFERENCES acl_object_identity(id);ALTER TABLE acl_entryADD FOREIGN KEY (sid) REFERENCES acl_sid(id);ALTER TABLE acl_object_identityADD FOREIGN KEY (parent_object) REFERENCES acl_object_identity (id);ALTER TABLE acl_object_identityADD FOREIGN KEY (object_id_class) REFERENCES acl_class (id);ALTER TABLE acl_object_identityADD FOREIGN KEY (owner_sid) REFERENCES acl_sid (id);PrzykÅ‚adowe daneUtworzony schemat naleÅ¼y wypeÅ‚niÄ‡ odpowiednimi danymi. W naszej aplikacji mamy dwÃ³ch predefiniowanych uÅ¼ytkownikÃ³w user1 i user2 z takÄ… samÄ… rolÄ… TASK. Dla tych uÅ¼ytkownikÃ³w utworzymy 8 zadaÅ„ i odpowiednio przypiszemy ich do poszczegÃ³lnych zadaÅ„. UÅ¼ytkownik user1 bÄ™dzie mieÄ‡ prawo odczytu do zadaÅ„ z kategorii Security, natomiast uÅ¼ytkownik user2 bÄ™dzie mieÄ‡ prawo odczytu do pozostaÅ‚ych zadaÅ„. W naszym przykÅ‚adzie ograniczamy siÄ™ jedynie do prawa odczytu, jednak ACL umoÅ¼liwia nadawanie uprawnieÅ„ dla odczytu, zapisu, tworzenia oraz usuwania.Warto podkreÅ›liÄ‡, Å¼e model aplikacji nie jest bezpoÅ›rednio powiÄ…zany z tabelami, w ktÃ³rych sÄ… trzymane informacje o uprawnieniach. PoÅ›rednim powiÄ…zaniem miÄ™dzy modelem aplikacji, a zdefiniowanymi uprawnieniami, sÄ… adnotacje.W naszej przykÅ‚adowej aplikacji dodajemy dane bezpoÅ›rednio do bazy danych za pomocÄ… DML.-- Kilka przykÅ‚adowych zadaÅ„INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (1, &#39;Security&#39;, &#39;tytuÅ‚ 1&#39;, &#39;opis zadania 1&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (2, &#39;Cloud&#39;, &#39;tytuÅ‚ 2&#39;, &#39;opis zadania 2&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (3, &#39;Security&#39;, &#39;tytuÅ‚ 3&#39;, &#39;opis zadania 3&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (4, &#39;Cloud&#39;, &#39;tytuÅ‚ 4&#39;, &#39;opis zadania 4&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (5, &#39;Frontend&#39;, &#39;tytuÅ‚ 5&#39;, &#39;opis zadania 5&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (6, &#39;Security&#39;, &#39;tytuÅ‚ 6&#39;, &#39;opis zadania 6&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (7, &#39;Cloud&#39;, &#39;tytuÅ‚ 7&#39;, &#39;opis zadania 7&#39;, current_timestamp);INSERT INTO tasks (id, chapter, title, description, creation_date) VALUES (8, &#39;Storage&#39;, &#39;tytuÅ‚ 8&#39;, &#39;opis zadania 8&#39;, current_timestamp);-- ACL - przepisanie uprawnieÅ„INSERT INTO acl_sid (id, principal, sid) VALUES(1, 0, &#39;ROLE_TASK&#39;),(2, 1, &#39;admin&#39;),(3, 1, &#39;user1&#39;),(4, 1, &#39;user2&#39;);INSERT INTO acl_class (id, class) VALUES(1, &#39;com.consdata.task.model.Task&#39;);INSERT INTO acl_object_identity (id, object_id_class, object_id_identity, parent_object, owner_sid, entries_inheriting) VALUES(1, 1, 1, NULL, 2, 0),(2, 1, 3, NULL, 2, 0),(3, 1, 6, NULL, 2, 0),(4, 1, 2, NULL, 2, 0),(5, 1, 4, NULL, 2, 0),(6, 1, 5, NULL, 2, 0),(7, 1, 7, NULL, 2, 0),(8, 1, 8, NULL, 2, 0);INSERT INTO acl_entry (id, acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure) VALUES(1, 1, 1, 3, 1, 1, 1, 0),(2, 2, 1, 3, 1, 1, 1, 0),(3, 3, 1, 3, 1, 1, 1, 0),(4, 4, 1, 4, 1, 1, 1, 0),(5, 5, 1, 4, 1, 1, 1, 0),(6, 6, 1, 4, 1, 1, 1, 0),(7, 7, 1, 4, 1, 1, 1, 0),(8, 8, 1, 4, 1, 1, 1, 0);Opis poszczegÃ³lnych tabel zostaÅ‚ przedstawiony tutaj.MoÅ¼emy rÃ³wnieÅ¼ programowo dodawaÄ‡ uprawnienia do uÅ¼ytkownikÃ³w. PrzykÅ‚ad klasy, ktÃ³ra to realizuje:@RequiredArgsConstructor@Servicepublic class PermissionService {    private final MutableAclService aclService;    public void addPermission(String username, Class&amp;lt;?&amp;gt; type, Long id, Permission permission) {        ObjectIdentity objectIdentity = new ObjectIdentityImpl(type, id);        Sid sid = new PrincipalSid(username);        MutableAcl acl;        try {            acl = (MutableAcl) aclService.readAclById(objectIdentity);        } catch (NotFoundException exception) {            acl = aclService.createAcl(objectIdentity);        }        acl.insertAce(acl.getEntries().size(), permission, sid, true);        aclService.updateAcl(acl);    }}Access Control List w akcjiOmÃ³wiliÅ›my juÅ¼ wszystkie niezbÄ™dne kwestie. JesteÅ›my gotowi uruchomiÄ‡ aplikacjÄ™ i jÄ… przetestowaÄ‡. PeÅ‚ny kod znajduje siÄ™ pod adresem https://github.com/pawelwalaszek/spring-security-acl.mvn spring-boot:runUwaga! Dla kaÅ¼dego uÅ¼ytkownika naleÅ¼y zalogowaÄ‡ siÄ™ w osobnym trybie incognito, gdyÅ¼ pozwoli nam uniknÄ…Ä‡ problemÃ³w z cachowaniem danych dostÄ™powych w przeglÄ…darce internetowej.WejÅ›cie pod adres:http://localhost:8080/tasks/list-with-acli zalogowanie siÄ™ jako user1 z hasÅ‚em user1 spowoduje wyÅ›wietlenie zadaÅ„ tylko z kategorii Security. Natomiast dla uÅ¼ytkownika user2 z hasÅ‚em user2 zostanÄ… wyÅ›wietlone zadania z pozostaÅ‚ych kategorii.SprÃ³bujmy przypisaÄ‡ uÅ¼ytkownikowi user1 uprawnienie do odczytywania zadania z identyfikatorem nr 8. Dla tej sytuacji zostaÅ‚ przygotowany endpoint, ktÃ³ry potrafi zrealizowaÄ‡ takÄ… operacjÄ™.curl -X PUT -u admin:admin http://localhost:8080/permissions/READ/tasks/8/users/user1/addPonowne wejÅ›cie pod adres:http://localhost:8080/tasks/list-with-acli zalogowanie siÄ™ jako user1 z hasÅ‚em user1 spowoduje wyÅ›wietlenie zadaÅ„ z kategorii Security oraz jedno zadanie z identyfikatorem nr 8, czyli zadanie z kategorii Storage.WejÅ›cie pod adres:http://localhost:8080/tasks/list-without-acldowolnym uÅ¼ytkownikiem spowoduje wyÅ›wietlenie wszystkich zadaÅ„, gdyÅ¼ dla tego adresu zostaÅ‚ okreÅ›lony dostÄ™p na poziomie wywoÅ‚ania metody, w tym przypadku, dla uÅ¼ytkownikÃ³w z rolÄ… TASK.PodsumowanieCzy potrzebujmy Spring Security ACL? To zaleÅ¼y od wymagaÅ„:  Tak, jeÅ›li potrzebujemy okreÅ›laÄ‡ dostÄ™p na poziomie obiektÃ³w.  Nie, jeÅ›li potrzebujemy okreÅ›laÄ‡ dostÄ™p na poziomie Å¼Ä…dania HTTP lub wywoÅ‚ania metody.Tym artykuÅ‚em chciaÅ‚bym zwrÃ³ciÄ‡ uwagÄ™ na obecnoÅ›Ä‡ gotowej implementacji Access Control List oraz jaki konkretny problem rozwiÄ…zuje. Warto skorzystaÄ‡ z gotowych i dojrzaÅ‚ych rozwiÄ…zaÅ„, takich jak, Spring Security ACL, gdyÅ¼ pozwoli nam zaoszczÄ™dziÄ‡ sporo czasu oraz uniknÄ…Ä‡ potencjalnych bÅ‚Ä™dÃ³w podczas tworzenia wÅ‚asnej implementacji.",
"url": "/2021/07/16/zarzadzanie-dostepem-przy-uzyciu-access-control-list.html",
"author": "PaweÅ‚ Walaszek",
"authorUrl": "/authors/pwalaszek.html",
"image": "pwalaszek.jpg",
"highlight": "/assets/img/posts/2021-07-16-zarzadzanie-dostepem-przy-uzyciu-access-control-list/acl.png",
"date": "16-07-2021",
"path": "pl/2021-07-16-zarzadzanie-dostepem-przy-uzyciu-access-control-list"
}
,


"2021-07-08-metaprogramowanie-w-javie-html": {
"title": "Metaprogramowanie w Javie - @Target",
"lang": "pl",
"tags": "java",
"content": "W tym artykule dowiemy siÄ™ jak uÅ¼ywaÄ‡ adnotacji @Target przy tworzeniu wÅ‚asnej adnotacji.@Target okreÅ›la, w ktÃ³rych miejscach konstruowana przez nas adnotacja moÅ¼e zostaÄ‡ uÅ¼yta. Gdy zadeklarujemy, w jakich miejscach kodu jest moÅ¼liwe uÅ¼ycie adnotacji, bÅ‚Ä™dne jej umiejscowienie nie pozwoli na skompilowanie kodu.Podstawowa skÅ‚adnia adnotacjiAdnotacje tworzy siÄ™ uÅ¼ywajÄ…c deklaracji interface ze znakiem @ na poczÄ…tku. Taka adnotacja nic nie robi, lecz program nie wyrzuci bÅ‚Ä™du przy kompilacji.public @interface MyAnnotation {}PowyÅ¼sza adnotacja nie ma zdefiniowanego miejsca, w ktÃ³rym moÅ¼emy jej uÅ¼yÄ‡. Aby to zrobiÄ‡, naleÅ¼y dodaÄ‡ adnotacjÄ™ @Target, wraz z parametrami.Parametry do adnotacji @Target moÅ¼emy przekazaÄ‡ na 4 rÃ³Å¼ne sposoby. W trzecim i czwartym przykÅ‚adzie moÅ¼liwe jest zdefiniowanie jednej lub wiÄ™kszej liczby typÃ³w:@Target(ElementType.FIELD)@Target(value=ElementType.FIELD)@Target({ElementType.FIELD, ElementType.CONSTRUCTOR})@Target(value={ElementType.FIELD, ElementType.CONSTRUCTOR})Gdzie moÅ¼emy uÅ¼yÄ‡ adnotacji, w zaleÅ¼noÅ›ci od przekazanego typu ElementType?  ElementType.ANNOTATION_TYPE - adnotacja do tworzenia adnotacji ğŸ™‚. Na przykÅ‚ad wymienione w tytule @Target() jest takÄ… adnotacjÄ…. Inny przykÅ‚ad to @Retention() opisujÄ…ce cykl Å¼ycia adnotacji. Obie sÄ… oznaczone adnotacjÄ… ElementType.ANNOTATION_TYPE.@Target({ ElementType.ANNOTATION_TYPE })public @interface MyAnnotation {}@MyAnnotation@interface NewAnnotation {}  ElementType.CONSTRUCTOR - przy deklaracji konstruktora.@Target({ ElementType.CONSTRUCTOR })public @interface MyAnnotation {} public class NewClass {         @MyAnnotation    public NewClass(){}}  ElementType.FIELD - przy deklaracji pola w klasie.@Target({ ElementType.FIELD })public @interface MyAnnotation {} public class NewClass {         @MyAnnotation    private String text;}  ElementType.LOCAL_VARIABLE - przy deklaracji lokalnej zmiennej (np. w funkcji). Nie myliÄ‡ z deklaracjÄ… FIELD.@Target({ ElementType.LOCAL_VARIABLE })public @interface MyAnnotation {} public class NewClass {         public void newFunction(){        @MyAnnotation        String text = &quot;text&quot;;    }}  ElementType.METHOD - przy deklaracji metody/funkcji.@Target({ ElementType.METHOD })public @interface MyAnnotation {} public class NewClass {     @MyAnnotation    public void newFunction(){}}  ElementType.PACKAGE - przy deklaracji pakietu. MoÅ¼liwe jedynie do dodania w pliku package-info.java!@Target({ ElementType.PACKAGE })public @interface MyAnnotation {} @MyAnnotationpackage mypackage; // tylko w pliku package-info.java  ElementType.PARAMETER - przy deklaracji parametrÃ³w metody/funkcji.@Target({ ElementType.PARAMETER })public @interface MyAnnotation {} public class NewClass {    public void newFunction(@MyAnnotation int a, @MyAnnotation String b){}}  ElementType.TYPE - przy deklaracji klasy, interfejsu, enuma.@Target({ ElementType.TYPE })public @interface MyAnnotation {} @MyAnnotationpublic class NewClass {}  ElementType.TYPE_USE - od Javy 8. WszÄ™dzie tam gdzie uÅ¼yty jest typ. â€œAs of the Java SE 8 release, annotations can also be applied to any type use. This means that annotations can be used anywhere you use a type. A few examples of where types are used are class instance creation expressions (new), casts, implements clauses, and throws clausesâ€.@Target({ ElementType.TYPE_USE })public @interface MyAnnotation {} public class NewClass extends @MyAnnotation Object{    List&amp;lt; @MojaAdnotacja String&amp;gt; myList;    int a = (@MyAnnotation int) 4.21;    Exception e = new @MyAnnotation Exception();}  ElementType.TYPE_PARAMETER- od Javy 8. Przy definiowaniu typÃ³w generycznych.@Target({ ElementType.TYPE_PARAMETER })public @interface MyAnnotation {}public class NewClass&amp;lt; @MyAnnotation T&amp;gt;{    &amp;lt;@MyAnnotation U&amp;gt; void myMethod(){    }}W przypadku gdy nie zadeklarujemy, w ktÃ³rym miejscu moÅ¼emy uÅ¼yÄ‡ adnotacji, moÅ¼emy jej uÅ¼yÄ‡ wszÄ™dzie oprÃ³cz TYPE_USE i TYPE_PARAMETER.public @interface MyAnnotation {} @MyAnnotation@interface NewAnnotation {} @MyAnnotationpublic class NewClass {     @MyAnnotation    String newField;     @MyAnnotation    public NewClass(){    }     @MyAnnotation    public void newFunction(@MyAnnotation String parametr){        @MyAnnotation String myLocalVariable;    }}Å¹rÃ³dÅ‚a:  https://www.programmersought.com/article/7951304416/  https://www.samouczekprogramisty.pl/adnotacje-w-jezyku-java/  https://bykowski.pl/adnotacje-w-jezyku-java-2/  https://docs.oracle.com/javase/tutorial/java/annotations/basics.html  https://docs.oracle.com/javase/tutorial/java/annotations/type_annotations.html",
"url": "/2021/07/08/metaprogramowanie-w-javie.html",
"author": "Dominik Surdyk",
"authorUrl": "/authors/dsurdyk.html",
"image": "dsurdyk.webp",
"highlight": "/assets/img/posts/2021-07-06-metaprogramowanie-w-javie/metaprogramowanie.jpeg",
"date": "08-07-2021",
"path": "pl/2021-07-08-metaprogramowanie-w-javie"
}
,


"2021-05-31-slowo-kluczowe-volatile-html": {
"title": "Volatile nie naleÅ¼y siÄ™ baÄ‡",
"lang": "pl",
"tags": "java",
"content": "SÅ‚owo kluczowe volatile wydaje siÄ™ jednym z najrzadziej stosowanych, ale teÅ¼ najbardziej tajemniczych i najsÅ‚abiej poznanych sÅ‚Ã³w kluczowych w Javie. Do czego wiÄ™c sÅ‚uÅ¼y, i czy jest siÄ™ czego baÄ‡?Na poczÄ…tek naleÅ¼y zauwaÅ¼yÄ‡, Å¼e volatile ma zastosowanie jedynie w przypadku zmiennych. Sam typ zmiennej, oraz to, czy jest to typ prosty czy zÅ‚oÅ¼ony, nie ma znaczenia. PrzykÅ‚adowe uÅ¼ycie sÅ‚owa volatile wyglÄ…da nastÄ™pujÄ…co:private volatile int myInt = 0;Volatile ma zastosowanie w przypadku aplikacji wielowÄ…tkowych, i zwiÄ…zane jest z optymalizacjami, ktÃ³re wykonuje zarÃ³wno procesor, jak i JVM podczas zmiany wartoÅ›ci zmiennych, z ktÃ³rych korzysta wiÄ™cej niÅ¼ jeden wÄ…tek. Brzmi skomplikowanie? WyobraÅºmy sobie sytuacjÄ™, w ktÃ³rej wÄ…tki A oraz B majÄ… dostÄ™p do zmiennej foo. W przypadku kiedy wÄ…tek A zmieni wartoÅ›ci tej zmiennej, zmiana ta niekoniecznie bÄ™dzie od razu spropagowana do wÄ…tku B! W skrajnym przypadku moÅ¼e nie zostaÄ‡ spropagowana nigdy. Oznacza to, Å¼e dwa wÄ…tki, odczytujÄ…ce pozornie tÄ… samÄ… zmiennÄ…, mogÄ… widzieÄ‡ dwie rozbieÅ¼ne wartoÅ›ci. Tyle teorii, kod jest ciekawszy.Å»eby lepiej zobrazowaÄ‡ problem, pochylmy siÄ™ nad poniÅ¼szym kawaÅ‚kiem kodu:public class VolatileExample {     private static int counter = 0;     public static void main(String[] args) {        ThreadSupplier producer = () -&amp;gt; {            while (true) {                System.out.println(format(&quot;Ustawiam licznik na %s&quot;, ++counter));                Thread.sleep(1000);            }        };         ThreadSupplier consumer = () -&amp;gt; {            int localCounter = counter;            while (true) {                if (localCounter != counter) {                    System.out.println(format(&quot;Licznik zmieniÅ‚ wartoÅ›Ä‡ na: %s&quot;, localCounter = counter));                }            }        };         CompletableFuture.allOf(supplyAsync(producer), supplyAsync(consumer)).join();    }}Co robi ta klasa? Uruchamia dwa wÄ…tki: odpowiednio wÄ…tek producenta, podbijajÄ…cy raz na sekundÄ™ licznik, oraz wÄ…tek konsumenta, ktÃ³ry w pÄ™tli sprawdza czy licznik zmieniÅ‚ wartoÅ›Ä‡, a jeÅ›li tak - wypisuje jego wartoÅ›Ä‡.Jakiego wyjÅ›cia na pierwszy rzut oka moÅ¼na by siÄ™ spodziewaÄ‡ po odpaleniu powyÅ¼szego kodu? Prawdopodobnie wielu z nas spodziewaÄ‡ siÄ™ bÄ™dzie efektu mniej wiÄ™cej jak poniÅ¼ej - i wydaje siÄ™ to zupeÅ‚nie rozsÄ…dne:Ustawiam licznik na 1Licznik zmieniÅ‚ wartoÅ›Ä‡ na: 1Ustawiam licznik na 2Licznik zmieniÅ‚ wartoÅ›Ä‡ na: 2Ustawiam licznik na 3Licznik zmieniÅ‚ wartoÅ›Ä‡ na: 3Ustawiam licznik na 4Licznik zmieniÅ‚ wartoÅ›Ä‡ na: 4Ustawiam licznik na 5Licznik zmieniÅ‚ wartoÅ›Ä‡ na: 5Tymczasem jednak, po uruchomieniu tego kodu najprawdopodobniej zobaczycie takie wyjÅ›cie:Ustawiam licznik na 1Ustawiam licznik na 2Ustawiam licznik na 3Ustawiam licznik na 4Ustawiam licznik na 5...Ustawiam licznik na 1000Co siÄ™ dzieje z wÄ…tkiem konsumenta, a w szczegÃ³lnoÅ›ci, dlaczego nie podchwytuje zmian licznika? Okazuje siÄ™, Å¼e oba te wÄ…tki - producent oraz konsument - posiadajÄ… wÅ‚asnÄ… kopiÄ™ zmiennej counter. Kiedy jeden z wÄ…tkÃ³w zmienia jej wartoÅ›Ä‡, to JVM oraz procesor decydujÄ…, kiedy przepropagowaÄ‡ jej wartoÅ›Ä‡ do pozostaÅ‚ych wÄ…tkÃ³w. W imiÄ™ optymalizacji taka propagacja moÅ¼e nie nastÄ…piÄ‡ nigdy. Jak wiÄ™c naprawiÄ‡ nasz program? Bardzo prosto, wystarczy do definicji zmiennej counter dodaÄ‡ sÅ‚owo kluczowe volatile, ktÃ³re poinformuje wszystkie zainteresowane mechanizmy, Å¼e z tej zmiennej korzysta wiÄ™cej niÅ¼ jeden wÄ…tek, i wszelkie zmiany jej wartoÅ›ci naleÅ¼y natychmiast propagowaÄ‡ do tych wÄ…tkÃ³w:private static volatile int counter = 0;Po takiej zmianie i ponownym uruchomieniu programu ujrzymy wyjÅ›cie, ktÃ³rego siÄ™ oryginalnie spodziewaliÅ›my.Jak natomiast ma siÄ™ to do aplikacji, ktÃ³re rozwijamy na co dzieÅ„? Dobrym przykÅ‚adem mogÄ… byÄ‡ np. zmienne trzymane w sesji uÅ¼ytkownika, czytane i modyfikowane przez potencjalnie wiele wÄ…tkÃ³w - w skrajnym przypadku moÅ¼e dojÅ›Ä‡ do sytuacji, w ktÃ³rej rÃ³Å¼ne wÄ…tki korzystajÄ…ce z takiego sesyjnego obiektu bÄ™dÄ… widziaÅ‚y rozbieÅ¼ne jego wartoÅ›ci, co z kolei moÅ¼e doprowadziÄ‡ do najrÃ³Å¼niejszych anomalii oraz bÅ‚Ä™dÃ³w (szczegÃ³lnie, jeÅ›li jeden z tych wÄ…tkÃ³w wykonuje przetwarzanie obciÄ…Å¼ajÄ…ce procesor - z punktu widzenia procesora bÄ™dzie to kandydat do wykonania optymalizacji polegajÄ…cej na niepropagowaniu do tego wÄ…tku nowej wartoÅ›ci takiej zmiennej).PodsumowujÄ…c, warto pamiÄ™taÄ‡ o volatile rozwijajÄ…c wielowÄ…tkowe aplikacje, w ktÃ³rych rÃ³Å¼ne wÄ…tki korzystajÄ… ze wspÃ³lnych zmiennych.PS. uwaÅ¼ny czytelnik zauwaÅ¼y, Å¼e w goÅ‚ej Javie nie istnieje taki interfejs funkcyjny jak ThreadSupplier - utworzyÅ‚em go na potrzeby czytelnoÅ›ci przykÅ‚adu, aby nie zaciemniaÄ‡ kodu obsÅ‚ugÄ… wyjÄ…tku z Thread.sleep. PeÅ‚ny kod ÅºrÃ³dÅ‚owy tego przykÅ‚adu znajduje siÄ™ poniÅ¼ej â€” polecam lekturÄ™ wszystkim, ktÃ³rzy chcieliby siÄ™ dowiedzieÄ‡ jak poradziÄ‡ sobie z wyjÄ…tkami rzucanymi w lambdach bez uÅ¼ycia zewnÄ™trznych bibliotek.package com.consdata.webdev;import java.util.concurrent.CompletableFuture;import java.util.function.Supplier;import static java.lang.String.format;import static java.util.concurrent.CompletableFuture.supplyAsync;public class VolatileExample {    private static volatile int counter = 0;    public static void main(String[] args) {        ThreadSupplier producer = () -&amp;gt; {            while (true) {                System.out.println(format(&quot;Ustawiam licznik na %s&quot;, ++counter));                Thread.sleep(1000);            }        };        ThreadSupplier consumer = () -&amp;gt; {            int localCounter = counter;            while (true) {                if (localCounter != counter) {                    System.out.println(format(&quot;Licznik zmieniÅ‚ wartoÅ›Ä‡Â na: %s&quot;, localCounter = counter));                }            }        };        CompletableFuture.allOf(supplyAsync(producer), supplyAsync(consumer)).join();    }}/** * Gdyby ktoÅ›Â siÄ™Â zastanawiaÅ‚ dlaczego interfejs funkcyjny z dwoma metodami w ogÃ³le dziaÅ‚a: * W przypadku interfejsÃ³w funkcyjnych pod uwagÄ™Â brane sÄ…Â jedynie nieabstrakcyjne metody interfejsu. * Metoda interfejsu posiadajÄ…ca domyÅ›lnÄ…Â implementacjÄ™Â NIE JEST traktowana jako abstrakcyjna. * * Na podobnej zasadzie dziaÅ‚a np. Consumer * https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/function/Consumer.html */@FunctionalInterfaceinterface ThreadSupplier&amp;lt;T&amp;gt; extends Supplier&amp;lt;T&amp;gt; {    default T get() {        try {            return getThrows();        } catch (InterruptedException e) {            // W tym miejscu naleÅ¼y zrobiÄ‡Â coÅ›Â sensownego z wyjÄ…tkiem - minimum zalogowaÄ‡.            throw new RuntimeException(e);        }    }    T getThrows() throws InterruptedException;}",
"url": "/2021/05/31/slowo-kluczowe-volatile.html",
"author": "Marcin Mergo",
"authorUrl": "/authors/mmergo.html",
"image": "mmergo.webp",
"highlight": "/assets/img/posts/2021-05-31-slowo-kluczowe-volatile/volatile.jpeg",
"date": "31-05-2021",
"path": "pl/2021-05-31-slowo-kluczowe-volatile"
}
,


"2021-04-30-java-darmowa-czy-nie-update-html": {
"title": "Java darmowa, czy nie? - aktualizacja",
"lang": "pl",
"tags": "java",
"content": "Microsoft doÅ‚Ä…cza do dystrybutorÃ³w JDK. To dobry moment Å¼eby sprawdziÄ‡, jak rozwinÄ™Å‚a siÄ™ sytuacja z wydawaniem darmowych dystrybucji od czasu, kiedy Oracle zmieniÅ‚ tryb licencjonowania. PisaliÅ›my o tym dwa lata temu w artykule Java darmowa, czy nie?OpenJDK pozostaje miejscem, w ktÃ³rym toczÄ… siÄ™ prace rozwojowe nad poszczegÃ³lnymi wersjami Java SE. SzczegÃ³Å‚owe plany dla wersji LTS (Long Term Support) moÅ¼na znaleÅºÄ‡ na wiki:  JDK 8  JDK 11KolejnÄ… wersjÄ… LTS bÄ™dzie wersja 17, ktÃ³rej pierwsze wydanie planowane jest na wrzesieÅ„ 2021 roku.Zgodnie z tym, co pisaliÅ›my 2 lata temu, Oracle pozostaÅ‚ przy wydawaniu jedynie referencyjnych wersji z kaÅ¼dej, gÅ‚Ã³wnej wersji OpenJDK: https://jdk.java.net/. OczywiÅ›cie poza wersjami referencyjnymi, Oracle wydaje regularnie komercyjne wersje oparte rÃ³wnieÅ¼ na OpenJDK.AdoptOpenJDK -&amp;gt; Eclipse AdoptiumAdoptOpenJDK zostaÅ‚ gÅ‚Ã³wnym dostawcÄ… darmowej dystrybucji Javy. Zgodnie z raportem zamieszczonym na stronie https://snyk.io/blog/jvm-ecosystem-report-2020/ udziaÅ‚ OracleJDK w rynku na przestrzeni lat 2018 - 2019, czyli w momencie zakoÅ„czenia wydawania darmowej wersji, zmalaÅ‚ o 36%. WiÄ™ksza czÄ™Å›Ä‡ tych 36% uÅ¼ytkownikÃ³w zmigrowaÅ‚a siÄ™ wÅ‚aÅ›nie do wersji wydawanych przez AdoptOpenJDK. Wg raportu z 2020 roku udziaÅ‚ AdoptOpenJDK na rynku uÅ¼ywanych dystrybucji wyniÃ³sÅ‚ 24%.W samym AdoptOpenJDK zachodzÄ… natomiast doÅ›Ä‡ istotne zmiany. SpoÅ‚ecznoÅ›Ä‡ AdoptOpenJDK przechodzi z London Java Community pod skrzydÅ‚a Eclipse Foundation. Informacje dot. motywacji, jak i samego procesu moÅ¼na przeczytaÄ‡ na blogu AdoptOpenJDK. Nazwa AdoptOpenJDK zostanie zastÄ…piona przez Eclipse Adoptium.Microsoft Build of OpenJDK6 kwietnia Microsoft opublikowaÅ‚ informacjÄ™ o doÅ‚Ä…czeniu do dystrybutorÃ³w darmowej wersji JDK. Binaria, na razie w wersji preview, moÅ¼na pobraÄ‡ ze strony https://www.microsoft.com/openjdk. Wersja Microsoftu oparta jest na ÅºrÃ³dÅ‚ach OpenJDK i budowana przy uÅ¼yciu skryptÃ³w Eclipse Adoptium.Co ciekawe, Microsoft deklaruje, Å¼e do koÅ„ca roku dystrybucja oparta na OpenJDK zostanie domyÅ›lnÄ… dystrybucjÄ… uÅ¼ywanÄ… w serwisach dostÄ™pnych za poÅ›rednictwem Azureâ€™a. PozostaÅ‚e dystrybucje uÅ¼ywane przez Microsoft bÄ™dÄ… rÃ³wnieÅ¼ sukcesywnie zastÄ™powane przez wersje pochodzÄ…ce z OpenJDK.Polityka wydawania nowych wersji, podobnie jak w przypadku AdoptOpenJDK, zakÅ‚ada kwartalny cykl wydawniczy. Microsoft planuje wydawaÄ‡ wersjÄ™ JDK 11 do 2024 roku. Do koÅ„ca bieÅ¼Ä…cego roku planujÄ… rÃ³wnieÅ¼ wydaÄ‡ wersjÄ™ JDK 17.Przydatne linki  https://snyk.io/blog/jvm-ecosystem-report-2020/  https://blog.adoptopenjdk.net/2020/06/adoptopenjdk-to-join-the-eclipse-foundation/  https://devblogs.microsoft.com/java/announcing-preview-of-microsoft-build-of-openjdk/  https://www.microsoft.com/openjdk  Java darmowa, czy nie?",
"url": "/2021/04/30/java-darmowa-czy-nie-update.html",
"author": "Jakub Wilczewski",
"authorUrl": "/authors/jwilczewski.html",
"image": "jwilczewski.jpg",
"highlight": "/assets/img/posts/2021-04-25-java-darmowa-czy-nie-update/java-darmowa.png",
"date": "30-04-2021",
"path": "pl/2021-04-26-java-darmowa-czy-nie-update"
}
,


"2021-04-16-webpack-externals-vs-bundled-html": {
"title": "Micro frontends: czy wspÃ³Å‚dzieliÄ‡ zaleÅ¼noÅ›ci?",
"lang": "pl",
"tags": "frontend angular webpack micro-frontends",
"content": "tl;dr To wspÃ³Å‚dzieliÄ‡ zaleÅ¼noÅ›ci czy nie? Nie zawsze! JeÅ¼eli nie natrafiÅ‚eÅ› na problemy z rozmiarem bundli, to nie rozwiÄ…zuj teoretycznych problemÃ³w. Zanim zabierzesz siÄ™ za optymalizacjÄ™ - oceÅ„, co jest problemem, okreÅ›l, co chcesz osiÄ…gnÄ…Ä‡ i zastanÃ³w siÄ™, jakimi krokami moÅ¼esz tam dotrzeÄ‡. BieÅ¼Ä…ce narzÄ™dzia stosujÄ… zaawansowane mechanizmy optymalizacji, ktÃ³re mogÄ… zachwiaÄ‡ Twoje intuicyjne rozumienie problemu ;-)Zarysujmy prosty przykÅ‚ad biznesowo sensownej aplikacji, ktÃ³ra posÅ‚uÅ¼y nam do zobrazowania omawianego problemu. ZaÅ‚Ã³Å¼my, Å¼e budujemy system wewnÄ™trznej komunikacji z klientami. KaÅ¼dy klient ma dostÄ™p do panelu poczty, z ktÃ³rego moÅ¼e przeglÄ…daÄ‡ listÄ™ dotychczasowych wÄ…tkÃ³w, prowadziÄ‡ konwersacjÄ™ oraz przeglÄ…daÄ‡ szczegÃ³Å‚y dowolnego wÄ…tku i wysÅ‚aÄ‡ nowÄ… wiadomoÅ›Ä‡, Å¼eby rozpoczÄ…Ä‡ nowy wÄ…tek.PoniÅ¼szy diagram przedstawia przykÅ‚adowy system zbudowany w podejÅ›ciu micro frontends. System skÅ‚ada siÄ™ z czterech niezaleÅ¼nie rozwijanych i osadzanych webcomponentÃ³w:  mailbox-webcomponent - Aplikacja hosta odpowiedzialna za uwierzytelnianie uÅ¼ytkownika, layout oraz routing komponentÃ³w funkcjonalnych.  thread-webcomponent - Aplikacja prezentujÄ…ca szczegÃ³Å‚y konkretnego wÄ…tku.  threads-webcomponent - Aplikacja prezentujÄ…ca listÄ™ dostÄ™pnych wÄ…tkÃ³w.  new-message-webcomponent - Aplikacja pozwalajÄ…ca wysÅ‚aÄ‡ nowÄ… wiadomoÅ›Ä‡.PoszczegÃ³lne aplikacje sÄ… wczytywane lazy, gdy sÄ… potrzebne, a konkretna nawigacja i konfiguracja jest realizowana na poziomie aplikacji hosta. Wszystkie aplikacje sÄ… zbudowane z wykorzystaniem Angular + Angular Elements oraz korzystajÄ… z NgRx i rx.js.Angular jest ciÄ™Å¼ki, a Ty masz 4 kopie?! Szalony!Naturalnym pierwszych odruchem jest zwÄ…tpienie (Å¼eby nie powiedzieÄ‡ panika) w sensownoÅ›Ä‡ takiego podejÅ›cia. PrzecieÅ¼ to jest wÅ‚aÅ›ciwie homogeniczny system i niepotrzebnie dostarczamy te same zaleÅ¼noÅ›ci czterokrotnie!SprawdÅºmy, ile waÅ¼Ä… zaleÅ¼noÅ›ci i oceÅ„my potencjalny zysk?            Aplikacja      bundled      vendor.js      angular+rx                  mailbox-webcomponent      505K      434K      294K              new-message-webcomponent      285K      248K      212K              thread-webcomponent      280K      248K      212K              threads-webcomponent      558K      378K      235K      PodsumowujÄ…c rozmiar zaleÅ¼noÅ›ci Angular+Rx.js w chunku vendor moÅ¼emy zaryzykowaÄ‡, Å¼e do zaoszczÄ™dzenia jest nawet 659K!OczywiÅ›cie, powinna do tego dojÅ›Ä‡ jeszcze kompresja serwer-przeglÄ…darka, ale rozmiar wynikowy bÄ™dzie malaÅ‚ proporcjonalnie do wartoÅ›ci w tabeli.Inne pytanie, czemu angular czasem zajmuje wiÄ™cej, a czasem mniej? WrÃ³cimy do tego w dalszej czÄ™Å›ci wpisu.Czy moÅ¼emy coÅ› z tym zrobiÄ‡? OczywiÅ›cie! Z pomocÄ… przychodzi webpack i konfiguracja externals (https://webpack.js.org/configuration/externals/#externals). Bez wiÄ™kszych trudnoÅ›ci moÅ¼emy okreÅ›liÄ‡ nie tylko, ktÃ³re moduÅ‚y trafiajÄ… do ktÃ³rego bundle (main, polyfills czy vendor), ale wprost wskazaÄ‡, Å¼e czÄ™Å›Ä‡ zaleÅ¼noÅ›ci w ogÃ³le ma nie trafiÄ‡ do wynikowych skryptÃ³w i obiecaÄ‡ webpackowi: â€œjakoÅ› to bÄ™dzie, nie martw siÄ™, przyjdÄ… z zewnÄ…trzâ€.Konfiguracja wspÃ³Å‚dzielenia zaleÅ¼noÅ›ci pomiÄ™dzy aplikacjamiCo wÅ‚aÅ›ciwie robimy?  W osadzanych aplikacjach oznaczamy zaleÅ¼noÅ›ci jako zewnÄ™trzne  W aplikacji hosta eksponujemy jego zaleÅ¼noÅ›ci jako globalneW komponentach threads, thread i new-message oznaczamy zaleÅ¼noÅ›ci jako zewnÄ™trzne:{    // ....,    externals: {        &#39;rxjs&#39;: &#39;rxjs&#39;,        &#39;rxjs/operators&#39;: &#39;rxjs.operators&#39;,        &#39;@angular/core&#39;: &#39;ng.core&#39;,        &#39;@angular/common&#39;: &#39;ng.common&#39;,        &#39;@angular/common/http&#39;: &#39;ng.common.http&#39;,        &#39;@angular/compiler&#39;: &#39;ng.compiler&#39;,        &#39;@angular/platform-browser&#39;: &#39;ng.platformBrowser&#39;,        &#39;@angular/platform-browser-dynamic&#39;: &#39;ng.platformBrowserDynamic&#39;,        &#39;@angular/router&#39;: &#39;ng.router&#39;,        &#39;@angular/forms&#39;: &#39;ng.forms&#39;,        &#39;@angular/elements&#39;: &#39;ng.elements&#39;    }}W aplikacji hosta dodajemy wymagane skrypty do skryptÃ³w globalnie doÅ‚Ä…czanych do aplikacji.KorzyÅ›ci ze wspÃ³Å‚dzielenia zaleÅ¼noÅ›ciZobaczmy zatem, ile faktycznie ugraliÅ›my wyrzucajÄ…c Angular i rx.js poza aplikacje.            Aplikacja      main.js (bundled)      main.js (externals)      diff      scripts                  mailbox-webcomponent      505K      227K      278K      1.2M              new-message-webcomponent      285K      101K      184K      -              thread-webcomponent      280K      95K      185K      -              threads-webcomponent      558K      357K      201K      -      Okazuje siÄ™, Å¼e finalnie straciliÅ›my na caÅ‚ej operacji! Na poszczegÃ³lnych aplikacjach zaoszczÄ™dziliÅ›my 848K, ale w hoÅ›cie doÅ‚oÅ¼yliÅ›my 1.2M skryptÃ³w z zaleÅ¼noÅ›ciami. MieliÅ›my oszczÄ™dziÄ‡ 659K, a doÅ‚oÅ¼yliÅ›my ~350K. W dodatku, w najgorszym moÅ¼liwym miejscu, bo podczas Å‚adowania pierwszego, poczÄ…tkowego bundla (wczeÅ›niej byÅ‚o to rozÅ‚oÅ¼one na bundle Å‚adowane lazy w razie potrzeby).Co siÄ™ wÅ‚aÅ›ciwie staÅ‚o?Bundler, Tree Shaking, minification, AoT i inniNa poczÄ…tek zastanÃ³wmy siÄ™, z czego wynikajÄ… rÃ³Å¼nice w wielkoÅ›ci doÅ‚Ä…czanych bibliotek pomiÄ™dzy aplikacjami? W tym celu porÃ³wnajmy, co trafia do wynikowego kodu przed i po zastosowaniu optymalizacji na zaleÅ¼noÅ›ciach i bundle.PoniÅ¼sze obrazy przedstawiajÄ… wizualizacjÄ™ analizy wynikowego bundle webpacka:  vendor.js - reprezentuje aplikacjÄ™ bez optymalizacji,  vendor.43b31â€¦js - reprezentuje aplikacjÄ™ z wÅ‚Ä…czonymi optymalizacjami,  na rÃ³Å¼owo oznaczone sÄ… rozmiary zaleÅ¼noÅ›ci widziane przez webpack, gdzie stat size to rozmiar poczÄ…tkowy, a gzipped size to rozmiar w wynikowym bundle.Dla uproszczenia, rozmiary czÄ™Å›ci zaleÅ¼noÅ›ci umieÅ›cimy w tabeli:            ZaleÅ¼noÅ›Ä‡      stat (unoptimized)      gzip (unoptimized)      stat (optimized)      gzip (optimized)      gzip (diff)                  @angular/core/core.js      1.26M      280K      1.26M      36K      244K              @angular/common      215K      48K      159K      6K      42K              @angular/forms      262K      46K      222K      7K      39K              @angular/common/http      87K      20K      82K      5K      15K              @angular/platform-browser      85K      20K      75K      4K      16K              @angular/elements      24K      6K      24K      2K      4K              date-fns      516K      100K      187K      10K      90K              rxjs      245K      44K      92K      9K      35K      PorÃ³wnujÄ…c wartoÅ›ci unoptimized i optimized Å‚atwo wychwycimy rÃ³Å¼nicÄ™ w rozmiarach zaleÅ¼noÅ›ci w wynikowej aplikacji. JuÅ¼ te kilka przykÅ‚adÃ³w pokazuje rÃ³Å¼nicÄ™ ~500K w skompresowanym kodzie!Bundler (np. webpack) w trakcie budowania aplikacji ma okazjÄ™ skorzystaÄ‡ z wielu technik optymalizacji, takich jak Tree Shaking, importy, AoT compilation, minification, itp., ktÃ³re pozwalajÄ… mu:  zbieraÄ‡ tylko faktycznie uÅ¼ywane elementy zaleÅ¼noÅ›ci,  minifikowaÄ‡ nazwy od strony zaleÅ¼noÅ›ci i jej klienta,  optymalizowaÄ‡ wykonania kodu,  itp.MoÅ¼liwe optymalizacje dobrze widaÄ‡ na przykÅ‚adzie biblioteki rxjs gdzie wiÄ™kszoÅ›Ä‡ jej operatorÃ³w zostaÅ‚a pominiÄ™ta, a sam rozmiar biblioteki zostaÅ‚ zredukowany o ~80%!Sam proces optymalizacji kodu i jego zaleÅ¼noÅ›ci to zupeÅ‚nie osobny, rozbudowany temat, ktÃ³remu nie moÅ¼emy przyjrzeÄ‡ siÄ™ po prostu â€œprzy okazjiâ€. Jednak na nasze potrzeby sama Å›wiadomoÅ›Ä‡ procesu optymalizacji i jej wpÅ‚ywu na wynikowy rozmiar jest wystarczajÄ…ca.Rozmiar zaleÅ¼noÅ›ci w bundle, a rozmiar z npmBudujÄ…c konkretnÄ… aplikacjÄ™ z konkretnymi zaleÅ¼noÅ›ciami proces budowania moÅ¼e wykonaÄ‡ ciÄ™Å¼kÄ… pracÄ™ i wyznaczyÄ‡ minimalny dziaÅ‚ajÄ…cy zakres kodu. Dodatkowo, taki kod moÅ¼e zostaÄ‡ dalej optymalizowany, bo mamy moÅ¼liwoÅ›Ä‡ modyfikowania zarÃ³wno samej zaleÅ¼noÅ›ci, jak i kodu, ktÃ³ry z niej korzysta. MoÅ¼emy nawet przyjÄ…Ä‡, z czÄ™Å›ciowym zaufaniem, Å¼e wynikowa aplikacja nie zawiera ani kawaÅ‚ka kodu, ktÃ³ry nie jest przez niÄ… faktycznie wykorzystywany w runtime.ZupeÅ‚nie inaczej sytuacja wyglÄ…da, gdy zaleÅ¼noÅ›ci dostarczamy w runtime. Na etapie buildu nie moÅ¼emy ani wnioskowaÄ‡, ktÃ³re fragmenty kodu bÄ™dÄ… potrzebne, ani wprowadzaÄ‡ optymalizacji w ÅºrÃ³dle. Nie znajÄ…c potrzeb aplikacji klienckich, ani nie mogÄ…c wpÅ‚ywaÄ‡ na sposÃ³b wykorzystania dostarczanych zaleÅ¼noÅ›ci, musimy je dostarczyÄ‡ as-is w caÅ‚oÅ›ci.W naszym przykÅ‚adzie, rÃ³Å¼nica miÄ™dzy aplikacjÄ… przed i po wprowadzeniu externals wynika wprost z tego, Å¼e ta druga musi dostarczyÄ‡ masÄ™ kodu, ktÃ³rego nikt nie potrzebuje. W efekcie, realizacja wprost zaprzeczyÅ‚a zaÅ‚oÅ¼eniom eksperymentu :)To kiedy wspÃ³Å‚dzieliÄ‡ zaleÅ¼noÅ›ci?Zawsze, gdy jest ku temu przesÅ‚anka! ;) Jest kilka dodatkowych czynnikÃ³w sugerujÄ…cych wprowadzenie wspÃ³Å‚dzielenia zaleÅ¼noÅ›ci:  nie masz kontroli nad aplikacjami klienckimi,  wykorzystywane zaleÅ¼noÅ›ci nie poddajÄ… siÄ™ Å‚atwo optymalizacji,  zaleÅ¼noÅ›ci nie poddajÄ… siÄ™ Å‚atwo tree shaking,  gdy liczba aplikacji sprawia, Å¼e oszczÄ™dnoÅ›Ä‡ bÄ™dzie wiÄ™ksza niÅ¼ narzut,  gdy stosowana zaleÅ¼noÅ›Ä‡ nie lubi byÄ‡ w wielu instancjach w DOM (np. rÃ³Å¼nego rodzaju globalne zaleÅ¼noÅ›ci).To, co chcieliÅ›my pokazaÄ‡, to Å¼e wspÃ³Å‚dzielenie nie jest oczywistÄ… rzeczÄ…, ktÃ³rÄ… â€œnaleÅ¼y zawsze robiÄ‡â€. Za kaÅ¼dym razem naleÅ¼y przeanalizowaÄ‡ obecne problemy i metody ich rozwiÄ…zania. Nie warto wprowadzaÄ‡ rozwiÄ…zaÅ„ problemÃ³w, ktÃ³rych siÄ™ nie ma ;)",
"url": "/2021/04/16/webpack-externals-vs-bundled.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2021-04-16-webpack-externals-vs-bundled/scale.jpeg",
"date": "16-04-2021",
"path": "pl/2021-04-16-webpack-externals-vs-bundled"
}
,


"2021-04-14-wspoldzielona-biblioteka-w-jenkins-pipeline-html": {
"title": "WspÃ³Å‚dzielona biblioteka w Jenkins pipeline",
"lang": "pl",
"tags": "jenkins devops pipeline shared library",
"content": "W tym artykule zapoznamy siÄ™ z mechanizmem bibliotek wspÃ³Å‚dzielonych (Pipeline: Shared Groovy Libraries), ktÃ³re stanowiÄ…zaleÅ¼noÅ›Ä‡ do szeroko stosowanej wtyczki jenkinsowej pipelines (https://www.jenkins.io/doc/book/pipeline/).KaÅ¼dy z nas podczas modelowania procesÃ³w CI/CD spotkaÅ‚ siÄ™ z pewnymi podobieÅ„stwami pomiÄ™dzy projektami. NiewÄ…tpliwiejednym z takich procesÃ³w moÅ¼e byÄ‡ release projektu. W naszej firmie prawie kaÅ¼dy projekt budowany jest przy uÅ¼yciumavena. Tym samym release takich projektÃ³w jest procesem bardzo zunifikowanym. W zwiÄ…zku z tym jest to idealnykandydat, by zamknÄ…Ä‡ go w bibliotece, ustawiÄ‡ na pÃ³Å‚kÄ™ i uÅ¼ywaÄ‡, gdy zajdzie taka potrzeba.ZakÅ‚adajÄ…c, Å¼e kaÅ¼dy projekt w procesie wydawniczym (pipeline) ma krok pod tytuÅ‚em â€œreleaseâ€, wÃ³wczas wystarczy, Å¼e zbudujemy wspÃ³Å‚dzielonÄ… bibliotekÄ™, ktÃ³rÄ… uÅ¼yjemy w kroku bez zagÅ‚Ä™biania siÄ™ w sposÃ³b dziaÅ‚ania.Biblioteka ma zapewniÄ‡ nam:  podbicie wersje w POMie do stabilnej,  upload artefaktÃ³w (binarki) do repozytorium,  ustalenie nowej wersji developerskiej + commit do gÅ‚Ã³wnej gaÅ‚Ä™zi.Tworzenie biblioteki w Jenkins pipelineW nowo utworzonym repozytorium kodu tworzymy strukturÄ™ katalogÃ³w. W naszym przykÅ‚adzie git@git.consdata/consdata-shared-lib(projekt)+- src|  +- com.consdata.shared.library|   +- VersionBumper.groovy  # klasa(pomocnicza) generuje wersje artefactu+- vars|  +- release.groovy # Definicja zmiennej â€˜releaseâ€™ dostÄ™pna z pipelinuW ten sposÃ³b stworzyliÅ›my zmiennÄ… globalnÄ… o nazwie release. Aby moÅ¼na byÅ‚o jÄ… wywoÅ‚aÄ‡ bezpoÅ›rednio po nazwie wewnÄ…trz Jenkins pipeline, definiujemy funkcjÄ™ call.//vars/release.groovyimport com.consdata.shared.library.VersionBumperdef call(String branchName, String gitCredentialId, String versionToBump) {    def currentVersion = readMavenPom().getVersion()    def bumper = new VersionBumper(currentVersion)    releaseVersion = currentVersion.minus(&quot;-SNAPSHOT&quot;);    snapshotVersion = bumper.bump(versionToBump)    sh &quot;mvn clean versions:set -DnewVersion=\\&quot;$releaseVersion\\&quot; -DgenerateBackupPoms=false&quot;    sshagent(credentials: [gitCredentialId]) {        sh(&quot;git commit -a -m &#39;Release $releaseVersion&#39;&quot;)    }    releaseShaCommit = sh(script: &quot;git rev-parse HEAD&quot;, returnStdout: true).trim()    echo &quot;SHA Commit $releaseShaCommit&quot;    sh &quot;mvn clean versions:set -DnewVersion=\\&quot;$snapshotVersion\\&quot;-SNAPSHOT -DgenerateBackupPoms=false&quot;    sshagent(credentials: [gitCredentialId]) {        sh(&quot;git commit -a -m &#39;Snapshot $snapshotVersion&#39;-SNAPSHOT&quot;)        sh(&quot;git push origin HEAD:$branchName&quot;)        sh(&quot;git checkout $releaseShaCommit&quot;)    }    sh &quot;mvn clean deploy&quot;    sshagent(credentials: [gitCredentialId]) {        sh(&quot;git tag $releaseVersion&quot;)        sh(&quot;git push --tags&quot;)    }}W kodzie powyÅ¼ej wykorzystaliÅ›my klasÄ™ VersionBumper, ktÃ³ra dostarcza nam funkcjonalnoÅ›Ä‡ wyliczania nowej wersji. Napotrzeby tego artykuÅ‚u, implementacja zostaÅ‚a pominiÄ™ta.Definiowanie bibliotekiTak przygotowanÄ… bibliotekÄ™ musimy dodaÄ‡ do Jenkinsa. PoniewaÅ¼ biblioteka bÄ™dzie stosowana globalnie na poziomie kaÅ¼degoprojektu. Tym samym zdefiniujemy jÄ… na najwyÅ¼szym poziomie.ZarzÄ…dzaj Jenkinsem â†’ Skonfiguruj system â†’ Global Pipeline Libraries (Uwaga: NaleÅ¼y zweryfikowaÄ‡, czy pluginJenkins pipeline: Shared Groovy Libraries - https://plugins.jenkins.io/workflow-cps-global-lib jest aktywny.)UÅ¼ycie w pipelinePrzechodzimy do ostatniego etapu wykorzystania biblioteki wewnÄ…trz pliku Jenkinsfile.@Library([&#39;consdata-shared-lib&#39;]) _ //Adnotacja okreÅ›lajÄ…ca nazwÄ™ bibliotekipipeline {    agent any    stages {        stage(&#39;Release&#39;) {            steps {                release(&quot;master&quot;, env.GIT_CREDENTIAL_ID, &quot;MINOR&quot;)                //nazwa &#39;release&#39; wynika z konwencji,                //jest to nazwa pliku w repozytorium biblioteki /vars/release.groovy            }        }    }}PodsumowanieW artykule zastosowaliÅ›my tylko niewielki wycinek mechanizmu wspÃ³Å‚dzielonych bibliotek i wykorzystaliÅ›my go w Jenkins pipeline. Szerszy kontekst dostÄ™pny jestbezpoÅ›rednio w dokumentacji.",
"url": "/2021/04/14/wspoldzielona-biblioteka-w-jenkins-pipeline.html",
"author": "Dawid Kubiak",
"authorUrl": "/authors/dkubiak.html",
"image": "dkubiak.webp",
"highlight": "/assets/img/posts/2021-04-14-wspoldzielona-biblioteka-w-jenkins-pipeline/jenkins-shard-pipeline.jpeg",
"date": "14-04-2021",
"path": "pl/2021-04-14-wspoldzielona-biblioteka-w-jenkins-pipeline"
}
,


"2021-03-31-rest-api-dobre-praktyki-html": {
"title": "Standard HTTP i REST - dobre i zÅ‚e praktyki",
"lang": "pl",
"tags": "http rest rest api",
"content": "HTTP i REST - czy zawsze dobrze je stosujemy?Jakie sÄ… czÄ™ste bÅ‚Ä™dy przy doborze metod HTTP?  Kiedy trzymaÄ‡ siÄ™ standardu, a kiedy moÅ¼e to byÄ‡ problemem? O czym pamiÄ™taÄ‡ projektujÄ…c swoje REST API? ChoÄ‡ ani standard HTTP, ani REST nie sÄ… nowoÅ›ciÄ… w Å›wiecie IT, to pewne twierdzenia ich dotyczÄ…ce sÄ… bÅ‚Ä™dnie powielane przez wiele osÃ³b. Czasem znÃ³w okazuje siÄ™, Å¼e deweloperzy pracujÄ…cy dla rÃ³Å¼nych firm podchodzÄ… do tego samego problemu w inny sposÃ³b. Zapraszam na podrÃ³Å¼ w znane, ale wciÄ…Å¼ jeszcze nie zawsze przestrzegane, standardy HTTP i REST.Kiedy POST, a kiedy PUT?POST do tworzenia, a PUT do modyfikacji? NiekoniecznieCzÄ™sto moÅ¼na spotkaÄ‡ siÄ™ z prostym (lecz bÅ‚Ä™dnym) wyjaÅ›nieniem, kiedy uÅ¼ywaÄ‡ metody POST, a kiedy PUT. Twierdzi siÄ™, Å¼e kiedy tworzymy nowy zasÃ³b â€” POST, kiedy modyfikujemy istniejÄ…cy â€” PUT. Jest to jednak znaczne uproszczenie i pierwszy mit, z ktÃ³rym chcÄ™ siÄ™ rozprawiÄ‡.Zacznijmy od tego, Å¼e PUT rÃ³wnieÅ¼ moÅ¼e tworzyÄ‡ zasÃ³b, wiÄ™c nie jest to wcale rÃ³Å¼nica miÄ™dzy PUT i POST wynikajÄ…ca ze standardu HTTP. Co wiÄ™cej, POST ma o wiele szersze zastosowanie niÅ¼ dziaÅ‚anie na zasobach. MoÅ¼e np. byÄ‡ uÅ¼yty do przekazania danych z formularza lub innych danych, wiadomoÅ›ci, ktÃ³re zostanÄ… przetworzone przez serwer praktycznie w dowolny sposÃ³b. Niekoniecznie celem jest utworzenie (lub teÅ¼ modyfikacja) czegokolwiek, efektem moÅ¼e byÄ‡ np. wysÅ‚anie wiadomoÅ›ci, rozpoczÄ™cie procesu. W wyniku Å¼Ä…dania moÅ¼e, lecz nie musi, powstaÄ‡ zasÃ³b identyfikowany przez URI. JeÅ›li powstanie, naleÅ¼y zwrÃ³ciÄ‡ kod odpowiedzi 201 (Created). JeÅ›li nie powstanie taki zasÃ³b, naleÅ¼y zwrÃ³ciÄ‡ kod 200 (OK) lub 204 (No Content). Natomiast metoda PUT odnosi siÄ™ do konkretnego zasobu, ktÃ³ry w jej wyniku moÅ¼e zostaÄ‡ zastÄ…piony reprezentacjÄ… zawartÄ… w przekazanych danych (wÃ³wczas zwracamy 200 (OK) lub 204 (No Content)). JeÅ›li taki zasÃ³b nie istnieje, w zaleÅ¼noÅ›ci od naszej decyzji moÅ¼emy go utworzyÄ‡, zwracajÄ…c 201 (Created) lub odpowiedzieÄ‡ kodem bÅ‚Ä™du, jeÅ›li nie chcemy wspieraÄ‡ takiej obsÅ‚ugi. GET wykonany tuÅ¼ po przetworzeniu metody PUT zwrÃ³ci nam dokÅ‚adnie tÄ™ samÄ… reprezentacjÄ™, ktÃ³ra byÅ‚a przekazana w metodzie PUT. Warto jednak podkreÅ›liÄ‡, Å¼e PUT moÅ¼e mieÄ‡ wpÅ‚yw na inne powiÄ…zane zasoby.Na razie wiÄ™c widzimy, Å¼e choÄ‡ POST i PUT majÄ… ze sobÄ… duÅ¼o wspÃ³lnego, POST moÅ¼e mieÄ‡ szersze zastosowanie i moÅ¼e w dowolny sposÃ³b przetwarzaÄ‡ przekazane dane. Natomiast PUT odnosi siÄ™ do konkretnego zasobu okreÅ›lonego przez jego identyfikator i powinien byÄ‡ obsÅ‚uÅ¼ony przez zastÄ…pienie obecnej reprezentacji zasobu reprezentacjÄ… przekazanÄ… w Å¼Ä…daniu. Nie tÅ‚umaczy to jednak gÅ‚Ã³wnej rÃ³Å¼nicy miÄ™dzy POST a PUT, ktÃ³rÄ… moÅ¼emy zawrzeÄ‡ w haÅ›le â€idempotentnoÅ›Ä‡â€.IdempotentnoÅ›Ä‡Termin ten, wywodzÄ…cy siÄ™ z matematyki, oznacza tutaj, Å¼e operacja idempotentna wykonana wielokrotnie nie doprowadzi do bÅ‚Ä™du, a jej wynik bÄ™dzie za kaÅ¼dym razem taki sam. PUT jest idempotentny, natomiast POST nie. Przy okazji warto zauwaÅ¼yÄ‡, Å¼e dwie inne popularne metody HTTP â€” GET i DELETE â€” sÄ… rÃ³wnieÅ¼ idempotentne.Parokrotne wywoÅ‚anie metody PUT speÅ‚nia te zasady (o ile nasza implementacja jest zgodna ze standardem).PUT /messages/1234{  &quot;title&quot;: &quot;Hello!&quot;,  &quot;text&quot;: &quot;Do you know that PUT is indempotent?&quot;}POST bez ciaÅ‚a (body)?BiorÄ…c pod uwagÄ™ to, Å¼e metoda POST ma bardzo szerokie zastosowanie i nie jest idempotentna, w skrajnym przypadku moÅ¼emy nie chcieÄ‡ przekazywaÄ‡ Å¼adnych danych. Nasze Å¼Ä…danie moÅ¼e byÄ‡ np. jedynie wyzwalaczem (trigger) jakiegoÅ› procesu i nie potrzebujemy przekazywaÄ‡ nic wiÄ™cej. W innym przypadku moÅ¼emy przekazaÄ‡ potrzebne informacje w nagÅ‚Ã³wkach HTTP, a poniewaÅ¼ reprezentacja to poÅ‚Ä…czenie nagÅ‚Ã³wkÃ³w z danymi, to reprezentacja interpretowana przez serwer nie bÄ™dzie wcale pusta. Nie bÄ™dzie to sprzeczne ze standardem HTTP. NaleÅ¼y jedynie pamiÄ™taÄ‡ o poprawnej interpretacji w zaleÅ¼noÅ›ci od technologii, z ktÃ³rej korzystamy, zarÃ³wno po stronie serwera, jak i klienta. JeÅ›li np. standardowo posÅ‚ugujemy siÄ™ formatem application/json i tu teÅ¼ posÅ‚uÅ¼ymy siÄ™ takimi nagÅ‚Ã³wkami, puste Å¼Ä…danie moÅ¼e byÄ‡ uznane za niepoprawne w przeciwieÅ„stwie do przekazania {}. Problem moÅ¼e wystÄ…piÄ‡ rÃ³wnieÅ¼ na innym poziomie infrastruktury, przykÅ‚adowo tak spreparowane Å¼Ä…danie moÅ¼e zostaÄ‡ zablokowane na WAF-ie (Web application firewall), jeÅ›li zostaÅ‚a ustalona reguÅ‚a, ktÃ³rÄ… bÄ™dzie ono Å‚amaÄ‡.GET z duÅ¼Ä… liczbÄ… parametrÃ³wOpis problemuStandard nie okreÅ›la ograniczenia na rozmiar URI, jednakÅ¼e poszczegÃ³lne implementacje juÅ¼ je majÄ… (zazwyczaj mieszczÄ…cy siÄ™ miÄ™dzy 2 KB, a 8 KB). Co waÅ¼ne, w zaleÅ¼noÅ›ci od stosowanych technologii musimy mieÄ‡ nad nimi kontrolÄ™ od strony serwerowej. Z kolei same przeglÄ…darki majÄ… rÃ³Å¼ne ograniczenia. Bezpiecznie jest wiÄ™c trzymaÄ‡ siÄ™ dolnej granicy leÅ¼Ä…cej poniÅ¼ej 2048 znakÃ³w (moÅ¼emy teÅ¼ spotkaÄ‡ siÄ™ z zaleceniami, by utrzymywaÄ‡ rozmiar URI poniÅ¼ej 2000 znakÃ³w). Czy w ogÃ³le tak dÅ‚ugie URLe sÄ… potrzebne, czytelne i wskazane? OdpowiadajÄ…c na pierwszÄ… wÄ…tpliwoÅ›Ä‡, mogÄ… byÄ‡ dosyÄ‡ czÄ™ste przy wyszukiwaniach po wielu kryteriach, dodatkowo z paginacjÄ… i sortowaniem. NiewÄ…tpliwie czytelnoÅ›Ä‡ parametrÃ³w w URI jest duÅ¼o mniejsza niÅ¼ przy przekazaniu parametrÃ³w w ciele Å¼Ä…dania w formacie json czy XML. Wyszukiwanie nie zmienia stanu zasobÃ³w, czyli powinniÅ›my skorzystaÄ‡ i zazwyczaj korzystamy z GETa do pobierania danych. Metoda ta jest idempotentna, moÅ¼emy korzystaÄ‡ z gotowych mechanizmÃ³w zapewniajÄ…cych nam cacheâ€™owanie lub powtÃ³rne wywoÅ‚anie GETa w przypadku bÅ‚Ä™du sieciowego. I jak najbardziej wydaje siÄ™ odpowiednia, skoro chcemy pobraÄ‡ dane.PrzykÅ‚adowy GET:GET /locations/?country=France,Italy,Greece,......,Brazil&amp;amp;minimum_population=250000&amp;amp;type=city,village&amp;amp;max_height=1300&amp;amp;min_area=100000&amp;amp;.......Czasami parametrÃ³w nie chcemy przekazywaÄ‡ w ten sposÃ³b jeszcze z innego powodu. Serwery czÄ™sto logujÄ… caÅ‚Ä… treÅ›Ä‡ zapytania, co moÅ¼e od razu wykluczaÄ‡ pewne zastosowania, np. przesyÅ‚anie wraÅ¼liwych danych. Dodatkowo taki url bÄ™dzie dostÄ™pny w historii, moÅ¼e zostaÄ‡ udostÄ™pniony przez nieÅ›wiadomego uÅ¼ytkownika komuÅ› innemu, bÄ™dzie widoczny przez dostawcÄ™ usÅ‚ug internetowych. Taka podatnoÅ›Ä‡ pozwoli atakujÄ…cym uzyskaÄ‡ dostÄ™p do wraÅ¼liwych danych.Sednem problemu jest jednak to, Å¼e standard zakÅ‚ada, Å¼e parametry bÄ™dÄ… przekazane w URL-u, a nie w ciele metody. Co wiÄ™c w przypadku, gdy naszych parametrÃ³w jest za duÅ¼o, Å¼eby trzymaÄ‡ siÄ™ tego standardu lub gdy sÄ… to dane wraÅ¼liwe?RozwiÄ…zaÅ„ jest kilka i kaÅ¼de ma swoje wady i zalety.GET i parametry przekazywanie nie w URI, a w ciele Å¼Ä…daniaPierwszy pomysÅ‚ rozwiÄ…zania tego problemu to przekazanie parametrÃ³w w ciele metody GET. KaÅ¼da metoda HTTP moÅ¼e mieÄ‡ ciaÅ‚o, ale w przypadku GETa pojawia siÄ™ kilka wÄ…tpliwoÅ›ci.  Nie jest to zgodne z zaÅ‚oÅ¼eniami i praktykÄ…. Co prawda standard pozwala na to, Å¼eby dowolna metoda HTTP miaÅ‚a ciaÅ‚o, ale przez wiele lat i w wielu implementacjach zaÅ‚oÅ¼ono, Å¼e ciaÅ‚o metody GET bÄ™dzie ignorowane przez serwer. Znajdziemy siÄ™ wiÄ™c w dosyÄ‡ nietypowej sytuacji, w ktÃ³rej, chociaÅ¼ nie jesteÅ›my niezgodni ze standardem, to jednak Ã³w standard pomija kwestiÄ™, jak powinno byÄ‡ traktowane ciaÅ‚o metody GET. W zwiÄ…zku z tym rÃ³wnieÅ¼ konkretne implementacje nie bÄ™dÄ… wspieraÄ‡ tego rozwiÄ…zania.  Wiele implementacji po stronie frontu i serwera nie wspiera GET-a z ciaÅ‚em. CzÄ™Å›Ä‡ bibliotek HTTP (np. JavaScript) nie wspiera wysyÅ‚ania Å¼Ä…daÅ„ GET z ciaÅ‚em. RÃ³Å¼ne serwery i proxy mogÄ… ignorowaÄ‡ dane przekazane w ten sposÃ³b.  Tracimy Å‚atwe wsparcie dla cacheâ€™owania, poniewaÅ¼ dziaÅ‚a ono na podstawie URL-a, a nie ciaÅ‚a metody.  RozwiÄ…zanie moÅ¼e stworzyÄ‡ problemy zwiÄ…zane z konfiguracjÄ… blokujÄ…cÄ… takie Å¼Ä…dania na WAF-ie (Web application firewall), jeÅ›li osoby odpowiedzialne za konfiguracjÄ™ WAF-a uznaÅ‚y, Å¼e Å¼Ä…dania GET nie powinny mieÄ‡ ciaÅ‚a.GET /locations{  &quot;country&quot;: &quot;France,Italy,Greece,......,Brazil&quot;,  &quot;minimum_population&quot;: 250000,  &quot;type&quot;: &quot;city, village&quot;,  &quot;max_height&quot;: 1300,  &quot;min_area&quot;: 100000,  ....}{  &quot;locations&quot;: [    {&quot;id&quot;: &quot;2443&quot;, &quot;name&quot;: &quot;Rome&quot;},    {&quot;id&quot;: &quot;6789&quot;, &quot;name&quot;: &quot;Paris&quot;},    ...  ]}Czy takie rozwiÄ…zania sÄ… spotykane w praktyce? Warto wiedzieÄ‡, Å¼e twÃ³rcy Elasticsearch sÄ… zwolennikami stosowania GETa w ten sposÃ³b, argumentujÄ…c to tutaj. W swoim Search API umoÅ¼liwiajÄ… zarÃ³wno skorzystanie z metody GET, jak i z metody POST, ktÃ³rÄ… omÃ³wimy za chwilÄ™.POSTDrugi pomysÅ‚, bÄ™dÄ…cy obejÅ›ciem na problemy poprzedniego rozwiÄ…zania, to skorzystanie z innej metody HTTP â€” POST. Jest to dosyÄ‡ pragmatyczne podejÅ›cie, przy ktÃ³rym jednak tracimy zalety, ktÃ³re dawaÅ‚ nam GET z parametrami w URLu, czyli:  Å‚atwe wsparcie dla cacheâ€™owania. Co prawda standard RFC 7234 zakÅ‚ada wsparcie dla metod GET, HEAD i POST, ale wiÄ™kszoÅ›Ä‡ implementacji wspiera tylko metody GET i HEAD.  wsparcie dla ponawiania Å¼Ä…dania przez klienckÄ… bibliotekÄ™ HTTP przy bÅ‚Ä™dzie sieciowym.  zgodnoÅ›Ä‡ ze standardem. MoÅ¼na teÅ¼ spieraÄ‡ siÄ™ o to, jak bardzo to rozwiÄ…zanie jest nieeleganckie lub czy nie wprowadzi osÃ³b korzystajÄ…cych z naszego API w bÅ‚Ä…d.POST /locations/search{  &quot;country&quot;: &quot;France,Italy,Greece,......,Brazil&quot;,  &quot;minimum_population&quot;: 2500000,  &quot;type&quot;: &quot;city, village&quot;,  &quot;max_height&quot;: 1300,  &quot;min_area&quot;: 100000,  ....}{  &quot;locations&quot;: [    {&quot;id&quot;: &quot;2443&quot;, &quot;name&quot;: &quot;Rome&quot;},    {&quot;id&quot;: &quot;6789&quot;, &quot;name&quot;: &quot;Paris&quot;},    ...  ]}Czy takie rozwiÄ…zanie sÄ… spotykane w praktyce? Tak, np. zdecydowali siÄ™ na to twÃ³rcy Dropboxa, argumentujÄ…c swojÄ… decyzjÄ™ tutaj.GET i POSTTrzeci pomysÅ‚ to prÃ³ba poÅ‚Ä…czenia dwÃ³ch poprzednich rozwiÄ…zaÅ„ w taki sposÃ³b, Å¼ebyÅ›my byli zgodni ze standardem i intuicyjnym rozumieniem metod (czyli do pobierania danych ma sÅ‚uÅ¼yÄ‡ GET, a nie POST). Najpierw tworzymy zapytanie wyszukiwania, przekazujÄ…c w ciele POST-a parametry wyszukiwania. W odpowiedzi otrzymujemy id naszego wyszukiwania. Korzystamy z GETa i ze zwrÃ³conego wczeÅ›niej id, aby otrzymaÄ‡ nasz wynik.  MoÅ¼emy odczuÄ‡, Å¼e zaczynamy wprowadzaÄ‡ nadmiernie skomplikowany mechanizm, a przecieÅ¼ chcemy jedynie otrzymaÄ‡ wynik wyszukiwania. W tym celu konieczne bÄ™dÄ… aÅ¼ dwa wywoÅ‚ania usÅ‚ug i caÅ‚y mechanizm na serwerze zapisujÄ…cy gdzieÅ› te wyniki wyszukiwania.  MoÅ¼na w tej koncepcji wprowadziÄ‡ cacheâ€™owanie.  JesteÅ›my zgodni ze standardem.POST /locations/search{  &quot;country&quot;: &quot;France,Italy,Greece,......,Brazil&quot;,  &quot;minimum_population&quot;: 2500000,  &quot;type&quot;: &quot;city, village&quot;,  &quot;max_height&quot;: 1300,  &quot;min_area&quot;: 100000,  ....}{  &quot;id&quot;: &quot;1297612456456&quot;}GET /locations/search?id=1297612456456{  &quot;locations&quot;: [    {&quot;id&quot;: &quot;2443&quot;, &quot;name&quot;: &quot;Rome&quot;},    {&quot;id&quot;: &quot;6789&quot;, &quot;name&quot;: &quot;Paris&quot;},    ...  ]}Na pewno nie jest to popularne rozwiÄ…zanie, jest najbardziej kosztowne i ryzykowne, ale zyskujemy zgodnoÅ›Ä‡ ze standardem.Jak poprawnie odpowiadaÄ‡ na Å¼Ä…daniaRozrÃ³Å¼nianie miÄ™dzy niewÅ‚aÅ›ciwÄ… Å›cieÅ¼kÄ…, nieistniejÄ…cym zasobem, brakiem uprawnieÅ„â€¦CzÄ™stym bÅ‚Ä™dem w odpowiedzi na Å¼Ä…dania jest zwracanie nieprawidÅ‚owego (niezgodnego ze standardem) kodu bÅ‚Ä™du.  NaleÅ¼y pamiÄ™taÄ‡, Å¼e odpowiedÅº musi byÄ‡ zrozumiaÅ‚a i Å‚atwa w interpretacji dla uÅ¼ytkownika naszego API, a z drugiej strony nie moÅ¼na zapomnieÄ‡ o kwestiach zwiÄ…zanych z bezpieczeÅ„stwem.Zacznijmy od przykÅ‚adu.GET /films/1234Response: 404Co bÄ™dzie oznaczaÅ‚a odpowiedÅº z kodem bÅ‚Ä™du 404? MoÅ¼emy podejrzewaÄ‡ np. brak takiego zasobu, albo np. Å¼e zasÃ³b istnieje, ale nie mamy uprawnieÅ„ do niego. InnÄ… nasuwajÄ…cÄ… siÄ™ opcjÄ… jest to, Å¼e Å›cieÅ¼ka jest niewÅ‚aÅ›ciwa. Dlatego czÄ™Å›Ä‡ osÃ³b uwaÅ¼a, Å¼e naleÅ¼y zwracaÄ‡ inny kod bÅ‚Ä™du w kaÅ¼dym z tych przypadkÃ³w.ZaÅ‚Ã³Å¼my wiÄ™c, Å¼e bÄ™dziemy zwracaÄ‡ 403, jeÅ›li zasÃ³b istnieje, a uÅ¼ytkownik nie ma do niego dostÄ™pu. W ten sposÃ³b moÅ¼na Å‚atwo poprzez enumeracjÄ™ i przekazywanie kolejnych id, dowiedzieÄ‡ siÄ™, ile jest zasobÃ³w danego typu i poznaÄ‡ ich identyfikatory.GET /films/1Response: 403GET /films/2Response: 404...Dlatego teÅ¼ w zaleÅ¼noÅ›ci od tego, czy bezpieczne jest ujawnianie takich informacji klientowi, moÅ¼emy zwracaÄ‡ albo oba kody bÅ‚Ä™du - 403 i 404 dla rozrÃ³Å¼nienia obu przypadkÃ³w, albo samo 404, gdy chcemy postawiÄ‡ na jednÄ… moÅ¼liwoÅ›Ä‡. JeÅ›li wystawiamy serwisy wewnÄ™trznie, to o wiele przydatniejsze bÄ™dzie skorzystanie z kodu 403. Warto pamiÄ™taÄ‡, Å¼e kod 404 bÄ™dzie odpowiedni w sytuacji, gdy nie chcemy ujawniÄ‡ informacji, dlaczego nie zwracamy zasobu.PrzejdÅºmy do innego przykÅ‚adu. Czy 404 oznacza, Å¼e zasÃ³b nie istnieje, czy Å¼e Å›cieÅ¼ka jest niewÅ‚aÅ›ciwa? Trudno powiedzieÄ‡, jeÅ›li zwrÃ³cimy jedynie kod bÅ‚Ä™du 404.GET /firms/100Response: 404GET /films/100Response: 404W tym przypadku zalecane jest pozostanie przy kodzie 404, ale dodanie do odpowiedzi przyczyny bÅ‚Ä™du. Inny sposÃ³b â€” z dwoma rÃ³Å¼nymi kodami bÅ‚Ä™du, jest niezgodny ze standardem.GET /firms/100Response: 404Invalid path: /firmsGET /films/100Response: 404No film with id: 100SzczegÃ³Å‚y bÅ‚Ä™duJeÅ›li wystawiamy puliczne API, z ktÃ³rego korzystaÄ‡ bÄ™dzie wielu deweloperÃ³w, moÅ¼emy chcieÄ‡ podzieliÄ‡ siÄ™ bardzo dokÅ‚adnym szczegÃ³Å‚em bÅ‚Ä™du. W innym przypadku moÅ¼emy ze wzglÄ™dÃ³w bezpieczeÅ„stwa nie przekazywaÄ‡ w wersji produkcyjnej tak szczegÃ³Å‚owych informacji na temat bÅ‚Ä™du. W ogÃ³lnoÅ›ci poza obowiÄ…zkowym kodem bÅ‚Ä™du moÅ¼na zaproponowaÄ‡ dodatkowe pola, przedstawione w poniÅ¼szym przykÅ‚adzie.Response: 400{  &quot;errorCode&quot; : &quot;12355&quot;,  &quot;developerMessage&quot; : &quot;Message for developers of your API&quot;,  &quot;userMessage&quot; : &quot;Message for end user&quot;,  &quot;moreInfo&quot; : &quot;http://www.myapi.com/help/errors/12355&quot;}Poprawne odpowiedziPoza kodem odpowiedzi czÄ™sto zwracamy dane â€” warto trzymaÄ‡ siÄ™ nastÄ™pujÄ…cych zasad:  nie zwracamy kluczy i wartoÅ›ci zwiÄ…zanych z wewnÄ™trznÄ… serwerowÄ… reprezentacjÄ… i implementacjÄ…,  nie zwracamy wartoÅ›ci jako klucze.PrzykÅ‚ad zgodny z zasadami{  &quot;locations&quot;: [    {&quot;id&quot;: &quot;2443&quot;, &quot;name&quot;: &quot;Rome&quot;},    {&quot;id&quot;: &quot;6789&quot;, &quot;name&quot;: &quot;Paris&quot;}  ]}PrzykÅ‚ad Å‚amiÄ…cy pierwszÄ… zasadÄ™{  &quot;locations&quot;: [    {&quot;id&quot;: &quot;2443&quot;, &quot;name&quot;: &quot;Rome&quot;, &quot;internalId&quot;: &quot;345345&quot;, &quot;node&quot;: &quot;1&quot;},    {&quot;id&quot;: &quot;6789&quot;, &quot;name&quot;: &quot;Paris&quot;, &quot;internalId&quot;: &quot;235435345&quot;, &quot;node&quot;: 2}  ]}PrzykÅ‚ad Å‚amiÄ…cy drugÄ… zasadÄ™{  &quot;locations&quot;: [    {&quot;2443&quot;: &quot;Rome&quot;},    {&quot;6789&quot;: &quot;Paris&quot;}  ]}Metoda PATCHPATCH a PUTMetoda PATCH zostaÅ‚a wprowadzona do standardu w RFC 5789 w 2010 roku, nie byÅ‚ to jednak wÃ³wczas nowy pomysÅ‚. Koncepcja opiera siÄ™ na tym, Å¼e w przeciwieÅ„stwie do metody PUT, nie przekaÅ¼emy caÅ‚ego zasobu, a jedynie zmiany. W zwiÄ…zku z tym metoda nie jest idempotentna w przeciwieÅ„stwie do metody PUT.ZaÅ‚Ã³Å¼my, Å¼e chcemy zaktualizowaÄ‡ liczbÄ™ ludnoÅ›ci miasta, przechowywanÄ… w polu  population i dodaÄ‡ wartoÅ›Ä‡, ktÃ³ra dotychczas nie byÅ‚a zdefiniowana, dla gÄ™stoÅ›ci zaludnienia density. WÃ³wczas oczywiÅ›cie PUT z peÅ‚nymi danymi tylko po to, Å¼eby zaktualizowaÄ‡ dwie wartoÅ›ci z wielu, nie ma sensu.PUT /locations/6789{  &quot;name&quot; : &quot;Paris&quot;,  &quot;country&quot;: &quot;France&quot;,  &quot;population&quot;: 2206488,  &quot;density&quot;: 20000,  &quot;type&quot;: &quot;city&quot;,  &quot;height_a&quot;: 1300,  &quot;min_area&quot;: 105.4,  &quot;time_zone&quot;: &quot;UTC+01:00&quot;,  &quot;amsl&quot;: 35,  ....}Zazwyczaj czytajÄ…c o metodzie PATCH, zetkniemy siÄ™ z nastÄ™pujÄ…cym przykÅ‚adem, ktÃ³ry jednak nie jest zgodny ze standardem.PATCH /locations/6789{  &quot;population&quot;: 2206488,  &quot;density&quot;: 20000}Na postawie dokumentu RFC 7396 moÅ¼na zaproponowaÄ‡ drobnÄ… modyfikacjÄ™ tego przykÅ‚adu.PATCH /locations/6789Content-Type: application/merge-patch+json{  &quot;population&quot;: 2206488,  &quot;density&quot;: 20000}Innym podejÅ›ciem, opisanym w RFC 6902 jest zapis stosujÄ…cy operacje. Taki obiekt skÅ‚ada siÄ™ z jednego operatora, okreÅ›lajÄ…cego, jakÄ… akcjÄ™ naleÅ¼y wykonaÄ‡. SÄ… to add, remove, replace, move, copy, test. W Å¼Ä…daniu moÅ¼emy przekazaÄ‡ kilka operacji. W przypadku metody PATCH serwer musi zaaplikowaÄ‡ nasze Å¼Ä…danie atomowo, czyli mamy pewnoÅ›Ä‡, Å¼e albo wszystkie pola zostanÄ… zmodyfikowane w Å¼Ä…dany sposÃ³b, albo Å¼adne (w przypadku bÅ‚Ä™du). PATCH /locations/6789Content-Type: application/json-patch+json   [     { &quot;op&quot;: &quot;test&quot;, &quot;path&quot;: &quot;/population&quot;, &quot;value&quot;: 2175601 },     { &quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/population&quot;, &quot;value&quot;: 2206488 },     { &quot;op&quot;, &quot;add&quot;, &quot;path&quot;: &quot;/density&quot;, &quot;value&quot;: 20000},   ]Czy w praktyce PATCH jest czÄ™sto stosowany? Czy faktycznie deweloperzy stosujÄ… PUT tylko zgodnie z zasadÄ…, Å¼e naleÅ¼y przekazaÄ‡ caÅ‚y zasÃ³b? W wielu przypadkach stosowanie jest obejÅ›cie w postaci uÅ¼ycia POSTa.PrzykÅ‚ad z blokowaniem na WAFChcÄ…c jednak byÄ‡ spÃ³jni ze standardem i stosujÄ…c metodÄ™ PATCH w odpowiednim przypadku, moÅ¼emy zorientowaÄ‡ siÄ™, Å¼e Å¼Ä…dania PATCH trafiajÄ…ce na nasz serwer sÄ… po drodze wycinane â€” blokowane przez WAF. WAF, ktÃ³rego celem jest zapewnienie bezpieczeÅ„stwa, jest konfigurowany zazwyczaj przez inny zespÃ³Å‚, czasem z innej firmy lub przez klienta, dla ktÃ³rego dostarczamy rozwiÄ…zanie. Dlatego tego typu problemy sÄ… dosyÄ‡ czÄ™ste. Konfiguracja WAF jest oparta na blokowaniu niedozwolonych Å¼Ä…daÅ„ i odpowiedzi lub akceptowaniu tylko dozwolonych.Czy w opisanym przypadku blokowanie Å¼Ä…daÅ„, ktÃ³re korzystajÄ… z metody PATCH, byÅ‚o uzasadnione? Zapewne wynikaÅ‚o z tego, Å¼e konfiguracja byÅ‚a zawÄ™Å¼ona najbardziej, jak to byÅ‚o moÅ¼liwe. W tym przypadku moÅ¼na oczywiÅ›cie zmieniÄ‡ konfiguracjÄ™ WAF, ale nierzadko w tego typu sytuacjach w praktyce dostosowujemy siÄ™ do infrastruktury klienta, ktÃ³remu dostarczamy oprogramowanie i decydujemy siÄ™ na zmianÄ™ np. na PUT. W ten sposÃ³b nie jesteÅ›my juÅ¼ zgodni ze standardem. WidaÄ‡ tu wyraÅºnie rÃ³Å¼nicÄ™ miÄ™dzy sytuacjÄ…, gdy wystawiamy API dla potencjalnie wielu klientÃ³w i wÃ³wczas trzymanie siÄ™ standardÃ³w uÅ‚atwi innym zrozumienie naszego API, a sytuacjÄ…, gdy tworzymy rozwiÄ…zanie dla jednego klienta, ktÃ³re dziaÅ‚a na jego infrastrukturze, a my staramy siÄ™ byÄ‡ elastyczni. W drugim przypadku jakoÅ›Ä‡ naszego API bÄ™dzie duÅ¼o niÅ¼sza. Nie moÅ¼na jednak zapominaÄ‡, Å¼e zazwyczaj reguÅ‚y na WAFie sÅ‚uÅ¼Ä… poprawie bezpieczeÅ„stwa i zabezpieczeniem przed znanymi i dobrze opisanymi atakami. Dlatego czÄ™sto to wÅ‚aÅ›nie brak trzymania siÄ™ standardÃ³w doprowadzi do problemÃ³w na WAF-ie.PodsumowanieKrÃ³tka podrÃ³Å¼ po polecanych i odradzanych praktykach w obszarze REST i HTTP dobiegÅ‚a koÅ„ca, a jest to jedynie wycinek tych zagadnieÅ„. Te konkretne przypadki to prÃ³ba rozprawienia siÄ™ z czÄ™sto spotykanymi bÅ‚Ä™dami. Ale najwaÅ¼niejszy byÄ‡ moÅ¼e wniosek to: uczmy siÄ™ standardÃ³w, by albo je stosowaÄ‡, albo â€” w uzasadnionych przypadkach â€” Å›wiadomie Å‚amaÄ‡.",
"url": "/2021/03/31/rest-api-dobre-praktyki.html",
"author": "Barbara Mitan",
"authorUrl": "/authors/bmitan.html",
"image": "bmitan.jpg",
"highlight": "/assets/img/posts/2021-03-31-rest-api-dobre-praktyki/RESTApi.jpeg",
"date": "31-03-2021",
"path": "pl/2021-03-31-rest-api-dobre-praktyki"
}
,


"2021-03-03-przyklad-migracji-do-chmury-html": {
"title": "Migracja aplikacji do chmury Google Cloud Platform w praktyce",
"lang": "pl",
"tags": "cloud serverless gcp googlecloud cloud migration google cloud platform",
"content": "W poprzednim wpisie pt. â€œMigracja do chmury - czyli od czego zaczÄ…Ä‡?â€przedstawiÅ‚em etapy procesu migracji aplikacji do chmury, a takÅ¼e opisaÅ‚em poszczegÃ³lne strategie migracji.W tym wpisie chciaÅ‚bym przedstawiÄ‡ migracjÄ™ do chmury Google Cloud Platform w praktyce. Na warsztat wezmÄ™ dziaÅ‚ajÄ…cÄ… aplikacjÄ™ demo, ktÃ³ra w Å¼aden sposÃ³b nie jest przystosowana do uruchomienia w chmurze, przedstawiÄ™ architekturÄ™ docelowÄ… przy wykorzystaniu kaÅ¼dej z opisywanych wczeÅ›niej strategii oraz zaimplementujÄ™ jednÄ… z nich.SÅ‚owem wstÄ™puKody ÅºrÃ³dÅ‚owe aplikacji demo sÄ… dostÄ™pne na GitHubie:  aplikacja ÅºrÃ³dÅ‚owa (przed migracjÄ…)  aplikacja docelowa (po migracji)Dla przypomnienia, 4 etapy procesu migracji do chmury, opisane w poprzednim wpisie:SzacowanieNa etapie szacowania powinniÅ›my dokonaÄ‡ analizy istniejÄ…cego systemu/infrastruktury. Na potrzeby wpisu przygotowaÅ‚em aplikacjÄ™ demo, ktÃ³ra nie jest uruchomiona produkcyjnie, stÄ…d trudno byÅ‚oby oszacowaÄ‡ wykorzystywane zasoby. Nie chcÄ…c wrÃ³Å¼yÄ‡ z fusÃ³w, na etapie szacowania przedstawiÄ™ jedynie architekturÄ™ aplikacji oraz jej dziaÅ‚anie.Zadaniem aplikacji jest przyjÄ™cie danych od uÅ¼ytkownika za pomocÄ… formularza, przetworzenie ich, utrwalenie w bazie danych oraz umoÅ¼liwienie uÅ¼ytkownikowi odczytu tych danych. System skÅ‚ada siÄ™ z kilku elementÃ³w:  aplikacji frontendowej - napisanej w Angularze (TypeScript), ktÃ³rej zadaniem jest przyjmowanie danych od uÅ¼ytkownika oraz ich prezentacja;  aplikacji backendowej - napisanej w Javie (Spring Boot), ktÃ³rej zadaniem jest przyjÄ™cie danych z aplikacji frontendowej i przesÅ‚anie ich do kolejki oraz odczytanie z bazy danych;  kolejki - opartej o RabbitMQ, ktÃ³rej celem jest optymalizacja zapisu;  bazy danych - w postaci nierelacyjnej bazy MongoDB, ktÃ³ra przechowuje przesÅ‚ane dane.WykorzystaÅ‚em kolejkÄ™, aby dane przesyÅ‚ane przez uÅ¼ytkownikÃ³w byÅ‚y od razu przyjmowane, a uÅ¼ytkownik otrzymywaÅ‚ potwierdzenie przyjÄ™cia ich przez system. Przetwarzanie danych moÅ¼e byÄ‡ w teorii czasochÅ‚onnym procesem, dlatego dziÄ™ki wykorzystaniu kolejki, uÅ¼ytkownik nie musi czekaÄ‡ na przetworzenie danych, aby uzyskaÄ‡ odpowiedÅº.Dane pobierane sÄ… z kolejki przez aplikacjÄ™ backendowÄ…, nastÄ™pnie przetwarzane (w przykÅ‚adowej aplikacji pominÄ…Å‚em element przetwarzania - moÅ¼emy wyobraziÄ‡ sobie tutaj jakiÅ› zÅ‚oÅ¼ony i czasochÅ‚onny proces) i utrwalane w bazie danych. Odczyt danych z bazy wykonywany jest rÃ³wnieÅ¼ przez aplikacjÄ™ backendowÄ…, za poÅ›rednictwem sterownika bazy danych, a nastÄ™pnie dane te sÄ… przesyÅ‚ane do aplikacji frontendowej w formacie JSON.Infrastruktura systemu ÅºrÃ³dÅ‚owego moÅ¼e byÄ‡ oparta o maszyny fizyczne, wirtualne, kontenery (Docker, Kubernetes, OpenShift) lub o dowolne inne rozwiÄ…zanie. Na potrzeby wpisu wykorzystaÅ‚em Docker Compose, co uÅ‚atwia uruchomienie caÅ‚ej aplikacji lokalnie.ZakÅ‚adajÄ…c znajomoÅ›Ä‡ podstawowych usÅ‚ug oferowanych przez Google Cloud Platform, przejdÅºmy do kolejnego etapu migracji.PlanowaniePlanujÄ…c architekturÄ™ systemu w chmurze, pierwszÄ… czynnoÅ›ciÄ…, jakÄ… naleÅ¼y wykonaÄ‡, jest wybÃ³r strategii migracji. Od niej zaleÅ¼eÄ‡ bÄ™dzie to, jak bÄ™dzie wyglÄ…daÅ‚ system docelowy oraz jakie narzÄ™dzia i usÅ‚ugi zostanÄ… wykorzystane.WybierajÄ…c strategiÄ™ migracji, przyjÄ…Å‚em kilka zaÅ‚oÅ¼eÅ„:  nie ma Å¼adnych ograniczeÅ„ budÅ¼etowych oraz czasowych na wykonanie migracji;  system musi byÄ‡ gotowy obsÅ‚uÅ¼yÄ‡ kaÅ¼dy ruch uÅ¼ytkownikÃ³w (automatyczne skalowanie);  utrzymanie infrastruktury powinno wymagaÄ‡ jak najmniejszego udziaÅ‚u czÅ‚owieka (automatyzacja);  koszt utrzymania powinien byÄ‡ moÅ¼liwie jak najniÅ¼szy, szczegÃ³lnie w przypadku braku ruchu uÅ¼ytkownikÃ³w.Zanim podejmiemy ostatecznÄ… decyzjÄ…, zastanÃ³wmy siÄ™, jaka bÄ™dzie architektura systemu docelowego, w zaleÅ¼noÅ›ci od wykorzystanej strategii. Zalety oraz wady kaÅ¼dej ze strategii opisaÅ‚em juÅ¼ w poprzednim wpisie, a podane tutaj rozwiÄ…zania majÄ… jedynie charakter przykÅ‚adowy. To jak zaplanujemy architekturÄ™ docelowÄ…, zaleÅ¼y od wielu czynnikÃ³w, a strategie majÄ… jedynie pomÃ³c nam w podjÄ™ciu decyzji.Strategia â€œLift and shiftâ€Migracja strategiÄ… â€œLift and shiftâ€ polega na wykorzystaniu maszyn wirtualnych (Compute Engine) na ktÃ³rych uruchomione zostanÄ… poszczegÃ³lne elementy systemu. WyjÄ…tek stanowi aplikacja frontendowa, ktÃ³rej pliki statyczne bÄ™dÄ…ce wynikiem zbudowania aplikacji, umieszczone zostanÄ… w buckecie (Cloud Storage).Plusy:Proces migracji w tym wypadku jest nieskomplikowany, wymaga od nas minimalnej znajomoÅ›ci platformy i zajmie stosunkowo niewiele czasu. W przypadku, gdy infrastruktura ÅºrÃ³dÅ‚owa oparta jest o VMware vSphere, chmurÄ™ AWS lub Azure, moÅ¼emy zautomatyzowaÄ‡ caÅ‚y proces, wykorzystujÄ…c do tego celu narzÄ™dzie Migrate for Compute Engine.Minusy:Nie wykorzystujemy praktycznie wcale potencjaÅ‚u chmury, odpowiedzialnoÅ›Ä‡ za system stoi w wiÄ™kszoÅ›ci po naszej stronie, a kolejka oraz baza danych nie jest skalowana automatycznie. Musimy rÃ³wnieÅ¼ z gÃ³ry okreÅ›liÄ‡ typ maszyn Compute Engine oraz skonfigurowaÄ‡ ich skalowanie (managed instance groups).Strategia â€œImprove and moveâ€Migracja strategiÄ… â€œImprove and moveâ€ polega na zastÄ…pieniu bazy danych oraz kolejki usÅ‚ugami SaaS. SÄ… to elementy, ktÃ³re najÅ‚atwiej jest zastÄ…piÄ‡, przy jak najmniejszym nakÅ‚adzie pracy. BazÄ™ danych zastÄ™puje w tym przypadku odpowiadajÄ…ca jej usÅ‚uga Cloud Firestore, a kolejkÄ™ usÅ‚uga Cloud Pub/Sub.Plusy:Eliminujemy problem braku automatycznego skalowania bazy danych i kolejki, przesuwajÄ…c rÃ³wnieÅ¼ odpowiedzialnoÅ›Ä‡ za te elementy na usÅ‚ugodawcÄ™.Minusy:Wymagana jest znajomoÅ›Ä‡ wykorzystywanych usÅ‚ug SaaS, a takÅ¼e ingerencja w kody ÅºrÃ³dÅ‚owe aplikacji (warstwa komunikacji z bazÄ…/kolejkÄ…). Backend nadal oparty jest o maszyny wirtualne, ze wszelkimi tego konsekwencjami.Strategia â€œRip and replaceâ€Migracja strategiÄ… â€œRip and replaceâ€ polega na caÅ‚kowitym wykorzystaniu natywnych rozwiÄ…zaÅ„ chmury. OprÃ³cz usÅ‚ug SaaS, wykorzystujemy dodatkowo Cloud Functions, dziÄ™ki czemu eliminujemy minusy poprzednich dwÃ³ch strategii.Plusy:Optymalizujemy architekturÄ™ systemu, przesuwajÄ…c granicÄ™ odpowiedzialnoÅ›ci prawie caÅ‚kowicie na stronÄ™ usÅ‚ugodawcy. Cloud Functions umoÅ¼liwia wywoÅ‚ywanie funkcji po pojawieniu siÄ™ wiadomoÅ›ci w usÅ‚udze Cloud Pub/Sub, dziÄ™ki czemu aplikacja frontendowa moÅ¼e zapisywaÄ‡ dane przyjÄ™te od uÅ¼ytkownika bezpoÅ›rednio do kolejki, bez poÅ›rednictwa aplikacji backendowej. PrzepisujÄ…c aplikacjÄ™ backendowÄ… na funkcjÄ™ moÅ¼na zrezygnowaÄ‡ rÃ³wnieÅ¼ z jej poÅ›rednictwa w odczycie danych z Cloud Firestore, poniewaÅ¼ usÅ‚uga ta udostÄ™pnia REST API, ktÃ³re umoÅ¼liwia odczyt danych bezpoÅ›rednio przez aplikacjÄ™ frontendowÄ…. DziÄ™ki automatycznemu skalowaniu (rÃ³wnieÅ¼ do zera), optymalizujemy koszty utrzymania infrastruktury, ktÃ³re w przypadku zerowego ruchu uÅ¼ytkownikÃ³w, moÅ¼na ograniczyÄ‡ caÅ‚kowicie do zera (w ramach GCP Free Tier).Minusy:Wykorzystanie natywnych rozwiÄ…zaÅ„ wymaga od nas bardzo dobrej znajomoÅ›ci platformy, usÅ‚ug oraz komunikacji miÄ™dzy nimi. Jak okaÅ¼e siÄ™ za chwilÄ™, pojawiajÄ… siÄ™ rÃ³wnieÅ¼ nowe problemy, jak na przykÅ‚ad ograniczenia API usÅ‚ug, czy problem zimnego startu funkcji. Migracja z wykorzystaniem strategii â€œRip and replaceâ€ jest rÃ³wnieÅ¼ najbardziej czasochÅ‚onna, poniewaÅ¼ wymaga caÅ‚kowitego przepisania czÄ™Å›ci systemu. WykorzystujÄ…c natywne rozwiÄ…zania platformy uzaleÅ¼niamy siÄ™ rÃ³wnieÅ¼ od usÅ‚ugodawcy (vendor lock-in).Architektura systemu docelowegoPoniewaÅ¼ zÅ‚oÅ¼onoÅ›Ä‡ systemu ÅºrÃ³dÅ‚owego jest niewielka i chciaÅ‚bym w tym wpisie pokazaÄ‡ jak najwiÄ™cej, przeprowadzimy migracjÄ™ z wykorzystaniem strategii â€œRip and replaceâ€. Architektura systemu docelowego bÄ™dzie wiÄ™c wyglÄ…daÄ‡ nastÄ™pujÄ…co:  aplikacja frontendowa (pliki statyczne) zostanie umieszczona w Cloud Storage i udostÄ™pniona publicznie, wykorzystujÄ…c HTTP/S Load Balancer. AlternatywÄ… jest wykorzystanie platformy Firebase, w praktyce jednak, Firebase przechowuje pliki statyczne rÃ³wnieÅ¼ w Cloud Storage, przykrywajÄ…c wszystko wÅ‚asnym interfejsem graficznym;  aplikacja backendowa, z racji niskiej zÅ‚oÅ¼onoÅ›ci, zostanie przepisana caÅ‚kowicie na Cloud Functions. Utracona zostanie walidacja danych wejÅ›ciowych, ale dziÄ™ki temu uÅ¼ytkownik bÄ™dzie mÃ³gÅ‚ przesyÅ‚aÄ‡ dane do Cloud Pub/Sub bezpoÅ›rednio z aplikacji frontendowej. Dane te mogÄ… byÄ‡ walidowane przez funkcjÄ™, ktÃ³ra pobiera je z Cloud Pub/Sub, przetwarza i utrwala w Firestore. Gdyby walidacja byÅ‚a wymagana przed wrzuceniem danych do Cloud Pub/Sub, to pomiÄ™dzy aplikacjÄ… frontendowÄ… a Cloud Pub/Sub musiaÅ‚aby znaleÅºÄ‡ siÄ™ dodatkowa funkcja, ktÃ³rej zadaniem byÅ‚oby przyjÄ™cie lub odrzucenie danych oraz przesÅ‚anie ich do Cloud Pub/Sub;  kolejka RabbitMQ zostanie zastÄ…piona caÅ‚kowicie przez usÅ‚ugÄ™ Cloud Pub/Sub;  baza danych MongoDB zostanie zastÄ…piona caÅ‚kowicie przez odpowiadajÄ…cÄ… jej usÅ‚ugÄ™ Cloud Firestore, ktÃ³ra jest bazÄ… nierelacyjnÄ…, przechowujÄ…cÄ… dane w formie dokumentÃ³w JSON.W systemie docelowym, jako Å¼e jest on w infrastrukturze chmury (czyli dostÄ™pny publicznie przez Internet), w celu zabezpieczenia przed nieupowaÅ¼nionym dostÄ™pem, musimy zaimplementowaÄ‡ mechanizm uwierzytelniania (chyba, Å¼e nie obawiamy siÄ™ rachunkÃ³w od Google). W tym celu wykorzystamy Google Sign-In. Aby to zrobiÄ‡, musimy w APIs &amp;amp; Services stworzyÄ‡ credential OAuth client ID i skonfigurowaÄ‡ w Cloud IAM przykÅ‚adowego uÅ¼ytkownika, ktÃ³ry posiadaÄ‡ bÄ™dzie uprawnienia do korzystania z aplikacji (moÅ¼e to byÄ‡ nasze gÅ‚Ã³wne konto, ktÃ³re posiada rolÄ™ wÅ‚aÅ›ciciela).DziÄ™ki wykorzystaniu Cloud Functions, zoptymalizujemy koszt utrzymania systemu. Funkcje generujÄ… koszt wyÅ‚Ä…cznie wtedy, kiedy dziaÅ‚ajÄ… - za liczbÄ™ wywoÅ‚aÅ„ oraz czas ich wykonywania. W przypadku bardzo niskiego ruchu (Å‚apiÄ…cego siÄ™ w darmowe limity wywoÅ‚aÅ„ funkcji), lub jego braku, opÅ‚aty mogÄ… zostaÄ‡ zminimalizowane do zera. Funkcje skalujÄ… siÄ™ automatycznie, dlatego caÅ‚a odpowiedzialnoÅ›Ä‡ za obsÅ‚uÅ¼enie ruchu uÅ¼ytkownikÃ³w i zapewnienie dostÄ™pnoÅ›ci systemu leÅ¼y po stronie usÅ‚ugodawcy.UsÅ‚uga Cloud Pub/Sub dziaÅ‚a na zasadzie kolejki, wiÄ™c idealnie zastÄ…pi RabbitMQ. Zazwyczaj Cloud Pub/Sub dostarcza kaÅ¼dÄ… wiadomoÅ›Ä‡ jeden raz oraz w takiej kolejnoÅ›ci, w jakiej zostaÅ‚a opublikowana. Google w dokumentacji usÅ‚ugi informuje, Å¼e mogÄ… zdarzyÄ‡ siÄ™ sytuacje, w ktÃ³rych wiadomoÅ›Ä‡ zostanie dostarczona poza kolejnoÅ›ciÄ… lub wiÄ™cej niÅ¼ jeden raz. WiedzÄ…c o tym, naleÅ¼y zaimplementowaÄ‡ odbiorcÄ™ wiadomoÅ›ci w sposÃ³b idempotentny, czyli odporny na wielokrotne dostarczenie tej samej wiadomoÅ›ci. W przypadku aplikacji demo nie stanowi to problemu, poniewaÅ¼ kaÅ¼da wiadomoÅ›Ä‡ posiadaÄ‡ bÄ™dzie unikalny identyfikator, a wielokrotne zapisanie tej samej wiadomoÅ›ci do Cloud Firestore spowoduje jej nadpisanie. W systemie ÅºrÃ³dÅ‚owym, wykorzystanie RabbitMQ rÃ³wnieÅ¼ wymagaÅ‚o idempotentnego odbiorcy wiadomoÅ›ci.Pojawienie siÄ™ wiadomoÅ›ci w Cloud Pub/Sub triggerowaÄ‡ bÄ™dzie wywoÅ‚anie funkcji odpowiedzialnej za przetworzenie wiadomoÅ›ci i utrwalenie jej w Cloud Firestore. Zrezygnujemy z funkcji pomiÄ™dzy aplikacjÄ… frontendowÄ… a Cloud Pub/Sub, poniewaÅ¼ zakÅ‚adamy, Å¼e nie ma potrzeby walidacji danych przed wysÅ‚aniem ich do Cloud Pub/Sub. W aplikacji ÅºrÃ³dÅ‚owej taka walidacja byÅ‚a wykonywana przez aplikacjÄ™ backendowÄ…, zanim wiadomoÅ›Ä‡ zostaÅ‚a wysÅ‚ana do kolejki RabbitMQ. DziÄ™ki temu, podczas migracji zoptymalizujemy system, upraszczajÄ…c jego architekturÄ™. OczywiÅ›cie taka optymalizacja byÅ‚aby moÅ¼liwa rÃ³wnieÅ¼ w systemie ÅºrÃ³dÅ‚owym, poniewaÅ¼ RabbitMQ umoÅ¼liwia dostarczanie wiadomoÅ›ci poprzez REST API, wykorzystujÄ…c w tym celu dodatkowÄ… wtyczkÄ™.Odpowiednikiem bazy MongoDB jest usÅ‚uga Cloud Firestore. UmoÅ¼liwia ona zapis i odczyt za pomocÄ… REST API, dziÄ™ki czemu odczyt moÅ¼e byÄ‡ wykonywany w samej aplikacji frontendowej, bez udziaÅ‚u aplikacji backendowej (nie jest potrzebny sterownik do bazy danych). To upraszcza jeszcze bardziej architekturÄ™ systemu docelowego.WdraÅ¼anieWszystkie elementy zostanÄ… wdroÅ¼one rÄ™cznie, za pomocÄ… Cloud CLI (ktÃ³re umoÅ¼liwia wykonywanie poleceÅ„ GCP w lokalnym terminalu) oraz Cloud Console.Aplikacja frontendowaMigracja aplikacji frontendowej wymaga drobnych zmian. Po pierwsze, musimy zaimplementowaÄ‡ uwierzytelnianie, wykorzystujÄ…ce Google Sign-In. W tym celu, w pliku environment.ts musimy skonfigurowaÄ‡ Client ID, ktÃ³ry wygenerowaliÅ›my wczeÅ›niej. Po drugie, gÅ‚Ã³wne zmiany zajdÄ… w serwisie odpowiedzialnym za zapis oraz odczyt danych (w systemie ÅºrÃ³dÅ‚owym, wszystko odbywa siÄ™ przez aplikacjÄ™ backendowÄ…). PrzykÅ‚adowy zapis oraz odczyt w aplikacji frontendowej (w systemie ÅºrÃ³dÅ‚owym), wyglÄ…da nastÄ™pujÄ…co:upsertData(data: Data): Observable&amp;lt;Object&amp;gt; {    console.log(`Sending ${JSON.stringify(data)}`);    return this.http.post(`${environment.apiUrl}/api`, data);}findByUuid(uuid: string): Observable&amp;lt;Object&amp;gt; {    console.log(`Find by uuid: ${uuid}`);    return this.http.get(`${environment.apiUrl}/api/${uuid}`);}Funkcja upsertdata przesyÅ‚a dane do aplikacji backendowej, za pomocÄ… Å¼Ä…dania HTTP POST. Odczyt danych za poÅ›rednictwem aplikacji backendowej wykonywany jest przez funkcjÄ™ findByUuid, za pomocÄ… Å¼Ä…dania HTTP GET.W systemie docelowym, zapis wykonywany jest bezpoÅ›rednio z aplikacji frontendowej do usÅ‚ugi Cloud Pub/Sub, a odczyt bezpoÅ›rednio z Cloud Firestore:upsertData(data: Data): Observable&amp;lt;Object&amp;gt; {    console.log(`Sending ${JSON.stringify(data)}`);    let dataToSend = Object.assign({}, data);    dataToSend.uuid = uuid.v4();    return this.http.post(environment.pubSubUrl, {      &quot;messages&quot;: [        {          &quot;data&quot;: btoa(JSON.stringify(dataToSend))        }      ]    }).pipe(map(response =&amp;gt; ({      messageId: response[&#39;messageIds&#39;][0],      uuid: dataToSend.uuid    })));  }findByUuid(documentUuid: string): Observable&amp;lt;Data&amp;gt; {    console.log(`Find by uuid: ${documentUuid}`);    return this.http.get&amp;lt;any&amp;gt;(`${environment.firestoreUrl}/${documentUuid}`)        .pipe(map(object =&amp;gt;            ({                uuid: object.fields.uuid.stringValue,                manufacturer: object.fields.manufacturer.stringValue,                model: object.fields.model.stringValue            })));}Funkcja upsertData przygotowuje obiekt do wysÅ‚ania do usÅ‚ugi Cloud Pub/Sub, dodajÄ…c do niego unikalny identyfikator UUID i kodujÄ…c wiadomoÅ›Ä‡ do formatu Base64. OdpowiedÅº z usÅ‚ugi jest mapowana na odpowiedni model.Funkcja findByUuid pobiera dane z usÅ‚ugi Cloud Firestore i mapuje je na odpowiedni model.GÅ‚Ã³wna rÃ³Å¼nica w zapisie, to nadanie unikalnego identyfikatora UUID, ktÃ³ry wczeÅ›niej byÅ‚ nadawany przez aplikacjÄ™ backendowÄ…, przygotowanie wiadomoÅ›ci Cloud Pub/Sub oraz przemapowanie odpowiedzi.Odczyt rÃ³Å¼ni siÄ™ natomiast tym, Å¼e z odpowiedzi usÅ‚ugi Cloud Firestore, wyciÄ…gane sÄ… jedynie potrzebne dane (oryginalna odpowiedÅº zawiera wiele dodatkowych informacji, takich jak znaczniki czasowe zapisu/aktualizacji itp., ktÃ³re nie sÄ… prezentowane uÅ¼ytkownikowi).CaÅ‚a logika odpowiedzialna za przemapowanie Å¼Ä…dania/odpowiedzi, ktÃ³ra do tej pory byÅ‚a zaimplementowana w aplikacji backendowej, musi zostaÄ‡ zaimplementowana po stronie aplikacji frontendowej. DziÄ™ki temu architektura znaczÄ…co siÄ™ upraszcza.Aby uruchomiÄ‡ aplikacjÄ™ w chmurze, potrzebny jest bucket w Cloud Storage oraz usÅ‚uga HTTP(S) Load Balancer. Po zbudowaniu aplikacji frontendowej, wygenerowane pliki statyczne (JS oraz CSS) umieszczamy w buckecie.Musimy pamiÄ™taÄ‡ jeszcze o skonfigurowaniu go w taki sposÃ³b, aby pliki byÅ‚y dostÄ™pne publicznie. W tym celu, naleÅ¼y dodaÄ‡ w konfiguracji bucketu uÅ¼ytkownika o nazwie allUsers oraz nadaÄ‡ mu uprawnienie Storage Object Viewer.Po umieszczeniu plikÃ³w w Cloud Storage, bÄ™dÄ… one dostÄ™pne publicznie, np. plik index.html bÄ™dzie dostÄ™pny pod adresem:https://storage.googleapis.com/BUCKET_NAME/index.htmlAplikacja nie bÄ™dzie jednak dziaÅ‚aÄ‡, gdyÅ¼ do jej uruchomienia potrzebna bÄ™dzie jeszcze usÅ‚uga Cloud Load Balancing. Bez niej, po wejÅ›ciu na podany wyÅ¼ej adres, zostanie wyÅ›wietlona jedynie zawartoÅ›Ä‡ pliku index.html, a zawarte w nim skrypty JavaScript nie zostanÄ… w Å¼aden sposÃ³b zinterpretowane przez przeglÄ…darkÄ™, w efekcie czego wyÅ›wietli siÄ™ jedynie pusta strona.Podczas konfiguracji usÅ‚ugi Cloud Load Balancing, jako backend musimy skonfigurowaÄ‡ bucket zawierajÄ…cy pliki statyczne oraz musimy nadaÄ‡ statyczny adres IP. Dodatkowo moÅ¼emy wykorzystaÄ‡ usÅ‚ugÄ™ Cloud CDN. WiÄ™cej na ten temat znajdziemy w dokumentacji: Setting up a load balancer with backend buckets.DziÄ™ki temu, aplikacja bÄ™dzie dziaÅ‚aÄ‡ poprawnie pod adresem IP:http://LOAD_BALANCER_IP/index.htmlDo peÅ‚ni szczÄ™Å›cia potrzebna jest jeszcze domena, ktÃ³ra musi zostaÄ‡ skonfigurowana w usÅ‚udze Cloud Load Balancing. Google Sign-In, ktÃ³re zostaÅ‚o wykorzystane do uwierzytelniania, wymaga skonfigurowania adresu Origin dla wygenerowanego Client ID, czyli adresu, pod ktÃ³rym bÄ™dzie dostÄ™pna aplikacja internetowa. Nie moÅ¼e to byÄ‡ adres IP, poniewaÅ¼ mimo moÅ¼liwoÅ›ci wpisania w tym miejscu adresu IP, podczas prÃ³by zalogowania siÄ™ otrzymamy bÅ‚Ä…d redirect_uri_mismatch:The JavaScript origin in the request, does not match the ones authorized for the OAuth client,czyli taki sam, jak w przypadku braku adresu Origin.Po skonfigurowaniu domeny, moÅ¼emy skonfigurowaÄ‡ odpowiednio Client ID:KolejkaW konsoli usÅ‚ugi Cloud Pub/Sub musimy skonfigurowaÄ‡ nowy topic, ktÃ³rego identyfikator zostanie przekazany do aplikacji frontendowej, poniewaÅ¼ adres na ktÃ³ry sÄ… wysyÅ‚ane wiadomoÅ›ci (environment.pubSubUrl) musi wskazywaÄ‡, na jaki topic wiadomoÅ›Ä‡ jest wysyÅ‚ana (a takÅ¼e musi zawieraÄ‡ id projektu):https://pubsub.googleapis.com/v1/projects/PROJECT_ID/topics/TOPIC_NAME:publishKonfiguracja kolejki w zasadzie na tym siÄ™ koÅ„czy, poniewaÅ¼ usÅ‚uga Cloud Pub/Sub nie wymaga Å¼adnych dodatkowych konfiguracji.Aplikacja backendowaAplikacja backendowa, ktÃ³ra odpowiedzialna jest za komunikacjÄ™ aplikacji frontendowej z kolejkÄ… RabbitMQ oraz bazÄ… danych MongoDB, zostanie zastÄ…piona krÃ³tkÄ… funkcjÄ….Zapis danych do usÅ‚ugi Cloud Pub/Sub oraz odczyt z Cloud Firestore odbywa siÄ™ bezpoÅ›rednio przez REST API, dlatego jedynÄ… odpowiedzialnoÅ›ciÄ… funkcji jest pobieranie danych pojawiajÄ…cych siÄ™ w Cloud Pub/Sub, przetwarzanie ich (jak juÅ¼ wspomniaÅ‚em, pominÄ…Å‚em przetwarzanie) oraz utrwalenie w Cloud Firestore.FunkcjÄ™ napiszemy w jednym z dostÄ™pnych w Cloud Functions jÄ™zykÃ³w, a dokÅ‚adnie w JavaScript, ktÃ³ry wykorzystuje Å›rodowisko uruchomieniowe Node.js (w wersji 10).Aplikacja ÅºrÃ³dÅ‚owa skÅ‚ada siÄ™ z kilku klas Javy, z ktÃ³rych najwaÅ¼niejszÄ… jest klasa DataService:public class DataService {    private final RabbitService rabbitService;    private final MongoService mongoService;    Data saveInQueue(Data data) {        log.info(&quot;&amp;gt; saveInQueue [data={}]&quot;, data);        data.setId(UUID.randomUUID().toString());        data.setTimestamp(LocalDateTime.now());        rabbitService.send(data);        log.info(&quot;&amp;lt; saveInQueue [data={}]&quot;, data);        return data;    }    Data findByUuid(String uuid) {        log.info(&quot;&amp;gt; findByUuid [uuid={}]&quot;, uuid);        Data data = mongoService.findByUuid(uuid);        log.info(&quot;&amp;lt; findByUuid [data={}]&quot;, data);        return data;    }    List&amp;lt;Data&amp;gt; findAll() {        log.info(&quot;&amp;gt; findAll&quot;);        List&amp;lt;Data&amp;gt; data = mongoService.findAll();        log.info(&quot;&amp;lt; findAll [data={}]&quot;, data);        return data;    }    void deleteAll() {        log.info(&quot;&amp;gt; deleteAll&quot;);        mongoService.deleteAll();        log.info(&quot;&amp;lt; deleteAll&quot;);    }}SkÅ‚ada siÄ™ ona z metody saveInQueue, ktÃ³ra zapisuje dane przesÅ‚ane przez aplikacjÄ™ frontendowÄ… do kolejki RabbitMQ, za pomocÄ… serwisu RabbitService oraz metod odczytujÄ…cych dane z bazy MongoDB (metody findByUuid oraz findAll) za pomocÄ… serwisu MongoService. OprÃ³cz tego, zawiera ona metodÄ™ deleteAll, ktÃ³ra usuwa wszystkie dane zapisane w bazie.Implementacja serwisu RabbitService wyglÄ…da nastÄ™pujÄ…co:public class RabbitService {    private final RabbitTemplate rabbitTemplate;    private final MongoService mongoService;    @RabbitListener(queues = RabbitConfig.QUEUE_NAME)    void listen(Data data) {        log.info(&quot;Received data from queue [queue={}, data={}]&quot;, RabbitConfig.QUEUE_NAME, data);        mongoService.saveInDatabase(data);    }    void send(Data data) {        log.info(&quot;Send data to queue [queue={}, data={}]&quot;, RabbitConfig.QUEUE_NAME, data);        rabbitTemplate.convertAndSend(RabbitConfig.QUEUE_NAME, data);    }}SkÅ‚ada siÄ™ ona z metody send, z ktÃ³rej korzysta serwis DataService. Zapisuje ona dane w kolejce RabbitMQ za pomocÄ… klasy RabbitTemplate, ktÃ³ra jest czÄ™Å›ciÄ… biblioteki spring-boot-starter-amqp. Druga metoda (listen), odpowiada za pobieranie wiadomoÅ›ci pojawiajÄ…cych siÄ™ w kolejce i zapisywanie ich w bazie danych za pomocÄ… serwisu MongoService.Serwis MongoService wyglÄ…da nastÄ™pujÄ…co:public class MongoService {    private final MongoOperations mongoOperations;    void saveInDatabase(Data data) {        try {            mongoOperations.insert(data);            log.info(&quot;Saved data in database&quot;);        } catch (DuplicateKeyException ignore) {            log.warn(&quot;Duplicated data from queue ignored&quot;);        } catch (Exception e) {            log.error(&quot;Error saving data in database&quot;, e);            throw e;        }    }    Data findByUuid(String uuid) {        return mongoOperations.findById(uuid, Data.class);    }    List&amp;lt;Data&amp;gt; findAll() {        return mongoOperations.findAll(Data.class);    }    void deleteAll() {        mongoOperations.dropCollection(Data.class);    }}Wykorzystuje on klasÄ™ MongoOperations do komunikacji z bazÄ… danych MongoDB, za pomocÄ… odpowiedniego sterownika. Klasa ta jest czÄ™Å›ciÄ… biblioteki spring-boot-starter-data-mongodb. Implementacja serwisu skÅ‚ada siÄ™ z 4 metod, odpowiedzialnych za zapis danych w bazie (saveInDatabase), odczyt (findByUuid oraz findAll) oraz usuniÄ™cie wszystkich danych (deleteAll).W celu komunikacji aplikacji backendowej z aplikacjÄ… frontendowÄ… za pomocÄ… REST API, zaimplementowany zostaÅ‚ kontroler DataController, wystawiajÄ…cy metody serwisu DataService jako endpointy REST API. Jego implementacja wyglÄ…da nastÄ™pujÄ…co:@RestController@RequestMapping(&quot;/api&quot;)@RequiredArgsConstructorpublic class DataController {    private final DataService dataService;    @PostMapping    public ResponseEntity&amp;lt;Data&amp;gt; save(@RequestBody @Valid Data data) {        log.debug(&quot;&amp;gt; save [data={}]&quot;, data);        Data savedData = dataService.saveInQueue(data);        log.debug(&quot;&amp;lt; save [savedData={}]&quot;, savedData);        return ResponseEntity.status(HttpStatus.ACCEPTED).body(savedData);    }    @GetMapping(&quot;/{uuid}&quot;)    public ResponseEntity&amp;lt;Data&amp;gt; getById(@PathVariable String uuid) {        log.debug(&quot;&amp;gt; getById [uuid={}]&quot;, uuid);        Data dataFromDb = dataService.findByUuid(uuid);        log.debug(&quot;&amp;lt; getById [dataFromDb={}]&quot;, dataFromDb);        if (dataFromDb == null) {            return ResponseEntity.notFound().build();        }        return ResponseEntity.ok(dataFromDb);    }    @GetMapping    public ResponseEntity&amp;lt;List&amp;lt;Data&amp;gt;&amp;gt; getAll() {        log.debug(&quot;&amp;gt; getAll&quot;);        List&amp;lt;Data&amp;gt; dataFromDb = dataService.findAll();        log.debug(&quot;&amp;lt; getAll [resultSize={}]&quot;, dataFromDb.size());        if (dataFromDb.isEmpty()) {            return ResponseEntity.notFound().build();        }        return ResponseEntity.ok(dataFromDb);    }    @DeleteMapping    @ResponseStatus(code = HttpStatus.ACCEPTED)    public void deleteAll() {        log.debug(&quot;&amp;gt; deleteAll&quot;);        dataService.deleteAll();        log.debug(&quot;&amp;lt; deleteAll&quot;);    }    @ResponseStatus(HttpStatus.BAD_REQUEST)    @ExceptionHandler(MethodArgumentNotValidException.class)    public Map&amp;lt;String, String&amp;gt; handleValidationExceptions(            MethodArgumentNotValidException ex) {        Map&amp;lt;String, String&amp;gt; errors = new HashMap&amp;lt;&amp;gt;();        ex.getBindingResult().getAllErrors().forEach(error -&amp;gt; {            String fieldName = ((FieldError) error).getField();            String errorMessage = error.getDefaultMessage();            errors.put(fieldName, errorMessage);        });        return errors;    }}OprÃ³cz wystawienia metod serwisu DataService jako endpointy REST API, kontroler obsÅ‚uguje rÃ³wnieÅ¼ bÅ‚Ä™dy (np. wynikajÄ…ce z niepoprawnego wywoÅ‚ania lub niepoprawnego modelu przekazywanych danych do zapisu) za pomocÄ… metody handleValidationExceptions.OprÃ³cz wyÅ¼ej wymienionych klas, aplikacja backendowa skÅ‚ada siÄ™ dodatkowo z konfiguracji kolejki RabbitMQ (klasa RabbitConfig - 24 linie kodu), konfiguracji CORS (klasa WebConfig - 19 linii kodu), modelu danych (klasa Data - 26 linii kodu) oraz gÅ‚Ã³wnej klasy BackendApplication, odpowiedzialnej za uruchomienie aplikacji (12 linii kodu). CaÅ‚a aplikacja skÅ‚ada siÄ™ z 8 klas Javy oraz pliku konfiguracyjnego application.yml.Implementacja funkcji, zastÄ™pujÄ…ca aplikacjÄ™ backendowÄ… wyglÄ…da nastÄ™pujÄ…co:const Firestore = require(&#39;@google-cloud/firestore&#39;);const firestore = new Firestore({    projectId: process.env.GCP_PROJECT});exports.main = (event, context) =&amp;gt; {    const message = JSON.parse(Buffer.from(event.data, &#39;base64&#39;).toString());    console.log(`Save Pub/Sub message in db [data=${JSON.stringify(message)}, context=${JSON.stringify(context)}]`);    const document = firestore.collection(process.env.COLLECTION_NAME).doc(message.uuid);    document.set({        uuid: message.uuid,        manufacturer: message.manufacturer,        model: message.model    }).then(doc =&amp;gt; {        console.log(`Data saved [doc=${JSON.stringify(doc)}]`);    }).catch(err =&amp;gt; {        console.error(err);        throw new Error(`Error saving data...`);    });};SkÅ‚ada siÄ™ ona z jednej funkcji main, ktÃ³rej zadaniem jest zdekodowanie wiadomoÅ›ci z usÅ‚ugi Cloud Pub/Sub z formatu Base64 oraz zapisanie danych w usÅ‚udze Cloud Firestore.Funkcja wykorzystuje do komunikacji z usÅ‚ugÄ… Cloud Firestore bibliotekÄ™ @google-cloud/firestore, a samo wywoÅ‚anie funkcji wyzwalane jest przez usÅ‚ugÄ™ Cloud Pub/Sub, w momencie pojawienia siÄ™ wiadomoÅ›ci w odpowiednim topicu.IloÅ›Ä‡ kodu zostaÅ‚a drastycznie zmniejszona. Aplikacja backendowa zostaÅ‚a caÅ‚kowicie zastÄ…piona przez funkcjÄ™, skÅ‚adajÄ…cÄ… siÄ™ z 21 linii kodu JavaScript. DziÄ™ki migracji z wykorzystaniem strategii â€œRip and replaceâ€, udaÅ‚o siÄ™ znaczÄ…co uproÅ›ciÄ‡ architekturÄ™ i zredukowaÄ‡ tzw. boilerplate code, ktÃ³ry czÄ™sto wystÄ™puje w aplikacjach napisanych w jÄ™zyku Java.FunkcjÄ™ moÅ¼emy wdroÅ¼yÄ‡ z poziomu GUI (Cloud Console), lub za pomocÄ… polecenia:gcloud functions deploy demo-function \\    --entry-point main \\    --runtime nodejs10 \\    --trigger-topic demo-topic \\    --region europe-west3 \\    --timeout 10 \\    --memory 128MB \\    --max-instances 1 \\    --set-env-vars COLLECTION_NAME=demo-collection \\    --project PROJECT_IDNiezaleÅ¼nie od sposobu wdraÅ¼ania, musimy odpowiednio skonfigurowaÄ‡ funkcjÄ™:  entry-point - nazwa metody (w jÄ™zyku JavaScript zwanej funkcjÄ…), ktÃ³ra jest wywoÅ‚ywana przy triggerowaniu funkcji;  runtime - Å›rodowisko uruchomieniowe;  trigger-topic - topic w Cloud Pub/Sub, w ktÃ³rym pojawienie siÄ™ wiadomoÅ›ci triggeruje wywoÅ‚anie funkcji;  region - region, w ktÃ³ry funkcja fizycznie bÄ™dzie uruchamiana;  timeout - maksymalny czas wykonywania funkcji, po przekroczeniu ktÃ³rego funkcja jest automatycznie zakaÅ„czana bÅ‚Ä™dem;  memory - rozmiar pamiÄ™ci, jaka bÄ™dzie przydzielona funkcji w trakcie wywoÅ‚ania;  max-instances - maksymalna liczba instancji, ktÃ³re mogÄ… zostaÄ‡ utworzone (automatyczne skalowanie);  set-env-vars - zmienne Å›rodowiskowe, ktÃ³re bÄ™dÄ… wykorzystane w funkcji, w naszym wypadku jest to nazwa kolejki w Cloud Firestore, do ktÃ³rej bÄ™dÄ… zapisywane dane;  project - id projektu.Dodatkowo moglibyÅ›my skonfigurowaÄ‡ ponawianie przetwarzania wiadomoÅ›ci, w przypadku bÅ‚Ä™du wywoÅ‚ania funkcji, ale nie bÄ™dziemy tego robiÄ‡.Baza danychKonfiguracja Cloud Firestore jest jeszcze Å‚atwiejsza, niÅ¼ konfiguracja Cloud Pub/Sub, poniewaÅ¼ nie wymaga absolutnie Å¼adnych czynnoÅ›ci do jej uruchomienia.Dane zapisywane i odczytywane sÄ… poprzez REST API, wskazujÄ…c w adresie url identyfikator projektu, domyÅ›lnÄ… bazÄ™ danych oraz strukturÄ™ w ktÃ³rej dane majÄ… byÄ‡ utrwalone. Zapis danych nie wymaga istnienia struktury, poniewaÅ¼ zostanie ona utworzona przy pierwszym zapisie.Adres url do zapisu oraz odczytu (environment.firestoreUrl) danych do kolekcji o nazwie demo-collection wyglÄ…da nastÄ™pujÄ…co:https://firestore.googleapis.com/v1/projects/PROJECT_ID/databases/(default)/documents/demo-collectionZamiana bazy danych MongoDB, z ktÃ³rÄ… komunikacja odbywaÅ‚a siÄ™ poprzez sterownik bazodanowy w aplikacji backendowej, na usÅ‚ugÄ™ Cloud Firestore, niesie ze sobÄ… pewne ograniczenia. WynikajÄ… one z interfejsu REST API, ktÃ³ry udostÄ™pnia usÅ‚uga, przez co pewne operacje mogÄ… byÄ‡ niemoÅ¼liwe.W przypadku bazy MongoDB, moÅ¼na byÅ‚o wykonaÄ‡ dowolne zapytanie, na przykÅ‚ad usuwajÄ…ce wszystkie dane z bazy (w przykÅ‚adzie wykorzystaÅ‚em wysokopoziomowy interfejs MongoOperations, ale moÅ¼na rÃ³wnieÅ¼ wywoÅ‚aÄ‡ dowolne polecenie na bazie danych):void deleteAll() {    mongoOperations.dropCollection(Data.class);}WedÅ‚ug dokumentacji REST API usÅ‚ugi Cloud Firestore, nie ma moÅ¼liwoÅ›ci usuniÄ™cia wszystkich danych jednym Å¼Ä…daniem HTTP. Aby usunÄ…Ä‡ wszystkie dane z poziomu aplikacji, naleÅ¼aÅ‚oby najpierw pobraÄ‡ ich identyfikatory, a nastÄ™pnie usuwaÄ‡ je pojedynczo lub w paczkach, co byÅ‚oby maÅ‚o wydajne. ZakÅ‚adamy jednak, Å¼e usuwanie wszystkich danych przez aplikacjÄ™, jest raczej maÅ‚o realnym przypadkiem uÅ¼ycia, dlatego nie bÄ™dziemy implementowaÄ‡ takiej operacji. ChciaÅ‚em jedynie na jej przykÅ‚adzie przedstawiÄ‡ problemy, na jakie moÅ¼emy trafiÄ‡ w przypadku usÅ‚ug SaaS i ich interfejsÃ³w.GdybyÅ›my chcieli jednak zaimplementowaÄ‡ takÄ… operacjÄ™, moglibyÅ›my na przykÅ‚ad utworzyÄ‡ dodatkowÄ… funkcjÄ™, ktÃ³ra przyjmowaÅ‚aby polecenie z aplikacji frontendowej, a nastÄ™pnie pobieraÅ‚a dokumenty w paczkach z Cloud Firestore i usuwaÅ‚a je. Taka operacja powinna byÄ‡ wykonywana asynchronicznie i w sposÃ³b umoÅ¼liwiajÄ…cy ponawianie, poniewaÅ¼ w przypadku duÅ¼ej iloÅ›ci danych, proces ten moÅ¼e byÄ‡ czasochÅ‚onny.UprawnieniaAby umoÅ¼liwiÄ‡ komunikacjÄ™ z usÅ‚ugami (zapis danych do usÅ‚ugi Cloud Pub/Sub oraz odczyt z usÅ‚ugi Cloud Firestore), naleÅ¼y skonfigurowaÄ‡ uprawnienie dla uÅ¼ytkownika w usÅ‚udze Cloud IAM. Komunikacja z usÅ‚ugami odbywa siÄ™ bezpoÅ›rednio z aplikacji frontendowej, dlatego do uwierzytelnienia wykorzystywane jest konto zalogowanego uÅ¼ytkownika. W przypadku, kiedy operacje te byÅ‚yby wykonywane przez innÄ… usÅ‚ugÄ™ GCP, np. Compute Engine, to musielibyÅ›my utworzyÄ‡ odpowiednie konto serwisowe (service account) i nadaÄ‡ mu odpowiednie uprawnienia. Konta serwisowe sÄ… wykorzystywane przez usÅ‚ugi GCP, w celu uwierzytelniania przed innymi usÅ‚ugami.W celach demonstracyjnych, moÅ¼emy wykorzystaÄ‡ nasze konto, ktÃ³re posiada uprawnienie wÅ‚aÅ›ciciela projektu. GdybyÅ›my chcieli umoÅ¼liwiÄ‡ korzystanie z systemu innym uÅ¼ytkownikom, powinniÅ›my utworzyÄ‡ odpowiedniÄ… rolÄ™, posiadajÄ…cÄ… wymagane uprawnienia oraz nadaÄ‡ tÄ™ rolÄ™ kaÅ¼demu uÅ¼ytkownikowi. Jest wiele sposobÃ³w na zarzÄ…dzanie uÅ¼ytkownikami w Google Cloud. MoÅ¼na zaimportowaÄ‡ ich z pliku CSV, utworzyÄ‡ rÄ™cznie, wykorzystaÄ‡ rozwiÄ…zania zewnÄ™trzne takie jak Okta czy Ping lub skorzystaÄ‡ z zalecanego rozwiÄ…zania, czyli narzÄ™dzia Google Cloud Directory Sync.OptymalizacjaEtap optymalizacji polega na monitorowaniu aplikacji w poszukiwaniu bÅ‚Ä™dÃ³w, optymalizacji wydajnoÅ›ci oraz wykonywaniu zmian, na ktÃ³re nie byÅ‚o czasu lub budÅ¼etu przed wdroÅ¼eniem.Poprawa bÅ‚Ä™dÃ³wMonitorowanie logÃ³w aplikacji w usÅ‚udze Cloud Monitoring pozwoliÅ‚o na wykrycie bÅ‚Ä™du w kodzie funkcji.Podczas jednego z zapisÃ³w, w logach zabrakÅ‚o informacji o pomyÅ›lnym zapisaniu danych w Cloud Firestore, nie byÅ‚o rÃ³wnieÅ¼ Å¼adnego bÅ‚Ä™du. W efekcie, po wykonaniu trzech zapisÃ³w, utrwalone zostaÅ‚y jedynie dane z dwÃ³ch ostatnich:2020-08-12T18:29:51 g8xx0fyvsqhl Function execution started2020-08-12T18:29:51 g8xx0fyvsqhl Save Pub/Sub message in db2020-08-12T18:29:51 g8xx0fyvsqhl Function execution took 217 ms, finished with status: &#39;ok&#39;2020-08-12T18:50:15 2kcnvesdjzpp Function execution started2020-08-12T18:50:16 2kcnvesdjzpp Save Pub/Sub message in db2020-08-12T18:50:16 2kcnvesdjzpp Function execution took 413 ms, finished with status: &#39;ok&#39;2020-08-12T18:51:18 2kcnvesdjzpp Data saved2020-08-12T18:52:59 2kcnvlflowql Function execution started2020-08-12T18:52:59 2kcnvlflowql Save Pub/Sub message in db2020-08-12T18:52:59 2kcnvlflowql Function execution took 19 ms, finished with status: &#39;ok&#39;2020-08-12T18:53:00 2kcnvlflowql Data savedJak widaÄ‡ w powyÅ¼szym logu, w pierwszym z trzech wywoÅ‚aÅ„ funkcji, brakuje informacji Data saved. Fakt, Å¼e informacja ta jest w pozostaÅ‚ych przypadkach logowana po informacji o zakoÅ„czeniu wywoÅ‚ania funkcji sugeruje, Å¼e zapis do Cloud Firestore jest wykonywany asynchronicznie, czyli moÅ¼e trwaÄ‡ dÅ‚uÅ¼ej niÅ¼ czas wykonywania samej funkcji. PrzeglÄ…dajÄ…c kod funkcji, szybko udaje siÄ™ znaleÅºÄ‡ bÅ‚Ä…d, w postaci brakujÄ…cego sÅ‚owa kluczowego return, dziÄ™ki ktÃ³remu funkcja bÄ™dzie czekaÅ‚a na zakoÅ„czenie siÄ™ wywoÅ‚ania asynchronicznej metody document.set:exports.main = (event, context) =&amp;gt; {    const message = JSON.parse(Buffer.from(event.data, &#39;base64&#39;).toString());    console.log(`Save Pub/Sub message in db [data=${JSON.stringify(message)}, context=${JSON.stringify(context)}]`);    const document = firestore.collection(process.env.COLLECTION_NAME).doc(message.uuid);    return document.set({        uuid: message.uuid,        manufacturer: message.manufacturer,        model: message.model    }).then(doc =&amp;gt; {        console.log(`Data saved [doc=${JSON.stringify(doc)}]`);    }).catch(err =&amp;gt; {        console.error(err);        throw new Error(`Error saving data...`);    });};UsprawnieniaNa etapie optymalizacji moÅ¼na rÃ³wnieÅ¼ wykonywaÄ‡ zmiany, ktÃ³re sÄ… wynikiem dalszego zdobywania wiedzy po wdroÅ¼eniu lub pojawiania siÄ™ nowych moÅ¼liwoÅ›ci w Google Cloud. Jednym z nich jest na przykÅ‚ad moÅ¼liwoÅ›Ä‡ utworzenia konfiguracji strony www w Cloud Storage.W dokumentacji usÅ‚ugi Cloud Storage znajduje siÄ™ informacja o tym, Å¼e w przypadku nadania bucketowi nazwy, bÄ™dÄ…cej poprawnym adresem URL, pojawi siÄ™ dodatkowa opcja konfiguracji dla witryny internetowej. DziÄ™ki temu, moÅ¼na skonfigurowaÄ‡ plik, ktÃ³ry ma byÄ‡ udostÄ™pniany uÅ¼ytkownikowi po wejÅ›ciu na adres www.Aby nadaÄ‡ bucketowi nazwÄ™ domeny, naleÅ¼y wczeÅ›niej wykonaÄ‡ weryfikacjÄ™ wÅ‚asnoÅ›ci domeny (pod tym adresem). KonfigurujÄ…c w ten sposÃ³b bucket, nie potrzebujemy HTTP/S Load Balancera do dziaÅ‚ania aplikacji. Nie jest to jednak dobre rozwiÄ…zanie w przypadku Å›rodowiska produkcyjnego, poniewaÅ¼ bez usÅ‚ugi Cloud Load Balancing nie ma moÅ¼liwoÅ›ci skonfigurowania certyfikatu HTTPS, a wykorzystywanie nieszyfrowanego poÅ‚Ä…czenia pomiÄ™dzy uÅ¼ytkownikiem a aplikacjÄ… internetowÄ…, jest zÅ‚Ä… praktykÄ….Dodatkowo, w konfiguracji domeny, zamiast podawaÄ‡ adres IP w rekordzie typu A, naleÅ¼y podaÄ‡ adres c.storage.googleapis.com, w rekordzie typu CNAME.WiÄ™cej informacji znajdziemy tutaj: Hosting a static website, Static website examples and tips.AutomatyzacjaInnym elementem etapu optymalizacji mogÄ… byÄ‡ na przykÅ‚ad usprawnienia w procesie wdraÅ¼ania aplikacji. StwÃ³rzmy zatem proste CI/CD, wykorzystujÄ…c do tego celu repozytorium GitHub, usÅ‚ugÄ™ Cloud Build oraz infrastrukturÄ™ jako kod (IaC), opartÄ… o Terraform. Jako alternatywÄ™ dla Terraform moglibyÅ›my wykorzystaÄ‡ Cloud Deployment Manager, ale wtedy uzaleÅ¼nilibyÅ›my siÄ™ od chmury Google (vendor lock).Przed implementacjÄ…, musimy jeszcze:  utworzyÄ‡ bucket w usÅ‚udze Cloud Storage, ktÃ³ry przechowywaÄ‡ bÄ™dzie stan infrastruktury, wykorzystywany przez Terraform:  poÅ‚Ä…czyÄ‡ repozytorium GitHub, zawierajÄ…ce kody aplikacji, z usÅ‚ugÄ… Cloud Build. W celu integracji, w repozytorium GitHub naleÅ¼y zainstalowaÄ‡ aplikacjÄ™ Google Cloud Build, a nastÄ™pnie poÅ‚Ä…czyÄ‡ repozytorium z usÅ‚ugÄ… Cloud Build:  w Cloud IAM przydzieliÄ‡ uprawnienia do konta serwisowego, z ktÃ³rego korzysta Cloud Build: Cloud Build Service Account, Cloud Functions Admin, Cloud Functions Developer, Service Account User, Pub/Sub Editor, Storage Admin:  nadaÄ‡ uprawnienie do zweryfikowanej domeny dla konta serwisowego Cloud Build (pod tym adresem):Konfiguracja automatyzujÄ…ca tworzenie infrastruktury oraz wdraÅ¼anie aplikacji skÅ‚ada siÄ™ z dwÃ³ch czÄ™Å›ci:  konfiguracji Terraform, definiujÄ…cej infrastrukturÄ™, np. trigger w Cloud Build, ktÃ³ry na podstawie zmian kodu w repozytorium uruchamia zadanie;  konfiguracji Cloud Build, czyli definicji zadaÅ„ do wykonania, ktÃ³re sÄ… uruchamiane przez triggery utworzone przez Terraform.Konfiguracja TerraformKonfiguracja Terraform jest umieszczona w folderze infrastructure i skÅ‚ada siÄ™ z:  konfiguracji tzw. backendu, ktÃ³ry w Terraform jest abstrakcjÄ…, okreÅ›lajÄ…cÄ… m.in. w jaki sposÃ³b Å‚adowany jest stan infrastruktury (infrastructure/backend.tf):terraform {  backend &quot;gcs&quot; {    bucket = &quot;demo-infrastructure&quot;    prefix = &quot;terraform/state&quot;  }}W drugiej linii definiujemy typ backendu, w tym przypadku gcs, ktÃ³ry przechowuje stan w usÅ‚udze Cloud Storage. NastÄ™pnie definiujemy nazwÄ™ utworzonego wczeÅ›niej bucketu, w ktÃ³rym bÄ™dzie przechowywany stan, oraz prefix, bÄ™dÄ…cy Å›cieÅ¼kÄ… folderÃ³w, w ktÃ³rych stan bÄ™dzie siÄ™ znajdowaÅ‚,  konfiguracji providera (infrastructure/main.tf):provider &quot;google-beta&quot; {  project = var.gcp-project  region = var.gcp-region  zone = var.gcp-zone}Terraform udostÄ™pnia dwÃ³ch dostawcÃ³w dla Google Cloud: google, google-beta. W pierwszej linii definiujemy dostawcÄ™ google-beta, ktÃ³ry umoÅ¼liwia wykorzystywanie API, ktÃ³re w GCP jest w wersji beta. W kolejnych liniach definiujemy projekt, region oraz strefÄ™, ktÃ³re w tym przypadku sÄ… pobierane ze zmiennych,      definicji zmiennych, wykorzystywanych przez konfiguracjÄ™ Terraform (infrastructure/variables.tf i infrastructure/terraform.tfvars) (niektÃ³re ze zmiennych sÄ… rÃ³wnieÅ¼ przekazywane przez Terraform do Cloud Build);        konfiguracji triggera Cloud Build, ktÃ³ry na podstawie zmian kodÃ³w konfiguracji infrastruktury w repozytorium (folder infrastructure), uruchamia zdefiniowane zadanie w Cloud Build:  resource &quot;google_cloudbuild_trigger&quot; &quot;deploy-demo-infrastructure&quot; {  provider = google-beta  name = &quot;deploy-demo-infrastructure&quot;  description = &quot;[demo] Deploy main: infrastructure&quot;  filename = &quot;infrastructure/build/deploy.cloudbuild.yaml&quot;  included_files = [    &quot;infrastructure/**&quot;  ]  github {    owner = var.github-owner    name = var.github-repository    push {      branch = &quot;^main$&quot;    }  }}W pierwszej linii okreÅ›lamy rodzaj tworzonego zasobu (google_cloudbuild_trigger - trigger w usÅ‚udze Cloud Build). W kolejnych liniach definiujemy providera, nazwÄ™ triggera, jego opis, Å›cieÅ¼kÄ™ pod ktÃ³rÄ… znajduje siÄ™ definicja zadaÅ„ do wykonania przez Cloud Build, Å›cieÅ¼kÄ™ w ktÃ³rej zmiana plikÃ³w spowoduje uruchomienie zadania oraz konfiguracjÄ™ repozytorium GitHub. W konfiguracji repozytorium definiujemy jego poÅ‚oÅ¼enie (parametr owner i name) oraz sposÃ³b triggerowania zadania Cloud Build, w tym przypadku jest to wypushowanie zmian kodÃ³w do brancha main (dostÄ™pne sÄ… m.in. opcje triggerowania na push taga lub utworzenie pull requesta w aplikacji GitHub),  konfiguracji tworzÄ…cej buckety w Cloud Storage (infrastructure/frontend-bucket.tf i infrastructure/yarn-cache.storage.tf), ktÃ³re wykorzystywane sÄ… m.in. do przechowywania plikÃ³w statycznych aplikacji frontendowej oraz kopii podrÄ™cznej zaleÅ¼noÅ›ci, wykorzystywanych przez aplikacjÄ™ frontendowÄ… i funkcjÄ™ (w dalszej czÄ™Å›ci wyjaÅ›niÄ™ o co chodzi);  konfiguracji topicu w usÅ‚udze Cloud Pub/Sub (infrastructure/pubsub.tf);  konfiguracji triggerÃ³w w usÅ‚udze Cloud Build, ktÃ³re na podstawie zmian w repozytorium GitHub, uruchamiajÄ… zdefiniowane zadania (o tym teÅ¼ za chwilÄ™).Konfiguracja Cloud BuildDrugÄ… z konfiguracji, jest konfiguracja usÅ‚ugi Cloud Build, czyli definicja wykonania zadaÅ„, potrzebnych do zbudowania i wdroÅ¼enia poszczegÃ³lnych elementÃ³w systemu. Definicja wdraÅ¼ania dla kaÅ¼dego elementu systemu znajduje siÄ™ w folderze zawierajÄ…cym jego kody ÅºrÃ³dÅ‚owe. SkÅ‚ada siÄ™ ona z:  konfiguracji wdraÅ¼ania infrastruktury (infrastructure/build/deploy.cloudbuild.yml):steps:  - name: &#39;hashicorp/terraform:0.12.26&#39;    entrypoint: &#39;sh&#39;    args:      - &#39;-c&#39;      - |        terraform init &amp;amp;&amp;amp; terraform apply -auto-approve    dir: &#39;infrastructure&#39;SkÅ‚ada siÄ™ ona z jednego kroku, ktÃ³ry za pomocÄ… powÅ‚oki systemu Linux (sh), wykonuje w folderze infrastructure nastÄ™pujÄ…ce polecenia: terraform init (inicjalizujÄ…ce Terraform), terraform apply -auto-approve (tworzÄ…ce infrastrukturÄ™ za pomocÄ… konfiguracji Terraform),  konfiguracji budowania i wdraÅ¼ania aplikacji frontendowej (frontend/deploy.cloudbuild.yml);  konfiguracji wdraÅ¼ania funkcji (function/deploy.cloudbuild.yml).Dependency cacheKopia podrÄ™czna zaleÅ¼noÅ›ci, wykorzystywanych przez aplikacjÄ™ frontendowÄ… oraz funkcjÄ™, przechowywana jest w przeznaczonym do tego celu buckecie.Aplikacje JavaScript (a wiÄ™c te oparte o framework Angular, jak i funkcje napisane w czystym JavaScript) wykorzystujÄ… zewnÄ™trzne zaleÅ¼noÅ›ci (biblioteki, moduÅ‚y), ktÃ³re przechowujÄ… w folderze node_modules. Za kaÅ¼dym razem, kiedy aplikacja lub funkcja sÄ… budowane, muszÄ… one pobraÄ‡ wszystkie zaleÅ¼noÅ›ci z ktÃ³rych korzystajÄ…. Bardzo czÄ™sto, zaleÅ¼noÅ›ci liczone sÄ… w dziesiÄ…tkach, a nawet setkach, a pobranie wszystkich za kaÅ¼dym razem, powoduje niepotrzebne wykorzystywanie Å‚Ä…cza internetowego oraz dÅ‚uÅ¼szy czas wykonywania zadania w usÅ‚udze Cloud Build (ktÃ³ra posiada darmowy limit w postaci 120 minut, za ktÃ³re w ciÄ…gu dnia nie trzeba dodatkowo pÅ‚aciÄ‡).ChcÄ…c zoptymalizowaÄ‡ czas budowania i wdraÅ¼ania, a takÅ¼e koszty z tym zwiÄ…zane, utworzone zostaÅ‚y skrypty (w folderze yarn-cache-builder), ktÃ³re przed pobraniem zaleÅ¼noÅ›ci z Internetu, sprawdzajÄ… najpierw, czy nie istnieje juÅ¼ paczka (plik .zip), zawierajÄ…ca te zaleÅ¼noÅ›ci w Cloud Storage. JeÅ›li tak, to zaleÅ¼noÅ›ci te pobierane sÄ… z bucketu i wypakowywane, co zajmuje o wiele mniej czasu, niÅ¼ pobieranie ich ponownie.Kopia podrÄ™czna tworzona jest na podstawie sumy kontrolnej MD5 pliku yarn.lock, ktÃ³ry zawiera listÄ™ wymaganych zaleÅ¼noÅ›ci. JeÅ›li zaleÅ¼noÅ›ci te siÄ™ nie zmieniÅ‚y (np. nie dodano nowych lub nie zmieniono wersji ktÃ³rejÅ› z nich), to moÅ¼na wykorzystaÄ‡ zaleÅ¼noÅ›ci przechowywane w buckecie. JeÅ›li jednak coÅ› siÄ™ zmieniÅ‚o, to zostanÄ… one pobrane z Internetu, a nastÄ™pnie spakowane do archiwum .zip, zawierajÄ…cego w nazwie sumÄ™ kontrolnÄ… i umieszczone w buckecie.Konfiguracja Terraform (infrastructure/yarn-cache.storage.tf) tworzÄ…ca bucket, przeznaczony na kopie podrÄ™czne zaleÅ¼noÅ›ci, wyglÄ…da nastÄ™pujÄ…co:resource &quot;google_storage_bucket&quot; &quot;demo-yarn-cache&quot; {  provider = google-beta  name = var.cache-bucket-name  location = var.gcp-region  lifecycle_rule {    condition {      age = &quot;7&quot;    }    action {      type = &quot;Delete&quot;    }  }}W pierwszej linii okreÅ›lamy rodzaj tworzonego zasobu (google_storage_bucket - bucket w usÅ‚udze Cloud Storage). W kolejnych liniach definiujemy providera, nazwÄ™ tworzonego bucketu, region w ktÃ³rym bÄ™dzie utworzony oraz reguÅ‚Ä™ cyklu Å¼ycia plikÃ³w. ReguÅ‚a definiuje akcjÄ™ usuniÄ™cia plikÃ³w starszych niÅ¼ 7 dni.Skrypt tworzÄ…cy kopiÄ™ podrÄ™cznÄ… zaleÅ¼noÅ›ci (yarn-cache-builder/yarn-cache-push.sh) wyglÄ…da nastÄ™pujÄ…co:lockChecksum=$(md5sum yarn.lock | cut -d&#39; &#39; -f1)cacheArchive=$(basename &quot;$PWD&quot;).node_modules.${lockChecksum}.tar.gzif gsutil -q stat ${1}/&quot;$cacheArchive&quot;; then  echo &quot;cache archive already exists (${cacheArchive})&quot;else  tar -czf &quot;$cacheArchive&quot; node_modules  gsutil -m cp &quot;$cacheArchive&quot; ${1}/fiW pierwszej linii tworzy on sumÄ™ kontrolnÄ… MD5 pliku yarn.lock. W drugiej definiuje nazwÄ™ archiwum .zip, zawierajÄ…cÄ… sumÄ™ kontrolnÄ…. W kolejnych liniach definiuje warunek sprawdzajÄ…cy, czy plik o takiej nazwie juÅ¼ istnieje (co sugeruje brak potrzeby odkÅ‚adania do bucketu kopii podrÄ™cznej zasobÃ³w), w przeciwnym wypadku tworzÄ…c archiwum zawierajÄ…ce folder node_modules i umieszczajÄ…c je w buckecie. Do komunikacji z usÅ‚ugÄ… Cloud Storage wykorzystywane jest narzÄ™dzie gsutil, a nazwa bucketu przekazywana jest do skryptu w parametrze ${1}.Skrypt pobierajÄ…cy kopiÄ™ podrÄ™cznÄ… zaleÅ¼noÅ›ci (yarn-cache-builder/yarn-cache-push.sh) wyglÄ…da nastÄ™pujÄ…co:lockChecksum=$(md5sum yarn.lock | cut -d&#39; &#39; -f1)cacheArchive=$(basename &quot;$PWD&quot;).node_modules.${lockChecksum}.tar.gzif gsutil -q stat ${1}/&quot;$cacheArchive&quot;; then  gsutil -m cp ${1}/&quot;$cacheArchive&quot; .  tar -xzf &quot;$cacheArchive&quot;fiPierwsze dwie linie sÄ… identyczne, jak w skrypcie tworzÄ…cym. W kolejnych liniach zdefiniowany jest warunek, sprawdzajÄ…cy czy plik o odpowiedniej nazwie istnieje. W przypadku istnienia pliku z odpowiedniÄ… sumÄ… kontrolnÄ…, archiwum .zip pobierane jest za pomocÄ… narzÄ™dzia gsutil, a nastÄ™pnie wypakowywane. DziÄ™ki temu, zaleÅ¼noÅ›ci w trakcie budowania aplikacji, bÄ™dÄ… juÅ¼ istnieÄ‡ w folderze node_modules i nie bÄ™dÄ… pobierane z Internetu.Konfiguracja frontenduKonfiguracja aplikacji frontendowej skÅ‚ada siÄ™ z:  konfiguracji Terraform (infrastructure/frontend.deploy.tf):resource &quot;google_cloudbuild_trigger&quot; &quot;deploy-main-demo-frontend&quot; {  provider = google-beta  name = &quot;deploy-main-demo-frontend&quot;  description = &quot;[demo] Deploy main: frontend&quot;  filename = &quot;frontend/deploy.cloudbuild.yaml&quot;  included_files = [    &quot;frontend/**&quot;  ]  github {    owner = var.github-owner    name = var.github-repository    push {      branch = &quot;^main$&quot;    }  }  substitutions = {    _CACHE_BUCKET = &quot;gs://${var.cache-bucket-name}&quot;    _FRONTEND_BUCKET = &quot;gs://${var.frontend-bucket-name}&quot;  }}Konfiguracja Terraform aplikacji frontendowej nie rÃ³Å¼ni siÄ™ za bardzo od konfiguracji infrastruktury, poniewaÅ¼ rÃ³wnieÅ¼ tworzy trigger w usÅ‚udze Cloud Build. RÃ³Å¼nicÄ… jest tutaj inna Å›cieÅ¼ka do definicji zadaÅ„ Cloud Build oraz inna Å›cieÅ¼ka do folderu, w ktÃ³rym zmiany wyzwolÄ… uruchomienie zadania, a takÅ¼e przekazanie zmiennych do konfiguracji Cloud Build,  konfiguracji Cloud Build (frontend/deploy.cloudbuild.yaml):steps:  - id: fetch-dependencies-cache    name: gcr.io/cloud-builders/gsutil    entrypoint: bash    args: [&#39;../yarn-cache-builder/yarn-cache-fetch.sh&#39;, &#39;${_CACHE_BUCKET}&#39;]    dir: &#39;frontend&#39;  - id: yarn-install    name: node:12.13.1    entrypoint: yarn    args: [&#39;install&#39;]    dir: &#39;frontend&#39;  - id: yarn-build    name: node:12.13.1    entrypoint: yarn    args: [&#39;build&#39;]    dir: &#39;frontend&#39;  - id: copy-dist    name: gcr.io/cloud-builders/gsutil    args: [&#39;cp&#39;,&#39;-r&#39;,&#39;frontend/dist/frontend-app/*&#39;, &#39;${_FRONTEND_BUCKET}&#39;]    waitFor:      - yarn-build  - id: push-dependencies-cache    name: gcr.io/cloud-builders/gsutil    entrypoint: bash    args: [&#39;../yarn-cache-builder/yarn-cache-push.sh&#39;, &#39;${_CACHE_BUCKET}&#39;]    dir: &#39;frontend&#39;Konfiguracja Cloud Build skÅ‚ada siÄ™ z kolejnych krokÃ³w, ktÃ³rych wykonanie zbuduje i wdroÅ¼y aplikacjÄ™ frontendowÄ…. W kroku fetch-dependencies-cache pobierana jest kopia podrÄ™czna zaleÅ¼noÅ›ci (jeÅ›li taka istnieje), nastÄ™pnie wykonywane sÄ… polecenia yarn-install oraz yarn-build, ktÃ³re budujÄ… aplikacjÄ™. Po zbudowaniu aplikacji, pliki statyczne sÄ… kopiowane do bucketa w usÅ‚udze Cloud Storage, a po zakoÅ„czeniu, tworzona jest nowa kopia podrÄ™czna zaleÅ¼noÅ›ci. Wszystkie kroki sÄ… wykonywane w katalogu frontend (parametr dir), a nazwy bucketÃ³w przekazane sÄ… w postaci zmiennych: ${_FRONTEND_BUCKET} (bucket przeznaczony na pliki statyczne), ${_CACHE_BUCKET} (bucket zawierajÄ…cy kopiÄ™ podrÄ™cznÄ… zaleÅ¼noÅ›ci). Do komunikacji z usÅ‚ugÄ… Cloud Storage wykorzystywane jest narzÄ™dzie gsutil,  konfiguracji Terraform, tworzÄ…cej bucket na pliki statyczne (infrastructure/frontend-bucket.tf):resource &quot;google_storage_bucket&quot; &quot;frontend-website-bucket&quot; {  provider = google-beta  name = var.frontend-bucket-name  location = var.gcp-region  force_destroy = true  website {    main_page_suffix = &quot;index.html&quot;  }}resource &quot;google_storage_bucket_iam_member&quot; &quot;frontend-website-bucket-public-permissions&quot; {  bucket = google_storage_bucket.frontend-website-bucket.name  role = &quot;roles/storage.objectViewer&quot;  member = &quot;allUsers&quot;}SkÅ‚ada siÄ™ ona z dwÃ³ch czÄ™Å›ci. W pierwszej tworzony jest bucket w Cloud Storage. Konfiguracja jest podobna do tej, ktÃ³ra tworzy bucket przeznaczony na kopiÄ™ podrÄ™cznÄ… zaleÅ¼noÅ›ci. GÅ‚Ã³wnÄ… rÃ³Å¼nicÄ… jest tutaj parametr force_destroy, ktÃ³ry umoÅ¼liwia usuniÄ™cie bucketu, nawet jeÅ›li zawiera on pliki, a takÅ¼e konfiguracja witryny internetowej (opisana wczeÅ›niej). W drugiej czÄ™Å›ci nadawane sÄ… uprawnienia publiczne do bucketu (rola roles/storage.objectViewer dla allUsers).Konfiguracja funkcjiKonfiguracja funkcji skÅ‚ada siÄ™ z:  konfiguracji Terraform (infrastructure/function.deploy.tf):resource &quot;google_cloudbuild_trigger&quot; &quot;deploy-main-demo-function&quot; {  provider = google-beta  name = &quot;deploy-main-demo-function&quot;  description = &quot;[demo] Deploy main: function&quot;  filename = &quot;function/deploy.cloudbuild.yaml&quot;  included_files = [    &quot;function/**&quot;  ]  github {    owner = var.github-owner    name = var.github-repository    push {      branch = &quot;^main$&quot;    }  }  substitutions = {    _CACHE_BUCKET = &quot;gs://${var.cache-bucket-name}&quot;    _PUBSUB_TOPIC = var.pubsub-topic    _FIRESTORE_COLLECTION = var.firestore-collection    _GCP_REGION = var.gcp-region  }}Konfiguracja Terraform funkcji jest podobna do konfiguracji aplikacji frontendowej. Jedynymi rÃ³Å¼nicami sÄ… inne Å›cieÅ¼ki, a takÅ¼e przekazywane zmienne.  konfiguracji Cloud Build (function/deploy.cloudbuild.yaml):steps:  - id: fetch-dependencies-cache    name: gcr.io/cloud-builders/gsutil    entrypoint: bash    args: [&#39;../yarn-cache-builder/yarn-cache-fetch.sh&#39;, &#39;${_CACHE_BUCKET}&#39;]    dir: &#39;function&#39;  - id: yarn-install    name: node:12.13.1    entrypoint: yarn    args: [&#39;install&#39;]    dir: &#39;function&#39;  - id: deploy-function    name: gcr.io/cloud-builders/gcloud    args: [      &#39;beta&#39;, &#39;functions&#39;, &#39;deploy&#39;, &#39;demo-function&#39;,      &#39;--runtime&#39;, &#39;nodejs10&#39;,      &#39;--trigger-topic&#39;, &#39;${_PUBSUB_TOPIC}&#39;,      &#39;--region&#39;, &#39;${_GCP_REGION}&#39;,      &#39;--timeout&#39;, &#39;10&#39;,      &#39;--memory&#39;, &#39;128MB&#39;,      &#39;--max-instances&#39;, &#39;1&#39;,      &#39;--entry-point&#39;, &#39;main&#39;,      &#39;--set-env-vars&#39;, &#39;COLLECTION_NAME=${_FIRESTORE_COLLECTION}&#39;    ]    dir: &#39;function&#39;  - id: push-dependencies-cache    name: gcr.io/cloud-builders/gsutil    entrypoint: bash    args: [&#39;../yarn-cache-builder/yarn-cache-push.sh&#39;, &#39;${_CACHE_BUCKET}&#39;]    dir: &#39;function&#39;Konfiguracja Cloud Build skÅ‚ada siÄ™ z kolejnych krokÃ³w, ktÃ³rych efektem bÄ™dzie dziaÅ‚ajÄ…ca funkcja, wyzwalana za pomocÄ… Cloud Pub/Sub. Kroki zwiÄ…zane z kopiÄ… podrÄ™cznÄ… zaleÅ¼noÅ›ci sÄ… analogiczne do konfiguracji aplikacji frontendowej. PoniewaÅ¼ funkcja jest napisana w czystym JavaScript, to nie wymaga budowania z TypeSript do JavaScript (jak w przypadku aplikacji frontendowej), dlatego pominiÄ™ty zostaÅ‚ krok wykonujÄ…cy polecenie yarn-build. W linii 7 wykonywane jest jedynie polecenie yarn-install, ktÃ³re pobiera wymagane przez funkcjÄ™ zaleÅ¼noÅ›ci. W kroku deploy-function tworzona jest funkcja na podstawie kodÃ³w ÅºrÃ³dÅ‚owych, zawartych w folderze function. Do konfiguracji zostaÅ‚y przekazane zmienne: ${_PUBSUB_TOPIC} (zawierajÄ…ca nazwÄ™ topicu, ktÃ³ry triggeruje funkcjÄ™), ${_GCP_REGION} (zawierajÄ…ca nazwÄ™ regionu, w ktÃ³rym zostanie uruchomiona funkcja), ${_FIRESTORE_COLLECTION} (zawierajÄ…ca nazwÄ™ kolekcji w Cloud Firestore, w ktÃ³rej funkcja bÄ™dzie utrwalaÄ‡ dane) oraz zmienna zawierajÄ…ca nazwÄ™ bucketu przechowujÄ…cego kopiÄ™ podrÄ™cznÄ… zaleÅ¼noÅ›ci.PoniewaÅ¼ triggery uruchamiajÄ…ce Cloud Build po zmianach konfiguracji infrastruktury (w folderze infrastructure) sÄ… tworzone przez ten sam kod, to za pierwszym razem trzeba utworzyÄ‡ je rÄ™cznie. W tym celu, w folderze infrastructure naleÅ¼y wykonaÄ‡ polecenia:  terraform init - inicjalizuje Terraform, tworzÄ…c folder .terraform zawierajÄ…cy stan i wykorzystywane wtyczki;  terraform plan - wykonuje plan dziaÅ‚ania Terraform, dziÄ™ki czemu moÅ¼na zweryfikowaÄ‡ konfiguracjÄ™ pod kÄ…tem bÅ‚Ä™dÃ³w, jeszcze przed uruchomieniem narzÄ™dzia;  terraform apply - akceptuje zmiany wynikajÄ…ce ze stanu aktualnego oraz wynikajÄ…cego z konfiguracji, czyli wdraÅ¼a infrastrukturÄ™ do chmury. W efekcie tego polecenia, utworzone zostanÄ… wszystkie zasoby (triggery Cloud Build, buckety Cloud Storage, topic Cloud Pub/Sub).Kolejne zmiany kodu infrastruktury bÄ™dÄ… uruchamiaÄ‡ zadanie w Cloud Build, dziÄ™ki czemu zmiany infrastruktury bÄ™dÄ… automatycznie nanoszone w chmurze.Utworzone triggery Cloud Build moÅ¼na rÃ³wnieÅ¼ wyzwoliÄ‡ rÄ™cznie, za pomocÄ… Cloud Console. MoÅ¼na tam znaleÅºÄ‡ historiÄ™ wykonywanych zadaÅ„ oraz logi zawierajÄ…ce ich przebieg.W przedstawionym rozwiÄ…zaniu, kody aplikacji przechowywane sÄ… w repozytorium GitHub i zawierajÄ… wraÅ¼liwe dane (konfiguracjÄ™ w plikach frontend/src/environments/environment.ts oraz infrastructure/terraform.tfvars). JeÅ›li chcemy wykorzystaÄ‡ takie rozwiÄ…zanie, powinniÅ›my utworzyÄ‡ prywatne repozytorium GitHub, w przeciwnym wypadku, nasza konfiguracja wycieknie do sieci. Do przechowywania konfiguracji moÅ¼emy wykorzystaÄ‡ np. usÅ‚ugÄ™ Cloud Secret Manager lub zaimplementowaÄ‡ wÅ‚asne rozwiÄ…zanie, oparte chociaÅ¼by o Cloud Storage.ZaletÄ… IaC, oprÃ³cz automatyzacji tworzenia infrastruktury, jest rÃ³wnieÅ¼ wersjonowanie. KaÅ¼da zmiana infrastruktury wiÄ…Å¼e siÄ™ ze zmianÄ… kodu Terraform i moÅ¼e wymagaÄ‡ np. pull requesta, lub napisania testÃ³w, sprawdzajÄ…cych poprawnoÅ›Ä‡ konfiguracji. DziÄ™ki temu, proces wdraÅ¼ania infrastruktury jest powtarzalny oraz bardziej odporny na bÅ‚Ä™dy, niÅ¼ rÄ™czne tworzenie zasobÃ³w z poziomu GUI, czy konsoli.Migracja do chmury - podsumowanieOpisany przeze mnie proces migracji do chmury Google Cloud Platform, jest jedynie przykÅ‚adem, zawierajÄ…cym minimalnÄ… iloÅ›Ä‡ wiedzy, potrzebnej do rozpoczÄ™cia przygody z chmurÄ… Google. Nie powinniÅ›my podejmowaÄ‡ siÄ™ takiego procesu nie posiadajac wczeÅ›niej wiedzy na temat usÅ‚ug GCP, poniewaÅ¼ w najgorszym wypadku, moÅ¼e siÄ™ to skoÅ„czyÄ‡ bardzo wysokimi rachunkami.Przed rozpoczÄ™ciem zabawy z GCP, proponujÄ™ zapoznaÄ‡ siÄ™ z materiaÅ‚ami od Google, np. w formie kursÃ³w wideo, dostÄ™pnych na platformach Coursera czy Pluralsight. Bardzo duÅ¼o informacji znajdziemy rÃ³wnieÅ¼ w oficjalnej dokumentacji GCP - od specyfikacji i API usÅ‚ug, po gotowe rozwiÄ…zania w formie â€œbest practicesâ€ czy â€œhow toâ€.Warto pamiÄ™taÄ‡ rÃ³wnieÅ¼ o GCP Free Tier, w ramach ktÃ³rego otrzymujemy na start $300, ktÃ³re w poÅ‚Ä…czeniu z darmowymi limitami, w zupeÅ‚noÅ›ci wystarczÄ… do zapoznania siÄ™ z platformÄ…. Kursy wideo zawierajÄ… rÃ³wnieÅ¼ zadania techniczne (Qwiklabs), ktÃ³re wykonujemy na prawdziwej chmurze, wykorzystujÄ…c do tego wygenerowane na potrzeby zadania konta - z tego rÃ³wnieÅ¼ warto skorzystaÄ‡.",
"url": "/2021/03/03/przyklad-migracji-do-chmury.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2021-03-03-przyklad-migracji-do-chmury/clouds.jpeg",
"date": "03-03-2021",
"path": "pl/2021-03-03-przyklad-migracji-do-chmury"
}
,


"2021-02-19-wszystko-co-chcielibyscie-wiedziec-o-fontach-ale-baliscie-sie-zapytac-html": {
"title": "Wszystko, co chcielibyÅ›cie wiedzieÄ‡ o fontach, ale baliÅ›cie siÄ™ zapytaÄ‡",
"lang": "pl",
"tags": "font czcionka rem woff font-face",
"content": "Osoby pracujÄ…ce na frontendzie czÄ™sto majÄ… do czynienia z fontami, czy to wrzucajÄ… je do projektu, czy po prostu zmieniajÄ… sposÃ³b, w jaki tekst wyÅ›wietla siÄ™ na stronie.Na pierwszy rzut oka moÅ¼e siÄ™ wydawaÄ‡, Å¼e to bajecznie proste.Jest jednak kilka waÅ¼nych rzeczy, na ktÃ³re warto zwracaÄ‡ uwagÄ™ i byÄ‡ ich Å›wiadomym.Sposoby okreÅ›lania wielkoÅ›ci fontÃ³w (EM, REM, PX)Zacznijmy od poczÄ…tku. Jak poprawnie zdefiniowaÄ‡ wielkoÅ›Ä‡ fontÃ³w? W wiÄ™kszoÅ›ci przypadkÃ³w wyboru dokonujemy pomiÄ™dzy PX, EM a REM.PrzejdÅºmy do tego pierwszego.Piksele sÄ… wygodne do definiowania, poniewaÅ¼ kaÅ¼dy intuicyjnie rozumie jak one dziaÅ‚ajÄ… i jakÄ… przestrzeÅ„ zajmujÄ… na stronie. Tworzenie animacji, nadawanie ramek czy tworzenie rÃ³Å¼nych innych elementÃ³w graficznych czÄ™sto wydaje nam siÄ™ prostsze w px. Schody zaczynajÄ… siÄ™, kiedy bÄ™dziemy chcieli byÄ‡ przyjaznym dla uÅ¼ytkownika i umoÅ¼liwiÄ‡ mu zmianÄ™ wielkoÅ›ci fontÃ³w w przeglÄ…darce (i chodzi tutaj o ustawienia fontÃ³w w ustawieniach, a nie funkcjonalnoÅ›Ä‡ przybliÅ¼ania i oddalania strony, ona nadal bÄ™dzie dziaÅ‚aÄ‡ poprawnie). UÅ¼ywajÄ…c pikseli nie jesteÅ›my w stanie tego obsÅ‚uÅ¼yÄ‡ i zawsze bÄ™dziemy nadpisywaÄ‡ preferencje uÅ¼ytkownika. A wiÄ™c jak moÅ¼na rozwiÄ…zaÄ‡ ten problem? Z pomocÄ… przychodzÄ… nam jednostki wzglÄ™dne.Takimi jednostkami sÄ… wÅ‚aÅ›nie EM i REM. Nazywamy je wzglÄ™dnymi, poniewaÅ¼ aby dowiedzieÄ‡ siÄ™, jaka jest faktycznie ich wartoÅ›Ä‡, naleÅ¼y spojrzeÄ‡, gdzie dana deklaracja siÄ™ znajduje. W przypadku EM wystÄ™puje dziedziczenie wzglÄ™dem elementu nadrzÄ™dnego, a REM dziedziczy po roocie aplikacji. Przy pracy nad wiÄ™kszymi projektami czÄ™sto faworyzuje siÄ™ REM nad EM ze wzglÄ™du na prostotÄ™ w utrzymaniu. Przy pracy nad tymi jednostkami warto jednak zwrÃ³ciÄ‡ uwagÄ™ na kilka rzeczy.Å»eby wyliczyÄ‡, na ile ustawiÄ‡ wartoÅ›Ä‡ REM, aby odpowiadaÅ‚a konkretnej wartoÅ›ci w pikselach, weÅºmy przykÅ‚ad:font-size domyÅ›lnie mamy 16px, a potrzebujemy nadaÄ‡ pewnemu elementowi wielkoÅ›Ä‡ 10px. MoÅ¼emy skorzystaÄ‡z internetowego kalkulatoraalbo rozwiÄ…zaÄ‡ rÃ³wnanie, ktÃ³renaprowadzi nas na poprawnÄ… wartoÅ›Ä‡: 16px * x= 10px. Nie brzmi zachÄ™cajÄ…co? Warto w takim razie zastanowiÄ‡ siÄ™, czyfaktycznie waÅ¼ne jest, aby byÅ‚o to dokÅ‚adnie 10px, poniewaÅ¼ moÅ¼emy przyjÄ…Ä‡ wartoÅ›Ä‡ 0.6rem, ktÃ³ra moÅ¼e siÄ™ okazaÄ‡dostatecznie bliska. JeÅ¼eli nie godzimy siÄ™ na takie przybliÅ¼anie i musimy trzymaÄ‡ siÄ™ konkretnych wartoÅ›ci,a korzystamy z preprocessora do CSS, warto napisaÄ‡ metodÄ™, ktÃ³ra policzy to za nas, przyjmujÄ…c w parametrze docelowÄ…wartoÅ›Ä‡ w px. Tworzenie zmiennych okreÅ›lajÄ…cych rÃ³Å¼ne wartoÅ›ci REM zawierajÄ…ce w nazwie odniesienie do konkretnych wartoÅ›Ä‡ w PX nie jest dobrÄ…praktykÄ…, poniewaÅ¼ w przypadku zmiany wieloÅ›ci w rootâ€™cie aplikacji wszystkie te zmienne przestajÄ… mieÄ‡ sens.PrzejdÅºmy jednak do wczeÅ›niej przytoczonego problemu z nadpisywaniem preferencji uÅ¼ytkownika dotyczÄ…cych  wielkoÅ›ci fontÃ³w. Tak jak wczeÅ›niej wspomniaÅ‚em, wiÄ™kszoÅ›Ä‡ przeglÄ…darek ma wartoÅ›Ä‡ domyÅ›lnÄ… fontu ustawionÄ… na 16px. JeÅ¼eli nadpisalibyÅ›my jÄ… uÅ¼ywajÄ…c px narzucamy wÅ‚asne style ponad ustawienia uÅ¼ytkownika, ale jeÅ¼eli bÄ™dziemy uÅ¼ywaÄ‡ jednostek wzglÄ™dnych â€“ takiego problemu nie bÄ™dzie. Przyjrzyjmy siÄ™ pewnemu przykÅ‚adowi:Na pierwszy rzut oka wszystko wydaje siÄ™ takie samo, jedynÄ… rÃ³Å¼nicÄ… jest to, Å¼e po prawej stronie zadeklarowaliÅ›my wielkoÅ›Ä‡ fontu,ktÃ³ra jest taka sama jak domyÅ›lna. Po zmianie wielkoÅ›ci fontu w ustawieniach przeglÄ…darki nagle widaÄ‡ rÃ³Å¼nicÄ™:Na koniec jedna uwaga  dotyczÄ…cÄ… uÅ¼ywania pikseli. Na urzÄ…dzeniach przenoÅ›nych piksele sÄ… innej wielkoÅ›ci, niÅ¼ na standardowym monitorze. Mimo iÅ¼ urzÄ…dzenie ma wiÄ™kszÄ… rozdzielczoÅ›Ä‡, przeglÄ…darka traktujÄ… jÄ…, jak gdyby byÅ‚a nawet kilkukrotnie mniejsza. Dzieje siÄ™ tak, poniewaÅ¼ ekran na telefonie mamy maÅ‚y, a zagÄ™szczenie pikseli wysokie. Powoduje to, Å¼e co na ekranie monitora jest czytelne, na ekranie komÃ³rki jest ledwo zauwaÅ¼alne. Na przykÅ‚ad, kiedy wejdziemy w przeglÄ…darce Chrome w opcje developerskie i ustawimy, aby przeglÄ…darka zmieniÅ‚a wielkoÅ›Ä‡ okna i dopasowaÅ‚a siÄ™ do iPhoneâ€™a X, wyÅ›wietli nam siÄ™ rozdzielczoÅ›Ä‡ 375 x 812, gdy realna rozdzielczoÅ›Ä‡ urzÄ…dzenia wynosi 1125 x 2436.WiÄ™c jakie jest rozstrzygniÄ™cie? Czy jesteÅ›my w stanie wybraÄ‡ i pozostaÄ‡ przy tylko jednym sposobie okreÅ›lania wielkoÅ›ci? Nie, wszystko zaleÅ¼y od projektu, w jakim pracujemy, doboru narzÄ™dzi i makiet dostarczonych przez klienta. Racjonalnym wyborem czÄ™sto stajÄ… siÄ™ jednostki wzglÄ™dne, dziÄ™ki Å‚atwiejszym moÅ¼liwoÅ›ciom ich skalowania. W ten sposÃ³b szanujemy rÃ³wnieÅ¼ uÅ¼ytkownika i pozwalamy mu na dostosowywanie fontÃ³w wedÅ‚ug jego potrzeb. Z kolei kiedy wiemy, Å¼e w projekcie bÄ™dzie duÅ¼o elementÃ³w graficznych, zwiÄ…zanych z animacjami, gdzie wielkoÅ›Ä‡, czytelnoÅ›Ä‡ fontÃ³w i moÅ¼liwoÅ›Ä‡ ich powiÄ™kszania schodzi na drugi plan â€“ sensowniejszym wyborem staje siÄ™ uÅ¼ycie px.Warto teÅ¼ byÄ‡ Å›wiadomym, Å¼e Å‚Ä…czenie obu jednostek nie zawsze jest zÅ‚e. Czasami chcemy, aby rÃ³Å¼ne elementy powiÄ™kszaÅ‚y siÄ™ razem z fontem, a czasami zostaÅ‚y staÅ‚e, niezaleÅ¼nie od wielkoÅ›ci elementÃ³w dookoÅ‚a (na przykÅ‚ad wielkoÅ›ci ramek, cieni, czy czasem odstÄ™pÃ³w pomiÄ™dzy elementami, kluczowy jest tutaj kontekst).Rozszerzenia fontÃ³wPrzejdÅºmy teraz do rozszerzeÅ„ plikÃ³w z fontami. Kiedy bÄ™dziemy chcieli uÅ¼yÄ‡ na stronie innych fontÃ³w niÅ¼ domyÅ›lne, bÄ™dziemy musieli wrzuciÄ‡ do projektu plik z definicjÄ… fontu. RozszerzeÅ„ takich plikÃ³w jest sporo i czÄ™sto budzi to konsternacjÄ™: wystarczy pojedynczy plik, czy moÅ¼e po jednym z kaÅ¼dego z rodzaju? Przed odpowiedzeniem na to pytanie przyjrzyjmy siÄ™ popularnym rozszerzeniom:  EOT (Embedded OpenType) â€“ przestarzaÅ‚y juÅ¼ format, obsÅ‚ugiwany tylko i wyÅ‚Ä…cznie przez Internet Explorer. IE w wersji 9+ potrafi juÅ¼ odczytywaÄ‡ inne formaty, wiÄ™c jeÅ¼eli nie zaleÅ¼y nam na starych wersjach IE, to nie musimy siÄ™ martwiÄ‡ tym rozszerzeniem, tym bardziej, Å¼e czÄ™sto fonty o tym rozszerzeniu nie sÄ… kompresowane i zajmujÄ… wiÄ™cej miejsca.  TTF/OFT (TrueType) - fonty o tym rozszerzeniu powinny zawieraÄ‡ w sobie wszystkie moÅ¼liwe gruboÅ›ci i odmiany danego kroju. CzÄ™Å›ciej jest on stosowany w programach graficznych, niÅ¼ do wyÅ›wietlania tekstÃ³w na stronach internetowych. MoÅ¼e okazaÄ‡ siÄ™ przydatny dla starszych przeglÄ…darek, szczegÃ³lnie mobilnych, ale z uwagi na brak kompresji pliki mogÄ… waÅ¼yÄ‡ wiÄ™cej. OFT jest nowszÄ… odmianÄ… standardu, lecz specyfikacjÄ™ ma bardzo podobnÄ…. JeÅ¼eli zaleÅ¼y nam gÅ‚Ã³wnie na aktualnych przeglÄ…darkach moÅ¼emy odpuÅ›ciÄ‡ sobie oba rozszerzenia.  WOFF (Web Open Font Format) â€“ jest to forma TTF, ale z dodanÄ… kompresjÄ… i wiÄ™kszym wsparciem przeglÄ…darek. Aktualnie jest wspierany przez wszystkie przeglÄ…darki i jest domyÅ›lnym wyborem dla uÅ¼ywania zewnÄ™trznych fontÃ³w w projektach.  WOFF2 (Web Open Font Format 2) â€“ jak po nazwie moÅ¼na siÄ™ domyÅ›liÄ‡, jest ulepszonÄ… wersjÄ… WOFF. Oferuje mniejsze wielkoÅ›ci plikÃ³w i lepszÄ… wydajnoÅ›Ä‡. Aktualnie jest wspierany przez wszystkie przeglÄ…darki za wyjÄ…tkiem IE.DodajÄ…c fonty do aplikacji moÅ¼emy ograniczyÄ‡ siÄ™ tylko do WOFF i WOFF2, jeÅ¼eli chcemy wpieraÄ‡ tylko aktualne przeglÄ…darki. OferujÄ… one maÅ‚e rozmiary plikÃ³w, a przeglÄ…darka dobrze sobie radzi z wyÅ›wietlaniem ich na stronie. JeÅ¼eli na urzÄ…dzeniach, na ktÃ³rych aplikacja bÄ™dzie uruchamiana brakuje dla nich wsparcia, warto zostaÄ‡ przy domyÅ›lnych systemowych fontach z uwagi na wydajnoÅ›Ä‡ aplikacji. JeÅ¼eli jednak chcemy rozszerzaÄ‡ wsparcie na tak wiele urzÄ…dzeÅ„, jak to moÅ¼liwe i nie boimy siÄ™ ich wspierania, moÅ¼emy wtedy skorzystaÄ‡ z plikÃ³w EOT i TTF/OTF.DoÅ‚Ä…czanie fontÃ³w do aplikacjiNa koniec przyjrzyjmy siÄ™ sposobom doÅ‚Ä…czania fontÃ³w do projektu. SÄ… rÃ³Å¼ne moÅ¼liwoÅ›ci, a kilka z nich,razem z ich zaletami i wadami, przedstawiam poniÅ¼ej:@Font-faceNajbardziej znany i lubiany sposÃ³b definiowania nowych fontÃ³w, ktÃ³re chcemy uÅ¼yÄ‡ w projekcie. Tworzymy nowy plik i wrzucamy do niego Å›cieÅ¼ki do fontÃ³w (najczÄ™Å›ciej w formacie WOFF i WOFF2). Plik ma strukturÄ™, w ktÃ³rej definiujemy nazwÄ™ i Å›cieÅ¼ki do fontÃ³w:@font-face {  font-family: &#39;NowyFont&#39;;  src: url(&#39;nowyFont.woff2&#39;) format(&#39;woff2&#39;),       url(&#39;nowyFont.woff&#39;) format(&#39;woff&#39;),}Struktura jest czytelna, wiÄ™c moÅ¼emy Å‚atwo jÄ… modyfikowaÄ‡ i dodawaÄ‡ kolejne fonty. Aplikacja nie czeka aÅ¼ fonty zostanÄ… zaÅ‚adowane, wiÄ™c nie musimy siÄ™ martwiÄ‡, Å¼e wydÅ‚uÅ¼amy czas Å‚adowania aplikacji. MoÅ¼e to byÄ‡ porÄ™czne, ale powoduje rÃ³wnieÅ¼ pewne problemy, poniewaÅ¼ przez to mamy czÄ™sto do czynienia z â€˜mrugniÄ™ciem fontuâ€™, czyli z szybkÄ… zmianÄ… wyglÄ…du tekstu. SÄ… rÃ³Å¼ne strategie radzenia sobie z tym przez przeglÄ…darki. NajczÄ™Å›ciej tekst jest na chwilÄ™ niewidzialny i jeÅ¼eli po pewnym czasie font nie zostanie zaÅ‚adowany, tekst siÄ™ wyÅ›wietla, ale z uÅ¼ytym domyÅ›lnym fontem. W momencie kiedy font siÄ™ zaÅ‚aduje, tekst â€˜wskakujeâ€™ we wÅ‚aÅ›ciwy font. Im font wiÄ™cej waÅ¼y i im mamy gorszy transfer tym dÅ‚uÅ¼ej moÅ¼e to potrwaÄ‡. Wszystkie Å¼Ä…dania odbywajÄ… siÄ™ niezaleÅ¼nie, wiÄ™c trudno je razem zgrupowaÄ‡, aby mogÅ‚y zaÅ‚adowaÄ‡ siÄ™ w tym samym momencie.font-displayNa ratunek z pojawiajÄ…cym siÄ™ nagle tekstem przychodzi wÅ‚asnoÅ›Ä‡ font-display: swap, ktÃ³rÄ… moÅ¼emy ustawiÄ‡ w naszym pliku @font-face. DziÄ™ki niemu nie uÅ›wiadczymy juÅ¼ dwÃ³ch mrugniÄ™Ä‡ (pojawienie siÄ™ tekstu i zmiana fontu), a jednego: tekst pojawia siÄ™ od razu i czeka, aÅ¼ font zostanie zaÅ‚adowany. ZaletÄ… tego rozwiania jest prostota w konfiguracji. Minusem jest to, Å¼e tak naprawdÄ™ niewiele nam to jeszcze daje.Wczytywanie fontu przed renderowaniem zawartoÅ›ci stronyInnym sposobem radzenia sobie z Å‚adowaniem fontÃ³w jest doÅ‚Ä…czanie do pliku html linku, wskazujÄ…cego na font, z ktÃ³rego chcemy skorzystaÄ‡:    &amp;lt;link rel=&quot;preload&quot; href=&quot;https://fonts.gstatic.com/s/opensans/v13/k3k702ZOKiLJc3WVjuplzBampu5_7CjHW5spxoeN3Vs.woff2&quot; as=&quot;font&quot; type=&quot;font/woff2&quot; crossorigin&amp;gt;RozwiÄ…zanie jest Å‚atwe w implementacji, jeden link i mamy wszystko czego potrzebujemy. Nie musimy siÄ™ martwiÄ‡, Å¼e teksty na stronie bÄ™dÄ… Åºle wyglÄ…daÄ‡ bez fontÃ³w. RozwiÄ…zanie to moÅ¼e wydawaÄ‡ siÄ™ bardzo dobre, za wyjÄ…tkiem jednej rzeczy. Przez to, Å¼e wczytujemy font wczeÅ›niej, opÃ³Åºniamy wejÅ›cie na stronÄ™. Czas wejÅ›cia na stronÄ™ jest dÅ‚uÅ¼szy, poniewaÅ¼ zaÅ‚adowanie fontu ma wyÅ¼szy priorytet i odbÄ™dzie siÄ™ przed wyÅ›wietleniem aplikacji.Wykrywanie momentu zaÅ‚adowania fontÃ³wInnym rozwiÄ…zaniem, potrafiÄ…cym rozwiÄ…zaÄ‡ problemy, na ktÃ³re moÅ¼emy napotkaÄ‡ podczas â€˜wskakujÄ…cych fontÃ³wâ€™ jest uÅ¼ywanie biblioteki pozwalajÄ…cej wykryÄ‡ moment (lub posÅ‚ugujÄ…c siÄ™ bezpoÅ›rednio CSS Font Loading API), w ktÃ³rym dany font, czy teÅ¼ wszystkie fonty, zostaÅ‚y juÅ¼ zaÅ‚adowane. PrzewaÅ¼nie uÅ¼ywamy tego, aby nadaÄ‡ jakÄ…Å› klasÄ™ na najwyÅ¼szym elemencie struktury html, ktÃ³ra poinformuje, Å¼e font zostaÅ‚ zaÅ‚adowany. BÄ™dzie to sygnaÅ‚, ktÃ³ry pozwoli nam zmieniÄ‡ dynamicznie wyglÄ…d aplikacji. Nie powinno siÄ™ raczej mieszaÄ‡ javascriptu do zarzÄ…dzania css, ale czasami nie ma innego rozwiÄ…zania. SzczegÃ³lnie wtedy, kiedy musimy wiedzieÄ‡, czy font zostaÅ‚ juÅ¼ poprawnie zaÅ‚adowany, aby uzaleÅ¼niÄ‡ od tego okreÅ›lone elementy aplikacji.OczywiÅ›cie istniejÄ… bardziej zaawansowane metody wczytywania fontÃ³w, ktÃ³re w inny sposÃ³b rozwiÄ…zujÄ… problemy migajÄ…cego tekstu (czÄ™sto w sieci nazywane jako FOIT, kiedy mamy do czynienia z pojawiajÄ…cym siÄ™ fontem, lub FOUT, kiedy tekst zmienia nagle swÃ³j styl), lecz w zdecydowanej wiÄ™kszoÅ›Ä‡ przypadkÃ³w wyÅ¼ej wymienione rozwiÄ…zania sÄ… w peÅ‚ni wystarczajÄ…ce. Warto rÃ³wnieÅ¼ zwrÃ³ciÄ‡ uwagÄ™, Å¼e wsparcie fontÃ³w w przeglÄ…darkach dynamicznie siÄ™ zmienia, patrzÄ…c chociaÅ¼by na kolejne wersji najpopularniejszych przeglÄ…darek. Sprawia to, Å¼e warto Å›ledziÄ‡ zmiany, poniewaÅ¼ prÄ™dzej czy pÃ³Åºniej caÅ‚a zawarta tutaj wiedza moÅ¼e siÄ™ zdezaktualizowaÄ‡.â€¦i jeszcze jedna drobna kwestia, stanowiÄ…ca bardziej ciekawostkÄ™. W artykule posÅ‚ugiwaÅ‚em siÄ™ pojÄ™ciem font, unikajÄ…c sÅ‚owa czcionka. PrzyjÄ™Å‚o siÄ™ uÅ¼ywaÄ‡ te sÅ‚owa zamiennie, aczkolwiek, poprawnym sÅ‚owem jest font, moÅ¼na teÅ¼ mÃ³wiÄ‡ czcionka komputerowa. Samo sÅ‚owo czcionka oznacz kawaÅ‚ek metalu z pojedynczÄ… literÄ… sÅ‚uÅ¼Ä…cÄ… do dawnych metod drukarstwa. Jest to jednak maÅ‚o istotne i nie ma to duÅ¼ego znaczenia w komunikacji, a osoby, ktÃ³re nadmiernie zwracajÄ… na to uwagÄ™ moÅ¼na oskarÅ¼yÄ‡ o snobizm :)",
"url": "/2021/02/19/wszystko-co-chcielibyscie-wiedziec-o-fontach-ale-baliscie-sie-zapytac.html",
"author": "Piotr Grobelny",
"authorUrl": "/authors/pgrobelny.html",
"image": "pgrobelny.webp",
"highlight": "/assets/img/posts/2021-02-01-wszystko-co-chcielibyscie-wiedziec-o-fontach-ale-baliscie-sie-zapytac/thumbnail.jpeg",
"date": "19-02-2021",
"path": "pl/2021-02-01-wszystko-co-chcielibyscie-wiedziec-o-fontach-ale-baliscie-sie-zapytac"
}
,


"2021-02-10-odpowiedzi-na-pytania-cd-tech-5-html": {
"title": "Domain Driven Design w oparciu o Axon Framework - odpowiedzi na pytania!",
"lang": "pl",
"tags": "ddd axon consdata tech cdtech#5",
"content": "Zgodnie z obietnicÄ…, przyszedÅ‚ czas odpowiedzieÄ‡ na pytania, ktÃ³re pozostaÅ‚y bez odpowiedzi podczas naszego minionego eventu - Consdata Tech.Nie przedÅ‚uÅ¼ajÄ…c wiÄ™c, przejdÄ™ do czÄ™Å›ci wÅ‚aÅ›ciwej. ;)JeÅ›li replayEvents jest wyÅ‚Ä…czony, to czy framework przy starcie aplikacji potrafi odczytaÄ‡ stan np. Issue z bazy danych i dalej na nim operowaÄ‡?ZacznÄ™ od pytania, przy ktÃ³rym zatrzymam siÄ™ trochÄ™ dÅ‚uÅ¼ej, bo jest tu parÄ™ kwestii do omÃ³wienia.NaleÅ¼aÅ‚oby na samym poczÄ…tku rozrÃ³Å¼niÄ‡ odtwarzanie zdarzeÅ„ na dwie podgrupy:  Odtwarzanie stanu agregatu  Odtwarzanie stanu systemu (replay)Pierwszy typ odtwarzania sÅ‚uÅ¼y do skonstruowania stanu agregatu (na podstawie wszystkich zdarzeÅ„ lub snapshota + delty zdarzeÅ„), w momencie, gdy pojawia siÄ™ nowy command w systemie.Jest to konieczne, aby sprawdziÄ‡ niezmienniki/warunki i w odpowiedzi na command wyemitowaÄ‡ zdarzenie, lub teÅ¼ nie.Na ten mechanizm nie mamy wpÅ‚ywu i nie da siÄ™ go wyÅ‚Ä…czyÄ‡.Drugi typ odtwarzania to wÅ‚aÅ›nie te â€œreplay eventsâ€, ktÃ³rego zapewne tyczy siÄ™ pytanie.Tu juÅ¼ jak najbardziej mamy wiele moÅ¼liwoÅ›ci konfiguracyjnych w Axonie.Wszystko rozbija siÄ™ o Event Processory i skÅ‚adowanie Tracking TokenÃ³w w Token Store.W momencie, gdy odpalimy aplikacjÄ™ na domyÅ›lnej konfiguracji, wszystkie Tokeny trafiajÄ… do InMemoryTokenStore, czyli siÅ‚Ä… rzeczy po restarcie aplikacji przepadajÄ….Ta wiedza pozwoliÅ‚a mi zaprezentowaÄ‡ EventSourcing na ostatniej prelekcji.OczywiÅ›cie domyÅ›lne konfiguracje nie sÄ… zalecane na produkcji, a dokumentacja jawnie mÃ³wi o wymogu dostarczenia implementacji Token Store do konfiguracji.MoÅ¼emy to zrobiÄ‡ samemu lub wykorzystaÄ‡ gotowca, jeÅ›li istnieje (np dla Mongo istnieje taki Token Store).W momencie, gdy dostarczymy takowÄ… implementacjÄ™, wÃ³wczas Tracking Tokeny zacznÄ… trafiaÄ‡ do bazy.Nadal jednak moÅ¼na bÄ™dzie wykonaÄ‡ replay events (np zapiÄ…Ä‡ jakiÅ› endpoint na takÄ… akcjÄ™), o ile nie wyÅ‚Ä…czymy tego caÅ‚kowicie w konfiguracji (opisujÄ™ to w kolejnym akapicie).Czy moÅ¼na wyÅ‚Ä…czyÄ‡ domyÅ›lne zachowanie Axona w kontekÅ›cie odtwarzania eventÃ³w przy starcie aplikacji?Tak, odpowiedziaÅ‚em na to pytanie podczas webinaru, lecz w tej chwili mogÄ™ wrÃ³ciÄ‡ juÅ¼ z konkretnym przykÅ‚adem w kodzie.Podczas transmisji wspominaÅ‚em o tym, Å¼e taka moÅ¼liwoÅ›Ä‡ istnieje i moÅ¼na wrÄ™cz wskazaÄ‡ w konfiguracji Event Processor (czyli obiekt odpowiadajÄ…cy za przetwarzanie zdarzeÅ„), ktÃ³ry ma byÄ‡ ignorowany podczas odtwarzania.Event Processory domyÅ›lnie dostajÄ… nazwÄ™ stworzonÄ… na podstawie javowego package, w ktÃ³rym siÄ™ znajdujÄ… (zdaje siÄ™, Å¼e wyjÄ…tkiem sÄ… tu Sagi).MoÅ¼emy je teÅ¼ jawnie nazywaÄ‡ z uÅ¼yciem adnotacji @ProcessingGroup.MajÄ…c nazwÄ™ processora, w konfiguracji moÅ¼na wykluczyÄ‡ go z akcji odtwarzania stanu, poprzez sprytne wskazanie, aby Tracking Tokeny dla niego tworzyÅ‚y siÄ™ na koÅ„cu â€œjego kolejkiâ€.WyglÄ…da to nastÄ™pujÄ…co:@Configurationpublic class AxonConfig {    @Autowired    public void customTrackingConfig(EventProcessingConfigurer configurer) {        var trackingProcessorConfig = TrackingEventProcessorConfiguration                .forSingleThreadedProcessing()                .andInitialTrackingToken(StreamableMessageSource::createHeadToken);        // This prevents from replaying in MovieSaga        configurer.registerTrackingEventProcessor(&quot;MovieSagaProcessor&quot;,                org.axonframework.config.Configuration::eventStore,                c -&amp;gt; trackingProcessorConfig);        // This prevents from replaying MultipleMoviesRefreshedEvent in RefreshEventHandler        configurer.registerTrackingEventProcessor(&quot;com.kociszewski.moviekeeper.notreplayable&quot;,                org.axonframework.config.Configuration::eventStore,                c -&amp;gt; trackingProcessorConfig);    }}OpisujÄ…c powyÅ¼szy kod jÄ™zykiem ludzkim: klasa MovieSaga oraz wszystkie klasy obsÅ‚ugujÄ…ce zdarzenia, ktÃ³re znajdujÄ… siÄ™ w packageâ€™u com.kociszewski.moviekeeper.notreplayable zostanÄ… pominiÄ™te podczas operacji replay events.Uwaga! JeÅ›li wskaÅ¼ecie package za wysoko, to nie zadziaÅ‚a - musi to byÄ‡ nazwa packageâ€™u, w ktÃ³rym znajdujÄ… siÄ™ klasy obsÅ‚ugujÄ…ce zdarzenia (zagnieÅ¼dÅ¼enia nie bÄ™dÄ… uwzglÄ™dniane).Namiary na projekt podane sÄ… na koÅ„cu, jest to ten sam projekt, ktÃ³ry omawiaÅ‚em we wczeÅ›niejszych wpisach.Jak sobie radzicie w Consdacie z organizacjÄ… Event StormingÃ³w w czasach pracy zdalnej?Z peÅ‚nym spokojem mogÄ™ poleciÄ‡ miro - Å›wietne narzÄ™dzie z mnÃ³stwem moÅ¼liwoÅ›ci.Na koncie bezpÅ‚atnym moÅ¼na naprawdÄ™ wiele zdziaÅ‚aÄ‡. OczywiÅ›cie to wciÄ…Å¼ nie to samo, co â€˜realneâ€™ spotkanie w grupie projektujÄ…cej, ale wiÄ™kszoÅ›Ä‡ zalet Event Stormingu wyciÄ…gniemy nawet w remote.Co w momencie, gdy Axon zacznie odtwarzaÄ‡ zdarzenia z klasy, ktÃ³ra wrzuca lub aktualizuje coÅ› w bazie?Tutaj jest kilka moÅ¼liwych rozwiÄ…zaÅ„. Najprostszym z nich jest opatrzyÄ‡ klasÄ™/metodÄ™ adnotacjÄ… @DisallowReplay, powinno to skutecznie zatrzymaÄ‡ Event Processor.JeÅ›li jednak chcielibyÅ›my, aby klasa/metoda braÅ‚a udziaÅ‚ w odtwarzaniu zdarzeÅ„ (przykÅ‚adowo chcemy mÃ³c migrowaÄ‡ na innÄ… bazÄ™, ale nie chcemy aby nam siÄ™ duplikowaÅ‚y krotki w bazie), to widzÄ™ tu dwa rozwiÄ…zania.Jednym z nich jest konfiguracja sterowana profilem - powinno zadziaÅ‚aÄ‡, ale nie sprawdzaÅ‚em.Drugi sposÃ³b to obsÅ‚uga takiego przypadku rÄ™cznie, samemu:public class MovieProjection {    ...    @EventHandler    public void handle(MovieSavedEvent event) {        movieRepository.findByExternalMovieId(event.getExternalMovie().getExternalMovieId()).ifPresentOrElse(                movie -&amp;gt; handleMovieDuplicate(),                () -&amp;gt; persistMovie(event));    }        private void handleMovieDuplicate() {        notifySubscribers(new MovieDTO(MovieState.ALREADY_ADDED));    }    ...}W tym przypadku wywoÅ‚anie notifySubscribers powoduje wyemitowanie (przy uÅ¼yciu queryUpdateEmittera) nowego filmu z ustawionym statusem ALREADY_ADDED.Pojawienie siÄ™ filmu o takim statusie jest obsÅ‚ugiwane wyÅ¼ej i skutkuje zwrÃ³ceniem kodu bÅ‚Ä™du 409, mÃ³wiÄ…cym o konflikcie.Co dalej?JeÅ›li szukacie projektÃ³w zwiÄ…zanych z tematem DDD i Axona, to zerknijcie tu:  Repozytorium, ktÃ³re omawiaÅ‚em na Consdata Tech  Repozytorium, ktÃ³re cytujÄ™ tutaj",
"url": "/2021/02/10/odpowiedzi-na-pytania-cd-tech-5.html",
"author": "Mateusz Kociszewski",
"authorUrl": "/authors/mkociszewski.html",
"image": "mkociszewski.webp",
"highlight": "/assets/img/posts/2021-02-10-odpowiedzi-na-pytania-cd-tech-5/lightboard.jpeg",
"date": "10-02-2021",
"path": "pl/2021-02-10-odpowiedzi-na-pytania-cd-tech-5"
}
,


"2021-02-09-migracja-schematow-bazy-danych-html": {
"title": "Migracja schematÃ³w bazy danych",
"lang": "pl",
"tags": "migration database liquibase flyway kubernetes job initContainers",
"content": "NiemoÅ¼liwe jest rozwijanie aplikacji bez rÃ³wnoczesnego rozwijania schematu bazy danych.Tak jak podczas rozwijania naszej aplikacji, stosujemy wzorce projektowe przy pisaniu kodu, tak w przypadku rozwijania schematÃ³w baz danych rÃ³wnieÅ¼ powinniÅ›my stosowaÄ‡ siÄ™ do takich wytycznych, aby rozwijanie bazy danych byÅ‚o przyjemnoÅ›ciÄ…, a nie ostatecznoÅ›ciÄ….Migracja schematu, czyli ewolucyjny projekt bazy danych (ang. Evolutionary Database Design)Aby umoÅ¼liwiÄ‡ proste rozwijanie naszej bazy danych, moÅ¼emy skorzystaÄ‡ z przetestowanego juÅ¼ zbioru zaleceÅ„ ğŸ”—Â¹ ğŸ”—Â², dziÄ™ki ktÃ³rym zmiany bÄ™dÄ… mniej inwazyjne, a nawet bezprzerwowe (zero downtime deployment).Przechowywanie zmian w repozytorium kodÃ³wPodobnie jak kod aplikacji, schemat bazy danych jest czÄ™Å›ciÄ… tworzonego systemu i dobrÄ… praktykÄ… jest przechowywanie go w repozytorium. Jako Å¼e zmiany schematu bazy danych sÄ… przyrostowe, to repozytorium powinno zawieraÄ‡ wszystkie zmiany umoÅ¼liwiajÄ…ce odtworzenie zawsze tej samej bazy danych.DziÄ™ki temu uzyskamy szereg korzyÅ›ci:  moÅ¼liwoÅ›Ä‡ zweryfikowania zmian,  prostsze utrzymywanie kolejnoÅ›ci zmian schematu bazy danych, dziÄ™ki utrzymywaniu zmian w jednym miejscu,  bezproblemowe odtworzenie zawsze dokÅ‚adnie takiej samej bazy danych (np. lokalnie do celÃ³w testowych).JeÅ›li kilka projektÃ³w korzysta z bazy, to mimo wszystko zmiany powinny odbywaÄ‡ siÄ™ tylko na jednym gÅ‚Ã³wnym repozytorium (nawet na osobnym).KaÅ¼da zmiana schematu powinna byÄ‡ migracjÄ…KaÅ¼dorazowe modyfikowanie schematu, powinno odbywaÄ‡ siÄ™ za pomocÄ… migracji, ktÃ³rÄ… zapiszemy w repozytorium, unikajÄ…c rÄ™cznego modyfikowania schematu.DziÄ™ki temu nie bÄ™dzie sytuacji, w ktÃ³rej po odtworzeniu bazy, bÄ™dzie siÄ™ ona rÃ³Å¼niÄ‡ od oryginaÅ‚u.Dodatkowo zmiany wykonane rÄ™cznie (z pominiÄ™ciem migracji), mogÄ… wpÅ‚ynÄ…Ä‡ na jego pÃ³Åºniejsze wykonanie za pomocÄ… migracji, np. gdy wykonujemy CREATE TABLE bezpoÅ›rednio na bazie, a pÃ³Åºniej dodajemy migracjÄ™ schematu, ktÃ³ra to procesuje, to w takim wypadku otrzymamy bÅ‚Ä…d informujÄ…cy o tym, Å¼e taka tabela juÅ¼ istnieje.Wersjonowanie (rosnÄ…ce) kaÅ¼dej zmiany  KaÅ¼da zmiana powinna byÄ‡ wersjonowana, np. w osobnych plikach, w ktÃ³rych zachowanie kolejnoÅ›ci bÄ™dzie wykonane za pomocÄ… podbijania licznika lub dodania znacznika czasu do nazwy pliku.Jest to bardzo waÅ¼ne, poniewaÅ¼ inna kolejnoÅ›Ä‡ uruchomienia migracji schematÃ³w bazy danych moÅ¼e caÅ‚kowicie zmieniÄ‡ jej sens albo nawet caÅ‚kowicie jÄ… uniemoÅ¼liwiÄ‡.  Zalecane jest, aby kaÅ¼da zmiana byÅ‚a jak najmniejsza i najlepiej moÅ¼liwa do odwrÃ³cenia. PrzykÅ‚adowo tworzÄ…c indeksy na istniejÄ…cych tabelach, najlepiej rozbiÄ‡ ich tworzenie do osobnych wersji.JeÅ›li nie zostanÄ… one wykonane w osobnych migracjach schematu, wtedy naraÅ¼amy siÄ™ na ryzyko takie jak opisane niÅ¼ej:          w tej samej migracji schematu bazy danych tworzymy indeks A oraz indeks B,      stworzenie indeksu A zajmuje 5 minut i przebiega poprawnie,      stworzenie indeksu B zajmuje ponad 5 minut i powoduje bÅ‚Ä…d TimeoutException,      oba indeksy zostajÄ… wycofane i indeks A musi byÄ‡ ponownie zaÅ‚oÅ¼ony,      w przypadku, gdyby tworzenie indeksÃ³w byÅ‚o rozdzielone na osobne migracje, wtedy nie bÄ™dzie koniecznoÅ›ci ponownego tworzenia indeksu A (i ponownego poÅ›wiÄ™cania 5 minut na ten cel).        Wykonywane zmiany powinny byÄ‡ przyrostowe, czyli zmiana dla danej wersji powinna byÄ‡ uruchomiona tylko raz.PrzykÅ‚adowe biblioteki  SQL          Liquibase                  liquibase.org                    FlywayDB                  flywaydb.org                    MyBatis Migration                  mybatis.org/migrations                      NoSQL          Mongock                  github.com/cloudyrock/mongock          mongock.io                    Migrate-mongo                  npmjs.com/package/migrate-mongo          github.com/seppevs/migrate-mongo                    liquibase-mongodb                  github.com/liquibase/liquibase-mongodb                    w powyÅ¼szych bibliotekach tworzenie i uruchamianie przyrostowe zmian jest wbudowane.Zmiany powinny byÄ‡ kompatybilne wsteczJest to szczegÃ³lnie waÅ¼ne, jeÅ›li chcemy bezprzerwowo aktualizowaÄ‡ naszÄ… bazÄ™ danych, w takim wypadku aktualizacja bazy danych nie powinna spowodowaÄ‡, Å¼e starsza wersja aplikacji przestanie dziaÅ‚aÄ‡.PrzykÅ‚adowo nowa kolumna powinna mieÄ‡ domyÅ›lnÄ… wartoÅ›Ä‡ lub przyjmowaÄ‡ null-e.Zmiana nazwy kolumny lub jej usuniÄ™cie powinno byÄ‡ rozbite na kilka etapÃ³w, tak aby jej prawdziwe usuniÄ™cie byÅ‚o wykonane nie w docelowej wersji, tylko np. w nastÄ™pnej iteracji, gdy bÄ™dziemy pewni, Å¼e Å¼adna aplikacja z niej nie korzysta.Aplikowanie zmianAplikowanie zmian wykonanych w ramach ewolucyjnej bazy danych jest juÅ¼ zaleÅ¼ne od konkretnego przypadku.JeÅ›li baza danych jest Å›ciÅ›le zwiÄ…zana z jednÄ… aplikacjÄ…, to moÅ¼emy jÄ… uruchamiaÄ‡ bezpoÅ›rednio z kodu ğŸ”—âµ .W przypadku gdy aplikacja jest rozproszona i nie chcemy blokowaÄ‡ wszystkich instancji aplikacji na czas migracji schematu lub gdy kilka rÃ³Å¼nych aplikacji korzysta z tej bazy danych, moÅ¼emy uruchamiaÄ‡ migracjÄ™ niezaleÅ¼nie od aplikacji.W tym przypadku mamy nastÄ™pujÄ…ce moÅ¼liwoÅ›ci:  Wykonywanie zmian uruchamianych za pomocÄ… CI/CD (np. automatycznie po otrzymaniu nowej wersji).Na repozytorium wykonujemy merge z migracjami schematu bazy danych, Jenkins wykrywa zmianÄ™ na repozytorium i wykonuje jÄ… na bazie wskazanej w konfiguracji.  Z wykorzystaniem mechanizmÃ³w dostarczonych przez platformÄ™, na ktÃ³rej bÄ™dzie to uruchamiane. PrzykÅ‚adowo dla Kubernetesa moÅ¼emy:          wykorzystaÄ‡ initContainers, celem odpalenia migracji schematu bazy danych przed uruchomieniem docelowego kontenera z aplikacjÄ… (w takim wypadku kaÅ¼da replika uruchomi migracjÄ™ schematu, a to mechanizm migracji musi zapewniÄ‡, Å¼e zmiany zostanÄ… wykonane wszystkie na jednym kontenerze i do tego jednorazowo) ğŸ”—âµ ,      wykorzystaÄ‡ do tego celu Joby, ktÃ³re jednorazowo uruchomiÄ… migracjÄ™ (a w przypadku problemÃ³w, wykonajÄ… automatyczne ponowienie n-razy) ğŸ”—Â³ ğŸ”—â´ ğŸ”—âµ ,      wykorzystaÄ‡ dwa powyÅ¼sze mechanizmy ğŸ”—âµ,uruchomiÄ‡ joba, aby wykonaÅ‚ migracjÄ™ schematu bazy danych, oraz initContainers tak, aby poczekaÅ‚ na zakoÅ„czenie migracji schematu(a jeÅ›li wszystkie migracje schematu wymagane przez aplikacjÄ™, sÄ… juÅ¼ zaaplikowane, to uruchomienie docelowego kontenera).      PrzykÅ‚ady - KubernetesPrzykÅ‚adowe rozwiÄ…zanie Å‚Ä…czÄ…ce mechanizm initContainer oraz job-a, dla rÃ³Å¼nych bibliotek do migracji schematÃ³w bazy danych:   Liquibase   FlywayDB   MyBatis Migration   Migrate-mongoBibliografia  https://www.martinfowler.com/articles/evodb.html  https://en.wikipedia.org/wiki/Evolutionary_database_design  https://cloud.google.com/solutions/addressing-continuous-delivery-challenges-in-a-kubernetes-world#related_kubernetes_concepts_2  https://kubernetes.io/docs/concepts/workloads/controllers/job/  https://andrewlock.net/deploying-asp-net-core-applications-to-kubernetes-part-7-running-database-migrations/",
"url": "/2021/02/09/migracja-schematow-bazy-danych.html",
"author": "Jakub Goszczurny",
"authorUrl": "/authors/jgoszczurny.html",
"image": "jgoszczurny.jpg",
"highlight": "/assets/img/posts/2021-02-09-migracja-schematow-bazy-danych/bird-migrations.jpg",
"date": "09-02-2021",
"path": "pl/2021-02-09-migracja-schematow-bazy-danych"
}
,


"2021-01-11-pisanie-pluginow-do-intellij-html": {
"title": "Jak napisaÄ‡ plugin w IntelliJ",
"lang": "pl",
"tags": "intellij ide plugin",
"content": "IntelliJ IDEA to obecnie jedno z popularniejszych, jeÅ›li nie najpopularniejsze IDE dla Javy. JednÄ…Â z jego zalet jest duÅ¼a baza pluginÃ³w, dostarczana przez samo JetBrains, jak i spoÅ‚ecznoÅ›Ä‡. W tym artykule przedstawiÄ™ podstawy tworzenia pluginÃ³w dla tej platformy. WiÄ™kszoÅ›Ä‡Â z zebranych tu informacji (poza elementami zwiÄ…zanymi z JavÄ…) ma zastosowanie do dowolnego IDE ze stajni JetBrains.Sposoby rozszerzania IDEW platformie mamy do dyspozycji trzy podstawowe metody rozszerzenia IDE:  actions - kod uruchamiany w momencie, gdy uÅ¼ytkownik kliknie np. w element menu kontekstowego lub paska narzÄ™dziowego,  listeners - pozwalajÄ… nasÅ‚uchiwaÄ‡ na eventy generowane przez platformÄ™ lub inne pluginy,  extension points - interfejsy pozwalajÄ…ce na rozszerzenie konkretnych elementÃ³w platformy lub innych pluginÃ³w.WiÄ™cej informacji o tym, co i jak dziaÅ‚a, moÅ¼ecie znaleÅºÄ‡ w dokumentacji IDE. Ja natomiast przedstawiÄ™ ujÄ™cie praktyczne, w ramach ktÃ³rego stworzymy prosty plugin dla IntelliJ, ktÃ³ry wykorzysta wszystkie opisane wyÅ¼ej metody. PrzykÅ‚adowy plugin, na podstawie adnotacji, wygeneruje plik tekstowy z prostÄ… dokumentacjÄ…Â dla klas Javy (do tego wykorzystane zostanÄ… akcje i listenery) oraz pozwoli na wyÅ›wietlenie tej dokumentacji w ramach Quick Documentation (Extension point). MajÄ…c klasÄ™:@Doc(&quot;To jest testowa klasa&quot;)public class TestClass {    @Doc(&quot;To jest testowe pole&quot;)    private String field;    @Doc(&quot;To jest testowe pole &quot; + Constants.ADDITIONAL_TEXT)    private String fieldWithExtraInfo;}plugin wygeneruje dokumentacjÄ™ w postaci:TestClass: To jest testowa klasafield: To jest testowe polefieldWithExtraInfo: To jest testowe pole z dodatkowym opisem ze staÅ‚eNa githubie znajduje siÄ™ repozytorium z pluginem oraz repozytorium z testowÄ… aplikacjÄ…Baza pluginuPrzygodÄ™ z wÅ‚asnym pluginem rozpoczynamy od stworzenia nowego projektu typu Intellij Platform Plugin. Wygenerowana zostanie domyÅ›lna struktura katalogÃ³w oraz plik XML z manifestem (META-INF/plugin.xml). Zawiera on podstawowe informacje o pluginie tj. jego unikalny identyfikator, opis, dane autora itd. W tym pliku definiujemy rÃ³wnieÅ¼ zaleÅ¼noÅ›Ä‡ pluginu, w naszym przypadku bÄ™dÄ… takie trzy:&amp;lt;depends&amp;gt;com.intellij.modules.platform&amp;lt;/depends&amp;gt;&amp;lt;depends&amp;gt;com.intellij.modules.lang&amp;lt;/depends&amp;gt;&amp;lt;depends&amp;gt;com.intellij.modules.java&amp;lt;/depends&amp;gt;  *.platform - zawiera interfejsy i klasy potrzebne do implementacji serwisÃ³w, akcji, UI, rozszerzeÅ„ itd.;  *.lang - zawiera elementy zwiÄ…zane z przetwarzaniem plikÃ³w, nawigacjÄ… itd.;  *.java - zawiera elementy uÅ‚atwiajÄ…ce prace z plikami Javy;AkcjeMajÄ…c juÅ¼ gotowy projekt bazowy moÅ¼emy przejÅ›Ä‡ do implementacji akcji czyli dodamy element do menu kontekstowego edytora i do drzewa projektu - przycisk â€˜Generujâ€™. Na razie bÄ™dzie wyÅ›wietlaÅ‚ tylko popup z informacjÄ….KaÅ¼da akcja w platformie musi rozszerzaÄ‡ abstrakcyjnÄ… klasÄ™ AnAction i implementowaÄ‡ metodÄ™ actionPerformed. Tworzymy zatem naszÄ… akcjÄ™, ktÃ³rÄ… nazwiemy DocAction.Na razie implementacja actionPerformed sprowadzaÄ‡ bÄ™dzie siÄ™Â do wyÅ›wietlenia okna dialogowego. Do tego celu wykorzystamy gotowego helpera w platformie - Messages:public class DocAction extends AnAction {    @Override    public void actionPerformed(@NotNull AnActionEvent event) {        Messages.showMessageDialog(event.getProject(), &quot;Witam!&quot;, &quot;&quot;, null);    }}Na koniec musimy jeszcze powiÄ…zaÄ‡ naszÄ… akcjÄ™ z jakimÅ›Â elementem IDE, ktÃ³ry jÄ… wywoÅ‚a. AkcjÄ™ definiujemy w manifeÅ›cie w nastÄ™pujÄ…cy sposÃ³b:    &amp;lt;actions&amp;gt;        &amp;lt;action id=&quot;com.consdata.article.DocAction&quot;                class=&quot;com.consdata.article.DocAction&quot;                text=&quot;Generuj&quot;&amp;gt;            &amp;lt;add-to-group group-id=&quot;EditorPopupMenu&quot; anchor=&quot;last&quot;/&amp;gt;            &amp;lt;add-to-group group-id=&quot;ProjectViewPopupMenu&quot; anchor=&quot;last&quot;/&amp;gt;        &amp;lt;/action&amp;gt;    &amp;lt;/actions&amp;gt;Atrybut id to unikalny identyfikator naszej akcji (zwykle Fully qualified name klasy), w atrybucie class wskazujemy implementacjÄ™ akcji. W atrybucie text okreÅ›lamy tekst przycisku w menu. WewnÄ…trz wÄ™zÅ‚a akcji definiujemy, do ktÃ³rej grupy akcji chcemy jÄ…Â â€™przypiÄ…Ä‡â€™. W naszym przypadku jest to EditorPopupMenu - menu kontekstowe edytora oraz ProjectViewPopupMenu - menu kontekstowe drzewa projektu. Po uruchomieniu projektu i klkniÄ™ciu prawym przyciskiem myszy na edytor pliku w menu kontekstowym pokaÅ¼e nam siÄ™ opcja â€˜Generujâ€™Po klikniÄ™cu w â€˜Generujâ€™ pojawi siÄ™ komunikat â€˜Witam!â€™DobrÄ… praktykÄ… jest organizowanie kilku akcji pluginu w ramach grupy. Co prawda nasz plugin bÄ™dzie dostarczaÅ‚ tylko jednÄ… akcjÄ™, niemniej warto w celach dydaktycznych to zaprezentowaÄ‡. Analogicznie do akcji, grupy rozszerzajÄ… dedykowanÄ…Â klasÄ™ ActionGroup. Implementacja grupy jest juÅ¼Â zadaniem nieco bardziej zÅ‚oÅ¼onym, dlatego platforma dostarcza domyÅ›lnÄ…Â implementacjÄ™Â w postaci DefaultActionGroup. Tworzymy zatem nowÄ… klasÄ™ DocGroup:public class DocGroup extends DefaultActionGroup {}StworzonÄ… wczeÅ›niej akcjÄ™ dodajemy do nowej grupy, a nastÄ™pnie naszÄ… grupÄ™ DocGroup doÅ‚Ä…czamy do menu kontekstowego edytora i drzewa projektu:    &amp;lt;actions&amp;gt;        &amp;lt;group id=&quot;com.consdata.article.DocGroup&quot;               class=&quot;com.consdata.article.DocGroup&quot; popup=&quot;true&quot;               text=&quot;Dokumentacja&quot;&amp;gt;            &amp;lt;add-to-group group-id=&quot;EditorPopupMenu&quot; anchor=&quot;last&quot;/&amp;gt;            &amp;lt;add-to-group group-id=&quot;ProjectViewPopupMenu&quot; anchor=&quot;last&quot;/&amp;gt;            &amp;lt;action id=&quot;com.consdata.article.DocAction&quot;                    class=&quot;com.consdata.article.DocAction&quot;                    text=&quot;Generuj&quot;&amp;gt;            &amp;lt;/action&amp;gt;        &amp;lt;/group&amp;gt;    &amp;lt;/actions&amp;gt;Po uruchomieniu w miejscu przycisku â€˜Generujâ€™ pojawi siÄ™ przycisk â€˜Dokumentacjaâ€™, kierujÄ…cy do naszego podmenu.Plugin bÄ™dzie generowaÅ‚ dokumentacjÄ™ na podstawie adnotacji Doc, dlatego teÅ¼ nie ma sensu uruchamiaÄ‡ akcji na plikach, ktÃ³re takiej adnotacji nie zawierajÄ…. W naszym pluginie przycisk â€˜Dokumentacjaâ€™ pozostawimy widocznym, ale jednoczeÅ›nie, jeÅ›li celem akcji jest plik niezawierajÄ…cy adnotacji Doc, to wÃ³wczas warto by byÅ‚ nieaktywny. WidocznoÅ›Ä‡ i aktywnoÅ›Ä‡ przycisku aktualizujemy w metodzie update wywoÅ‚ywanej w przypadku, gdy uÅ¼ytkownik kliknie w jakiÅ› element interfejsu zawierajÄ…cy tÄ™ akcjÄ™ lub grupÄ™:public class DocGroup extends DefaultActionGroup {    @Override    public void update(@NotNull AnActionEvent event) {        event.getPresentation().setVisible(true);        event.getPresentation().setEnabled(ofNullable(CommonDataKeys.PSI_FILE.getData(event.getDataContext()))                .map(this::hasDocAnnotation)                .orElse(false));    }    private boolean hasDocAnnotation(PsiFile psiFile) {        if (psiFile instanceof PsiJavaFile) {            PsiJavaFile javaFile = (PsiJavaFile) psiFile;            return Arrays.stream(javaFile.getClasses())                    .anyMatch(psiClass -&amp;gt; psiClass.hasAnnotation(&quot;com.consdata.doc.Doc&quot;)                            || Arrays.stream(psiClass.getFields()).anyMatch(field -&amp;gt; field.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                            || Arrays.stream(psiClass.getAllMethods()).anyMatch(method -&amp;gt; method.hasAnnotation(&quot;com.consdata.doc.Doc&quot;)));        }        return false;    }}W powyÅ¼szym kodzie skorzystaliÅ›my z jednego z podstawowych elementÃ³w platformy tj. PSI (Program Structure Interface). NajproÅ›ciej rzecz ujmujÄ…c, PSI odpowiada w platformie za parsowanie plikÃ³w i generowanie modelu kodu, ktÃ³ry zawierajÄ…. DziÄ™ki temu w prosty sposÃ³b moÅ¼emy, przejÅ›Ä‡ po wszystkich klasach, ich polach i metodach zwartych w danym pliku. PeÅ‚ny model PSI moÅ¼na w prosty sposÃ³b podejrzeÄ‡ za pomocÄ…Â pluginu np. PsiViewer. W powyÅ¼szym przykÅ‚adzie pobieramy model PSI z kontekstu zdarzenia akcji (podobnie moÅ¼emy odnieÅ›Ä‡ siÄ™ do otwartego edytora, czy zaznaczonego fragmentu tekstu - patrz com.intellij.openapi.actionSystem.CommonDataKeys). NastÄ™pnie weryfikujemy, czy jest to model Javy. JeÅ›li tak, to sprawdzamy, czy klasy, ich pola lub metody zawierajÄ… adnotacjÄ™ Doc. Po tej zmianie, klikniÄ™cie prawym przyciskiem myszy w plik, ktÃ³ry nie zawiera tej adnotacji zdezaktywuje przycisk â€˜Generujâ€™. Na koniec pozostaje juÅ¼Â tylko zaimplementowaÄ‡ sam mechanizm generowania dokumentacji oraz zapisaÄ‡ tÄ™ dokumentacjÄ™ we wskazanym pliku.Generowanie dokumentacjiDokumentacja bÄ™dzie skÅ‚adaÄ‡ siÄ™ z wierszy zawierajÄ…cych nazwÄ™ dokumentowanego elementu (np. nazwa pola) oraz opisu z adnotacji. PrzyjmujÄ…c, Å¼e na wejsciu mamy model PSI pliku z kodem, wygenerowanie takiej dokumentacji moÅ¼e wyglÄ…daÄ‡ mniej wiÄ™cej tak:    private String getDoc(PsiFile psiFile) {        if (psiFile instanceof PsiJavaFile) {            PsiJavaFile javaFile = (PsiJavaFile) psiFile;            Map&amp;lt;String, String&amp;gt; doc = Arrays.stream(javaFile.getClasses())                    .filter(psiClass -&amp;gt; psiClass.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                    .collect(Collectors.toMap(PsiClass::getName, psiClass -&amp;gt; evaulate(psiClass.getProject(), psiClass.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;))));            doc.putAll(Arrays.stream(javaFile.getClasses())                    .map(PsiClass::getFields)                    .flatMap(Arrays::stream)                    .filter(psiField -&amp;gt; psiField.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                    .collect(Collectors.toMap(PsiField::getName, psiField -&amp;gt; evaulate(psiField.getProject(), psiField.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;)))));            doc.putAll(Arrays.stream(javaFile.getClasses())                    .map(PsiClass::getMethods)                    .flatMap(Arrays::stream)                    .filter(psiMethod -&amp;gt; psiMethod.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                    .collect(Collectors.toMap(PsiMethod::getName, psiMethod -&amp;gt; evaulate(psiMethod.getProject(), psiMethod.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;)))));            return String.join(&quot;\\n&quot;, doc.entrySet().stream().map(e -&amp;gt; e.getKey() + &quot;: &quot; + e.getValue()).collect(Collectors.toList()));        } else {            return &quot;&quot;;        }    }KorzystajÄ…c z PSI przechodzimy po wszystkich klasach w pliku oraz ich polach i metodach. JeÅ›li zawierajÄ… adnotacjÄ™ Doc, to do wierszy dokumentacji dodajemy nazwÄ™Â pola, znak â€˜:â€™ oraz wartoÅ›Ä‡Â adnotacji. Nie moÅ¼emy jednak wartoÅ›ciÂ adnotacji pobraÄ‡Â wprost, gdyÅ¼ nie jest to String. ZaleÅ¼nie od tego co znajduje siÄ™ w adnotacji bÄ™dzie to model jakiegoÅ› wyraÅ¼enia. Musimy takie wyraÅ¼enie wyliczyÄ‡ (aby np. rozwiÄ…zaÄ‡Â uÅ¼yte w nim staÅ‚e). Dla uÅ‚atwienia tego typu zadaÅ„ powstaÅ‚ ewaluator staÅ‚ych, ktÃ³ry jest czÄ™Å›ciÄ…Â fasady Javy dla PSI:    private String evaulate(Project project, PsiAnnotationMemberValue expression) {        return JavaPsiFacade.getInstance(project).getConstantEvaluationHelper().computeConstantExpression(expression).toString();    }Helper ten automatycznie rozwiÄ…Å¼e nam wszystkie wyraÅ¼enie z adnotacji. NaleÅ¼y jednak pamiÄ™taÄ‡Â o tym, aby projekt byÅ‚ zaindeksowany, a elementy wyraÅ¼enia widoczne w ramach projektu.Na koniec naszÄ… mapÄ™ konwertujemy do oczekiwanego Stringa i zapisujemy w pliku:    private void save(String doc, AnActionEvent event) throws IOException {        final FileSaverDialog dialog = FileChooserFactory.getInstance().createSaveFileDialog(                new FileSaverDescriptor(&quot;Generate to&quot;, &quot;&quot;, &quot;txt&quot;), event.getProject());        VirtualFileWrapper wrapper = dialog.save(event.getProject().getProjectFile(), &quot;&quot;);        VirtualFile vFile = wrapper.getVirtualFile(true);        vFile.setCharset(StandardCharsets.UTF_8);        vFile.setBinaryContent(doc.getBytes());    }Przy zapisie do pliku zahaczamy o kolejny waÅ¼ny element platformy - warstwÄ™ plikÃ³w wirtualnych (Virtual File System). UdostÄ™pnia ona wspÃ³lne api do wszystkich operacji na plikach niezaleÅ¼nie od ich poÅ‚oÅ¼enia. Pliki w tej warstwie nie sÄ… fizycznymi plikami z dysku, tylko snapshotem systemu plikÃ³w z danego czasu. Czasami moÅ¼emy spotkaÄ‡ siÄ™ z komunikatem w IDE, pytajÄ…cym o to, czy wczytaÄ‡ zmiany z dysku oraz czy korzystaÄ‡ wciÄ…Å¼ z lokalnych plikÃ³w. Zdarza siÄ™ teÅ¼, Å¼e zmiany w projekcie nie odzwierciedlajÄ… zmian na dysku. Wtedy klikamy zwykle w â€˜Synchronizeâ€™ lub â€˜Reload all from diskâ€™ - synchornizujÄ…c wtedy wÅ‚aÅ›nie pliki wirtualne.Podobnie jak w innych systemach, IntelliJ udostÄ™pnia gotowe definicje okien dialogowych dla np. zapisu plikÃ³w. W naszym przypadku jest to FileSaverDialog. Po wybraniu pliku i klikniÄ™ciu â€˜zapiszâ€™, dialog zwraca nam wrapper na pliku wirtualnym. Z wrappera pobieramy instancjÄ™Â pliku wirtualnego i zapisujemy do niego treÅ›Ä‡ naszej dokumentacji.Tym samym zaimplementowaliÅ›my w peÅ‚ni dziaÅ‚ajÄ…cÄ… akcjÄ™ naszego pluginu. Teraz przyszedÅ‚ czas na kolejny element rozszerzajÄ…cy dziaÅ‚anie IDE - listenery.ListeneryListenery pozwalajaÂ pluginowi reagowaÄ‡ na eventy w ramach platformy, emitowane czy to przez IDE, czy przez inne pluginy. W przykÅ‚adzie plugin najpierw wyemituje event po zapisie dokumentacji. JeÅ›li plugin otrzyma event z szyny, to otworzy plik z dokumentacjÄ…Â w edytorze. Takie przechodzenie pomiÄ™dzy plikami jest, co prawda trochÄ™ przekombinowane, ale w prosty sposÃ³b zaprezentuje dziaÅ‚anie caÅ‚ego mechanizmu.W pierwszej kolejnoÅ›ci musimy zdefiniowaÄ‡ interfejs naszego listenera:public interface DocSaved {    void onSave(VirtualFile virtualFile);}Interfejs zawiera jednÄ… definicjÄ™ metody. Argumentem jest plik wirtualny, do ktÃ³rego dokumentacja zostaÅ‚a zapisana. W kolejnym korku tworzymy implementacjÄ™ listenera:public class DocListener implements DocSaved {    private final Project project;    public DocListener(Project project) {        this.project = project;    }    @Override    public void onSave(VirtualFile virtualFile) {        Optional.ofNullable(virtualFile).ifPresent(vFile -&amp;gt; new OpenFileDescriptor(project, vFile).navigate(true));    }}Listener bÄ™dzie operowaÄ‡ na poziomie pojedynczego projektu. W metodzie onSave wykorzystaliÅ›my OpenFileDescriptor, ktÃ³ry pozwala na otwarcie edytora danego pliku z poziomu kodu.Podobnie jak inne elementy rozszerzajÄ…ce dziaÅ‚anie platformy, listenery takÅ¼e musimy zdefiniowaÄ‡ w manifeÅ›cie pluginu:    &amp;lt;projectListeners&amp;gt;        &amp;lt;listener class=&quot;com.consdata.article.DocListener&quot;                  topic=&quot;com.consdata.article.DocSaved&quot;/&amp;gt;    &amp;lt;/projectListeners&amp;gt;Atrybut class zawiera implementacjÄ™ interfejsu naszego listenera, zdefiniowanego w polu topic. Listenery dziaÅ‚ajÄ…ce w obrÄ™bie caÅ‚ej aplikacji definiujemy w wÄ™Åºle applicationListeners.CoÅ›Â musi jeszcze wywoÅ‚aÄ‡ event, na ktÃ³ry nasÅ‚uchujemy. W metodzie save naszej akcji dodajemy liniÄ™:   event.getProject().getMessageBus()                    .syncPublisher(Topic.create(&quot;com.consdata.article.DocSaved&quot;, DocSaved.class))                    .onSave(vFile);W efekcie po zapisie dokumentacji do pliku automatycznie otworzy nam siÄ™ edytor pliku dokumentacji.Extension PointsOstatnim elementem, jaki poznamy bÄ™dÄ…Â Extension Pointy. SÄ… to wprost nazwane interfejsy, ktÃ³re pozwalajÄ… na rozszerzenie konkretnych elementÃ³w platformy lub innych pluginÃ³w. PeÅ‚na lista dostÄ™pnych extension pointÃ³w znajduje siÄ™ na https://jetbrains.org/intellij/sdk/docs/appendix/resources/extension_point_list.html.W ramach naszego projektu stworzymy rozszerzenie dla extension pointa com.intellij.documentationProvider. Pozwala on na wzbogacenie  dokumetancji prezentowanej np. w Quick Documentation (Ctrl + Q) o wÅ‚asne treÅ›ci.Tworzym klasÄ™ DocProvider implementujÄ…ca interfejs DocumentationProvider oraz ExternalDocumentationProvider.public class DocProvider implements DocumentationProvider, ExternalDocumentationProvider {    @Nullable    @Override    public String fetchExternalDocumentation(Project project, PsiElement psiElement, List&amp;lt;String&amp;gt; list) {        return getDoc((PsiClass) psiElement);    }    @Override    public boolean hasDocumentationFor(PsiElement psiElement, PsiElement psiElement1) {        if (psiElement instanceof PsiClass) {            PsiClass psiClass = (PsiClass) psiElement;            return psiClass.hasAnnotation(&quot;com.consdata.doc.Doc&quot;)                    || Arrays.stream(psiClass.getFields()).anyMatch(field -&amp;gt; field.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                    || Arrays.stream(psiClass.getMethods()).anyMatch(field -&amp;gt; field.hasAnnotation(&quot;com.consdata.doc.Doc&quot;));        }        return false;    }    private String getDoc(PsiClass psiClass) {        Map&amp;lt;String, String&amp;gt; doc = new HashMap&amp;lt;&amp;gt;();        doc.put(psiClass.getName(), evaulate(psiClass.getProject(), psiClass.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;)));        doc.putAll(Arrays.stream(psiClass.getFields())                .filter(psiField -&amp;gt; psiField.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                .collect(Collectors.toMap(PsiField::getName, psiField -&amp;gt; evaulate(psiField.getProject(), psiField.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;)))));        doc.putAll(Arrays.stream(psiClass.getMethods())                .filter(psiMethod -&amp;gt; psiMethod.hasAnnotation(&quot;com.consdata.doc.Doc&quot;))                .collect(Collectors.toMap(PsiMethod::getName, psiMethod -&amp;gt; evaulate(psiMethod.getProject(), psiMethod.getAnnotation(&quot;com.consdata.doc.Doc&quot;).findAttributeValue(&quot;value&quot;)))));        return doc.entrySet().stream().map(e -&amp;gt; &quot;&amp;lt;b&amp;gt;&quot; + e.getKey() + &quot;&amp;lt;/b&amp;gt;: &quot; + e.getValue()).collect(Collectors.joining(&quot;&amp;lt;br/&amp;gt;&quot;));    }    private String evaulate(Project project, PsiAnnotationMemberValue expression) {        return JavaPsiFacade.getInstance(project).getConstantEvaluationHelper().computeConstantExpression(expression).toString();    }        @Nullable    @Override    public List&amp;lt;String&amp;gt; getUrlFor(PsiElement element, PsiElement originalElement) {        return Collections.singletonList(&quot;&quot;);    }    @Override    public boolean canPromptToConfigureDocumentation(PsiElement psiElement) {        return false;    }    @Override    public void promptToConfigureDocumentation(PsiElement psiElement) {    }}W fetchExternalDocumentation generujemy dokumentacjÄ™Â dla wskazanej klasy analogicznie jak w akcji, tylko dla jednej klasy. Dodatkowo wzbogacamy dokumentacjÄ™Â o znacznik HTML (w oknie QuickDocumentation rednerowany jest HTML). W hasDocumentationFor decydujemy czy dla danego elementu powinniÅ›my wygenerowaÄ‡ dodatkowÄ… dokumentacjÄ™, podobnie jak w przypadku grupy, gdy decydowaliÅ›my o jej aktywnoÅ›ci.Tak zdefiniowany provider moÅ¼emy teraz zdefiniowaÄ‡ w manifeÅ›cie pluginu jako rozszerzenie dla documentationProvider:    &amp;lt;extensions defaultExtensionNs=&quot;com.intellij&quot;&amp;gt;        &amp;lt;documentationProvider implementation=&quot;com.consdata.article.DocProvider&quot;/&amp;gt;    &amp;lt;/extensions&amp;gt;Po uruchomieniu pluginu, przechodzimy do klasy UseCase. NajeÅ¼dÅ¼amy na typ TestClass i wybieramy Ctrl + Q. Po wywoÅ‚aniu skrÃ³tu pojawi siÄ™Â popup z wygenerowanÄ…Â dokumentacjÄ…:Po ponownym uÅ¼yciu skrÃ³tu otworzy siÄ™Â szuflada:OczywiÅ›cie w przypadku innych extension pointÃ³w potrzeba bÄ™dzie zdefiniowaÄ‡ inne mechanizmy. Co do zasady sprawa jest jednakowa dla wszystkich extension pointÃ³w. Definujemy implementacjÄ™ dla konkretnego przypadku i Å‚Ä…czymy jÄ… z okreÅ›lonym extensionPointem w manifeÅ›cie.Plugin w IntelliJ - dystrybucjaGotowy plugin pakujemy do paczki klikajÄ…c prawym przyciskiem myszy na projekt pluginu i wybieramy Prepare plugin module ... for deployment. Wygenerowany JAR pluginu moÅ¼emy opublikowaÄ‡ w repo IntelliJ lub samodzielnie udostÄ™pniaÄ‡ go z prywatnego repo.Przydatne linki  Kompleksowe wprowadzenie do pluginÃ³w  Forum odnoÅ›nie api i pisania pluginÃ³w  Lista platformowych extension pointÃ³w  Tworzenie prywatnego repo pluginÃ³w  Repo z pluginem  Repo z testowÄ… aplikacjÄ…",
"url": "/2021/01/11/pisanie-pluginow-do-intellij.html",
"author": "Bartosz RadliÅ„ski",
"authorUrl": "/authors/bradlinski.html",
"image": "bradlinski.webp",
"highlight": "/assets/img/posts/2021-01-11-pisanie-pluginow-do-intellij/top.jpeg",
"date": "11-01-2021",
"path": "pl/2021-01-11-pisanie-pluginow-do-intellij"
}
,


"2020-11-24-testy-e2e-cypress-html": {
"title": "Testy e2e z Cypress",
"lang": "pl",
"tags": "Cypress e2e e2e testing JavaScript",
"content": "Åamy bloga Consdata Tech goÅ›ciÅ‚y juÅ¼ wiele wpisÃ³w dotyczÄ…cych testowania aplikacji - jednak Å¼aden z nich nie zajmowaÅ‚ siÄ™ tematem testÃ³w e2e (end-to-end).Na rynku testÃ³w e2e, czyli takich, ktÃ³re sprawdzajÄ… funkcjonalnoÅ›Ä‡ od poczÄ…tku do koÅ„ca, symulujÄ…c zachowanie uÅ¼ytkownika i weryfikujÄ…c UI, stale dominuje Selenium - narzÄ™dzie wielu programistom znane, z historiÄ… siÄ™gajÄ…cÄ… 2004 roku.DziÅ› na warsztat wezmÄ™ doÅ›Ä‡ mÅ‚ody framework - Cypress, ktÃ³ry moÅ¼e okazaÄ‡ siÄ™ kuszÄ…cÄ… alternatywÄ… dla wczeÅ›niej wspomnianego narzÄ™dzia.Kilka sÅ‚Ã³w o CypressNaleÅ¼y zaczÄ…Ä‡ od tego, Å¼e Cypress nie jest nakÅ‚adkÄ… na Selenium - jest to caÅ‚kowicie niezaleÅ¼ny byt, zbudowany na JavaScript.RÃ³wnieÅ¼ pisanie testÃ³w odbywa siÄ™ w tym jÄ™zyku, a jeÅ›li ktoÅ› miaÅ‚ wczeÅ›niej stycznoÅ›ci z narzÄ™dziami takimi jak Chai, czy Mocha, to bÄ™dzie czuÅ‚ siÄ™ jak w domu - Cypress zaadoptowaÅ‚ i dopasowaÅ‚ wykorzystywane przez nie rozwiÄ…zania do swoich potrzeb.Wykonywane scenariusze testowe mogÄ… byÄ‡ przez nas podglÄ…dane na Å¼ywo - sÄ… one uruchamiane na wybranej przez nas przeglÄ…darce, moÅ¼e to byÄ‡ Edge, Chrome, Firefox lub wbudowany Electron. Podczas ich wykonywania kaÅ¼dy kolejny krok zapisywany jest pod postaciÄ… snapshotÃ³w - migawek, do ktÃ³rych moÅ¼emy zajrzeÄ‡ w kaÅ¼dym momencie i zweryfikowaÄ‡ stan aplikacji.Przez to, Å¼e Cypress uruchamiany jest w naturalnym Å›rodowisku twojej aplikacji, moÅ¼emy korzystaÄ‡ ze wszystkich dobrodziejstw nowoczesnych DevToolsÃ³w: od debugowania kodu, poprzez kontrolÄ™ sieci czy podglÄ…danie DOM.W Cypressie developer nie musi pamiÄ™taÄ‡, aby pisaÄ‡ jawne oczekiwanie na zakoÅ„czenie poleceÅ„ (wait znane z Selenium). Jest to zrobione za nas przez twÃ³rcÃ³w frameworka - wszystko dzieje siÄ™ automatycznie i kolejne polecenia oraz asercje wykonujÄ… siÄ™ w odpowiednim momencie.KolejnÄ… z rzeczy wartych wspomnienia jest Å‚atwoÅ›Ä‡ uÅ¼ycia i konfiguracji â€” jedno polecenie instaluje framework, a kolejne uruchamia dashboard, ktÃ³rym posÅ‚ugiwanie siÄ™ jest intuicyjne.Rys. 1. Dashboard CypressRozpoczynanie pracyW kwestii wymagaÅ„, Cypress nie potrzebuje wiele: wystarczy Node.js oraz ulubione IDE.Aby umoÅ¼liwiÄ‡ rozpoczÄ™cie pracy, wystarczy wykonaÄ‡ nastÄ™pujÄ…ce polecenia w katalogu projektu:  npm init, aby stworzyÄ‡ projekt nodeâ€™owy  npm install cypress --save-dev dla instalacji CypressaPo zakoÅ„czeniu instalacji powstanie domyÅ›lna struktura:Rys. 2. Struktura projektu CypressObjaÅ›nienia:  fixtures - miejsce, gdzie moÅ¼emy przechowywaÄ‡ gotowe zestaw danych, np. sÅ‚uÅ¼Ä…ce do zamockowania usÅ‚ug;  integration - lokalizacja testÃ³w;  plugins - miejsce do zaÅ‚Ä…czania zewnÄ™trznych rozszerzeÅ„ dla Cypressa;  support - tutaj znajdÄ… siÄ™ np. staÅ‚e powtarzajÄ…ce siÄ™ w wielu scenariuszach czy teÅ¼ nowe, customowe polecenia do globalnego reuÅ¼ycia.NastÄ™pnie przy pomocy komendy npx cypress open uruchamiamy dashboard i jeden z przykÅ‚adowych testÃ³w.Scenariusze testoweW ramach tego wpisu, na warsztat weÅºmiemy stronÄ™ gÅ‚Ã³wnÄ… bloga Consdata Tech -  https://blog.consdata.tech/ i stworzymy dla niej dwa przypadki testowe.Pierwszy scenariusz bÄ™dzie polegaÅ‚ na wejÅ›cie na stronÄ™, poczekaniu aÅ¼ siÄ™ zaÅ‚aduje i zweryfikowaniu kilku elementÃ³w, ktÃ³ra potwierdzÄ… nam, Å¼e portal jest w peÅ‚ni dziaÅ‚ajÄ…cy.Drugi scenariusz, nieco bardziej rozbudowany, dokona kilku interakcji z blogiem.Pierwszy testW katalogu integration tworzymy nowy plik o nazwie blog.spec.js, przechodzimy do jego edycji i uzupeÅ‚niamy go o nastÄ™pujÄ…cÄ… treÅ›Ä‡:describe(&#39;Blog Consdata Tech&#39;, () =&amp;gt; {    it(&#39;should check page fully loaded&#39;, () =&amp;gt; {        // ..    });})Tak jak wczeÅ›niej wspomniaÅ‚em, jeÅ›li ktoÅ› miaÅ‚ wczeÅ›niej stycznoÅ›Ä‡ z testami w JS, wszystko bÄ™dzie dla niego jasne.IdÄ…c od poczÄ…tku, describe nazywa nam caÅ‚oÅ›ciowy kontekst, ktÃ³rego bÄ™dÄ… dotyczyÄ‡ poszczegÃ³lne scenariusze. it rozpoczyna konkretny przypadek testowy i to wewnÄ…trz niego bÄ™dziemy implementowaÄ‡ wÅ‚aÅ›ciwÄ… logikÄ™.W tym momencie uruchamiamy dashboard Cypressa. Zobaczymy w nim, Å¼e pojawiÅ‚ siÄ™ nasz plik. Po klikniÄ™ciu w niego uruchomi siÄ™ przeglÄ…darka oraz scenariusz testowy:Rys. 3. Uruchomiony scenariusz w CypressZostawmy przeglÄ…darkÄ™ i dashboard wÅ‚Ä…czony w tle - Cypress nasÅ‚uchuje na zmiany i od razu je wykonuje. DziÄ™ki temu mamy ciÄ…gÅ‚Ä… pÄ™tlÄ™ zwrotnÄ… z informacjÄ… czy to, co tworzymy przynosi oczekiwane efekty.WracajÄ…c do tworzenia testu, jak wynika z nazwy should check page fully loaded, pierwszy z nich bÄ™dzie sprawdzaÅ‚ czy strona, na ktÃ³rÄ… wchodzimy poprawnie siÄ™ zaÅ‚adowaÅ‚a. Dodajemy ciaÅ‚o do pustej metody:cy.visit(&#39;https://blog.consdata.tech/&#39;).then(() =&amp;gt;{    cy.get(&#39;.header-logo&#39;).should(&#39;be.visible&#39;);    cy.get(&#39;footer&#39;).should(&#39;be.visible&#39;);});Jak widaÄ‡, napisany kod jest wÅ‚aÅ›ciwie samoopisujÄ…cy siÄ™. W pierwszej linii odwiedzamy podany adres, nastÄ™pnie, gdy to siÄ™ odbÄ™dzie, szukamy w DOM elementu o klasie header-logo i sprawdzamy czy jest widoczny. Operacje powtarzamy dla elementu footer. W przeglÄ…darce uÅ›wiadczy nas poniÅ¼szy obrazek:Rys. 4. Scenariusz testowy zakoÅ„czony powodzeniemInterakcjeTwÃ³rcy Cypressa przygotowali zestaw metod, ktÃ³ry uÅ‚atwi nam wykonywanie operacji na stronie. W skÅ‚ad tych poleceÅ„ wchodzi m.in. click(), type(), select() czy check().Jeszcze zanim przejdziemy do implementacji drugiego scenariusza, trzeba zauwaÅ¼yÄ‡, Å¼e kaÅ¼dy z nich bÄ™dzie zaczynaÅ‚ siÄ™ od tej samej akcji - otworzenia strony. MoÅ¼emy wynieÅ›Ä‡ ten kawaÅ‚ek kodu do metody beforeEach(), ktÃ³ra jest uruchamiana przed kaÅ¼dym testem:beforeEach(() =&amp;gt; {    cy.visit(&#39;https://blog.consdata.tech/&#39;)})W ten sposÃ³b bÄ™dziemy zgodni z reguÅ‚Ä… DRY :)WracajÄ…c do wÅ‚aÅ›ciwego testu, rzuÄ‡my na niego okiem:it(&#39;search for a specific post&#39;, () =&amp;gt; {       const searchBoxElementId = &#39;#search-box&#39;;       cy.get(searchBoxElementId).should(&#39;be.not.visible&#39;); // weryfikacja czy element nie jest widoczny       cy.get(&#39;.desktop-navbar .search-icon&#39;).click(); // klikniÄ™cie w ikonÄ™ wyszukiwarki       cy.get(searchBoxElementId).should(&#39;be.visible&#39;); // element powinien siÄ™ pojawiÄ‡       cy.get(searchBoxElementId).type(&#39;ansible&#39;); // wpisanie wartoÅ›ci       cy.get(searchBoxElementId).type(&#39;{enter}&#39;).then(() =&amp;gt; { // symulacja wciÅ›niÄ™cia przycisku enter, aby wysÅ‚aÄ‡ formularz           cy.get(&#39;.post-title&#39;).should(&#39;contain&#39;, &#39;Ansible - jak uporzÄ…dkowaÄ‡ chaos?&#39;); // weryfikacja oczekiwanego efektu       })   });Podobnie jak poprzednio, idÄ…c linijka po linijce, jesteÅ›my w stanie Å‚atwo rozczytaÄ‡, co siÄ™ wydarzyÅ‚o, nawet bez pomocy komentarzy.Gdy zajrzymy do ÅºrÃ³dÅ‚a strony w przeglÄ…darce, okaÅ¼e siÄ™, Å¼e w DOMie jest wiÄ™cej elementÃ³w z klasÄ… post-title, a mimo tego test przechodzi poprawnie. Jest to oczekiwane zachowanie - Å‚aÅ„cuch komend get().should() znajduje wszystkie elementy i sprawdza czy w jakimkolwiek z nich znajduje siÄ™ podana treÅ›Ä‡. GdybyÅ›my chcieli sprawdziÄ‡ czy pierwszy element zawiera konkretnÄ… wartoÅ›Ä‡, moÅ¼emy wykorzystaÄ‡ first():  cy.first(&#39;.post-title&#39;).should(&#39;contain&#39;, &#39;Ansible - jak uporzÄ…dkowaÄ‡ chaos?&#39;);PodsumowaniePrzystÄ™pnoÅ›Ä‡ Cypressa (szczegÃ³lnie dla web developerÃ³w, w zwiÄ…zku z silnym zakorzenieniem w ekosystemie JavaScript) i minimum czasu potrzebnego na przygotowanie dziaÅ‚ajÄ…cej konfiguracji mogÄ… okazaÄ‡ siÄ™ kluczowe dla osÃ³b szukajÄ…cych nietrudnego sposobu na automatyzacjÄ™ testÃ³w. ByÄ‡ moÅ¼e bÄ™dzie to rÃ³wnieÅ¼ okazja dla zraÅ¼onych do Selenium, by daÄ‡ testom E2E drugÄ… szansÄ™.Å¹rÃ³dÅ‚a  https://docs.cypress.io/",
"url": "/2020/11/24/testy-e2e-cypress.html",
"author": "Adrian MarszaÅ‚ek",
"authorUrl": "/authors/amarszalek.html",
"image": "amarszalek.jpg",
"highlight": "/assets/img/posts/2020-11-24-testy-e2e-cypress/e2e-cypress.jpeg",
"date": "24-11-2020",
"path": "pl/2020-11-19-testy-e2e-cypress"
}
,


"2020-11-17-processing-java-stream-html": {
"title": "Java Stream - przetwarzanie elementÃ³w",
"lang": "pl",
"tags": "java stream benchmarking",
"content": "Java StreamStrumienie zostaÅ‚y dodane do Javy w wersji 8, wzbogacajÄ…c jÄ™zyk o namiastkÄ™ programowania funkcyjnego oraz alternatywÄ™ dla dobrze znanych pÄ™tli.Pierwsze pytania jakie siÄ™ nasuwajÄ…, to czy warto stosowaÄ‡ strumienie oraz jak robiÄ‡ to Å›wiadomie.ArtykuÅ‚ ma na celu analizÄ™ kilku podstawowych wÅ‚aÅ›ciwoÅ›ci strumieni oraz porÃ³wnanie ich z pÄ™tlami pod wzglÄ™dem wydajnoÅ›ci.Intermediate vs TerminalJava Stream API definiuje dwa rodzaje operacji, jakie moÅ¼emy wykonaÄ‡ w trakcie przetwarzania strumieni, operacje poÅ›rednie â€“ intermediate,oraz operacje koÅ„cowe - terminal.Operacje poÅ›rednie w sposÃ³b deklaratywny opisujÄ…, jak dane powinny byÄ‡ przetworzone, a dodatkowo zawsze zwracajÄ… obiekt typu Stream, co daje moÅ¼liwoÅ›Ä‡ Å‚Ä…czenia ich z kolejnymi operacjami poÅ›rednimi.Jak widaÄ‡ na przykÅ‚adzie strumieÅ„ danych stworzony z listy filtruje te, ktÃ³re zaczynajÄ… siÄ™ na literÄ™ â€œaâ€,nastÄ™pnie zamienia wszystkie litery na litery wielkie, a na koniec wyÅ›wietla przetworzone elementy.Niestety uruchamiajÄ…c taki kod nic siÄ™ nie zadzieje, a konsola nie wypisze Å¼adnego elementuponiewaÅ¼ w naszym strumieniu brakuje operacji koÅ„cowej -  czyli takiej, ktÃ³ra koÅ„czy strumieÅ„ i sprawia, Å¼e nie moÅ¼na go juÅ¼ wiÄ™cej przetwarzaÄ‡.    private static final List&amp;lt;String&amp;gt; LIST = Arrays.asList(&quot;aab&quot;, &quot;aab&quot;,                                                            &quot;aac&quot;, &quot;aac&quot;,                                                            &quot;bbb&quot;, &quot;ccc&quot;, &quot;ddd&quot;,                                                            &quot;eee&quot;, &quot;fff&quot;, &quot;ggg&quot;);    public static void main(String[] args) {        LIST.stream()                .filter(e -&amp;gt; e.startsWith(&quot;a&quot;))                .map(String::toUpperCase)                .peek(System.out::println);    }Po dodaniu do kodu metody collect, dostajemy zamierzony efekt i mimo, Å¼e stworzona z przetworzonych danych lista nie jest przypisana do zmiennej, to strumieÅ„ miaÅ‚ powÃ³d aby siÄ™ wykonaÄ‡.ListÄ™ metod poÅ›rednich oraz koÅ„cowych znajdziemy tutaj.    private static final List&amp;lt;String&amp;gt; LIST = Arrays.asList(&quot;aab&quot;, &quot;aab&quot;,                                                            &quot;aac&quot;, &quot;aac&quot;,                                                            &quot;bbb&quot;, &quot;ccc&quot;, &quot;ddd&quot;,                                                            &quot;eee&quot;, &quot;fff&quot;, &quot;ggg&quot;);    public static void main(String[] args) {        LIST.stream()                .filter(e -&amp;gt; e.startsWith(&quot;a&quot;))                .map(String::toUpperCase)                .peek(System.out::println)                .collect(Collectors.toList());    }KolejnoÅ›Ä‡ przetwarzaniaKod prezentuje przykÅ‚adowe przetwarzanie danych oparte o metodÄ™ filter oraz map.    private static final List&amp;lt;String&amp;gt; LIST = Arrays.asList(&quot;aab&quot;, &quot;aab&quot;,                                                            &quot;aac&quot;, &quot;aac&quot;,                                                            &quot;bbb&quot;, &quot;ccc&quot;, &quot;ddd&quot;);    public static void main(String[] args) {        List&amp;lt;String&amp;gt; a = LIST.stream()                .filter(e -&amp;gt; {                    System.out.println(&quot;Stream - filter: &quot; + e);                    return e.startsWith(&quot;a&quot;);                })                .map(e -&amp;gt; {                    System.out.println(&quot;Stream - map:&quot; + e);                    return e.toUpperCase();                })                .collect(Collectors.toList());    }Z logÃ³w wyÅ›wietlonych w konsoli widzimy, Å¼e operacje wykonywane sÄ… horyzontalnie, to znaczy dla kaÅ¼dego elementu od poczÄ…tku do koÅ„ca. DziÄ™ki temu, sekwencja skoÅ„czy siÄ™ na pierwszym niespeÅ‚nionym warunku a nadmiarowy kod nie jest wykonywany.Stream - filter: aabStream - map:aabStream - filter: aabStream - map:aabStream - filter: aacStream - map:aacStream - filter: aacStream - map:aacStream - filter: bbbStream - filter: cccStream - filter: dddPrzetwarzanie rÃ³wnolegÅ‚eWartoÅ›ciowym mechanizmem, ktÃ³ry zostaÅ‚ dodany do Java Stream API jest moÅ¼liwoÅ›Ä‡ rÃ³wnolegÅ‚ego przetwarzania strumieni, co daje moÅ¼liwoÅ›Ä‡ wykorzystania wiÄ™kszej liczby rdzeni procesora do wykonania zadania.Jak widaÄ‡ na zaÅ‚Ä…czonym kodzie wystarczy, Å¼e skorzystamy z metody parallelStream zamiast stream i nasze dane zostanÄ… odpowiednio podzielone i przetworzone rÃ³wnolegle z uÅ¼yciem wielu wÄ…tkÃ³w.Stream tworzony w domyÅ›lny sposÃ³b korzysta ze wspÃ³lnej puli wÄ…tkÃ³w, wiÄ™c przetwarzanie w taki sposÃ³b wiÄ™kszej iloÅ›ci danych moÅ¼e zmniejszyÄ‡ zasoby przeznaczone na inne procesy w aplikacji.Warto zwrÃ³ciÄ‡ uwagÄ™ na to, Å¼e samo dzielenie danych wymaga dodatkowej pracy, dlatego przeliczanie rÃ³wnolegÅ‚e mniejszej iloÅ›ci danych moÅ¼e trwaÄ‡ dÅ‚uÅ¼ej niÅ¼ zrobienie tego samego z wykorzystaniem jednego wÄ…tku.Dodatkowo kolejnoÅ›Ä‡ przetwarzanie elementÃ³w przez wiele wÄ…tkÃ³w jednoczeÅ›nie jest niedeterministyczna.    private static final List&amp;lt;String&amp;gt; LIST = Arrays.asList(&quot;aab&quot;, &quot;aab&quot;,                                                            &quot;aac&quot;, &quot;aac&quot;,                                                            &quot;bbb&quot;, &quot;ccc&quot;, &quot;ddd&quot;);    public static void main(String[] args) {        LIST.parallelStream()                .filter(e -&amp;gt; {                    System.out.println(&quot;Stream - filter: &quot; + e);                    return e.startsWith(&quot;a&quot;);                })                .map(e -&amp;gt; {                    System.out.println(&quot;Stream - map:&quot; + e);                    return e.toUpperCase();                })                .collect(Collectors.toList());    }BenchmarkWiemy juÅ¼, jak przetwarzaÄ‡ Java Stream bardziej efektywnie. Nasuwa siÄ™ pytanie, jak ich szybkoÅ›Ä‡ wypada w porÃ³wnaniu do pÄ™tli, aby to sprawdziÄ‡ zostaÅ‚y przeprowadzone testy przy uÅ¼yciu Java Microbenchmark Harness i procesora Intel i7 10700K. Kod zaprezentowany niÅ¼ej zostaÅ‚ uruchomiony na kolekcjach liczÄ…cej 1, 100, 10 000 oraz 1 000 000 elementÃ³w.@Benchmark@Fork(value = 1, warmups = 2)public void forLoop() {    List&amp;lt;String&amp;gt; convertedList = new ArrayList&amp;lt;&amp;gt;();    for (String word : DataProvider.WORDS) {        if (word.startsWith(PREFIX)) {                convertedList.add(word.toUpperCase());        }    }}@Benchmark@Fork(value = 1, warmups = 2)public void stream() {    List&amp;lt;String&amp;gt; convertedList = DataProvider.WORDS.stream()            .filter(word -&amp;gt; word.startsWith(PREFIX))            .map(String::toUpperCase)            .collect(Collectors.toList());}@Benchmark@Fork(value = 1, warmups = 2)public void parallelStream() {    List&amp;lt;String&amp;gt; convertedList = DataProvider.WORDS.parallelStream()            .filter(word -&amp;gt; word.startsWith(PREFIX))            .map(String::toUpperCase)            .collect(Collectors.toList());}JednostkÄ… pomiarowÄ… jest liczba operacji na sekundÄ™, czyli innymi sÅ‚owy, ile razy wywoÅ‚ano danÄ… metodÄ™ w ciÄ…gu jednej sekundy.Jak widaÄ‡ na wykresie dla 1 elementu, pÄ™tla okazaÅ‚a siÄ™ zdecydowanie szybsza niÅ¼ strumienie. Test 100 elementÃ³w pokazaÅ‚ Å¼e strumienie powoli doganiajÄ… zwykÅ‚Ä… pÄ™tlÄ™, jednoczeÅ›nie strumieÅ„ rÃ³wnolegÅ‚y okazaÅ‚ siÄ™ zdecydowanie najwolniejszym rozwiÄ…zaniem.W kolejnych testach dla 10 000 i 1 000 000 elementÃ³w, widzimy siÅ‚Ä™ przetwarzania rÃ³wnolegÅ‚ego. Dodatkowo warto zauwaÅ¼yÄ‡, Å¼e dla testu najwiÄ™kszej kolekcji, przetwarzanie w pÄ™tli uzyskaÅ‚o delikatnie sÅ‚abszy wynik niÅ¼ w jednowÄ…tkowym strumieniu.PodsumowanieNiekiedy zÅ‚oÅ¼one warunki filtrowania i przetwarzania kolekcji sprawiajÄ…, Å¼e kod napisany przy uÅ¼yciu pÄ™tli moÅ¼eby byÄ‡ maÅ‚o czytelny.CzytelnoÅ›Ä‡ moÅ¼na poprawiÄ‡ korzystajÄ…c z Java Stream, a znajÄ…c mechanizmy dziaÅ‚ajÄ…ce podczas przetwarzania strumieni moÅ¼emy tworzyÄ‡ rozwiÄ…zania rÃ³wnie szybkie jak przy uÅ¼yciu petli.",
"url": "/2020/11/17/processing-java-stream.html",
"author": "Tomasz DrÄ…g",
"authorUrl": "/authors/tdrag.html",
"image": "tdrag.jpg",
"highlight": "/assets/img/posts/2020-11-17-java-stream-processing/waterfall-stream.jpeg",
"date": "17-11-2020",
"path": "pl/2020-11-17-processing-java-stream"
}
,


"2020-11-04-nowa-forma-meetupu-html": {
"title": "Consdata Tech Webinar - rozmowa z Marcinem Mergo o nowej formie meetupu",
"lang": "pl",
"tags": "consdatatech meetup",
"content": "Consdata Tech to inicjatywa, ktÃ³rej zaÅ‚oÅ¼eniem od poczÄ…tku byÅ‚o dzielenie siÄ™ wiedzÄ… i doÅ›wiadczeniem w formie cyklicznych meetupÃ³w oraz integracja lokalnej spoÅ‚ecznoÅ›ci zafascynoweanej Å›wiatem Java. Wszystkie dotychczasowe edycje odbywaÅ‚y siÄ™ w Poznaniu, w przestrzeni +Jeden, jednakÅ¼e trwajÄ…ca pandemia uniemoÅ¼liwia zachowanie takiej formuÅ‚y eventu. Ta sytuacja staÅ‚a siÄ™ motywatorem do tego, by kolejne edycje Consdata Tech zorganizowaÄ‡ w postaci webinarowej i tym samym przenieÅ›Ä‡ je z przestrzeni biurowej wprost do domÃ³w swoich uczestnikÃ³w. O nowej formie i oczekiwaniach wzglÄ™dem niej oraz przede wszystkim, czy warto doÅ‚Ä…czaÄ‡ do webinaru, rozmawiamy z Marcinem Mergo - pomysÅ‚odawcÄ… cyklu eventÃ³w.ChociaÅ¼ wielu z nas ma juÅ¼ dosyÄ‡ dyskutowania o wpÅ‚ywie koronawirusa na nasze Å¼ycie, to tutaj nie sposÃ³b od tego nie zaczÄ…Ä‡. Mianowicie dotychczasowe edycje konferencji Consdata Tech odbywaÅ‚y siÄ™ w salach konferencyjnych, gdzie prelegenci i goÅ›cie uczestniczyli w meetingu twarzÄ… w twarz. Co spowodowaÅ‚o, Å¼e postanowiliÅ›cie przejÅ›Ä‡ na wersjÄ™ webinarowÄ… zamiast poczekaÄ‡ aÅ¼ Å¼ycie wrÃ³ci do normy, gdy ponownie bÄ™dzie moÅ¼na siÄ™ spotkaÄ‡ w dotychczasowej formie?Przede wszystkim niepewnoÅ›Ä‡ zwiÄ…zana z koronawirusem. Bardzo ciÄ™Å¼ko jest na ten moment okreÅ›liÄ‡, kiedy tak naprawdÄ™ moglibyÅ›my wrÃ³ciÄ‡ do stacjonarnej formy przeprowadzania kolejnych edycji, a jednoczeÅ›nie nie chcieliÅ›my czekaÄ‡ z zaÅ‚oÅ¼onymi rÄ™kami na rozwÃ³j sytuacji.Dodatkowo, zdalna forma organizacji meetupÃ³w nie jest dla nas caÅ‚kowitÄ… nowoÅ›ciÄ… - wszystkie dotychczasowe edycje Consdata Tech, poza tym, Å¼e odbywaÅ‚y siÄ™ w formie stacjonarnej, byÅ‚y rÃ³wnieÅ¼ transmitowane na Å¼ywo w internecie. Mamy juÅ¼ w zwiÄ…zku z tym rozpracowane  sporo rozwiÄ…zaÅ„ typowych dla zdalnej formy organizacji spotkaÅ„ technicznych, co uÅ‚atwiÅ‚o nam decyzjÄ™ o przejÅ›ciu na formÄ™ webinarÃ³w - po prostu nie jest to dla nas skok w kompletnie nieznane.Ostatnim powodem, ktÃ³ry ostatecznie przekonaÅ‚ nas do tej formy, jest ogÃ³lna zmiana podejÅ›cia do pracy oraz komunikacji przez internet. To co dla wielu z nas jeszcze niedawno byÅ‚o marzeniem - w peÅ‚ni zdalna praca - dzisiaj jest rzeczywistoÅ›ciÄ…, nie tylko w branÅ¼y IT. OdcisnÄ™Å‚o to swoje piÄ™tno nie tylko na sposobie pracy, ale teÅ¼ na inicjatywach pokroju Consdata Tech. Meetupy, spotkania i konferencje organizowane w formie onlineâ€™owej sÄ… dzisiaj dla uczestnikÃ³w rÃ³wnie naturalne, co jeszcze niedawno stacjonarne. Z tÄ… moÅ¼e rÃ³Å¼nicÄ…, Å¼e ciÄ™Å¼ej jest siÄ™ obÅ‚owiÄ‡ w siatkÄ™ peÅ‚nÄ… gadÅ¼etÃ³w ğŸ˜‰Jakie bÄ™dÄ… najwiÄ™ksze zmiany wzglÄ™dem poprzednich edycji. JuÅ¼ wiemy, Å¼e na pewno forma - ale na co jeszcze powinni siÄ™ nastawiaÄ‡ dotychczasowi uczestnicy?Faktycznie, poza samÄ… formÄ… pojawiÅ‚o siÄ™ kilka istotnych zmian. Prawdopodobnie najwiÄ™ksza z nich dotyczy dÅ‚ugoÅ›ci trwania samego wydarzenia, a takÅ¼e jego czÄ™stotliwoÅ›ci. Dotychczas, jeszcze w tradycyjnej formie stacjonarnego meetupu, skÅ‚adaÅ‚o siÄ™ na niego kilka prelekcji - okoÅ‚o trzech, czterech, a sam meetup odbywaÅ‚ siÄ™ raz na pÃ³Å‚ roku. Nowa forma pozwoliÅ‚a nam na bardziej elastyczne podejÅ›cie do tematu - webinar bÄ™dzie obejmowaÅ‚ tylko jednÄ… prelekcjÄ™, a same webinary odbywaÄ‡ siÄ™ bÄ™dÄ… w odstÄ™pie okoÅ‚o miesiÄ…ca. Czujemy, Å¼e taka forma bÄ™dzie wygodniejsza dla uczestnikÃ³w - proÅ›ciej znaleÅºÄ‡ godzinÄ™ w ciÄ…gu dnia na wysÅ‚uchanie pojedynczej prelekcji, niÅ¼ wygospodarowaÄ‡ sporÄ… czÄ™Å›Ä‡ wieczoru. OczywiÅ›cie takie zaÅ‚oÅ¼enie jest prawdziwe jedynie dla zdalnej formy wydarzenia - w przypadku wydarzeÅ„ stacjonarnych szkoda zachodu staÄ‡ w korkach dla pojedynczej prelekcji.JednÄ… z wiÄ™kszych wartoÅ›ci dotychczasowych edycji byÅ‚a jej praktycznoÅ›Ä‡ oraz to, Å¼e uczestnicy czÄ™sto wdawali siÄ™ w dyskusjÄ™ z prelegentami odnoÅ›nie treÅ›ci wystÄ…pieÅ„. Czy nie boicie siÄ™ zmiana formy na webinarowÄ… sprawi, Å¼e trudniej bÄ™dzie utrzymaÄ‡ ten poziom?MyÅ›lÄ™, Å¼e nie. Ostatnie pÃ³Å‚ roku dobitnie pokazaÅ‚o, Å¼e komunikujÄ…c siÄ™ zdalnie moÅ¼na osiÄ…gnÄ…Ä‡ bardzo wiele, a webinary i ich praktycznoÅ›Ä‡ nie sÄ… tutaj wyjÄ…tkiem. Co wiÄ™cej, taka forma otwiera przed nami moÅ¼liwoÅ›ci, ktÃ³rych wczeÅ›niej nie mieliÅ›my - dziÄ™ki wykorzystaniu lightboarda zyskujemy dodatkowe medium prezentacji informacji oraz interakcji z uczestnikami. OdnoÅ›nie dyskusji z prelegentem - juÅ¼ w trakcie pierwszych edycji istniaÅ‚a moÅ¼liwoÅ›Ä‡ zadawania pytaÅ„ za poÅ›rednictwem internetu, takÅ¼e taka forma nie jest dla nas nowoÅ›ciÄ…, i wierzymy, Å¼e sprawdzi siÄ™ i tym razem.OczywiÅ›cie stacjonarne meetupy majÄ… swoje niezaprzeczalne zalety - inne nawet niÅ¼ darmowa pizza ğŸ˜‰ Zdalnie ciÄ™Å¼ko jest zadbaÄ‡ choÄ‡by o networking, i to faktycznie jest cena, ktÃ³rÄ… ponosimy za zmianÄ™ formy organizacji eventu.PomÃ³wmy trochÄ™ o tematyce Consdata Tech. Czy poszczegÃ³lne webinary bÄ™dÄ… ze sobÄ… tematycznie powiÄ…zane?Dotychczas kaÅ¼da z edycji oscylowaÅ‚a wokÃ³Å‚ jednego konkretnego tematu - Event Sourcing, Mikrofrontendy, OpenShift. Dzieki temu osoby zainteresowane konkretnym tematem, np. mikrofrontendami, otrzymywaÅ‚y skondensowanÄ… dawkÄ™ wiedzy na ten temat, nierzadko z rÃ³Å¼nych punktÃ³w widzenia. W nowym podejÅ›ciu zdecydowaliÅ›my siÄ™ od tego odejÅ›Ä‡ - przede wszystkim dlatego, Å¼e webinary bÄ™dÄ… organizowane pojedynczo, wiÄ…zanie ich tematycznie byÅ‚oby sztuczne. DziÄ™ki temu jednak zyskaliÅ›my swobodÄ™, ktÃ³ra pozwala nam poruszaÄ‡ zupeÅ‚nie rÃ³Å¼ne tematy w ramach poszczegÃ³lnych spotkaÅ„. Na pierwszym webinerze Marek PaweÅ‚czyk opowie o reaktywnym programowaniu biorÄ…c na warsztat framework Spring Webflux. Nie oznacza to jednak, Å¼e kolejne rÃ³wnieÅ¼ bÄ™dÄ… dotyczyÅ‚y tej tematyki. MyÅ›lÄ™, Å¼e mogÄ™ uchyliÄ‡ rÄ…bka tajemnicy i zdradziÄ‡, Å¼e kolejny webinar bÄ™dzie dotyczyÅ‚ miÄ™dzy innymi Domain Driven Designu.Na koniec jeszcze jedno, bardzo ogÃ³lne pytanie- zaÅ‚Ã³Å¼my Å¼e ktoÅ› dotychczas nie uczestniczyÅ‚ w Consdata Tech - dlaczego miaÅ‚by doÅ‚Ä…czyÄ‡?OczywiÅ›cie z uwagi na ciekawe prelekcje! DuÅ¼Ä… wagÄ™ przykÅ‚adamy nie tylko do tego, aby prezentacje dotyczyÅ‚y aktualnych trendÃ³w i technologii w IT, ale teÅ¼ do interesujÄ…cej formy. Ostatecznie kaÅ¼dy moÅ¼e zajrzeÄ‡ do dokumentacji, ale nie o to przecieÅ¼ chodzi. ZaleÅ¼y nam na tym, aby nawet pozornie zawiÅ‚e kwestie przedstawiÄ‡ w zrozumiaÅ‚y sposÃ³b - tak, aby kaÅ¼dy z uczestnikÃ³w poczuÅ‚, Å¼e byÅ‚o warto ğŸ™‚DziÄ™kujÄ™ za rozmowÄ™.RozmawiaÅ‚ Adam Pijanowski - Specjalista ds. EB &amp;amp; KomunikacjiDoÅ‚Ä…cz do wydarzenia poprzez Facebook lub MeetUp.",
"url": "/2020/11/04/nowa-forma-meetupu.html",
"author": "Marcin Mergo",
"authorUrl": "/authors/mmergo.html",
"image": "mmergo.webp",
"highlight": "/assets/img/posts/2020-11-04-nowa-forma-meetupu/consdata_tech_webinar.jpeg",
"date": "04-11-2020",
"path": "pl/2020-11-04-nowa-forma-meetupu"
}
,


"2020-11-03-proces-migracji-do-chmury-html": {
"title": "Migracja do chmury - czyli od czego zaczÄ…Ä‡?",
"lang": "pl",
"tags": "cloud serverless gcp aws azure googlecloud",
"content": "PlanujÄ…c migracjÄ™ systemu informatycznego do chmury, zastanawiamy siÄ™ od czego zaczÄ…Ä‡? Proces migracji skÅ‚ada siÄ™ z kilku etapÃ³w, ktÃ³re pomogÄ… nam przejÅ›Ä‡ z punktu A (systemu ÅºrÃ³dÅ‚owego), do punktu B (systemu docelowego).Przed rozpoczÄ™ciem lektury warto zapoznaÄ‡ siÄ™ z wpisem Grzegorza pt.â€œW chmurze czyli jak? O moÅ¼liwych kierunkach rozwoju aplikacji chmurowychâ€ktÃ³ry przedstawia poszczegÃ³lne modele wdroÅ¼enia w chmurze.SwojÄ… wiedzÄ™ opieraÄ‡ bÄ™dÄ™ na doÅ›wiadczeniach z chmurÄ… Google (Google Cloud Platform, GCP), dlatego w tekÅ›cie bÄ™dÄ™ nawiÄ…zywaÅ‚ do usÅ‚ug i pojÄ™Ä‡ zwiÄ…zanych z tÄ… platformÄ….SzacowaniePierwszym z etapÃ³w migracji do chmury jest etap szacowania, na ktÃ³rym przeprowadzona zostaje dokÅ‚adna analiza istniejÄ…cego systemu oraz infrastruktury.Podczas szacowania analizujemy wykorzystywane zasoby, zaleÅ¼noÅ›ci pomiÄ™dzy elementami systemu oraz wymagania.Wybieramy te elementy systemu, ktÃ³re chcemy przenieÅ›Ä‡ do chmury, co pozwoli na obliczenie dokÅ‚adnych kosztÃ³w utrzymania infrastruktury.W przypadku kiedy przenosimy maszyny wirtualne, szacujemy zasoby, ktÃ³re sÄ… nam potrzebne, aby okreÅ›liÄ‡ np. typ maszyn Compute Engine oraz ich parametry.JeÅ›li znamy juÅ¼ dokÅ‚adnie system ÅºrÃ³dÅ‚owy i jego wymagania, musimy zapoznaÄ‡ siÄ™ z platformÄ… usÅ‚ugodawcy, do ktÃ³rego bÄ™dziemy migrowaÄ‡ nasz system. PrÃ³g wejÅ›cia bÄ™dzie tutaj zaleÅ¼aÅ‚ od modelu wdroÅ¼enia, poniewaÅ¼ w zaleÅ¼noÅ›ci od niego musimy poznaÄ‡ mniej lub bardziej caÅ‚Ä… platformÄ™.Pierwszy etap migracji jest tym miejscem, w ktÃ³rym zapoznajemy siÄ™ z moÅ¼liwoÅ›ciami chmury oraz zdobywamy potrzebne do migracji kompetencje (na przykÅ‚ad poprzez szkolenia czy certyfikacje).PomÃ³c moÅ¼e nam w tym rÃ³wnieÅ¼ przetestowanie platformy, wdroÅ¼enie PoC oraz eksperymenty, ktÃ³re pozwolÄ… rozwiaÄ‡ wszelkie wÄ…tpliwoÅ›ci i przewidzieÄ‡ potencjalne problemy.RozwaÅ¼yÄ‡ naleÅ¼y miÄ™dzy innymi:  porÃ³wnanie wydajnoÅ›ci i moÅ¼liwoÅ›ci aktualnej bazy danych z usÅ‚ugami bazodanowymi w chmurze (np. Cloud SQL, Cloud Firestore, Cloud Spanner),  przetestowanie opÃ³ÅºnieÅ„ sieciowych,  zastÄ…pienie mechanizmÃ³w logowania oraz monitorowania aplikacji przez dedykowane usÅ‚ugi (np. Operations/Stackdriver),  przetestowanie wydajnoÅ›ci funkcji (np. Cloud Functions) oraz ich problemu z tzw. zimnym startem (cold start), ktÃ³ry moÅ¼e zdyskwalifikowaÄ‡ wykorzystanie ich w systemie docelowym,  porÃ³wnanie czasÃ³w budowania, wdraÅ¼ania i uruchamiania aplikacji (on-premises vs infrastruktura w chmurze),  koszty migracji i utrzymania systemu docelowego w zaleÅ¼noÅ›ci od zastosowanego modelu (IaaS, PaaS, CaaS, FaaS).PowinniÅ›my rÃ³wnieÅ¼ ustaliÄ‡ kolejnoÅ›Ä‡ migrowanych elementÃ³w, zaczynajÄ…c od mniej zÅ‚oÅ¼onych aplikacji, co pozwoli nabraÄ‡ doÅ›wiadczenia i ograniczyÄ‡ ryzyko. ZdobytÄ… wiedzÄ™ wykorzystamy pÃ³Åºniej podczas migracji bardziej zÅ‚oÅ¼onych systemÃ³w. DziÄ™ki temu programiÅ›ci bÄ™dÄ… mogli uruchamiaÄ‡ i testowaÄ‡ pierwsze aplikacje w chmurze, skupiajÄ…c siÄ™ na samej migracji, a nie zÅ‚oÅ¼onoÅ›ci systemu.Aplikacje bÄ™dÄ…ce dobrymi kandydatami:  nie sÄ… krytyczne pod wzglÄ™dem biznesowym, co zmniejsza ryzyko migracji,  mogÄ… byÄ‡ przydatne do zbudowania bazy wiedzy,  sÄ… wspierane przez zespÃ³Å‚ developerski, ktÃ³ry jest zmotywowany do zdobycia kompetencji w pracy z chmurÄ…,  sÄ… bezstanowe (stateless), czyli nie przechowujÄ… Å¼adnych informacji pomiÄ™dzy interakcjami (np. sesji uÅ¼ytkownika) i majÄ… maÅ‚Ä… liczbÄ™ zaleÅ¼noÅ›ci(takie aplikacje sÄ… Å‚atwiejsze do przeniesienia i nie pociÄ…gajÄ… za sobÄ… potrzeby przeniesienia innych elementÃ³w systemu),  wymagajÄ… minimalnych zmian w kodzie i konfiguracji,  nie wymagajÄ… przenoszenia duÅ¼ych iloÅ›ci danych,  nie wymagajÄ… licencji innych firm, poniewaÅ¼ niektÃ³rzy dostawcy nie licencjonujÄ… swoich produktÃ³w w chmurze lub mogÄ… wymagaÄ‡ zmiany typu licencji,  nie sÄ… wraÅ¼liwe na przestÃ³j spowodowany migracjÄ…, co pozwala na Å‚atwiejsze zaplanowanie migracji danych z bazy.Przydatne mogÄ… okazaÄ‡ siÄ™ narzÄ™dzia takie jak Google Cloud Pricing Calculator (ktÃ³ry pomoÅ¼e nam obliczyÄ‡ koszt utrzymania infrastruktury w chmurze Google) czy CloudPhysics (ktÃ³re pozwoli nam zarzÄ…dzaÄ‡ wÅ‚asnÄ… infrastrukturÄ…, porÃ³wnaÄ‡ koszty utrzymania infrastruktury on-premises vs chmura oraz wybraÄ‡ te elementy, ktÃ³rych migracja do chmury przyniesie najwiÄ™cej korzyÅ›ci).Efektem etapu szacowania jest szczegÃ³Å‚owa analiza systemu ÅºrÃ³dÅ‚owego, okreÅ›lone wymagania i wykorzystywane zasoby oraz posiadane licencje na oprogramowanie.W wyniku takiej analizy moÅ¼e okazaÄ‡ siÄ™, Å¼e niektÃ³re elementy nie mogÄ… zostaÄ‡ przeniesione do chmury.Powody mogÄ… byÄ‡ rÃ³Å¼ne:  wymagania co do lokalizacji zapisanych danych,  specyficzne systemy operacyjne,  oprogramowanie ktÃ³rego nie oferuje chmura,  obostrzenia wynikajÄ…ce z licencji,  zbyt duÅ¼e ryzyko lub brak opÅ‚acalnoÅ›ci migracji.PlanowanieDrugim z etapÃ³w migracji do chmury jest etap planowania, na ktÃ³rym powstaje podstawowa infrastruktura w chmurze oraz planowane jest przeniesienie systemu.Planowanie obejmuje takie elementy jak zarzÄ…dzanie toÅ¼samoÅ›ciÄ…, struktura i organizacja projektu w GCP, infrastruktura sieci oraz komunikacja pomiÄ™dzy elementami systemu.Wybrana zostaje rÃ³wnieÅ¼ strategia migracji, co zostaÅ‚o opisane w dalszej czÄ™Å›ci.Etap ten jest Å›ciÅ›le zwiÄ…zany z konkretnÄ… platformÄ…, poniewaÅ¼ od niej zaleÅ¼Ä… czynnoÅ›ci ktÃ³re naleÅ¼y wykonaÄ‡.W przypadku Google Cloud Platform musimy:  skonfigurowaÄ‡ uÅ¼ytkownikÃ³w i konta systemowe (Google Accounts, Service Accounts, Google Groups, G Suite domains, Cloud Identity domains),  zaprojektowaÄ‡ strukturÄ™ zasobÃ³w (organizacje, foldery, projekty),  zdefiniowaÄ‡ grupy i role posiadajÄ…ce uprawnienia do tych zasobÃ³w (minimum to: organization admin, network admin, security admin, billing admin),  zaprojektowaÄ‡ topologiÄ™ sieci i skonfigurowaÄ‡ poÅ‚Ä…czenie istniejÄ…cego Å›rodowiska z chmurÄ… (minimum to przynajmniej jedna sieÄ‡ VPC).Do poÅ‚Ä…czenia wÅ‚asnej infrastruktury z chmurÄ… moÅ¼na wykorzystaÄ‡ poÅ‚Ä…czenia hybrydowe, takie jak: Internet publiczny, Cloud VPN, Peering (Direct/Carrier), Cloud Interconnect (Dedicated/Partner).Efektem etapu planowania jest gotowy plan migracji oraz architektura systemu w chmurze.Plan migracji uwzglÄ™dnia elementy, ktÃ³re bÄ™dÄ… przenoszone do chmury, zasoby, ktÃ³re bÄ™dÄ… wykorzystywane, szacowane koszty utrzymania systemu docelowego oraz listÄ™ rzeczy niezbÄ™dnych do wykonania przed rozpoczÄ™ciem migracji.Strategie migracjiPodczas etapu planowania wybieramy strategiÄ™ migracji, ktÃ³ra wpÅ‚ywa na to jak wyglÄ…daÄ‡ bÄ™dzie system docelowy, w jakim modelu zostanie on wdroÅ¼ony, ile bÄ™dzie kosztowaÅ‚a sama migracja oraz jakie bÄ™dÄ… pÅ‚ynÄ…Ä‡ z niej korzyÅ›ci.Na wybÃ³r strategii wpÅ‚ywa wiele czynnikÃ³w:  Infrastruktura ÅºrÃ³dÅ‚owa - czy jest to on-premises, prywatny hosting czy inna publiczna chmura?  ZÅ‚oÅ¼onoÅ›Ä‡ systemu - czy moÅ¼na go Å‚atwo przepisaÄ‡ na natywne rozwiÄ…zania chmurowe lub zastÄ…piÄ‡ usÅ‚ugami SaaS?  BudÅ¼et - czy proces migracji moÅ¼na wydÅ‚uÅ¼yÄ‡ w czasie, obniÅ¼ajÄ…c dziÄ™ki temu koszty z nim zwiÄ…zane?  Czas - czy migracja musi odbyÄ‡ siÄ™ w okreÅ›lonym czasie, np. w celu zwolnienia zasobÃ³w, czy moÅ¼e byÄ‡ wykonywana w dÅ‚uÅ¼szej perspektywie czasu?  Kompetencje - czy dobrze znana jest platforma docelowa, czy moÅ¼na poÅ›wiÄ™ciÄ‡ czas na zdobycie nowych kompetencji?Strategia â€œLift and shiftâ€Lift and shift - czyli â€œpodnieÅ› i przesuÅ„â€, jest strategiÄ…, w ktÃ³rej system przenoszony jest do chmury z minimalnÄ… liczbÄ… modyfikacji.Ewentualne zmiany sÄ… zwiÄ…zane tylko z przystosowaniem systemu do infrastruktury docelowej.Jest to najszybszy sposÃ³b na migracjÄ™, poniewaÅ¼ iloÅ›Ä‡ zmian jest ograniczona do minimum.StrategiÄ™ â€œlift and shiftâ€ wybiera siÄ™ wtedy, kiedy system ma zostaÄ‡ przeniesiony do chmury w jak najkrÃ³tszym czasie.RÃ³wnieÅ¼ ograniczona moÅ¼liwoÅ›Ä‡ modyfikacji aplikacji (lub jej brak) oraz koszty z tym zwiÄ…zane mogÄ… byÄ‡ powodem wyboru te strategii.Zalety:  szybkoÅ›Ä‡ procesu migracji i niskie koszty z tym zwiÄ…zane,  niewielkie ryzyko i niski prÃ³g wejÅ›cia (programiÅ›ci wykorzystujÄ… znane im rozwiÄ…zania, np. migrujÄ…c maszyny wirtualne do Compute Engine czy kontenery z orkiestracji Kubernetes/OpenShift do Google Kubernetes Engine (GKE)),  moÅ¼liwoÅ›Ä‡ automatyzacji (np. wykorzystujÄ…c narzÄ™dzie Migrate for Compute Engine).Wady:  brak wykorzystania natywnych rozwiÄ…zaÅ„ chmury (np. skalowania horyzontalnego, usÅ‚ug SaaS),  droÅ¼sza i trudniejsza w utrzymaniu infrastruktura docelowa,  duÅ¼a odpowiedzialnoÅ›Ä‡ za system docelowy po naszej stronie.Strategia â€œImprove and moveâ€Improve and move - czyli â€œulepsz i przenieÅ›â€, to strategia, podczas ktÃ³rej dokonywane sÄ… modyfikacje unowoczeÅ›niajÄ…ce system o rozwiÄ…zania chmurowe.Modyfikacje te sÄ… wykonywane w celu wykorzystywania natywnych moÅ¼liwoÅ›ci chmury, a nie tylko przystosowania systemu do nowej infrastruktury.PozwalajÄ… one ulepszyÄ‡ system pod kÄ…tem wydajnoÅ›ci, funkcjonalnoÅ›ci, kosztÃ³w utrzymania oraz wraÅ¼enia na uÅ¼ytkowniku koÅ„cowym.StrategiÄ™ â€œimprove and moveâ€ wybiera siÄ™ wtedy, kiedy architektura systemu umoÅ¼liwia Å‚atwe i szybkie przepisanie lub zastÄ…pienie pewnych elementÃ³w usÅ‚ugami SaaS,ale nie moÅ¼emy z jakiegoÅ› powodu przepisaÄ‡ caÅ‚ego systemu, w celu wykorzystania wszystkich rozwiÄ…zaÅ„ chmurowych.NiezbÄ™dne do tego celu jest lepsze poznanie moÅ¼liwoÅ›ci oferowanych przez chmurÄ™ (wyÅ¼szy prÃ³g wejÅ›cia) oraz poÅ›wiÄ™cenie wiÄ™kszej iloÅ›ci czasuna przystosowanie systemu do nowej infrastruktury.Zalety:  wykorzystanie niektÃ³rych natywnych rozwiÄ…zaÅ„ chmury, ktÃ³re wpÅ‚ywajÄ… bezpoÅ›rednio na dostÄ™pnoÅ›Ä‡ systemu, jego bezpieczeÅ„stwo oraz wydajnoÅ›Ä‡,  niÅ¼sze koszty utrzymania infrastruktury docelowej niÅ¼ w przypadku strategii â€œlift and shiftâ€,  przeniesienie czÄ™Å›ci odpowiedzialnoÅ›ci za system docelowy na operatora chmury,  podczas modyfikacji moÅ¼na dodatkowo zastosowaÄ‡ rozwiÄ…zania, ktÃ³re uÅ‚atwiÄ… w przyszÅ‚oÅ›ci migracjÄ™ do innych platform.Wady:  dÅ‚uÅ¼szy czas migracji niÅ¼ w przypadku strategii â€œlift and shiftâ€ oraz wyÅ¼sze koszty z tym zwiÄ…zane,  nadal brak wykorzystywania peÅ‚ni moÅ¼liwoÅ›ci chmury.Strategia â€œRip and replaceâ€Rip and replace - czyli â€œzniszcz i zastÄ…pâ€, to strategia, w ktÃ³rej wykorzystujemy w peÅ‚ni natywne rozwiÄ…zania chmury, modyfikujÄ…c lub caÅ‚kowicie zastÄ™pujÄ…c elementy systemu ÅºrÃ³dÅ‚owego.Modyfikacje mogÄ… polegaÄ‡ na przepisaniu aplikacji np. na funkcje lub na zastÄ…pieniu pewnych elementÃ³w usÅ‚ugami SaaS (np. bazy danych czy kolejki).StrategiÄ™ â€œrip and replaceâ€ wybiera siÄ™ wtedy, kiedy jakiÅ› element systemu ÅºrÃ³dÅ‚owego nie speÅ‚nia oczekiwaÅ„ lub wymagaÅ„ i moÅ¼e zostaÄ‡ caÅ‚kowicie przepisany lub zastÄ…piony usÅ‚ugÄ… SaaS.Taka zmiana pozwoli wykorzystaÄ‡ natywne rozwiÄ…zania chmury, ktÃ³re zapewniÄ… skalowanie horyzontalne, wysokÄ… wydajnoÅ›Ä‡ i dostÄ™pnoÅ›Ä‡ systemu, wiÄ™ksze bezpieczeÅ„stwo, optymalizacjÄ™ kosztÃ³w utrzymania oraz minimalnÄ… odpowiedzialnoÅ›Ä‡ po stronie uÅ¼ytkownika (patrz wykres odpowiedzialnoÅ›ci we wpisie Grzegorza).Zalety:  wykorzystujemy w peÅ‚ni natywne rozwiÄ…zania oferowane przez chmurÄ™, ktÃ³re pozytywnie wpÅ‚ywajÄ… na wydajnoÅ›Ä‡, dostÄ™pnoÅ›Ä‡ i bezpieczeÅ„stwo systemu,  przepisujÄ…c lub zastÄ™pujÄ…c elementy systemu eliminujemy dÅ‚ug techniczny,  usÅ‚ugi SaaS zapewniajÄ… aktualizacje przeÅºroczyste dla dziaÅ‚ania systemu,  rozwiÄ…zania w modelu FaaS/SaaS mogÄ… nie generowaÄ‡ Å¼adnych kosztÃ³w w przypadku braku ruchu uÅ¼ytkownikÃ³w, dziÄ™ki czemu minimalizujemy koszty utrzymania,  zmniejszamy naszÄ… odpowiedzialnoÅ›Ä‡ za system docelowy (konfiguracja, zarzÄ…dzanie, skalowanie, klastrowanie, bezpieczeÅ„stwo i wiele wiÄ™cej), dziÄ™ki czemu stajemy siÄ™ mniej DevOps, a bardziej NoOps.Wady:  bardzo wysoki prÃ³g wejÅ›cia, poniewaÅ¼ musimy dokÅ‚adnie poznaÄ‡ wszystkie usÅ‚ugi i rozwiÄ…zania, jakie oferuje dana platforma,  wysokie ryzyko migracji, poniewaÅ¼ natywne rozwiÄ…zania chmury mogÄ… mieÄ‡ swoje ograniczenia (np. konkretne API),  wysoki koszt i czasochÅ‚onnoÅ›Ä‡ migracji,  uzaleÅ¼nianie siÄ™ od operatora chmury (vendor lock-in).WdraÅ¼anieTrzecim z etapÃ³w migracji do chmury jest etap wdraÅ¼ania, na ktÃ³rym projektujemy, implementuje oraz wdraÅ¼amy system docelowy w chmurze.CzÄ™Å›Ä‡ elementÃ³w systemu moÅ¼e zostaÄ‡ przeniesiona bez wiÄ™kszych zmian, inne zaÅ› wymagaÄ‡ mogÄ… gruntownej refaktoryzacji lub zastÄ…pienia innym rozwiÄ…zaniem (np. usÅ‚ugami SaaS).NiezbÄ™dne sÄ… rÃ³wnieÅ¼ takie elementy jak CI/CD, czyli proces budowania i wdraÅ¼ania aplikacji (wykorzystujÄ…cy na przykÅ‚ad Terraform oraz usÅ‚ugÄ™ Cloud Build). Konieczne moÅ¼e okazaÄ‡ siÄ™ rÃ³wnieÅ¼ dopracowanie infrastruktury w chmurze, aby sprostaÄ‡ wymaganiom systemu.Do wyboru mamy nastÄ™pujÄ…ce procesy wdraÅ¼ania:  WdraÅ¼anie rÄ™czne - pozwala na szybkie testowanie i eksperymentowanie z chmurÄ…, ale jest podatne na bÅ‚Ä™dy, czÄ™sto niepowtarzalne.Zasoby moÅ¼na tworzyÄ‡ rÄ™cznie z poziomu Google Cloud Console, a polecenia mogÄ… byÄ‡ wprowadzane z poziomu terminala lokalnego lub Cloud Shell.  NarzÄ™dzia do wdraÅ¼ania - takie jak Ansible, Chef, Puppet czy SaltStack umoÅ¼liwiajÄ… konfigurowanie Å›rodowiska w sposÃ³b zautomatyzowany, powtarzalny oraz kontrolowany.NarzÄ™dzia te nie umoÅ¼liwiajÄ… jednak wdraÅ¼ania bezprzerwowego lub typu Blue-Green (niektÃ³re umoÅ¼liwiajÄ… implementacjÄ™ wÅ‚asnej logiki wdraÅ¼ania, ale jest to dodatkowym obciÄ…Å¼eniem).  Orkiestracja kontenerÃ³w - jeÅ¼eli aplikacje zostanÄ… skonteneryzowane, moÅ¼na skorzystaÄ‡ z usÅ‚ugi Google Kubernetes Engine (GKE).Kubernetes nie tylko zarzÄ…dza, automatyzuje i skaluje aplikacje kontenerowe, ale oferuje rÃ³wnieÅ¼ wiele metod bezprzerwowego wdraÅ¼ania.  Automatyzacja wdraÅ¼ania - wdraÅ¼ajÄ…c proces CI/CD, moÅ¼na zautomatyzowaÄ‡ budowanie i wdraÅ¼anie aplikacji.  Infrastruktura jako kod (IaC) - rozwiÄ…zanie to pozwala w sposÃ³b deklaratywny tworzyÄ‡ zasoby i wdraÅ¼aÄ‡ aplikacje.UmoÅ¼liwia to rÃ³wnieÅ¼ utworzenie testÃ³w do kodu tworzÄ…cego infrastrukturÄ™.Aby zaimplementowaÄ‡ infrastrukturÄ™ jako kod, moÅ¼na wykorzystaÄ‡ Cloud Deployment Manager lub jego alternatywÄ™ w postaci Terraform,ktÃ³ry umoÅ¼liwi wdroÅ¼enie nie tylko w chmurze Google.W przypadku migracji maszyn wirtualnych (VMware vSphere, Amazon AWS, Microsoft Azure) do GCP, moÅ¼emy skorzystaÄ‡ z narzÄ™dzia Migrate for Compute Engine, ktÃ³re zautomatyzuje ten proces.Efektem etapu wdraÅ¼ania jest gotowy i dziaÅ‚ajÄ…cy system w architekturze chmurowej. Skonfigurowane sÄ… takie elementy jak sieÄ‡, uprawnienia, skalowanie czy monitoring aplikacji.OptymalizacjaOstatnim i czwartym z etapÃ³w migracji do chmury jest etap optymalizacji, na ktÃ³rym monitoruje siÄ™ dziaÅ‚ajÄ…cy system w celu optymalizacji jego dziaÅ‚ania.Podczas optymalizacji wykonujemy testy wydajnoÅ›ciowe, ktÃ³re moÅ¼emy porÃ³wnaÄ‡ z testami systemu ÅºrÃ³dÅ‚owego oraz konfigurujemy wykorzystywane usÅ‚ugi i zasoby tak, aby system dziaÅ‚aÅ‚ stabilnie, bezawaryjnie oraz wydajnie.Optymalizacja aplikacji w chmurze moÅ¼e byÄ‡ rÃ³wnieÅ¼ efektem zmian usÅ‚ug platformy chmurowej - na przykÅ‚ad nowym API, nowymi funkcjami lub nowymi usÅ‚ugami.RÃ³wnieÅ¼ nabieranie doÅ›wiadczenia i kompetencji przez zespÃ³Å‚ programistÃ³w moÅ¼e byÄ‡ powodem pÃ³Åºniejszych usprawnieÅ„ systemu w chmurze.Z czasem coraz wiÄ™cej elementÃ³w infrastruktury zostaje zautomatyzowanych, co redukuje koszty utrzymania oraz czas wdraÅ¼ania aplikacji.ZastÄ™powane sÄ… rÃ³wnieÅ¼ kolejne elementy infrastruktury usÅ‚ugami SaaS, dÄ…Å¼Ä…c do w peÅ‚ni natywnych rozwiÄ…zaÅ„ chmurowych.DziaÅ‚ajÄ…cy system jest optymalizowany pod kÄ…tem wykorzystywanych zasobÃ³w (na przykÅ‚ad zmieniajÄ…c typ maszyn Compute Engine), dostosowujÄ…c je do aktualnych wymagaÅ„, a takÅ¼e skonfigurowanezostaje automatyczne skalowanie.Przydatne mogÄ… okazaÄ‡ siÄ™ narzÄ™dzia z grupy Operations/Stackdriver, a takÅ¼e narzÄ™dzia i usÅ‚ugi przydatne w automatyzacji infrastruktury i procesu CI/CD (np. Terraform i Cloud Build).Proces optymalizacji nie ma swojego koÅ„ca, poniewaÅ¼ dziaÅ‚ajÄ…cy system moÅ¼e wymagaÄ‡ okresowych zmian w konfiguracji, aby sprostaÄ‡ nowym wymaganiom i obciÄ…Å¼eniu generowanemu przezuÅ¼ytkownikÃ³w. PowinniÅ›my stale analizowaÄ‡ miesiÄ™czne koszty utrzymania, trendy i produkty, ktÃ³re sÄ… wykorzystywane najczÄ™Å›ciej.DziÄ™ki temu moÅ¼na zmniejszaÄ‡ koszty, na przykÅ‚ad podpisujÄ…c umowy na korzystanie z Compute Engine (committed use discounts), czy zmieniajÄ…c model pÅ‚atnoÅ›ci za usÅ‚ugÄ™ BigQuery na flat-rate.Migracja do chmury - podsumowanieNa koniec chciaÅ‚bym zaznaczyÄ‡, Å¼e opisane tutaj strategie migracji mogÄ… byÄ‡ rÃ³Å¼nie opisywane w literaturze.MoÅ¼emy spotkaÄ‡ siÄ™ z artykuÅ‚ami opisujÄ…cymi 4 czy 6 strategii, np.â€œ6 Strategies for Migrating Applications to the Cloudâ€Opisywane strategie pokrywajÄ… siÄ™ mniej lub bardziej, a rozbieÅ¼noÅ›ci sÄ… spowodowane innym punktem widzenia (niekoniecznie programisty).NajwaÅ¼niejsze w migracji jest jednak to jak jÄ… zaczniemy. JeÅ›li zabierzemy siÄ™ do tego bez podstawowej wiedzy na temat platformy, z ktÃ³rej chcemy skorzystaÄ‡, to odbije siÄ™ to na wydÅ‚uÅ¼onym czasie migracji oraz niekoniecznie najlepszej architekturze systemu docelowego.Warto przed przystÄ…pieniem do planowania migracji zdobyÄ‡ odpowiednie kompetencje, a na pytanie czy jesteÅ›my na to gotowi moÅ¼e nam odpowiedzieÄ‡ np. Google Cloud Adoption Framework.",
"url": "/2020/11/03/proces-migracji-do-chmury.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2020-11-03-proces-migracji-do-chmury/clouds.jpeg",
"date": "03-11-2020",
"path": "pl/2020-11-03-proces-migracji-do-chmury"
}
,


"2020-10-21-modele-wdrozenia-w-chmurze-html": {
"title": "W chmurze czyli jak? O moÅ¼liwych kierunkach rozwoju aplikacji chmurowych",
"lang": "pl",
"tags": "cloud iaas caas paas faas gcp aws azure",
"content": "Co to znaczy byÄ‡ w chmurze? Co to wÅ‚aÅ›ciwie jest IaaS, PaaS, CaaS, FaaS? Jak przenieÅ›Ä‡ siÄ™ do chmury? Czy jestem juÅ¼ wystarczajÄ…co zachmurzony? JeÅ¼eli nie znasz odpowiedzi na ktÃ³rekolwiek z powyÅ¼szych pytaÅ„, to ten wpis jest stworzony specjalnie dla Ciebie!Czym wÅ‚aÅ›ciwie jest chmura? W uproszczeniu moÅ¼emy powiedzieÄ‡, Å¼e to dowolna usÅ‚uga (lub zestaw usÅ‚ug), ktÃ³ra dostarcza mechanizmy automatycznego tworzenia zasobÃ³w na Å¼Ä…danie i rozliczania ich zgodnie z faktycznym ich wykorzystaniem (The NIST Definition of Cloud Computing). Sama definicja jest rozlegÅ‚a i moÅ¼emy pod niÄ… umieÅ›ciÄ‡ wiele skrajnie rÃ³Å¼nych rozwiÄ…zaÅ„. W kolejnych akapitach przyjrzymy siÄ™ krÃ³tkiej charakterystyce podejÅ›Ä‡ oferowanych przez wiodÄ…cych dostawcÃ³w chmur publicznych.On-premises - wÅ‚asna infrastrukturaZanim omÃ³wimy podejÅ›cia do migracji w chmurze, okreÅ›lmy zgrubnie punkt wyjÅ›cia, do ktÃ³rego bÄ™dziemy odnosiÄ‡ kolejne modele wdroÅ¼eniowe:PowyÅ¼szy diagram przedstawia uproszczony model elementÃ³w, za ktÃ³re jesteÅ› odpowiedzialny wdraÅ¼ajÄ…c system we wÅ‚asnej serwerowni.IaaS - Infrastructure as a serviceDostawca chmury przejmuje odpowiedzialnoÅ›Ä‡ za fizyczny sprzÄ™t potrzebny do uruchomienia infrastruktury. UÅ¼ytkownik zarzÄ…dza systemem na poziomie konkretnych maszyn wirtualnych.W najbardziej oczywistym aspekcie mÃ³wimy o zakupie serwerÃ³w, ale naleÅ¼y uwzglÄ™dniÄ‡ teÅ¼ fizycznÄ… ochronÄ™ serwerowni, serwis i utrzymanie sprzÄ™tu, budowÄ™ sieci, koszty pomieszczeÅ„, opÅ‚at bieÅ¼Ä…cych i licencji. Do tego dochodzi koszt zatrudnienia i szkolenia administratorÃ³w o odpowiednich kompetencjach, koszt wypracowania standardÃ³w i konfiguracji, koÅ„czÄ…c na takich kwestiach, jak procedury migracji, disaster recovery czy tworzenie strategii rozwoju uwzglÄ™dniajÄ…cych zakup sprzÄ™tu potencjalnie potrzebnego w przyszÅ‚oÅ›ci.W uproszczeniu, IaaS zdejmuje z Ciebie takie zmartwienia, jak umierajÄ…ce dyski SSD czy telefon w Å›rodku nocy (bo  np. zabrakÅ‚o prÄ…du lub wÅ‚Ä…czyÅ‚ siÄ™ alarm przeciwpoÅ¼arowy) oraz ograniczenia sprzÄ™towe przy eksperymentowaniu czy planowaniu nowych produktÃ³w.W praktyce oznacza to, Å¼e na Å¼Ä…danie moÅ¼esz tworzyÄ‡ dowolnie skonfigurowane instancje maszyn wirtualnych spiÄ™tych w wirtualne sieci o dowolnej topologii. Dla maszyn, poza technicznymi parametrami, moÅ¼esz okreÅ›laÄ‡ dostÄ™pnoÅ›Ä‡ w sieci czy szczegÃ³Å‚owe uprawnienia dostÄ™pu.MigrujÄ…c w modelu IaaS zyskujesz:  fizyczne zabezpieczenie serwerowni,  bezpieczeÅ„stwo i ciÄ…gÅ‚oÅ›Ä‡ dziaÅ‚ania serwerÃ³w,  bezpieczny storage,  stabilnoÅ›Ä‡ i bezpieczeÅ„stwo sieci,  audytowalnoÅ›Ä‡ zmian i monitoring infrastruktury,  skalowanie liczby i rozmiaru maszyn pod bieÅ¼Ä…ce potrzeby.Nadal jednak musisz zajmowaÄ‡ siÄ™ bezpieczeÅ„stwem, aktualizacjami i konfiguracjÄ… systemÃ³w operacyjnych wdroÅ¼onych maszyn wirtualnych.W przypadku migracji systemu do modelu IaaS mÃ³wimy o podejÅ›ciu rehosting i jest to najprostszy model wdroÅ¼enia do chmury. ZakÅ‚ada jedynie przerzucenie (czy nawet import) systemÃ³w z aplikacjami do infrastruktury dostawcy. Koszt migracji jest minimalny, a dla legacy systemÃ³w drastycznie niÅ¼szy niÅ¼ w pozostaÅ‚ych modelach wdroÅ¼enia. Pomimo pierwszych zalet, w modelu IaaS trudno mÃ³wiÄ‡ o wdroÅ¼eniu chmurowym. Nadal nie wykorzystujesz w peÅ‚ni moÅ¼liwoÅ›ci niskokosztowej i skalowalnej infrastruktury.Model IaaS moÅ¼e byÄ‡ prostym pierwszym krokiem, ktÃ³ry pozwoli szybko wskoczyÄ‡ do publicznej chmury i otworzyÄ‡ moÅ¼liwoÅ›ci szerszej integracji z systemami dostawcy i przyrostowych zmian we wdraÅ¼anym systemie (ewolucja przez refaktoring, podmiana pojedynczych elementÃ³w czy integracja z konkretnymi usÅ‚ugami zamiast dÅ‚ugotrwaÅ‚ego przepisywania caÅ‚ego systemu od podstaw).CaaS - Container as a serviceDostawca chmury przejmuje odpowiedzialnoÅ›Ä‡ za utrzymanie maszyn wirtualnych obsÅ‚ugujÄ…cych infrastrukturÄ™. UÅ¼ytkownik zarzÄ…dza systemem na poziomie kontenerÃ³w aplikacji.Najpopularniejszym rozwiÄ…zaniem w tej kategorii jest klaster Kubernetes w peÅ‚ni zarzÄ…dzany przez dostawcÄ™ chmury. W praktyce zarzÄ…dzanie maszynami wirtualnymi zostaje ograniczone do zdefiniowania ich rozmiaru i liczby, a czasem wrÄ™cz do okreÅ›lenia limitÃ³w minimalnej i maksymalnej liczby wÄ™zÅ‚Ã³w. AktualizacjÄ™, konfiguracjÄ™, zabezpieczenie czy  monitorowanie systemÃ³w maszyn wirtualnych oddajesz w rÄ™ce specjalistÃ³w. DziÄ™ki temu moÅ¼esz skupiÄ‡ siÄ™ na tworzeniu niezawodnego oprogramowania.MigrujÄ…c w modelu CaaS zyskujesz:  aktualizacje i konfiguracje systemÃ³w maszyn wirtualnych,  bezpieczeÅ„stwo zainstalowanych na maszynach systemÃ³w operacyjnych,  aktualizacje, konfiguracje i bezpieczeÅ„stwo klastra dostarczanego przez dostawcÄ™,  rÃ³wnowaÅ¼enie obciÄ…Å¼enia hostÃ³w klastra i optymalizacjÄ™ kosztÃ³w dziaÅ‚ania systemu,  moÅ¼liwoÅ›ci skalowania i niezawodnoÅ›Ä‡ systemu wynikajÄ…ce z Å‚atwego powielania instancji aplikacji i wÄ™zÅ‚Ã³w klastra.DziÄ™ki abstrakcji na infrastrukturÄ™, ktÃ³rÄ… zapewnia konteneryzacja aplikacji moÅ¼esz skorzystaÄ‡ z gotowych usÅ‚ug dostarczanych przez dostawcÄ™ chmury. W zaleÅ¼noÅ›ci od operatora dostÄ™pne bÄ™dÄ… np. load balancer z firewallem i ochronÄ… przed DDoS, bezpieczny storage w postaci persistent volumes czy centralne zarzÄ…dzanie logami lub metrykami dziaÅ‚ania systemu. Dodatkowo, takie mechanizmy, jak kontrola uprawnieÅ„ czy skalowanie systemu, sÄ… juÅ¼ w standardzie.Jednym z najwaÅ¼niejszych ograniczeÅ„ w przypadku CaaS jest koniecznoÅ›Ä‡ peÅ‚nej obsÅ‚ugi stosu aplikacyjnego. PrzykÅ‚adowo, udostÄ™pniajÄ…c usÅ‚ugi HTTP musisz zadbaÄ‡ o uruchomienie, konfiguracjÄ™ i bezpieczeÅ„stwo serwera WWW, kontrolÄ™ dostÄ™pu do usÅ‚ugi czy poprawnÄ… konfiguracjÄ™ liczby wÄ…tkÃ³w i poÅ‚Ä…czenia do bazy danych, a nawet definicjÄ™ odpowiednich portÃ³w serwera i przygotowanie certyfikatÃ³w SSL. Migrowane aplikacje czÄ™sto bÄ™dÄ… wymagaÅ‚y zmiany w konfiguracji, czy nawet kodzie ÅºrÃ³dÅ‚owym, w celu dostosowania do infrastruktury i dostÄ™pnych usÅ‚ug. Bez tych zmian nie bÄ™dzie moÅ¼liwe peÅ‚ne wykorzystanie potencjaÅ‚u wdroÅ¼enia w chmurze.Dodatkowo naleÅ¼y pamiÄ™taÄ‡, Å¼e po stronie uÅ¼ytkownika pozostaje zapewnienie bezpieczeÅ„stwa i stabilnoÅ›ci dostarczanego kontenera. PrzykÅ‚adowo: przeprowadzanie analizy kontenerÃ³w pod kÄ…tem znanych podatnoÅ›ci, aktualizowanie oprogramowania i obrazÃ³w bazowych oraz rozwiÄ…zywanie problemÃ³w wynikajÄ…cych z bÅ‚Ä™dnie zdefiniowanych obrazÃ³w i deskryptorÃ³w wdroÅ¼enia.W przypadku modelu CaaS moÅ¼emy juÅ¼ mÃ³wiÄ‡ o strategii migracji typu refactoring. Nawet jeÅ¼eli unikniesz zmian funkcjonalnych w kodzie, bÄ™dziesz modyfikowaÅ‚ sposÃ³b wdraÅ¼ania aplikacji. W ramach migracji naleÅ¼y przeprowadziÄ‡ konteneryzacjÄ™ przenoszonych aplikacji i przygotowaÄ‡ deskryptory wdroÅ¼enia. Koszt migracji jest wiÄ™kszy niÅ¼ w przypadku modelu IaaS, ale moÅ¼liwe jest przygotowanie siÄ™ do migracji w ramach istniejÄ…cych wdroÅ¼eÅ„ przed rozpoczÄ™ciem faktycznych migracji w chmury. NaleÅ¼y oczywiÅ›cie zauwaÅ¼yÄ‡, Å¼e systemy juÅ¼ wdraÅ¼ane w kontenerach lub klastrach Kubernetes dostajÄ… moÅ¼liwoÅ›Ä‡ migracji do chmury przy minimalnych kosztach zmian.Model CaaS pozwala w praktyce wdroÅ¼yÄ‡ wiele rozwiÄ…zaÅ„ kojarzonych z publicznymi chmurami obliczeniowymi - skalowanie, niezawodnoÅ›Ä‡, szybkoÅ›Ä‡ zmian. Dla wielu bÄ™dzie to docelowy model wdroÅ¼enia w chmurze, optymalnie Å‚Ä…czÄ…cy koszt i zakres zmian z natychmiastowymi zyskami i moÅ¼liwoÅ›ciami dalszego rozwoju. Ewolucyjna natura podejÅ›cia, moÅ¼liwoÅ›Ä‡ migracji do innego dostawcy czy nawet powrÃ³t do wdroÅ¼eÅ„ on-premises bÄ™dÄ… przemawiaÄ‡ za modelem CaaS.PaaS - Platform as a serviceDostawca chmury przejmuje odpowiedzialnoÅ›Ä‡ za wdroÅ¼enie i utrzymanie aplikacji. UÅ¼ytkownik zarzÄ…dza systemem na poziomie pojedynczych aplikacji.W modelu PaaS to dostawca chmury odpowiedzialny jest za budowanie i osadzanie aplikacji oraz utrzymanie kompletnej infrastruktury. Platforma dostarcza rozszerzenia zapewniajÄ…ce prostÄ… konfiguracjÄ™ i integracjÄ™ tworzonych aplikacji z usÅ‚ugami dostÄ™pnymi w chmurze. Osadzana usÅ‚uga bÄ™dzie miaÅ‚a zapewnione wsparcie dla monitorowania, uwierzytelniania czy komunikacji HTTPS na poziomie platformy (bez zmian w samej osadzanej aplikacji).Aplikacje sÄ… automatycznie zarzÄ…dzane przez platformÄ™. Wersjonowanie, load balancing i automatyczne skalowanie to tylko niektÃ³re z dostÄ™pnych funkcjonalnoÅ›ci. Jako uÅ¼ytkownik nie musisz zarzÄ…dzaÄ‡ procesem budowania aplikacji. W przypadku platformy PaaS moÅ¼emy myÅ›leÄ‡ jedynie o aplikacjach, a wszystkie aspekty ich wdroÅ¼enia i klastrowania sÄ… zarzÄ…dzane przez systemy chmury.MigrujÄ…c w modelu PaaS zyskujesz:  aktualizacjÄ™ i bezpieczeÅ„stwo kontenerÃ³w uruchamiajÄ…cych tworzone aplikacje,  w peÅ‚ni zarzÄ…dzanÄ… infrastrukturÄ™  wspierajÄ…cÄ… wersjonowanie i skalowanie na Å¼Ä…danie,  koszty wynikajÄ…ce wprost z czasu dziaÅ‚ania systemu,  wdroÅ¼enia gotowe do obsÅ‚ugi produkcyjnego ruchu - bez koniecznoÅ›ci znajomoÅ›ci zagadnieÅ„ DevOps,  brak kosztÃ³w zwiÄ…zanych z zarzÄ…dzaniem infrastrukturÄ….WÅ‚aÅ›ciwie wszystkie elementy wdroÅ¼enia chmurowego sÄ… juÅ¼ ukryte przed uÅ¼ytkownikiem. W praktyce oznacza to, Å¼e oddajÄ…c coraz wiÄ™cej elastycznoÅ›ci tworzonej aplikacji obniÅ¼yÅ‚eÅ› do minimum koniecznoÅ›Ä‡ zarzÄ…dzania systemem. Koncepty, ktÃ³rymi nadal zajmuje siÄ™ uÅ¼ytkownik, wynikajÄ… juÅ¼ ze stosowanych narzÄ™dzi i frameworkÃ³w oraz natury tworzonej aplikacji.Platforma PaaS najczÄ™Å›ciej okreÅ›la jÄ™zyki i frameworki, dla ktÃ³rych dostarcza wsparcie w postaci automatycznego procesu budowania i osadzania, narzÄ™dzi i bibliotek wspierajÄ…cych tworzenie usÅ‚ug oraz automatycznej konfiguracji frameworkÃ³w.W przypadku migracji systemu w modelu PaaS moÅ¼emy wpaÅ›Ä‡ w jednÄ… z dwÃ³ch Å›cieÅ¼ek: dla aplikacji tworzonych we wspieranym przez chmurÄ™ jÄ™zyku/frameworku moÅ¼liwa bÄ™dzie refaktoryzacja, jednak dla pozostaÅ‚ych aplikacji konieczne moÅ¼e byÄ‡ ich przepisanie.Model sprawdzi siÄ™ dobrze w aplikacjach webowych i serwerach usÅ‚ug HTTP - wszÄ™dzie tam, gdzie przejÅ›cie na model FaaS nie jest moÅ¼liwe ze wzglÄ™du na jego ograniczenia.FaaS - Function as a serviceDostawca chmury przejmuje odpowiedzialnoÅ›Ä‡ za wdroÅ¼enie i utrzymanie pojedynczych funkcji. UÅ¼ytkownik zarzÄ…dza systemem na poziomie kodu ÅºrÃ³dÅ‚owego konkretnych funkcji.W modelu FaaS dostawca chmury odpowiedzialny jest za wszystkie aspekty uruchomienia funkcji biznesowej w chmurze. Platforma dostarcza nie tylko infrastrukturÄ™ systemu, ale teÅ¼ obsÅ‚uguje np. elementy stosu HTTP. Model funkcyjny jest modelem zdarzeniowym - uÅ¼ytkownik skupia siÄ™ na obsÅ‚udze zdarzeÅ„ w systemie, np. zdarzeniem Å¼Ä…dania HTTP, pojawieniem siÄ™ komunikatu w kolejce czy utworzeniem nowego konta uÅ¼ytkownika lub pliku w storage.PrzykÅ‚adowo, dla funkcji HTTP, abstrahowane sÄ… nie tylko sposÃ³b uruchomienia, obsÅ‚uga wÄ…tkÃ³w, SSL czy port, na ktÃ³rym uruchomiona jest usÅ‚uga, ale teÅ¼ adres publikacji endpointu HTTP, obsÅ‚ugiwane metody jego wywoÅ‚ania czy parsowanie Å¼Ä…dania i odpowiedzi. Z punktu widzenia uÅ¼ytkownika wywoÅ‚anie funkcji HTTP niewiele rÃ³Å¼ni siÄ™ od wywoÅ‚ania jej przez inny proces. Nawet konkretny serwer obsÅ‚ugujÄ…cy Å¼Ä…dania HTTP jest ukryty przed uÅ¼ytkownikiem i moÅ¼e ulec zmianie na poziomie infrastruktury dostawcy.KaÅ¼da osadzona funkcja jest:  niezaleÅ¼nie budowana i wersjonowana (zarÃ³wno jej kod, jak i deployment),  wykonywana z niezaleÅ¼nym zestawem zaleÅ¼noÅ›ci (bibliotek),  obsÅ‚ugiwana niezaleÅ¼nie przez load balancer,  niezaleÅ¼nie skalowana,  zabezpieczona dedykowanymi dla niej reguÅ‚ami uwierzytelniania i autoryzacji.PodsumowujÄ…c, kaÅ¼da funkcja jest traktowana jak niezaleÅ¼ny artefakt i naleÅ¼y jÄ… postrzegaÄ‡ jako samodzielnÄ… aplikacjÄ™.MigrujÄ…c w modelu FaaS zyskujesz:  zerowy koszt utrzymania i zarzÄ…dzania infrastrukturÄ…,  ograniczenie tworzenia kodu niepowiÄ…zanego bezpoÅ›rednio z realizowanÄ… funkcjonalnoÅ›ciÄ…,  skalowanie od zera do dowolnego obciÄ…Å¼enia,  bÅ‚yskawiczne tempo wprowadzania nowych zmian i eksperymentÃ³w.Model FaaS zakÅ‚ada analizÄ™ i fundamentalne przeprojektowanie systemu. Zmiana myÅ›lenia o architekturze i przetwarzaniu sprawia, Å¼e dotychczasowe problemy bÄ™dziesz mÃ³gÅ‚ rozwiÄ…zaÄ‡ na nowe sposoby. UÅ¼ytkownicy mogÄ… w caÅ‚oÅ›ci skupiÄ‡ siÄ™ na tworzeniu funkcjonalnoÅ›ci biznesowych, drastycznie skracajÄ…c czas potrzebny do wdraÅ¼ania nowych rozwiÄ…zaÅ„.Warto teÅ¼ zauwaÅ¼yÄ‡, Å¼e skalowanie systemu pozwala nie tylko obsÅ‚ugiwaÄ‡ uÅ¼ytkownikÃ³w na Å›rodowiskach produkcyjnych, ale teÅ¼ skalowaÄ‡ Å›rodowiska programistyczne i testowe. JeÅ¼eli koszt infrastruktury wprost wynika z liczby uÅ¼ytkownikÃ³w, to nie ma powodu tworzyÄ‡ uproszczonych wersji Å›rodowisk testowych i moÅ¼na wewnÄ™trznie zapewniÄ‡ infrastrukturÄ™ w peÅ‚ni zgodnÄ… z produkcyjnym wdroÅ¼eniem.W przypadku FaaS naleÅ¼y pamiÄ™taÄ‡, Å¼e z najwiÄ™kszymi moÅ¼liwoÅ›ciami i prostotÄ… pojawiajÄ… siÄ™ najwiÄ™ksze ograniczenia (najwiÄ™ksze uzaleÅ¼nienie kodu od konkretnej chmury). Tworzona funkcja bÄ™dzie w peÅ‚ni polegaÄ‡ na Å›rodowisku uruchomieniowym dostawcy. Kod bÄ™dzie tworzony w jÄ™zyku programowania i w ramach frameworkÃ³w wskazanych przez usÅ‚ugÄ™ FaaS. CzÄ™sto lokalne testowanie bÄ™dzie utrudnione lub bÄ™dzie wymagaÅ‚o emulatora. Jednym z najwiÄ™kszych ograniczeÅ„ wielu popularnych chmur jest czas zimnego startu funkcji, tj. natychmiastowe skalowanie od zera do w zasadzie dowolnego obciÄ…Å¼enia wiÄ…Å¼e siÄ™ z czÄ™stym tworzeniem nowych instancji usÅ‚ugi. To oznacza, Å¼e czÄ™Å›Ä‡ uÅ¼ytkownikÃ³w trafiajÄ…cych na nowÄ… usÅ‚ugÄ™ moÅ¼e zauwaÅ¼yÄ‡ dÅ‚uÅ¼sze czasy odpowiedzi. W praktyce problem jest zauwaÅ¼alny w systemach o maÅ‚ym ruchu lub gdy niedopuszczalne sÄ… nawet pojedyncze Å¼Ä…dania przekraczajÄ…ce zaÅ‚oÅ¼ony czas odpowiedzi.FaaS najlepiej sprawdza siÄ™ w przetwarzaniu opartym o zdarzenia. Zastosowanie funkcji do tworzenia aplikacji webowych lub usÅ‚ug API naleÅ¼y poprzedziÄ‡ analizÄ… wymagaÅ„, oceniÄ‡ np. dopuszczalne SLA usÅ‚ugi przy uwzglÄ™dnieniu czasu zimnego startu. MoÅ¼liwoÅ›Ä‡ skalowania usÅ‚ug od zera do dowolnego obciÄ…Å¼enia oraz ograniczenie czasu tworzenia nowych funkcjonalnoÅ›ci do minimum sprawia, Å¼e FaaS to zawsze opcja warta rozwaÅ¼enia.Niskie koszty utrzymania infrastruktury, wysokie tempo wprowadzania zmian i wzorowe moÅ¼liwoÅ›ci skalowania pozwolÄ… Twojemu produktowi zyskaÄ‡ przewagÄ™ nad konkurencjÄ….Migracja a rozwÃ³jPrzytaczane do tej pory koszty zwiÄ…zane z migracjÄ… zakÅ‚adaÅ‚y dostosowanie i wdroÅ¼enie dziaÅ‚ajÄ…cych systemÃ³w. Przy ich ocenie zakÅ‚adaÅ‚em, Å¼e zespÃ³Å‚ nie posiada wiedzy i doÅ›wiadczenia w tworzeniu aplikacji w chmurze. W takiej sytuacji koszt szkoleÅ„, prÃ³b i bÅ‚Ä™dÃ³w oraz faktycznego wdroÅ¼enia roÅ›nie wraz ze wzrostem â€œchmurowoÅ›ciâ€ rozwiÄ…zania.Sytuacja bÄ™dzie wyglÄ…daÄ‡ zupeÅ‚nie inaczej dla zespoÅ‚u tworzÄ…cego i utrzymujÄ…cego juÅ¼ istniejÄ…ce rozwiÄ…zania chmurowe. W takim wypadku koszt nowej technologii zostaÅ‚ juÅ¼ poniesiony i nie wpÅ‚ywa na koszt przygotowywania nowych rozwiÄ…zaÅ„. Dla doÅ›wiadczonych zespoÅ‚Ã³w koszt dostarczenia nowej funkcjonalnoÅ›ci w Å›rodowisku chmurowym bÄ™dzie wyraÅºnie niÅ¼szy niÅ¼ w tradycyjnym podejÅ›ciu ze wzglÄ™du na:  abstrakcjÄ™ infrastruktury,  minimalny koszt wdroÅ¼enia i utrzymania aplikacji,  przeniesienie ciÄ™Å¼aru na rozwÃ³j funkcjonalny aplikacji,  dostÄ™pnoÅ›Ä‡ gotowych do integracji z systemem usÅ‚ug w modelu SaaSVendor lock-inPlanujÄ…c migracjÄ™ do chmury musisz zmierzyÄ‡ siÄ™ z tematem uzaleÅ¼nienia kodu od konkretnego dostawcy.Czy vendor lock-in jest zÅ‚y? Zagadnienie warto traktowaÄ‡ jako ryzyko, a nie zagroÅ¼enie jako takie. Dla ryzyk moÅ¼liwe jest zaplanowanie Å›cieÅ¼ek przeciwdziaÅ‚ania i przygotowanie planu wyjÅ›cia z chmury (czy to do innego dostawcy, czy zupeÅ‚nie w kierunku chmury prywatnej lub rozwiÄ…zania on-premises).Dla podejÅ›Ä‡ IaaS i CaaS moÅ¼emy przyjÄ…Ä‡, Å¼e ryzyko wyjÅ›cia z chmury niesie za sobÄ… minimalne koszty - w szczegÃ³lnoÅ›ci, gdy system nie korzysta z natywnych usÅ‚ug oferowanych przez chmurÄ™ obliczeniowÄ….W przypadku PaaS i FaaS prawdopodobnie zaprojektowaÅ‚eÅ› system pod kÄ…tem oferty konkretnej chmury. NajwiÄ™ksi dostawcy zapewniajÄ… ujednoliconÄ… ofertÄ™ produktÃ³w. O ile rÃ³Å¼nice pomiÄ™dzy oferowanymi rozwiÄ…zaniami w wielu przypadkach uniemoÅ¼liwiajÄ… migracjÄ™ systemu bez Å¼adnych zmian, to jednak znajdziemy pomiÄ™dzy nimi odpowiadajÄ…ce sobie rozwiÄ…zania pozwalajÄ…ce zrealizowaÄ‡ system w podobnej architekturze.Warto zauwaÅ¼yÄ‡, Å¼e problem vendor lock-in, jako powaÅ¼ne ryzyko migracji do chmury, czÄ™sto jest adresowany wprost przez dostawcÃ³w. PrzykÅ‚adowo w Google Cloud Platform wiÄ™kszoÅ›Ä‡ produktÃ³w jest zbudowana w oparciu o otwarte standardy oraz narzÄ™dzia open-source. PrzykÅ‚adowo Google Kubernetes Engine do dziaÅ‚ania wykorzystuje platformÄ™ Kubernetes, Cloud Bigtable jest zgodny z HBase, itd. Podobne podejÅ›cie jest stosowane przez wiodÄ…cych dostawcÃ³w chmur publicznych.SzacujÄ…c koszty wyjÅ›cia z chmury powinieneÅ› rozwaÅ¼yÄ‡ rÃ³wnieÅ¼ utracone zyski wynikajÄ…ce z obaw przed vendor lock-in. Obawa przed uzaleÅ¼nieniem moÅ¼e doprowadziÄ‡ do zwiÄ™kszenia zÅ‚oÅ¼onoÅ›ci systemu, zwiÄ™kszenia kosztu produkcji i utrzymania systemu, utraty funkcjonalnoÅ›ci dajÄ…cych przewagÄ™, itp. Czy ew. koszt wyjÅ›cia z chmury bÄ™dzie wiÄ™kszy niÅ¼ oszczÄ™dnoÅ›ci wynikajÄ…ce z jej wykorzystania? W przypadku duÅ¼ego prawdopodobieÅ„stwa lub wysokiego kosztu wyjÅ›cia z chmury warto rozwaÅ¼yÄ‡ ograniczenie migracji do modelu CaaS.On-prem, IaaS, CaaS, PaaS, FaaSMajÄ…c juÅ¼ w gÅ‚owie argumentacje i przykÅ‚ady wszystkich podejÅ›Ä‡, moÅ¼emy nakreÅ›liÄ‡ podsumowanie odpowiedzialnoÅ›ci w rÃ³Å¼nych modelach.Im bardziej zaadaptujemy rozwiÄ…zania chmurowe, tym wiÄ™cej odpowiedzialnoÅ›ci przerzucimy na stronÄ™ dostawcy.DojrzaÅ‚oÅ›Ä‡ chmurowaZnajÄ…c system moÅ¼emy pokusiÄ‡ siÄ™ o ocenÄ™ jego dojrzaÅ‚oÅ›ci chmurowej. Z jednej strony mamy klasyczne rozwiÄ…zania on-premises, a z drugiej rozwiÄ…zania w peÅ‚ni serverless. PodsumowujÄ…c wady i zalety opisywanych do tej pory podejÅ›Ä‡ naszkicujmy prosty diagram szans i ryzyk zaleÅ¼ny od stopnia migracji do chmury:Im bardziej zbliÅ¼ymy siÄ™ do podejÅ›Ä‡ serverless, tym wiÄ™cej korzyÅ›ci osiÄ…gniemy z migracji. NaleÅ¼y jednak zwrÃ³ciÄ‡ uwagÄ™, Å¼e im dalej siÄ™ przesuwamy, tym droÅ¼sza bÄ™dzie migracja oraz wzroÅ›nie ryzyko uzaleÅ¼nienia siÄ™ od konkretnego dostawcy.Cele migracjiPodsumowujÄ…c, zanim wybierzesz odpowiedni kierunek migracji do chmury, powinieneÅ› zidentyfikowaÄ‡ kluczowe problemy, ktÃ³re starasz siÄ™ rozwiÄ…zaÄ‡. Na ich podstawie moÅ¼esz ustaliÄ‡ cele i ograniczenia, ktÃ³re pomogÄ… Ci wybraÄ‡ odpowiedniÄ… strategiÄ™ dla Twojego systemu.RzuÄ‡my okiem na kilka przykÅ‚adowych celÃ³w. PokaÅ¼Ä™ Ci, jakie decyzje mÃ³gÅ‚byÅ› rozwaÅ¼yÄ‡, stojÄ…c przed nimi:  â€œChcemy byÄ‡ w chmurzeâ€ - przy minimalnym nakÅ‚adzie pracy moÅ¼esz wskoczyÄ‡ we wdroÅ¼enia w ramach IaaS i z sukcesem odhaczyÄ‡ wymaganie. Jednak, o ile ten cel nie ma ukrytej intencji, samo przeniesienie do chmury dla prestiÅ¼u nie wydaje siÄ™ byÄ‡ sensownie obranÄ… strategia rozwoju.  â€œChcemy obniÅ¼yÄ‡ koszty sprzÄ™tuâ€- wdroÅ¼enia IaaS mogÄ… obniÅ¼yÄ‡ koszt sprzÄ™tu, jednak koszt utrzymania pojedynczej wirtualnej maszyny odpowiadajÄ…cej juÅ¼ posiadanym maszynom moÅ¼e byÄ‡ wiÄ™kszy.  â€œChcemy obniÅ¼yÄ‡ koszty administrowaniaâ€ - wdroÅ¼enia CaaS zdejmujÄ… z uÅ¼ytkownika potrzebÄ™ administrowania systemami operacyjnymi maszyn wirtualnych. PrzejÅ›cie na model PaaS i FaaS pozwala dalej radykalnie ograniczaÄ‡ te koszty.  â€œChcemy obniÅ¼yÄ‡ koszty infrastrukturyâ€ - model CaaS wyraÅºnie zwiÄ™ksza utylizacjÄ™ infrastruktury. Dodatkowo przejÅ›cie na PaaS i FaaS pozwala nie utrzymywaÄ‡ infrastruktury w ogÃ³le gdy nie jest potrzebna.  â€œChcemy zwiÄ™kszyÄ‡ skalowalnoÅ›Ä‡ systemuâ€ - kaÅ¼dy kolejny etap migracji zwiÄ™ksza standaryzacjÄ™ wdraÅ¼anych rozwiÄ…zaÅ„, przez co pozwala dostawcy chmury na efektywniejsze skalowanie systemu bez naszego udziaÅ‚u.  â€œChcemy poprawiÄ‡ bezpieczeÅ„stwo systemuâ€ - kaÅ¼dy kolejny model (CaaS, PaaS, FaaS) poprawia bezpieczeÅ„stwo systemu przenoszÄ…c odpowiedzialnoÅ›Ä‡ za utrzymanie i zarzÄ…dzanie kolejnymi elementami przez dostawcÄ™ infrastruktury.  â€œChcemy obniÅ¼yÄ‡ koszty wprowadzenia nowych zmianâ€ - modele chmurowe sprzyjajÄ… szybkiemu wprowadzaniu zmian i prowadzeniu eksperymentÃ³w przy minimalnym narzucie zwiÄ…zanym z wdroÅ¼eniem i administracjÄ….  â€œNie chcemy pÅ‚aciÄ‡ za infrastrukturÄ™â€ - cel zdefiniowany przewrotnie, jednak jego intencjÄ… jest pokrycie kosztÃ³w infrastruktury przez uÅ¼ytkownikÃ³w - gdy nie uÅ¼ywajÄ… systemu, to ten nie generuje kosztÃ³w utrzymania. Jak siÄ™ juÅ¼ pewnie domyÅ›lasz, docieramy do Graala rozwiÄ…zaÅ„ chmurowych. W tym miejscu Å‚akomie zerkasz juÅ¼ w stronÄ™ serverless, kuszÄ… CiÄ™ jego moÅ¼liwoÅ›ci skalowania do zera, brak staÅ‚ych kosztÃ³w utrzymania i moÅ¼liwoÅ›Ä‡ okreÅ›lenia precyzyjnego kosztu obsÅ‚ugi kaÅ¼dego uÅ¼ytkownika w systemie :)Potraktuj przykÅ‚adowe cele jako inspiracje i przygotuj wÅ‚asnÄ… listÄ™ oczekiwaÅ„ i driverÃ³w migracji do chmury. ZnajÄ…c problemy i oczekiwania, skuteczniej ocenisz potencjalne zyski i sensownoÅ›Ä‡ wybranego podejÅ›cia.Co wybraÄ‡?To co ostatecznie wybraÄ‡? Wszystko po trochu!SposÃ³b migracji aplikacji naleÅ¼y dobieraÄ‡ do jej potrzeb, ograniczeÅ„ i szans na rozwÃ³j. Naturalnym podejÅ›ciem bÄ™dzie wdroÅ¼enie czÄ™Å›ci systemÃ³w wymagajÄ…cych minimalnych czasÃ³w odpowiedzi do uÅ¼ytkownika w modelu CaaS lub PaaS oraz zaprojektowanie procesÃ³w biznesowych w modelu zdarzeniowym przy wsparciu FaaS.Migracja do chmury uczy nas myÅ›lenia nie tylko w kategoriach kodu, ale teÅ¼ optymalizacji kosztÃ³w i szybkoÅ›ci wdraÅ¼ania zmian. PrzykÅ‚adowo, jeÅ›li tworzysz aplikacjÄ™ bota integrujÄ…cego siÄ™ z platformÄ… Slack, moÅ¼esz uruchomiÄ‡ webhook w oparciu o PaaS, ktÃ³ry zleca dalsze operacje do kolejki zdarzeÅ„ obsÅ‚ugiwanych przez infrastrukturÄ™ FaaS. W takim podejÅ›ciu usÅ‚uga PaaS zapewnia nam staÅ‚e dziaÅ‚anie usÅ‚ugi nieobarczonej kosztem zimnego startu, a FaaS zapewnia infrastrukturÄ™ przetwarzania operacji, za ktÃ³rÄ… pÅ‚acimy tylko w trakcie obsÅ‚ugi. W takim podejÅ›ciu poniesiemy minimalny koszt zawsze czekajÄ…cej usÅ‚ugi (co jest wymaganiem od strony UI uÅ¼ytkownika) i zerowy koszt funkcji dziaÅ‚ajÄ…cych tylko wtedy, gdy jest dla nich zadanie do wykonania. DziÄ™ki takiej analizie moÅ¼emy optymalizowaÄ‡ koszt dziaÅ‚ania systemu przeznaczajÄ…c Å›rodki w miejscach, w ktÃ³rych niosÄ… realnÄ… wartoÅ›Ä‡ (szybki czas odpowiedzi usÅ‚ugi do uÅ¼ytkownika) i obniÅ¼ajÄ…c je tam, gdzie moÅ¼liwe sÄ… oszczÄ™dnoÅ›ci (przetwarzanie zadaÅ„ w tle).PodsumowujÄ…c -  przy wyborze modelu wdroÅ¼enia w chmurze waÅ¼ne jest okreÅ›lenie rozwiÄ…zywanych problemÃ³w i celÃ³w, ktÃ³re chcesz osiÄ…gnÄ…Ä‡. Na tej podstawie bÄ™dziesz mÃ³gÅ‚ Å›wiadomie wybraÄ‡ najlepsze narzÄ™dzia do zadanego problemu. Nie bÃ³j siÄ™ eksperymentowaÄ‡ i mieszaÄ‡ podejÅ›Ä‡, aby uzyskaÄ‡ infrastrukturÄ™ skrojonÄ… idealnie pod Twoje potrzeby.",
"url": "/2020/10/21/modele-wdrozenia-w-chmurze.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2020-10-22-modele-wdrozenia-w-chmurze/cloud.jpeg",
"date": "21-10-2020",
"path": "pl/2020-10-22-modele-wdrozenia-w-chmurze"
}
,


"2020-08-27-axon-kompleksowe-testowanie-aplikacji-html": {
"title": "Axon - Kompleksowe testowanie aplikacji",
"lang": "pl",
"tags": "java microservices axon axon-server event-sourcing spring-boot tests",
"content": "Powszechnie wiadomo, Å¼e kod dobrze pokryty testami jest duÅ¼o bardziej podatny na rozwÃ³j - wszak nie musimy obawiaÄ‡ siÄ™, Å¼e nasza zmiana spowoduje np. powrÃ³t znanego wczeÅ›niej bÅ‚Ä™du.W poprzednim wpisie opisaÅ‚em swoje zmagania z migracjÄ… monolitu do mikroserwisÃ³w na Axonie, umyÅ›lnie pomijajÄ…c kwestiÄ™ zwiÄ…zanÄ… z testami.Niniejszy artykuÅ‚ jest poÅ›wiÄ™cony w peÅ‚ni temu tematowi.PrzedstawiÄ™ w nim kilka elementÃ³w skÅ‚adajÄ…cych siÄ™ na kompleksowo przetestowanÄ… aplikacjÄ™ opartÄ… o Axona.Testy domenoweZacznijmy od przetestowania domeny, czyli logiki biznesowej zawartej w obiektach domenowych.W Axonie jest to uÅ‚atwione, poprzez gotowe narzÄ™dzia, ktÃ³re dostajemy w pakiecie z frameworkiem.Zaleta tych testÃ³w jest taka, Å¼e nie podnoszÄ… one Å¼adnego kontekstu, a wiÄ™c wykonujÄ… siÄ™ bardzo szybko.AgregatyZostajÄ…c przy aplikacji z poprzedniego wpisu, weÅºmy jako przykÅ‚ad oznaczanie filmu jako obejrzany/nieobejrzany.Niezmiennik agregatu mÃ³wi, Å¼e gdy film jest juÅ¼ oznaczony jako obejrzany, to nie moÅ¼emy tego zrobiÄ‡ ponownie - tak samo nieobejrzanego filmu nie moÅ¼emy â€œodzobaczyÄ‡â€ ;).WystÄ…pienie takiej anomalii odnotowywane jest w logu, a ToggleWatchedEvent nie zostaje wyemitowany.@Aggregatepublic class MovieAggregate {    ...    @CommandHandler    public void handle(ToggleWatchedCommand command) {        if (this.watched.isWatched() == command.getWatched().isWatched()) {            log.info(&quot;Cannot toggle to the same state, skipping..&quot;);            return;        }        apply(new ToggleWatchedEvent(command.getMovieId(), command.getWatched()));    }    ...}RozwaÅ¼my tzw. happy path w testach dla tego przypadku biznesowego. BÄ™dziemy potrzebowaÄ‡ obiektu FixtureConfiguration, ktÃ³ry zasymuluje nam sytuacjÄ™, w ktÃ³rej moÅ¼e znaleÅºÄ‡ siÄ™ nasz agregat.public class MovieAggregateTest {    ...    private FixtureConfiguration&amp;lt;MovieAggregate&amp;gt; fixture;    @BeforeEach    public void setup() {        this.fixture = new AggregateTestFixture&amp;lt;&amp;gt;(MovieAggregate.class);        ...    }}Test piszemy w nastÄ™pujÄ…cy sposÃ³b:  OkreÅ›lamy â€œpunkt startowyâ€ dla naszego agregatu, czyli jakie eventy zostaÅ‚y zastosowane w agregacie do tej pory (jest to given w podejÅ›ciu behawioralnym).  Wpisujemy command, ktÃ³ry chcemy poddaÄ‡ testom (odpowiednio - when). W naszym przypadku to ToggleWatchedCommand  Definiujemy stan oczekiwany.public class MovieAggregateTest {    ...    @Test    public void shouldToggleWatchedEventAppear() {        fixture.given(                                                              // 1                    new MovieCreatedEvent(movieId, searchPhrase),                    new MovieSavedEvent(movieId, externalMovie))                .when(new ToggleWatchedCommand(movieId, new Watched(true)))         // 2                .expectEvents(new ToggleWatchedEvent(movieId, new Watched(true)))   // 3                .expectState(                                                                           state -&amp;gt; assertThat(state.getWatched().isWatched()).isTrue());    }}Druga Å›cieÅ¼ka do sprawdzenia to brak emisji zdarzenia w momencie zmiany stanu na ten sam.DorzuÄ‡my wiÄ™c do given wystÄ…pienie eventu ToggleWatchedEvent - wtedy agregat nie powinien wyemitowaÄ‡ nic nowego:public class MovieAggregateTest {    ...    @Test    public void shouldNotToggleWatchedEventAppear() {        fixture.given(                    new MovieCreatedEvent(movieId, searchPhrase),                    new MovieSavedEvent(movieId, externalMovie),                    new ToggleWatchedEvent(movieId, new Watched(true)))                .when(new ToggleWatchedCommand(movieId, new Watched(true)))                .expectNoEvents()                .expectState(                                                                           state -&amp;gt; assertThat(state.getWatched().isWatched()).isTrue());    }}SagiDrugim obiektem domenowym, ktÃ³ry poddam testom, jest saga (zob. DDD).W mojej aplikacji zdarzeniem otwierajÄ…cym sagÄ™ dla filmu jest MovieCreatedEvent wyemitowany przez MovieAggrate - po jego pojawieniu siÄ™, wysyÅ‚am command, ktÃ³ry zostanie obsÅ‚uÅ¼ony w mikroserwisie (proxy-service) odpowiedzialnym za pobieranie szczegÃ³Å‚Ã³w filmu z zewnÄ™trznego ÅºrÃ³dÅ‚a:public class MovieSaga {    ...    @StartSaga    @SagaEventHandler(associationProperty = MOVIE_ID)    public void handle(MovieCreatedEvent event) {        movieId = event.getMovieId();        String proxyId = PROXY_PREFIX.concat(movieId);        associateWith(&quot;proxyId&quot;, proxyId);        commandGateway.send(new FetchMovieDetailsCommand(proxyId, event.getSearchPhrase()));    }    ...}Proces ten moÅ¼e trochÄ™ potrwaÄ‡ (niedostÄ™pnoÅ›Ä‡ zewnÄ™trznego ÅºrÃ³dÅ‚a, timeouty, problemy z Å‚Ä…czem), dlatego teÅ¼ zdecydowaÅ‚em siÄ™ na sagÄ™, ktÃ³ra jest rozwiÄ…zaniem nieblokujÄ…cym.Gdy proxy-service wyemituje zdarzenie MovieDetailsEvent, to w zaleÅ¼noÅ›ci od zawartoÅ›ci payloadu, Å›le command z uzupeÅ‚nionymi szczegÃ³Å‚ami dla filmu lub nie i bez wzglÄ™du na rezultat koÅ„czÄ™ sagÄ™:public class MovieSaga {    ...    @SagaEventHandler(associationProperty = PROXY_ID)    @EndSaga    public void handle(MovieDetailsEvent event) {        var movie = event.getExternalMovie();        if (MovieState.NOT_FOUND_IN_EXTERNAL_SERVICE == movie.getMovieState()) {            // handle when movie not found        } else {            commandGateway.send(new SaveMovieCommand(movieId, event.getExternalMovie()));        }    }    ...}Do przetestowania tego przypadku znÃ³w bÄ™dziemy potrzebowaÄ‡ fixture, tyle Å¼e tym razem skrojony pod sagi:public class MovieSagaTest {    ...    private SagaTestFixture&amp;lt;MovieSaga&amp;gt; fixture;    @BeforeEach    public void setup() {        fixture = new SagaTestFixture&amp;lt;&amp;gt;(MovieSaga.class);        ...    }}Testy majÄ… sprawdziÄ‡ czy odpowiednie commandy zostanÄ… wyemitowane, oraz czy saga â€œwystartowaÅ‚aâ€, bÄ…dÅº zakoÅ„czyÅ‚a siÄ™ w odpowiednim momencie.Szkielet testu wyglÄ…da nastÄ™pujÄ…co:  MajÄ…c agregat X z ustalonym identyfikatorem.  WiedzÄ…c, Å¼e X nie wyemitowaÅ‚ Å¼adnego eventu (lub wyemitowaÅ‚ konkretny event).  To gdy agregat X.  Wyemituje konkretny event.  Oczekujemy aktywnej (lub nieaktywnej) sagi oraz opublikowany command (lub nieopublikowanie niczego).public class MovieSagaTest {    ...    @Test    public void shouldDispatchFetchMovieDetailsCommand() {        fixture.givenAggregate(movieId)                                      // 1                .published()                                                 // 2                .whenAggregate(movieId)                                      // 3                .publishes(new MovieCreatedEvent(movieId, searchPhrase))     // 4                .expectActiveSagas(1)                                        // 5                .expectDispatchedCommands(                                                       new FetchMovieDetailsCommand(proxyId, searchPhrase));    }    @Test    public void shouldDispatchSaveCastCommand() {        fixture.givenAggregate(movieId)                                       // 1                .published(new MovieCreatedEvent(movieId, searchPhrase))      // 2                .whenAggregate(proxyId)                                       // 3                .publishes(new MovieDetailsEvent(proxyId, externalMovie))     // 4                .expectActiveSagas(0)                                         // 5                .expectDispatchedCommands(                                                        new SaveMovieCommand(movieId, externalMovie));    }}Jak widaÄ‡ zastosowanie fixture rÃ³wnieÅ¼ w przypadku sagi, okazuje siÄ™ proste i intuicyjne.Testy integracyjne - moÅ¼liwe z Axonem?Po testach domenowych, gdy wiemy juÅ¼, Å¼e nasza logika biznesowa jest poprawna (i mamy na to dowody w postaci testÃ³w!), moÅ¼na zabraÄ‡ siÄ™ za weryfikacjÄ™ trochÄ™ wiÄ™kszego fragmentu aplikacji.KonfiguracjaTesty integracyjne z uÅ¼yciem prawdziwego Event Storeâ€™a (w naszym przypadku AxonServera) wymagajÄ… wiÄ™cej konfiguracji - twÃ³rcy w tym aspekcie akurat nie przygotowali nam gotowego rozwiÄ…zania.TrochÄ™ siÄ™ naszukaÅ‚em, zanim znalazÅ‚em informacjÄ™ o tym, Å¼e rekomendowanym przez AxonIQ rozwiÄ…zaniem problemu jest skorzystanie z obrazu dockerowego.Konkretnie wspominajÄ… o uruchomieniu AxonServer z terminala i podÅ‚Ä…czeniu siÄ™ testami do tej instancji.WrÄ™cz idealna rola dla testcontainers - pomyÅ›laÅ‚em (po przygotowaniu konfiguracji pod testy, trafiÅ‚em na podobne rozwiÄ…zanie na stacku).StworzyÅ‚em klasÄ™ umoÅ¼liwiajÄ…cÄ… podniesienie potrzebnych kontenerÃ³w, aby skorzystaÄ‡ z nich podczas testÃ³w:@ActiveProfiles(&quot;test&quot;)public class TestContainers {    private static final int MONGO_PORT = 29019;    private static final int AXON_HTTP_PORT = 8024;    private static final int AXON_GRPC_PORT = 8124;    public static void startAxonServer() {        GenericContainer axonServer = new GenericContainer(&quot;axoniq/axonserver:latest&quot;)                .withExposedPorts(AXON_HTTP_PORT, AXON_GRPC_PORT)                .waitingFor(                        Wait.forLogMessage(&quot;.*Started AxonServer.*&quot;, 1)                );        axonServer.start();        System.setProperty(                &quot;ENV_AXON_GRPC_PORT&quot;,                 String.valueOf(axonServer.getMappedPort(AXON_GRPC_PORT)));    }    public static void startMongo() {        GenericContainer mongo = new GenericContainer(&quot;mongo:latest&quot;)                .withExposedPorts(MONGO_PORT)                .withEnv(&quot;MONGO_INITDB_DATABASE&quot;, &quot;moviekeeper&quot;)                .withCommand(String.format(&quot;mongod --port %d&quot;, MONGO_PORT))                .waitingFor(                        Wait.forLogMessage(&quot;.*waiting for connections.*&quot;, 1)                );        mongo.start();        System.setProperty(                &quot;ENV_MONGO_PORT&quot;,                 String.valueOf(mongo.getMappedPort(MONGO_PORT)));    }}NaleÅ¼y tu jednak pamiÄ™taÄ‡ o tym, Å¼e withExposedPorts wystawia porty tylko wewnÄ…trz kontenera, potrzebny wiÄ™c byÅ‚ sposÃ³b na pozyskanie portÃ³w, do ktÃ³rych testy bÄ™dÄ… mogÅ‚y siÄ™ poÅ‚Ä…czyÄ‡.Testcontainers przy kaÅ¼dym restarcie kontenera wystawia go na losowym wolnym porcie z danego zakresu, istnieje jednak metoda na pobranie tych portÃ³w w runtime.RobiÄ™ to w ostatniej instrukcji kaÅ¼dej z metod, jednoczeÅ›nie wrzucajÄ…c znalezione wartoÅ›ci do zmiennych Å›rodowiskowych ENV_AXON_GRPC_PORT oraz ENV_MONGO_PORT.Zmienne te uÅ¼ywam w yamlu konfiguracyjnym pod testy:spring:  data:        mongodb:            uri: mongodb://localhost:${ENV_MONGO_PORT}/moviekeeperaxon:  axonserver:        servers: localhost:${ENV_AXON_GRPC_PORT}Metody startMongo i startAxonServer wykorzystaÅ‚em w klasie, z ktÃ³rej dziedziczÄ… wszystkie testy integracyjne:@ExtendWith(SpringExtension.class)@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)@ActiveProfiles(&quot;test&quot;)public class CommonIntegrationSetup {    ...    @BeforeAll    public static void beforeAll() {        TestContainers.startAxonServer();        TestContainers.startMongo();    }    ...}Po wszystkim nie musimy zatrzymywaÄ‡ kontenerÃ³w, zadzieje siÄ™ to automatycznie (GenericContainer implementuje AutoCloseable).NaleÅ¼y jednak pamiÄ™taÄ‡ o ustawieniu profilu i pliku konfiguracyjnym pod ten profil - zdarzyÅ‚o mi siÄ™ puÅ›ciÄ‡ testy (bez tych dwÃ³ch rzeczy skonfigurowanych), podczas gdy aplikacja chodziÅ‚a â€œprodukcyjnieâ€ - moÅ¼na Å‚atwo zgadnÄ…Ä‡, do jakiego AxonServera owe testy siÄ™ podÅ‚Ä…czyÅ‚y. :)Skonfigurowane. Do dzieÅ‚a!W mojej aplikacji w momencie, gdy znaleziony zostanie film o Å¼Ä…danym tytule, majÄ… miejsce nastÄ™pujÄ…ce kroki:  Zwracane sÄ… szczegÃ³Å‚y znalezionego filmu.  WysyÅ‚any jest command, ktÃ³ry mÃ³wi znajdÅº trailery i obsadÄ™ dla tego filmu.ParÄ™ krokÃ³w pÃ³Åºniej efektem tego commanda, sÄ… kolejne commandy, juÅ¼ skierowane do konkretnego mikroserwisu (odpowiedzialnego za pobranie obsady i trailerÃ³w).Å»eby nie byÅ‚o za Å‚atwo, wyszukiwanie czegokolwiek w TMDb zlecam osobnemu mikroserwisowi (zachÄ™cam do spojrzenia na diagram komponentÃ³w z poprzedniego wpisu).OczywiÅ›cie nie chcÄ™, aby test byÅ‚ zaleÅ¼ny od jakiegoÅ› serwisu, wiÄ™c konieczne jest stworzenie mocka:@Profile(&quot;test&quot;)@Slf4j@Component@RequiredArgsConstructorpublic class MockProxyCommandHandler {    private final EventGateway eventGateway;    @CommandHandler    public void handle(FetchTrailersCommand command) {        log.info(&quot;MOCK fetching...&quot;);        eventGateway.publish(new TrailersDetailsEvent(command.getProxyId(), TRAILERS));    }}W teÅ›cie chcÄ™ zasymulowaÄ‡ sytuacjÄ™, w ktÃ³rej pojawia siÄ™ command CreateTrailersCommand.W efekcie aplikacja powinna pobraÄ‡ trailery dla wskazanego filmu i umieÅ›ciÄ‡ je w bazie:public class TrailersIntegrationTest extends CommonIntegrationSetup {    @Autowired    private CommandGateway commandGateway;    ...    @BeforeEach    public void beforeEach() {        this.movieId = &quot;123&quot;;        this.trailers = generateTrailers(movieId);    }    @Test    public void shouldRetrieveTrailers() {        // given        commandGateway.send(new CreateTrailersCommand(                    trailers.getAggregateId(),                     trailers.getExternalMovieId(),                     trailers.getMovieId()));        await()            .atMost(FIVE_SECONDS)            .with()            .pollInterval(ONE_HUNDRED_MILLISECONDS)            .until(() -&amp;gt; trailerRepository.findByMovieId(movieId).isPresent());        // when        ResponseEntity&amp;lt;TrailerDTO[]&amp;gt; trailerResponse = testRestTemplate                .getForEntity(                        String.format(GET_TRAILERS_URL, randomServerPort, movieId),                        TrailerDTO[].class);        // then        assertThat(trailerResponse.getStatusCode()).isEqualTo(HttpStatus.OK);        assertThat(trailerResponse.getBody()).isNotNull();        List&amp;lt;TrailerDTO&amp;gt; trailerDTOS = Arrays.asList(trailerResponse.getBody());        assertThat(trailerDTOS.size()).isEqualTo(2);        assertThat(trailerDTOS).isEqualTo(trailers.getTrailers());    }}SkorzystaÅ‚em z awaitility, Å¼eby poczekaÄ‡ chwilÄ™ na odpowiedÅº w razie maÅ‚ej czkawki.Testy E2ENa samym szczycie piramidy testÃ³w sÄ… testy end-to-end, czyli sprawdzenie aplikacji w ten sposÃ³b, w jaki klient z niej korzysta.W moim przypadku klientem jest aplikacja frontendowa, ktÃ³ra uderzajÄ…c na konkretny endpoint, oczekuje konkretnej odpowiedzi.Przetestujmy wyszukanie filmu po tytule.Taki test powinien:  uderzyÄ‡ na endpoint, za ktÃ³rym kryje siÄ™ dana funkcjonalnoÅ›Ä‡,  sprawdziÄ‡ status odpowiedzi od serwera,  sprawdziÄ‡ zawartoÅ›Ä‡ odpowiedzi,  upewniÄ‡ siÄ™, Å¼e film zostaÅ‚ umieszczony w bazie, a jeÅ›li tak to czy jest on rÃ³wny temu, ktÃ³ry dostaliÅ›my w ciele odpowiedzi.public class MovieE2ETest {    ...    @Test    public void shouldStoreMovie() {        // when        ResponseEntity&amp;lt;MovieDTO&amp;gt; storedMovieResponse = testRestTemplate.postForEntity(                           String.format(GET_OR_POST_MOVIES, randomServerPort),                            new TitleBody(SUPER_MOVIE),                            MovieDTO.class);        assertThat(storedMovieResponse.getStatusCode()).isEqualTo(HttpStatus.CREATED);        MovieDTO body = storedMovieResponse.getBody();        await()                .atMost(FIVE_SECONDS)                .with()                .pollInterval(ONE_HUNDRED_MILLISECONDS)                .until(() -&amp;gt; movieRepository.findById(body.getAggregateId()).isPresent());        // then        assertThat(body).isNotNull();        assertThat(body.getAggregateId()).isNotEmpty();        assertThat(body.getTitle()).isEqualTo(SUPER_MOVIE);        Optional&amp;lt;MovieDTO&amp;gt; persistedMovie = movieRepository                    .findByExternalMovieId(body.getExternalMovieId());        persistedMovie.ifPresent(movie -&amp;gt; {            assertThat(movie).isEqualTo(body);            assertThat(movie.getCreationDate()).isEqualTo(NOW);            assertThat(movie.isWatched()).isFalse();        });    }    ...}W tym podejÅ›ciu rÃ³wnieÅ¼ wykorzystaÅ‚em kontenery testowe, tak samo, jak przy testach integracyjnych, konfiguracja jest identyczna.Nie chcÄ™ uzaleÅ¼niaÄ‡ Å¼adnych testÃ³w od poÅ‚Ä…czenia z zewnÄ™trznym serwisem, wiÄ™c i w tym przypadku posÅ‚uÅ¼yÅ‚em siÄ™ mockiem, symulujÄ…cym dziaÅ‚anie proxy-service.PodsumowanieJak widaÄ‡ korzystanie z Axonowych fixture bardzo uÅ‚atwia testowanie kodu, a i w przypadku testÃ³w wymagajÄ…cych szerszego kontekstu rÃ³wnieÅ¼ istniejÄ… rozwiÄ…zania.Uruchamianie takich testÃ³w moÅ¼na w Å‚atwy sposÃ³b zautomatyzowaÄ‡, np. uÅ¼ywajÄ…c Travisa, dziÄ™ki czemu bÄ™dziemy znali na bieÅ¼Ä…co stan naszej aplikacji.Å¹rÃ³dÅ‚a  https://github.com/matty-matt/movie-keeper-core",
"url": "/2020/08/27/axon-kompleksowe-testowanie-aplikacji.html",
"author": "Mateusz Kociszewski",
"authorUrl": "/authors/mkociszewski.html",
"image": "mkociszewski.webp",
"highlight": "/assets/img/posts/2020-07-30-axon-kompleksowe-testowanie-aplikacji/axontest.jpg",
"date": "27-08-2020",
"path": "pl/2020-07-30-axon-kompleksowe-testowanie-aplikacji"
}
,


"2020-07-08-ansible-jak-uporzadkowac-chaos-html": {
"title": "Ansible - jak uporzÄ…dkowaÄ‡ chaos?",
"lang": "pl",
"tags": "ansible automation devops",
"content": "Czy istnieje moÅ¼liwoÅ›Ä‡ usprawnienia istniejÄ…cych procesÃ³w instalacji aplikacji lub nawet caÅ‚ych systemÃ³w mimo, Å¼e te sprawdzajÄ… siÄ™ juÅ¼ od wielu lat? Okazuje siÄ™, Å¼e tak. MoÅ¼na dziÄ™ki temu zaoszczÄ™dziÄ‡ trochÄ™ czasu na analizÄ™ wystÄ™pujÄ…cych problemÃ³w, a takÅ¼e zwiÄ™kszyÄ‡ czytelnoÅ›Ä‡ skryptÃ³w wykorzystywanych do instalacji. Ponadto moÅ¼na z administratora zdjÄ…Ä‡ obowiÄ…zek orientowania siÄ™ w konfiguracji dziesiÄ…tek serwerÃ³w.Wystarczy w tym celu zastosowaÄ‡ oprogramowanie do automatyzacji procesÃ³w. Takim narzÄ™dziem moÅ¼e byÄ‡ Ansible od Red Hatâ€™a. W poniÅ¼szym artykule opisano przykÅ‚ady wykorzystania Ansibleâ€™a do instalacji platformy Eximee oraz kilku mikroserwisÃ³w wykorzystywanych przez klientÃ³w firmy. Opisane zostaÅ‚y podstawowe elementy oprogramowania i ich wykorzystanie. Wspomniano o sytuacjach, ktÃ³re moÅ¼na byÅ‚o zrobiÄ‡ lepiej podczas implementacji. Na koniec wymieniono gÅ‚Ã³wne zalety migracji ze skryptÃ³w bashowych na Ansible.Jak byÅ‚o kiedyÅ›?ZrÄ™cznoÅ›Ä‡ tworzenia skryptÃ³w w bashu od dawna jest waÅ¼nÄ… umiejÄ™tnoÅ›ciÄ… administratorÃ³w systemÃ³w informatycznych i osÃ³b dziaÅ‚ajÄ…cych w obszarze DevOps. Pozwala automatyzowaÄ‡ dowolne zadania od tworzenia plikÃ³w i nadawania im odpowiednich uprawnieÅ„, po wdraÅ¼anie i konfigurowanie gotowych aplikacji na docelowych serwerach. Skoro wiÄ™c istniejÄ… juÅ¼ sprawdzone i stosowane od wielu lat sposoby automatyzacji procesÃ³w, to czy warto je modyfikowaÄ‡ lub usprawniaÄ‡? Innymi sÅ‚owy, czy jest sens zmieniaÄ‡ coÅ›, co dziaÅ‚a?Platforma Eximee, ktÃ³rÄ… rozwijamy, instalowana byÅ‚a wÅ‚aÅ›nie przy uÅ¼yciu skryptÃ³w bashowych. Wszystkie wykorzystywane tam funkcje przez lata zostaÅ‚y doszlifowane, aby spaÅ‚niaÅ‚y konkretne wymagania klientÃ³w i byÅ‚y na tyle uniwersalne, aby ograniczyÄ‡ liczbÄ™ wprowadzanych w nich zmian. Napisany kod speÅ‚niaÅ‚ wszystkie zaÅ‚oÅ¼enia â€“ tworzyÅ‚ odpowiedniÄ… strukturÄ™ katalogÃ³w, nadawaÅ‚ uprawnienia, zastÄ™powaÅ‚ placeholdery odpowiednimi wartoÅ›ciami z pliku konfiguracyjnego, startowaÅ‚ poszczegÃ³lne aplikacje osadzone wczeÅ›niej w katalogach docelowych, itp.ChoÄ‡ proces wydaje siÄ™ prosty, to nie kaÅ¼da instalacja platformy koÅ„czyÅ‚a siÄ™ sukcesem. Przyczyn bywaÅ‚o kilka â€“ niechÄ™Ä‡ instalujÄ…cego do dokÅ‚adnego zapoznania siÄ™ z dokumentacjÄ…, czy choÄ‡by brak wczeÅ›niejszego doÅ›wiadczenia we wdraÅ¼aniu platformy. Zawsze mogÅ‚a zdarzyÄ‡ siÄ™ sytuacja, Å¼e nie wszystkie parametry instalacyjne zostaÅ‚y ustawione. TakÅ¼e uÅ¼ytkownik, z ktÃ³rego uruchamiano skrypt byÅ‚ nie bez znaczenia. MusiaÅ‚ on posiadaÄ‡ wszystkie uprawnienia do wykonania zawartych w kodzie instrukcji. KaÅ¼da z wymienionych przyczyn wymagaÅ‚a analizy. Aby ta byÅ‚a moÅ¼liwa konieczne byÅ‚o logowanie poszczegÃ³lnych etapÃ³w wykonania skryptu i wartoÅ›ci, ktÃ³re miaÅ‚y wpÅ‚yw na nieudanÄ… instalacjÄ™. Fakt ten wymagaÅ‚ przygotowania dodatkowych instrukcji tworzÄ…cych plik z logiem i wypisujÄ…cych stan instalacji na ekran konsoli uÅ¼ytkownika, tym samym zwiÄ™kszajac zÅ‚oÅ¼onoÅ›Ä‡ i rozmiar skryptu.Sam start instalacji byÅ‚ doÅ›Ä‡ prosty. WystarczyÅ‚o rozpakowaÄ‡ archiwum ZIP, zawierajÄ…ce piki instalacyjne platformy Eximee i wykonaÄ‡ znajdujÄ…cy siÄ™ tam skrypt, przekazujÄ…c plik z ustawieniami dostosowanymi dla danego serwera. Plik z ustawieniami tworzony byÅ‚ po stronie klienta i rozwijany w oparciu o zaÅ‚Ä…czane instrukcje.Uruchomienie skryptu instalacyjnego:$ ./update.sh ~/config/settings.shCo dziaÅ‚o siÄ™ po uruchomieniu skryptu update.sh? Zasadniczo za kaÅ¼dym razem to samo. Zatrzymywane byÅ‚y kluczowe procesy (Tomcat, Servicemix, itd.), usuwane byÅ‚y â€Å›ladyâ€ po poprzedniej instalacji, rozpakowywana byÅ‚a zawartoÅ›Ä‡ archiwum, a wszystkie pliki trafiaÅ‚y do ustalonej struktury katalogÃ³w na serwerze klienta. Na koniec ponownie uruchamiane byÅ‚y kluczowe aplikacje. PrzykÅ‚adowa funkcja usuwajÄ…ca dotychczas wyglÄ…daÅ‚a tak:function cleanOldVersion {     \tlog &quot;Czyszczenie poprzedniej instalacji&quot;    \t   \tCONFIGS=&quot;${installSettings[&#39;ROOT&#39;]}/${installSettings[&#39;CONFIG_FOLDER&#39;]}&quot;    \tBINS=&quot;${installSettings[&#39;ROOT&#39;]}/${installSettings[&#39;BINARIES_FOLDER&#39;]}&quot;       \tlog &quot;Usuwanie: $CONFIGS/eximee/bundles_config&quot;    \trm -rf $CONFIGS/eximee/bundles_config || fail &quot;Blad przy czyszczeniu poprzedniej instalacji&quot;       \tlog &quot;Usuwanie: $CONFIGS/eximee/logback&quot;    \trm -rf $CONFIGS/eximee/logback || fail &quot;Blad przy czyszczeniu poprzedniej instalacji&quot;       \tlog &quot;Usuwanie: find $CONFIGS/eximee/ -maxdepth 1 -type f -name \\*.xml&quot;    \tfind $CONFIGS/eximee/ -maxdepth 1 -type f -name *.xml | grep -v &quot;konfiguracja-partnera&quot; |    \tgrep -v \t&quot;knowledge-base&quot; | xargs rm -rf || fail &quot;Blad przy czyszczeniu \tpoprzedniej instalacji&quot;       \tlog &quot;Czyszczenie tomcata.\\nUsuwanie plikÃ³w i katalogÃ³w bez webapps&quot;    \tfind $BINS/tomcat/ -maxdepth 1 -mindepth 1 -not -name &quot;webapps&quot; | xargs rm -rf       \tlog &quot;Usuwanie aplikacji bez knowledgebase&quot;    \tfind $BINS/tomcat/webapps/ -maxdepth 1 -mindepth 1 -not -name &quot;knowledgebase*&quot; | \txargs rm -rf      \tlog &quot;Czyszczenie tomcata 9 na JVM 11.\\nUsuwanie plikÃ³w i katalogÃ³w bez webapps&quot;    \tfind $BINS/tomcat-jvm11/ -maxdepth 1 -mindepth 1 -not -name &quot;webapps&quot; | xargs rm -rf       \tlog &quot;Usuwanie aplikacji bez knowledgebase&quot;    \tfind $BINS/tomcat-jvm11/webapps/ -maxdepth 1 -mindepth 1 -not -name &quot;knowledgebase*&quot; | \txargs rm -rf       \tlog &quot;Usuwanie: $BINS/eximee/bundles/\\*&quot;    \trm -rf $BINS/eximee/bundles/* || fail &quot;Blad przy czyszczeniu poprzedniej instalacji&quot;       \tlog &quot;Usuwanie: $BINS/eximee/bundles-jvm11/\\*&quot;    \trm -rf $BINS/eximee/bundles-jvm11/* || fail &quot;Blad przy czyszczeniu poprzednieji instalacji&quot;       \tif [ -d $BINS/servicemix/data/cache/bundle212 ]; then     \t\tlog &quot;Usuwanie: $BINS/servicemix/data/cache/bundle212&quot;     \t\trm -rf $BINS/servicemix/data/cache/bundle212 || fail &quot;Blad przy czyszczeniu \t\t\t\tpoprzedniej instalacji&quot;    \tfi       \tlog $PHASE_SEPARATOR       \tlog &quot;Czyszczenie zalezne od platformy&quot;    \tcleanSystemBased || fail &quot;Blad czyszczenia czesci zaleznej od platformy&quot;    \tlog $PHASE_SEPARATOR   }Niby nic nadzwyczajnego, a jednak na samo logowanie postÄ™pu i usuniÄ™cie plikÃ³w, ktÃ³re i tak zostanÄ… ponownie wgrane na Å›rodowisko wraz z nowÄ… paczkÄ…, przeznaczono jakieÅ› 30 linii kodu. ChoÄ‡ logowanie niekoniecznie byÅ‚o niezbÄ™dne, to jednak pozwalaÅ‚o Å›ledziÄ‡ kolejne etapy procesu instalacji, dajÄ…c wiÄ™kszÄ… wiedzÄ™ osobom analizujÄ…cym ewentualne przyczyny nieudanej instalacji.W takim razie, co miaÅ‚ zrobiÄ‡ administrator systemu, ktÃ³ry chciaÅ‚by skrÃ³ciÄ‡ proces i zainstalowaÄ‡ tylko te komponenty, ktÃ³re ulegÅ‚y zmianie? No cÃ³Å¼, musiaÅ‚ on wykazaÄ‡ siÄ™ nie lada cierpliwoÅ›ciÄ… i pewnoÅ›ciÄ… siebie, modyfikujÄ…c doÅ‚Ä…czony do paczki skrypt instalacyjny lub po prostu pogodziÄ‡ siÄ™ z faktem, Å¼e nie da siÄ™ tego zrobiÄ‡ â€na skrÃ³tyâ€.Jakby tego byÅ‚o maÅ‚o, chcÄ…c zainstalowaÄ‡ kompletnÄ… platformÄ™ na â€Å›wieÅ¼ymâ€ Å›rodowisku konieczna byÅ‚a praca z kilkoma archiwami zip, ktÃ³re zawieraÅ‚y poszczegÃ³lne skÅ‚adowe systemu. Osobno bowiem dostarczano strukturÄ™ bazy danych, frontend, backend czy aplikacje do zarzÄ…dzania systemem plikÃ³w. W skrÃ³cie, aby administrator zainstalowaÅ‚ platformÄ™ Eximee musiaÅ‚ co najmniej 4 razy powtÃ³rzyÄ‡ podobny proces dla kaÅ¼dej czÄ™Å›ci platformy.Era Ansible JuÅ¼ od wczesnych lat studiÃ³w programistom wpaja siÄ™, aby dÄ…Å¼yÄ‡ do utrzymania eleganckiej i czytelnej struktury swoich aplikacji (KISS â€“ Keep it simple, stupid). Doskonale w ten trend wpasowuje siÄ™ Ansible. To kupione przez firmÄ™ Red Hat opensourceâ€™owe oprogramowanie m.in. do automatyzacji procesu wdraÅ¼ania aplikacji i zarzÄ…dzania konfiguracjÄ…. Za pomocÄ… jÄ™zyka YAML, w prosty sposÃ³b pozwala opisaÄ‡ wzajemne relacje miÄ™dzy systemami.CzytajÄ…c dokumentacjÄ™ dostajemy obietnicÄ™ ujednolicenia konfiguracji, organizacji zÅ‚oÅ¼onych procesÃ³w i jednoczeÅ›nie Å‚atwÄ… do zarzÄ…dzania architekturÄ™. Ponadto czytamy, Å¼e Ansible pozwala osiÄ…gnÄ…Ä‡ wzrost wydajnoÅ›ci i nie nakÅ‚ada dodatkowych wymagaÅ„ na otoczenie, w ktÃ³rym dziaÅ‚a.Do pracy z Ansible wymagane jest tylko, aby na maszynie sterujÄ…cej zainstalowane byÅ‚y:  Python 2.7 lub Python 3.5+  Ansible (np. przy uÅ¼yciu Python Package Managerâ€™a)Ansible wymaga hasÅ‚a lub klucza SSH w celu rozpoczÄ™cia zarzÄ…dzania systemami i moÅ¼e rozpoczÄ…Ä‡ zarzÄ…dzanie nimi bez instalowania oprogramowania agenta, unikajÄ…c problemu â€zarzÄ…dzania zarzÄ…dzaniemâ€ powszechnego w wielu systemach do automatyzacji.Ansible Å‚Ä…czy siÄ™ z systemami poprzez mechanizmy transportowe â€“ SSH (Unix) lub PowerShell (Windows). ModuÅ‚y, ktÃ³re sÄ… maÅ‚ymi programami, zawierajÄ…ce uzupeÅ‚nione argumenty, przenoszone sÄ… do tymczasowego katalogu przez wspomniane mechanizmy na zarzÄ…dzane maszyny. Tam sÄ… wykonywane, a nastÄ™pnie usuwane w ramach jednej akcji. ModuÅ‚y zwracajÄ… obiekty JSON na standardowe wyjÅ›cie, a te z kolei przetwarzane sÄ… przez program Ansible na maszynie sterujÄ…cej. MogÄ… one zarzÄ…dzaÄ‡ zasobami w sposÃ³b indempotentny. Oznacza to, Å¼e moduÅ‚ dziaÅ‚a w sposÃ³b deklaratywny, czyli moÅ¼e zdecydowaÄ‡ np. czy dany pakiet powinien zostaÄ‡ zainstalowany w okreÅ›lonej wersji lub nie wykonaÄ‡ Å¼adnej akcji, gdy system jest juÅ¼ w poÅ¼Ä…danym stanie. MoÅ¼na je teÅ¼ uruchamiaÄ‡ pojedynczo (imperatywnie).Do zarzÄ…dzania administrowanymi systemami sÅ‚uÅ¼Ä… pliki inventory. PozwalajÄ… one na grupowanie serwerÃ³w i definiowanie zmiennych, ktÃ³re pÃ³Åºniej wykorzystywane bÄ™dÄ… w tzw. playbookach. Plik inventory moÅ¼e byÄ‡ uÅ¼yty globalnie, w ramach instalacji Ansible, lub wykorzystaÄ‡ lokalne pliki inventory dedykowane dla konkretnego projektu. PrzykÅ‚adowy fragment pliku inventory wyglÄ…da nastÄ™pujÄ…co:# eximee-ansible/settings/settings-template.yml### OgÃ³lne parametry instalacjivalidation_protocol: httpvalidation_host: eximee-validationvalidation_port: 8080services_protocol: httpservices_host: eximee-servicesservices_port: 8080servicemix_host: eximee-servicemixvalidation_url: &quot;{{ validation_protocol }}://{{ validation_host }}:{{ validation_port }}/osgi-bridge/validation/&quot;services_url: &quot;{{ services_protocol }}://{{ services_host }}:{{ services_port }}/osgi-bridge/serviceproxy/&quot;eximee_status_url: &quot;{{ eximee_status_protocol }}://{{ eximee_status_host }}:{{ eximee_status_port }}/eximee-status/&quot;repository_url: &quot;{{ repository_protocol }}://{{ repository_host }}:{{ repository_port }}/repository/&quot;repository_username: UZUPELNIJrepository_password: UZUPELNIJmongodb_host: eximee-mongomongo_db_auth: MONGODB-CR...W pliku inventory znajdujÄ… siÄ™ zatem dane dotyczÄ…ce hostÃ³w czy uÅ¼ywanych portÃ³w. W inventory warto umieÅ›ciÄ‡ rÃ³wnieÅ¼ takie zmienne, ktÃ³re sÄ… czÄ™Å›ciej wykorzystywane w playbookach lub zaleÅ¼ne sÄ… np. od serwerÃ³w, na ktÃ³rych instalujemy aplikacjÄ™. Nie powinno siÄ™ bowiem modyfikowaÄ‡ playbookÃ³w przy okazji kaÅ¼dej instalacji, a utrzymywaÄ‡ dla danego serwera odpowiedniÄ… konfiguracjÄ™. W przypadku platformy Eximee takimi zmiennymi sÄ… np. adresy URL rÃ³Å¼nych aplikacji. Warto teÅ¼ zwrÃ³ciÄ‡ uwagÄ™, Å¼e adresy w powyÅ¼szym przykÅ‚adzie nie sÄ… zdefiniowane â€na sztywnoâ€. ZawierajÄ… one odwoÅ‚ania do kilku innych zmiennych tworzÄ…c nowÄ… wartoÅ›Ä‡, na co rÃ³wnieÅ¼ pozwala Ansible.Do zapamiÄ™tania haseÅ‚ i innych danych uwierzytelniajÄ…cych pomocne okaÅ¼e siÄ™ Ansible Vault. WÅ‚aÅ›ciwoÅ›Ä‡ ta pozwala na przechowywanie poufnych i wraÅ¼liwych danych (np. haseÅ‚) w inny sposÃ³b, niÅ¼ w postaci zwykÅ‚ego tekstu w plikach inventory, rolach lub playbookach. WykorzystujÄ…c poniÅ¼sze polecenie i podajÄ…c hasÅ‚o, przy uÅ¼yciu ktÃ³rego konfiguracja zostanie zaszyfrowana, moÅ¼na w prosty sposÃ³b zabezpieczyÄ‡ wskazany plik.$ ansible-vault encrypt /path/to/fileNew Vault password: Confirm New Vault password: Encryption successfulZawartoÅ›Ä‡ takiego zasobu, ktÃ³ry przed wykonaniem operacji wyglÄ…daÅ‚ nastÄ™pujÄ…co:---repository_username: repoUserrepository_password: ^$asdY$4-(56aspo uÅ¼yciu Ansible Vault wyglÄ…da znacznie bezpieczniej:$ANSIBLE_VAULT;1.1;AES256393038396565633461386537343838613639376439343235633565333664373336333833393237393135386136336365316535346630333261316232393238360a353437383762386665363662316138636361393731623061653962313862653332646365376164636339353736373661646237623531353263663338323163350a38623038303465353836353830353737643535616634633738663762366238613839356538336530636136333065343935393034656434666464623033633330656162643838643761656633303664633131653362373438636364376664373039643133623139353663323463623331343838326238393364333266353937313937663762653739343932363336623165353435646531366662633837353562Uruchomienie playbooka, ktÃ³ry wykorzystuje zaszyfrowane pliki moÅ¼liwe jest poprzez uÅ¼ycie dyrektywy --ask-vault-pass, np.:$ ansible-playbook --ask-vault-pass --inventory inventory_file sample_playbook.ymlWiedzÄ…c juÅ¼ czym jest moduÅ‚ oraz gdzie naleÅ¼y umieÅ›ciÄ‡ konfiguracjÄ™, potrzebna jest jeszcze wiedza, jak definiowaÄ‡ pewien stan systemu, ktÃ³ry chcemy osiÄ…gnÄ…Ä‡. Do tego wÅ‚aÅ›nie sÅ‚uÅ¼Ä… playbooki. Definicja takiego stanu dzieli siÄ™ na taski. ZwiÄ™ksza to nie tylko czytelnoÅ›Ä‡ kodu playbooka, ale teÅ¼ oddziela od siebie niezaleÅ¼ne etapy instalacji.# eximee-ansible/platform.yml---- name: Create installation_tmp dir  hosts: localhost  become: no  connection: local  tasks:    - file:        path: &quot;/installation_tmp&quot;        state: directory- import_playbook: check-settings.yml- import_playbook: eximee-common.yml- import_playbook: dmzzew.yml- import_playbook: dmz.yml- import_playbook: formstore.yml- name: Remove installation_tmp dir  hosts: localhost  become: no  gather_facts: false  connection: local  tasks:    - file:        path: &quot;/installation_tmp&quot;        state: absentW powyÅ¼szym przykÅ‚adzie widoczne sÄ… dwa proste zadania. Pierwsze, o nazwie Create installation_tmp dir tworzy tymczasowy katalog instalacyjny installation_tmp w lokalizacji, ktÃ³ra zdefiniowana zostaÅ‚a pod zmiennÄ… eximee_platform_dest. Drugie (Remove installation_tmp dir) ten katalog usuwa. PomiÄ™dzy tymi zadaniami zaimportowane zostaÅ‚y odseparowane logicznie playbooki. KaÅ¼dy z nich instaluje odrÄ™bnÄ… czÄ™Å›Ä‡ platformy, a ich rozdzielenie jeszcze bardziej zwiÄ™ksza czytelnoÅ›Ä‡ kodu. Co ciekawe, rÃ³wnieÅ¼ importowane playbooki zostaÅ‚y odpowiednio podzielone na role, ktÃ³re, na podstawie okreÅ›lonej struktury plikÃ³w, pozwalajÄ… na automatyczne Å‚adowanie zmiennych czy taskÃ³w. Ponadto, grupowanie zadaÅ„ w role pozwala na ich Å‚atwe reuÅ¼ywanie.Jak uruchomiÄ‡ taki skrypt instalacyjny? Nic prostszego â€“ wystarczy poniÅ¼sza instrukcja:$ ansible-playbook nazwa_playbooka.ymlDocelowo wiÄ™c pierwotna struktura paczki wdroÅ¼eniowej, skÅ‚adajÄ…cej siÄ™ ze skryptÃ³w bashowych, domyÅ›lnych parametrÃ³w konfiguracyjnych i plikÃ³w z platformÄ…, nabraÅ‚a nowego charakteru. Wprowdzone modyfikacje pozwoliÅ‚y na wydzielenie wielu plikÃ³w z odseperowanymi logicznie zadaniami, ktÃ³re nie musiaÅ‚y juÅ¼ byÄ‡ rozpakowywane na maszynie docelowej, a jedynie uruchomione z odpowiednim uÅ¼ytkownikiem z poziomu maszyny kontrolnej:eximee-ansible|â”€â”€common|â”€â”€roles                                   # katalog agregujÄ…cy role|   |â”€â”€java8                               # rola java8|   |   |â”€â”€tasks                           # taski zdefiniowane w ramach roli java8|   |   |   |  ensure-dir-exists.yml     |   |   |   |  install.yml|   |   |   |  main.yml|   |   |   |  unarchive.yml|   |â”€â”€java11|   |   |â”€â”€tasks                           # taski zdefiniowane w ramach roli java11|   |   |   |  ...|   |â”€â”€tomcat-server                       # rola tomcat-server|   |   |â”€â”€tasks                           # taski zdefiniowane w ramach roli tomcat-server|   |   |   |  main.yml|   |   |   |  server.yml|   |   |   |  setup.yml|   ...|â”€â”€settings                                # ogÃ³lne parametry instalacji |   |   settings-template.yml             |   check-settings.yml                     # playbook weryfikujÄ…cy czy wszystkie wymagane parametry instalacyjne zostaÅ‚y zdefiniowane|   formstore.yml                          # playbook instalacyjny dla roli formstore|   platform.yml                           # gÅ‚Ã³wny playbook instalacyjny|   ...Jakie korzyÅ›ci niosÅ‚a za sobÄ… taka zmiana? Tych byÅ‚o kilka:  idempotenetnoÅ›Ä‡ stanu docelowego â€“ nie instalujemy czegoÅ›, co juÅ¼ jest w poÅ¼Ä…danym stanie;  moÅ¼liwoÅ›Ä‡ zarzÄ…dzania konfiguracjami poszczegÃ³lnych komponentÃ³w platformy Eximee;  platforma dostarczana jest jednÄ… paczkÄ…, zawierajÄ…cÄ… wszystkie komponenty;  instalacja odbywaÄ‡ siÄ™ bÄ™dzie bardzo podobnie, jak miaÅ‚o to miejsce w przypadku skryptÃ³w bashowych â€“ uruchamiany bÄ™dzie gÅ‚Ã³wny playbook wraz ze wskazanaiem pliku konfiguracyjnego;  moÅ¼liwoÅ›Ä‡ uruchomienia skryptÃ³w z poziomu maszyny sterujÄ…cej â€“ system bÄ™dzie wiedziaÅ‚ na jakim serwerze ma zostaÄ‡ zainstalowana platforma;  instalowane bÄ™dÄ… tylko te aplikacje, ktÃ³rych konfiguracja siÄ™ zmieniÅ‚a;  wbudowany mechanizm logowania postÄ™pu instalacji;  znaczna poprawa czytelnoÅ›ci;  Å‚atwa moÅ¼liwoÅ›Ä‡ rozszerzerzania skryptÃ³w â€“ np. o tagi, pozwalajÄ…ce na wykonanie skryptÃ³w tylko dla danego komponentu lub grupy komponentÃ³w.Ansible, a instalacja mikroserwisÃ³wPrzejÅ›cie na nowy sposÃ³b instalacji wykonane zostaÅ‚o nie tylko dla komponentÃ³w platformy, ale teÅ¼ dla mikroserwisÃ³w dostarczanych dla jednego z klientÃ³w. W kaÅ¼dym takim mikroserwisie, bÄ™dÄ…cym klasycznÄ… aplikacjÄ… Spring BootowÄ…, wydzielono dodatkowy moduÅ‚, w ktÃ³rym zdefiniowano taski odpowiedzialne za:  kopiowanie wykonywalnego jara na docelowe Å›rodowisko, pod okreÅ›lonÄ… w konfiguracji lokalizacjÄ™;  utworzenie katalogu z konfiguracjÄ…;  kopiowanie konfiguracji do utworzonego katalogu;  utworzenie katalogu z logami;  kopiowanie konfiguracji logbackâ€™a na Å›rodowisko docelowe;  restart aplikacji, jeÅ¼eli ta jest juÅ¼ uruchomiona na Å›rodowisku;  weryfikacjÄ™ dziaÅ‚ania aplikacji.Instalacja takiego mikroserwisu sprowadzaÅ‚a siÄ™ do uzupeÅ‚nienia parametrÃ³w konfiguracyjnych w pliku hosts-template.yml oraz wykonania polecenia:$ ansible-playbook --inventory hosts-template.yml microservice-x.yml -vvvvPlik microservice-x.yml to nic innego, jak gÅ‚Ã³wny playbook grupujÄ…cy w rolach wszystkie powyÅ¼sze zadania. Playbook jest bardzo prosty i wyglÄ…da nastÄ™pujÄ…co:---- name: deploy microservice-x  hosts: lan  become: &#39;&#39;  become_user: &#39;&#39;  roles:    - microservice-xJuÅ¼ na pierwszy rzut oka widaÄ‡, Å¼e wspomniane taski mogÅ‚y zostaÄ‡ z powodzeniem wydzielone do osobnego projektu. Ten odrÄ™bny byt mÃ³gÅ‚by staÄ‡ siÄ™ wspÃ³lnym elementem dla wszystkich mikroserwisÃ³w po to, by nie powielaÄ‡ kodu i zmniejszyÄ‡ zÅ‚oÅ¼onoÅ›Ä‡ dodatkowego moduÅ‚u. W takich kwestiach bardzo pomocny jest rozdziaÅ‚ poÅ›wiÄ™cony dobrym praktykom w samej dokumentacji Ansible, dostÄ™pny pod adresem: dobre praktyki.Podczas pierwszych wdroÅ¼eÅ„ na Å›rodowisku klienckim okazaÅ‚o siÄ™, Å¼e konieczne jest wprowadzenie dodatkowej konfiguracji. PowyÅ¼sza definicja playbooka jest juÅ¼ w niÄ… zaopatrzona. Chodzi bowiem o dyrektywy become oraz become_user. Pierwsze instalacje aplikacji koÅ„czyÅ‚y siÄ™ niepowodzeniem z powodu braku odpowiednich uprawnieÅ„. Dyrektywa become pozwala na ich tzw. eskalacjÄ™ czyli wykonanie zadania z uprawnieniami innego uÅ¼ytkownika, niÅ¼ obecnie zalogowany (zdalny). Innymi sÅ‚owy zastosowanie dyrektywy become pozwala na wykonanie poleceÅ„ przy uÅ¼yciu takich narzÄ™dzi jak sudo, su, runas, itd. JeÅ¼eli zdefiniowana zostanie jedynie dyrektywa become, uÅ¼ytkownik domyÅ›lnie otrzymuje uprawnienia rootâ€™a. Problem w tym, Å¼e nie zawsze to wÅ‚aÅ›nie ten uÅ¼ytkownik byÅ‚ tym poÅ¼Ä…danym. Tu z pomocÄ… przyszÅ‚a dyrektywa become_user, ktÃ³ra pozwala na zdefiniowanie nazwy uÅ¼ytkownika, z ktÃ³rym mamy np. wykonaÄ‡ odpowiednie zadanie. Wykorzystanie w powyÅ¼szym przykÅ‚adzie playbooka nastÄ™pujÄ…cych wartoÅ›ci:switch_user: yes            # wÅ‚Ä…czenie eskalacji uprawnieÅ„switched_user: tomcat       # przeÅ‚Ä…czenie na uÅ¼ytkownika o nazwie tomcatpozwoli na wykonanie zadaÅ„ z poziomu uÅ¼ytkownika o nazwie tomcat, a nie tego, ktÃ³ry jest obecnie zalogowany na serwerze.Åšledzenie postÄ™pÃ³w instalacjiAnsible dostarcza wbudowany mechanizm logowania, pozwalajÄ…cy na Å›ledzenie postÄ™pÃ³w instalacji oraz uzyskanie informacji, ktÃ³re zadania zostaÅ‚y wykonane, a ktÃ³re nie. PrzykÅ‚adowy log procesu instalacji mikroserwisu wyglÄ…da nastÄ™pujÄ…co:PLAY [deploy microservice-x] ********************************************************************************************************************************************************************************TASK [Gathering Facts] **********************************************************************************************************************************************************************************ok: [lan]TASK [microservice-x : copy microservice-x jar] *****************************************************************************************************************************************************************[WARNING]: Unable to find &#39;../files/bundles&#39; in expected paths (use -vvvvv to see paths)TASK [microservice-x : create config directory] *************************************************************************************************************************************************************ok: [lan]TASK [ microservice-x : copy application properties] *********************************************************************************************************************************************************ok: [lan] =&amp;gt; (item=/home/users/rmastalerek/Projects/Eximee/microservice-x/microservice-x-deploy/src/main/ansible/install/roles/microservice-x/files/../templates/application.properties.j2)TASK [microservice-x : make sure logs directory exists] *****************************************************************************************************************************************************ok: [lan]TASK [microservice-x : create logs directory] ***************************************************************************************************************************************************************skipping: [lan]TASK [microservice-x : make sure sensitive logs directory exists] *******************************************************************************************************************************************ok: [lan]TASK [microservice-x : create sensitive logs directory] *****************************************************************************************************************************************************skipping: [lan]TASK [microservice-x : copy logback conf] *******************************************************************************************************************************************************************ok: [lan]TASK [microservice-x : get pid of microservice-x] ***************************************************************************************************************************************************************changed: [lan]TASK [microservice-x : kill microservice-x processes] ***********************************************************************************************************************************************************changed: [lan] =&amp;gt; (item=14454)TASK [microservice-x : wait_for] ****************************************************************************************************************************************************************************ok: [lan] =&amp;gt; (item=14454)TASK [microservice-x : stop microservice-x] *********************************************************************************************************************************************************************TASK [microservice-x : start/restart microservice-x] ************************************************************************************************************************************************************changed: [lan]TASK [microservice-x : check if microservice-x process exists] **************************************************************************************************************************************************ok: [lan]TASK [microservice-x : report status of service] ************************************************************************************************************************************************************skipping: [lan]TASK [microservice-x : report status of service] ************************************************************************************************************************************************************ok: [lan] =&amp;gt; {    &quot;msg&quot;: &quot;Microservice-x works&quot;}PLAY RECAP **********************************************************************************************************************************************************************************************lan             : ok=12   changed=3    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0 SposÃ³b prezentowania informacji przez Ansible jest doÅ›Ä‡ czytelny. InstalacjÄ™ rozpoczyna uruchomienie playbooka o nazwie deploy microservice-x. NastÄ™pnie wykonywany jest domyÅ›lny, ansibleâ€™owy task Gathering Facts, ktÃ³ry zbiera informacjÄ™ o hostach, na ktÃ³rych wykonywane bÄ™dÄ… zmiany. PÃ³Åºniej juÅ¼ wykonywane sÄ… wszystkie zadania zdefiniowane w playbooku i wykorzystywanych rolach. KaÅ¼de zadanie koÅ„czy siÄ™ pewnym statusem. Na powyÅ¼szym przykÅ‚adzie widaÄ‡, Å¼e zadania uzyskaÅ‚y takie statusy, jak: ok, changed czy skipping. DziÄ™ki wspomnianej na poczÄ…tku idempotentnoÅ›ci niektÃ³re zadania zostaÅ‚y pominiÄ™te, poniewaÅ¼ system byÅ‚ juÅ¼ w poÅ¼Ä…danym stanie. Tym zadaniom system przypisaÅ‚ status ok. Taski, ktÃ³re wymagaÅ‚y wykonania jakiejÅ› zmiany na serwerze oznaczone zostaÅ‚y statusem changed. Status skipping zostaÅ‚ przypisany zadaniom, ktÃ³rych wykonanie zostaÅ‚o oparte o pewien warunek, a ten z kolei nie zostaÅ‚ speÅ‚niony.KaÅ¼de wykonanie playbooka koÅ„czy siÄ™ podsumowaniem. Zawiera ono zbiorczÄ… informacjÄ™ dotyczÄ…cÄ… wszystkich zadaÅ„ oraz ich koÅ„cowych statusach. Gdyby okazaÅ‚o siÄ™, Å¼e jeden z kluczowych taskÃ³w nie moÅ¼e zostaÄ‡ wykonany, np. z powodu braku poÅ‚Ä…czenia z serwerem docelowym, to skrypt zakoÅ„czyÅ‚by swoje wykonanie na tym zadaniu, np.:PLAY [deploy microservice-x] ********************************************************************************************************************************************************************************TASK [Gathering Facts] **********************************************************************************************************************************************************************************fatal: [lan]: UNREACHABLE! =&amp;gt; {&quot;changed&quot;: false, &quot;msg&quot;: &quot;Failed to connect to the host via ssh: ssh: Could not resolve hostname some.host.consdata.local: Temporary failure in name resolution&quot;, &quot;unreachable&quot;: true}PLAY RECAP **********************************************************************************************************************************************************************************************lan                        : ok=0    changed=0    unreachable=1    failed=0    skipped=0    rescued=0    ignored=0Ansible daje moÅ¼liwoÅ›Ä‡ wykonania playbooka z wiÄ™kszÄ… iloÅ›ciÄ… informacji poprzez uÅ¼ycie przeÅ‚Ä…cznika verbose (-vvv lub -vvvv z moÅ¼liwoÅ›ciÄ… debugowania poÅ‚Ä…czenia)PodsumowanieZgrabne zarzÄ…dzanie konfiguracjÄ…, automatyzacja i uproszczenie procesu instalacji, do tego czytelnoÅ›Ä‡ i wiÄ™ksza kontrola nad procesem wdraÅ¼ania aplikacji. To gÅ‚Ã³wne zalety tego, co udaÅ‚o siÄ™ wprowadziÄ‡ zastÄ™pujÄ…c nieco archaiczne podejÅ›cie oparte o bashowe skrypty.Wymienione korzyÅ›ci wpÅ‚ywajÄ… przede wszystkim na skrÃ³cenie czasu wykonywania powtarzalnych czynnoÅ›ci. Sama automatyzacja pozwala ograniczyÄ‡ do minimum ryzyko popeÅ‚nienia bÅ‚Ä™du ludzkiego podczas instalowania aplikacji. Zapis krokÃ³w instalacji aplikacji czy systemu w postaci prostych taskÃ³w oraz grupowanie ich w moduÅ‚y a nastÄ™pnie playbooki pozwala na standaryzacjÄ™ procesu. To z kolei wyklucza niepotrzebne wykonywanie rÄ™cznych zmian i pÃ³ÅºniejszÄ…, czÄ™sto czasochÅ‚onnÄ… analizÄ™ problemu, gdy taki wystÄ…pi. DziÄ™ki plikom inventory nie jest konieczne utrzymywanie przez administratora konfiguracji do znacznej iloÅ›ci serwerÃ³w i dokumentacji do nich. NiewÄ…tpliwÄ… zaletÄ… Ansible jest przewidywalnoÅ›Ä‡. Zapewnia ona efektywnÄ… pracÄ™ administratora czy DevOpsa i ogranicza wystÄ…pienie nieoczekiwanych problemÃ³w.",
"url": "/2020/07/08/ansible-jak-uporzadkowac-chaos.html",
"author": "Robert Mastalerek",
"authorUrl": "/authors/rmastalerek.html",
"image": "rmastalerek.webp",
"highlight": "/assets/img/posts/2020-07-08-ansible-jak-uporzadkowac-chaos/chaos.jpg",
"date": "08-07-2020",
"path": "pl/2020-07-08-ansible-jak-uporzadkowac-chaos"
}
,


"2020-06-09-microservices-on-axon-html": {
"title": "Mikroserwisy na Axonie",
"lang": "pl",
"tags": "java microservices axon event-sourcing spring-boot",
"content": "ZnajÄ…c definicjÄ™ Event Sourcingu oraz korzyÅ›ci, jakie nam zapewnia (dla przypomnienia polecam wpis Marcina poÅ›wiÄ™cony czÄ™Å›ciowo tej tematyce) warto rozwaÅ¼yÄ‡ zastosowanie tego wzorca w swoim projekcie (oczywiÅ›cie nie wszÄ™dzie siÄ™ on nada).Osoby zainteresowane tematem z pewnoÅ›ciÄ… zostanÄ… postawione przed wyborem technologii, w ktÃ³rej rozpocznÄ… implementacjÄ™. NiezaleÅ¼nie od jÄ™zyka programowania, moÅ¼na implementowaÄ‡ CQRS oraz Event Sourcing samemu, od A-Z, jednakÅ¼e byÅ‚oby to czasochÅ‚onne i moÅ¼e prowadziÄ‡ do wielu bÅ‚Ä™dÃ³w. AlternatywÄ… bÄ™dzie zatem skorzystanie z gotowego frameworku, ktÃ³ry od poczÄ…tku tworzony byÅ‚ z myÅ›lÄ… o wspomnianych wzorcach (wÅ‚Ä…czajÄ…c w to mikroserwisy) - mowa tutaj o AxonFramework.W tym wpisie przedstawiÄ™ Axona i omÃ³wiÄ™ wybory, przed ktÃ³rymi staÅ‚em w kontekÅ›cie tego frameworka, oraz drogÄ™ migracji z monolitu do mikroserwisÃ³w wraz z problemami, na ktÃ³re siÄ™ natknÄ…Å‚em.KrÃ³tko o AxonieAxon to framework, ktÃ³ry czerpie garÅ›ciami z Domain Driven Design (ktÃ³re jest poza zakresem tego wpisu), wykorzystujÄ…c rÃ³wnieÅ¼ nomenklaturÄ™ panujÄ…cÄ… w tym podejÅ›ciu, ktÃ³rÄ… takÅ¼e bÄ™dÄ™ siÄ™ posÅ‚ugiwaÅ‚ w tym wpisie.Axon bierze na barki zarzÄ…dzanie przepÅ‚ywem wszystkich informacji miÄ™dzy komponentami np. kierowanie commandÃ³w do odpowiednich agregatÃ³w, czy zapisywanie eventÃ³w w event store. JeÅ¼eli chodzi o kwestie event storeâ€™a, to framework zostawia tu peÅ‚nÄ… dowolnoÅ›Ä‡, choÄ‡ nie kaÅ¼da baza speÅ‚ni siÄ™ w tej roli.Dodatkowym plusem jest bezproblemowa integracja ze Spring Bootem, moÅ¼liwoÅ›Ä‡ skalowania i gotowoÅ›Ä‡ produkcyjna, co moim zdaniem czyni Axona mocnym graczem.Event storeFundamentem projektu opartego o Event Sourcing jest oczywiÅ›cie event store - ÅºrÃ³dÅ‚o prawdy caÅ‚ego systemu, stÄ…d wybÃ³r narzÄ™dzia pod tÄ™ funkcjÄ™ jest kluczowy.MoÅ¼e Kafka?Kafka opiera siÄ™ na eventach, ktÃ³rych kolejnoÅ›Ä‡ pojawiania siÄ™ moÅ¼e zostaÄ‡ zachowana - co zapobiega sytuacji, w ktÃ³rej wykonamy aktualizacjÄ™ krotki, zanim zostanie ona utworzona.Ponadto Kafka trzyma dane na topicach, zapamiÄ™tujÄ…c offset (liczbÄ™ porzÄ…dkowÄ…) dla kaÅ¼dego eventu. ZnajÄ…c offset istnieje moÅ¼liwoÅ›Ä‡ odtworzenia topica od tego offsetu, aÅ¼ do koÅ„ca - umoÅ¼liwia to odtwarzanie idealnego stanu aplikacji dosÅ‚ownie na zawoÅ‚anie (dopÃ³ki nie mamy do czynienia z paruset milionami eventÃ³w :wink:).Do tego Kafka bardzo Å‚atwo siÄ™ skaluje oraz uniemoÅ¼liwia edycjÄ™ naÅ‚oÅ¼onych eventÃ³w, co niewÄ…tpliwie jest plusem. Jest jednak parÄ™ punktÃ³w, ktÃ³re brakujÄ… Kafce, do bycia idealnym kandydatem na event store:  Problem pojawia siÄ™ w momencie, gdy chcielibyÅ›my odtworzyÄ‡ agregat na podstawie eventÃ³w. Kafka w tym momencie musiaÅ‚aby przeiterowaÄ‡ caÅ‚y topic od pewnego offsetu, aÅ¼ do koÅ„ca.W kolejnym kroku konieczne jest odfiltrowanie eventÃ³w nie zwiÄ…zanych z agregatem, ktÃ³ry prÃ³bujemy odtworzyÄ‡, co wymaga od nas dodatkowej logiki w kodzie, oraz nakÅ‚ada niepotrzebny narzut na event store (odfiltrowane eventy nie sÄ… nam potrzebne).  Drugim problemem jest brak natywnego wsparcia dla mechanizmu snapshotÃ³w, bez ktÃ³rego odtwarzanie stanu przy duÅ¼ym wolumenie moÅ¼e trwaÄ‡ wieki.  Kolejnym ograniczeniem rÃ³wnie waÅ¼nym co poprzednie, jest brak optimistic lockingu w Kafce (istnieje jedynie obejÅ›cie w postaci jednego wÄ…tku piszÄ…cego na topic). Bez tego mechanizmu, w wielowÄ…tkowej aplikacji moÅ¼e pojawiÄ‡ siÄ™ problem, gdy wpadnÄ… dwa eventy w tym samym czasie - wtedy jedno z tych zdarzeÅ„ zaaplikuje siÄ™ na modelu zbudowanym z niekompletnego zestawu eventÃ³w.Potencjalnym rozwiÄ…zaniem pierwszego problemu mÃ³gÅ‚by byÄ‡ osobny topic dla kaÅ¼dego agregatu, wÃ³wczas odpada koniecznoÅ›Ä‡ filtrowania eventÃ³w.To rozwiÄ…zanie jednak moÅ¼e nie sprawdziÄ‡ siÄ™ przy ogromnej iloÅ›ci agregatÃ³w. Wynika to ze sposobu, w jaki Kafka przechowuje topici (a wÅ‚aÅ›ciwie partycje) - dla kaÅ¼dej tworzony jest osobny katalog w systemie plikÃ³w. SzczegÃ³Å‚owe wyjaÅ›nienie znajduje siÄ™ w filmie przygotowanym przez AxonIQ (firma odpowiedzialna za rozwÃ³j Axona).AxonServerW kwestii event store AxonIQ wyszedÅ‚ na przeciw potrzebom dajÄ…c do dyspozycji swoje narzÄ™dzie, ktÃ³re idealnie speÅ‚nia siÄ™ w tej roli - AxonServer:  Pozwala na dokÅ‚adanie eventÃ³w (z jednoczesnym brakiem moÅ¼liwoÅ›ci edycji juÅ¼ istniejÄ…cych).  Zapewnia staÅ‚Ä… wydajnoÅ›Ä‡ niezaleÅ¼nie od iloÅ›ci danych przetrzymywanych w event store.  UmoÅ¼liwia konstruowanie snapshotÃ³w dla agregatÃ³w i nakÅ‚adanie ich (w przypadku duÅ¼ej iloÅ›ci eventÃ³w rekonstrukcja agregatu bez funkcjonalnoÅ›ci snapshotÃ³w moÅ¼e trochÄ™ trwaÄ‡).Po uruchomieniu AxonServera mamy dostÄ™p do dashboardu pokazujÄ…cego, ktÃ³ry mikroserwis jest podpiÄ™ty pod event store wraz z jego liczbÄ… instancji:Na samym dashboardzie, funkcjonalnoÅ›ci panelu administracyjnego siÄ™ nie koÅ„czÄ…:  PodglÄ…d konfiguracji wraz z przepustowoÅ›ciÄ… (commandy/eventy/query/snapshoty na sekundÄ™).  MoÅ¼liwoÅ›Ä‡ wyszukiwania eventu przy uÅ¼yciu zapytaÅ„.  Tabelka ze wskazaniem, ktÃ³ry command, ile razy i w jakim serwisie zostaÅ‚ obsÅ‚uÅ¼ony.  ZarzÄ…dzanie dostÄ™pem do panelu.OczywiÅ›cie AxonFramework jest w peÅ‚ni kompatybilny z AxonServerem i dziaÅ‚a out-of-the-box, bez dodatkowej konfiguracji.Najpierw monolitZaczynajÄ…c przygodÄ™ z Axonem, nie chciaÅ‚em skakaÄ‡ na gÅ‚Ä™bokÄ… wodÄ™, zaczÄ…Å‚em wiÄ™c od monolitu, majÄ…c jednak z tyÅ‚u gÅ‚owy perspektywÄ™ zmigrowania na coÅ› bardziej skalowalnego.Migracja z monolitu na mikroserwisy nierzadko sprawia wiele problemÃ³w, tak byÅ‚o rÃ³wnieÅ¼ w moim przypadku z tÄ… aplikacjÄ….W skrÃ³cie pozwala ona na wyszukiwanie filmÃ³w po tytuÅ‚ach, wraz z ich obsadÄ… oraz trailerami korzystajÄ…c z API TMDb, zapisywanie wszystkiego w bazie, oznaczanie filmu jako przeczytany oraz sprawdzanie premiery cyfrowego wydania.StworzyÅ‚em wiÄ™c agregat filmu wraz z encjami zawierajÄ…cymi trailery oraz obsadÄ™:@Aggregatepublic class MovieAggregate {    @AggregateIdentifier    private MovieId movieId;    @AggregateMember    private TrailerEntity trailerEntity;    @AggregateMember    private CastEntity castEntity;    ...}Pobieranie danych z zewnÄ™trznego serwisu dziaÅ‚o siÄ™ w event handlerze, poprzez zawoÅ‚anie odpowiedniej metody z interfejsu ExternalService:@Servicepublic class MovieEventsHandler {    ...    @EventHandler    public void handle(MovieSearchDelegatedEvent event) {            ...                ExternalMovie externalMovie = externalService.searchMovie(event.getSearchPhrase());                commandGateway.send(new SaveMovieCommand(event.getMovieId(), externalMovie));            ...    }    ...}Agregat obsÅ‚ugiwaÅ‚ SaveMovieCommand, wysyÅ‚ajÄ…c MovieSavedEvent, ktÃ³ry z kolei powoduje zapis do bazy:    @EventHandler    public void handle(MovieSavedEvent event) {        ...        movieRepository.findByExternalMovieId(event.getExternalMovie().getExternalMovieId().getId()).ifPresentOrElse(                movie -&amp;gt; handleMovieDuplicate(),                () -&amp;gt; persistMovie(event));    }SzczegÃ³Å‚owy diagram przepÅ‚ywu dla tego przypadku uÅ¼ycia (juÅ¼ dla mikroserwisÃ³w) znajduje siÄ™ w kolejnym rozdziale.Projekt w tym momencie speÅ‚niaÅ‚ moje wymagania i skÅ‚adaÅ‚ siÄ™ z trzech elementÃ³w:  Aplikacja-monolit  Event store - AxonServer  Storage, read model - MongoDBUwidoczniÅ‚y siÄ™ poszczegÃ³lne funkcjonalnoÅ›ci, ktÃ³re mogÅ‚yby byÄ‡ odrÄ™bnymi serwisami - mowa tu o zarzÄ…dzaniu: filmami, trailerami, obsadÄ… oraz serwis odpowiedzialny za odÅ›wieÅ¼anie dat cyfrowej premiery wraz z ocenami i liczbÄ… gÅ‚osÃ³w.MikroserwisyPrzyszÅ‚a pora na przekucie teorii w praktykÄ™ wykorzystujÄ…c wypracowany wczeÅ›niej podziaÅ‚ odpowiedzialnoÅ›ci.Aplikacja podzielona na mniejsze fragmenty (realizujÄ…ce skoÅ„czone funkcjonalnoÅ›ci) wyglÄ…daÅ‚aby w ten sposÃ³b:  proxy-service, odpowiedzialny za pobieranie danych z zewnÄ™trznego serwisu.  trailer-service, obsÅ‚ugujÄ…cy zapis/odczyt trailerÃ³w, serwujÄ…cy endpointy do pobierania trailerÃ³w.  cast-service, robiÄ…cy to samo dla obsady.  movie-service, odpowiadajÄ…cy za szczegÃ³Å‚y dot. filmu wraz z funkcjonalnoÅ›ciÄ… cyfrowych premier, serwujÄ…cy wszystkie endpointy zwiÄ…zane z filmem.PrzejÅ›cie na mikroserwisy wiÄ…zaÅ‚o siÄ™ rÃ³wnieÅ¼ ze stworzeniem API Gateway kierujÄ…cym ruch do odpowiedniego serwisu w zaleÅ¼noÅ›ci od endpointu.Na diagramie prezentuje siÄ™ to nastÄ™pujÄ…co:A tak prezentuje siÄ™ przepÅ‚yw Axonowych zdarzeÅ„ w przypadku wyszukania filmu z automatycznym zwrÃ³ceniem wyniku.Obsada i trailery pobierane sÄ… z zewnÄ™trznego serwisu od razu i zapisywane do bazy. UÅ¼ytkownik dopiero pÃ³Åºniej moÅ¼e je pobraÄ‡ wchodzÄ…c w szczegÃ³Å‚y wyszukanego filmu. ProblemyMigracja okazaÅ‚a siÄ™ bezbolesna dla Axon Servera, ktÃ³ry bez problemu zaczÄ…Å‚ wykrywaÄ‡ nowe instancje. Pierwsze problemy zaczÄ™Å‚y pojawiaÄ‡ siÄ™ w momencie, gdy chciaÅ‚em wysÅ‚aÄ‡ command do innego mikroserwisu.Z jakiegoÅ› powodu aplikacja nie potrafiÅ‚a skorelowaÄ‡ commanda o tych samych polach i nazwie w jednym serwisie z identycznym commandem w drugim serwisie.OkazaÅ‚o siÄ™, Å¼e problem tkwi w serializacji - commandy byÅ‚y w pakietach o innych nazwach, przez co nie byÅ‚y interpretowane jako ten sam byt.Nie chcÄ…c traciÄ‡ czasu, uspÃ³jniÅ‚em pakiety miÄ™dzy commandami i przepÅ‚yw zaczÄ…Å‚ dziaÅ‚aÄ‡.UsprawnieniaW miÄ™dzyczasie zastÄ…piÅ‚em EventHandler odpowiadajÄ…cy za pobieranie danych z zewnÄ™trznego serwisu Sagami, ktÃ³re wysyÅ‚ajÄ… commandy do proxy-service, aby wyszukaÅ‚ podany tytuÅ‚.Ten asynchronizm uodporniÅ‚ aplikacjÄ™ na niedostÄ™pnoÅ›Ä‡ zewnÄ™trznego serwisu lub dÅ‚ugi czas odpowiedzi:  movie-service    @Sagapublic class MovieSaga {  ...  @StartSaga  @SagaEventHandler(associationProperty = &quot;movieId&quot;)  public void handle(MovieSearchDelegatedEvent event) {      ...      commandGateway.send(new FetchMovieDetailsCommand(proxyId, event.getSearchPhrase()));  }  @SagaEventHandler(associationProperty = &quot;proxyId&quot;)  @EndSaga  public void handle(MovieDetailsFetchedEvent event) {      ...      var movie = event.getExternalMovie();      if (MovieState.NOT_FOUND_IN_EXTERNAL_SERVICE == movie.getMovieState()) {          queryUpdateEmitter.emit(GetMovieQuery.class, query -&amp;gt; true, new MovieDTO(MovieState.NOT_FOUND_IN_EXTERNAL_SERVICE));          end();      } else {          commandGateway.send(new SaveMovieCommand(movieId, event.getExternalMovie()));      }  }  ...}        proxy-service    @Componentpublic class ProxyCommandHandler {  ...  @CommandHandler  public void handle(FetchMovieDetailsCommand command) {      ExternalMovie externalMovie;      try {          externalMovie = tmdbService.searchMovie(command.getSearchPhrase());      } catch (NotFoundInExternalServiceException e) {          externalMovie = ExternalMovie.builder().movieState(MovieState.NOT_FOUND_IN_EXTERNAL_SERVICE).build();      }      eventGateway.publish(new MovieDetailsFetchedEvent(command.getProxyId(), externalMovie));  }  ...}      Jako Å¼e trailers i cast dostaÅ‚y swÃ³j wÅ‚asny serwis i nie byÅ‚y juÅ¼ powiÄ…zane z agregatem filmu, musiaÅ‚em przekonwertowaÄ‡ je na samodzielne agregaty:@Aggregatepublic class TrailerAggregate {    @AggregateIdentifier    private String trailersId;    private List&amp;lt;Trailer&amp;gt; trailers;    ...}PodsumowaniePrzejÅ›cie na architekturÄ™ mikroserwisÃ³w niewÄ…tpliwie daje wiele korzyÅ›ci, jednak bez wyklarowanego dobrego podziaÅ‚u jest to mocno utrudnione.Axon sam w sobie sprzyja tej architekturze, a korzystajÄ…c z gotowych narzÄ™dzi, moÅ¼na takÄ… migracjÄ™ przeprowadziÄ‡ w relatywnie krÃ³tkim czasie.CaÅ‚y kod znajduje siÄ™ w moim repozytorium tutaj.Å¹rÃ³dÅ‚a  https://github.com/matty-matt/movie-keeper-core  https://axoniq.io/  https://youtu.be/zUSWsJteRfw?t=2179",
"url": "/2020/06/09/microservices-on-axon.html",
"author": "Mateusz Kociszewski",
"authorUrl": "/authors/mkociszewski.html",
"image": "mkociszewski.webp",
"highlight": "/assets/img/posts/2020-06-08-microservices-on-axon/axon.jpg",
"date": "09-06-2020",
"path": "pl/2020-06-08-microservices-on-axon"
}
,


"2020-06-01-na-co-nam-ta-chmura-html": {
"title": "Na co nam ta chmura?",
"lang": "pl",
"tags": "cloud google cloud platform gcp serverless",
"content": "Chmury obliczeniowe prÄ™Å¼nie siÄ™ rozwijajÄ… i zyskujÄ… coraz wiÄ™kszÄ… popularnoÅ›Ä‡. Wiele firm decyduje siÄ™ na skorzystanie z produktÃ³w oferowanych przez Google, Amazon czy Microsoft.Z inicjatywy PKO Banku Polskiego powstaje Chmura Krajowa, ktÃ³ra nawiÄ…zuje wspÃ³Å‚pracÄ™ z Google. Google Cloud otwiera nowy region w Warszawie. ğŸ”—W ostatnich latach bardzo duÅ¼o siÄ™ dzieje w Å›wiecie Cloud Computing. Coraz czÄ™Å›ciej rezygnujemy z rozwiÄ…zaÅ„ on-premise na rzecz platform chmurowych, migrujemy swoje infrastruktury do takich gigantÃ³w jak AWS, Microsoft Azure, czy Google Cloud. Ale dlaczego?Na co nam ta chmura?W tym wpisie przedstawiÄ™ kilka powodÃ³w, dla ktÃ³rych warto skorzystaÄ‡ z Google Cloud Platform, jednak wiele elementÃ³w pokrywa siÄ™ rÃ³wnieÅ¼ z innymi usÅ‚ugodawcami, czy ogÃ³lnÄ… ideÄ… chmury.WydajnoÅ›Ä‡Infrastruktura Google Cloud Platform zapewnia nam wydajnoÅ›Ä‡ kilkudziesiÄ™ciu centrÃ³w danych oraz wÅ‚asnej sieci internetowej.SieÄ‡ Google jest odpowiedzialna za 40% ruchu caÅ‚ego internetu i jest najwiÄ™ksza sieciÄ… tego typu na Å›wiecie. Komunikacja miÄ™dzy usÅ‚ugami Google Cloud odbywa siÄ™ przez wewnÄ™trznÄ… infrastrukturÄ™ sieciowÄ…, co zapewnia bardzo wysokÄ… przepustowoÅ›Ä‡ oraz niskÄ… latencjÄ™.Google NetworkÅºrÃ³dÅ‚o: https://cloud.google.com - dostÄ™p: 2020-06-01NiezawodnoÅ›Ä‡UsÅ‚ugi Google Cloud oferujÄ… wysokÄ… dostÄ™pnoÅ›Ä‡ na poziomie SLA powyÅ¼ej 99%.PrzykÅ‚adowo dla Cloud Storage jest to (w zaleÅ¼noÅ›ci od klasy) od 99,0% do 99,95% SLA, a dla Compute Engine od 99,5% do 99,99% SLA.Aby zminimalizowaÄ‡ przerwy w Å›wiadczeniu usÅ‚ug z powodu awarii sprzÄ™tu, klÄ™sk Å¼ywioÅ‚owych lub innych incydentÃ³w, Google zbudowaÅ‚ wysoce redundantnÄ… infrastrukturÄ™. JeÅ›li awarii ulegnie nawet caÅ‚e centrum danych, nasze dane i usÅ‚ugi bÄ™dÄ… nadal dostÄ™pne, poniewaÅ¼ Google posiada centra danych rozmieszczone na caÅ‚ym Å›wiecie, a nasze dane sÄ… replikowane.KorzystajÄ…c z chmury nie musimy wiÄ™c przejmowaÄ‡ siÄ™ awariami sprzÄ™tu (np. wymianÄ… dyskÃ³w), zanikami energii elektrycznej, poÅ¼arami oraz fizycznymi wÅ‚amaniami do serwerowni.BezpieczeÅ„stwoGoogle Cloud oferuje bezpieczeÅ„stwo, o ktÃ³re trudno w przypadku on-premise. SkÅ‚ada siÄ™ na to wiele elementÃ³w, miÄ™dzy innymi:      BieÅ¼Ä…ce aktualizacje bezpieczeÅ„stwa, ktÃ³re odbywajÄ… siÄ™ bez przerw w dostÄ™pie do usÅ‚ugi;        Ponad 500 ekspertÃ³w bezpieczeÅ„stwa Google, w tym czoÅ‚owych ekspertÃ³w na Å›wiecie, ktÃ³rzy pracujÄ… przez caÅ‚Ä… dobÄ™, aby wczeÅ›niej wykryÄ‡ zagroÅ¼enia i zareagowaÄ‡;        Szyfrowanie danych przesyÅ‚anych miÄ™dzy Google, a klientami oraz miÄ™dzy centrami danych, a takÅ¼e szyfrowanie danych zapisanych w chmurze;        Automatyczna rotacja kluczy (Cloud KMS);        ZarzÄ…dzanie rolami i uprawnieniami (Cloud Identity and Access Management);        Zabezpieczenie przed atakami DDoS (Cloud Armor);        BezpieczeÅ„stwo fizyczne centrÃ³w danych Google, ktÃ³re odwiedziÄ‡ moÅ¼e jednie niewielka czÄ™Å›Ä‡ pracownikÃ³w firmy;        Wieloletnie doÅ›wiadczenie zdobyte podczas atakÃ³w na usÅ‚ugi wyszukiwarki Google, Gmail oraz YouTube;        Wykorzystanie niestandardowego sprzÄ™tu oraz podpisÃ³w kryptograficznych na wszystkich niskopoziomowych komponentach (takich jak BIOS, Bootloader, Kernel).  Google posiada rozbudowanÄ… warstwÄ™ bezpieczeÅ„stwa, ktÃ³ra zabezpiecza infrastrukturÄ™ od sprzÄ™tu aÅ¼ po system operacyjny. Nie wszystko jest jednak dostÄ™pne out-of-the-box.Musimy pamiÄ™taÄ‡, Å¼e niektÃ³re elementy muszÄ… zostaÄ‡ przez nas poprawnie skonfigurowane. Mam na myÅ›li na przykÅ‚ad uprawnienia/role czy reguÅ‚y firewall. JeÅ›li tego nie zrobimy, to moÅ¼e siÄ™ okazaÄ‡, Å¼e nieupowaÅ¼nione osoby mogÄ… mieÄ‡ dostÄ™p do naszego systemu przez internet.ElastycznoÅ›Ä‡Jednym z najwiÄ™kszych atutÃ³w chmury jest jej elastycznoÅ›Ä‡.Nie jesteÅ›my ograniczeni przez sprzÄ™t, ktÃ³ry posiadamy. Zasoby sÄ… dostÄ™pne na Å¼Ä…danie, wiÄ™c jeÅ›li przyjdzie potrzeba zwiÄ™kszenia pamiÄ™ci RAM czy wielkoÅ›ci dysku, to moÅ¼emy to zrobiÄ‡ w kaÅ¼dej chwili.Wykorzystujemy tylko tyle zasobÃ³w, ile potrzebujemy w danej chwili. Jest to szczegÃ³lnie waÅ¼ne, jeÅ›li nasza infrastruktura ma byÄ‡ gotowa na chwilowy, zwiÄ™kszony ruch. W przeciwieÅ„stwie do on-premise, nasze zasoby nie marnujÄ… siÄ™ w przypadku nie korzystania z nich.SkalowalnoÅ›Ä‡W przypadku usÅ‚ug w modelu SaaS, takich jak np. Cloud SQL czy Cloud Function, nie musimy siÄ™ przejmowaÄ‡ skalowaniem czy wydajnoÅ›ciÄ…. Google zapewni nam dostÄ™pnoÅ›Ä‡ oraz wydajnoÅ›Ä‡ usÅ‚ugi niezaleÅ¼nie od obciÄ…Å¼enia. Nie musimy wiÄ™c zajmowaÄ‡ siÄ™ klastrowaniem wÅ‚asnej bazy danych.JeÅ›li uruchomimy naszÄ… aplikacjÄ™ w modelu PaaS, np. korzystajÄ…c z usÅ‚ugi App Engine (w wersji standard), Google automatycznie bÄ™dzie skalowaÅ‚ jÄ… w zaleÅ¼noÅ›ci od obciÄ…Å¼enia. WiÄ™kszÄ… kontrolÄ™ nad skalowaniem naszej aplikacji zapewni nam Kubernetes Engine, ktÃ³ry jest hybrydÄ… miÄ™dzy IaaS a PaaS.RÃ³wnieÅ¼ w przypadku modelu IaaS, korzystajÄ…c z maszyn wirtualnych Compute Engine, mamy moÅ¼liwoÅ›Ä‡ automatycznego skalowania. W tym wypadku musimy jednak skonfigurowaÄ‡ grupÄ™ instancji i ustaliÄ‡ minimalnÄ…/maksymalnÄ… liczbÄ™ maszyn wirtualnych oraz na jakiej podstawie usÅ‚uga ma byÄ‡ skalowana (np. obciÄ…Å¼enie CPU). W zamian otrzymujemy najwiÄ™kszÄ… kontrolÄ™ nad tym, w jaki sposÃ³b odbywa siÄ™ skalowanie.ObniÅ¼enie kosztÃ³wW przypadku modelu IaaS, jeÅ›li zmigrujemy siÄ™ do chmury strategiÄ… â€œLift and Shiftâ€, czyli mÃ³wiÄ…c proÅ›ciej, przeniesiemy nasze serwery na maszyny wirtualne Compute Engine, moÅ¼e okazaÄ‡ siÄ™, Å¼e miesiÄ™czny koszt infrastruktury bÄ™dzie wyÅ¼szy niÅ¼ w przypadku on-premise.Sytuacja zmienia siÄ™ w przypadku modeli PaaS czy SaaS, a takÅ¼e hybrydy w postaci Google Kubernetes Engine. PoniewaÅ¼ zasoby w chmurze sÄ… dostÄ™pne na Å¼Ä…danie, to pÅ‚acimy tylko za te, ktÃ³re faktycznie wykorzystujemy.JeÅ›li nasz system przyjmuje wzmoÅ¼ony ruch np. przez kilka dni w kaÅ¼dym miesiÄ…cu, to w tych dniach zostanÄ… przydzielone dodatkowe zasoby. Gdy ruch spadnie, to zasoby zostanÄ… zredukowane, dziÄ™ki czemu nie bÄ™dziemy pÅ‚aciÄ‡ za to, czego w danej chwili nie potrzebujemy.Google Cloud oferuje rÃ³wnieÅ¼ zniÅ¼ki:  Sustained use discounts - zniÅ¼ki za uruchamianie okreÅ›lonych zasobÃ³w przez znacznÄ… czÄ™Å›Ä‡ miesiÄ…ca;  Committed use discounts - zniÅ¼ki w ramach umowy z Google, jeÅ›li zobowiÄ…Å¼emy siÄ™ do korzystania z zasobÃ³w przez okreÅ›lony czas.a takÅ¼e darmowe limity. ğŸ”—ZaoszczÄ™dzimy rÃ³wnieÅ¼ na utrzymaniu infrastruktury, poniewaÅ¼ nie potrzebujemy juÅ¼ administratorÃ³w opiekujÄ…cych siÄ™ naszymi serwerami.DziÄ™ki automatyzacji, jakÄ… daje nam chmura, moÅ¼emy byÄ‡ mniej DevOps, a bardziej NoOps.",
"url": "/2020/06/01/na-co-nam-ta-chmura.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2020-06-01-na-co-nam-ta-chmura/cloud.jpg",
"date": "01-06-2020",
"path": "pl/2020-06-01-na-co-nam-ta-chmura"
}
,


"2020-05-05-tworzenie-i-usuwanie-indeksow-w-bazie-mongodb-na-produkcji-html": {
"title": "Tworzenie i usuwanie indeksÃ³w w bazie MongoDB na produkcji",
"lang": "pl",
"tags": "tech mongodb index",
"content": "Rankingi baz danych pokazujÄ…, Å¼e juÅ¼ dobrych kilka lat wÅ›rÃ³d baz typu NoSQL krÃ³luje MongoDB i nic nie wskazuje na to, aby miaÅ‚o siÄ™ to szybko zmieniÄ‡. Trudno siÄ™ temu dziwiÄ‡ - MongoDB jest dokumentowÄ… bazÄ… danych, ale oferuje duÅ¼o wiÄ™cej poza funkcjonalnoÅ›ciami dodawania i pobierania dokumentÃ³w.Dysponujemy bogatym zestawem narzÄ™dzi do zapytaÅ„ w postaci mechanizmu agregacji. Mamy teÅ¼ moÅ¼liwoÅ›Ä‡ nasÅ‚uchiwania na zmiany danych w bazie poprzez strumieÅ„ zmian (change stream). MoÅ¼emy rÃ³wnieÅ¼ walidowaÄ‡ schemat kolekcji poprzez dostarczony przez nas zestaw reguÅ‚. Wersja 4.0 MongoDB dostarcza transakcje obejmujÄ…ce wiÄ™cej niÅ¼ jeden dokument. JuÅ¼ wczeÅ›niejszy mechanizm transakcji na poziomie pojedyneczego dokumentu pozwala na tworzenie produkcyjnych aplikacji przy wykorzystaniu funkcji typu znajdÅº i usuÅ„, podmieÅ„ oraz zaktualizuj (findOneAndDelete, findOneAndReplace, findOneAndUpdate). W tym przypadku musimy zaprojektowaÄ‡ odpowiedni schemat bazy.DziÄ™ki shardingowi MongoDB pozwala przechowywaÄ‡ i przetwarzaÄ‡ ogromne iloÅ›ci danych bez znacznego spadku wydajnoÅ›ci. Poza tym dziÄ™ki redundancji w klastrze (replica set) dane sÄ… niemalÅ¼e zawsze dostÄ™pne. Co wiÄ™cej, dokumentacja MongoDB wprost mÃ³wi, Å¼e klaster z redundacjÄ… danych powinien byÄ‡ podstawÄ… kaÅ¼dej instalacji produkcyjnej.KaÅ¼dy system jest rozwijany i zmienia siÄ™ w odpowiedzi na nowe wymagania biznesowe. Z tego powodu moÅ¼e siÄ™ zdarzyÄ‡, Å¼e konieczne bÄ™dÄ… zmiany w zapytaniach do bazy i co za tym idzie rÃ³wnieÅ¼ mogÄ… byÄ‡ wymagane zmiany indeksÃ³w. Staniemy wtedy przed wyzwaniem zmiany indeksÃ³w w systemie produkcyjnym. MoÅ¼e siÄ™ zdarzyÄ‡, Å¼e jeden okaÅ¼e siÄ™ niepotrzebny i bÄ™dziemy chcieli go usunÄ…Ä‡, aby zwolniÄ‡ miejsce. Drugi indeks trzeba bÄ™dzie stworzyÄ‡, aby przyspieszyÄ‡ wykonywanie nowych zapytaÅ„. Tworzenie indeksu moÅ¼e trwaÄ‡ bardzo dÅ‚ugo. Nie chcemy na ten czas wyÅ‚Ä…czaÄ‡ produkcji. PoniÅ¼szy tekst wyjaÅ›nia, jak stworzyÄ‡ nowy i usunÄ…Ä‡ stary indeks bez wiÄ™kszych zawirowaÅ„ na produkcji.Aby caÅ‚a operacja odbyÅ‚a siÄ™ bez problemÃ³w, powinniÅ›my wykonaÄ‡ jÄ… w nastÄ™pujÄ…cej kolejnoÅ›ci:  utworzenie indeksu pod nowe zapytania w systemie;  aktualizacja czÄ™Å›ci biznesowej systemu;  usuniÄ™cie starego indeksu, o ile nie jest juÅ¼ uÅ¼ywany.Tworzenie indeksu w MongoDB w sposÃ³b rollingTworzenie indeksu w sposÃ³b rolling dotyczy tylko i wyÅ‚Ä…cznie bazy z redundacjÄ… danych w klastrze. Ta metoda pozwala na tworzenie nieunikalnych indeksÃ³w. Przeprowadzana jest dla kaÅ¼dego wÄ™zÅ‚a w klastrze:  wÄ™zeÅ‚ jest odÅ‚Ä…czany od klastra i uruchamiany w trybie standalone;  tworzony jest indeks na tym wÄ™Åºle;  wÄ™zeÅ‚ jest doÅ‚Ä…czany do klastra.W czasie tworzenia indeksu pozostaÅ‚e wÄ™zÅ‚y klastra caÅ‚y czas dziaÅ‚ajÄ… produkcyjnie i co za tym idzie dane siÄ™ zmieniajÄ…. WÄ™zeÅ‚, ktÃ³ry byÅ‚ uruchomiony w trybie standalone, i na ktÃ³rym tworzony byÅ‚ indeks, po wÅ‚Ä…czeniu do klastra bÄ™dzie musiaÅ‚ siÄ™ zsynchronizowaÄ‡ i pobraÄ‡ wszytkie zmiany, ktÃ³re zaszÅ‚y w czasie, kiedy byÅ‚ odÅ‚Ä…czony. Aby caÅ‚a procedura odbyÅ‚a siÄ™ bez problemu, naleÅ¼y zapewniÄ‡, aby oplog miaÅ‚ odpowiedni rozmiar. Oplog przechowuje ostatnie zmiany danych, ktÃ³re zaszÅ‚y w wÄ™Åºle primary i jeÅ¼eli nie bÄ™dzie odpowiednio duÅ¼y, to wÄ™zeÅ‚ ktÃ³ry jest doÅ‚Ä…czany do klastra, nie bÄ™dzie w stanie siÄ™ zsynchronizowaÄ‡. WiÄ™cej informacji o tym, jak dobraÄ‡ rozmiar oplog jest w dokumentacji MongoDB.ProcedurÄ™ zaczynamy od wÄ™zÅ‚Ã³w secondary, a na koÅ„cu przeprowadzamy jÄ… dla wÄ™zÅ‚a primary. NaleÅ¼y zwrÃ³ciÄ‡ uwagÄ™ na write concern. PrzykÅ‚adowo jeÅ¼eli mamy klaster zÅ‚oÅ¼ony z 3 wÄ™zÅ‚Ã³w i write concern rÃ³wne 3, to z pukntu widzenia aplikacji baza bÄ™dzie niedostÄ™pna po odÅ‚Ä…czeniu wÄ™zÅ‚a. Wszystkie zapisy bÄ™dÄ… siÄ™ koÅ„czyÄ‡ bÅ‚Ä™dem.OdÅ‚Ä…czenie wÄ™zÅ‚a od klastraOdÅ‚Ä…czenie wÄ™zÅ‚a od klastra wymaga 2 krokÃ³w:  zmiany w konfiguracji, aby wÄ™zeÅ‚ po restarcie nie podÅ‚Ä…czyÅ‚ siÄ™ do klastra,  restartu wÄ™zÅ‚a.W konfiguracji musimy zmieniÄ‡ port, wykomentowaÄ‡ konfiguracjÄ™ repliki oraz wyÅ‚Ä…czyÄ‡ odÅ›wieÅ¼anie sesji. PrzykÅ‚adowo fragment pliku z konfiguracjÄ… moÅ¼e wyglÄ…daÄ‡ tak:net:  bindIp: 127.0.0.1  port: 28017#   port: 27017#replication:#   replSetName: rs0# WyÅ‚Ä…cz odÅ›wieÅ¼anie sesjisetParameter:   disableLogicalSessionCacheRefresh: trueUwaga! JeÅ¼eli wÄ™zeÅ‚ jest primary, to musimy wykonaÄ‡ operacjÄ™ step down przed restartem, aby staÅ‚ siÄ™ secondary, a klaster wybraÅ‚ inny wÄ™zeÅ‚ jako primary. SÅ‚uÅ¼y temu polecenie rs.stepDown().Po zmianach w konfiguracji restartujemy wÄ™zeÅ‚. W tym momencie wÄ™zeÅ‚ jest odÅ‚Ä…czony od klastra i dziaÅ‚a w trybie standalone. Teraz moÅ¼emy utworzyÄ‡ indeks.Tworzenie indeksuPo restarcie wÄ™zÅ‚a i uruchomieniu w trybie standalone, podÅ‚Ä…czamy siÄ™ do niego i wykonujemy polecenie tworzÄ…ce indeks zgodnie z dokumentacjÄ…. Tworzenie indeksu moÅ¼e okazaÄ‡ siÄ™ czasochÅ‚onne. Aktualnie wykonywane operacje na bazie sprawdzimy, uruchamiajÄ…c polecenie db.currentOp() w powÅ‚oce MongoDB. To pozwoli dowiedzieÄ‡ siÄ™, czy indeks nadal siÄ™ buduje.DoÅ‚Ä…czenie wÄ™zÅ‚a do klastraPo zbudowaniu indeksu doÅ‚Ä…czamy wÄ™zeÅ‚ do klastra. Polega to na wycofaniu zmian w konfiguracji oraz restarcie wÄ™zÅ‚a. W tym momencie wÄ™zeÅ‚ bÄ™dzie siÄ™ aktualizowaÅ‚ wzglÄ™dem klastra (wÄ™zÅ‚a primary), czyli pobieraÅ‚ zmiany, ktÃ³re zaszÅ‚y w czasie kiedy byÅ‚ odÅ‚Ä…czony.Informacje o klastrze sÄ… zwracane przez polecenia:  rs.status() - zwraca status klastra wzglÄ™dem wÄ™zÅ‚a, na ktÃ³rym polecenie zostaÅ‚o uruchomione;  rs.printSlaveReplicationInfo() - zwraca informacje o wÄ™zÅ‚ach secondary Å‚Ä…cznie z opÃ³Åºnieniem wzglÄ™dem wÄ™zÅ‚a primary.Usuwanie indeksuProcedura usuniÄ™cia indeksu zaleÅ¼y od wersji MongoDB. Od wersji 4.2 wystarczy usunÄ…Ä‡ indeks na wÄ™Åºle primary. CaÅ‚Ä… resztÄ…, czyli usuniÄ™ciem indeksu z wÄ™zÅ‚Ã³w secondary, zajmie siÄ™ baza. JeÅ¼eli pracujemy z wczeÅ›niejszÄ… wersjÄ…, to indeks naleÅ¼y usunÄ…Ä‡ podobnie jak tworzymy indeks w sposÃ³b rolling. JedynÄ… rÃ³Å¼nicÄ… jest to, Å¼e indeks usuwamy, a nie tworzymy.W jednym i drugim przypadku musimy jednak siÄ™ upewniÄ‡, Å¼e Å¼adne zapytanie nie korzysta z danego indeksu. Inaczej zapytanie zakoÅ„czy siÄ™ bÅ‚Ä™dem.ZarzÄ…dzanie indeksami a automatyzacjaZazwyczaj chcemy uÅ‚atwiÄ‡ sobie Å¼ycie i wiele rzeczy automatyzujemy. MoÅ¼na rÃ³wnieÅ¼ siÄ™ pokusiÄ‡ o automatyczne usuwanie i tworzenie indeksÃ³w podczas wdraÅ¼ania kolejnej wersji systemu. DoÅ›wiadczenie pokazuje, Å¼e moÅ¼na pochopnie umieÅ›ciÄ‡ w skryptach dwa polecenia usuniÄ™cia i stworzenia indeksu na wÄ™Åºle primary. Najprawdopodobniej skoÅ„czy siÄ™ to powaÅ¼nym bÅ‚Ä™dem i jeÅ¼eli operacjÄ™ przeprowadzamy na produkcji, to produkcja bÄ™dzie niedostÄ™pna do czasu naprawy. Czas przestoju bÄ™dzie znaczÄ…cy, jeÅ¼eli kolekcja bÄ™dzie znaczÄ…cych rozmiarÃ³w.Zmiany w indeksach powinniÅ›my przeprowadzaÄ‡ manualnie z planem dziaÅ‚ania w rÄ™ku.PodsumowanieMongoDB jest dokumentowÄ… bazÄ… danych oferujÄ…cÄ… bogatÄ… funkcjonalnoÅ›Ä‡ i jednoczeÅ›nie na tyle elastycznÄ…, Å¼e pozwala przeprowadzaÄ‡ zadania administracyjne bez przerwy w dziaÅ‚aniu. To siÄ™ tyczy rÃ³wnieÅ¼ tworzenia oraz usuwania indeksÃ³w, co nie jest operacjÄ… trudnÄ….",
"url": "/2020/05/05/tworzenie-i-usuwanie-indeksow-w-bazie-mongodb-na-produkcji.html",
"author": "MikoÅ‚aj Gucki",
"authorUrl": "/authors/mgucki.html",
"image": "mgucki.jpg",
"highlight": "/assets/img/posts/2020-05-05-tworzenie-i-usuwanie-indeksow-w-bazie-mongodb-na-produkcji/indeksy_mongo.jpg",
"date": "05-05-2020",
"path": "pl/2020-05-05-tworzenie-i-usuwanie-indeksow-w-bazie-mongodb-na-produkcji"
}
,


"2020-03-18-tomcat-model-przetwarzania-zadan-html": {
"title": "Tomcat - model przetwarzania Å¼Ä…daÅ„",
"lang": "pl",
"tags": "java tomcat nio connector",
"content": "Tomcat jest jednym z najpopularniejszych serwerÃ³w webowych dla aplikacji pisanych w Javie. Jest podstawowym kontenerem aplikacji springbootowych. TworzÄ…c nowy projekt czÄ™sto polegamy na jego domyÅ›lnej konfiguracji. Kiedy projekt dojrzewa do wdroÅ¼enia produkcyjnego i musi zmierzyÄ‡Â siÄ™ z obsÅ‚ugÄ… duÅ¼ego ruchu, czÄ™sto konieczne okazuje siÄ™Â dostrojenie tej konfiguracji. W tym artykule skupiÄ™Â siÄ™Â na konfiguracji connectorÃ³w na przykÅ‚adzie pewnego problemu produkcyjnego. Opis konfiguracji Tomcata bazuje na wersji 7.x, ale jest w zasadzie aktualny rÃ³wnieÅ¼ dla wyÅ¼szych wersji.Problem z wyczerpanÄ… pulÄ… wÄ…tkÃ³w w TomcacieW jednym z systemÃ³w, ktÃ³re wspÃ³Å‚tworzyÅ‚em, wystÄ…piÅ‚ problem podczas dziaÅ‚ania produkcyjnego. Problem objawiaÅ‚ siÄ™Â brakiem moÅ¼liwoÅ›ci poÅ‚Ä…czenia z endpointem wystawionym na Tomcacie. Monitoring i analiza logÃ³w jednoznacznie pokazaÅ‚y, Å¼e wyczerpaÅ‚a siÄ™ pula wÄ…tkÃ³w obsÅ‚ugujÄ…cych Å¼Ä…dania http. Dalsza analiza ujawniÅ‚a, Å¼e praprzyczynÄ… problemu byÅ‚ w tym przypadku system autoryzacji, z ktÃ³rym Å‚Ä…czyÅ‚Â siÄ™ nasz system. W systemie autoryzacji znaczÄ…co wzrosÅ‚y czasy odpowiedzi, co powodowaÅ‚o, Å¼e wÄ…tki Tomcata byÅ‚y bardzo dÅ‚ugo zajÄ™te. Tomcat powoÅ‚ywaÅ‚ nowe wÄ…tki, ale ostatecznie osiÄ…gnÄ…Å‚ limit 1000 wÄ…tkÃ³w (taki mieliÅ›my ustawiony na connectorze) i przestaÅ‚ obsÅ‚ugiwaÄ‡ nowe poÅ‚Ä…czenia - rÃ³wnieÅ¼ takie, ktÃ³re nie wymagaÅ‚y wywoÅ‚ania systemu autoryzacji.Co wiÄ™cej, zauwaÅ¼yliÅ›my i potwierdziliÅ›my to pÃ³Åºniej w testach, Å¼e po caÅ‚kowitym wysyceniu puli wÄ…tkÃ³w, Tomcat nie jest w stanie bez restartu powrÃ³ciÄ‡ do prawidÅ‚owego dziaÅ‚ania nawet wtedy, kiedy problem z dÅ‚ugimi czasami odpowiedzi zostanie wyeliminowany.Opisana sytuacja skÅ‚oniÅ‚a nas do sprawdzenia czy jesteÅ›my w stanie zapobiec takiemu zachowaniu Tomcata poprzez modyfikacjÄ™Â konfiguracji connectorÃ³w. PojawiÅ‚Â siÄ™ miÄ™dzy innymi pomysÅ‚ zmiany implementacji connectora blokujÄ…cego (bio) na nieblokujÄ…cy (nio). W systemie, ktÃ³rego dotyczyÅ‚Â problem uÅ¼ywany byÅ‚ tomcat 7.x, w ktÃ³rym domyÅ›lnie uÅ¼ywana jest implementacja blokujÄ…ca.Konfiguracja connectorÃ³wPodstawowa konfiguracja Tomcata znajduje siÄ™Â w pliku conf/server.xml i zawiera konfiguracjÄ™ nastÄ™pujÄ…cych elementÃ³w:  Server - konfiguracja caÅ‚ego kontenera, zawiera konfiguracje poszczegÃ³lnych serwisÃ³w.  Service - zawiera konfiguracjÄ™ poszczegÃ³lnych connectorÃ³w Å‚Ä…czÄ…c je silnikiem przetwarzania Å¼Ä…daÅ„.  Connector - nasÅ‚uchuje na wybranym porcie http i obsÅ‚uguje poÅ‚Ä…czenia przekazujÄ…c Å¼Ä…dania do silnika zdefiniowanego w elemencie Engine.  Engine - przetwarza Å¼Ä…dania pochodzÄ…ce ze wszystkich connectorÃ³w zdefiniowanych w elemencie Service.Z punktu widzenia przetwarzania Å¼Ä…daÅ„, kluczowe znaczenie ma konfiguracja connectora i parametry:  protocol - Pozwala okreÅ›liÄ‡ wybranÄ… implementacjeÂ connectora (to tutaj moÅ¼emy zdecydowaÄ‡ czy chcemy uÅ¼yÄ‡ connectora blokujÄ…cego czy nieblokujÄ…cego).  acceptCount - DÅ‚ugoÅ›Ä‡Â kolejki oczekujÄ…cych poÅ‚Ä…czeÅ„. Kolejka napeÅ‚nia siÄ™Â jeÅ¼eli wszystkie wÄ…tki w puli wÄ…tkÃ³w connectora sÄ… zajÄ™te. W przypadku osiÄ…gniÄ™cia limitu tej kolejki (domyÅ›lnie 100) poÅ‚Ä…czenia klientÃ³w bÄ™dÄ… odrzucane.  maxConnections - Maksymalna liczba poÅ‚Ä…czeÅ„, ktÃ³re mogÄ… byÄ‡Â przetwarzane. Po osiÄ…gniÄ™ciu maksymalnej liczby poÅ‚Ä…czeÅ„, poÅ‚Ä…czenia nadal sÄ… przyjmowane i kolejkowane do czasu osiÄ…gniÄ™cia limitu wynikajÄ…cego z parametru acceptCount. DomyÅ›lnie maxConnections jest rÃ³wne maxThreads dla connectora blokujÄ…cego i 10000 dla nieblokujÄ…cego.  maxThreads - Maksymalna liczba wÄ…tkÃ³w obsÅ‚ugujÄ…cych Å¼Ä…dania. Parametr ten oznacza, ile Å¼Ä…daÅ„Â moÅ¼e byÄ‡Â symultanicznie przetwarzanych przez serwer. DomyÅ›lna wartoÅ›Ä‡ tego parametru to 200. Jest to najwaÅ¼niejszy parametr, zwaÅ¼ywszy na problem, ktÃ³ry rozwiÄ…zujemy w tym artykule.Monitorowanie puli wÄ…tkÃ³wAktualna liczba wÄ…tkÃ³w przetwarzajÄ…cych Å¼Ä…dania jest, obok rozmiaru sterty, jednym z najwaÅ¼niejszych parametrÃ³w, ktÃ³re powinny byÄ‡ objÄ™te monitoringiem. W tym przypadku monitorujemy atrybut currentThreadsBusy mbeanâ€™aCatalina:name=&quot;http-RODZAJ_CONNECTORA-PORT&quot;,type=ThreadPool(przy czym RODZAJ_CONNECTORA to â€œbioâ€ dla connectora blokujÄ…cego i â€œnioâ€ dla nieblokujÄ…cego, PORT to numer portu, na ktÃ³rym nasÅ‚uchuje connector).Do monitoringu moÅ¼na uÅ¼yÄ‡ narzÄ™dzia jolokia, ktÃ³re udostÄ™pnia JMX za pomocÄ… protokoÅ‚u http. W takiej konfiguracji wystarczy regularnie odpytywaÄ‡ o stan puli wÄ…tkÃ³w poprzez wywoÅ‚anie http GET:http://HOST:PORT/jolokia/read/Catalina:name=&quot;http-RODZAJ_CONNECTORA-PORT&quot;,type=ThreadPool/currentThreadsBusyW odpowiedzi dostajemy jsona, ktÃ³ry w polu value zawiera aktualny rozmiar puli wÄ…tkÃ³w{  &quot;request&quot;: {    &quot;mbean&quot;: &quot;Catalina:name=\\&quot;http-RODZAJ_CONNECTORA-PORT\\&quot;,type=ThreadPool&quot;,    &quot;attribute&quot;: &quot;currentThreadsBusy&quot;,    &quot;type&quot;: &quot;read&quot;  },  &quot;value&quot;: 1,  &quot;timestamp&quot;: 1564763927,  &quot;status&quot;: 200}Warto skonfigurowaÄ‡Â alerting, ktÃ³ry bÄ™dzie ostrzegaÅ‚ o wysycaniu siÄ™ puli poÅ‚Ä…czeÅ„ i pozwoli szybciej zdiagnozowaÄ‡Â problem.PorÃ³wnanie connectorÃ³w blokujÄ…cych (bio) i nieblokujÄ…cych (nio)RÃ³Å¼nica w dziaÅ‚aniuW Tomcacie 7.x domyÅ›lnÄ…Â implementacjÄ…Â connectora jest implementacja blokujÄ…ca. W Tomcacie 8 i wyÅ¼szych domyÅ›lny jest connector nieblokujÄ…cy. Podstawowa rÃ³Å¼nica w dziaÅ‚aniu polega na tym, Å¼e w connectorze blokujÄ…cym wÄ…tek przypisywany jest do poÅ‚Ä…czenia, a w connectorze nieblokujÄ…cym do pojedynczego Å¼Ä…dania. MoÅ¼e to mieÄ‡ duÅ¼e znaczenie przy zastosowaniu poÅ‚Ä…czeÅ„ keep-alive, kiedy to jedno poÅ‚Ä…czenie jest wykorzystywane do przesÅ‚ania wielu Å¼Ä…daÅ„Â i odpowiedzi. W takim modelu wÄ…tek na serwerze jest zajÄ™ty na caÅ‚y czas trwania pojedynczego poÅ‚Ä…czenia mimo, Å¼e faktyczne przetwarzanie na serwerze zachodzi tylko w obrÄ™bie pojedynczego Å¼Ä…dania.TestDla porÃ³wnania moÅ¼na wykonaÄ‡ prosty test na dwÃ³ch rodzajach connectorÃ³w. W teÅ›cie klient raz na sekundÄ™ wysyÅ‚a Å¼Ä…danie do serwera. ÅÄ…cznie jeden klient wysyÅ‚a 30 Å¼Ä…daÅ„. Uruchamiamy 20 klientÃ³w w ciÄ…gu 2 sekund. JednoczeÅ›nie monitorujemy rozmiar puli wÄ…tkÃ³w.Tak wyglÄ…da wykres czasÃ³w odpowiedzi dla connectora blokujÄ…cego:a tak dla connectora nieblokujÄ…cego:Nie widaÄ‡ tutaj jakiejÅ› specjalnej rÃ³Å¼nicy miÄ™dzy dziaÅ‚aniem connectora bio i nio. ZupeÅ‚nie inaczej wyglÄ…dajÄ… natomiast wykresy liczby zajÄ™tych wÄ…tkÃ³w w puli. Dla connectora blokujÄ…cego liczba zajÄ™tych wÄ…tkÃ³w podczas trwania testu przekracza 20. Czyli jest zgodna z liczbÄ… klientÃ³w wysyÅ‚ajÄ…cych Å¼Ä…dania do serwera. PoÅ‚Ä…czenia keep-alive majÄ… timeout rÃ³wny 5 sekund wiÄ™c klient utrzymuje caÅ‚y czas jedno poÅ‚Ä…czenie do wszystkich Å¼Ä…daÅ„:Dla connectora nieblokujÄ…cego Å¼Ä…dania sÄ… obsÅ‚ugiwane w wiÄ™kszoÅ›ci przez jeden wÄ…tek:Test pokazuje, Å¼e przy takim modelu przetwarzania Å¼Ä…daÅ„ za pomocÄ…Â connectora nieblokujÄ…cego moÅ¼emy uzyskaÄ‡ sporÄ… oszczÄ™dnoÅ›Ä‡Â zasobÃ³w i lepiej zutylizowaÄ‡ serwer.UÅ¼ycie mod_proxy zmienia sytuacjÄ™Warto zwrÃ³ciÄ‡ uwagÄ™ na to, Å¼e takie wyniki osiÄ…gamy w przypadku bezpoÅ›redniego poÅ‚Ä…czenia pomiÄ™dzy klientem, a serwerem Tomcat. Zdarza siÄ™Â jednak, Å¼e mamy jeszcze warstwÄ™ poÅ›redniÄ… np. w postaci serwera Apache httpd i moduÅ‚u mod_proxy. DomyÅ›lnie mod_proxy nie ma wÅ‚Ä…czonej opcji keep-alive wiÄ™c wszystkie poÅ‚Ä…czenia do backendu sÄ… zamykane po obsÅ‚uÅ¼eniu pojedynczego Å¼Ä…dania.Test zostaÅ‚ przeprowadzony za pomocÄ… narzÄ™dzia Gatling. WiÄ™cej o samym narzÄ™dziu moÅ¼na przeczytaÄ‡ w osobnym artykule na naszym blogu.PrÃ³ba rozwiÄ…zania problemuPodsumowujÄ…c: WstÄ™pem do rozwaÅ¼aÅ„ nad konfiguracjÄ…Â connectorÃ³w byÅ‚ problem z dÅ‚ugimi czasami jakie wÄ…tki Tomcata spÄ™dzaÅ‚y na komunikacji z systemem autoryzacji. Czy zmiana connectora na nieblokujÄ…cy pomogÅ‚aby w tej sytuacji? Niestety nie. Connector nieblokujÄ…cy nie wiÄ…Å¼e wÄ…tku z poÅ‚Ä…czeniem, ale nadal wiÄ…Å¼e go z pojedynczym Å¼Ä…daniem. W tym przypadku nadal wÄ…tki bÄ™dÄ… blokowane na dÅ‚ugim wywoÅ‚aniu systemu autoryzacji. ChoÄ‡Â zastosowanie connectora nio z pewnoÅ›ciÄ… zaoszczÄ™dziÅ‚oby czÄ™Å›Ä‡ zasobÃ³w maszyny, to w tym przypadku naleÅ¼aÅ‚oby raczej rozwaÅ¼yÄ‡ uÅ¼ycie jakiejÅ›Â implementacji circuit breakerâ€™a lub teÅ¼ zmieniÄ‡ model obsÅ‚ugi Å¼Ä…daÅ„ na bardziej reaktywny (np. webflux).",
"url": "/2020/03/18/tomcat-model-przetwarzania-zadan.html",
"author": "Jakub Wilczewski",
"authorUrl": "/authors/jwilczewski.html",
"image": "jwilczewski.jpg",
"highlight": "/assets/img/posts/2020-03-18-tomcat-model-przetwarzania-zadan/Tomcat.jpeg",
"date": "18-03-2020",
"path": "pl/2020-03-18-tomcat-model-przetwarzania-zadan"
}
,


"2020-03-09-o-openid-connect-slow-kilka-html": {
"title": "O OpenID Connect sÅ‚Ã³w kilka",
"lang": "pl",
"tags": "openid connect oauth 2 keycloak uwierzytelnianie uÅ¼ytkownika",
"content": "W nawiÄ…zaniu do mojego poprzedniego wpisu pt.:â€œKeycloak - uwierzytelnianie i autoryzacja uÅ¼ytkownika w aplikacji Angular/Spring Bootâ€ ğŸ”—chciaÅ‚bym krÃ³tko opisaÄ‡ standard OpenID Connect, ktÃ³ry zostaÅ‚ wykorzystany podczas logowania do aplikacji przy uÅ¼yciu serwera uwierzytelniania Keycloak.WstÄ™pNajpopularniejszymi standardami wykorzystywanymi do uwierzytelniania/autoryzacji sÄ… OAuth 2.0, OpenID Connect oraz SAML.O OAuth 2.0 zostaÅ‚o juÅ¼ napisanych wiele artykuÅ‚Ã³w, ktÃ³rych nie ma sensu powielaÄ‡. Jednak aby przedstawiÄ‡ OpenID Connect, musiaÅ‚bym opisaÄ‡ OAuth 2.0 oraz JWT.W celu zapoznania siÄ™ ze standardem OAuth 2.0 odeÅ›lÄ™ do artykuÅ‚u pt.:â€œOAuth 2.0 â€“ jak dziaÅ‚a / jak testowaÄ‡ / problemy bezpieczeÅ„stwaâ€ ğŸ”—autorstwa Marcina Pioska z portalu Sekurak, w ktÃ³rym zostaÅ‚a opisana terminologia, sposoby pozyskiwania tokenu oraz zasada dziaÅ‚ania standardu.O JWT natomiast moÅ¼emy przeczytaÄ‡ w dokumencie RFC7519.Dlaczego wiÄ™c do integracji naszej aplikacji z serwerem uwierzytelniania Keycloak uÅ¼yliÅ›my OpenID Connect?Uwierzytelnianie a autoryzacjaPoruszajÄ…c temat zabezpieczania zasobÃ³w i dostÄ™pu do nich, mÃ³wimy o takich pojÄ™ciach jak uwierzytelnianie (ang. authentication) oraz autoryzacja (ang. authorization).  uwierzytelnianie to proces polegajÄ…cy na potwierdzeniu toÅ¼samoÅ›ci, czyli w skrÃ³cie - kim jestem?;  autoryzacja to proces nadawania uprawnieÅ„ (dostÄ™pu do zasobu), czyli w skrÃ³cie - co mogÄ™ zrobiÄ‡?.OAuth 2.0, wedÅ‚ug oficjalnej dokumentacji, nie powinien sÅ‚uÅ¼yÄ‡ do uwierzytelniania, a jedynie do autoryzacji (ÅºrÃ³dÅ‚o ğŸ”—):  OAuth 2.0 is not an authentication protocol.JeÅ›li potrzebujemy mechanizmu pozwalajÄ…cego na poprawne zaimplementowanie uwierzytelniania, z pomocÄ… przychodzi OpenID Connect.OpenID ConnectOpenID Connect jest prostÄ… warstwÄ… toÅ¼samoÅ›ci opartÄ… na OAuth 2.0.UmoÅ¼liwia klientom weryfikacjÄ™ toÅ¼samoÅ›ci uÅ¼ytkownika koÅ„cowego na podstawie uwierzytelnienia przeprowadzonego przez serwer autoryzacji, a takÅ¼e uzyskanie podstawowych informacji o jego profilu. Rozszerza OAuth 2.0, umoÅ¼liwiajÄ…c uwierzytelnianie stowarzyszone (ang. federated authentication):  Federated Authentication - uÅ¼ytkownik loguje siÄ™ do serwisu Spotify przy uÅ¼yciu konta na portalu Facebook (OpenID Connect);  Delegated Authorization - Spotify prÃ³buje uzyskaÄ‡ dostÄ™p do listy znajomych na Facebooku, aby zaimportowaÄ‡ jÄ… do swojej bazy danych (OAuth 2.0).PrzepÅ‚yw procesu jest podobny do OAuth 2.0, ale dodatkowo w procesie bierze udziaÅ‚ ID Token.ID TokenID Token przypomina koncepcjÄ™ dowodu osobistego w formacie JWT, podpisanego przez dostawcÄ™ OpenID (OP). SpeÅ‚nia zaÅ‚oÅ¼enia standardu JWT, wiÄ™c skÅ‚ada siÄ™ z nagÅ‚Ã³wka, zawartoÅ›ci orazsygnatury. Jego zawartoÅ›Ä‡ moÅ¼e wiÄ™c wyglÄ…daÄ‡ nastÄ™pujÄ…co:{  &quot;jti&quot;: &quot;e78b5f41-e769-4353-8874-44302f4a17c3&quot;,  &quot;exp&quot;: 1583205992,  &quot;nbf&quot;: 0,  &quot;iat&quot;: 1583169992,  &quot;iss&quot;: &quot;http://localhost:8180/auth/realms/SpringBootAngular&quot;,  &quot;aud&quot;: &quot;developer&quot;,  &quot;sub&quot;: &quot;c3c3755a-e499-4782-b119-a19bede0ace8&quot;,  &quot;typ&quot;: &quot;Serialized-ID&quot;,  &quot;nonce&quot;: &quot;02c0b033-bfac-4030-a317-c18aec3cb2db&quot;,  &quot;auth_time&quot;: 1583169991,  &quot;acr&quot; : &quot;1&quot;,  &quot;session_state&quot;: &quot;8b66127b-4474-41bd-8e36-5d18286df73f&quot;,  &quot;state_checker&quot;: &quot;HZZmC4no-TEqiCf31Mk1MtONDqyxkk81ZXZCwANQb9Y&quot;,  &quot;name&quot;: &quot;Jan Nowak&quot;,  &quot;email&quot;: &quot;jan.nowak@example.pl&quot;}W skrÃ³cie, ID Token m.in.:  potwierdza toÅ¼samoÅ›Ä‡ uÅ¼ytkownika, zwanego podmiotem w OpenID (sub);  okreÅ›la organ wydajÄ…cy (iss);  jest generowany dla okreÅ›lonej grupy odbiorcÃ³w - klienta (aud);  moÅ¼e zawieraÄ‡ losowy ciÄ…g sÅ‚uÅ¼Ä…cy do identyfikowania pochodzenia Å¼Ä…dania (nonce);  moÅ¼e okreÅ›laÄ‡ kiedy (auth time) i jak, pod wzglÄ™dem siÅ‚y (acr) uÅ¼ytkownik zostaÅ‚ uwierzytelniony;  posiada znacznik czasu wydania (iat) oraz czas waÅ¼noÅ›ci (exp);  moÅ¼e zawieraÄ‡ dodatkowe informacje takie jak imiÄ™, nazwisko (name) oraz adres email (email);  jest podpisany cyfrowo, dziÄ™ki czemu moÅ¼e zostaÄ‡ zweryfikowany;  opcjonalnie moÅ¼e zostaÄ‡ zaszyfrowany w celu zapewnienia poufnoÅ›ci danych.WiÄ™cej informacji na ten temat znajdziemy w oficjalnej dokumentacji ğŸ”—.PodsumowanieDziÄ™ki wykorzystaniu ID Token, OpenID Connect nadaje siÄ™ do uwierzytelniania uÅ¼ytkownika, w przeciwieÅ„stwie do OAuth 2.0, ktÃ³ry najlepiej sprawdzi siÄ™ podczas autoryzacji dwÃ³ch aplikacji komunikujÄ…cych siÄ™ miÄ™dzy sobÄ… przez API.Wiemy juÅ¼, Å¼e Federated Authentication ma zastosowanie, kiedy uÅ¼ytkownik loguje siÄ™ do serwisu przy uÅ¼yciu wspÃ³lnego konta.OpenID Connect wydaje siÄ™ wiÄ™c byÄ‡ naturalnym kandydatem do uwierzytelniania uÅ¼ytkownikÃ³w w rÃ³Å¼nego rodzaju serwisach spoÅ‚ecznoÅ›ciowych czy aplikacjach internetowych (jak w przykÅ‚adzie logowania do aplikacji za poÅ›rednictwem Keycloaka).Delegated Authorization natomiast ma zastosowanie, kiedy klient (aplikacja) prÃ³buje uzyskaÄ‡ dostÄ™p do zasobÃ³w innej aplikacji. UÅ¼ytkownik musi jedynie zaakceptowaÄ‡ uprawnienia przyznawane aplikacji klienckiej, czyli np. odczyt listy znajomych na Facebooku, o ktÃ³ry ubiega siÄ™ Spotify.Tutaj do autoryzacji Spotify w Facebooku najlepiej spisze siÄ™ OAuth 2.0.Standardy wymienione we wstÄ™pie moÅ¼na podsumowaÄ‡ nastÄ™pujÄ…co:  OAuth 2.0 - stworzony w 2006 roku przy wspÃ³Å‚pracy Twittera i Google, otwarty standard autoryzacji oparty o format JSON. GÅ‚Ã³wne zastosowanie to autoryzacja API miÄ™dzy dwoma aplikacjami;  OpenID Connect 1.0 - stworzony w 2014 roku przez OpenID Foundation, otwarty standard uwierzytelniania oparty o format JSON. GÅ‚Ã³wne zastosowanie to SSO dla aplikacji konsumenckich;  SAML 2.0 - stworzony w 2001 roku przez OASIS, otwarty standard autoryzacji i uwierzytelniania oparty o format XML. GÅ‚Ã³wne zastosowanie to SSO dla aplikacji enterprise.",
"url": "/2020/03/09/o-openid-connect-slow-kilka.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2020-03-09-o-openid-connect-slow-kilka/oauth.jpg",
"date": "09-03-2020",
"path": "pl/2020-03-09-o-openid-connect-slow-kilka"
}
,


"2020-02-14-angular-app-initializer-html": {
"title": "Angular APP_INITIALIZER",
"lang": "pl",
"tags": "Angular APP_INITIALIZER Application Initializer InjectionToken DI Dependency Injection ApplicationInitStatus",
"content": "APP_INITIALIZER to wbudowany w Angulara InjectionToken.Pod InjectionToken moÅ¼na zarejestrowaÄ‡ wartoÅ›Ä‡, funkcjÄ™ albo serwis. Token ten moÅ¼na wstrzyknÄ…Ä‡ do komponentu lub serwisu.PrzykÅ‚ad zdefiniowania MY_TOKEN:export const MY_TOKEN = new InjectionToken&amp;lt;string&amp;gt;(&#39;MY_TOKEN&#39;);Zarejestrowanie wartoÅ›ci Hello pod MY_TOKEN:@NgModule({// (...)providers: [{  provide: MY_TOKEN,  useValue: &#39;Hello&#39;,}]// (...)})export class AppModule { }WstrzykniÄ™cie wartoÅ›ci MY_TOKEN do serwisu oraz wyÅ›wietlenie w konsoli przeglÄ…darki Hello:@Injectable()export class MyService {  constructor(@Inject(MY_TOKEN) public value: string) {    console.log(value);  }}Natomiast, dziÄ™ki tokenowi APP_INITIALIZER, moÅ¼liwe jest wykonanie funkcji, lub zestawu funkcji, ktÃ³re zostanÄ… wykonane przed uruchomieniem aplikacji (bootstraping).PrzykÅ‚adProsty przykÅ‚ad wywoÅ‚ania dwÃ³ch funkcji przed startem aplikacji:export function appInit1() {  return () =&amp;gt; console.log(&#39;Hello from appInit1!&#39;);}export function appInit2() {  return () =&amp;gt; console.log(&#39;Hello from appInit2!&#39;);}Parametr multi pozwala na rejestracjÄ™ dwÃ³ch lub wiÄ™cej funkcji pod APP_INITIALIZER:@NgModule({// (...)providers: [{  provide: APP_INITIALIZER,  useFactory: appInit1,  multi: true},{  provide: APP_INITIALIZER,  useFactory: appInit2,  multi: true}],// (...)})export class AppModule { }W konsoli przeglÄ…darki pojawiÄ… siÄ™ poniÅ¼sze komunikaty:Hello from appInit1!Hello from appInit2!PrzykÅ‚ad z PromiseDo APP_INITIALIZER moÅ¼na takÅ¼e przekazaÄ‡ funkcjÄ™, ktÃ³ra zwrÃ³ci Promise! Angular poczeka, aÅ¼ wszystkie zwrÃ³cone Promiseâ€™y zostanÄ… rozwiÄ…zane (resolved).export function appInit() {  return () =&amp;gt; new Promise((resolve, reject) =&amp;gt; {    setTimeout(() =&amp;gt; {      console.log(&#39;Hello from appInit&#39;);      resolve();    }, 2000);  })}@NgModule({// (...)providers: [{  provide: APP_INITIALIZER,  useFactory: appInit,  multi: true}],// (...)})export class AppModule { }W rezultacie, po 2 sekundach od wywoÅ‚ania funkcji appInit, w konsoli zostanie wyÅ›wietlona wiadomoÅ›Ä‡: Hello from appInit.Zaawansowany przykÅ‚adDo funkcji uruchamianej przed bootstrapem aplikacji moÅ¼liwe jest wstrzykniÄ™cie serwisu.W poniÅ¼szym przykÅ‚adzie aplikacja frontendowa Å›ciÄ…ga konfiguracjÄ™ wymaganÄ… do poprawnego dziaÅ‚ania.Na backendzie wystawiony jest plik conf.json, serwowany przez http-server.Interface Configuration jest modelem danych z pliku conf.json, zawiera tylko pole name.Serwis AppInitService wywoÅ‚uje Å¼Ä…danie typu GET na /api/conf.json.export interface Configuration {  name;}@Injectable()export class AppInitService {  constructor(private httpClient: HttpClient) {  }  init(): Promise&amp;lt;Configuration&amp;gt; {    return this.httpClient.get&amp;lt;Configuration&amp;gt;(&#39;api/conf.json&#39;)           .toPromise();  }}export function appInit(appInitService: AppInitService) {  return () =&amp;gt; appInitService.init().then(configuration =&amp;gt; console.log(configuration));}@NgModule({// (...)providers: [  AppInitService,  {    provide: APP_INITIALIZER,    useFactory: appInit,    deps: [AppInitService],    multi: true  }]// (...)})export class AppModule { }PowyÅ¼szy kod wyÅ›wietli w konsoli konfiguracjÄ™ z pliku conf.json.{name: &quot;Test App name&quot;}Implementacja w AngularzePrzyjrzyjmy siÄ™ teraz, w jaki sposÃ³b APP_INITIALIZER zostaÅ‚ zaimplementowany w samym Angularze.W pliku application_init.ts znajduje siÄ™ definicja InjectionToken.export const APP_INITIALIZER = new InjectionToken&amp;lt;Array&amp;lt;() =&amp;gt; void&amp;gt;&amp;gt;(&#39;Application Initializer&#39;);PoczÄ…tek bootstrapowania aplikacji w Angular wyglÄ…da nastÄ™pujÄ…co:platformRef#bootstrapModuleFactory()return _callAndReportToErrorHandler(exceptionHandler, ngZone !, () =&amp;gt; {       const initStatus: ApplicationInitStatus = moduleRef.injector.get(ApplicationInitStatus);       initStatus.runInitializers(); // (1)       return initStatus.donePromise.then(() =&amp;gt; {         this._moduleDoBootstrap(moduleRef); // (2)         return moduleRef;       });W punkcie (1) w serwisie ApplicationInitStatus wywoÅ‚ana jest funkcja runInitializers. Po zakoÅ„czeniu ApplicationInitStatus, Angular przeprowadza bootstrap komponentu.ApplicationInitStatus#runInitializers()  runInitializers() {    // (...)    const asyncInitPromises: Promise&amp;lt;any&amp;gt;[] = [];    if (this.appInits) {      for (let i = 0; i &amp;lt; this.appInits.length; i++) {        const initResult = this.appInits[i]();        if (isPromise(initResult)) {          asyncInitPromises.push(initResult);        }      }    }    Promise.all(asyncInitPromises).then(() =&amp;gt; { complete(); }).catch(e =&amp;gt; { this.reject(e); });    // (...)  }Metoda runInitializers sprawdza wywoÅ‚ania, ktÃ³re zwrÃ³ciÅ‚y Promise i czeka, aÅ¼ wszystkie funkcje zostanÄ… zakoÅ„czone (resolve).ZastosowaniaDo czego moÅ¼na zastosowaÄ‡ APP_INITIALIZER?  obsÅ‚uga powiadomieÅ„ push z serwera (comety),  pobranie konfiguracji np. CSRF token,  monitorowanie aktywnoÅ›ci uÅ¼ytkownika,  keep alive,  keycloak - polecam Å›wietny wpis MichaÅ‚a Hoji na ten temat ÅºrÃ³dÅ‚o.Nawet, jeÅ¼eli w swojej aplikacji nie uÅ¼ywamy APP_INITIALIZER, sam Angular wykorzystuje go do poprawnego dziaÅ‚ania.PrzykÅ‚ady uÅ¼ycia w Angularze:  RouterModule, uÅ¼ywany jest do poprawnej pracy GuardÃ³w;  WorkerAppModule;  ServiceWorkerModule;  NgProbe. Angular 9 wprowadza nowy renderer Ivy tym samym mechanizm NgProbe przestanie dziaÅ‚aÄ‡.",
"url": "/2020/02/14/angular-app-initializer.html",
"author": "Dorian Mejer",
"authorUrl": "/authors/dmejer.html",
"image": "dmejer.jpg",
"highlight": "/assets/img/posts/2020-02-14-angular-app-initializer/app_initializer.png",
"date": "14-02-2020",
"path": "pl/2020-02-14-angular-app-initializer"
}
,


"2020-02-01-keycloak-user-authentication-authorization-springboot-angular-html": {
"title": "Keycloak - user authentication and authorization in Angular/Spring Boot application",
"lang": "en",
"tags": "angular spring boot keycloak keycloak-spring-boot-2-starter keycloak-spring-boot-2-adapter keycloak-angular uwierzytelnianie uÅ¼ytkownika",
"content": "Keycloak - user authentication and authorization in Angular/Spring Boot applicationIn this article I will demonstrate using a Keycloak server to log into an application on the example of a ready-made project which enables logging in from the browser level.What is Keycloak?Keycloak is an open source authentication and authorization server. It can connect to the LDAP/AD or authenticate users via Google, Facebook, etc. It also features an admin console where you can easily configure user permissions and other parameters.Find out more at www.keycloak.org.Demo projectThe application is available on GitHub.It consists of a back-end part written in Spring Boot (Kotlin) and a front-end application part in Angular 8.For the purpose of demonstrating the implementation of user authentication with a Keycloak server, letâ€™s secure the endpoints on the backend and the front-end part separately.Keycloak serverThe Keycloak server will be run in Docker. Execute the following command in the main repo directory to run an instance of a Keycloak server on port 8180:docker run --rm --name keycloak-server -p 8180:8080 \\  -e KEYCLOAK_USER=admin \\  -e KEYCLOAK_PASSWORD=admin \\  -e KEYCLOAK_IMPORT=/realm/realm-export.json \\  -v $(pwd)/realm/:/realm/ \\  jboss/keycloakThe admin console will be available at: 127.0.0.1:8180/auth/adminLog in to the admin console using the login and password defined in KEYCLOAK_USER and KEYCLOAK_PASSWORD, in this case admin:admin.Server configurationKeycloak server configuration deserves a separate article so letâ€™s use a pre-made configuration here.The server configuration export has been located in the demo projectâ€™s repository (realm/realm-export.json) and will be loaded at server start.** The following parameters have been configured: **  realm SpringBootAngular  client SpringBootAngularClient          Access Type: confidential - when logging in you need to pass the secret configured in SpringBootAngularClient                  also available are bearer-only and public options - more about that can be found in the  documentation                    Valid Redirect URIs: * - no limitations for convenience      Web Origins: * - no limitations for convenience        user_role - only a user with this role will be able to authorize themselves in the applications  user with user_role (user:password)  user2 without user_role (user2:password2)Backend applicationThe backend application consists of two controllers:  MainController - exposes the secured endpoints          /api/hello - returns the Hello from the Backend! string      /api/logout - logs the user out of the backend application        KeycloakController - exposes a public endpoint          api/keycloak/config - exposes a shared configuration to the frontend      Frontend applicationThe frontend application consist of three components:  PublicComponent - accessible to everyone without logging in  ProtectedComponent - protected from unauthorized users  ToolbarComponent - menu with buttons for convenienceAuthentication on backendDependenciesThe following dependencies will be used on the backend:  org.keycloak:keycloak-adapter-cores  org.keycloak:keycloak-spring-boot-2-adapter  org.keycloak:keycloak-tomcat-adapterOne dependency containing the following adapters could be used:  org.keycloak:keycloak-spring-boot-2-starter couldHowever, the latest available version, 4.0.0.Final, uses older adapter versions. One of the changes in newer adapter versions is improved token validation. If a new version of the dependencies with improved adapters comes out in the future, it will be possible to useit as well.ConfigurationBesides configuring the application port and adapter login level (which lets you see what exactly is going on in the logs), you need to configure keycloak-adapter-core.Thanks to keycloak-spring-boot-2-adapter everything can be configured in application.yml:keycloakRequiredUserRole: user_rolekeycloak:  enabled: true  auth-server-url: http://localhost:8180/auth  realm: SpringBootAngular  resource: SpringBootAngularClient  security-constraints:    - authRoles:        - ${keycloakRequiredUserRole}      securityCollections:        - name: protected resource          patterns:            - /api/*    - securityCollections:        - name: public resource          patterns:            - /api/keycloak/config  credentials:    secret: &quot;&amp;lt;SECRET&amp;gt;&quot;  realm-key: &quot;&amp;lt;PUBLIC_KEY&amp;gt;&quot;  keycloakRequiredUserRole - since only one role will be used, it will be easier to make it accessible via API (if you want to use more roles, you need to extract them from the authRoles list)  keycloak.security-constraints - you define endpoint limitations hereYou can define paths that are public:e.g. /api/keycloak/configand paths which will require permissionse.g. /api/*which will require ${keycloakRequiredUserRole} from the user (that is user_role).Keycloak configuration:  keycloak.enabled - allows you to easily switch off authentication;  keycloak.auth-server-url - Keycloak server address;  keycloak.realm - realm name;  keycloak.resource - name of the client configured for the given realm;  keycloak.credentials.secret - secret generated in SpringBootAngularClient, you can find it in admin console (Clients &amp;gt; SpringBootAngularClient &amp;gt; Credentials &amp;gt; Secret);  keycloak.realm-key - realmâ€™s public key, you can find it in the admin console (Realm Settings &amp;gt; Keys &amp;gt; Active &amp;gt; RSA &amp;gt; Public Key).Exposing configuration to frontendSince the backend and frontend applications are secured separately, and the Keycloak configuration remains the same, the configuration can be exposed from application.yml via API. This way you can avoid duplicating the configuration in the frontend application.Expose the configuration in KeycloakController at the following address: api/keycloak/config. It will look like that:{    &quot;enabled&quot;: true,    &quot;authServerUrl&quot;: &quot;http://localhost:8180/auth&quot;,    &quot;realm&quot;: &quot;SpringBootAngular&quot;,    &quot;resource&quot;: &quot;SpringBootAngularClient&quot;,    &quot;requiredUserRole&quot;: &quot;user_role&quot;,    &quot;credentials&quot;: {        &quot;secret&quot;: &quot;&amp;lt;SECRET&amp;gt;&quot;    }}Authentication on the frontendDependenciesThe keycloak-angular library will be used on the frontend link.Add dependencies in package.json:&quot;keycloak-angular&quot;: &quot;^7.0.1&quot;,&quot;keycloak-js&quot;: &quot;^6.0.1&quot;Downloading configuration from backendThe configuration can be downloaded by calling the backend endpoint.The first configuration download from KeycloakConfigService will execute a request and the result will be saved. Subsequent downloads will return the saved configuration.@Injectable({providedIn: &#39;root&#39;})export class KeycloakConfigService {    private config: KeycloakConfig;    constructor(private http: HttpClient) {    }    getConfig(): Observable&amp;lt;KeycloakConfig&amp;gt; {        if (this.config) {            return of(this.config);        } else {            const configObservable = this.http.get&amp;lt;KeycloakConfig&amp;gt;(&#39;/api/keycloak/config&#39;);            configObservable.subscribe(config =&amp;gt; this.config = config);            return configObservable;        }    }}ConfigurationUse the downloaded configuration in the injection token, defining the provider for the APP_INITIALIZER token in app.module.ts:{    provide: APP_INITIALIZER,    useFactory: initializer,    multi: true,    deps: [KeycloakService, KeycloakConfigService]}Create a function using the KeycloakConfigService that initializes KeycloakService from the keycloak-angular library:export function initializer(keycloakService: KeycloakService, keycloakConfigService: KeycloakConfigService): () =&amp;gt; Promise&amp;lt;boolean&amp;gt; {    return (): Promise&amp;lt;boolean&amp;gt; =&amp;gt; keycloakConfigService.getConfig()        .pipe(            filter(config =&amp;gt; config.enabled),            flatMap(config =&amp;gt; {                return keycloakService.init({                    config: {                        url: config.authServerUrl,                        realm: config.realm,                        clientId: config.resource,                        credentials: {                            secret: config.credentials.secret                        }                    },                    initOptions: {                        onLoad: &#39;check-sso&#39;,                        checkLoginIframe: false                    }                });            })).toPromise();}Securing routesIn order to secure routes, use Angular Route Guard.Create AppAuthGuard by extending KeycloakAuthGuard and implementing canActivate.Download the configuration from KeycloakConfigService in the constructor to verify if authentication is enabled (the keycloak.enabled parameter in application.yml), and check if the user has the required role:@Injectable({    providedIn: &#39;root&#39;})export class AppAuthGuard extends KeycloakAuthGuard {    isAuthEnabled: boolean = true;    requiredUserRole: string;    constructor(protected router: Router, protected keycloakService: KeycloakService, private keycloakConfigService: KeycloakConfigService) {        super(router, keycloakService);        this.keycloakConfigService.getConfig().subscribe(config =&amp;gt; {            this.isAuthEnabled = config.enabled;            this.requiredUserRole = config.requiredUserRole;        });    }    canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Promise&amp;lt;boolean&amp;gt; {        if (!this.isAuthEnabled) {            return Promise.resolve(true);        } else {            return super.canActivate(route, state) as Promise&amp;lt;boolean&amp;gt;;        }    }    isAccessAllowed(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Promise&amp;lt;boolean&amp;gt; {        return new Promise(async (resolve) =&amp;gt; {            if (!this.authenticated) {                return this.keycloakService.login();            }            resolve(this.roles.includes(this.requiredUserRole));        });    }}Next, use the guard in w app-routing.module.ts to secure the protected route:const routes: Routes = [    {        path: &#39;&#39;,        component: PublicComponent    },    {        path: &#39;protected&#39;,        component: ProtectedComponent,        canActivate: [AppAuthGuard]    }];TestsRunning a containerOnce you have a Keycloak server running, you can build the application and a Docker image and then run a container.To do so, first build the application in the main repo directory:./gradlew buildNext, create a docker image:docker build -t michuu93/spring-angular-keycloak-demo .Finally, run the container:docker run --rm --name spring-angular-keycloak-demo --network host michuu93/spring-angular-keycloak-demoSince the applications inside the container as well as you operating at the browser level need to have access to the Keycloak server at the same address, a container with the --network host option is run in Docker. Letâ€™s skip the details on how the network works for now.Thanks to that you donâ€™t have to expose any proxy or replace hosts in the system. This is, however, a simplification made for the purpose of the demo and shouldnâ€™t be used in a production environment.Verifying authentication procedureAfter running the application you can test it in action.Go to localhost:9082 where you should see the frontend application, specifically ToolbarComponent and PublicComponent:You can use the menu to go to:  Public - unsecured route with PublicComponent;  Protected - secured route with ProtectedComponent;  Keycloak Configuration - unsecured endpoint exposing Keycloak configuration from the backend;  Backend Hello - secure endpoint that returns Hello from the Backend!;  Logout (backend) - logging out of the backend;  Logout (frontend) - button which logs you out of the frontend, available only after logging into the frontend.To check if you have access to Keycloak Configuration without logging in, execute:It looks like the public route and API endpoint are working properly.If you now move to Protected, you will be redirected to Keycloakâ€™s login page:http://localhost:8180/auth/realms/SpringBootAngular/protocol/openid-connect/auth?client_id=SpringBootAngularClient&amp;amp;redirect_uri=http%3A%2F%2Flocalhost%3A9082%2F%23%2F&amp;amp;state=3e007783-4772-48dd-8b31-4bfe3cc9c42c&amp;amp;response_mode=fragment&amp;amp;response_type=code&amp;amp;scope=openid&amp;amp;nonce=023ab545-32dc-4bdc-9cbf-12cad1d0c944As you can see, the address contains information such as protocol name, realm, client and the address you will be redirected to after logging in.If you log in with a user that has user_role (user:password), you will be redirected back to the application:Additionally, you can use the Logout (frontend) button. Youâ€™re logged in now, so you can go to Protected:Backend Hello will work as well:If you log out of the frontend now - Logout (frontend), the Logout (frontend) button will disappear and you will no longer have access to Protected.You will still have access to Backend Hello. Only when you log out of the backend - Logout (backend), will you lose access to Backend Hello.However, if you are a logged in user and you log out of the backend, not the frontend, you will be automatically logged out of the frontend as well.Why?The principles of how Keycloak and the tokens (the OpenID Connect standard specifically) work is a separate topic. Due to complex implementation, logging out deserves a separate article, especially when distributed systems with multiple application instances running behind a load balancer are involved.The demo has a very simple logging out mechanism.Logging out from the frontend will call the logout method on the keycloak-angular library service:logout = async (): Promise&amp;lt;void&amp;gt; =&amp;gt; await this.keycloakService.logout();whereas logging out from the backend will call /api/logout, which will result in executing:fun logout(request: HttpServletRequest, response: HttpServletResponse) {    request.logout()    response.sendRedirect(&quot;/&quot;)}on the backend.Finally, letâ€™s also verify a user without the user_role (user2:password2).After logging in, you should see the same buttons in the menu as in the case of a user with the required role.This is so because displaying buttons is not dependent on whether the user has the permission to the route but on whether they are logged in:ngOnInit(): void {    this.keycloakService.isLoggedIn().then(isLogged =&amp;gt; this.isLogged = isLogged);}Calling Backend Hello will not be possible either.Authentication can be quickly turned off in both applications by setting keycloak.enabled in application.yml to false.It can be useful e.g. in test environments.Closing remarksI hope this article has been useful in demonstrating how to integrate an application with a Keycloak server.Still, this is not the only method of implementation. If the application is supposed to be more flexible, you can use the implementation of the OAuth2 standard using Spring Security. This way you will not be tied to a Keycloak server and in the future you will be able to easily replace it with a different authentication/authorization server.Keycloak exposes endpoints at which the configuration is available (link).You can find them in Realm Settings &amp;gt; General &amp;gt; Endpoints. For OpenID Connect in this case it is:http://127.0.0.1:8180/auth/realms/SpringBootAngular/.well-known/openid-configurationThey can be useful if the application does not use Keycloak adapters to connect to the server.Also, you donâ€™t have to log in to the application via a browser but you can use Keycloak to authenticate applications between one another, e.g. when you are integrating various modules together. In such a case, the bearer-only option` in the client configuration will be useful.",
"url": "/2020/02/01/keycloak-user-authentication-authorization-springboot-angular.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2020-02-01-keycloak-uwierzytelnianie-autoryzacja-springboot-angular/Keycloak.png",
"date": "01-02-2020",
"path": "en/2020-02-01-keycloak-user-authentication-authorization-springboot-angular"
}
,


"2020-01-19-zarzadzanie-zadaniami-html": {
"title": "Moje wÅ‚asne zadania i jak siÄ™ w nich odnaleÅºÄ‡",
"lang": "pl",
"tags": "Personal Tasks Time Management Productivity To-Do Lists Planning Your Day",
"content": "Czy warto Å›wiadomie zarzÄ…dzaÄ‡ zadaniami?WiÄ™kszoÅ›Ä‡ z nas ma coÅ› do zrobienia. Na poczÄ…tku owe coÅ› jest doÅ›Ä‡ ogÃ³lnie zdefiniowane, np.: â€œnapisaÄ‡ wpis na blogaâ€ czy â€œzaprojektowaÄ‡ mechanizm Å‚adowania moduÅ‚Ã³w aplikacjiâ€. DoÅ›Ä‡ szybko zaczynamy rozbijaÄ‡ temat na mniejsze elementy. Te mniejsze elementy zostajÄ… doprecyzowane lub dalej podzielone, aby w koÅ„cu staÄ‡ siÄ™  zadaniami:  wymyÅ›liÄ‡ tytuÅ‚ i datÄ™ publikacji wpisu  zaproponowaÄ‡ agendÄ™  napisaÄ‡ tekst.Bierzemy pierwsze zadanie od gÃ³ry i zaczynamy realizowaÄ‡ nasz projekt. DoÅ›Ä‡ szybko pojawiajÄ… siÄ™ nowe zadania:  skoordynowaÄ‡ datÄ™ publikacji z innymi wpisami w kolejce  zorganizowaÄ‡ wsparcie merytoryczne          doprecyzowaÄ‡ agendÄ™, aby mÃ³c wybraÄ‡ osobÄ™ wspierajÄ…cÄ…        zweryfikowaÄ‡ dane statystyczne  sporzÄ…dziÄ‡ listÄ™ ÅºrÃ³deÅ‚  wybraÄ‡ grafiki.Jeszcze nie zaczÄ™liÅ›my pisaÄ‡ samego tekstu bloga a juÅ¼ mamy 9 zadaÅ„. W miarÄ™ postÄ™pu prac pojawiajÄ… siÄ™ nastÄ™pne konkretne zadania:  znaleÅºÄ‡ wyniki badaÅ„ potwierdzajÄ…cych tezÄ™  przeredagowaÄ‡ punkt 5  skrÃ³ciÄ‡ podsumowanie  uzgodniÄ‡ przesuniÄ™cie daty publikacji  poprawiÄ‡ literÃ³wki po przeglÄ…dzie.OpierajÄ…c siÄ™ na wÅ‚asnym doÅ›wiadczeniu zaryzykujÄ™ poniÅ¼sze stwierdzenia:  nawet przy pozornie prostym temacie zadaÅ„ potrafi byÄ‡ sporo  nowe zadania pojawiajÄ… siÄ™ ciÄ…gle, w trakcje realizacji innych zadaÅ„.WiÄ™kszoÅ›Ä‡ z nas zarzÄ…dza wÅ‚asnymi zadaniami. Åšwiadomie lub nie. CzÄ™Å›Ä‡ z nas robi to w pamiÄ™ci - pamiÄ™tam o kupieniu kwiatÃ³w dla Å¼ony na rocznicÄ™ Å›lubu. Niestety nasz mÃ³zg ma pewne ograniczenia utrudniajÄ…ce zarzÄ…dzanie zadaniami w pamiÄ™ci.Zadania przechowywane w pamiÄ™ci trudno siÄ™ priorytetyzuje. Ciekawe zadania automatycznie stajÄ… siÄ™ waÅ¼niejsze. Podobnie zresztÄ… zadania nowe. DuÅ¼y wpÅ‚yw na priorytety zadaÅ„ majÄ… teÅ¼ czynniki zewnÄ™trzne co nie zawsze jest poÅ¼Ä…dane. CytujÄ…c nasz biurowy humor: â€œkto gÅ‚oÅ›niej krzyczy ten ma wiÄ™kszy priorytetâ€.Zadania nudne lub odlegÅ‚e w czasie doÅ›Ä‡ Å‚atwo mogÄ… siÄ™ zagubiÄ‡ w mÃ³zgu, przynajmniej w moim. SzczegÃ³lnie gdy lista zadaÅ„ i rÃ³Å¼nych wÄ…tkÃ³w, ktÃ³re naleÅ¼y kontrolowaÄ‡ ciÄ…gle roÅ›nie. Paradoksalnie niektÃ³re zadania trudno usunÄ…Ä‡ z mÃ³zgu. Mam w gÅ‚owie mnÃ³stwo rzeczy, o ktÃ³rych nie muszÄ™ juÅ¼ pamiÄ™taÄ‡ i z przyjemnoÅ›ciÄ… zwolniÅ‚bym tÄ™ czÄ™Å›Ä‡ pamiÄ™ci.NajwaÅ¼niejszym argumentem przeciwko przechowywaniu listy zadaÅ„ w gÅ‚owie jest skalowanie tego rozwiÄ…zania. Owszem, mÃ³zg moÅ¼na Ä‡wiczyÄ‡ i konsekwentnie poprawiaÄ‡ jego dziaÅ‚anie, jednakÅ¼e wiÄ™kszoÅ›Ä‡ z nas ma swÃ³j limit po przekroczeniu ktÃ³rego zaczyna gubiÄ‡ informacje. W miarÄ™ jak lista zadaÅ„ w naszej gÅ‚owie roÅ›nie, prÄ™dzej czy pÃ³Åºniej o ktÃ³rymÅ› zapomnimy.Mam nadziejÄ™, Å¼e na na tym etapie tekstu jest jasne, Å¼e warto odciÄ…Å¼yÄ‡ gÅ‚owy przenoszÄ…c gdzieÅ› listÄ™ zadaÅ„. Pytanie zatem gdzie?Co chcÄ™ osiÄ…gnÄ…Ä‡?WybierajÄ…c mechanizm zarzÄ…dzania zadaniami mam dwa podstawowe cele:  zapisujÄ…c zadanie chcÄ™ mieÄ‡ pewnoÅ›Ä‡, Å¼e zajmÄ™ siÄ™ nim w odpowiednim czasie          nie muszÄ™ o nim pamiÄ™taÄ‡        realizujÄ…c zadanie chcÄ™ mieÄ‡ pewnoÅ›Ä‡, Å¼e jest to najlepsze wykorzystanie mojego czasu w danej chwili          mogÄ™ siÄ™ skupiÄ‡ tylko na tym zadaniu.      Zestaw narzÄ™dzi umoÅ¼liwiajÄ…cych zrealizowanie powyÅ¼szych celÃ³w pozwoli mi ze spokojem pracowaÄ‡ nad meritum i uwolni mnie od nerwowego â€œprzeczesywaniaâ€ pamiÄ™ci: â€œco powinienem teraz zrobiÄ‡?â€, â€œczy wysÅ‚aÅ‚em ofertÄ™ na XYZ?â€, â€œczy mogÄ™ iÅ›Ä‡ do domu?â€.Teoria i metodykiNie bÄ™dzie duÅ¼ym zaskoczeniem jeÅ¼eli napiszÄ™, Å¼e ktoÅ› juÅ¼ wpadÅ‚ na pomysÅ‚ usprawnienia zarzÄ…dzania zadaniami. W internecie i drukowanych materiaÅ‚ach znaleÅºÄ‡ moÅ¼na mnÃ³stwo informacji na temat wielu metodyk zarzÄ…dzania zadaniami, np:  Getting Things Done (GTD)  Getting Sh-t Done (GSD)  Autofocus  Strikethru.CzÄ™Å›Ä‡ metodyk poparta jest badaniami i opiera siÄ™ na naukowych podstawach, aby maksymalizowaÄ‡ efekty naszej pracy. Å»adna z poznanych przeze mnie metryk nie jest jednak dla mnie idealna. W codziennej pracy wykorzystujÄ™ parÄ™ zaleceÅ„ i wskazÃ³wek z rÃ³Å¼nych metodyk i ÅºrÃ³deÅ‚.3 elementy zarzÄ…dzania zadaniamiPracÄ™ z zadaniami dzielÄ™ na trzy podstawowe etapy:  zapisywanie zadaÅ„  przeglÄ…d zadaÅ„  wykonanie zadania.Zapisywanie zadaÅ„Zadanie powinniÅ›my zapisaÄ‡ w momencie, gdy je dostrzeÅ¼emy. Chcemy minimalizowaÄ‡ czas, w ktÃ³rym zadanie jest tylko w naszej pamiÄ™ci. Oznacza to, Å¼e chcemy zapisywaÄ‡ zadania w trakcie wykonywania innych czynnoÅ›ci, np. bÄ™dÄ…c na spotkaniu, pracujÄ…c nad innym zdaniem, rozmawiajÄ…c na korytarzu czy patrzÄ…c przez okno kontemplujÄ…c porannÄ… kawkÄ™.NarzÄ™dzie wspomagajÄ…ce nas w zarzÄ…dzaniu zadaniami musi zatem dostarczaÄ‡ prosty sposÃ³b zapisywania zadania. Jak najmniej danych obowiÄ…zkowych, jak najmniej decyzji do podjÄ™cia w momencie zapisywania. JeÅ¼eli do stworzenia zadania muszÄ™ siÄ™ przygotowaÄ‡ i wiedzieÄ‡ kiedy, jak, gdzie i z kim to zadanie bÄ™dÄ™ wykonywaÅ‚, to czÄ™sto tego zadania nie zapiszÄ™.JeÅ¼eli od poczÄ…tku wiem coÅ› wiÄ™cej o zadaniu np. â€œÅ¼eby wysÅ‚aÄ‡ tego maila bÄ™dÄ™ potrzebowaÅ‚ dostÄ™pu do pocztyâ€ to mogÄ™ od razu to zapisaÄ‡ np. dodajÄ…c etykietÄ™ â€œemailâ€. Ale nie muszÄ™ tego robiÄ‡ natychmiast. MogÄ™ te informacje uzupeÅ‚niÄ‡ pÃ³Åºniej. Najlepiej podczas przeglÄ…dania zadaÅ„.Aby mÃ³c zapisaÄ‡ zadanie musimy najpierw je dostrzec. To samo w sobie czÄ™sto jest bardzo trudne, a czasem wrÄ™cz najtrudniejsze. RealizujÄ…c zadanieÂ Å‚atwo jest â€œzatraciÄ‡ siÄ™â€ i rozwiÄ…zywaÄ‡ kolejne wyzwania bez zastanawiania siÄ™ czy nie odwodzi nas to zbytnio od aktualnego celu.A zatem co moÅ¼e byÄ‡ moim zadaniem? Wszystko co nie jest wprost zaadresowane do osoby obecnej przy rozmowie. Aby w ciÄ…gu sÅ‚Ã³w i myÅ›li rozpoznaÄ‡ potencjalne zadanie warto zwracaÄ‡ uwagÄ™ na wypowiedziane czasowniki:  w pierwszej osobie liczby pojedynczej i mnogiej, np:          â€œzrobiÄ™/zrobimyâ€      â€œsprawdzÄ™/sprawdzimyâ€      â€œzapytamâ€      â€œprzypilnujÄ™/dopilnujÄ™â€        w drugiej osobie liczby mnogiej          â€œzrobicieâ€      â€œsprawdzicieâ€        w trzeciej osobie liczby pojedynczej          â€œon to zrobiâ€.      Zdania z takimi czasownikami opisujÄ… zadanie, ktÃ³re naleÅ¼y wykonaÄ‡ albo upewniÄ‡ siÄ™, Å¼e ktoÅ› je wykona.PrzeglÄ…d zadaÅ„JeÅ¼eli mamy juÅ¼ listÄ™ zadaÅ„ dodanych jak najszybciej, â€œna gorÄ…coâ€, to koniecznie musimy tÄ™ listÄ™ oczyÅ›ciÄ‡. Nieoczyszczana lista szybko robi siÄ™ dÅ‚uga i przeraÅ¼ajÄ…ca. Jej pielÄ™gnowanie jest bardzo waÅ¼ne. Na szczÄ™Å›cie mamy doÅ›Ä‡ proste narzÄ™dzie do pielÄ™gnacji listy: przeglÄ…d.PrzeglÄ…d polega na przejÅ›ciu wszystkich zadaÅ„ na liÅ›cie.  Procedura powtarzana dla kaÅ¼dego zadania moÅ¼e byÄ‡ rÃ³Å¼na. W moim przypadku sprawdza siÄ™ poniÅ¼sza:  jeÅ¼eli zadanie jest nieaktualne lub bez sensu: usuwam to zadanie  jeÅ¼eli zadanie jest â€œmaÅ‚eâ€ (dla mnie najczÄ™Å›ciej to znaczy â€œzajmie mniej niÅ¼ 3 minutyâ€): realizujÄ™ natychmiast  jeÅ¼eli jest jakaÅ› wÄ…tpliwoÅ›Ä‡ w zadaniu i mogÄ™ jÄ… wyjaÅ›niÄ‡: uzupeÅ‚niam opis zadania  jeÅ¼eli jest jakaÅ› wÄ…tpliwoÅ›Ä‡ w zadaniu i nie mogÄ™ jej od razu wyjaÅ›niÄ‡: dodajÄ™ zadanie na wyjaÅ›nienie  upewniam siÄ™, Å¼e zadanie ma peÅ‚en opis wedle obecnego stanu wiedzy (treÅ›Ä‡, priorytet, termin, etykiety, komentarzeâ€¦), w razie potrzeby: uzupeÅ‚niam lub poprawiam opis.Koniec, w ramach przeglÄ…du nie robiÄ™ nic wiÄ™cej. Taki przeglÄ…d powinien zajÄ…Ä‡ nie wiÄ™cej niÅ¼ 15 minut i powinien byÄ‡ robiony co najmniej raz dziennie. Dla mnie optymalne sÄ… dwa przeglÄ…dy: jeden rano â€œdo porannej kawkiâ€ podczas ktÃ³rego staram siÄ™ uÅ‚oÅ¼yÄ‡ plan dnia, i drugi pod koniec pracy w biurze podczas ktÃ³rego upewniam siÄ™ Å¼e nie przeoczyÅ‚em czegoÅ› waÅ¼nego.CzÄ™Å›Ä‡ materiaÅ‚Ã³w dostÄ™pnych online poleca wieczorny przeglÄ…d zadaÅ„ â€œna koniec dniaâ€, aby nastÄ™pnego dnia obudziÄ‡ siÄ™ z gotowym planem na dzieÅ„ w gÅ‚owie. CytujÄ…c klasyka:  â€œnajlepszy sposÃ³b na zakoÅ„czenie dnia to zaplanowanie dnia nastÄ™pnegoâ€PomysÅ‚ jest pociÄ…gajÄ…cy, idea szczytna. Prawda jest taka, Å¼e nie udaÅ‚o mi siÄ™ jak dotÄ…d wcieliÄ‡ tego w Å¼ycie. MoÅ¼e kiedyÅ› bÄ™dÄ™ mÃ³gÅ‚ uzupeÅ‚niÄ‡ ten wpis doÅ›wiadczeniami w tym zakresie.W ramach przeglÄ…du moÅ¼na teÅ¼ przypisaÄ‡ zadaniom kategorie/projekty, priorytety, etykiety, itp. MoÅ¼liwoÅ›ci sÄ… mocno zaleÅ¼ne od wybranego narzÄ™dzia wpierajÄ…cego zarzÄ…dzanie zadaniami, jednak cel jest wspÃ³lny dla wszystkich: podzieliÄ‡ duÅ¼y zbiÃ³r zadaÅ„ na mniejsze, ktÃ³re Å‚atwiej uÅ‚oÅ¼yÄ‡ w odpowiedniej kolejnoÅ›ci.Wykonanie zadaÅ„Po dostrzeÅ¼eniu zadaÅ„, zapisaniu ich poza gÅ‚owÄ…, przejrzeniu i odpowiednim uszeregowaniu przychodzi wreszcie czas na ich wykonanie. JeÅ¼eli poprzednie elementy wykonaliÅ›my poprawnie, moÅ¼emy w tym momencie skupiÄ‡ siÄ™ w 100% na meritum zadania. JesteÅ›my pewni, Å¼e zadanie na gÃ³rze listy jest najwaÅ¼niejsze i w tej chwili powinniÅ›my siÄ™ nim zajÄ…Ä‡. Nie rozprasza nas zastanawianie siÄ™ nad tym, jak lepiej wykorzystaÄ‡ czas.DostÄ™pne narzÄ™dziaWybÃ³r narzÄ™dzia najczÄ™Å›ciej jest najciekawszym etapem rÃ³Å¼nych przedsiÄ™wziÄ™Ä‡. Wiele osÃ³b od tego zaczyna przygodÄ™ z â€œzarzÄ…dzaniem zadaniamiâ€. Niestety wielu teÅ¼ na tym etapie koÅ„czy. PamiÄ™tajmy, Å¼e narzÄ™dzie ma nam pomÃ³c osiÄ…gnÄ…Ä‡ cel. Ma nam uÅ‚atwiÄ‡. Nie wskaÅ¼e nam natomiast celÃ³w i nie wykona zadaÅ„ za nas. Korzystanie z danego narzÄ™dzia nie powinno teÅ¼ byÄ‡ celem samym w sobie.Skoro chcemy jednak â€œgdzieÅ›â€ te zadania zapisywaÄ‡ zobaczmy, jakie mamy moÅ¼liwoÅ›ci.  kartka papieru          Å‚atwe do wdroÅ¼enia, praktycznie zerowy czas wejÅ›cia      trudne zarzÄ…dzanie (sortowanie? priorytetyzacja? zadania cykliczne?)      trudne wyszukiwanie      sÅ‚abe skalowanie        plik tekstowy          Å‚atwe do uruchomienia      Å‚atwe wyszukiwanie      koniecznoÅ›Ä‡ wypracowania wÅ‚asnej notacji i oznaczeÅ„      brak obsÅ‚ugi przypomnieÅ„      synchronizacja pomiÄ™dzy urzÄ…dzeniami?        WIKI (np. lista zadaÅ„ w prywatnej przestrzeni)          Å‚atwe do uruchomienia      Å‚atwe wyszukiwanie      koniecznoÅ›Ä‡ wypracowania wÅ‚asnej notacji i oznaczeÅ„      brak obsÅ‚ugi przypomnieÅ„      Å‚atwa synchronizacja pomiÄ™dzy urzÄ…dzeniami        JIRA (np. lista zadaÅ„ w prywatnym projekcie)          proste zarzÄ…dzanie z wykorzystaniem rankingu, etykiet, epikÃ³w itp.      moÅ¼liwoÅ›Ä‡ skonfigurowania przypomnieÅ„      skomplikowana konfiguracja przepÅ‚ywu i struktury zadania      sÅ‚abe wsparcie dla urzÄ…dzeÅ„ mobilnych bez dodatkowych aplikacji        â€œJIRAâ€ w chmurze (np. Trello)          lista zadaÅ„ w prywatnej â€œchmurzeâ€      proste zarzÄ…dzanie z wykorzystaniem rankingu, etykiet, epikÃ³w itp.      moÅ¼liwoÅ›Ä‡ skonfigurowania przypomnieÅ„      dostÄ™pnoÅ›Ä‡ z internetu (bez vpn/certyfikatÃ³w)      aplikacja mobilna      koniecznoÅ›Ä‡ dostosowania workflow        dedykowana aplikacja          lista zadaÅ„ w prywatnej â€œchmurzeâ€      moÅ¼liwoÅ›Ä‡ wprowadzenia struktury/etykiet      dostÄ™pnoÅ›Ä‡ z internetu      aplikacja mobilna      brak narzuconego/wymaganego workflow.      PowyÅ¼sza lista Å¼adnÄ… miarÄ… nie jest kompletna. Jestem przekonany, Å¼e istnieje jeszcze sporo ciekawych rozwiÄ…zaÅ„. Korzystanie z dedykowanej aplikacji jest jednak tak wygodne, Å¼e przestaÅ‚em szukaÄ‡ dalej.Moje narzÄ™dzieJa do zarzÄ…dzania zadaniami wykorzystujÄ™ aplikacjÄ™ Todoist. MÃ³j wybÃ³r uÅ‚atwiÅ‚y nastÄ™pujÄ…ce wÅ‚aÅ›ciwoÅ›ci aplikacji:  Å‚atwoÅ›Ä‡ dostÄ™pu          WWW      dedykowana aplikacja mobilna      aplikacja Chrome (np. uruchamianie w Ubuntu jako osobne okno ktÃ³re mogÄ™ przykleiÄ‡ do pulpitu)      rozszerzenie Chrome (np. do szybkiego dodawania zadaÅ„)        brak narzuconego sposobu zarzÄ…dzania          nie muszÄ™ definiowaÄ‡ statusÃ³w/workflow zadaÅ„      mogÄ™ dowolnie interpretowaÄ‡ priorytety/etykiety/projekty itp.        dodatkowe wbudowane funkcjonalnoÅ›ci          etykiety      projekty      filtry      przypomnienia czasowe i geograficzne      integracje (email, Gmail, Chrome, Asystent Google, Slack, Kalendarz Google, IFFTâ€¦)        aspekt spoÅ‚ecznoÅ›ciowy          sporo materiaÅ‚Ã³w opisujÄ…cych podejÅ›cia rÃ³Å¼nych osÃ³b do zarzadzania zadaniami w Todoist      Youtube, Twitter, blog.      Dodawanie zadaÅ„ jest proste. Wymaga minimalnej wiedzy o zadaniu jednoczeÅ›nie umoÅ¼liwia ustawienie wszystkich aspektÃ³w natychmiast. DziÄ™ki integracjom mogÄ™ dodawaÄ‡ zadanie w najwygodniejszy aktualnie sposÃ³w, np.  gdy prowadzÄ™ samochÃ³d mogÄ™ powiedzieÄ‡ do Asystenta Google: â€œnotatka dla siebie sprawdÅº jutro czy poszÅ‚a faktura za Xâ€  podczas korzystania z telefonu mogÄ™ dodaÄ‡ zadnie dotykajÄ…c jeden przycisk na ekranie i wpisaÄ‡ treÅ›Ä‡ zadania          etykiety, terminy, priorytety sÄ… zaczytywane z tekstu      moÅ¼na teÅ¼ je Å‚atwo wybraÄ‡ przyciskami        mogÄ™ dodaÄ‡ zadanie wysyÅ‚ajÄ…c email na dedykowany adres          bardzo przydatne jako forward - stworzenie zadania z maila zajmuje 4 sekundy        mogÄ™ dodaÄ‡ zadanie z menu kontekstowego w przeglÄ…darce  mogÄ™ dodaÄ‡ zadanie z poziomu rozmowy na Slack wpisujÄ…Ä‡ â€œ/todoist sprawdÅº kiedy grajÄ… Gwiezdne Wojnyâ€  mogÄ™ dodaÄ‡ zadanie bezpoÅ›rednio w aplikacji  mogÄ™ automatycznie tworzyÄ‡ zadania w odpowiedzi na zdarzenia IFFT.PrzeglÄ…danie zadaÅ„ jest proste. Zadania bez wskazanego projektu wpadajÄ… do skrzynki odbiorczej. Jest to worek, na wszystko co wpadÅ‚o (o ile podczas tworzenia zadania nie podaÅ‚em wprost projektu). PrzeglÄ…dajÄ…c skrzynkÄ™ odbiorczÄ… mogÄ™:  uzupeÅ‚niÄ‡ opis zadania          notatki w formie tekstu i zaÅ‚Ä…cznikÃ³w        dodaÄ‡ podzadania  ustawiÄ‡ priorytet          5 poziomÃ³w      steruje kolejnoÅ›ciÄ… wyÅ›wietlania zadaÅ„ (prosto, bez rÄ™cznego sortowania i nadmiernego wyboru)        przypisaÄ‡ do projektu          pozwala zdefiniowaÄ‡ osobne worki zadaÅ„      uÅ‚atwia â€œogarniÄ™cieâ€ duÅ¼ej iloÅ›ci zadaÅ„        ustawiÄ‡ etykietÄ™          ja wykorzystujÄ™ etykiety jako wskazÃ³wki czego potrzebujÄ™ do wykonania zadania      jedno zadanie moÅ¼e mieÄ‡ wiele etykiet      przykÅ‚ady moich etykiet: email, wiki, jira, biuro, cisza      bardzo przydatne przy wykorzystaniu filtrÃ³w        ustawiÄ‡ termin  ustawiÄ‡ przypomnienie          czasowe      geograficzne (np. â€œgdy wejdÄ™ do Castoramaâ€) - brzmi fajnie, przydatnoÅ›Ä‡ taka sobie w moim przypadku.      WybÃ³r zadania do wykonania jest prosty. Opieram siÄ™ o filtry wybierajÄ…ce zadania na dany moment. Dla przykÅ‚adu:  filtr â€œK9â€ (od nazwy naszego biura):          etykiety: biuro lub jira lub wiki lub email lub telefon lub â€œnie ciszaâ€      termin: dzisiaj lub brak terminu (jeÅ¼eli na jutro to dzisiaj nie wrzucaj mi tego na ekran)        filtr â€œpociÄ…gâ€:          etykiety: jira lub wiki lub email lub cisza      termin: dzisiaj lub brak terminu        filtr â€œwieczÃ³râ€:          etykiety: jira lub wiki lub email lub cisza lub â€œnie biuroâ€.      Zadania widoku filtra sÄ… posortowane po priorytetach. NajwaÅ¼niejsze na gÃ³rze. Aplikacja Chrome dodana do autostartu zapewnia Å¼e lista zadaÅ„ bÄ™dzie zawsze widoczna na pulpicie komputera.Kiedy to wszystko robiÄ‡?Dodajemy zadania ciÄ…gle, na bieÅ¼Ä…co. Nie chcemy pamiÄ™taÄ‡ o dodaniu zadania.PrzeglÄ…d zadaÅ„ - regularnie. U mnie sprawdza siÄ™ metoda â€œpozytywnego skojarzeniaâ€: poranny przeglÄ…d zadaÅ„ zawsze przy porannej kawce. NaleÅ¼y pamiÄ™taÄ‡, Å¼e przeglÄ…d moÅ¼na robiÄ‡ teÅ¼ w miarÄ™ potrzeb, nawet jeÅ›li niedawno zrobiÅ‚o siÄ™ planowany. JeÅ¼eli np. zrealizowaliÅ›my juÅ¼ wszystkie zadania na dzisiaj (rzadko) albo sprawy bieÅ¼Ä…ce przygniotÅ‚y nas bardziej niÅ¼ zakÅ‚adaliÅ›my (czÄ™sto).Wykonywanie zadaÅ„ - ciÄ…gle. JeÅ¼eli siadam przy biurku, to nie zastanawiam siÄ™, co tu by zrobiÄ‡. PatrzÄ™ na listÄ™ w odpowiednim filtrze i jadÄ™ od gÃ³ry. Zadanie moÅ¼emy rÃ³wnieÅ¼ wykonywaÄ‡ w odpowiedzi na przypomnienie. Polecam jednak ostroÅ¼noÅ›Ä‡ w tym aspekcie. Przypomnienia potrafiÄ… skutecznie wybiÄ‡ z rytmu.Kiedy robiÄ™ coÅ› nie tak?Po czym mogÄ™ poznaÄ‡, Å¼e coÅ› robiÄ™ nie tak? Mam skonfigurowane narzÄ™dzie. Jestem zmotywowany. CoÅ› tam wychodzi, ale czy na pewno? PoniÅ¼sze objawy powinny nas sprowokowaÄ‡ do optymalizacji lub zmiany podejÅ›cia:  nie zapisujÄ™ zadaÅ„          nie mam przy sobie narzÄ™dzia      nie wiem, na kiedy to      nie wiem, czego bÄ™dÄ™ potrzebowaÅ‚      nie wiem, czy warto        realizujÄ™ chaotycznie          nie wiem, za co siÄ™ zabraÄ‡      â€œaaaa, tutaj to byÅ‚o!â€â€      â€œdzisiaj juÅ¼ tego nie dokoÅ„czÄ™â€        realizujÄ™ z pamiÄ™ci i potem znajdujÄ™ zadania juÅ¼ wykonane          â€œo to juÅ¼ zrobiÅ‚em dwa tygodnie temuâ€      â€œten projekt zrobiliÅ›my w zeszÅ‚ym rokuâ€        realizujÄ™ zbyt duÅ¼e zadania          â€œnapisz blogaâ€ (jedno zadanie)        realizujÄ™ zadania, ktÃ³rych nie warto robiÄ‡ teraz.Gdzie szukaÄ‡ informacji?Przede wszystkim: Google. Temat nie jest nowy, jest bardzo czÄ™sto opisywany. PamiÄ™tajmy jednak, aby wykorzystaÄ‡ opisy aby dostosowaÄ‡ mechanizm do wÅ‚asnych potrzeb. WidziaÅ‚em juÅ¼ (nie tylko u siebie) prÃ³by bezkrytycznego wdroÅ¼enia metodyki (np. GTD) koÅ„czÄ…ce siÄ™ totalnÄ… klapÄ… z uwagi na drobnostki. MoÅ¼na wybraÄ‡ sobie tylko te elementy, ktÃ³re nam pomagajÄ….PozostaÅ‚e ÅºrÃ³dÅ‚a informacji:  Youtube          Carl Pullein      Keep Productive      Doist        strona Todoist i blog firmy ktÃ³ra go napisaÅ‚a  Twitter          @todoist      @carlpullein      #productivity.      ",
"url": "/2020/01/19/zarzadzanie-zadaniami.html",
"author": "MichaÅ‚ Stolarski",
"authorUrl": "/authors/mstolarski.html",
"image": "mstolarski.jpg",
"highlight": "/assets/img/posts/2020-01-19-zarzadzanie-zadaniami/zarzadzanie_zadaniami.jpg",
"date": "19-01-2020",
"path": "pl/2020-01-19-zarzadzanie-zadaniami"
}
,


"2020-01-09-same-site-lax-by-default-html": {
"title": "SameSite=Lax by default coraz bliÅ¼ej - czy jesteÅ› gotowy?",
"lang": "pl",
"tags": "cookies security same-site",
"content": "Same site cookies (First-Part-Only) to stworzony kilka lat temu mechanizm, ktÃ³ry pozwala na zmniejszenie ryzyka atakÃ³w typu CSRF.Zapewnia on, Å¼e dane ciasteczko moÅ¼e byÄ‡ wysyÅ‚ane wyÅ‚Ä…cznie z Å¼Ä…daniami zainicjowanymi z domeny, dla ktÃ³rej zostaÅ‚o zarejestrowane. DokÅ‚adniejszy opis znajdziesz pod tym adresem: https://web.dev/samesite-cookies-explained/.Skoro atrybut SameSite istnieje tak dÅ‚ugo dlaczego nagle staÅ‚ siÄ™ dla mnie waÅ¼ny?W maju 2019 twÃ³rcy przegladarki Chrome zapowiedzieli, Å¼e od wersji 80 (planowana wersja wydania to 4 lutego 2020) dla wszystkich ciasteczek, ktÃ³re nie majÄ… zdefiniowanego atrybutu SameSite domyÅ›lnie zostanie przyjÄ™ta wartoÅ›Ä‡ Lax. Mozilla i Microsoft rÃ³wnieÅ¼ wyraziÅ‚y chÄ™Ä‡ wprowadzenia tej zmiany we wÅ‚asnych przeglÄ…darkach, wiÄ™c moÅ¼emy siÄ™ spodziewaÄ‡, Å¼e w nieodlegÅ‚ej przyszÅ‚oÅ›ci takie zachowanie zostanie rÃ³wnieÅ¼ zaimplementowane w Firefoxie i Edgeâ€™u.W praktyce oznacza to, Å¼e ciasteczka ktÃ³re nie bÄ™dÄ… miaÅ‚y jawnie zdefiniowanego atrybutu SameSite nie bÄ™dÄ… wysyÅ‚ane przy prÃ³bach Å¼Ä…daÅ„ typu cross-site. WyjÄ…tkiem od tej zasady bÄ™dzie przypadek gdy uÅ¼yjemy bezpiecznej metody HTTP (GET, HEAD, OPTIONS, TRACE) a wykonanie Å¼Ä…dania bÄ™dzie skutkowaÅ‚o tzw. top-level navigation (zmiana adresu w pasku przeglÄ…darki).Jak sprawdziÄ‡ czy ta zmiana dotyczy mnie?Jednym z najprostszych sposobÃ³w jest zajrzenie do narzÄ™dzi developerskich przeglÄ…darki. Od wersji 77 przeglÄ…darka Chrome, w przypadku problematycznych Å¼Ä…daÅ„, wyÅ›wietla w konsoli ostrzeÅ¼enie o nastÄ™pujÄ…cej treÅ›ci (jeÅ¼eli zauwaÅ¼yÅ‚eÅ› takie ostrzeÅ¼enie w swoim systemie, bÄ™dziesz musiaÅ‚ podjÄ…Ä‡ jakÄ…Å› akcjÄ™):A cookie associated with a cross-site resource at (cookie domain) was set without the SameSite attribute. A future release of Chrome will only deliver cookies with cross-site requests if they are set with SameSite=None and Secure. You can review cookies in developer tools under Application&amp;gt;Storage&amp;gt;Cookies and see more details at https://www.chromestatus.com/feature/5088147346030592 and https://www.chromestatus.com/feature/5633521622188032Dodatkowo, przegladarki Chrome oraz Firefox umoÅ¼liwiajÄ… rÄ™czne wÅ‚Ä…czenie opisywanego wyÅ¼ej zachowania. W Chromeâ€™ie naleÅ¼y ustawiÄ‡ wartoÅ›Ä‡ Enabled nastÄ™pujacym flagom: SameSite by default cookies (chrome://flags/#same-site-by-default-cookies) oraz Cookies without SameSite must be secure (chrome://flags/#cookies-without-same-site-must-be-secure)W Firefoxie wÅ‚Ä…czymy funkcjonalnoÅ›Ä‡ wchodzÄ…c na adres about:config i ustawiajÄ…c flagi network.cookie.sameSite.laxByDefault oraz network.cookie.sameSite.noneRequiresSecure na wartoÅ›Ä‡ true.WeryfikujÄ…c swoje systemy warto zwrÃ³ciÄ‡ uwagÄ™ na nastÄ™pujÄ…ce elementy:  treÅ›ci umieszczone w tagu &amp;lt;iframe&amp;gt; (w taki sposÃ³b czesto zapewniana jest integracja z systemami zapewniajacymi mapy, video, kontrolki do pÅ‚atnoÅ›ci, kalendarze itp),  zewnÄ™trzne zasoby uÅ¼ywane w naszym systemie (np: obrazki, zewnÄ™trzne skrypty czy arkusze styli),  wszelkie wejÅ›cia do twojego systemu (np: przekierowania z innych stron, publiczne usÅ‚ugi, formularze, ktÃ³re mogÄ… byÄ‡ wysyÅ‚ane z innych systemÃ³w),  skoki do innych systemÃ³w (np: formularze pÅ‚atnoÅ›ci),  wszelkie elementy wykorzystujÄ…ce SSO (single sign-on).Jak siÄ™ przygotowaÄ‡?Niestety nie istnieje jeden prosty sposÃ³b, ktÃ³ry rozwiÄ…Å¼e wszystkie problemy. Jednak twÃ³rcy implementacji atrybutu SameSite przewidzieli ewentualne problemyw istniejÄ…cych systemach i dodali moÅ¼liwoÅ›Ä‡ ustawienia mu wartoÅ›ci None. Takie ciasteczko bÄ™dzie dziaÅ‚aÅ‚o niemalÅ¼e identycznie jak te przed opisywanymi zmianami -jedynÄ… rÃ³Å¼nicÄ… jest koniecznoÅ›Ä‡ zastosowania atrybutu Secure (w przeciwnym razie ciasteczko bedzie zawsze ignorowana przy Å¼adaniach typu cross-site). NaleÅ¼y jednak pamiÄ™taÄ‡, Å¼e domyÅ›lne ustawienie SameSite=Lax zostaÅ‚o wprowadzone ze wzglÄ™dÃ³w bezpieczeÅ„stwa i ustawiajac wartoÅ›Ä‡ atrybutu na None naraÅ¼amy siÄ™ na potencjalne ataki, wiÄ™c tamgdzie jest to moÅ¼liwe powinniÅ›my unikaÄ‡ tego rozwiÄ…zania. Dodatkowo, wartoÅ›Ä‡ ta nie jest prawidÅ‚owo obsÅ‚ugiwana przez czÄ™Å›Ä‡ przegladarek co moÅ¼e byÄ‡ problemem w niektÃ³rych systemach.O czÄ™Å›ci usecaseâ€™Ã³w oraz rozwiÄ…zaÅ„ moÅ¼esz poczytaÄ‡ tutaj: https://web.dev/samesite-cookie-recipes/.Przydatne linki  https://blog.chromium.org/2019/05/improving-privacy-and-security-on-web.html  https://blog.chromium.org/2019/10/developers-get-ready-for-new.html  https://www.chromium.org/updates/same-site  https://web.dev/samesite-cookies-explained/  https://web.dev/samesite-cookie-recipes/  https://tools.ietf.org/html/draft-west-first-party-cookies-07  https://www.chromestatus.com/feature/5088147346030592  https://www.chromestatus.com/feature/5633521622188032",
"url": "/2020/01/09/same-site-lax-by-default.html",
"author": "Mateusz Pogorzelski",
"authorUrl": "/authors/mpogorzelski.html",
"image": "mpogorzelski.jpg",
"highlight": "/assets/img/posts/2020-01-09-same-site-lax-by-default/samesite.jpg",
"date": "09-01-2020",
"path": "pl/2020-01-09-same-site-lax-by-default"
}
,


"2020-01-09-rxjs-introduction-html": {
"title": "RxJS with Angular - reactive programming of a front-end application",
"lang": "en",
"tags": "Angular rxjs asynchronous reactive reactive extensions rxjs operators",
"content": "When writing  applications using Angular you eventually come into contact with Observables. You have surely dealt with them if you have used the HttpClient service to download data from a server or used EventEmitter for the communication between parent-child components. But have you ever wondered what exactly an object of this type is and why you have to subscribe to it to obtain data? Or maybe you know that already but want to find out how to use the RxJS library to its full potential?If this is the case, then this article is for you.What is RxJS?Reactive Extensions for JavaScript (RxJS) is a library that simplifies reactive programming in JavaScript. In this text I will try to demonstrate how the library and the components that it provides make creating asynchronous programs intuitive and straightforward.Data streamLetâ€™s start with the basics. According to its definition, a data stream is a sequence of data available within a given period, which you can observe or download objects and data from. Data can appear at any point during its lifespan, and you are notified about it with a callback, that is, a reverse function called by the stream. There are two types of streams: cold and hot.Cold streamA cold stream will not be emitting data until it is observed. It will emit a separate value for every new observer, and these values will not be shared, for example: sending a GET request to the server.this.httpClient.get&amp;lt;ServerResponse&amp;gt;(&#39;someUrl&#39;)Hot streamUnlike a cold stream, a hot stream emits data irrespective of whether it is being listened to or not. All observers work on a shared set of data - two observers will receive the same value at the time of it being emitted by the stream. A click event is an example of such a scenario:import {fromEvent} from &#39;rxjs&#39;; fromEvent(document, &#39;click&#39;)Observable, observer patternNow, having defined a stream and distinguished its types, letâ€™s describe a basic RxJS concept: an observable. An observable is an object that represents a data stream. It implements the observer design pattern which assumes the existence of an entity that stores the list of objects - observers listening for any changes of state of this entity. It also informs all observers about a change by calling functions that they have passed (callback).A simple observable can be created with the static of function.// Observable emitting numerical values from 1 to 5const numbers$: Observable&amp;lt;number&amp;gt; = of(1,2,3,4,5);Object numbers$ is the definition of the number-type of data stream. This is only a stream pattern. In this case a cold stream has been created. We know what the data set is (1, 2, 3, 4, 5), however data will be emitted only when an observer starts listening to a given data stream. To â€˜connectâ€™ to the stream, the subscribe() function should be used.subscribe() and unsubscribe()As a parameter, the subscribe function expects an object that defines three functions: next, error and complete.const subscription = numbers$.subscribe({    next(value) {},    error(err) {},    complete() {}});Each of these functions is a callback that is called at given moments of data flowing through the stream. The next(value) function is called every time the stream emits a single value, which in this case means that the next() function will be called 5 times, 1 time for every digit from 1 to 5. The error(err) callback will be called when the stream is unnaturally closed or disrupted. Complete is the last callback that is called once the stream has been closed.Calling the subscribe() function adds you to the list of observers of a given stream.When subscribing as an observer to a given observable, you are given a subscription-type  object on which you can call the unsubscribe() method to remove yourself from the list of observers.Unsubscribing is crucial in the case of hot streams, as they are mostly infinite, meaning they emit the value for a potentially infinite amount of time. If you forget to unsubscribe from the list of observers of a such a stream, the reference to the observer youâ€™ve created will exist throughout the whole lifecycle of the application, creating an infinite hole in the memory, which in extreme cases might lead to the death of the tab that the application is running in.Subject - creating your own streamsRxJS enables you to create your own streams and to do so you can use a subject-type object. Such a stream is potentially infinite, emitting new values at what you consider important points of the application. A subject is created in the same way as other objects:const subject$ = new Subject&amp;lt;number&amp;gt;();Now you can subscribe to the stream as an observer:subject$.asObservable()    .subscribe((value) =&amp;gt; console.log(&#39;value from subject$: &#39;, value))The subject$ variable now provides you with the next(value: number) method, which allows you to send out a new numeric value to all observers, like this:subject$.next(5);// value from subject$: 5The stream youâ€™ve just created is infinite, so you need to remember to unsubscribe once you finish listening to it. You can also close the stream with the complete() command.In this example, a numerical value â€˜5â€™ was emitted and received by a single observer. If no observers exist at the time of emitting a new value, it is lost. However, if this value is important to you and you donâ€™t want to lose, you can use specific subject-type extending objects.ReplaySubjectReplaySubject is a stream which replays a defined value of the last emitted data for every new observer. The value can be passed in the constructor in this way:const replaySubject$ = new ReplaySubject&amp;lt;number&amp;gt;(5);If some values have been emitted by this stream before, a maximum of 5 most recent ones will be generated to a given observer. For example:replaySubject$.next(1);replaySubject$.next(2);replaySubject$.next(3);replaySubject$.next(4);replaySubject$.next(5);replaySubject$.next(6);replaySubject$.asObservable()    .subscribe(replayedValue =&amp;gt; console.log(replayedValue));// 2// 3// 4// 5// 6BehaviorSubjectBehaviorSubject is a unique type of stream. It always has a value because it is necessary for creating a given object. Also, this stream always keeps the last emitted value and, similarly to ReplaySubject, replays it to every new observer. It is created just as easily:const behaviorSubject = new BehaviorSubject&amp;lt;boolean&amp;gt;(true);behaviorSubject.asObservable().subscribe(value =&amp;gt; console.log(value))// truebehaviorSubject.next(false);behaviorSubject.asObservable().subscribe(value =&amp;gt; console.log(&quot;secondobserver: &quot;, value))// false// second observer: falseNow, every new observer will receive the value - logical value â€˜trueâ€™ -  that is currently being stored by the stream.AsyncSubjectAsyncSubject is a unique kind of stream because it emits the last value passed in the next() function only after closing the stream, that is, after calling the complete() function on it. After closing, it stores the emitted value and emits it to each new observer that failed to subscribe before the stream closed.const asyncSubject = new AsyncSubject&amp;lt;number&amp;gt;();asyncSubject.asObservable().subscribe(value =&amp;gt; console.log(&quot;value from async subject: &quot;, value))asyncSubject.next(1);asyncSubject.next(2);asyncSubject.complete();// value from async subject: 2asyncSubject.asObservable().subscribe(value =&amp;gt; console.log(&quot;value from async subject after closing stream: &quot;, value))// value from async subject after closing stream: 2RxJS operators - operations on the streamIâ€™ve demonstrated a few ways of creating streams but you might also want to modify the emitted data to fit a particular business case. RxJS features a wide range of operators, that is, functions performing operations on the stream which can be used to modify the data. Below I will present a few of them that I consider very useful in everydayâ€™s work.Letâ€™s assume you are working on the following stream:const stream$ = new BehaviorSubject&amp;lt;number&amp;gt;(15_000);const observable$ = stream$.asObservable();By default the stream emits a numerical value â€˜15000â€™. You can perform operations on the data generated by the stream by passing the necessary operators as arguments of the pipe() function called on observable$.mapYou are probably familiar with the map operator, e.g., from API JS Arrays.map, which RxJS was based on. Map transforms data, returning a new result for every emitted piece of data. For example:observable$.pipe(map(number =&amp;gt; number*2))    .subscribe(value =&amp;gt; console.log(&#39;mapped value: &#39;, value))// mapped value: 30000firstFirst is an interesting operator that downloads the first element from the stream, and then - as a side effect - it unsubscribes the observer from the streamâ€™s observers list. This is very convenient when you need only one value from a given hot stream, as you donâ€™t have to call the unsubscribe() function. For example:observable$.pipe(first())    .subscribe(value =&amp;gt; console.log(&#39;first received value: &#39;, value))// first received value: 15000stream$.next(25000);// donâ€™t worry, observable$ has unsubscribed from the observers listwithLatestFromAnother noteworthy operator is withLatestForm, which enables you to â€˜cross streamsâ€™, that is, to add the last emitted value of one stream to another stream. For instance:const otherStream$ = new BehaviourSubject&amp;lt;boolean&amp;gt;(true);observable$.pipe(withLatestFrom(otherStream$))    .subscribe(([value, otherStreamValue]) =&amp;gt; console.log(&#39;value received from first stream: {}, from other stream: {}&#39;, value, otherStreamValue))// value received from first stream: 15000, from other stream: truetakeUntiltakeUntil is an operator that comes in handy when you want to unsubscribe from a given streamâ€™s observers list in a clear and simple way. Letâ€™s have a look at the code:@Component({  selector: &#39;app-some-component&#39;,  template: `        some template  `,  styleUrls: [&#39;some-styles.scss&#39;]})export class SomeComponent implements OnDestroy, OnInit {    private destroySubject$ = new Subject&amp;lt;void&amp;gt;();    private someValues$ = new BehaviourSubject&amp;lt;string&amp;gt;(&#39;initial value&#39;);        ngOnInit(): void {       this.someValues$.asObservable().pipe(takeUnitl(this.destroySubject$))            .subscribe(value =&amp;gt; ...)    }    ngOnDestroy(): void {       this.destroySubject.next();    }   }The above snippet contains SomeComponent, which listens to the values from the someValues$ stream until the other stream emits value destroySubject$. This way you donâ€™t need to remember about manually unsubscribing from the first stream because it will automatically close when the component is killed by Angular.switchMapAnother operator that you might find useful is switchMap(). It can be used to maintain clarity and prevent the so-called callback hell, which is a chain of nested subscribe() calls that are hard to read and maintain.observable$.subscribe(    value =&amp;gt; someService.processValue(value)        .subscribe(someServiceResponse =&amp;gt; andYetAnotherService.processAnotherValue(someServiceResponse)                .subscribe(yetAnotherResponse =&amp;gt; veryImportantService.processVeryImportantValue(yetAnotherResponse)                    .subscribe(veryImportantResponse =&amp;gt; ...))))In this case each service returns an observable to the stream from which you need a value to call another service. Instead, you can write:observable$.pipe(    switchMap(value =&amp;gt; someService.processValue(value)),    switchMap(someServiceResponse =&amp;gt; andYetAnotherService.processAnotherValue(someServiceResponse)),    switchMap(yetAnotherResponse =&amp;gt; veryImportantService.processVeryImportantValue(yetAnotherResponse)))        .subscribe(veryImportantResponse =&amp;gt; ...)SwitchMap automatically subscribes you to the next stream, which makes the code clearer. Naturally, nesting streams introduces load that may prevent you from quickly figuring out what the code does, but it is still a more elegant approach.More operatorsTo learn how to use other operators available in the RxJS library, I recommend visiting learnrxjs.SummaryRxJS is a powerful tool that gives you multiple options of writing code that will be reactive, asynchronous and intuitive for your fellow developers. I hope you will continue your journey with reactive programming and will find this article helpful in creating asynchronous code that will make you proud.",
"url": "/2020/01/09/rxjs-introduction.html",
"author": "Konrad Gabara",
"authorUrl": "/authors/kgabara.html",
"image": "kgabara.jpg",
"highlight": "/assets/img/posts/2020-01-09-rxjs-wstep/RxJS.png",
"date": "09-01-2020",
"path": "en/2020-01-09-rxjs-introduction"
}
,


"2019-12-19-testowanie-frontendu-asynchronicznego-html": {
"title": "Testowanie frontendu - Cz. 4 Testy jednostkowe kodu dziaÅ‚ajÄ…cego asynchronicznie",
"lang": "pl",
"tags": "Jasmine Angular async unit testing unit test komponent",
"content": "KoÅ„czÄ…c seriÄ™ dotyczÄ…cÄ… testowania komponentÃ³w Angularowych przy pomocy Jasmine, chciaÅ‚bym poruszyÄ‡ temat testÃ³w kodu wykonywanego asynchronicznie.Testy jednostkowe asynchronicznych aplikacji frontendowych czÄ™sto wydajÄ… siÄ™ byÄ‡ zagadkÄ… dla developerÃ³w. Na szczÄ™Å›cie twÃ³rcy narzÄ™dzi pomyÅ›leli rÃ³wnieÅ¼ o tym i dostarczyli nam narzÄ™dzia, ktÃ³re zdecydowanie uÅ‚atwiajÄ… pracÄ™Â z testowaniem takiego kodu.W tym wpisie jednak nie poruszÄ™ kwestii testowania opartego na mockowaniu/stubowaniu kodu. JeÅ›li jesteÅ› zainteresowany tym tematem, zachÄ™cam do zajrzenia do artykuÅ‚u Krzysztofa Czechowskiego o testowaniu serwisÃ³w.Kod poddany testomW celu sprawdzenia moÅ¼liwoÅ›ci testowania asynchronicznych wywoÅ‚aÅ„ weÅºmy na warsztat przykÅ‚adowy komponent:@Component({  selector: &#39;app-company&#39;,  template: &#39;&amp;lt;div *ngIf=&quot;messageVisible&quot; id=&quot;welcomeMessage&quot;&amp;gt;Hello!&amp;lt;/div&amp;gt;&#39;,})export class CompanyComponent {  messageVisible: boolean = false;  getCompany(): Promise&amp;lt;string&amp;gt; {    return Promise.resolve(&quot;company&quot;);  }  showMessage() {    setTimeout(() =&amp;gt; {      this.messageVisible = true;    }, 2000)  }}Posiada on dwie metody: jednÄ…, ktÃ³ra zwraca Promise z nazwÄ… firmy oraz drugÄ…, ktÃ³ra wykonuje zmianÄ™ widocznoÅ›ci flagi po dwÃ³ch sekundach. Na podstawie tej flagi wyÅ›wietlana jest wiadomoÅ›Ä‡ w templacie HTML.Klasa testowa, do ktÃ³rej bÄ™dÄ… dodawane test-caseâ€™y. W tym przypadku jest ona w 100% standardowa:describe(&#39;AppComponent&#39;, () =&amp;gt; {  let fixture: ComponentFixture&amp;lt;AppComponent&amp;gt;;  let debugElement: DebugElement;  beforeEach(async(() =&amp;gt; {    TestBed.configureTestingModule({      declarations: [        AppComponent      ],    }).compileComponents();      fixture = TestBed.createComponent(AppComponent);      debugElement = fixture.debugElement;  })); });Testowanie metod zwracajÄ…cych PromisyJeÅ›li chcemy przetestowaÄ‡Â metodÄ™, ktÃ³ra zwraca wartoÅ›Ä‡Â opakowanÄ… w Promise, oraz ktÃ³rej wynik nie jest zaleÅ¼ny od dostÄ™pnoÅ›ci zewnÄ™trznych usÅ‚ug, moÅ¼emy w Å‚atwy sposÃ³b sprawdziÄ‡ zwracane przez nie wartoÅ›ci przy pomocy mechanizmu async/await:it(&#39;resolves company using async/await&#39;, async function () {    const company = await fixture.componentInstance.getCompany();    expect(company).toEqual(&quot;company&quot;);});JeÅ›li z jakiegoÅ› powodu nie moÅ¼esz wykorzystaÄ‡ async/await, to wÃ³wczas zastosowanie znajdzie tradycyjne rozwiÄ…zywanie PromisÃ³w:it(&#39;resolves company promise manually&#39;, function () {    fixture.componentInstance.getCompany().then(company =&amp;gt; {        expect(company).toEqual(&quot;company&quot;);    });});Oczekiwanie na wykonanie metody przy uÅ¼yciu fakeAsyncMetoda showMessage() z naszego komponentu ma narzucony czas dwÃ³ch sekund oczekiwania przed jej wykonaniem.W teÅ›cie moÅ¼emy powtÃ³rzyÄ‡ ten zabieg i po wywoÅ‚aniu metody uruchomiÄ‡Â asercje wewnÄ…trz setTimeout(). Jednak wprowadzanie realnego czasu oczekiwania nie jest efektywnym rozwiÄ…zaniem i bardzo spowolni nasze testy. DziÄ™ki Angularowemu fakeAsync moÅ¼emy testowaÄ‡ kod asynchroniczny, w synchroniczny sposÃ³b.Zobaczmy:it(&quot;tests the message visibility&quot;, fakeAsync(() =&amp;gt; {  fixture.componentInstance.showMessage();  tick(2000);  fixture.detectChanges();  fixture.whenStable().then(() =&amp;gt; {    const helloMessage = fixture.debugElement.query(By.css(&quot;#welcomeMessage&quot;));    expect(helloMessage).toBeTruthy();    expect(helloMessage.nativeElement.innerHTML).toBe(&#39;Hello!&#39;);  })}));SpoglÄ…dajÄ…c od gÃ³ry:  najpierw opakowujemy nasz test jednostkowy w blok fakeAsync(), ktÃ³ry pozwala nam oszukaÄ‡ asynchroniczny przepÅ‚yw,  wywoÅ‚ujemy asynchronicznÄ… metodÄ™,  symulujemy upÅ‚yw czasu - w rzeczywistoÅ›ci nie trwa to dwÃ³ch sekund, jednak aplikacja â€œmyÅ›liâ€, Å¼e tyle upÅ‚ynÄ™Å‚o,  wykrywamy zmiany, a kiedy detekcja zmian siÄ™ zakoÅ„czy, robimy tradycyjne asercje.A co jeÅ›li nie znamy czasu, ktÃ³ry powinien upÅ‚ynÄ…Ä‡ zanim wykonamy asercje? W miejscu tick(2000), moÅ¼emy wykorzystaÄ‡ flush() i efekt bÄ™dzie dokÅ‚adnie taki sam. Czym siÄ™ charakteryzuje flush()? Podobnie jak tick, symuluje on upÅ‚yw czasu, jednak robi do momentu opustoszenia kolejki macrotaskÃ³w (czyli m.in. setTimeout, setInterval).Testowanie kodu asynchronicznego - podsumowanieDziÄ™ki uzbrojeniu JavaScriptu w wygodne mechanizmy oraz uÅ‚atwieniom ze strony Angulara, testowanie jednostkowe kodu dziaÅ‚ajÄ…cego asynchronicznie staje siÄ™ nawet nie tyle proste, co caÅ‚kiem przyjemne.",
"url": "/2019/12/19/testowanie-frontendu-asynchronicznego.html",
"author": "Adrian MarszaÅ‚ek",
"authorUrl": "/authors/amarszalek.html",
"image": "amarszalek.jpg",
"highlight": "/assets/img/posts/2019-12-20-testowanie-frontendu-asynchronicznego/testowanie-frontendu-asynch.jpg",
"date": "19-12-2019",
"path": "pl/2019-12-20-testowanie-frontendu-asynchronicznego"
}
,


"2019-12-04-testowanie-komponentow-z-inputami-i-outputami-html": {
"title": "Testowanie frontendu - Cz. 3. Testowanie komponentÃ³w angularowych z inputami i outputami",
"lang": "pl",
"tags": "Jasmine Angular unit test komponent",
"content": "Czas na kolejnÄ… dawkÄ™ informacji dotyczÄ…cych testowania przy uÅ¼yciu Jasmine. Po przeczytaniu wczeÅ›niejszych wpisÃ³w (Cz. 1 i Cz. 2) pora skupiÄ‡ siÄ™ na testowaniu komponentÃ³w angularowych, a w szczegÃ³lnoÅ›ci ich wejÅ›Ä‡ i wyjÅ›Ä‡. PrzykÅ‚ady oprzemy o aplikacjÄ™, ktÃ³ra bÄ™dzie skÅ‚adaÅ‚a siÄ™ z kilku drobnych wzajemnie siÄ™ ze sobÄ… komunikujÄ…cych elementÃ³w.Schemat przykÅ‚adowej aplikacji wyglÄ…da nastÄ™pujÄ…co:Jest to prosty program majÄ…cy na celu dodawanie i zapisywanie wynikÃ³w. ZostaÅ‚ rozpisany na komponenty tak, aby moÅ¼na byÅ‚o spokojnie przetestowaÄ‡ wejÅ›cia i wyjÅ›cia w rÃ³Å¼nych wariantach.Aplikacja zawiera dwa komponenty przekazujÄ…ce wpisanÄ… liczbÄ™ (CalculatorInputFieldComponent), nastÄ™pnie wysyÅ‚ane sÄ… one do komponentu, ktÃ³ry zliczy nam wynik (CalculatorResultComponent) i zaprezentuje go w czytelnej formie (CalucatorResultPresentationComponent). Z poziomu komponentu prezentujÄ…cego wyniki moÅ¼emy je rÃ³wnieÅ¼ zapisaÄ‡ (CalculatorSavedListComponent). StrzaÅ‚ki na diagramie oznaczajÄ… wejÅ›cia i wyjÅ›cia komponentÃ³w.Pisanie testÃ³w dotyczÄ…cych @InputNa poczÄ…tek weÅºmy na warsztat komponent pozwalajÄ…cy wyÅ›wietliÄ‡ listÄ™ wynikÃ³w, ktÃ³re chcielibyÅ›my zapisaÄ‡.@Component({  selector: &#39;calculator-saved-list&#39;,  template: `      &amp;lt;div class=&quot;result&quot;&amp;gt;{{getText()}}{{savedValues}}&amp;lt;/div&amp;gt;  `,})export class CalculatorSavedListComponent {  @Input() savedValues: Array&amp;lt;number&amp;gt;;  getText(): string {    if (this.savedValues.length === 0) {      return &#39;Brak zapisanych wartoÅ›ci&#39;;    } else {      return &#39;Zapisane wartoÅ›ci to: &#39;;    }  }}Trudno sobie wyobraziÄ‡ prostszy komponent. Mamy tutaj jeden input, przekazujÄ…cy listÄ™ wynikÃ³w, ktÃ³rÄ… chcemy wyÅ›wietliÄ‡.Pora na napisanie testu sprawdzajÄ…cego, czy komponent poprawnie interpretuje przekazane mu wynikidescribe(&#39;CalculatorSavedListComponent&#39;, () =&amp;gt; {  let component: CalculatorSavedListComponent;  let fixture: ComponentFixture&amp;lt;CalculatorSavedListComponent&amp;gt;;  let resultText: DebugElement;  beforeEach(async(() =&amp;gt; {    TestBed.configureTestingModule({      declarations: [CalculatorSavedListComponent]    }).compileComponents();    fixture = TestBed.createComponent(CalculatorSavedListComponent);    component = fixture.componentInstance;    resultText = fixture.debugElement.query(By.css(&#39;.result&#39;));  }));  it(&#39;should show correct text when list is empty&#39;, () =&amp;gt; {    component.savedValues = [];    fixture.detectChanges();    expect(resultText.childNodes[0].nativeNode.wholeText).toEqual(&#39;Brak zapisanych wartoÅ›ci&#39;);  });  it(&#39;should show elements of list with correct text&#39;, () =&amp;gt; {    component.savedValues = [12, 3];    fixture.detectChanges();    expect(resultText.childNodes[0].nativeNode.wholeText).toEqual(&#39;Zapisane wartoÅ›ci to: 12,3&#39;);  });});ZaczÄ™liÅ›my tutaj, podobnie jak w poprzednim artykule, od stworzenia TestBed i dodatkowo wyciÄ…gnÄ™liÅ›my za pomocÄ… zapytania element html prezentujÄ…cy tekst umieszczony z poziomu komponentu. MoÅ¼emy siÄ™ do niego odwoÅ‚aÄ‡ na wiele sposobÃ³w, na przykÅ‚ad za pomocÄ… klasy lub id.Dysponujemy tutaj dwoma testami o identycznej strukturze. Przekazujemy wartoÅ›ci w inpucie i sprawdzamy, czy element umieszczony w html zostaÅ‚ poprawnie zmieniony. JeÅ¼eli inputÃ³w w komponencie mamy wiÄ™cej, moÅ¼emy je przetestowaÄ‡ dokÅ‚adnie w ten sam sposÃ³b.Pisanie testÃ³w dotyczÄ…cych @OutputNastÄ™pnie napiszmy test do komponentu pozwalajÄ…cego wpisaÄ‡ liczbÄ™, ktÃ³rÄ… przekazuje do komponentu nadrzÄ™dnego.@Component({  selector: &#39;calculator-input-field&#39;,  template: `      &amp;lt;input (keyup)=&quot;onKey($event)&quot;&amp;gt;  `,})export class CalculatorInputFieldComponent {  @Output() fieldValue = new EventEmitter&amp;lt;number&amp;gt;();  onKey(event) {    this.fieldValue.emit(event.target.value);  }}Komponent rÃ³wnie prosty jak poprzedni z takim wyjÄ…tkiem, Å¼e mamy tutaj do czynienia z outputem.describe(&#39;CalculatorInputFieldComponent&#39;, () =&amp;gt; {  let component: CalculatorInputFieldComponent;  let fixture: ComponentFixture&amp;lt;CalculatorInputFieldComponent&amp;gt;;  let input: DebugElement;  beforeEach(async(() =&amp;gt; {    TestBed.configureTestingModule({      declarations: [CalculatorInputFieldComponent]    }).compileComponents();    fixture = TestBed.createComponent(CalculatorInputFieldComponent);    component = fixture.componentInstance;    input = fixture.debugElement.query(By.css(&#39;input&#39;));  }));  it(&#39;should emit correct value on input change&#39;, () =&amp;gt; {    component.fieldValue.subscribe((value) =&amp;gt; expect(value).toBe(&#39;7&#39;));    input.nativeElement.value = 7;    document.querySelector(&#39;input&#39;).dispatchEvent(new KeyboardEvent(&#39;keyup&#39;));  });});Czyli standardowo, zaczynamy od przygotowania moduÅ‚u testowego i uchwycenia elementu, ktÃ³ry chcemy przetestowaÄ‡. Warto tutaj zaznaczyÄ‡, Å¼e istniejÄ… inne sposoby na zainicjalizowanie komponentu niÅ¼ TestBed, wszystko zaleÅ¼y od tego co, i w jaki sposÃ³b, bÄ™dziemy testowaÄ‡. Na przykÅ‚ad kiedy nie potrzebujemy testowaÄ‡ elementÃ³w z DOM moÅ¼emy zostaÄ‡ przy zwykÅ‚ym inicjalizowaniu komponentÃ³w. WiÄ™cej szczegÃ³Å‚Ã³w moÅ¼na znaleÅºÄ‡Â w dokumentacji Angulara.Test zaczynamy od nasÅ‚uchiwania na zmiennÄ… fieldValue po ktÃ³rej spodziewamy siÄ™, Å¼e przekaÅ¼e nam wartoÅ›Ä‡ wpisanÄ… w pole. NastÄ™pnie uzupeÅ‚niamy wartoÅ›Ä‡ i aktywujemy event, pozwalajÄ…cy wywoÅ‚aÄ‡ metodÄ™ nasÅ‚uchujÄ…cÄ… na zmiany w polu. Test zakoÅ„czy siÄ™, kiedy zostanie wywoÅ‚ana metoda expect sprawdzajÄ…ca, czy wpisana przez nas wartoÅ›Ä‡ zgadza siÄ™ z oczekiwaniami. Test moÅ¼e siÄ™ rÃ³wnieÅ¼ zakoÅ„czyÄ‡ niepowodzeniem, kiedy po upÅ‚ywie danego czasu (domyÅ›lna konfiguracja wskazuje na 5s) Å¼aden expect nie zostanie wywoÅ‚any.Na koniec moÅ¼emy zebraÄ‡ wiedzÄ™ i przetestowaÄ‡ komponent zawierajÄ…cy wejÅ›cia, jak i wyjÅ›cia. PoniÅ¼szy kod przedstawia komponent, ktÃ³ry dodaje wskazane liczby oraz opcjonalnie potrafi wysÅ‚aÄ‡ dane o wyniku do komponentu â€˜wyÅ¼ejâ€™.@Component({  selector: &#39;calculator-result&#39;,  template: `      &amp;lt;calculator-result-presentation [calculationResult]=&quot;getCalculationResult()&quot;&amp;gt;&amp;lt;/calculator-result-presentation&amp;gt;      &amp;lt;button (click)=&quot;saveValue()&quot;&amp;gt;Zapisz wartoÅ›Ä‡&amp;lt;/button&amp;gt;  `,})export class CalculatorResultComponent {  @Input() values: Array&amp;lt;number&amp;gt;;  @Input() text: string;  @Output() savedValue = new EventEmitter&amp;lt;number&amp;gt;();  getResult(): number {    return Number(this.values[0]) + Number(this.values[1]);  }  getCalculationResult(): string {    return `${this.text} ${this.getResult()}`;  }  saveValue() {    this.savedValue.emit(this.getResult());  }}MoÅ¼emy zauwaÅ¼yÄ‡, Å¼e komponent potrzebuje innego komponentu (calculator-result-presentation), ktÃ³remu przekazuje wynik. W testach nie bÄ™dzie miaÅ‚o to duÅ¼ego znaczenia, naleÅ¼y jednak pamiÄ™taÄ‡ o jego deklaracji przy tworzeniu TestBed.describe(&#39;CalculatorResultComponent&#39;, () =&amp;gt; {  let component: CalculatorResultComponent;  let fixture: ComponentFixture&amp;lt;CalculatorResultComponent&amp;gt;;  let button: DebugElement;  beforeEach(async(() =&amp;gt; {    TestBed.configureTestingModule({      declarations: [        CalculatorResultComponent,        CalculatorResultPresentationComponent      ]    }).compileComponents();    fixture = TestBed.createComponent(CalculatorResultComponent);    component = fixture.componentInstance;    button = fixture.debugElement.query(By.css(&#39;button&#39;));  }));  it(&#39;should emit correct value on button&#39;, () =&amp;gt; {    component.values = [1, 2];    component.savedValue.subscribe((value) =&amp;gt; expect(value).toBe(3));    button.nativeElement.click();  });});PowyÅ¼szy test przekazuje wartoÅ›ci do inputÃ³w oraz naciska przycisk. JeÅ¼eli wszystko dziaÅ‚a poprawnie, po jego naciÅ›niÄ™ciu powinniÅ›my zostaÄ‡ powiadomieni o wyniku dziaÅ‚aniu, ktÃ³ry zostaÅ‚ wyemitowany na output.Testowanie komponentÃ³w angularowych - podsumowanie.PowyÅ¼sze przykÅ‚ady przedstawiajÄ… najprostsze scenariusze testowe. Jest to jednak dobry punkt wyjÅ›cia do napisania wÅ‚asnych testÃ³w komponentÃ³w angularowych, przy ktÃ³rych zaprezentowane rozwiÄ…zania mogÄ… okazaÄ‡ siÄ™ uÅ¼yteczne.",
"url": "/2019/12/04/testowanie-komponentow-z-inputami-i-outputami.html",
"author": "Piotr Grobelny",
"authorUrl": "/authors/pgrobelny.html",
"image": "pgrobelny.webp",
"highlight": "/assets/img/posts/2019-12-05-testowanie-komponentow-z-inputami-i-outputami/frontend-test.jpg",
"date": "04-12-2019",
"path": "pl/2019-12-05-testowanie-komponentow-z-inputami-i-outputami"
}
,


"2019-11-28-templatowanie-jobow-jenkinsa-html": {
"title": "Automat dodajÄ…cy joby do Jenkinsa",
"lang": "pl",
"tags": "jenkins job jenkins template devops jenkins-job-builder jenkins-jobs",
"content": "W ogarniajÄ…cym nas Å›wiecie mikroserwisÃ³w skala projektÃ³w do utrzymania staje siÄ™ ogromna. KaÅ¼dy z tych projektÃ³w musimy przecieÅ¼: zbudowaÄ‡, przetesowaÄ‡, zdeployowaÄ‡ itd. Przy duÅ¼ej liczbie projektÃ³w przestaje to byÄ‡ trywialne. W tym artykule zajmiemy siÄ™ pierwszym zagadnieniem - automatyzacjÄ… buildÃ³w, jednak opisany tutaj sposÃ³b bez problemu moÅ¼na zastosowaÄ‡ do innych aspektÃ³w.Do budowania projektÃ³w starajmy siÄ™ uÅ¼ywaÄ‡ jednego narzÄ™dzia, ogromnie wpÅ‚ynie to na proces unifikacji. W tym artykule bÄ™dziemy posÅ‚ugiwaÄ‡ siÄ™ mavenem.Do zautomatyzowania procesu posÅ‚uÅ¼y nam Jenkins.PrzejdÅºmy do sedna, czyli jak budowaÄ‡ duÅ¼Ä… liczbÄ™ projektÃ³w z jak najmniejszym nakÅ‚adem pracy i iloÅ›ciÄ… kodu do utrzymania.StartujemyPrzy zaÅ‚oÅ¼eniu, Å¼e projekty budujemymvn clean package-/+ jakieÅ› super waÅ¼ne przeÅ‚Ä…czniki typu -DskipTes... ;) jesteÅ›my w stanie w bardzo prosty i schludny sposÃ³b zbudowaÄ‡ kod/konfiguracjÄ™, ktÃ³ra zautomatyzuje caÅ‚y proces.AutomatyzacjÄ™ rozpoczniemy od uÅ¼ycia narzÄ™dzia: jenkins-job-builderInstalacja:pip install --user jenkins-job-buildermacOS:brew install jenkins-job-builderDefiniujemy plik konfiguracyjny dla jenkins-jobs w lokalizacji /etc/jenkins_jobs/jenkins_jobs.ini:[jenkins]query_plugins_info=Falseuser=jenkins #UÅ¼ytkownik Jenkinsowypassword=93a1160c11dc014b7214d4e8769fe8c9url=http://localhost:8080 #Url do jenkinsa  user - UÅ¼ytkownik Jenkinsowy  password - API Token dla swojego uÅ¼ytkownika link  url - Adres URL do JenkinsaTak skonfigurowane narzÄ™dzie pozwoli nam utworzyÄ‡ dowolny job jenkinsowy.UtwÃ³rzmy plik o nazwie project1-build.yaml w katalogu jobs z zawartoÅ›ciÄ…- job:    name: project-1-build    project-type: freestyle    disabled: false    builders:        - shell: &#39;mvn clean package&#39;Zasilenie jenkinsa nowo utworzonym jobem:jenkins-jobs update jobsPo wykonaniu polecenia, utworzony zostanie pierwszy z projektÃ³w jenkinsowych. Good Job!SzablonyUwielbiamy opakowywaÄ‡ wszystko w pewne wzorce, wspÃ³lne procesy, reuÅ¼ywaÄ‡ raz dobrze napisany kod. :) Dlatego ten wÄ…tek bÄ™dziÄ™ esencjÄ… artykuÅ‚u.Wiemy juÅ¼, Å¼e projekty budujemy w bardzo podobny sposÃ³b. Zbudujmy wiÄ™c pierwszy szablon.UtwÃ³rzmy szablon o nazwie project-build-template.yaml w katalogu jobs- job-template:    name: &#39;{name}-{subname}-build&#39;    project-type: freestyle    disabled: false    builders:        - shell: &#39;mvn clean package&#39;Szablon posiada dwie zmiennename : nazwa projektusubname: numer oznaczajacy jeden z koljenych projektÃ³wZwrÃ³Ä‡ uwagÄ™ na wartoÅ›Ä‡ w polu name {name}-{subname}-build jest to pattern, po ktÃ³rym bÄ™dzie szukany szablon.Aby uÅ¼yÄ‡ szablonu tworzymy plik w katalogu jobs o nazwie projects.yaml- project:    name: project    subname:        - 1        - 2        - 3    jobs:        - &#39;{name}-{subname}-build&#39;CaÅ‚oÅ›Ä‡ koÅ„czymy aktualizacjÄ… jobÃ³w: jenkins-jobs update jobsW ten sposÃ³b jednym ruchem wygenerowaliÅ›my 3 joby:project-1-buildproject-2-buildproject-3-buildKaÅ¼dy z nich zawiera definicjÄ™ joba opisanego w szablonie o nazwie {name}-{subname}-build&#39; czyli wywoÅ‚anie mvn clean packagePodsumowanieCel zostaÅ‚ osiÄ…gniÄ™ty! Raz napisana definicja builda zostaÅ‚a uÅ¼yta wiele razy (w naszym przykÅ‚adzie tylko 3 ;) ). ZmniejszyliÅ›my liczbÄ™ zdublowanych konfiguracji, dziÄ™ki czemu jesteÅ›my w stanie lepiej nimi zarzÄ…dzaÄ‡.ByÅ‚ to prosty przykÅ‚ad ukazujÄ…cy istnienie takiego narzÄ™dzia. JeÅ›li chcesz dowiedzieÄ‡ siÄ™ czegoÅ› wiÄ™cej - zostawiam kilka linkÃ³w.DokumentacjaRepozytorium projektu",
"url": "/2019/11/28/templatowanie-jobow-jenkinsa.html",
"author": "Dawid Kubiak",
"authorUrl": "/authors/dkubiak.html",
"image": "dkubiak.webp",
"highlight": "/assets/img/posts/2019-11-28-templatowanie-jobow-jenkinsa/jenkins-job.jpg",
"date": "28-11-2019",
"path": "pl/2019-11-28-templatowanie-jobow-jenkinsa"
}
,


"2019-11-20-testowanie-komponentow-i-serwisow-html": {
"title": "Testowanie frontendu - Cz. 2. Testowanie komponentÃ³w i serwisÃ³w",
"lang": "pl",
"tags": "Jasmine Angular unit test",
"content": "2 tygodnie temu Marcin Mendlik pisaÅ‚ o konfiguracji Karmy i Jasmine w projekcie.DziÅ› bÄ™dzie o tym, jak rozpoczÄ…Ä‡ testy komponentÃ³w i serwisu.Wprowadzenie do testowaniaProjekt dostÄ™pny jest tutaj.Zaczniemy od AnimalsComponent - komponent prezentuje listÄ™ zwierzÄ…t:@Component({  selector: &#39;app-animals&#39;,  templateUrl: &#39;./animals.component.html&#39;,  styleUrls: [&#39;./animals.component.scss&#39;]})export class AnimalsComponent implements OnInit {  animals$: Observable&amp;lt;Animal[]&amp;gt;;  constructor(private animalService: AnimalService) { }  ngOnInit() {    this.animals$ = this.animalService.getAnimals();  }}Na poczÄ…tek sprawdzmy czy komponent zostanie utworzony:describe(&#39;AnimalsComponent&#39;, () =&amp;gt; {  let component: AnimalsComponent;  beforeEach(() =&amp;gt; {    component = new AnimalsComponent(null);  });  it(&#39;should have a component&#39;, () =&amp;gt; {    expect(component).toBeTruthy();  });});Te testy powinny przejÅ›Ä‡ pozytywnie. AnimalComponent potrzebuje AnimalService, ale poniewaÅ¼ z niego nie korzystamy, moÅ¼emy do konstruktora przekazaÄ‡ null. Jednak jeÅ¼eli bÄ™dziemy chcieli sprawdziÄ‡, czy na liÅ›cie sÄ… jakieÅ› zwierzÄ™ta, np.:it(&#39;should have a animals list with 1 animal&#39;, () =&amp;gt; {    component.animals$.subscribe(animals =&amp;gt; {      expect(animals.length).toEqual(1);      expect(animals).toEqual([fakeAnimal]);    });  });Otrzymamy bÅ‚Ä…d: TypeError: Cannot read property &#39;subscribe&#39; of undefinedSubscribe, wywoÅ‚ywany jest na zmiennej animals$, ktÃ³ra inicjowana jest dopiero w metodzie ngOnInit(), wywoÅ‚ajmy wiÄ™c jÄ… na poczÄ…tku naszego nowego testu:it(&#39;should have a animals list with 1 animal&#39;, () =&amp;gt; {    component.ngOnInit();    component.animals$.subscribe(animals =&amp;gt; {      expect(animals.length).toEqual(1);      expect(animals).toEqual([fakeAnimal]);    });  });Tym razem mamy bÅ‚Ä…d: TypeError: Cannot read property &#39;getAnimals&#39; of nullW ngOnInit(), ktÃ³re wywoÅ‚aliÅ›my, jest metoda: animalService.getAnimals(), a do naszego komponentu przekazaliÅ›my nullâ€™a.MoÅ¼emy temu zaradziÄ‡ przekazujÄ…c spreparowany serwis na poczÄ…tku naszego pliku z testami:const fakeAnimal = {id: 1, name: &#39;pies&#39;};let fakeAnimalService;beforeEach(() =&amp;gt; {    fakeAnimalService = {      getAnimals: () =&amp;gt; of([fakeAnimal]),      httpClient: {}    } as any;    component = new AnimalsComponent(fakeAnimalService);  });Taki fakeAnimalService moÅ¼emy przekazaÄ‡ do konstruktora. Pusty obiekt httpClient nam nie przeszkadza - i tak nie chcemy z niego korzystaÄ‡. WykorzystujÄ…ca go funkcja getAnimals() od razu zwrÃ³ci nam wynik nie korzystajÄ…c z httpClientâ€™a. Po tych zmianach caÅ‚a klasa testu wyglÄ…da jak poniÅ¼ej:import {AnimalsComponent} from &#39;./animals.component&#39;;import {of} from &#39;rxjs&#39;;describe(&#39;AnimalsComponent&#39;, () =&amp;gt; {  let component: AnimalsComponent;  const fakeAnimal = {id: 1, name: &#39;pies&#39;};  let fakeAnimalService;  beforeEach(() =&amp;gt; {    fakeAnimalService = {      getAnimals: () =&amp;gt; of([fakeAnimal]),      httpClient: {}    } as any;    component = new AnimalsComponent(fakeAnimalService);  });  it(&#39;should have a component&#39;, () =&amp;gt; {    expect(component).toBeTruthy();  });  it(&#39;should have a animals list&#39;, () =&amp;gt; {    component.ngOnInit();    component.animals$.subscribe(animals =&amp;gt; {      expect(animals.length).toEqual(1);      expect(animals).toEqual([fakeAnimal]);    });  });});Takie testy nie dajÄ… nam jednak odpowiedzi na pytania czy nasz serwis zostaÅ‚ wywoÅ‚any i ile razy.Jest to teÅ¼ cenna informacja gdy nasz serwis robi np. jakieÅ› kosztowne obliczenia.W takiej sytuacji pomoÅ¼e nam funkcja createSpyObj, ktÃ³rÄ… dostarcza nam Jasmine. Do funkcji tej przekaÅ¼emy dwa parametry: nazwÄ™ serwisu i tablicÄ™ nazw metod.fakeAnimalService = jasmine.createSpyObj(&#39;animalService&#39;, [&#39;getAnimals&#39;]);Teraz jeszcze w naszym przypadku testowym musimy ustaliÄ‡ co funkcja getAnimals ma zwracaÄ‡:const spy = fakeAnimalService.getAnimals.and.returnValue(of([fakeAnimal]));Odpowiedzi ktÃ³rych szukaliÅ›my udzieli nam obiekt spy:it(&#39;should call getAnimals 1 time without parameters &#39;, () =&amp;gt; {    const spy = fakeAnimalService.getAnimals.and.returnValue(of([fakeAnimal]));    component.ngOnInit();    component.animals$.subscribe( () =&amp;gt; {      expect(spy).toHaveBeenCalled();      expect(spy).toHaveBeenCalledWith();      expect(spy).toHaveBeenCalledTimes(1);    });  });Istnieje teÅ¼ moÅ¼liwoÅ›Ä‡ skorzystania z prawdziwego serwisu i ustalenia co ma zwrÃ³ciÄ‡ dana metoda.W tym celu dokonamy kilku zmian:  fakeAnimalService = jasmine.createSpyObj(&#39;animalService&#39;, [&#39;getAnimals&#39;]);zmienimy na animalService = new AnimalService(null);  nowy serwis przekarzemy do konstruktora componentu: animalService = new AnimalService(null);  wykorzystamy teÅ¼ metodÄ™ spyOn();const spy = spyOn(animalService, &#39;getAnimals&#39;).and.returnValue(of([fakeAnimal]));CaÅ‚y plik z testami wyglÄ…da nastÄ™pujÄ…co:import {AnimalsComponent} from &#39;./animals.component&#39;;import {of} from &#39;rxjs&#39;;import {AnimalService} from &#39;../animal.service&#39;;describe(&#39;AnimalsComponent&#39;, () =&amp;gt; {  let component: AnimalsComponent;  const fakeAnimal = {id: 1, name: &#39;pies&#39;};  let animalService;  beforeEach(() =&amp;gt; {    animalService = new AnimalService(null);    component = new AnimalsComponent(animalService);  });  it(&#39;should have a component&#39;, () =&amp;gt; {    expect(component).toBeTruthy();  });  it(&#39;should have a animals list&#39;, () =&amp;gt; {    spyOn(animalService, &#39;getAnimals&#39;).and.returnValue(of([fakeAnimal]));    component.ngOnInit();    component.animals$.subscribe(animals =&amp;gt; {      expect(animals.length).toEqual(1);      expect(animals).toEqual([fakeAnimal]);    });  });  it(&#39;should call getAnimals 1 time without parameters &#39;, () =&amp;gt; {    const spy = spyOn(animalService, &#39;getAnimals&#39;).and.returnValue(of([fakeAnimal]));    component.ngOnInit();    component.animals$.subscribe( () =&amp;gt; {      expect(spy).toHaveBeenCalled();      expect(spy).toHaveBeenCalledWith();      expect(spy).toHaveBeenCalledTimes(1);    });  });})Testy z wykorzystaniem TestBedAby pomÃ³c nam w testach Angular dostarcza interfejs TestBed.Na poczÄ…tku, gdy wygenerowaliÅ›my komponent przy pomocy Angular CLI, zawieraÅ‚ on rÃ³wnieÅ¼ testy. Dla komponentu AnimalsComponent wyglÄ…daÅ‚y one tak:import { async, ComponentFixture, TestBed } from &#39;@angular/core/testing&#39;;import { AnimalsComponent } from &#39;./animals.component&#39;;describe(&#39;AnimalsComponent&#39;, () =&amp;gt; {  let component: AnimalsComponent;  let fixture: ComponentFixture&amp;lt;AnimalsComponent&amp;gt;;  beforeEach(async(() =&amp;gt; {    TestBed.configureTestingModule({      declarations: [ AnimalsComponent ]    })    .compileComponents();  }));  beforeEach(() =&amp;gt; {    fixture = TestBed.createComponent(AnimalsComponent);    component = fixture.componentInstance;    fixture.detectChanges();  });  it(&#39;should have a component&#39;, () =&amp;gt; {    expect(component).toBeTruthy();  });});Niestety od poczÄ…tku testy wskazywaÅ‚y bÅ‚Ä™dy.W powyÅ¼szym teÅ›cie TestBed chce nam dostarczyÄ‡ caÅ‚y komponent AnimalsComponent wraz z htmlâ€™em, jednak nie ma wszystkich skÅ‚adowych jak chociaÅ¼by AnimalsListComponent.Musimy poprawiÄ‡ naszÄ… konfiguracjÄ™ tak aby zawieraÅ‚a wszystkie wymagane elementy:describe(&#39;AnimalsComponent&#39;, () =&amp;gt; {  let component: AnimalsComponent;  let fixture: ComponentFixture&amp;lt;AnimalsComponent&amp;gt;;  let animalService: AnimalService;  const fakeAnimal = { id: 1, name: &#39;fake&#39; };  beforeEach(async(() =&amp;gt; {      TestBed.configureTestingModule({        imports: [RouterTestingModule],        declarations: [AnimalsComponent, AnimalsListComponent],        providers: [          AnimalService,          { provide: HttpClient, useValue: {} }]      })        .compileComponents();  }));  beforeEach(() =&amp;gt; {    fixture = TestBed.createComponent(AnimalsComponent);    component = fixture.componentInstance;    animalService = TestBed.get(AnimalService);  });});Ta konfiguracja pozwoli nam juÅ¼ otrzymaÄ‡ przygotowany przez TestBed komponent:it(&#39;should have a component&#39;, () =&amp;gt; {    expect(component).toBeTruthy();  });Jednak test sprawdzajÄ…cy prezentowane zwierzÄ™ta ponownie wykaÅ¼e bÅ‚Ä™dy:  it(`should have a list of animals`, () =&amp;gt; {    component.ngOnInit();    component.animals$.subscribe(animals =&amp;gt; {      expect(animals).toBeTruthy();      expect(animals).toEqual([fakeAnimal]);    });  });AnimalService wywoÅ‚a httpClient.get.W sekcji providers dostarczamy pusty obiekt jako httpClient: { provide: HttpClient, useValue: {} }Jest dobrze, bo nie chcemy Å¼eby nasz test komunikowaÅ‚ siÄ™ z zewnÄ™trznym serwisem.Ponownie wykorzystamy spyOn ktÃ³ry zapewni, Å¼e animalService zwrÃ³ci nam dane do testÃ³w:  it(`should have a list of animals`, () =&amp;gt; {    spyOn(animalService, &#39;getAnimals&#39;).and.returnValue(of([fakeAnimal]));    component.ngOnInit();    component.animals$.subscribe(animals =&amp;gt; {      expect(animals).toBeTruthy();      expect(animals).toEqual([fakeAnimal]);    });  });DziÄ™ki testom z wykorzystaniem TestBed moÅ¼emy przetestowaÄ‡ nasz szablon html:it(`should have a button with text &quot;fake&quot;`, (() =&amp;gt; {    spyOn(animalService, &#39;getAnimals&#39;).and.returnValue(of([fakeAnimal]));    component.ngOnInit();    fixture.detectChanges();    const buttons = fixture.debugElement.queryAll(By.css(&#39;.animal-button&#39;));    expect(buttons[0].nativeElement.textContent).toEqual(&#39;fake&#39;);  }));PoniÅ¼sze dwie linie pozwalajÄ… nam pobraÄ‡ buttony i sprawdziÄ‡, czy sÄ… odpowiednio podpisane.const buttons = fixture.debugElement.queryAll(By.css(&#39;.animal-button&#39;));expect(buttons[0].nativeElement.textContent).toEqual(&#39;fake&#39;);Testy z wykorzystaniem HttpClientTestingModuleTymczasem moÅ¼emy jeszcze wrÃ³ciÄ‡ do serwisu i sprawdziÄ‡ jak przetestowaÄ‡ go z wykorzystaniem TestBed i HttpClientTestingModule:Ponownie konfigurujemy moduÅ‚ do testÃ³w:describe(&#39;AnimalService&#39;, () =&amp;gt; {  beforeEach(() =&amp;gt; {    TestBed.configureTestingModule({      imports: [HttpClientTestingModule],      providers: [        AnimalService      ]    });  });  it(&#39;should have a service&#39;, inject([AnimalService], (service: AnimalService) =&amp;gt; {    expect(service).toBeTruthy();  }));  it(&#39;should have a service&#39;, () =&amp;gt; {    const service = TestBed.get(AnimalService);    expect(service).toBeTruthy();  });});PowyÅ¼ej widzimy dwa testy â€œshould have a serviceâ€. SprawdzajÄ… one to samo, jednak zaprezentowane sÄ… dwie rÃ³Å¼ne moÅ¼liwoÅ›ci dostarczenia serwisu do testu:  poprzez const service = TestBed.get(AnimalService);  inject([AnimalService], (service: AnimalService) - funkcja inject przyjmuje dwa parametry:          tablicÄ™ serwisÃ³w do wstrzykniÄ™cia - tu jest to AnimalService. GdybyÅ›my chcieli wstrzyknÄ…Ä‡ wiÄ™cej serwisÃ³w byÅ‚yby one kolejnymi elementami tablicy, np.: [AnimalService, NextService]      drugi parametr to funkcja, gdzie okreÅ›lamy referencjÄ™ do serwisu i jego typ. Dla dwÃ³ch serwisÃ³w wyglÄ…daÅ‚oby to tak: (service: AnimalService, nextService: NextService). WaÅ¼na jest ich kolejnoÅ›Ä‡ tak aby byÅ‚a zgodna z kolejnoÅ›ciÄ… w tablicy, gdyÅ¼ do pierwszej referencji bÄ™dzie wstrzykniÄ™ty pierwszy element z tablicy.      Gdy moduÅ‚ jest gotowy moÅ¼emy przygotowaÄ‡ test, ktÃ³ry sprawdzi czy trafimy pod odpowiedni adres - i tylko tam. describe(&#39;getAnimals&#39;, () =&amp;gt; {    it(&#39;should call get with correct url&#39;,      inject([AnimalService, HttpTestingController], (service: AnimalService, controller: HttpTestingController) =&amp;gt; {        service.getAnimals().subscribe();        const request = controller.expectOne(&#39;http://localhost:3000/animals&#39;);        request.flush({id: 1, name: &#39;pies&#39;});        controller.verify();      }));  });Przy konfiguracji testÃ³w z wykorzystaniem TestBed pojawiÅ‚o siÄ™ sÅ‚owo async. Ma ono zwiÄ…zek z asynchronicznoÅ›ciÄ…, o ktÃ³rej wiÄ™cej napisze Adrian. Stay tuned!WiÄ™cej na temat testÃ³w Angulara i Jasmine znajdziesz:  https://angular.io/guide/testing#service-tests  https://jasmine.github.io/2.0/introduction.html",
"url": "/2019/11/20/testowanie-komponentow-i-serwisow.html",
"author": "Krzysztof Czechowski",
"authorUrl": "/authors/kczechowski.html",
"image": "kczechowski.jpg",
"highlight": "/assets/img/posts/2019-11-20-testowanie-komponentow-i-serwisow/testowanie_frontendu.jpg",
"date": "20-11-2019",
"path": "pl/2019-11-20-testowanie-komponentow-i-serwisow"
}
,


"2019-11-06-testowanie-frontendu-wprowadzenie-do-jasmine-html": {
"title": "Testowanie frontendu - Cz. 1. Wprowadzenie do Jasmine - konfiguracja i przykÅ‚adowe testy",
"lang": "pl",
"tags": "javascript test jasmine",
"content": "MÃ³j poprzedni wpis byÅ‚ o tym co testowaÄ‡ w projektach frontendowych, teraz przyszedÅ‚ czas aby wybraÄ‡ odpowiednie narzÄ™dzia, zakasaÄ‡ rÄ™kawy i przejÅ›Ä‡ do praktyki. PokaÅ¼Ä™ jak zainstalowaÄ‡ i uÅ¼ywaÄ‡ frameworka Jasmine w projekcie Nodeâ€™owym.NodeInstalacja za pomocÄ… nvmAby zainstalowaÄ‡ lokalnie Nodeâ€™a moÅ¼na posÅ‚uÅ¼yÄ‡ siÄ™ nvm, wiÄ™cej w artykule autorstwa Krzysztofa Czechowskiego na Å‚amach naszego bloga.Do uÅ¼ywania frameworka bÄ™dzie potrzebny projekt Nodeâ€™owy, w przypadku jego braku moÅ¼na w dowolnym katalogu taki stworzyÄ‡ za pomocÄ… polecenianpm initJasmineFrameworkJasmine jest frameworkiem sÅ‚uÅ¼Ä…cym do testowania napisanym w duchu behaviour-driven development, nie ma dodatkowych zaleÅ¼noÅ›ci oraz, jak twierdzÄ… twÃ³rcy, dostajemy go z bateriami, czyli powinien zawieraÄ‡ wszystko, co jest potrzebne do pisania testÃ³w jednostkowych w naszym projekcie.InstalacjaInstrukcja instalacji jest zwiÄ™Åºle opisana w dokumentacji. Aby zainstalowaÄ‡ framework w projekcie, naleÅ¼y:dodaÄ‡ zaleÅ¼noÅ›Ä‡ w devDependencies,npm:npm install --save-dev jasmineyarn:yarn add jasmine --devinicjowaÄ‡ lokalnie zainstalowany framework, polecenie utworzy domyÅ›lnÄ… konfiguracjÄ™ w katalogu spec, domyÅ›lnie Jasmine bÄ™dzie wykonywaÅ‚ testy w plikach w katalogu spec o nazwach koÅ„czÄ…cych siÄ™ na spec.js lub Spec.js.node node_modules/jasmine/bin/jasmine initframework zainicjowaÅ‚ siÄ™Â z domyÅ›lnÄ… konfiguracjÄ…:{  &quot;spec_dir&quot;: &quot;spec&quot;,  &quot;spec_files&quot;: [    &quot;**/*[sS]pec.js&quot;  ],  &quot;helpers&quot;: [    &quot;helpers/**/*.js&quot;  ],  &quot;stopSpecOnExpectationFailure&quot;: false,  &quot;random&quot;: true}nastÄ™pnie naleÅ¼y dodaÄ‡ wpis do package.json,&quot;scripts&quot;: { &quot;test&quot;: &quot;jasmine&quot; }zweryfikowaÄ‡ instalacjÄ™.npm testalboyarn testAngular CLIW przypadku uÅ¼ycia frameworka Angular CLI mamy juÅ¼ dostÄ™pny framework Jasmine i wymaga on jedynie innej konwencji nazewniczej plikÃ³w z testami.Struktura testuTesty sÄ… znajdowane przez Jasmine na podstawie Å›cieÅ¼ki i nazwy pliku, sÄ… to po prostu pliki o strukturze:describe(&quot;A suite is just a function&quot;, () =&amp;gt; {  let a;  it(&quot;and so is a spec&quot;, () =&amp;gt; {    a = true;    expect(a).toBe(true);  });});Randomized with seed 12095Started.1 spec, 0 failuresFinished in 0.008 secondsRandomized with seed 12095 (jasmine --random=true --seed=12095)Nawet doÅ›wiadczonemu programiÅ›cie przyzwyczajonemu do testÃ³w backendu powyÅ¼szy przykÅ‚ad moÅ¼e wydawaÄ‡ siÄ™Â maÅ‚o intuicyjny, na szczÄ™Å›cie jest to tylko zÅ‚udzenie.describe - to funkcja opisujÄ…ca zestaw testÃ³w, jako pierwszy parametr przyjmuje opis zestawu, jako drugi funkcjÄ™ zawierajÄ…cÄ… poszczegÃ³lne przypadki testowe.it - funkcja opisujÄ…ca pojedynczy przypadek testowy, tak samo jako describe pierwszym parametrem jest opis, drugim funkcja zawierajÄ…cy faktyczny test.expect - przyjmuje bieÅ¼Ä…cÄ… wartoÅ›Ä‡ i porÃ³wnuje jÄ… za pomocÄ… wbudowanych metod porÃ³wnujÄ…cych z oczekiwanÄ… wartoÅ›ciÄ…, w powyÅ¼szym przypadku jest to toBe, ale sÄ… dostÄ™pne bardziej specyficzne porÃ³wnania albo ich zaprzeczenia (np. not.toBeNull, toBeUndefined etc.)DostÄ™pne sÄ… rÃ³wnieÅ¼ funkcje wykonujÄ…ce siÄ™ przed lub po wszystkich testach, lub kaÅ¼dym (beforeEach, afterEach, beforeAll, afterAll), przykÅ‚adowo:describe(&quot;Test for resetting value before each test&quot;, () =&amp;gt; {  let value;  beforeEach(() =&amp;gt; {    value = 0;  });  it(&quot;value should be 1&quot;, () =&amp;gt; {    value = value + 1;    expect(value).toBe(1);  });    it(&quot;value should be 0&quot;, () =&amp;gt; {    expect(value).toBe(0);  });});Randomized with seed 22493Started..2 specs, 0 failuresFinished in 0.009 secondsRandomized with seed 22493 (jasmine --random=true --seed=22493)JeÅ›li chcemy wyÅ‚Ä…czyÄ‡ dany zestaw testÃ³w, lub pojedynczy przypadek testowy, moÅ¼emy posÅ‚uÅ¼yÄ‡ siÄ™ funkcjami xdescribe lub xit,fdescribe oraz fit sÅ‚uÅ¼Ä… po to, by wyÅ‚Ä…czyÄ‡ resztÄ™ testÃ³w, a zostawiÄ‡ te oznaczone wÅ‚aÅ›nie tÄ… literkÄ… f (od focus). Jest to szczegÃ³lnie przydatne gdy pracujemy nad nowymi funkcjonalnoÅ›ciami i nie chcemy marnowaÄ‡ czasu na wykonywanie testÃ³w, ktÃ³re w tym momencie sÄ… nieistotne.Jak widaÄ‡ na powyÅ¼szych przykÅ‚adach podstawy frameworka Jasmine sÄ… proste, sama instalacja i konfiguracja nie jest specjalnie skomplikowana, a w przypadku Angular CLI wszystko mamy juÅ¼ dostÄ™pne po instalacji. Ten wpis jest wprowadzeniem do testÃ³w jednostkowych we frontendzie, w nastÄ™pnej odsÅ‚onie pokaÅ¼emy jak mockowaÄ‡ lub stubowaÄ‡ zaleÅ¼noÅ›ci w komponentach angularowych i serwisach.MateriaÅ‚y ÅºrÃ³dÅ‚owe  https://jasmine.github.io  https://github.com/nvm-sh/nvm  https://angular.io/guide/testing",
"url": "/2019/11/06/testowanie-frontendu-wprowadzenie-do-jasmine.html",
"author": "Marcin Mendlik",
"authorUrl": "/authors/mmendlik.html",
"image": "mmendlik.jpg",
"highlight": "/assets/img/posts/2019-11-06-testowanie-frontendu-wprowadzenie-do-jasmine/frontend-testing.jpeg",
"date": "06-11-2019",
"path": "pl/2019-11-06-testowanie-frontendu-wprowadzenie-do-jasmine"
}
,


"2019-10-21-batchowe-inserty-w-hibernate-droga-ku-szybkosci-html": {
"title": "Batchowe inserty w Hibernate - droga ku szybkoÅ›ci",
"lang": "pl",
"tags": "programming hibernate persistence jpa",
"content": "W tym poÅ›cie powiemy o przykÅ‚adowej Å›cieÅ¼ce optymalizacji wstawiania grup rekordÃ³w do bazy danych za pomocÄ… Hibernateâ€™a i SpringBoota z zaÅ‚oÅ¼eniem uÅ¼ycia spring-boot-starter-data-jpa.Skupimy siÄ™ na aspektach konfiguracyjnym i diagnostycznym systemu.Zapytany o to czy lepiej uÅ¼ywaÄ‡ EntityManagera czy Hibernateâ€™owego Session, Emmanuel Bernard  bez wahania opowiedziaÅ‚ siÄ™ za tym pierwszym [1]. Jest to wypowiedÅº zgodna z zasadÄ…, ktÃ³rÄ… jako programiÅ›ci wszyscy dobrze znamy â€“ bazowanie na specyfikacji, a nie implementacji danej technologii. Stosowanie siÄ™ do tej reguÅ‚y sprawia, Å¼e zmiany technologiczne sÄ… o wiele prostsze - jesteÅ›my zwiÄ…zani tylko z interfejsem, a podmiana dostawcy jego implementacji jest przecieÅ¼ w zaÅ‚oÅ¼eniu tylko formalnoÅ›ciÄ….Zdarza siÄ™ jednak, Å¼e musimy zrobiÄ‡ coÅ› co wychodzi poza ramy abstrakcyjnej specyfikacji i chcÄ…c nie chcÄ…c uÅ¼yÄ‡ mechanizmÃ³w konkretnej implementacji. Tak jest teÅ¼ w przypadku batchowych insertÃ³w czyli zapisywania wiÄ™kszych grup rekordÃ³w w jednej transakcji. W tym poÅ›cie przejdziemy przez typowÄ… drogÄ™ optymalizacji tejÅ¼e operacji, przykÅ‚ady wizualizujÄ…c statystykami generowanymi przez Hibernateâ€™a oraz przepÅ‚ywami zilustrowanymi za pomocÄ… Zipkina [2].ZaÅ‚Ã³Å¼my dobrze znany scenariusz - podczas spokojnego dnia w pracy nagle otrzymujemy maila:  ZÅ‚e wieÅ›ci!Wystawiona usÅ‚uga co prawda dziaÅ‚a, ale nie moÅ¼emy za jej pomocÄ… w jednym Å¼Ä…daniu zÅ‚oÅ¼yÄ‡ 2000 zamÃ³wieÅ„.Okazuje sie, Å¼e oczekiwanie na odpowiedÅº trwa zbyt dÅ‚ugo i dostajemy timeout!Nie pozostaje nam nic innego jak przystÄ…piÄ‡ do optymalizacji. Pierwsze kroki, ktÃ³ry warto podjÄ…Ä‡ to ustawienie w celach diagnostycznych wpisu konfiguracyjnegospring.jpa.properties.hibernate.generate_statistics=truew pliku .properties lub .yml oraz odpowiednie skonfigurowanie Zipkina (tu tÄ™ konfiguracjÄ™ pominiemy bo jest ona obszernym materiaÅ‚em, ktÃ³ry mÃ³gÅ‚by wypeÅ‚niÄ‡ osobny artykuÅ‚). Te kroki pomogÄ… nam w przeÅ›ledzeniu powodu wyjÄ…tkowo dÅ‚ugiego czasu odpowiedzi usÅ‚ugi. PrzykÅ‚ady bÄ™dziemy badaÄ‡ na realnej usÅ‚udze w dwÃ³ch wariantach â€“ Å¼Ä…danie z maÅ‚Ä… liczbÄ… encji zwizualizowane za pomocÄ… Zipkina oraz Å¼Ä…danie z duÅ¼Ä… liczbÄ… encji opisane za pomocÄ… kluczowych statystyk i czasu wykonania.PrzejdÅºmy do analizy. Na poczÄ…tek przyjrzyjmy siÄ™ usÅ‚udze bez Å¼adnych optymalizacji.Co powoduje, Å¼e widzimy tak duÅ¼o wykonanych operacji? JuÅ¼ na pierwszy rzut oka widaÄ‡, Å¼e kaÅ¼de wstawianie rekordu jest realizowane osobno. SpÃ³jrzmy na wygenerowane statystyki dla normalnego wywoÅ‚ania usÅ‚ugi (przy duÅ¼ej liczbie encji)ÅÄ…czny czas odpowiedzi usÅ‚ugi przy wywoÅ‚aniu przez HTTP 9503ms (POSTMAN)Kluczowe statystyki wygenerowane przez Hibernate:195762869 nanoseconds spent preparing 4005 JDBC statements;6984223566 nanoseconds spent executing 4005 JDBC statements;0 nanoseconds spent executing 0 JDBC batches;4163640487 nanoseconds spent executing 1 flushes (flushing a total of 2003 entities and 0 collections);5927 nanoseconds spent executing 1 partial-flushes (flushing a total of 0 entities and 0 collections)Ze statystyk wynika, Å¼e nie wykonaÅ‚y siÄ™ Å¼adne paczki operacji, widaÄ‡ natomiast informacjÄ™ o zrealizowaniu ponad 4000 komend JDBC. WÄ…skim gardÅ‚em jest sposÃ³b wstawiania rekordÃ³w do bazy danych. Jak temu zaradziÄ‡?Z pomocÄ… przychodzi nam konfiguracja operacji batchowych. Skupimy siÄ™ przede wszystkim na wstawianiu rekordÃ³w. Skonfigurujmy batchowe inserty poprzez dodanie do wczeÅ›niej wspomnianych plikÃ³w konfiguracyjnych odpowiednich wpisÃ³wspring.jpa.properties.hibernate.jdbc.batch_size=1000DodajÄ…c ten wpis ustawiliÅ›my wielkoÅ›Ä‡ paczek w operacjach paczkowanych.Warto rÃ³wnieÅ¼, choÄ‡ nie jest to wymagane, ustawiÄ‡ inny wpis konfiguracyjny.spring.jpa.properties.hibernate.order_inserts=trueJest to przydatne szczegÃ³lnie w przypadku gdy wystÄ™puje relacja encji rodzic-dziecko z kaskadowÄ… persystencjÄ…, pozwoli to w takim przypadku na zgrupowanie zapisÃ³w typami encji.Po wykonaniu pierwszego kroku optymalizacyjnego sprawdÅºmy jak zmieniÅ‚y siÄ™ wygenerowane statystyki.Dla duÅ¼ej liczby encji statystyki prezentujÄ… siÄ™ nastÄ™pujÄ…co:ÅÄ…czny czas odpowiedzi usÅ‚ugi przy wywoÅ‚aniu przez HTTP 5138ms (POSTMAN)Kluczowe statystyki wygenerowane przez Hibernate:84610265 nanoseconds spent preparing 2006 JDBC statements;3139685203 nanoseconds spent executing 2003 JDBC statements;349347467 nanoseconds spent executing 4 JDBC batches;539223064 nanoseconds spent executing 1 flushes (flushing a total of 2003 entities and 0 collections);5446 nanoseconds spent executing 1 partial-flushes (flushing a total of 0 entities and 0 collections)ZarÃ³wno z zwizualizowanego przepÅ‚ywu dla maÅ‚ej liczby encji, jak i wygenerowanych statystyk dla duÅ¼ej ich liczby widzimy, Å¼e operacji jest mniej wiÄ™cej o poÅ‚owÄ™ mniej, a wygenerowane statystyki wprost mÃ³wiÄ…, Å¼e zostaÅ‚y wykonane â€paczkiâ€ operacji. Nadal jednak wywoÅ‚aÅ„ komend JDBC jest duÅ¼o poniewaÅ¼ wciÄ…Å¼ wykonywane sÄ… indywidualne zapytania po przydziaÅ‚ numerÃ³w bazodanowej sekwencji, ktÃ³re sÅ‚uÅ¼Ä… jako identyfikatory wstawianych encji. Jak moÅ¼emy temu zaradziÄ‡?PoczÄ…tkowa konfiguracja identyfikatora naszej encji wyglÄ…da tak:@Id@GeneratedValueprivate Long transactionId;W praktyce oznacza to zostawienie dostawcy implementacji dowolnoÅ›ci w doborze strategii generowania id. WeÅºmy sprawy w swoje rÄ™ce i zmieÅ„my strategiÄ™ generowania id dla naszej encji na odpowiadajÄ…cÄ… naszym potrzebom.@Id@GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;hilo_sequence_generator&quot;)@GenericGenerator(      name = &quot;hilo_sequence_generator&quot;,      strategy = &quot;org.hibernate.id.enhanced.SequenceStyleGenerator&quot;,      parameters = {            @Parameter(name = &quot;sequence_name&quot;, value=&quot;EXAMPLE_SEQ&quot;),            @Parameter(name = &quot;initial_value&quot;, value=&quot;1&quot;),            @Parameter(name = &quot;increment_size&quot;, value = &quot;100&quot;),            @Parameter(name = &quot;optimizer&quot;, value = &quot;hilo&quot;)      })private Long transactionId;Co wÅ‚aÅ›ciwie skonfigurowaliÅ›my w tym momencie?W adnotacji GeneratedValue informujemy Hibernate by uÅ¼yÅ‚ strategii sekwencji generowania id dla encji i wskazujemy nazwÄ™ generatora. NiÅ¼ej podajemy wczeÅ›niej wspomnianÄ… nazwÄ™ generatora, klasÄ™ wskazujÄ…cÄ… na strategiÄ™ generatora, podstawowe parametry i optymalizator. Jak dziaÅ‚a ten ostatni, u nas przyjmujÄ…cy wartoÅ›Ä‡ â€hiloâ€?Sam algorytm hi/lo jest opisany w wielu miejscach na internecie [3], dlatego skupimy siÄ™ tylko na tym jak dziaÅ‚a na poziomie koncepcyjnym:Skoro nie chcemy za kaÅ¼dym razem pytaÄ‡ bazÄ™ danych o nowy numer sekwencji, to moÅ¼emy jako klient zapytaÄ‡ o niego raz na N encji (wartoÅ›Ä‡ N zostaÅ‚a przez nas ustawiona w parametrze increment_size), a pomiÄ™dzy tymi zapytaniami sami inkrementowaÄ‡ licznik.W praktyce oznacza to, Å¼e mogÄ… powstaÄ‡ â€dziuryâ€ w numeracji, gdy w danej transakcji wstawimy jednÄ… encjÄ™ to mimo wszystko potrzebujemy numeru sekwencji z bazy danych, a w konsekwencji podbijemy jÄ… o N. Zyskiem z korzystania z tego mechanizmu jest rzadka potrzeba pytania bazy o kolejnÄ… wartoÅ›Ä‡ sekwencji.SprawdÅºmy kolejny raz jak nasze optymalizacje wpÅ‚ynÄ™Å‚y na szybkoÅ›Ä‡ dziaÅ‚ania usÅ‚ugi.Dla duÅ¼ej liczby encji statystyki prezentujÄ… siÄ™ nastÄ™pujÄ…co:ÅÄ…czny czas odpowiedzi usÅ‚ugi przy wywoÅ‚aniu przez HTTP: 1746 ms (POSTMAN)Kluczowe statystyki wygenerowane przez Hibernate:4294453 nanoseconds spent preparing 26 JDBC statements;118572140 nanoseconds spent executing 23 JDBC statements;531069793 nanoseconds spent executing 4 JDBC batches;732899796 nanoseconds spent executing 1 flushes (flushing a total of 2003 entities and 0 collections);5497 nanoseconds spent executing 1 partial-flushes (flushing a total of 0 entities and 0 collections)Widzimy kolejny drastyczny spadek liczby wykonywanych operacji wynikajÄ…cy z tego, Å¼e nie musimy tak czÄ™sto odpytywaÄ‡ bazy o kolejne numery sekwencji.PorÃ³wnajmy teraz Å‚Ä…czne wywoÅ‚ania usÅ‚ugiStan poczÄ…tkowy â€“ bez optymalizacji: 9503 msZ batchowymi insertami: 5138 msZ batchowymi insertami i optymalizacjÄ… sekwencji: 1746 msDziÄ™ki uÅ¼yciu odpowiednich mechanizmÃ³w zmniejszyliÅ›my czas odpowiedzi naszej usÅ‚ugi o ponad 80%!Warto wspomnieÄ‡, Å¼e przy tego typu optymalizacjach zmiany w czasach wykonywania Å¼Ä…daÅ„ mogÄ… byÄ‡ wysoce zaleÅ¼ne od uÅ¼ytych technologii, dla konkretnych baz danych istniejÄ… teÅ¼ specyficzne moÅ¼liwe optymalizacje. Dobrym przykÅ‚adem tego jest ustawienie obecne w MySQLrewriteBatchedStatements=truepozwalajÄ…ce na zoptymalizowanie liczby zapytaÅ„ przesyÅ‚anych w pakiecie sieciowym.W przypadku optymalizacji takich jak pokazane w tym poÅ›cie warto zajrzeÄ‡ pod maskÄ™ - do dokumentacji, a nawet kodu ÅºrÃ³dÅ‚owego frameworku, a takÅ¼e zaopatrzyÄ‡ siÄ™ w dobre narzÄ™dzia wspomagajÄ…ce diagnostykÄ™ jak chociaÅ¼by wyÅ¼ej przytoczony Zipkin.Warto teÅ¼ strzec siÄ™ bÅ‚Ä™dÃ³w i niepoprawnych uÅ¼yÄ‡ mechanizmÃ³w frameworkÃ³w, naleÅ¼y chociaÅ¼by pamiÄ™taÄ‡ o tym, Å¼e aby wykonaÄ‡ batch insert za pomocÄ… klasy JpaRepository z frameworku Spring musimy skorzystaÄ‡ z metody saveAll, a nie save. Osobnej optymalizacji poprzez ustawienie order_updates w plikach konfiguracyjnych moÅ¼e wymagaÄ‡ rÃ³wnieÅ¼ uaktualnianie rekordÃ³w. Kolejna puÅ‚apka o ktÃ³rej naleÅ¼y pamiÄ™taÄ‡ zwiÄ…zana jest z cache poziomu L1. Jak wiemy, dziaÅ‚a ono na poziomie pojedynczej transakcji. Oznacza to, Å¼e zapisujÄ…c duÅ¼Ä… liczbÄ™ encji w jednej transakcji naraÅ¼amy siÄ™ na problemy pamiÄ™ciowe.PodsumowujÄ…c, wiemy Å¼e cenÄ… za wysoki poziom abstrakcji frameworkÃ³w jest to, Å¼e duÅ¼o rzeczy dzieje siÄ™ poza naszym wzrokiem. Czasem musimy wyjÅ›Ä‡ poza specyfikacjÄ™ interfejsu technologicznego i skorzystaÄ‡ z mechanizÃ³w konkretnej implementacji, takie podejÅ›cie czÄ™sto bazowane jest na eksperymentowaniu by dowiedzieÄ‡ jaki mechanizm rozwiÄ…Å¼e nasz problem. Wymaga to nieraz diagnostycznego spojrzenia na problem oraz zagÅ‚Ä™bienia siÄ™ w dokumentacjÄ™ uÅ¼ywanej przez nas technologii.",
"url": "/2019/10/21/batchowe-inserty-w-hibernate-droga-ku-szybkosci.html",
"author": "Robert Rudko",
"authorUrl": "/authors/rrudko.html",
"image": "rrudko.jpg",
"highlight": "/assets/img/posts/2019-10-21-batchowe-inserty-w-hibernate-droga-ku-szybkosci/inserty-w-hibernate.jpg",
"date": "21-10-2019",
"path": "pl/2019-10-21-batchowe-inserty-w-hibernate-droga-ku-szybkosci"
}
,


"2019-10-13-wprowadzenie-do-zed-attack-proxy-html": {
"title": "Wprowadzenie do Zed Attack Proxy",
"lang": "pl",
"tags": "programming pentest pentesting tool OWASP security",
"content": "ZAP (Zed Attack Proxy) jest opensourcowym narzÄ™dziem tworzonym przez organizacjÄ™ OWASP wspomagajÄ…cym testy penetracyjne, ktÃ³re sÅ‚uÅ¼y do znajdowania podatnoÅ›ci bezpieczeÅ„stwa w aplikacjachwebowych. DziaÅ‚a na zasadzie proxy, dziÄ™ki czemu pozwala nie tylko na podglÄ…danie Å¼Ä…daÅ„ wysyÅ‚anych do serwera aplikacji i odpowiedzi z serwera otrzymywanych, ale daje rÃ³wnieÅ¼moÅ¼liwoÅ›Ä‡ debugowania, modyfikowania oraz wysyÅ‚ania wÅ‚asnych Å¼Ä…daÅ„. Jest narzÄ™dziem dostosowanym do obsÅ‚ugi HTTP, oferuje prosty sposÃ³b na rozszyfrowanie HTTPS poprzez dodanie wÅ‚asnegocertyfikatu do przeglÄ…darki. Dostarcza automatyczne skanery, jak rÃ³wnieÅ¼ narzÄ™dzia pomagajÄ…ce manualnie testowaÄ‡ aplikacjÄ™.Instalacja oraz konfiguracjaLink do pobrania ZAPaBy mÃ³c korzystaÄ‡ ze wszystkich funkcjonalnoÅ›ci jakie dostarcza nam ZAP powinniÅ›my zaczÄ…Ä‡ pracÄ™ od konfiguracji przeglÄ…darki, tak by Å‚Ä…czyÅ‚a siÄ™ ona przez proxy (lokalnie odpalonego ZAPa).Z uwagi na prostÄ… konfiguracjÄ™ polecanÄ… przeglÄ…darkÄ… jest Firefox. W menu przeglÄ…darki odnajdujemy Preferencje â†’ SieÄ‡ i wchodzimy w Ustawienia. Zaznaczamy â€œRÄ™czna konfiguracjaserwerÃ³w proxyâ€. DomyÅ›lne wartoÅ›ci dla serwera to 127.0.01, a dla portu 8080.Od tego momentu ZAP dziaÅ‚a jako proxy, wszystkie Å¼Ä…dania, ktÃ³re wysyÅ‚amy do aplikacji oraz wszystkie odpowiedzi, ktÃ³re otrzymujemy, przechodzÄ… od teraz przez ZAPa.HTTPSW poprzednim kroku skonfigurowaliÅ›my przeglÄ…darkÄ™, by mÃ³c podglÄ…daÄ‡ ruch HTTP w sieci. Aby uÅ¼ywaÄ‡ ZAPa na stronach wymagajÄ…cych HTTPS, musimy dodaÄ‡ certyfikat ZAPa do naszejprzeglÄ…darki. Certyfikat znajdziemy w Options â†’ Dynamic SSL Certificates.W przeglÄ…darce importujemy certyfikat w Preferencje â†’ PrywatnoÅ›Ä‡ i bezpieczeÅ„stwo â†’ Certyfikaty â†’ WyÅ›wietl certyfikatyâ€¦ â†’ Importuj. Certyfikat ten jest certyfikatem CA - zaimportowaniego spowoduje dodanie OWASP Root CA do listy organÃ³w certyfikacji w naszej przeglÄ…darce:Teraz juÅ¼ moÅ¼emy podglÄ…daÄ‡ zarÃ³wno ruch nieszyfrowany jak i szyfrowany pomiÄ™dzy przeglÄ…darkÄ… i serwerami, z ktÃ³rymi siÄ™ Å‚Ä…czy. Musimy pamiÄ™taÄ‡, Å¼e od tej chwili nasza przeglÄ…darka jest podatnana atak Man in the middle i nie powinniÅ›my z niej korzystaÄ‡ w innych celach, niÅ¼ do testowania. PrzejdÅºmy zatem do zabawy ZAPem.ZAP - wprowadzenieDo prezentacji dziaÅ‚ania ZAPa wykorzystamy inne narzÄ™dzie: Webgoat, ktÃ³re jest celowo podatnÄ… aplikacjÄ… opensourcowÄ… napisanÄ… w Javie umoÅ¼liwiajÄ…cÄ… testowanie czÄ™sto spotykanych bÅ‚Ä™dÃ³wbezpieczeÅ„stwa w aplikacjach korzystajÄ…cych z popularnych opensourcowych komponentÃ³w.KorzystajÄ…c z tych dwÃ³ch aplikacji musimy pamiÄ™taÄ‡, by jednÄ… z nich uruchomiÄ‡ z innym portemniÅ¼ domyÅ›lny 8080. Po stronie ZAPa port moÅ¼emy zmieniÄ‡ w ustawieniach Options â†’ Local Proxies.Po uruchomieniu aplikacji Webgoat moÅ¼emy podglÄ…daÄ‡ caÅ‚Ä… komunikacjÄ™ z serwerem. W zakÅ‚adce History widzimy historiÄ™ wszystkich zapytaÅ„. MoÅ¼emy wykluczyÄ‡ wewnÄ™trzne zapytania Webgoataz historii komunikacji, dziÄ™ki czemu stanie siÄ™ ona bardziej przejrzysta. W tym celu klikamy prawym przyciskiem myszy na jeden z wpisÃ³w w historii, wybieramy Exclude from â†’ Proxyi dodajemy URLe, ktÃ³re bÄ™dÄ… ignorowane (moÅ¼emy w tym celu uÅ¼yÄ‡ wyraÅ¼eÅ„ regularnych).Z lewej strony programu umiejscowione jest menu. W zakÅ‚adce Sites, podobnie jak w History, znajdujÄ… siÄ™ wszystkie zapytania do serwera, jednak tutaj mamy zachowanÄ… strukturÄ™ zasobÃ³wna serwerze aplikacji. W tym miejscu moÅ¼emy zauwaÅ¼yÄ‡ rÃ³wnieÅ¼ zakÅ‚adkÄ™ Contexts. Konteksty umoÅ¼liwiajÄ… testowanie aplikacji na rÃ³Å¼nych poziomach dostÄ™pu w tym samym momencie - by to osiÄ…gnÄ…Ä‡dodajemy kontekst dla poszczegÃ³lnych uÅ¼ytkownikÃ³w. MoÅ¼emy teÅ¼ w tym miejscu w zakÅ‚adce Structure skonfigurowaÄ‡ parametry URL.Debugowanie oraz modyfikacja zapytaÅ„W zakÅ‚adce Request oraz Response moÅ¼emy podejrzeÄ‡ Å¼Ä…danie i odpowiedÅº z serwera. ZAP umoÅ¼liwia przechwytywanie zapytaÅ„ oraz ich modyfikacjÄ™. By przetestowaÄ‡ dziaÅ‚anie tej funkcjonalnoÅ›ciustawiamy breakpointy za pomocÄ… okrÄ…gÅ‚ej zielonej ikonki umieszczonej w gÃ³rnym pasku menu.KlikajÄ…c na ikonkÄ™ ustawimy breakpointy na kaÅ¼dym zapytaniu oraz odpowiedzi - ikonka po klikniÄ™ciu zmienia kolor na czerwony. NastÄ™pnie w aplikacji Webgoat wprowadzamy dane wejÅ›ciowe w dowolnym poludo tego przeznaczonym, np. w sekcji General -&amp;gt; HTTP Basics. Na potrzeby naszego testu wprowadziÅ‚am tekst â€œConsdataâ€.SzczegÃ³Å‚y zapytania w trybie debugowania otwierajÄ… siÄ™ w zakÅ‚adce Break, a poniÅ¼ej okna z Å¼Ä…daniem znajduje siÄ™ pole, w ktÃ³rym moÅ¼emy je modyfikowaÄ‡.Modyfikujemy Å¼Ä…danie wprowadzajÄ…c tekst â€œ123â€ w miejsce â€œConsdataâ€:W rezultacie otrzymamy odpowiedÅº z serwera zawierajÄ…cÄ… zmodyfikowane przez nas dane â€œThe server has reversed your name: 321â€, co moÅ¼emy zaobserwowaÄ‡ w ZAPie oraz Webgoacie.FunkcjonalnoÅ›ci wspierajÄ…ce testy penetracyjneZAP posiada szereg funkcji umoÅ¼liwiajÄ…cych przeskanowanie aplikacji w poszukiwaniu rÃ³Å¼nych zasobÃ³w i podatnoÅ›ci oraz wykonanie atakÃ³w. Jest to jednak narzÄ™dzie wspomagajÄ…ce pracÄ™ pentestera,bez manualnego przeklikania siÄ™ przez aplikacjÄ™ nie jest moÅ¼liwe znalezienie wszystkich podatnoÅ›ci. NarzÄ™dzia umoÅ¼liwiajÄ…ce wykonanie skanÃ³w oraz atakÃ³w znajdziemy klikajÄ…c prawym przyciskiemmyszy w zakÅ‚adce Sites na folderze, ktÃ³ry chcemy przetestowaÄ‡ lub w zakÅ‚adce History na interesujÄ…cym nas endpointcie (bÄ…dÅº kilku) w sekcji Attack albo w gÃ³rnym pasku menu w zakÅ‚adce Tool.SpiderJedynym z poczÄ…tkowych etapÃ³w testÃ³w penetracyjnych jest manualne przeszukanie aplikacji w celu znalezienia zasobÃ³w znajdujÄ…cych siÄ™ na serwerze. NarzÄ™dziem, ktÃ³re moÅ¼e zautomatyzowaÄ‡ czÄ™Å›Ä‡pracy jest Spider. Skanuje on aplikacjÄ™ w poszukiwaniu ukrytych zasobÃ³w. W przypadku, gdy chcemy przeszukaÄ‡ zasoby pobierane asynchronicznie powinniÅ›my uÅ¼yÄ‡ skanera AjaxSpider. NaleÅ¼y jednakzwrÃ³ciÄ‡ uwage na fakt, Å¼e narzÄ™dzie to nie zastÄ…pi rÄ™cznego przeszukania aplikacji, poniewaÅ¼ przechodzi jedynie przez HTMLowe linki na stronie. Nie sprawdzi siÄ™ rÃ³wnieÅ¼ w przypadku aplikacji,gdzie DOM jest generowany dynamicznie, nie obsÅ‚uÅ¼y teÅ¼ eventÃ³w innych niÅ¼ standardowe. Po uruchomieniu narzÄ™dzia w aplikacji pojawia siÄ™ sekcja Spider, w ktÃ³rej moÅ¼emy znaleÅ¼Ä‡ wyniki skanu.ActiveScanActiveScan jest narzÄ™dziem aktywnie skanujÄ…cym aplikacjÄ™, wykonujÄ…cym seriÄ™ atakÃ³w, ktÃ³rego zadaniem jest znalezienie podatnoÅ›ci. WysyÅ‚a Å¼Ä…dania do kolejnych endpointÃ³w automatycznie modyfikujÄ…cich treÅ›Ä‡, analizuje odpowiedzi i okreÅ›la na ich podstawie podatnoÅ›ci. Jednak tak jak przy Spiderze, tak i tutaj nie obÄ™dzie siÄ™ bez rÄ™cznego przejÅ›cia aplikacji. ActiveScan nie potrafi bowiemsamodzielnie wyszukaÄ‡ wszystkich endpointÃ³w, trzeba mu je wskazaÄ‡. Dopiero gdy znajdÄ… siÄ™ one w historii komunikacji mamy pewnoÅ›Ä‡, Å¼e skaner je przetestuje. Gdy skaner znajdzie podatnoÅ›Ä‡zobaczymy czerwonÄ… flagÄ™ przy endpointcie, a w zakÅ‚adce Alerts znajdÄ… siÄ™ informacje na temat znalezionej podatnoÅ›ci.DziaÅ‚anie ActiveScan przetestujemy w miejscu, o ktÃ³rym wiemy, Å¼e zawiera bÅ‚Ä…d bezpieczeÅ„stwa. W Webgoacie otwieramy sekcjÄ™ Injection Flaws â†’ SQL Injection (introduction) â†’ krok 11 i wprowadzamydowolne dane w widocznych polach.Po wprowadzeniu danych zobaczymy w ZAPie w sekcji History URL: http://localhost:9000/WebGoat/SqlInjection/attack8 i bÄ™dziemy mogli podejrzeÄ‡ Å¼Ä…danie.ActiveScan uruchomimy na tym endpoincie, by skrÃ³ciÄ‡ czas skanowania. Po uruchomieniu narzÄ™dzia w ZAPie pojawi siÄ™ zakÅ‚adka Active Scan, w ktÃ³rej bÄ™dziemy mogli zobaczyÄ‡ wszystkie Å¼Ä…dania wysyÅ‚anedo serwera przez ActiveScan, np.:JeÅ›li zostanÄ… znalezione bÅ‚Ä™dy, zobaczymy je w zakÅ‚adce Alerts. Widzimy tu informacje dotyczÄ…ce URLa, w ktÃ³rym ActiveScan znalazÅ‚ bÅ‚Ä…d, jakie dane wejÅ›ciowe sprowokowaÅ‚y bÅ‚Ä…d, opis bÅ‚Ä™du,dodatkowe informacje, proponowane rozwiÄ…zanie oraz referencje.W panelu Sites pojawi siÄ™ rÃ³wnieÅ¼ czerwona flaga w miejscu, w ktÃ³rym znaleziony zostal bÅ‚Ä…d.ForcedBrowseForcedBrowse jest narzÄ™dziem, ktÃ³ry szuka plikÃ³w o znanych lub Å‚atwych do przewidzenia nazwach na serwerze aplikacji korzystajÄ…c z odpowiednich sÅ‚ownikÃ³w. W ten sposÃ³b moÅ¼emy znaleÅºÄ‡ zasoby,ktÃ³re na serwerze nie powinny siÄ™ znaleÅºÄ‡ i stanowiÄ… zagroÅ¼enie. MoÅ¼e to na przykÅ‚ad byÄ‡ repozytorium, pliki konfiguracyjne, pliki z backupem, panel administracyjny, itp. W ZAPie wbudowanychjest kilka podstawowych sÅ‚ownikÃ³w, jednak bardziej rozbudowane moÅ¼na znaleÅºÄ‡ na githubie, na przykÅ‚ad:https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/SVNDigger/all.txtSÅ‚ownik moÅ¼emy dodaÄ‡ wybierajÄ…c z gÃ³rnego menu Tools -&amp;gt; Options -&amp;gt; ForcedBrowse -&amp;gt; Add custom Forced Browse file. Po uruchomieniu narzÄ™dzia w ZAPie pojawi siÄ™ zakÅ‚adaka Forced Browse, w ktÃ³rejwidzimy pasek postÄ™pu zadania, plik z jakiego pobierane sÄ… dane oraz wyniki skanu.W rzeczywistoÅ›ci ForcedBrowse bazuje na narzÄ™dziu DirBuster, ktÃ³re zostaÅ‚o wbudowane w ZAPa. Czas trwania skanu jest uzaleÅ¼niony od wielu czynnikÃ³w - wydajnosci serwera, wielkosci sÅ‚ownikai zastosowanych na sererze mechanizmÃ³w zabezpieczajÄ…cych. Warto zaznaczyÄ‡, Å¼e skan moÅ¼e zajÄ…Ä‡ nawet do kilkudziesiÄ™ciu godzin.FuzzNarzÄ™dzie Fuzz wykonuje atak za pomocÄ… techniki fuzzingu, czyli wysyÅ‚aniu do aplikacji predefiniowanych lub dynamicznie generowanych danych wejÅ›ciowych w celu sprowokowania bÅ‚Ä™dÃ³w.By przeprowadziÄ‡ ten atak naleÅ¼y wywoÅ‚aÄ‡ Å¼Ä…danie, zaznaczyÄ‡ na nim element, ktÃ³ry bÄ™dziemy poddawaÄ‡ modyfikacji, wybraÄ‡ Fuzz z bocznego menu oraz dodaÄ‡ dane wejÅ›ciowe (Payloads).Mamy moÅ¼liwoÅ›Ä‡ zdefiniowana rÃ³Å¼nego rodzaju danych wejÅ›ciowych w Fuzz -&amp;gt; Payloads -&amp;gt; Add. MogÄ… to byÄ‡ na przykÅ‚ad stringi, wyraÅ¼enia regularne, skrypty, pliki ze zdefiniowanymi wejÅ›ciami. NastÄ™pnienaleÅ¼y ustawiÄ‡ odpowiednie kodowanie w zaleÅ¼noÅ›ci od formy w jakiej dane majÄ… byÄ‡ dostarczone do aplikacji.Po ukoÅ„czeniu fuzzowania naleÅ¼y przeanalizowaÄ‡ odpowiedzi na wysyÅ‚ane Å¼Ä…dania - nietypowe odpowiedzi, na przykÅ‚ad zawierajÄ…ce komunikaty o bÅ‚Ä™dach, mogÄ… zasugerowaÄ‡ obecnoÅ›Ä‡Â podatnoÅ›ci danego typu(na przykÅ‚ad bÅ‚Ä™dy SQL sugerujÄ…, Å¼e moÅ¼emy testowaÄ‡ SQL injection). Odpowiedzi znajdujÄ… siÄ™ w zakÅ‚adce Fuzzer, ktÃ³ra otwiera siÄ™ podczas przeprowadzania ataku.W analizie odpowiedzi pomaga posegregowanie ich po wielkoÅ›ci. WiÄ™kszy rozmiar odpowiedzi sugeruje, Å¼e moÅ¼emy znaleÅºÄ‡ tam interesujÄ…cy bÅ‚Ä…d. W przypadku naszego testu otrzymaliÅ›my w odpowiedzi danez bazy danych oraz informacjÄ™ potwierdzajÄ…cÄ… nasz suckes: â€œYou have succeeded! You successfully compromised the confidentiality of data by viewing internal information that you should not haveaccess to. Well done!â€.PodsumowanieZAP jest narzÄ™dziem dostosowanym do obsÅ‚ugi protokoÅ‚u HTTP i oferujÄ…cym Å‚atwy sposÃ³b na rozszyfrowanie HTTPS. DziÄ™ki funkcji proxy daje moÅ¼liwoÅ›Ä‡ nie tylko podglÄ…dania, ale teÅ¼ modyfikowania i wysyÅ‚aniawÅ‚asnych Å¼Ä…daÅ„. Posiada rÃ³wnieÅ¼ wiele dodatkowych funkcjonalnoÅ›ci uÅ‚atwiajÄ…cych przeprowadzenie testÃ³w penetracyjnych. Musimy jednak pamiÄ™taÄ‡ o ograniczeniach podczas korzystania z tego typu narzÄ™dzi.Å»adne narzÄ™dzie nie zautomatyzuje w peÅ‚ni procesu testowania bezpieczeÅ„stwa aplikacji. Wyszukiwanie ewentualnych bÅ‚Ä™dÃ³w bezpieczeÅ„stwa nie obÄ™dzie siÄ™ bez manualnego przejÅ›cia aplikacji i umiejÄ™tnejanalizy oraz interpretacji odpowiedzi serwera.MateriaÅ‚y ÅºrÃ³dÅ‚owe  https://github.com/zaproxy/zaproxy/wiki/Downloads  https://github.com/zaproxy/zaproxy/wiki  https://owasp-academy.teachable.com/p/owasp-zap-tutorial  https://github.com/zaproxy/zap-core-help/wiki/HelpIntro  https://github.com/WebGoat/WebGoat  https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/SVNDigger/all.txt",
"url": "/2019/10/13/wprowadzenie-do-zed-attack-proxy.html",
"author": "Aleksandra Mak",
"authorUrl": "/authors/amak.html",
"image": "amak.jpg",
"highlight": "/assets/img/posts/2019-10-14-wprowadzenie-do-zed-attack-proxy/zed-attack-proxy.jpeg",
"date": "13-10-2019",
"path": "pl/2019-10-14-wprowadzenie-do-zed-attack-proxy"
}
,


"2019-10-03-kafka-companion-html": {
"title": "Kafka Companion",
"lang": "pl",
"tags": "programming kafka event sourcing tool",
"content": "Stalo siÄ™ standardem, Å¼e wspÃ³Å‚czesne narzÄ™dzia i biblioteki dystrybuowane sÄ… z mniej lub bardziej zaawansowanym interfejsem graficznym. RabbitMQ, bÄ™dÄ…cy najpopularniejszym obecnie systemem kolejkowym, wita nas po zainstalowaniu przejrzystym i funkcjonalnym panelem administracyjnym. MoÅ¼e wiÄ™c budziÄ‡ zdziwienie, Å¼e Apache Kafka nie zostaÅ‚a wyposaÅ¼ona w Å¼adne GUI. Do dyspozycji dostajemy jedynie zestaw skryptÃ³w bashowych, ktÃ³re co prawda pozwalajÄ… wykonaÄ‡ wiele czynnoÅ›ci administracyjnych, to jednak korzystanie z nich nie naleÅ¼y do przyjemnych. SprawiajÄ… wraÅ¼enie pisanych przez rÃ³Å¼ne zespoÅ‚y developerskie, poniewaÅ¼ te same parametry potrafiÄ… mieÄ‡ inne nazwy. W dodatku skrypty sÄ… bezstanowe - kaÅ¼de wywoÅ‚anie musi mieÄ‡ peÅ‚en zestaw parametrÃ³w identyfikujÄ…cych serwer i zasoby do ktÃ³rych chcemy siÄ™ odwoÅ‚aÄ‡. Naturalnym jest zatem, Å¼e do wygodnej i wydajnej pracy warto wdroÅ¼yÄ‡ rozwiÄ…zanie, ktÃ³re pozwala w Å‚atwy sposÃ³b podejrzeÄ‡ stan serwera oraz topikÃ³w na Kafce. Z kolei ze wzglÄ™du na prostotÄ™ testowania i diagnostyki, warto mieÄ‡ moÅ¼liwoÅ›Ä‡ dodawania nowych komunikatÃ³w.Dlaczego piszemy wÅ‚asne narzÄ™dziePoszukujÄ…c administracyjnego frontendu do naszej Kafki, zainstalowaliÅ›my i przetestowaliÅ›my szereg dostÄ™pnych w sieci darmowych aplikacji. Niestety Å¼adna z nich nie speÅ‚niÅ‚a wszystkich wyspecyfikowanych wymagaÅ„. Nie pozostaÅ‚o nam zatem nic innego, jak przygotowaÄ‡ wÅ‚asne narzÄ™dzie. Tak oto powstaÅ‚ Kafka Companion. UwaÅ¼ni czytelnicy naszego bloga zauwaÅ¼Ä… pewnie, Å¼e nie jest to pierwszy Companion, ktÃ³ry powstaÅ‚ w naszej firmie. Podobne pobudki doprowadziÅ‚y chociaÅ¼by do implementacji SQCompaniona, o ktÃ³rym pisaÅ‚ Grzegorz Lipecki w artykule Monitorowanie zespoÅ‚owych trendÃ³w jakoÅ›ci koduPodstawowe funkcjonalnoÅ›ciAplikacja podzielona jest na trzy moduÅ‚y dostarczajÄ…ce istotnych funkcjonalnoÅ›ci podczas codziennej pracy developerskiej z KafkÄ….PodglÄ…d kondycji klastraEkranem, od ktÃ³rego naleÅ¼aÅ‚oby rozpoczÄ…Ä‡, jest lista wszystkich wÄ™zÅ‚Ã³w w klastrze. ZnajÄ…c topologiÄ™ moÅ¼emy upewniÄ‡ siÄ™, czy wÄ™zÅ‚y klastra sÄ… Å¼ywe oraz jakie majÄ… identyfikatory.PodglÄ…d i dodawanie wiadomoÅ›ci do topikuMoÅ¼liwoÅ›Ä‡ podglÄ…dania stanu kolejek oraz dodawania nowych wiadomoÅ›ci jest niezwykle istotna podczas rozwijania oraz testowania systemu. W naszym rozwiÄ…zaniu wszystkie wiadomoÅ›ci sÄ… JSONami, wiÄ™c dodatkowo widok wiadomoÅ›ci prÃ³buje rozÅ‚oÅ¼yÄ‡ je do postaci tabeli tak, aby moÅ¼na byÅ‚o przejrzyÅ›cie zaprezentowaÄ‡ stan topiku.  Prezentowane sÄ… takÅ¼e metadane zwiÄ…zane z numerem partycji oraz offsetem wiadomoÅ›ci.W kaÅ¼dej chwili moÅ¼emy zarzuciÄ‡ topik dowolnÄ… liczbÄ… wiadomoÅ›ci. WprowadziliÅ›my takÅ¼e placeholdery pozwalajÄ…ce na rÃ³Å¼nicowanie wiadomoÅ›ci dodawanych w jednej serii.PodglÄ…d stanu grup konsumentÃ³wOstatnim ekranem jest podglÄ…d grup konsumentÃ³w.Dowiadujemy siÄ™ z niego kto konsumuje wiadomoÅ›ci z topikÃ³w oraz, co bardzo waÅ¼ne, czy wiadomoÅ›ci sÄ… konsumowane na bieÅ¼Ä…co.PodsumowanieKafka Companion jest darmowy i dostÄ™pny na naszym Githubie. ZachÄ™cam do pobrania, testowania i zgÅ‚aszania uwag.Zaproszenie na 4developersJeÅ¼eli zainteresowaÅ‚a was tematyka poruszana w tym artykule to serdecznie zapraszam na moje wystÄ…pienie na 4Developers, gdzie wykorzystam Kafka Companiona podczas mojej prezentacji. Wielkopolska edycja 4Developers odbÄ™dzie siÄ™ 18.11. ÅšcieÅ¼ki tematyczne, jakie pojawiÄ… siÄ™ w Poznaniu, to: .NET, Architektury Aplikacji, Java, JavaScriptTutaj zdobÄ™dziecie bilety",
"url": "/2019/10/03/kafka-companion.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2019-10-03-kafka-companion/kafka.png",
"date": "03-10-2019",
"path": "pl/2019-10-03-kafka-companion"
}
,


"2019-09-16-haproxy-small-but-handy-html": {
"title": "HAProxy - small but handy",
"lang": "en",
"tags": "programming load-balancing ha server network",
"content": "HAProxy is open source software that is most often used as a reverse proxy to ensure load balancing and high availability of application servers.Instead of connecting directly to the servers of an application, clients (e.g. of a browser) do it from a reverse proxy, which uses additional rules to pass the requests to the application servers and send the responses back to the client.The project has been actively developed since 2002 and has seen increased popularity due to the proliferation of distributed systems, in particular architectures based on microservices. It is in use by such household names as Digital Ocean, GitHub, Dropbox, Instagram or StackOverflow. It is also a component of the OpenShift containerization platform.The software is available for all popular Linux distributions, also as a Docker image.Typical usages of HAProxyEnsuring load balancingOne of the basic usages of HAProxy is as a software load balancer. With several nodes in an application, the traffic between them needs to be managed. To do that you need to declare an object called backend in the HAProxy configuration, which will represent a cluster of the application servers.Next, you need to declare an object called frontend, to which clients will be directed and frontend-to-backend traffic rules:frontend my-load-balancer    bind 172.19.0.1:81    default_backend my-application-servers    backend my-application-servers    balance roundrobin    server my-app-server-1 172.19.0.2:8080    server my-app-server-2 172.19.0.3:8080    server my-app-server-3 172.19.0.4:8080   As a result of the above configuration, the connection on endpoint 172.19.0.1:81 will be redirected to one of the servers on a round-robin basis.Ensuring High AvailabilityHAProxy can monitor the state of the servers declared in the backend section and halt directing traffic to the servers that have stopped working correctly.The server can be configured to determine how often HAProxy is supposed to check the serverâ€™s status, how many times the verification has to fail in order for the server to be considered faulty, and how many times the verification has to succeed for the excluded server to be regarded as healthy again.For example: server my-app-server-1 172.19.0.2:8080 check inter 5s fall 3 downinter 1m raise 5means that:  server status will be checked every 5 seconds (inter 5s),  server will be excluded if three consecutive verifications fail (fall 3),  excluded server will be checked every minute (downinter 1m),  server will be considered operational again if three consecutive verifications are successful (raiseÂ 5).TLS/SSLFor managing encrypted TLS/SSL connections, HAProxy can work in one of the following modes:  regular proxy  terminating encryption  encrypting traffic againRegular proxyIn this mode, HAProxy simply passes the stream of bytes from the frontend to the backend, disregarding the fact that the traffic is encrypted.Terminating encryptionIn this mode, HAProxy receives encrypted traffic from the frontend, decrypts it using a private key and passes the decrypted traffic to the backend.An example configuration:frontend my-terminating-load-balancer    bind 172.19.0.1:443 ssl crt /etc/ssl/certs/my-certs.pem    default_backend my-application-servers    backend my-application-servers    balance roundrobin    server my-app-server-1 172.19.0.2:8080    server my-app-server-2 172.19.0.3:8080Encrypting traffic againIn this mode, HAProxy receives encrypted traffic from the frontend, decrypts it using a private key, and then encrypts it again and passes it to the backend.An example configuration:frontend my-terminating-load-balancer    bind 172.19.0.1:443 ssl crt /etc/ssl/certs/my-certs.pem    default_backend my-secure-application-servers    backend my-secure-application-servers    balance roundrobin    server my-secure-app-server-1 172.19.0.2:8443 ssl    server my-secure-app-server-2 172.19.0.3:8443 sslAs a result of decryption, in this mode HAProxy can manipulate the HTTP requests that it redirects, unlike in the regular proxy mode.Session affinityHAProxy can be configured so that the requests from a given user will always be directed to the same application server. The need for this occurs, e.g. when you are using local user sessions that exist only on the application server which they were created on.An example configuration that is based on a session cookie prefix:frontend my-sticky-load-balancer    bind 172.19.0.1:81     default_backend my-application-servers    backend my-application-servers    cookie JSESSIONID prefix nocache    server my-app-server-1 172.19.0.2:8080 cookie node1    server my-app-server-2 172.19.0.3:8080 cookie node2With this configuration, all requests that carry a session cookie with the â€œnode1â€ prefix will be directed to the first application server.ACLHAProxy enables the user to configure rules (ACL - Access Control List) which determine how particular requests are supposed to be handled. An example configuration:frontend my-acl-load-balancer\tbind 172.19.0.1:81\tacl is-passive method GET\tuse_backend my-passive-application-server if is-passive\tdefault_backend my-active-application-server    backend my-passive-application-server\tserver my-passive-app-server-1 172.19.0.2:8080    backend my-active-application-server\tserver my-active-app-server-1 172.19.0.3:8080With this configuration, GET requests will be directed to a passive application server, whereas all other requests will be directed to an active one.A useful tool in your programming toolboxBesides the traditional use case as a reverse proxy that ensures load balancing and high availability, HAProxy can be used to great effect in a range of programming scenarios. Let me present some examples from my own experience.Easily changeable routingWhile developing an application that calls services from different applications, you might want to be able to switch between various addresses of those external services, e.g. between real applications and their mock versions. Restarting an application is often time-consuming, while changing the IP address to external services requires editing more than one file.In this case, HAProxy may act as a convenient â€œhubâ€, in which you can easily switch between various versions of the external services. By configuring HAProxy as follows:frontend my-forward-proxy\tbind 172.19.0.1:81\tdefault_backend my-external-services    backend my-external-services\tserver my-external-server-1 172.19.0.2:8080backend my-mocked-services\tserver my-mocked-server-1 172.19.0.3:8080and setting the address of external services in your application to 172.19.0.1:81, you can modify its external dependencies by changing the â€œdefault_backendâ€ value and a quick reload of HAProxy, without the need to restart the application.Monitoring TLS/SSLIf the services in your system send data through encrypted TLS/SSL connections, debugging communication using network traffic analyzers such as tcpdump or Wireshark might be difficult. However, you can set HAProxy as a proxy between the services that will terminate an encrypted connection and will allow you to monitor the network traffic.Delaying requestsWhile developing an application you might sometimes need to test how it will behave if calling an external service is processed for a longer time than expected. You can simulate this kind of delay with HAProxy acting as the proxy to external services. HAProxy itself does not have this capability but it enables you to extend its functionalities with Lua scripts. An example script introducing a delay:function delay_request(txn)    core.msleep(15000)endcore.register_action(&quot;delay_request&quot;, { &quot;http-req&quot; }, delay_request);Loading the script to HAProxy:lua-load /etc/haproxy/delay.luaand usage in the configuration:frontend my-delay-frontend    bind 172.19.0.1:81    mode http    http-request lua.delay_request    default_backend my-delay-backendbackend my-delay-backend    server my-external-server-1 172.19.0.2:8080A simple static content serverInterestingly, you can use HAProxy as a simple server for static files. For every backend, you can configure the files that are supposed to be served in the case of particular HTTP statuses. On the other hand, when no server has been defined in the backendâ€™s configuration, HAProxy generates HTTP status 503. By combining these two facts, you can configure the frontend to return a static file for particular requests:frontend my-frontend    bind 172.19.0.1:81    mode http    use_backend my-backend-static if { path_end /index.html }    default_backend my-backend-servicesbackend my-backend-static    mode http    errorfile 503 /etc/haproxy/index.html    backend my-backend-services    server my-external-server-1 172.19.0.2:8080Connecting to a sessionAs a developer you might need to connect with a browser to a user session on a server using the sessionâ€™s ID. Modern desktop browsers usually allow you to manually add a session cookie to a websiteâ€™s cookie set. But what if you need to serve less popular or mobile browsers? HAProxy may come in handy in this situation as well:frontend my-setcookie-frontend    bind 172.19.0.1:81    mode http    default_backend my-setcookie-backendbackend my-setcookie-backend    mode http    http-request redirect location http://172.19.0.1:80/\\r\\nSet-Cookie:\\ JSESSIONID=%[urlp(session_id)] code 302With this configuration, an attempt to access http://172.19.0.1:81/?session_id=123456 from any browser will be redirected to http://172.19.0.1:80 with an already set session cookie (here, we are using the fact that the cookies set for this domain do not take ports into consideration).SummaryAs you can see, HAProxy has a number of typical and inventive applications. Its big advantages are a relatively simple configuration, a runtime performance and being â€œlightweightâ€, which makes the changed configuration load in a split second.Iâ€™m sure that any designer of distributed systems or an agile developer will find HAProxy to be a very useful tool in their work.",
"url": "/2019/09/16/haproxy-small-but-handy.html",
"author": "Tomasz Lewandowski",
"authorUrl": "/authors/tlewandowski.html",
"image": "tlewandowski.jpg",
"highlight": "/assets/img/posts/2019-09-19-haproxy-mala-rzecz-a-cieszy/haproxy.jpg",
"date": "16-09-2019",
"path": "en/2019-09-19-haproxy-small-but-handy"
}
,


"2019-09-05-kafka-retry-dlq-html": {
"title": "Niezawodne dostarczanie zdarzeÅ„ w Apache Kafka oparte o ponawianie i DLQ",
"lang": "pl",
"tags": "programming kafka event sourcing retry dlq dlt",
"content": "W kaÅ¼dym dostatecznie zÅ‚oÅ¼onym systemie informatycznym dochodzimy w pewnym momencie do miejsca, w ktÃ³rym musimy sobie odpowiedzieÄ‡ na pytanie: a co jeÅ›li coÅ› pÃ³jdzie nie tak. JeÅ›li mamy szczÄ™Å›cie, to moÅ¼e siÄ™ okazaÄ‡, Å¼e rozwiÄ…zania, ktÃ³re wybraliÅ›my, dostarczajÄ… nam gotowe narzÄ™dzia do radzenia sobie w sytuacjach wyjÄ…tkowych. MoÅ¼e teÅ¼ siÄ™ okazaÄ‡, Å¼e nie mieliÅ›my tyle szczÄ™Å›cia i wybraliÅ›my KafkÄ™â€¦W niniejszym wpisie znajdziesz odpowiedÅº na to, dlaczego w Kafce nie ma DLQ (ang. Dead Letter Queue) oraz jak sobie poradziÄ‡ w sytuacji, gdy potrzebujesz takiego mechanizmu w swoim systemie.Dlaczego w Kafce nie ma DLQ?Zacznijmy zatem od odpowiedzi na pytanie. WiÄ™kszoÅ›Ä‡ popularnych systemÃ³w kolejkowych takich jak RabbitMQ czy ActiveMQ ma wbudowane systemy odpowiedzialne za niezawodne dostarczanie komunikatÃ³w. Dlaczego zatem Kafka nie oferuje takowego. OdpowiedÅº na to pytanie Å›ciÅ›le zwiÄ…zana jest z jednym z rozwiÄ…zaÅ„ architektonicznych leÅ¼Ä…cych u podstaw dziaÅ‚ania Kafki: gÅ‚upi broker i sprytny konsument (ang. dumb broker / smart consumer). Wzorzec ten sprowadza siÄ™ do tego, Å¼e ciÄ™Å¼ar logiki zwiÄ…zanej z obsÅ‚ugÄ… odczytÃ³w przenoszony jest na konsumenta. KonsekwencjÄ… takiego podejÅ›cia jest brak gotowego rozwiÄ…zania mogÄ…cego wspomÃ³c konsumenta w przypadku wystÄ…pienia problemu podczas przetwarzania komunikatu. Broker jest zainteresowany tylko jednÄ… informacjÄ…: pozycjÄ…, na ktÃ³rej konsument zakoÅ„czyÅ‚ przetwarzanie (ang. committed offset). OczywiÅ›cie zawsze moÅ¼na rzec, Å¼e w tej sytuacji naleÅ¼y dobraÄ‡ odpowiednie narzÄ™dzie do problemu i zastosowaÄ‡ system kolejkowy majÄ…cy takie wsparcie. Nie zawsze jednak mamy nieograniczonÄ… swobodÄ™ wprowadzania wielu rozwiÄ…zaÅ„ w jednym systemie. JeÅ›li tak jak ja wybraliÅ›cie KafkÄ™ jako silnik rejestrujÄ…cy zdarzenia, to w przypadku wystÄ…pienia opisywanego problemu musicie poradziÄ‡ sobie sami i odpowiednio go oprogramowaÄ‡.Jak sobie radziÄ‡ z bÅ‚Ä™damiWyobraÅºmy sobie sytuacjÄ™, w ktÃ³rej elementem procesu obsÅ‚ugi zdarzenia jest komunikacja z zewnÄ™trznym systemem. Musimy podjÄ…Ä‡ decyzjÄ™ jak ma zachowaÄ‡ siÄ™ konsument w momencie, gdy zewnÄ™trzny system odpowiada w inny sposÃ³b, niÅ¼ siÄ™ spodziewaliÅ›my albo, co gorsza - w ogÃ³le nie odpowiada. Jest wiele strategii obsÅ‚ugi takiej sytuacji. Ja na potrzeby tego artykuÅ‚u wybraÅ‚em cztery, ktÃ³re doprowadzÄ… nas do rozwiÄ…zania, ktÃ³rego implementacja zostanie zaprezentowana w kolejnych akapitach.Brak obsÅ‚ugiBardzo popularna i czÄ™sto stosowana strategia obsÅ‚ugi sytuacji wyjÄ…tkowych, to brak reakcji. MoÅ¼e to potwierdziÄ‡ kaÅ¼dy programista. Na powyÅ¼szym rysunku prostokÄ…ty oznaczajÄ… kolejne wiadomoÅ›ci w topiku. Gdy konsument napotka problem z przetwarzaniem komunikatu o offsecie 1486, ignoruje go i przechodzi do nastÄ™pnego. I mimo Å¼e takie podejÅ›cie wydaje siÄ™ niezbyt rozsÄ…dnym rozwiÄ…zaniem, to istniejÄ… sytuacje, gdy utrata czÄ™Å›ci komunikatÃ³w nie niesie za sobÄ… ryzyka. Za przykÅ‚ad moÅ¼na podaÄ‡ wszelkie rozwiÄ…zania przechowujÄ…ce i analizujÄ…ce zachowanie uÅ¼ytkownikÃ³w w aplikacji. PoniewaÅ¼ zadaniem takiego systemu jest zbieranie danych statystycznych, utrata pojedynczych zdarzeÅ„ nie wpÅ‚ynie znaczÄ…co na wyniki. WaÅ¼ne jest jednak, Å¼eby dysponowaÄ‡ skutecznym monitoringiem, ktÃ³ry wychwyci sytuacjÄ™, w ktÃ³rej utrata komunikatÃ³w przekracza pewien arbitralnie ustalony poziom.NieskoÅ„czone ponawianie w miejscuGdy nie moÅ¼emy pozwoliÄ‡ sobie na utratÄ™ komunikatÃ³w, najprostszym podejÅ›ciem jest ponawianie do skutku. OczywistÄ… konsekwencjÄ… jest tzw. zatrzymanie Å›wiata. DopÃ³ki bÅ‚Ä…d nie zostanie poprawiony albo zewnÄ™trzny system udroÅ¼niony - Å¼aden kolejny komunikat nie zostanie przetworzony. Takie rozwiÄ…zanie jest konieczne w przypadku, gdy chcemy zachowaÄ‡ kolejnoÅ›Ä‡ przetwarzania zdarzeÅ„ systemie. W ten scenariusz tym bardziej wpisuje siÄ™ potrzeba staÅ‚ego monitoringu.SkoÅ„czone ponawianie w miejscu z topikiem bÅ‚Ä™dÃ³w Omawiane do tej pory strategie zachowujÄ… kolejnoÅ›Ä‡ przetwarzania zdarzeÅ„. Jest to niezwykle istotne w sytuacji, gdy zdarzenia sÄ… od siebie zaleÅ¼ne i spÃ³jnoÅ›Ä‡ naszego systemu opiera siÄ™ na kolejnoÅ›ci przetwarzania. Nie zawsze jednak zdarzenia majÄ… takÄ… wÅ‚aÅ›ciwoÅ›Ä‡ i brak koniecznoÅ›ci zachowania kolejnoÅ›ci otwiera przed nami nowe moÅ¼liwoÅ›ci. WyobraÅºmy sobie co siÄ™ stanie, jak nieco poluzujemy wymaganie bezwzglÄ™dnego zachowania kolejnoÅ›ci. ZaÅ‚Ã³Å¼my, Å¼e prÃ³bujemy przez jakiÅ› czas ponawiaÄ‡, poniewaÅ¼ statystyka i doÅ›wiadczenie podpowiada nam, Å¼e 99% problemÃ³w z przetwarzaniem komunikatÃ³w jest chwilowych i samoczynnie ustÄ™puje po pewnym czasie. Dodatkowo komunikaty, ktÃ³rych nie udaÅ‚o siÄ™ przetworzyÄ‡, kopiujemy na oddzielny topik traktowany jako DLQ. DziÄ™ki temu mamy od razu wyÅ‚uskane problematyczne wiadomoÅ›ci i moÅ¼emy uruchomiÄ‡ na nich osobnÄ… grupÄ™ konsumentÃ³w.KrÃ³tkie wyjaÅ›nienie, dlaczego komunikaty sÄ… kopiowane a nie przenoszone. OdpowiedÅº jest bardzo prosta - nie mogÄ… byÄ‡ przenoszone. Wynika to z kolejnego fundamentu architektonicznego Kafki czyli niezmiennoÅ›ci topikÃ³w (ang. topics immutability). NiezaleÅ¼nie jaka byÅ‚a przyczyna bÅ‚Ä™du, komunikat na zawsze pozostanie utrwalony. IstniejÄ… sposoby na radzenie sobie z tym tematem i wrÃ³cimy do tego pÃ³Åºniej.SkoÅ„czone ponawianie na wydzielonym topikuDochodzimy niniejszym do naszego ostatecznego rozwiÄ…zania. Skoro mamy osobny topik dla zepsutych wiadomoÅ›ci to moÅ¼e warto wprowadziÄ‡ kolejny, na ktÃ³rym odbywa siÄ™ ponawianie. W tym modelu jeszcze bardziej luzujemy koniecznoÅ›Ä‡ zachowania kolejnoÅ›ci, ale dostajemy w zamian moÅ¼liwoÅ›Ä‡ bezprzerwowego przetwarzania gÅ‚Ã³wnego topiku. W konsekwencji nie zatrzymujemy Å›wiata a wiadomoÅ›ci kaskadowo kopiowane sÄ… najpierw na topik wiadomoÅ›ci ponawianych a w przypadku niepowodzenia - topik DLQ (technicznie powinniÅ›my nazwaÄ‡ go DLT, ale zostaÅ„my przy akronimie DLQ, jako Å¼e jest on dobrze kojarzony z tego rodzaju technikami).W systemie, na podstawie ktÃ³rego powstaÅ‚ ten wpis, wystÄ™puje wszystkie cztery opisywane warianty postÄ™powania w sytuacji awaryjnej. Wyzwanie polega na dopasowania odpowiedniej metody do natury danych przetwarzanych w topiku. Warto teÅ¼ zaznaczyÄ‡, Å¼e naleÅ¼y uczyÄ‡ siÄ™ od najwiÄ™kszych i dwa ostatnie modele sÄ… mocno inspirowane sposobem, w jaki KafkÄ™ w swoich systemach uÅ¼ywa Uber.ImplementacjeMajÄ…c za sobÄ… czÄ™Å›Ä‡ teoretycznÄ…, moÅ¼emy w koÅ„cu przejÅ›Ä‡ do kodu. PoglÄ…dowÄ… aplikacjÄ™, z ktÃ³rej pochodzÄ… poniÅ¼sze snippety, znajdziecie na Githubie. Od razu zaznaczam, Å¼e nie jest to coÅ›, z czym moÅ¼na by pÃ³jÅ›Ä‡ na produkcjÄ™. Chodzi bardziej o zarysowanie sposobu, w jaki moÅ¼na wdroÅ¼yÄ‡ ostatniÄ… strategiÄ™.Konsument gÅ‚Ã³wnego topiku    @KafkaListener(topics = &quot;${topic.main}&quot;)    public void consumeFromMainTopic(String message,                                     @Header(KafkaHeaders.RECEIVED_MESSAGE_KEY) String key,                                     @Header(KafkaHeaders.OFFSET) String offset) {        log.info(&quot;Consume from main topic [key={}, offset={}, message={}]&quot;, key, offset, message);        Message serializedMessage;        try {            serializedMessage = objectMapper.readValue(message, Message.class);            restTemplate.getForEntity(POSTMAN_RESOURCE_URL + serializedMessage.getAction(), String.class);            log.info(&quot;Done processing [key={}, offset={}]&quot;, key, offset);        } catch (Exception e) {            log.error(&quot;Cannot handle message: {}&quot;, e.getMessage());            copyMessageToRetry(message);        }    }WiÄ™kszoÅ›Ä‡ przykÅ‚adÃ³w i kursÃ³w uÅ¼ywa niskopoziomowego klienta dostarczonego przez Apache, ktÃ³ry moÅ¼e przeraziÄ‡ mniej doÅ›wiadczonych programistÃ³w konstrukcjÄ… wykorzystujÄ…cÄ… nieskoÅ„czonÄ… pÄ™tlÄ™. Nie ma siÄ™ czego baÄ‡, jest to po prostu konstrukcja wynikajÄ…ca ze sposobu w jaki klient Kafki dziaÅ‚a. Nie zmienia to jednak faktu, Å¼e nawet prosty odczyt wymaga nieco kodu. MoÅ¼na to znacznie uproÅ›ciÄ‡, wykorzystujÄ…c implementacjÄ™, ktÃ³ra opakowuje boilerplate kod, dostarczonÄ… przez Springa. Tak teÅ¼ zostaÅ‚o to zaproponowane w niniejszym przykÅ‚adzie, mamy wiÄ™c Kafka Listenera zapiÄ™tego na zdarzenia z gÅ‚Ã³wnego topiku. Dodatkowo wstrzykujemy elementy nagÅ‚Ã³wka wiadomoÅ›ci, aby moÅ¼na byÅ‚o na podstawie logÃ³w przeÅ›ledziÄ‡ procesowanie. Sama implementacja jest w tym przypadku bardzo prosta. WywoÅ‚ujemy zewnÄ™trzny serwis i w przypadku bÅ‚Ä™dÃ³w, kopiujemy wiadomoÅ›Ä‡ do topiku realizujÄ…cego ponawianie.W celu symulowania problemÃ³w z czasem odpowiedzi zewnÄ™trznego systemu, wykorzystamy tutaj publicznie dostÄ™pne API Postmana a w szczegÃ³lnoÅ›ci endpoint /delay. DziÄ™ki mnogoÅ›ci dostÄ™pnych zachowaÅ„ Postman Echo Å›wietnie sprawdza siÄ™ w testach integracyjnych z zewnÄ™trznym systemem.Konsument topiku do ponawiania    @KafkaListener(topics = &quot;${topic.retry}&quot;)    public void consumeFromRetryTopic(String message,                                      @Header(KafkaHeaders.RECEIVED_MESSAGE_KEY) String key,                                      @Header(KafkaHeaders.OFFSET) String offset) {        log.info(&quot;Consume from retry topic [key={}, offset={}, message={}]&quot;, key, offset, message);        Message serializedMessage;        long loop = 1;        boolean success = false;        while (loop &amp;lt;= 3 &amp;amp;&amp;amp; !success) {            try {                serializedMessage = objectMapper.readValue(message, Message.class);                Thread.sleep(loop * 500);                log.info(&quot;Retrying message in loop {}&quot;, loop);                restTemplateForRetrying.getForEntity(POSTMAN_RESOURCE_URL + serializedMessage.getAction(), String.class);                success = true;                log.info(&quot;Done processing [key={}, offset={}]&quot;, key, offset);            } catch (Exception e) {                log.error(&quot;Cannot handle message {}&quot;, e.getMessage());            }            loop++;        }        if (!success) {            copyMessageToDlq(message);        }    }Konsument topiku ponawiajÄ…cego podejmuje trzy prÃ³by przetworzenia wiadomoÅ›ci. Realizuje on teÅ¼ koncept polegajÄ…cy na tym, Å¼e kaÅ¼da nastÄ™pna prÃ³ba jest bardziej oddalona w czasie. W tej konkretnej implementacji jest to po prosty wynik mnoÅ¼enia numeru iteracji przez 500. W docelowym rozwiÄ…zaniu warto rozwaÅ¼yÄ‡ wykÅ‚adniczy wzrost odstÄ™pÃ³w pomiÄ™dzy kolejnymi prÃ³bami. JeÅ¼eli uda siÄ™ przetworzyÄ‡ wiadomoÅ›Ä‡ to konsument przechodzi do kolejnej, jeÅ›li nie - kopiuje do DLQ.Konsument DLQ    @KafkaListener(topics = &quot;${topic.dlq}&quot;)    public void consumeFromDlqTopic(String message,                                    @Header(KafkaHeaders.RECEIVED_MESSAGE_KEY) String key,                                    @Header(KafkaHeaders.OFFSET) String offset) {        log.error(&quot;Consume from DLQ topic [key={}, offset={}, message={}]&quot;, key, offset, message);    }W przypadku podglÄ…dowej aplikacji konsument DLQ wypisuje tylko wiadomoÅ›Ä‡ na ekranie. Natomiast w docelowych rozwiÄ…zaniach jest to dobre miejsce na zbieranie statystyk o czÄ™stotliwoÅ›ci oraz przyczynie bÅ‚Ä™dÃ³w i uruchamianie w systemie alertÃ³w.Uruchomienie przykÅ‚aduPo uruchomieniu aplikacji moÅ¼emy zaczÄ…Ä‡ bombardowaÄ‡ jÄ… wiadomoÅ›ciami. UÅ¼yjÄ™ w tym celu narzÄ™dzia Kafka Companion, ktÃ³re sami przygotowaliÅ›my w trakcie prac z KafkÄ…. Aplikacja jest darmowa i dostÄ™pna na naszym GitHubie. O tym jakie ma moÅ¼liwoÅ›ci i dlaczego powstaÅ‚o, bÄ™dziecie mogli przeczytaÄ‡ w moim kolejnym wpisie na blogu.Poprawnie przetworzona wiadomoÅ›Ä‡Consume from main topic [key=1, offset=0, message={    &quot;id&quot; : &quot;5dad21b1-9f5c-4b67-a583-dfad8b00b0b5&quot;,    &quot;action&quot; : &quot;0&quot;}]Done processing [key=1, offset=0]WysÅ‚anie wiadomoÅ›ci z action=0 spowoduje, Å¼e Postman Echo odpowiada bez zwÅ‚oki i przetwarzanie koÅ„czy siÄ™ na gÅ‚Ã³wnym topiku.WiadomoÅ›Ä‡ ponawiana - poprawnie przetworzonaConsume from main topic [key=1, offset=2, message={    &quot;id&quot; : &quot;646ad855-fe50-4e96-ba1e-78dfa939acef&quot;,    &quot;action&quot; : &quot;1&quot;}]Cannot handle message: I/O error on GET request for &quot;https://postman-echo.com/delay/1&quot;: Read timed outCopying message [target=external-retry, key=2019-09-01]Consume from retry topic [key=2019-09-01, offset=1, message={    &quot;id&quot; : &quot;646ad855-fe50-4e96-ba1e-78dfa939acef&quot;,    &quot;action&quot; : &quot;1&quot;}]Retrying message in loop 1Done processing [key=2019-09-01, offset=1]Aplikacja korzysta z dwÃ³ch instancji RestTemplate o innej konfiguracji timeoutÃ³w. Ten gÅ‚Ã³wny czeka maksymalnie 900ms, podczas gdy ten ponawiajÄ…cy 1900ms. Jest to wygodne na nasze potrzeby prezentacyjne, ale warto takÅ¼e zaznaczyÄ‡, Å¼e w docelowym rozwiÄ…zaniu rÃ³wnieÅ¼ naleÅ¼y rozwaÅ¼yÄ‡ rozdzielenie konfiguracji. PoniewaÅ¼ w tym modelu gÅ‚Ã³wny topik nie jest blokowany przez niepowodzenia, moÅ¼na bardziej liberalnie skonfigurowaÄ‡ poÅ‚Ä…czenie do zewnÄ™trznego systemu w przypadku konsumenta ponawiajÄ…cego.WiadomoÅ›Ä‡ w DLQConsume from main topic [key=1, offset=3, message={    &quot;id&quot; : &quot;77954f26-583b-4e55-9fe8-2a1f7c204541&quot;,    &quot;action&quot; : &quot;5&quot;}]Cannot handle message: I/O error on GET request for &quot;https://postman-echo.com/delay/5&quot;: Read timed outCopying message [target=external-retry, key=2019-09-01]Consume from retry topic [key=2019-09-01, offset=2, message={    &quot;id&quot; : &quot;77954f26-583b-4e55-9fe8-2a1f7c204541&quot;,    &quot;action&quot; : &quot;5&quot;}]Retrying message in loop 1Cannot handle message I/O error on GET request for &quot;https://postman-echo.com/delay/5&quot;: Read timed outRetrying message in loop 2Cannot handle message I/O error on GET request for &quot;https://postman-echo.com/delay/5&quot;: Read timed outRetrying message in loop 3Cannot handle message I/O error on GET request for &quot;https://postman-echo.com/delay/5&quot;: Read timed outCopying message [target=external-dlq, key=2019-09-01]Consume from DLQ topic [key=2019-09-01, offset=0, message={    &quot;id&quot; : &quot;77954f26-583b-4e55-9fe8-2a1f7c204541&quot;,    &quot;action&quot; : &quot;5&quot;}]Trzeci i ostatni przykÅ‚ad zadaje 5 sekundowe opÃ³Åºnienie i wiemy z naszej konfiguracji, Å¼e taki komunikat na pewno nie zostanie przetworzony i trafi ostatecznie do DLQ. Wprawne oko zauwaÅ¼y, Å¼e w podczas kopiowania nadawany jest inny klucz, w tym przypadku oznaczajÄ…cy dzieÅ„ wystÄ…pienia bÅ‚Ä™du. BÄ™dzie to istotne w kolejnym punkcie.DLQ a grupy konsumentÃ³wMarcin Mergo, ktÃ³rego moÅ¼ecie znaÄ‡ jako autora artykuÅ‚u Czy Apache Kafka nadaje siÄ™ do Event Sourcingu?, zapytaÅ‚ mnie ostatnio jak ma siÄ™ ponawianie na oddzielnych topikach do sytuacji, gdy mamy wiele rÃ³Å¼nych grup konsumentÃ³w. Na pierwszy rzut oka mogÅ‚oby siÄ™ wydawaÄ‡, Å¼e podobnie jak w RabbitMQ, topik ponawiajÄ…cy i DLQ sÄ… Å›ciÅ›le powiÄ…zane z gÅ‚Ã³wnym topikiem. Nic bardziej mylnego. Koncepcja grup konsumentÃ³w dziaÅ‚ajÄ…cych w Kafce na tym samym topiku, ale majÄ…cych innÄ… implementacjÄ™ powoduje, Å¼e mechanizm ponawiajÄ…cy musi byÄ‡ powiÄ…zany z konkretnÄ… grupÄ…. W szczegÃ³lnoÅ›ci rÃ³Å¼ne grupy mogÄ… mieÄ‡ innÄ… logikÄ™ ponawianie i obsÅ‚ugi bÅ‚Ä™dÃ³w. Sytuacja jeszcze bardziej siÄ™ komplikuje, gdy grupy konsumentÃ³w sÄ… w jakiÅ› sposÃ³b od siebie zaleÅ¼ne. Jedna grupa moÅ¼e bazowaÄ‡ na fakcie, Å¼e inna grupa poprawnie przetworzyÅ‚a dany komunikat. Trzeba wtedy bardzo rozwaÅ¼nie dostosowaÄ‡ mechanizmy ponawianie i obsÅ‚ugi bÅ‚Ä™dÃ³w tak, aby zachowaÄ‡ spÃ³jnoÅ›Ä‡ przetwarzania komunikatÃ³w.SprzÄ…tanie.Na zakoÅ„czenie pozostaje jeszcze rozwiÄ…zanie problemu zwiÄ…zanego z redundancjÄ… danych wynikajÄ…cÄ… z faktu kopiowania wiadomoÅ›ci pomiÄ™dzy topikami. W przypadku gÅ‚Ã³wnego topika mamy sytuacjÄ™, Å¼e kaÅ¼da wiadomoÅ›Ä‡, ktÃ³ra ostatecznie trafiÅ‚a do DLQ uznawana jest za uszkodzonÄ…. JeÅ›li w naszej aplikacji jest moÅ¼liwoÅ›Ä‡ ponownego przetworzenia strumienia wiadomoÅ›ci, to musimy jakoÅ› obsÅ‚uÅ¼yÄ‡ tÄ™ sytuacjÄ™. IstniejÄ… co najmniej dwa rozwiÄ…zania:  rejestr uszkodzonych wiadomoÅ›ci - moÅ¼e byÄ‡ budowany automatycznie na podstawie wiadomoÅ›ci trafiajÄ…cych do DLQ. SkÅ‚adajÄ… siÄ™ na niego offsety wiadomoÅ›ci z gÅ‚Ã³wnego topiku. Podczas ponownego przetworzenia konsument, wiedzÄ…c o rejestrze, pomija wszystkie oznaczone w nim wiadomoÅ›ci,  kompaktowanie - napisaÅ‚em wczeÅ›niej, Å¼e nie moÅ¼na zmieniaÄ‡ i usuwaÄ‡ wiadomoÅ›ci w topiku. Jest od tej reguÅ‚y wyjÄ…tek - mechanizm kompaktowania topiku. W najwiÄ™kszym skrÃ³cie dziaÅ‚a to w ten sposÃ³b, Å¼e broker uruchamia cyklicznie zadanie, ktÃ³re przeglÄ…da topik, zbiera wiadomoÅ›ci o tym samym kluczu i pozostawia tylko tÄ… najnowszÄ…. Trik polega na tym, Å¼eby wstawiÄ‡ do strumienia wiadomoÅ›Ä‡ o tym samym kluczu co uszkodzona, ale o pustej treÅ›ci. Konsument musi wczeÅ›niej byÄ‡ przygotowany na obsÅ‚ugÄ™ takich wiadomoÅ›ci.MoÅ¼na obie techniki stosowaÄ‡ jednoczeÅ›nie, naleÅ¼y jednak pamiÄ™taÄ‡, Å¼e offsety skompaktowanych wiadomoÅ›ci zniknÄ… bezpowrotnie z topiku.Topik retry zawiera wiadomoÅ›ci, ktÃ³re po przetworzeniu nie majÄ… Å¼adnej wartoÅ›ci, wiÄ™c w tym przypadku wystarczy skonfigurowaÄ‡ retencjÄ™, czyli czas Å¼ycia wiadomoÅ›ci. Trzeba tylko pamiÄ™taÄ‡, Å¼eby retencja nie byÅ‚a krÃ³tsza, niÅ¼ najdÅ‚uÅ¼szy moÅ¼liwy czas przetwarzania pojedynczej wiadomoÅ›ci.Topik DLQ powinien zawieraÄ‡ wiadomoÅ›ci dopÃ³ki, dopÃ³ty nie zostanÄ… zdiagnozowane a system - poprawiony. Jako, Å¼e ten czas nie jest Å‚atwy do ustalenia to nie wchodzi w rachubÄ™ retencja. StÄ…d teÅ¼ trik z kluczami opartymi na datach. JeÅ›li uznajemy, Å¼e incydenty z okreÅ›lonego dnia zostaÅ‚y rozwiÄ…zane, to wprowadzamy do DLQ pusty komunikat z kluczem takim jak dzieÅ„ i przy najbliÅ¼szej sesji kompaktowania - wszystkie wiadomoÅ›ci zostanÄ… usuniÄ™te z DLQ.PodsumowanieW ten oto sposÃ³b dobrnÄ™liÅ›my do koÅ„ca. LiczÄ™, Å¼e udaÅ‚o mi siÄ™ zaprezentowaÄ‡ na tym prostym przykÅ‚adzie, Å¼e iteracyjne podejÅ›cie do problemu potrafi doprowadziÄ‡ nas do ciekawych i skutecznych rozwiÄ…zaÅ„.Zaproszenie na 4developersJeÅ¼eli zainteresowaÅ‚a was tematyka poruszana w tym artykule to serdecznie zapraszam was na moje wystÄ…pienie na 4Developers, gdzie postaram siÄ™ ten temat jeszcze bardziej zgÅ‚Ä™biÄ‡. Wielkopolska edycja 4Developers odbÄ™dzie siÄ™ 18.11. ÅšcieÅ¼ki tematyczne, jakie pojawiÄ… siÄ™ w Poznaniu, to: .NET, Architektury Aplikacji, Java, JavaScriptTutaj zdobÄ™dziecie bilety",
"url": "/2019/09/05/kafka-retry-dlq.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2019-09-05-kafka-retry-dlq/apache-kafka.png",
"date": "05-09-2019",
"path": "pl/2019-09-05-kafka-retry-dlq"
}
,


"2019-08-22-view-encapsulation-w-angularze-html": {
"title": "View Encapsulation w Angularze - czyli o kapsuÅ‚kowaniu sÅ‚Ã³w kilka",
"lang": "pl",
"tags": "angular view encapsulation kapsuÅ‚kowanie",
"content": "TworzÄ…c komponenty w Angularze mamy moÅ¼liwoÅ›Ä‡ zarzÄ…dzania kapsuÅ‚kowaniem (enkapsulacjÄ…) stylÃ³w - czyli tym jak style z jednego komponentu wpÅ‚ywajÄ… na inne komponenty.Zanim omÃ³wimy kapsuÅ‚kowanie, wyjaÅ›nijmy w kilku sÅ‚owach czym jest Shadow DOM.Shadow DOMShadow DOM wprowadza kapsuÅ‚kowanie do DOM-u. Pozwala to odseparowaÄ‡ styl i kod potrzebny do wyÅ›wietlenia elementu od dokumentu, w ktÃ³rym siÄ™ znajduje. PrzykÅ‚adem moÅ¼e byÄ‡ np. element HTML &amp;lt;video&amp;gt;&amp;lt;video width=&quot;320&quot; height=&quot;240&quot;&amp;gt;    &amp;lt;source src=&quot;movie.mp4&quot; type=&quot;video/mp4&quot;&amp;gt;    &amp;lt;source src=&quot;movie.ogg&quot; type=&quot;video/ogg&quot;&amp;gt;&amp;lt;/video&amp;gt;Po wÅ‚Ä…czeniu opcji wyÅ›wietlania Shadow Root w przeglÄ…darce (na przykÅ‚adzie Google Chrome):DevTools &amp;gt; Settings &amp;gt; Preferences &amp;gt; ElementsmoÅ¼emy zobaczyÄ‡ z czego tak naprawdÄ™ skÅ‚ada siÄ™ element &amp;lt;video&amp;gt;:&amp;lt;video width=&quot;320&quot; height=&quot;240&quot;&amp;gt;    #shadow-root        &amp;lt;div pseudo=&quot;-webkit-media-controls&quot; class=&quot;sizing-small phase-ready state-stopped&quot;&amp;gt;            &amp;lt;div pseudo=&quot;-internal-media-controls-loading-panel&quot; aria-label=&quot;buforowanie&quot; aria-live=&quot;polite&quot;                style=&quot;display: none;&quot;&amp;gt;&amp;lt;/div&amp;gt;            &amp;lt;div pseudo=&quot;-webkit-media-controls-overlay-enclosure&quot;&amp;gt;&amp;lt;input                    pseudo=&quot;-internal-media-controls-overlay-cast-button&quot; type=&quot;button&quot;                    aria-label=&quot;odtwarzanie na urzÄ…dzeniu zdalnym&quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;/div&amp;gt;            &amp;lt;div pseudo=&quot;-webkit-media-controls-enclosure&quot;&amp;gt;                &amp;lt;div pseudo=&quot;-webkit-media-controls-panel&quot;&amp;gt;                    &amp;lt;div pseudo=&quot;-internal-media-controls-scrubbing-message&quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;/div&amp;gt;                    &amp;lt;div pseudo=&quot;-internal-media-controls-button-panel&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                            pseudo=&quot;-webkit-media-controls-play-button&quot; aria-label=&quot;odtwÃ³rz&quot; class=&quot;pause&quot; style=&quot;&quot;&amp;gt;                        &amp;lt;div aria-label=&quot;upÅ‚ynÄ™Å‚o: 0:00&quot; pseudo=&quot;-webkit-media-controls-current-time-display&quot; style=&quot;&quot;&amp;gt;0:00                        &amp;lt;/div&amp;gt;                        &amp;lt;div aria-label=&quot;pozostaÅ‚o: / 0:12&quot; pseudo=&quot;-webkit-media-controls-time-remaining-display&quot; style=&quot;&quot;&amp;gt;                            /                            0:12&amp;lt;/div&amp;gt;                        &amp;lt;div pseudo=&quot;-internal-media-controls-button-spacer&quot;&amp;gt;&amp;lt;/div&amp;gt;                        &amp;lt;div pseudo=&quot;-webkit-media-controls-volume-control-container&quot; class=&quot;closed&quot; style=&quot;&quot;&amp;gt;                            &amp;lt;div pseudo=&quot;-webkit-media-controls-volume-control-hover-background&quot;&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;input type=&quot;range&quot;                                step=&quot;any&quot; max=&quot;1&quot; aria-valuemax=&quot;100&quot; aria-valuemin=&quot;0&quot; aria-label=&quot;volume&quot;                                pseudo=&quot;-webkit-media-controls-volume-slider&quot; aria-valuenow=&quot;100&quot; class=&quot;closed&quot;                                style=&quot;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot; pseudo=&quot;-webkit-media-controls-mute-button&quot;                                aria-label=&quot;wyciszenie&quot; style=&quot;&quot;&amp;gt;                        &amp;lt;/div&amp;gt;&amp;lt;input type=&quot;button&quot; role=&quot;button&quot; aria-label=&quot;wÅ‚Ä…cz tryb obrazu w&amp;amp;nbsp;obrazie&quot;                            pseudo=&quot;-internal-media-controls-picture-in-picture-button&quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;input                            type=&quot;button&quot; pseudo=&quot;-webkit-media-controls-fullscreen-button&quot;                            aria-label=&quot;przejdÅº do peÅ‚nego ekranu&quot; style=&quot;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                            aria-label=&quot;pokaÅ¼ wiÄ™cej opcji sterowania multimediami&quot; title=&quot;wiÄ™cej opcji&quot;                            pseudo=&quot;-internal-media-controls-overflow-button&quot; style=&quot;&quot;&amp;gt;                    &amp;lt;/div&amp;gt;&amp;lt;input type=&quot;range&quot; step=&quot;any&quot; pseudo=&quot;-webkit-media-controls-timeline&quot; max=&quot;12.612&quot;                        aria-label=&quot;pasek czasu odtwarzania filmu 0:00 / 0:12&quot; aria-valuetext=&quot;upÅ‚ynÄ™Å‚o: 0:00&quot;&amp;gt;                &amp;lt;/div&amp;gt;            &amp;lt;/div&amp;gt;            &amp;lt;div role=&quot;menu&quot; aria-label=&quot;Opcje&quot; pseudo=&quot;-internal-media-controls-text-track-list&quot; style=&quot;display: none;&quot;&amp;gt;            &amp;lt;/div&amp;gt;            &amp;lt;div pseudo=&quot;-internal-media-controls-overflow-menu-list&quot; role=&quot;menu&quot; class=&quot;closed&quot; style=&quot;display: none;&quot;&amp;gt;                &amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot; OdtwÃ³rz &quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                        pseudo=&quot;-webkit-media-controls-play-button&quot; tabindex=&quot;-1&quot; aria-label=&quot;odtwÃ³rz&quot; class=&quot;pause&quot;                        style=&quot;display: none;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;OdtwÃ³rz&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot;przejdÅº do peÅ‚nego ekranu PeÅ‚ny ekran &quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                        pseudo=&quot;-webkit-media-controls-fullscreen-button&quot; aria-label=&quot;przejdÅº do peÅ‚nego ekranu&quot;                        tabindex=&quot;-1&quot; style=&quot;display: none;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;PeÅ‚ny ekran&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot;pobierz multimedia Pobierz &quot; class=&quot;animated-1&quot; style=&quot;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                        aria-label=&quot;pobierz multimedia&quot; pseudo=&quot;-internal-media-controls-download-button&quot; tabindex=&quot;-1&quot;                        style=&quot;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;Pobierz&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot; Wycisz &quot; class=&quot;animated-2&quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;input type=&quot;button&quot;                        pseudo=&quot;-webkit-media-controls-mute-button&quot; tabindex=&quot;-1&quot; aria-label=&quot;wyciszenie&quot;                        style=&quot;display: none;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;Wycisz&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot;odtwarzanie na urzÄ…dzeniu zdalnym PrzesyÅ‚aj &quot; class=&quot;animated-1&quot;                    style=&quot;display: none;&quot;&amp;gt;&amp;lt;input pseudo=&quot;-internal-media-controls-cast-button&quot; type=&quot;button&quot;                        aria-label=&quot;odtwarzanie na urzÄ…dzeniu zdalnym&quot; tabindex=&quot;-1&quot; style=&quot;display: none;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;PrzesyÅ‚aj&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot;wyÅ›wietlanie menu napisÃ³w Napisy &quot; class=&quot;animated-0&quot; style=&quot;display: none;&quot;&amp;gt;&amp;lt;input                        aria-label=&quot;wyÅ›wietlanie menu napisÃ³w&quot; type=&quot;button&quot;                        pseudo=&quot;-webkit-media-controls-toggle-closed-captions-button&quot; tabindex=&quot;-1&quot; style=&quot;display: none;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;Napisy&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;label pseudo=&quot;-internal-media-controls-overflow-menu-list-item&quot; role=&quot;menuitem&quot; tabindex=&quot;0&quot;                    aria-label=&quot;wÅ‚Ä…cz tryb obrazu w&amp;amp;nbsp;obrazie Obraz w&amp;amp;nbsp;obrazie &quot; class=&quot;animated-0&quot; style=&quot;&quot;&amp;gt;&amp;lt;input                        type=&quot;button&quot; role=&quot;button&quot; aria-label=&quot;wÅ‚Ä…cz tryb obrazu w&amp;amp;nbsp;obrazie&quot;                        pseudo=&quot;-internal-media-controls-picture-in-picture-button&quot; tabindex=&quot;-1&quot; style=&quot;&quot;&amp;gt;                    &amp;lt;div aria-hidden=&quot;true&quot;&amp;gt;&amp;lt;span&amp;gt;Obraz w&amp;amp;nbsp;obrazie&amp;lt;/span&amp;gt;&amp;lt;/div&amp;gt;                &amp;lt;/label&amp;gt;&amp;lt;/div&amp;gt;        &amp;lt;/div&amp;gt;    &amp;lt;source src=&quot;movie.mp4&quot; type=&quot;video/mp4&quot;&amp;gt;    &amp;lt;source src=&quot;movie.ogg&quot; type=&quot;video/ogg&quot;&amp;gt;&amp;lt;/video&amp;gt;Shadow DOM ukrywa caÅ‚Ä… implementacjÄ™ pod prostym tagiem.DziÄ™ki temu style zaaplikowane do naszego elementu nie wpÅ‚ywajÄ… na inne elementy DOM-u.Wsparcie Shadow DOM przez gÅ‚Ã³wne przeglÄ…darkiÅºrÃ³dÅ‚o: www.webcomponents.org - dostÄ™p: 2019-08-20View Encapsulation w AngularzeDomyÅ›lnie Angular korzysta z wÅ‚asnego kapsuÅ‚kowania stylÃ³w (ViewEncapsulation.Emulated), ale udostÄ™pnia jeszcze 3 inne tryby kapsuÅ‚kowania (w tym jeden deprecated).Aby zmieniÄ‡ domyÅ›lny tryb kapsuÅ‚kowania, wystarczy dodaÄ‡ odpowiedniÄ… opcjÄ™ w dekoratorze @Component, np.:encapsulation: ViewEncapsulation.ShadowDomOmÃ³wimy je na przykÅ‚adzie kodu z projektu demo. Link do repozytoriumProjekt demo skÅ‚ada siÄ™ z 4 komponentÃ³w:  app-root - gÅ‚Ã³wny komponent zawierajÄ…cy w sobie pozostaÅ‚e komponenty  app-red  app-green  app-blueKaÅ¼dy z komponentÃ³w app-red, app-green oraz app-blue skÅ‚ada siÄ™ z jednego paragrafu z odpowiednim kolorem tekstu dla tego elementu. OprÃ³cz tego istniejÄ… 3 branche, po jednym dla kaÅ¼dego z omawianych trybÃ³w, co pozwoli na zobrazowanie nakÅ‚adania siÄ™ oraz kapsuÅ‚kowania stylÃ³w.ViewEncapsulation.NoneBrak kapsuÅ‚kowania, czyli style utworzone w komponencie sÄ… globalne (w sekcji &amp;lt;head&amp;gt;).W tym trybie elementy HTML i odpowiadajÄ…ce im selektory CSS wyglÄ…dajÄ… tak samo jak te, ktÃ³re napisaliÅ›my w kodzie.MoÅ¼e to spowodowaÄ‡ niechciane nadpisywanie stylÃ³w lub dodawanie ich do elementÃ³w, ktÃ³re nie posiadajÄ… Å¼adnego stylu.W przykÅ‚adzie usunÄ™liÅ›my styl paragrafu w komponencie app-green.Link do repozytoriumimport {Component, ViewEncapsulation} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-red&#39;,    template: `        &amp;lt;p&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: red;        }    `],    encapsulation: ViewEncapsulation.None})export class RedComponent {}import {Component, ViewEncapsulation} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-green&#39;,    template: `        &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;    `,    encapsulation: ViewEncapsulation.None})export class GreenComponent {}import {Component, ViewEncapsulation} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-blue&#39;,    template: `        &amp;lt;p&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: blue;        }    `],    encapsulation: ViewEncapsulation.None})export class BlueComponent {}Wynikowy kod HTML:&amp;lt;head&amp;gt;    &amp;lt;style&amp;gt;        p {            color: red;        }    &amp;lt;/style&amp;gt;    &amp;lt;style&amp;gt;        p {            color: blue;        }    &amp;lt;/style&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;    &amp;lt;app-root ng-version=&quot;8.2.2&quot;&amp;gt;        &amp;lt;app-red&amp;gt;            &amp;lt;p&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-red&amp;gt;        &amp;lt;app-green&amp;gt;            &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-green&amp;gt;        &amp;lt;app-blue&amp;gt;            &amp;lt;p&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-blue&amp;gt;    &amp;lt;/app-root&amp;gt;&amp;lt;/body&amp;gt;Wynik widoczny w przeglÄ…darceJak widzimy, style zostaÅ‚y dodane w sekcji &amp;lt;head&amp;gt;, co spowodowaÅ‚o nadpisanie pierwszego stylu paragrafu drugim - color: blue. W efekcie wszystkie paragrafy majÄ… ten sam kolor, rÃ³wnieÅ¼ paragraf z komponentu app-green, ktÃ³ry nie posiada Å¼adnego stylu i powinien mieÄ‡ kolor domyÅ›lny.ViewEncapsulation.Emulated (default)DomyÅ›lny tryb kapsuÅ‚kowania w Angularze, w ktÃ³rym style sÄ… domkniÄ™te w komponencie.W tym trybie style rÃ³wnieÅ¼ znajdujÄ… siÄ™ w sekcji &amp;lt;head&amp;gt;, ale posiadajÄ… dodatkowe atrybuty ktÃ³re wiÄ…Å¼Ä… je z elementami HTML pochodzÄ…cymi z tego samego komponentu.DziÄ™ki temu na stronie moÅ¼e istnieÄ‡ kilka komponentÃ³w zawierajÄ…cych element tego samego typu, ale z rÃ³Å¼nymi stylami.Uwaga! W tym trybie style nie majÄ… wpÅ‚ywu na inne elementy na stronie (jednak mogÄ… mieÄ‡ wpÅ‚yw na elementy komponentu dziecka - jeÅ›li komponent dziecka posiada tryb kapsuÅ‚kowania inny niÅ¼ Shadow DOM), poniewaÅ¼ sÄ… domkniÄ™te unikalnymi atrybutami. Globalne style strony (oraz style innych komponentÃ³w, ktÃ³re majÄ… wyÅ‚Ä…czony tryb kapsuÅ‚kowania) mogÄ… jednak mieÄ‡ wpÅ‚yw na ten komponent.W przykÅ‚adzie przenieÅ›liÅ›my komponent app-green z komponentu app-root do komponentu app-blue i usunÄ™liÅ›my jego style.Link do repozytoriumimport {Component} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-red&#39;,    template: `        &amp;lt;p&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: red;        }    `]})export class RedComponent {}import {Component} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-green&#39;,    template: `        &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;    `})export class GreenComponent {}import {Component} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-blue&#39;,    template: `        &amp;lt;app-green&amp;gt;&amp;lt;/app-green&amp;gt;        &amp;lt;p&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: blue;        }    `]})export class BlueComponent {}Wynikowy kod HTML:&amp;lt;head&amp;gt;    &amp;lt;style&amp;gt;        p[_ngcontent-pes-c0] {            color: red;        }    &amp;lt;/style&amp;gt;    &amp;lt;style&amp;gt;        p[_ngcontent-pes-c1] {            color: blue;        }    &amp;lt;/style&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;    &amp;lt;app-root ng-version=&quot;8.2.2&quot;&amp;gt;        &amp;lt;app-red _nghost-pes-c0&amp;gt;            &amp;lt;p _ngcontent-pes-c0&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-red&amp;gt;        &amp;lt;app-blue _nghost-pes-c1&amp;gt;            &amp;lt;app-green _ngcontent-pes-c1&amp;gt;                &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;            &amp;lt;/app-green&amp;gt;            &amp;lt;p _ngcontent-pes-c1&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-blue&amp;gt;    &amp;lt;/app-root&amp;gt;&amp;lt;/body&amp;gt;Wynik widoczny w przeglÄ…darceDomyÅ›lny tryb pozwoliÅ‚ nam odseparowaÄ‡ style miÄ™dzy poszczegÃ³lnymi komponentami. W kodzie wynikowym widzimy, Å¼e style z komponentu rodzica app-blue nie zostaÅ‚y zaaplikowane do komponentu dziecka app-green, w efekcie czego paragraf ma kolor domyÅ›lny. StaÅ‚o siÄ™ tak, poniewaÅ¼ Angular dodaÅ‚ atrybut do stylu. GdybyÅ›my dodali styl w runtime, to zostaÅ‚by zaaplikowany rÃ³wnieÅ¼ do komponentu dziecka.Na przykÅ‚adzie komponentu app-red - Angular dodaÅ‚ atrybut _ngcontent-pes-c0 do selektora CSS oraz elementu HTML. W ten sposÃ³b style dodane w sekcji &amp;lt;head&amp;gt; aplikujÄ… siÄ™ tylko do odpowiednich elementÃ³w z tego samego komponentu. OprÃ³cz tego, na komponencie dodany zostaÅ‚ atrybut _nghost-pes-c0. Z czego skÅ‚adajÄ… siÄ™ te atrybuty?  _ngcontent - okreÅ›la typ elementu, w tym przypadku zawartoÅ›Ä‡ komponentu  _nghost - okreÅ›la element root komponentu  -pes - oznacza ID aplikacji (APP_ID), jeÅ›li nie zostaÅ‚ ustawiony to zostanie przyjÄ™ty wygenerowany ciÄ…g znakÃ³w - dziÄ™ki temu nie nakÅ‚adajÄ… siÄ™ style miÄ™dzy rÃ³Å¼nymi aplikacjami wyÅ›wietlanymi w jednym oknie  -c0 - numeruje kolejno elementy w komponencieViewEncapsulation.ShadowDomKapsuÅ‚kowanie oparte na Shadow DOM (wymaga wsparcia przeglÄ…darki dla Shadow DOM).W tym trybie style nie sÄ… dodawane w sekcji &amp;lt;head&amp;gt;, a istniejÄ… w Shadow Root.Uwaga! W tym trybie style nie majÄ… wpÅ‚ywu na inne elementy na stronie (jednak mogÄ… mieÄ‡ wpÅ‚yw na elementy komponentu dziecka - jeÅ›li komponent dziecka posiada tryb kapsuÅ‚kowania inny niÅ¼ Shadow DOM). Globalne style strony (oraz style innych komponentÃ³w) rÃ³wnieÅ¼ nie majÄ… wpÅ‚ywu na ten komponent.W przykÅ‚adzie przenieÅ›liÅ›my komponent app-green z komponentu app-root do komponentu app-blue, usunÄ™liÅ›my jego style i ustawiliÅ›my domyÅ›lny tryb kapsuÅ‚kowania.Link do repozytoriumimport {Component, ViewEncapsulation} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-red&#39;,    template: `        &amp;lt;p&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: red;        }    `],    encapsulation: ViewEncapsulation.ShadowDom})export class RedComponent {}import {Component} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-green&#39;,    template: `        &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;    `})export class GreenComponent {}import {Component, ViewEncapsulation} from &#39;@angular/core&#39;;@Component({    selector: &#39;app-blue&#39;,    template: `        &amp;lt;app-green&amp;gt;&amp;lt;/app-green&amp;gt;        &amp;lt;p&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;    `,    styles: [`        p {            color: blue;        }    `],    encapsulation: ViewEncapsulation.ShadowDom})export class BlueComponent {}Wynikowy kod HTML:&amp;lt;head&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;    &amp;lt;app-root ng-version=&quot;8.2.2&quot;&amp;gt;        &amp;lt;app-red&amp;gt;            #shadow-root            &amp;lt;style&amp;gt;                p {                    color: red;                }            &amp;lt;/style&amp;gt;            &amp;lt;p&amp;gt;Red paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-red&amp;gt;        &amp;lt;app-blue&amp;gt;            #shadow-root            &amp;lt;style&amp;gt;                p {                    color: blue;                }            &amp;lt;/style&amp;gt;            &amp;lt;app-green&amp;gt;                &amp;lt;p&amp;gt;Green paragraph!&amp;lt;/p&amp;gt;            &amp;lt;/app-green&amp;gt;            &amp;lt;p&amp;gt;Blue paragraph!&amp;lt;/p&amp;gt;        &amp;lt;/app-blue&amp;gt;    &amp;lt;/app-root&amp;gt;&amp;lt;/body&amp;gt;Wynik widoczny w przeglÄ…darceTryb Shadow DOM rÃ³wnieÅ¼ pozwoliÅ‚ nam odseparowaÄ‡ style miÄ™dzy poszczegÃ³lnymi komponentami. W sekcji &amp;lt;head&amp;gt; nie ma juÅ¼ Å¼adnych stylÃ³w, natomiast sÄ… ukryte w Shadow Root elementÃ³w DOM-u. Na przykÅ‚adzie widzimy, Å¼e style z komponentu rodzica app-blue zostaÅ‚y zaaplikowane do komponentu dziecka app-green, w efekcie czego paragraf ma kolor niebieski. Gdyby komponent app-green rÃ³wnieÅ¼ posiadaÅ‚ tryb ViewEncapsulation.ShadowDom, to style rodzica nie zostaÅ‚yby zaaplikowane, poniewaÅ¼ korzystaÅ‚by ze stylÃ³w z wÅ‚asnego Shadow Root. Tryb Shadow DOM zabezpiecza nasz komponent rÃ³wnieÅ¼ przed stylami z komponentu rodzica, dodanymi w runtime.ViewEncapsulation.NativeDo niedawna zamiast ViewEncapsulation.ShadowDom dostÄ™pny byÅ‚ tryb ViewEncapsulation.Native.DziaÅ‚aÅ‚ on w podobny sposÃ³b, ale zostaÅ‚ wycofany z powodu wykorzystywania przestarzaÅ‚ego standardu Shadow DOM.PodsumowanieOgÃ³lnie rzecz biorÄ…c, powinniÅ›my unikaÄ‡ braku kapsuÅ‚kowania stylÃ³w, poniewaÅ¼ powoduje to czÄ™sto niechciane efekty.Tryb Shadow DOM zapewnia caÅ‚kowite domkniÄ™cie stylÃ³w w komponencie, dziÄ™ki czemu style globalne oraz inne komponenty nie majÄ… na niego wpÅ‚ywu, tak samo jak komponent w tym trybie nie ma wpÅ‚ywu na inne komponenty na stronie (za wyjÄ…tkiem komponentÃ³w dzieci ktÃ³re majÄ… wÅ‚Ä…czony tryb kapsuÅ‚kowania inny niÅ¼ Shadow DOM).Niestety nie wszystkie przeglÄ…darki mogÄ… wspieraÄ‡ ten tryb, dlatego Angular domyÅ›lnie udostÄ™pniÅ‚ wÅ‚asny, emulowany tryb kapsuÅ‚kowania. W trybie domyÅ›lnym na nasz komponent majÄ… jednak wpÅ‚yw style globalne, a takÅ¼e mogÄ… mieÄ‡ wpÅ‚yw inne komponenty, poniewaÅ¼ komponent w tym trybie nadal wykorzystuje style z sekcji &amp;lt;head&amp;gt;. W wiÄ™kszoÅ›ci przypadkÃ³w tryb domyÅ›lny jest wystarczajÄ…cy, wiÄ™c jeÅ›li zaleÅ¼y nam na jak najlepszym wsparciu przeglÄ…darek i nie mamy problemÃ³w z nadpisywaniem stylÃ³w przez inne komponenty lub aplikacje, to moÅ¼emy z powodzeniem z niego korzystaÄ‡.Musimy jednak pamiÄ™taÄ‡, Å¼e mieszanie rÃ³Å¼nych trybÃ³w kapsuÅ‚kowania miÄ™dzy komponentami rÃ³wnieÅ¼ moÅ¼e spowodowaÄ‡ niezamierzone efekty.",
"url": "/2019/08/22/view-encapsulation-w-angularze.html",
"author": "MichaÅ‚ Hoja",
"authorUrl": "/authors/mhoja.html",
"image": "mhoja.jpg",
"highlight": "/assets/img/posts/2019-08-22-view-encapsulation-w-angularze/View-Encapsulation.jpg",
"date": "22-08-2019",
"path": "pl/2019-08-22-view-encapsulation-w-angularze"
}
,


"2019-08-06-angular-onpush-strategy-html": {
"title": "Angular - detekcja zmian strategiÄ… onPush",
"lang": "pl",
"tags": "angular frontend",
"content": "KaÅ¼da aplikacja rozwijana odpowiednio dÅ‚ugi czas moÅ¼e rozrosnÄ…Ä‡ siÄ™Â do ogromnych rozmiarÃ³w, a konkretniej do sporej liczby komponentÃ³w, jeÅ¼eli mÃ³wimy o aplikacji frontendowej pisanej z wykorzystaniem Angulara. Z czasem przyrost kolejnych funkcjonalnoÅ›ci moÅ¼e spowodowaÄ‡, Å¼e nasz produkt przestanie speÅ‚niaÄ‡ oczekiwania odnoÅ›nie wydajnoÅ›ci. W takim momencie powinniÅ›my pomyÅ›leÄ‡ nad moÅ¼liwoÅ›ciami naprawy tego problemu. W tym artykule pokaÅ¼emy jedno z moÅ¼liwych rozwiÄ…zaÅ„ tego problemu - zmiana strategii detekcji zmian.Detekcja zmianZaÅ‚Ã³Å¼my, Å¼e mamy przed sobÄ… kod aplikacji odpowiedzialnej za zarzÄ…dzanie hodowlÄ… zwierzÄ…t. PrzykÅ‚adowym komponentem odpowiedzialnym za wyÅ›wietlanie informacji o krÃ³wkach byÅ‚by cow-run.component, czyli wybieg krÃ³wek, ktÃ³ry przekazuje obiekt pojedynczej krÃ³wki do cow.component. Z drugiej strony mamy pig-run.component, ktÃ³ry speÅ‚nia te same zaÅ‚oÅ¼enia co komponent krÃ³wek. PrzykÅ‚adowe drzewo komponentÃ³w mogÅ‚oby wyglÄ…daÄ‡ tak:Angular dla kaÅ¼dego komponentu tworzy odpowiadajÄ…cy jemu (komponentowi) ChangeDetector. PrzejdÅºmy dalej, czyli jak to dziaÅ‚a?Jak to dziaÅ‚a?DomyÅ›lnie ChangeDetector nasÅ‚uchuje na kaÅ¼dÄ… zmianÄ™ stanu aplikacji - zmianÄ™ inputÃ³w, zmianÄ™ modelu prezentowanego na templatce, wywoÅ‚ania asynchroniczne, zdarzenia DOM, interwaÅ‚y. KaÅ¼da taka zmiana powoduje porÃ³wnanie obecnie prezentowanych w drzewie DOM wartoÅ›ci do tych, ktÃ³re przechowuje komponent - w momencie wykrycia rÃ³Å¼nic komponent oznaczany jest jako â€œbrudnyâ€ - proces ten nazywa siÄ™ â€œdirty checkingâ€. NastÄ™pnie dokonywana jest projekcja modelu na drzewo DOM, czyli faktyczne zaktualizowanie widoku.Detekcja zmian w kaÅ¼dym Å›wieÅ¼o utworzonym komponencie ustawiona jest na wartoÅ›Ä‡ ChangeDetectionStrategy.Default, co przekÅ‚ada siÄ™ na detekcjÄ™ zmian strategiÄ… CheckAlways. Strategia ta sprawia, Å¼e podczas kaÅ¼dej zmiany stanu aplikacji - asynchronicznego zapytania wysyÅ‚anego do serwera, zdarzenia DOM, interakcji uÅ¼ytkownika z naszÄ… aplikacjÄ… sprawdzane jest caÅ‚e drzewo komponentÃ³w. WyobraÅºmy sobie sytuacjÄ™, kiedy zdarzenie DOM zostaÅ‚o wyemitowane przez CowComponent. Angular zanim sprawdziÅ‚by komponent, ktÃ³ry faktycznie wyemitowaÅ‚ zdarzenie, musiaÅ‚by sprawdziÄ‡ wszystkie komponenty, zgodnie z utworzonym przez siebie drzewem. SpÃ³jrzmy na obrazek:StrzaÅ‚ki obrazujÄ… kierunek przechodzenia przez drzewo mechanizmu detekcji. Jest to prosty przykÅ‚ad, gdyÅ¼ drzewo jest bardzo maÅ‚e. WyobraÅºmy sobie jednak drzewo zbudowane z setek komponentÃ³w. Z kaÅ¼dÄ… zmianÄ… Angular musiaÅ‚by na nowo przeszukaÄ‡ caÅ‚e drzewo komponentÃ³w celem znalezienia tego komponentu, ktÃ³ry wyemitowaÅ‚ zmianÄ™. DoÅ›Ä‡ sporo obliczeÅ„, czyÅ¼ nie?Strategia onPushNa szczÄ™Å›cie Angular pozwala nam na zmianÄ™ domyÅ›lnej strategii detekcji zmian. JeÅ¼eli nie chcemy korzystaÄ‡ z domyÅ›lnego mechanizmu, to na ratunek przychodzi nam strategia onPush! Strategia ta mÃ³wi nam, Å¼e komponent zaleÅ¼ny jest tylko i wyÅ‚Ä…cznie od swoich inputÃ³w. Taki komponent nazywamy â€œczystymâ€. Zmiana propagowana jest w momencie zmiany referencji inputÃ³w komponentu jak i w przypadku wyemitowania zdarzenia DOM w szablonie komponentu (np. klikniÄ™cie w przycisk - event onclick). Co wiÄ™cej, komponent emitujÄ…cy zmianÄ™ z wykorzystaniem strategii onPush powiadamia mechanizm detekcji Angulara, Å¼e to wÅ‚aÅ›nie on wyemitowaÅ‚ zmianÄ™! To drastycznie zmniejsza koszt przeszukania drzewa komponentÃ³w, gdyÅ¼ Angular wie, ktÃ³rego komponentu szukaÄ‡, albo ktÃ³ry komponent pominÄ…Ä‡. ZdjÄ™cie poniÅ¼ej pozwoli zobrazowaÄ‡ tÄ™ sytuacjÄ™.Jak uÅ¼ywaÄ‡?UÅ¼ywanie takiej strategii wymusza na nas zmiany podejÅ›cia odnoÅ›nie projektowania naszych komponentÃ³w. Inputy czystego komponentu powinny byÄ‡ niezmienialne, co oznacza,Â Å¼e wartoÅ›ci naszych inputÃ³w powinny byÄ‡ aktualizowane przez zmianÄ™ referencji, a nie wartoÅ›ci. Prosty przykÅ‚ad:@Input() cowDonation: { donation: number };onClickUpdateDonation() {    this.cowDonation.donation = 500;}PowyÅ¼sza zmiana nie zadziaÅ‚a, poniewaÅ¼ zmieniamy wartoÅ›Ä‡, a nie referencjÄ™. Aby strategia onPush zadziaÅ‚aÅ‚a, wartoÅ›Ä‡ dotacji musimy zmieniÄ‡ poprzez zmianÄ™ referencji, czyli przykÅ‚adowo:@Input() cowDonation: { donation: number };updateDonation() {    this.cowDonation = {        donation: 500    };}Zdarzenia DOM sÄ… zdarzeniami asynchronicznymi, wiÄ™c moglibyÅ›my wyciÄ…gnÄ…Ä‡ wniosek: detekcja zmian zadziaÅ‚a, kiedy uÅ¼yjemy takich funkcji asynchronicznych jak setTimeout, setInterval albo subskrypcja do Observableâ€™a zwracanego przez serwis HTTP, prawda? OtÃ³Å¼ nie. Na szczÄ™Å›cie w przypadku bytÃ³w typu Observable Angular przychodzi nam z pomocÄ… i udostÄ™pnia AsyncPipe. Dlaczego to dziaÅ‚a z uÅ¼yciem AsyncPipe a nie z manualnÄ… subskrypcjÄ…? Zajrzyjmy wiÄ™c w kod:_updateLatestValue(async, value) {    if (async === this._obj) {        this._latestValue = value;        this._ref.markForCheck();    }}Jak widaÄ‡ powyÅ¼ej, w momencie aktualizacji wartoÅ›ci wywoÅ‚ywana jest funkcja markForCheck(), ktÃ³ra powiadamia mechanizm detekcji zmian o koniecznoÅ›ci sprawdzenia danego komponentu.PrzejÄ™cie kontroli nad mechanizmem detekcji zmianCo w przypadku, gdy bardzo potrzebujemy uÅ¼yÄ‡ funkcji setInterval lub setTimeout, ale jednoczeÅ›nie chcielibyÅ›my rÃ³wnieÅ¼ uÅ¼ywaÄ‡ strategii onPush? Angular daje nam moÅ¼liwoÅ›Ä‡ wstrzykniÄ™cia dedykowanego ChangeDetectora danemu komponentowi, a potem wywoÅ‚anie na nim funkcji markForCheck() - analogicznie jak w opisywanym przykÅ‚adzie z AsyncPipe!PrzykÅ‚adowy kod wyglÄ…daÅ‚by tak:constructor(private cowService: CowService, private changeDetectorRef: ChangeDetectorRef) {    this.updateCowDonationWithTimeout();}private updateCowDonationWithTimeout() {    setTimeout(() =&amp;gt; {        this.cowDonation = {            donation: 500        };        this.changeDetectorRef.markForCheck();    }, 500);}Przy stworzeniu komponentu zostanie wywoÅ‚ana funkcja zmieniajÄ…ca wartoÅ›Ä‡ dotacji dla krowy na 500 po upÅ‚ywie okoÅ‚o 500ms, a wszystko dziÄ™ki wywoÅ‚aniu markForCheck() na referencji do detektora zmian komponentu.Na co naleÅ¼y uwaÅ¼aÄ‡?Przypomnijmy, Å¼e przy korzystaniu ze strategii onPush musimy pamiÄ™taÄ‡ o tym, Å¼e:  zmiany inputÃ³w komponentu muszÄ… zachodziÄ‡ poprzez zmianÄ™ referencji, a nie wartoÅ›ci!  funkcje asynchroniczne (setTimeout, setInterval, manualna subskrypcja do Observableâ€™a) nie wywoÅ‚ujÄ… mechanizmu detekcji zmian.Kilka sÅ‚Ã³w na zakoÅ„czenieOnPush wymusza na nas projektowanie komponentÃ³w w okreÅ›lony sposÃ³b - tak, Å¼eby komponent odpowiedzialny byÅ‚ jedynie za prezentacjÄ™ danych na podstawie otrzymanych inputÃ³w. CaÅ‚a skomplikowana logika mogÅ‚aby wtedy byÄ‡ przeniesiona do serwisÃ³w. Przeniesienie logiki do serwisu umoÅ¼liwiÅ‚oby teÅ¼ Å‚atwiejsze otestowanie kodu - fajnie jest mieÄ‡ jakieÅ› potwierdzenie, Å¼e nasz kod robi to, co powinien :). Pisanie komponentÃ³w niezmienialnych (ang. immutable) i ogÃ³Å‚em kodu opartego na niezmienialnoÅ›ci to tworzenie dobrych przyzwyczajeÅ„, ktÃ³re mogÄ… byÄ‡ wykorzystane przy adaptacji nowych rozwiÄ…zaÅ„ w projekcie - przykÅ‚adowo kontrolowanie stanu z wykorzystaniem biblioteki ngRx, ktÃ³ra rÃ³wnieÅ¼ wymusza na programistach pisanie kodu opartego na niezmienialnoÅ›ci. Stosowanie strategii onPush z pewnoÅ›ciÄ… moÅ¼e zwiÄ™kszyÄ‡ wydajnoÅ›Ä‡ aplikacji, choÄ‡ zalecaÅ‚bym korzystanie z tej strategii w nowo tworzonych komponentach, pisanych od poczÄ…tku z myÅ›lÄ… o niezmienialnoÅ›ci. Wprowadzanie onPushâ€™a na siÅ‚Ä™ do juÅ¼ istniejÄ…cych, czasami mocno rozbudowanych komponentÃ³w moÅ¼e doprowadziÄ‡ do niepoÅ¼Ä…danych zachowaÅ„ (a w tym przypadku braku reakcji na zmiany :P), wiÄ™c trzeba wziÄ…Ä‡ to pod uwagÄ™ adaptujÄ…c tÄ™ strategiÄ™ do juÅ¼ istniejÄ…cego kodu.",
"url": "/2019/08/06/angular-onpush-strategy.html",
"author": "Konrad Gabara",
"authorUrl": "/authors/kgabara.html",
"image": "kgabara.jpg",
"highlight": "/assets/img/posts/2019-05-29-angular-onpush-strategy/angular-onpush.jpeg",
"date": "06-08-2019",
"path": "pl/2019-05-29-angular-onpush-strategy"
}
,


"2019-07-26-testy-frontendu-okiem-full-stacka-html": {
"title": "Testy jednostkowe frontendu okiem programisty full stack",
"lang": "pl",
"tags": "unit test jasmine angular",
"content": "NieÅ‚atwo znaleÅºÄ‡ wymÃ³wkÄ™, Å¼eby nie pisaÄ‡ testÃ³w jednostkowych. ObecnoÅ›Ä‡ frameworkÃ³w uÅ‚atwiajÄ…cych tÄ™ czynnoÅ›Ä‡ w projektach, z ktÃ³rymi stykamy siÄ™ na co dzieÅ„, nie powinna na Å¼adnym chociaÅ¼ trochÄ™ doÅ›wiadczonym programiÅ›cie robiÄ‡ wraÅ¼enia i nie trzeba go przekonywaÄ‡, Å¼e jedne z wielu zalet pisania testÃ³w jednostkowych, to:  zmuszenie twÃ³rcy do zastanowienia siÄ™ nad zadaniem sprawdzanego kodu (co moÅ¼e potencjalnie poprawiÄ‡ design aplikacji),  uÅ‚atwienie wczesnego wyÅ‚apywania bÅ‚Ä™dÃ³w,  ekspozycja przypadkÃ³w brzegowych,  uÅ‚atwienie zrozumienia dziaÅ‚ania kodu osobom, ktÃ³re go nie tworzyÅ‚y.W wielu nowoczesnych aplikacjach internetowych, w tym np. we wnioskach Eximee, duÅ¼a czÄ™Å›Ä‡ logiki znajduje siÄ™ po stronie klienckiej, hipokryzjÄ… byÅ‚oby pominiÄ™cie testÃ³w w tak istotnym elemencie aplikacji, poniewaÅ¼ najbardziej rzucajÄ…ce siÄ™ w oczy bÅ‚Ä™dy sÄ… wÅ‚aÅ›nie tam. Niemniej nawet przy ogromnej liczbie narzÄ™dzi wspomagajÄ…cych proces pisania testÃ³w jednostkowych, programiÅ›ci mogÄ… mieÄ‡ problem z wyznaczeniem wÅ‚aÅ›nie tych jednostek.Co testowaÄ‡NiezaleÅ¼nie od tego jaki framework zostaÅ‚ uÅ¼yty w danym projekcie, zawsze moÅ¼emy z niego wydzieliÄ‡ komponenty. PrzewaÅ¼nie jest to JavaScriptowa klasa z jakimÅ› odniesieniem do szablonu HTML. Akurat w tym artykule jako przykÅ‚ad uÅ¼yty zostaÅ‚ Angular. W praktyce moÅ¼emy podzieliÄ‡ te komponenty na dwa typy:  komponent prezentacyjny, ktÃ³ry nie posiada logiki biznesowej i jego jedynymi zadaniami sÄ… wyÅ›wietlenie szablonu na podstawie wejÅ›cia i ew. przekazanie jakiegoÅ› zdarzenia (np. klikniÄ™cia, wciÅ›niÄ™cia klawisza itp.) do komponentu nadrzÄ™dnego,  komponent, ktÃ³ry uÅ¼ywa i zarzÄ…dza innymi komponentami nie zajmujÄ…c siÄ™ jednoczeÅ›nie prezentacjÄ….Brak tego podziaÅ‚u moÅ¼e znaczÄ…co utrudniÄ‡ pisanie testÃ³w jednostkowych, co zresztÄ… okaÅ¼e siÄ™ bardzo szybko przy prÃ³bie napisania ich do sÅ‚abo zaprojektowanego komponentu.UwaÅ¼am, Å¼e testy jednostkowe komponentÃ³w prezentacyjnych sÄ… zasadne tylko w przypadku, gdy wejÅ›cie w jakiÅ› sposÃ³b zmienia jego zachowanie lub obsÅ‚uga uaktualnienia widoku jest skomplikowana (np. animacja przeliczajÄ…c atrybuty elementu w locie). NajwaÅ¼niejsze jest zwiÄ™kszenie pokrycia logiki biznesowej.Testowanie logiki biznesowejW pierwszej kolejnoÅ›ci powinniÅ›my siÄ™ zastanowiÄ‡ nad tym, czy z komponentu moÅ¼emy wydzieliÄ‡ logikÄ™, np. do osobnego serwisu, czyli w praktyce klasy odpowiedzialnej za jakÄ…Å› funkcjonalnoÅ›Ä‡ z moÅ¼liwoÅ›ciÄ… uÅ¼ywania jej w wielu miejsciach (np. serwis zarzÄ…dzajÄ…cy widocznoÅ›ciÄ… popupÃ³w w aplikacji). Serwisy testuje siÄ™ o wiele proÅ›ciej niÅ¼ komponenty, ze wzglÄ™du na brak szablonu i zwiÄ…zanego z frameworkiem narzutu (serwis moÅ¼e byÄ‡Â zwykÅ‚Ä… JavaScriptowÄ… klasÄ…).Praktyka na przykÅ‚adzie Jasmine i AngularaNiech przykÅ‚adem bÄ™dzie komponent wyboru daty z formatterem - zakÅ‚adajÄ…c, Å¼e caÅ‚a logika znajduje siÄ™ w komponencie, trzeba bÄ™dzie zadbaÄ‡ o stworzenie jego instancji ze wszystkimi zaleÅ¼noÅ›ciami piszÄ…c testy dla formattera, nastÄ™pnie zasymulowaÄ‡ zdarzenie wpisania danych w pole tekstowe. Gdyby wydzielono wczeÅ›niej osobny serwis do formatowania, to wystarczyÅ‚oby przetestowaÄ‡ tylko jego logikÄ™. Testy caÅ‚ego komponentu moÅ¼emy przeprowadziÄ‡ zaÅ›lepiajÄ…c odpowiednie zaleÅ¼noÅ›ci, co znacznie uÅ‚atwi pracÄ™.Tak wyglÄ…daÅ‚by komponent, jeÅ›li zaniedbalibyÅ›my wyÅ¼ej zaproponowany podziaÅ‚:Komponent@Component({    selector: &#39;date-picker&#39;,    template: `        &amp;lt;input [value]=&quot;formattedValue&quot; (change)=&quot;onValueChange($event.target.value)&quot;&amp;gt;    `})export class DatePicker implements OnChanges  {    @Input() value: string;    formattedValue: string;    constructor(private datePickerRestService: DatePickerRestService) {    }        ngOnChanges(changes: SimpleChanges): void {        this.formattedValue = this.format(changes.value.currentValue);    }     onValueChange(event: string): void {        ...    }    private format(string: value): string {        ...    }        private sendValue(value: string): void {       this.datePickerRestService.send(value);    }}Testlet fixture: ComponentFixture&amp;lt;DatePicker&amp;gt;;describe(&#39;DatePicker&#39;, () =&amp;gt; {    class DatePickerRestServiceMock implements Partial&amp;lt;DatePickerRestService&amp;gt; {        send(): void {        }    }    beforeEach(() =&amp;gt; {        TestBed.configureTestingModule({            declarations: [DatePicker],            providers: [              {                  provide: DatePickerRestService,                  useClass: DatePickerRestServiceMock              }            ]        });        fixture = TestBed.createComponent(DatePicker);    });    it(&#39;should return formatted date from timestamp&#39;, () =&amp;gt; {        // given        const hostElement = fixture.nativeElement;        const input: HTMLInputElement = hostElement.querySelector(&#39;input&#39;);        // when        fixture.componentInstance.value = &#39;2018-07-01&#39;;        fixture.detectChanges();        // then        expect(input.value).toBe(&#39;1 lipca 2018&#39;);    });});Jak widaÄ‡ testy sÄ… sÅ‚abo czytelne, poniewaÅ¼ widoczne sÄ… detale implementacyjne zwiÄ…zane z dziaÅ‚aniem frameworku (TestBed, ComponentFixture). Wraz z dodawaniem funkcjonalnoÅ›ci i zaleÅ¼noÅ›ci coraz trudniej bÄ™dzie utrzymaÄ‡ klarownoÅ›Ä‡.Zaprojektowany w ten sposÃ³b komponent pozwoli na przetestowanie gÅ‚Ã³wnej funkcjonalnoÅ›ci nie przejmujÄ…c siÄ™ zaleÅ¼noÅ›ciami komponentu i jego szablonem.Komponent@Component({    selector: &#39;date-picker&#39;,    template: `        &amp;lt;date-picker-input [value]=&quot;formattedValue&quot; (change)=&quot;onValueChange($event)&quot;&amp;gt;&amp;lt;/date-picker-input&amp;gt;    `})export class DatePicker implements OnChanges  {    @Input() value: string;    formattedValue: string;    constructor(private service: FormatterService ) {    }        ngOnChanges(changes: SimpleChanges): void {        this.formattedValue = this.service.format(changes.value.currentValue);    }    onValueChange(event: string): void {        // ...    }}Test serwisu formattera mÃ³gÅ‚by wyglÄ…daÄ‡ nastÄ™pujÄ…co:Testdescribe(&#39;FormatterService&#39;, () =&amp;gt; {   beforeEach(() =&amp;gt; {      service = new FormatterService();   });   it(&#39;should return formatted date from timestamp&#39;, () =&amp;gt; {      // given      const timestamp: string = Date.now(&#39;2018-07-01&#39;).toString();       // when      const result = service.format(timestamp);      // then      expect(result).toBe(&#39;1 lipca 2018&#39;);   });});Nie trzeba siÄ™ martwiÄ‡ o dodatkowe zaleÅ¼noÅ›ci, moÅ¼na siÄ™ skupiÄ‡ tylko na testowaniu funkcjonalnoÅ›ci.Jak widaÄ‡ przy odpowiednim podejÅ›ciu pisanie testÃ³w jednostkowych funkcjonalnoÅ›ci na frontendzie nie musi siÄ™ tak bardzo rÃ³Å¼niÄ‡ od tworzenia ich dla czÄ™Å›ci backendowej gdy wie siÄ™ co i w jaki sposÃ³b testowaÄ‡, wtedy samo pisanie testÃ³w staje siÄ™Â o wiele prostsze.",
"url": "/2019/07/26/testy-frontendu-okiem-full-stacka.html",
"author": "Marcin Mendlik",
"authorUrl": "/authors/mmendlik.html",
"image": "mmendlik.jpg",
"highlight": "/assets/img/posts/2019-07-25-testy-frontendu-okiem-full-stacka/testy-jednostkowe.jpg",
"date": "26-07-2019",
"path": "pl/2019-07-25-testy-frontendu-okiem-full-stacka"
}
,


"2019-07-12-10-praw-uzytecznego-designu-html": {
"title": "10 praw uÅ¼ytecznego designu",
"lang": "pl",
"tags": "ux ui design",
"content": "W latach 80. Dieter Rams zagubiony w chaosie form i kolorÃ³w postanowiÅ‚ coÅ› z tym zrobiÄ‡. DoszedÅ‚ do wniosku, Å¼e dobry design nie moÅ¼e trzymaÄ‡ siÄ™ sztywnych ram, ale opierajÄ…c siÄ™ na pewnych reguÅ‚ach, moÅ¼na stworzyÄ‡ dobry produkt. IdÄ…c tym tokiem rozumowania opracowaÅ‚ 10 reguÅ‚ dobrego designu, ktÃ³re w branÅ¼y zdÄ…Å¼yÅ‚y urosnÄ…Ä‡ do rangi dziesiÄ™ciu przykazaÅ„, a on sam uchodzi dziÅ› za jednego z najlepszych i najbardziej wpÅ‚ywowych projektantÃ³w XX wieku.ChoÄ‡ Å›wiat UX designu nie doczekaÅ‚ siÄ™ swojego Ramsa nie oznacza to, Å¼e projektanci interfejsÃ³w i doÅ›wiadczeÅ„ uÅ¼ytkownikÃ³w zostali pozostawieni na pastwÄ™ losu. Jak siÄ™ sami za chwilÄ™ przekonacie, niezliczone iloÅ›ci badaÅ„ na przestrzeni ostatnich kilkudziesiÄ™ciu lat zaowocowaÅ‚y caÅ‚kiem pokaÅºnÄ… listÄ… maksym i reguÅ‚.1. Efekt â€estetycznej funkcjonalnoÅ›ciâ€W latach 90 zeszÅ‚ego stulecia Masaaki Kurosu i Kaori Kashimura postanowili zbadaÄ‡ wpÅ‚yw atrakcyjnoÅ›ci estetycznej na sposÃ³b, w jaki postrzega siÄ™ funkcjonalnoÅ›Ä‡. W tym celu poprosili 252 uczestnikÃ³w badania o to, aby ocenili 26 rÃ³Å¼nych bankomatÃ³w, pod kÄ…tem tego, ktÃ³ry z nich jest najÅ‚atwiejszy w obsÅ‚udze, a ktÃ³ry najÅ‚adniejszy. DziÄ™ki temu Masaki i Kaori zaobserwowali, Å¼e istnieje pewna korelacja - im coÅ› jest piÄ™kniejsze, tym jest bardziej uÅ¼yteczne. Dodatkowo piÄ™kny wyglÄ…d sprawia, Å¼e jesteÅ›my skÅ‚onni wybaczyÄ‡ drobne bÅ‚Ä™dy uÅ¼ytecznoÅ›ci, czar jednak pryska jak baÅ„ka mydlana, gdy natrafimy na duÅ¼Ä… wadÄ™ jak np. brak moÅ¼liwoÅ›ci zÅ‚oÅ¼enia zamÃ³wienia.SprÃ³bujcie przypomnieÄ‡ sobie sytuacjÄ™, kiedy musieliÅ›cie podjÄ…Ä‡ decyzjÄ™ i wybraÄ‡ produkt spoÅ›rÃ³d kilku dostÄ™pnych? JeÅ›li wybraliÅ›cie coÅ› tylko dlatego, Å¼e miaÅ‚o Å‚adnÄ… etykietÄ™, to wÅ‚aÅ›nie ulegliÅ›cie efektowi estetycznej funkcjonalnoÅ›ci :)Rys. 1. Strona gÅ‚Ã³wna firmy AppleÅºrÃ³dÅ‚o: apple.com - dostÄ™p: 2019-07-072. Prawo JakobaJakob Nielsen, jeden z czoÅ‚owych specjalistÃ³w w dziedzinie uÅ¼ytecznoÅ›ci, a takÅ¼e zaÅ‚oÅ¼yciel Nielsen Norman Group zauwaÅ¼yÅ‚, Å¼e uÅ¼ytkownicy spÄ™dzajÄ… wiÄ™kszoÅ›Ä‡ czasu na innych stronach. Oznacza to, Å¼e uÅ¼ytkownicy wolÄ…, aby Twoja strona dziaÅ‚aÅ‚a tak samo, jak wszystkie inne witryny, ktÃ³re juÅ¼ znajÄ…. Dobrym przykÅ‚adem wykorzystania tej zasady sÄ… sklepy sprzedajÄ…ce odzieÅ¼ i obuwie on-line.JeÅ›li strona wyglÄ…da podobnie do innych, to wtedy uÅ¼ytkownicy bÄ™dÄ… z Å‚atwoÅ›ciÄ… umieli siÄ™ po niej poruszaÄ‡, skupiajÄ…c siÄ™ na oferowanych produktach.Rys. 2. Wybrany produkt w sklepie on-line marki KazarÅºrÃ³dÅ‚o: kazar.com - dostÄ™p: 2019-07-07Rys. 3. Wybrany produkt w sklepie on-line marki Gino RossiÅºrÃ³dÅ‚o: gino-rossi.com - dostÄ™p: 2019-07-073. Efekt izolacjiW 1933 roku Hedwig von Restorff odkryÅ‚a, Å¼e przy uczeniu siÄ™ listy bezsensownych sÅ‚Ã³w Å‚atwiej zapamiÄ™tuje siÄ™ te, ktÃ³re w jakiÅ› sposÃ³b wyrÃ³Å¼niajÄ… siÄ™ spoÅ›rÃ³d innych, na przykÅ‚ad sÄ… napisane wiÄ™kszymi literami lub majÄ… inny kolor. Jak siÄ™ juÅ¼ pewnie domyÅ›lacie, ta zasada oprÃ³cz tego, Å¼e Å›wietnie nadajÄ™ siÄ™ jako pomoc w nauce na jutrzejszÄ… kartkÃ³wkÄ™ z biologii, to rÃ³wnieÅ¼ znajduje zastosowanie w dziedzinie uÅ¼ytecznoÅ›ci. Przyjrzyjmy siÄ™ chociaÅ¼by Material Design, czyli jednemu z najpopularniejszych obecnie trendÃ³w w tworzeniu interfejsÃ³w. Jednym z charakterystycznych elementÃ³w tego stylu jest okrÄ…gÅ‚y przycisk, ktÃ³ry pÅ‚ywa przypiÄ™ty w jednym miejscu (zazwyczaj jest to prawy dolny rÃ³g ekranu) i pojawia siÄ™Â ponad innymi elementami. Taki przycisk odpowiada za najwaÅ¼niejszÄ… akcjÄ™ na ekranie. JeÅ›li chcemy zwrÃ³ciÄ‡ uwagÄ™ uÅ¼ytkownika na dany element strony wyrÃ³Å¼nijmy go na tle innych obiektÃ³w.Rys. 4. Floating Action Button wykonuje gÅ‚Ã³wnÄ… akcjÄ™ w aplikacji z systemem AndroidÅºrÃ³dÅ‚o: material.io - dostÄ™p: 2019-07-074. Efekt ZeigarnikMÃ³wi o tym, Å¼e ludzie pamiÄ™tajÄ… nieukoÅ„czone lub przerwane zadania lepiej niÅ¼ zadania zakoÅ„czone. Bluma Zeigarnik przeprowadziÅ‚a seriÄ™ eksperymentÃ³w sprawdzajÄ…cych zdolnoÅ›Ä‡ do zapamiÄ™tywania rÃ³Å¼nych zadaÅ„. Osoby biorÄ…ce udziaÅ‚ w badaniach proszono o rozwiÄ…zywanie Å‚amigÅ‚Ã³wek. CzÄ™Å›ci z nich przeszkadzano w trakcie wykonywania poleceÅ„, a pozostaÅ‚ym pozwalano w spokoju skoÅ„czyÄ‡. Zeigarnik zauwaÅ¼yÅ‚a, Å¼e czynnoÅ›ci, ktÃ³rych dokoÅ„czenie przerwano, sÄ… o 90% lepiej zapamiÄ™tywane, niÅ¼ te, ktÃ³re moÅ¼na byÅ‚o dokoÅ„czyÄ‡. Ten efekt okreÅ›lany jest jej nazwiskiem i zyskaÅ‚ szerokie zastosowanie, takÅ¼e w dziedzinie uÅ¼ytecznoÅ›ci. Efekt ten wykorzystuje na przykÅ‚ad Udemy, czyli platforma edukacyjna, na ktÃ³rej mamy dostÄ™p do kursÃ³w internetowych przygotowanych przez instruktorÃ³w z caÅ‚ego Å›wiata. JesteÅ›my na stronie zasypywani z kaÅ¼dej strony informacjami o tym, Å¼e kurs gotowania, ktÃ³ry wykupiliÅ›my kilka dni wczeÅ›niej jest ukoÅ„czony w 42%. Taki zabieg sprawia, Å¼e kurs nie daje nam spokoju i chcemy go doprowadziÄ‡ do koÅ„ca.Rys. 5. Strona gÅ‚Ã³wna serwisu UdemyÅºrÃ³dÅ‚o: udemy.com - dostÄ™p: 2019-07-075. Efekt pierwszeÅ„stwa i Å›wieÅ¼oÅ›ciTo tak naprawdÄ™ dwie zasady, mÃ³wiÄ…ce o tym, Å¼e najlepiej zapamiÄ™tujemy to, co znajduje siÄ™ na poczÄ…tku (efekt pierwszeÅ„stwa) oraz na koÅ„cu (efekt Å›wieÅ¼oÅ›ci). Taki zabieg stosuje Allegro, ktÃ³re przedstawia oferty sponsorowane na szczycie i u doÅ‚u listy.Rys. 6. Portal Allegro - Oferty sponsorowane na szczycie listy produktÃ³wÅºrÃ³dÅ‚o: Fotele wiszÄ…ce na Allegro - dostÄ™p: 2019-07-07Rys. 7. Portal Allegro - Oferty sponsorowane na dole listy produktÃ³wÅºrÃ³dÅ‚o: Fotele wiszÄ…ce na Allegro - dostÄ™p: 2019-07-076. Prawo MilleraWedÅ‚ug badaÅ„ opublikowanych w 1956 roku w artykule â€œMagiczna liczba siedem plus minus dwaâ€¦â€ przez Georga A. Millera czÅ‚owiek jest w stanie zapamiÄ™taÄ‡ 7 informacji naraz. Dobrym przykÅ‚adem wykorzystania tego prawa jest serwis Netflix. Po wejÅ›ciu na stronÄ™ gÅ‚Ã³wnÄ… platformy zostaniemy zasypani propozycjami filmÃ³wi i seriali, ktÃ³re z pewnoÅ›ciÄ… umilÄ… nam niedzielny wieczÃ³r. Projektanci serwisu, zadbali o to, abyÅ›my nie zagineli w gÄ…szczu propozycji, zostaÅ‚y one podzielone na kategorie, a kaÅ¼da z nich z kolei kusi 6 pozycjami.Rys. 8. Strona gÅ‚Ã³wna serwisu NetflixÅºrÃ³dÅ‚o: netflix.com - dostÄ™p: 2019-07-077. Prawo TesleraStwierdza, Å¼e dla kaÅ¼dego systemu istnieje pewna zÅ‚oÅ¼onoÅ›Ä‡, ktÃ³rej nie moÅ¼na zmniejszyÄ‡. Zbyt duÅ¼a liczba koniecznych dziaÅ‚aÅ„ moÅ¼e nas skutecznie zniechÄ™ciÄ‡ do skorzystania z niektÃ³rych usÅ‚ug, jak chociaÅ¼by wypeÅ‚nianie mnÃ³stwa pÃ³l formularza w sklepie internetowym podczas zakupu wymarzonej pary butÃ³w. Niestety w przypadku, gdy chcemy zarezerwowaÄ‡ idealne miejsce na weekendowy pobyt, bez podania tych wszystkich informacji jak np. dokÄ…d chcemy lecieÄ‡, na jak dÅ‚ugo czy kiedy planujemy wrÃ³ciÄ‡, system nie domyÅ›li siÄ™, Å¼e chcielibyÅ›my spÄ™dziÄ‡ tydzieÅ„ w igloo na mroÅºnej pÃ³Å‚nocy Norwegii.Rys. 9. Strona gÅ‚Ã³wna serwisu Booking.comÅºrÃ³dÅ‚o: booking.com - dostÄ™p: 2019-07-078. Prawo HickaWilliam Edmund Hick i Ray Hyman przeprowadzili seriÄ™ eksperymentÃ³w, dziÄ™ki ktÃ³rym zaobserwowali, Å¼e im wiÄ™ksza liczba opcji, tym dÅ‚uÅ¼ej bÄ™dziemy podejmowaÄ‡ decyzjÄ™ W zwiÄ…zku z tym rozsÄ…dnÄ… strategiÄ… jest zminimalizowanie alternatyw. Jako przykÅ‚ad moÅ¼e nam posÅ‚uÅ¼yÄ‡ serwis Airbnb, ktÃ³ry podszedÅ‚ do problemu rezerwacji w zupeÅ‚nie inny sposÃ³b niÅ¼ np. Booking.com. Nie musimy od razu wypeÅ‚niaÄ‡ wszystkich informacji - wystarczy, Å¼e wpiszemy miejsce do ktÃ³rego chcemy siÄ™ udaÄ‡, a resztÄ™ wypeÅ‚niamy w trakcie przeglÄ…dania dostÄ™pnych ofert.Rys. 10. Strona gÅ‚Ã³wna serwisu Airbnb.comÅºrÃ³dÅ‚o: airbnb.com - dostÄ™p: 2019-07-079. Prawo FittsaMÃ³wi o tym, Å¼e czas jaki potrzebny jest do wykonania akcji, bÄ™dzie zaleÅ¼ny od wielkoÅ›ci obiektu, z ktÃ³rym mamy wejÅ›Ä‡ w interakcjÄ™ i odlegÅ‚oÅ›ci w jakiej znajduje siÄ™ ten obiekt od uÅ¼ytkownika. MÃ³wiÄ…c inaczej, duÅ¼y przycisk, ktÃ³ry znajduje siÄ™ bliÅ¼ej uÅ¼ytkownika bÄ™dzie prostszy do wciÅ›niÄ™cia, niÅ¼ ten, ktÃ³ry bÄ™dzie maÅ‚y i oddalony.Rys. 11. ZbiÃ³rka na projekt wodoodpornych butÃ³w w serwisie KickstarterÅºrÃ³dÅ‚o: kickstarter.com - dostÄ™p: 2019-07-0710. Prawo bliskoÅ›ciMÃ³wi o tym, Å¼e elementy znajdujÄ…ce siÄ™ blisko siebie traktujemy jako powiÄ…zane ze sobÄ… lub jako jednÄ… caÅ‚oÅ›Ä‡. CzÄ™sto wykorzystuje siÄ™ je w nawigacji. Zgrupowanie linkÃ³w w wierszu lub kolumnie pozwala zinterpretowaÄ‡ uÅ¼ytkownikowi tÄ™ czÄ™Å›Ä‡ serwisu jako jednoÅ›Ä‡. W zasadzie bliskoÅ›ci chodzi o zastosowanie takich efektÃ³w, by uÅ¼ytkownik zrozumiaÅ‚, Å¼e naleÅ¼Ä… do jednej grupy. Taki efekt uzyskamy przez zastosowanie odpowiednio duÅ¼ych odstÄ™pÃ³w czy teÅ¼ umieszczenie ich w ramce.Ryz. 12. Strona gÅ‚Ã³wna AmazonÅºrÃ³dÅ‚o: amazon.com - dostÄ™p: 2019-07-07PodsumowaniePrzedstawiÅ‚em jedynie wybrane prawa spoÅ›rÃ³d 19, ktÃ³re istniejÄ…. ZachÄ™cam do zapoznania siÄ™ z pozostaÅ‚ymi prawami dostÄ™pnymi pod adresem: https://lawsofux.com",
"url": "/2019/07/12/10-praw-uzytecznego-designu.html",
"author": "Piotr Åšwierzko",
"authorUrl": "/authors/pswierzko.html",
"image": "pswierzko.jpg",
"highlight": "/assets/img/posts/2019-07-12-10-praw-uzytecznego-designu/design-w-it.jpg",
"date": "12-07-2019",
"path": "pl/2019-07-12-10-praw-uzytecznego-designu"
}
,


"2019-05-09-node-version-menager-html": {
"title": "KorzyÅ›ci wynikajÄ…ce z uÅ¼ycia Node Version Manager",
"lang": "pl",
"tags": "nvm node",
"content": "JavaScript i caÅ‚y ekosystem z nim zwiÄ…zany jest bardzo rozbudowany i wydaje siÄ™, Å¼e wcale nie zamierza przestaÄ‡ siÄ™ rozrastaÄ‡. MoÅ¼na czasem usÅ‚yszeÄ‡, Å¼e tydzieÅ„, w ktÃ³rym nie powstaÅ‚ nowy framework do JSa jest tygodniem straconym. Masa bibliotek w rÃ³Å¼nych wersjach, kolejne jÄ™zyki rozbudowujÄ…ce moÅ¼liwoÅ›ci JavaScriptu zmieniajÄ…ce to, jak go postrzegamy np.: TypeScript czy CoffeeScript, do tego jeszcze Node.js oraz rÃ³Å¼ne silniki w przeglÄ…darkach. W rezultacie mamy caÅ‚kiem sporÄ… listÄ™ i coraz wiÄ™cej pracy zwiÄ…zanej z zarzÄ…dzaniem tym wszystkim.Dlatego tym bardziej warto zainteresowaÄ‡ siÄ™ rozwiÄ…zaniami, ktÃ³re majÄ… na celu uÅ‚atwiÄ‡ nam Å¼ycie.Jednym z nich jest nvm, czyli Node Version Manager, ktÃ³ry ma nam pomÃ³c zarzÄ…dzaÄ‡ wersjami Node.js.Cel jest prosty - umoÅ¼liwiÄ‡ nam szybkie i Å‚atwe przeskakiwanie miÄ™dzy wersjami Node niewymagajÄ…ce uprawnieÅ„ administratora.Zalety+ instalacja nie wymaga uprawnieÅ„ roota,+ dostÄ™p do wielu wersji Node,+ szybkie i wygodne zmiany wersji noda,+ moÅ¼liwoÅ›Ä‡ wykorzystania rÃ³Å¼nych wersji Node dla rÃ³Å¼nych projektÃ³w.Wady- nvm manipuluje .bashrc,- lag na starcie bash.Podstawowe polecenia nvm      wylistowanie wszystkich dostÄ™pnych wersji    nvm ls-remote        ZwrÃ³ci nam wynik w postaci listy dostÄ™pnych wersji z zaznaczonÄ… obecnie uÅ¼ywanÄ….    v0.1.14...v10.15.0-&amp;gt;  v10.15.1v10.15.2...v12.2.0            instalacja najnowszej wersji Node    nvm install Node        w rezultacie otrzymamy informacje jak poniÅ¼ej    $ nvm install nodeDownloading and installing node v12.2.0...Downloading https://nodejs.org/dist/v12.2.0/node-v12.2.0-linux-x64.tar.xz...######################################################################### 100,0%Computing checksum with sha256sumChecksums matched!Now using node v12.2.0 (npm v6.9.0)            instalacja najnowszej wersji oznaczonej jako Long-term support    nvm install --lts        poniÅ¼ej rezultat     $ nvm install --lts Installing latest LTS version. Downloading and installing node v10.15.3... Downloading https://nodejs.org/dist/v10.15.3/node-v10.15.3-linux-x64.tar.xz... ######################################################################### 100,0% Computing checksum with sha256sum Checksums matched! Now using node v10.15.3 (npm v6.4.1)            instalacja konkretnej wersji Node (po instalacji aktualnie uÅ¼ywanÄ… wersjÄ… jest ta ostatnio zainstalowana)    nvm install {VERSION}        tu rezultat wyglÄ…da bardzo podobnie    $ nvm install 8.6.0Downloading and installing node v8.6.0...Downloading https://nodejs.org/dist/v8.6.0/node-v8.6.0-linux-x64.tar.xz...######################################################################### 100,0%Computing checksum with sha256sumChecksums matched!Now using node v8.6.0 (npm v5.3.0)            przestawienie domyÅ›lnej wersji Node    $ nvm alias default 10.15.1default -&amp;gt; 10.15.1 (-&amp;gt; v10.15.1)            wylistowanie wszystkich zainstalowanych wersji    nvm ls        zwraca nam listÄ™ aktualnie zainstalowanych wersji    v10.15.0-&amp;gt;  v10.15.1v10.15.2            uÅ¼ycie konkretnej wersji    nvm use Node {VERSION}        nvm potwierdzi nam zmianÄ™ wersji    $ nvm use 12.2.0Now using node v12.2.0 (npm v6.9.0)            uruchomienie aplikacji w wybranej wersji Node    nvm run {VERSION} index.js        tu rÃ³wnieÅ¼ nie bÄ™dziemy mieÄ‡ wÄ…tpliwoÅ›ci z jakÄ… wersjÄ… uruchomiliÅ›my aplikacjÄ™    $ nvm run 8.6.0 index.js Running node v8.6.0 (npm v5.3.0)            usuniÄ™cie wybranej wersji Node    nvm uninstall {VERSION}        potwierdzenie usuniÄ™cia    $ nvm uninstall 8.6.0Uninstalled node v8.6.0      Ponadto .nvmrc.Warto pamiÄ™taÄ‡, Å¼e w ramach projektu moÅ¼emy Å‚atwo ustaliÄ‡ jak wersja Node ma byÄ‡ wykorzystywana, a nvm zajmie siÄ™ resztÄ….Do projektu wystarczy dodaÄ‡ plik .nvmrc.  9.0.1i wykonaÄ‡ polecenie  nvm useUwaga na koniecNvm zwiÄ™ksza objÄ™toÅ›Ä‡ pliku .bashrc co spowalnia dziaÅ‚anie terminala, trzeba siÄ™ zastanowiÄ‡ czy na Å›rodowisku produkcyjnym jest to koszt, ktÃ³ry chcemy ponosiÄ‡.Link do projektuhttps://github.com/nvm-sh/nvm/blob/master/README.md",
"url": "/2019/05/09/node-version-menager.html",
"author": "Krzysztof Czechowski",
"authorUrl": "/authors/kczechowski.html",
"image": "kczechowski.jpg",
"highlight": "/assets/img/posts/2019-05-09-node-version-menager/Node-Version-Manager.jpg",
"date": "09-05-2019",
"path": "pl/2019-05-09-node-version-menager"
}
,


"2019-05-06-refactoring-html": {
"title": "PrzykÅ‚ady refaktoryzacji na podstawie ksiÄ…Å¼ki Martina Fowlera i Kenta Becka 'Refactoring'",
"lang": "pl",
"tags": "refaktoryzacja javascript",
"content": "KsiÄ…Å¼ka â€œRefactoringâ€ Martina Fowlera i Kenta Becka zostaÅ‚a po raz pierwszy wydana w 1999 roku i czÄ™sto okreÅ›lana jest jako pozycja wybitna, ponadczasowa, jako must read kaÅ¼dego programisty. Dodatkowo w tym roku wyszÅ‚a jej druga edycja. Po co?Martin podkreÅ›la przecieÅ¼, Å¼e notatki z lat dziewiÄ™Ä‡dziesiÄ…tych, ktÃ³re tworzyÅ‚ i ogÃ³lnie zasady refaktoryzacji wciÄ…Å¼ sÄ… aktualne i wciÄ…Å¼ sam ich uÅ¼ywa. Mimo to wszystkie jej rozdziaÅ‚y zostaÅ‚y przepisane, a przede wszystkim zmieniÅ‚ siÄ™ jÄ™zyk wykorzystany w przykÅ‚adach - wtedy wybrali JavÄ™, tym razem postawili na JavaScript.DominujÄ…ca czÄ™Å›Ä‡ tej pozycji to katalog reguÅ‚ refaktoryzacji wraz z motywacjÄ…, sposobem jej wykonania i oczywiÅ›cie kodem. Zanim jednak tam dotrzemy, Fowler prÃ³buje wytÅ‚umaczyÄ‡, po co w ogÃ³le refaktoryzowaÄ‡ i kiedy to robiÄ‡.I to, co najbardziej wyniosÅ‚am z tej lektury to podejÅ›cie, ktÃ³re przewija siÄ™ w niej bardzo czÄ™sto: mianowicie, Å¼e refaktoryzacja powinna byÄ‡ â€œczÄ™Å›ciÄ… naturalnego flow programistyâ€.Gdy podchodzimy do zadania, chcemy dodaÄ‡ nowÄ… funkcjonalnoÅ›Ä‡, powinniÅ›my mÃ³c jÄ… wprowadziÄ‡ w zastany kod w sposÃ³b Å‚atwy i Å‚adny. JeÅ›li jednak jego stan nam na to nie pozwala, moÅ¼e powinniÅ›my pokusiÄ‡ siÄ™ o jego reorganizacjÄ™, tak Å¼ebyÅ›my mogli pÃ³Åºniej szybko i bez wyrzutÃ³w sumienia wprowadzaÄ‡ zmiany. Bardzo trafnie opisuje to cytat:&quot;It&#39;s like I want to go 100 miles east but instead of just traipsing through the woods, I&#39;m going to drive 20 miles north to the highway and then I&#39;m going to go 100 miles east at three times the speed I could have if I just went straight there. When people are pushing you to just go straight there, sometimes you need to say &#39;Wait, I need to check the map and find the quickest route&#39;.&quot;Zanim przejdziemy do przykÅ‚adÃ³w, jeszcze jedna motywacja, czyli to, jak okreÅ›la sam siebie Kent Beck:&quot;I&#39;m not a great programmer. I&#39;m just a good programmer with great habits.&quot;PrzykÅ‚ad pierwszyfunction solveIdealRocketEquation(specificImpulse, initialMass, finalMass) {\tconst exhaustVelocity = specificImpulse * 9.81;\tconst massFraction = initialMass/finalMass;\treturn exhaustVelocity * Math.log(massFraction)}Refaktor powyÅ¼szego przykÅ‚adu rozpoczniemy od zastosowania wyodrÄ™bnienia metod (Extract Function).function solveIdealRocketEquation(specificImpulse, initialMass, finalMass) {\tconst exhaustVelocity = specificImpulse * 9.81;\tconst massFraction = initialMass/finalMass;\treturn calculateVelocity(exhaustVelocity, massFraction)}function calculateVelocity(exhaustVelocity, massFraction){\treturn exhaustVelocity * Math.log(massFraction)}NastÄ™pnie wprowadzimy strukturÄ™ sÅ‚uÅ¼Ä…cÄ… do komunikacji (Introduce Parameter Object).function solveIdealRocketEquation(specificImpulse, initialMass, finalMass) {\tconst exhaustVelocity = specificImpulse * 9.81;\tconst massFraction = initialMass/finalMass;\tconst velocityData = {exhaustVelocity: exhaustVelocity, massFraction: massFraction}\treturn calculateVelocity(velocityData)}function calculateVelocity(velocityData){\treturn velocityData.exhaustVelocity * Math.log(velocityData.massFraction)}I z tak posprzÄ…tanymi parametrami, moÅ¼emy wydzieliÄ‡ dwie, niezaleÅ¼ne fazy naszych obliczeÅ„ (Split Phase).function solveIdealRocketEquation(specificImpulse, initialMass, finalMass) {\tconst velocityData = calculateVelocityData(specificImpulse, initialMass, finalMass)\treturn calculateVelocity(velocityData)}function calculateVelocity(velocityData){\treturn velocityData.exhaustVelocity * Math.log(velocityData.massFraction)}function calculateVelocityData(specificImpulse, initialMass, finalMass){\tconst exhaustVelocity = specificImpulse * 9.81;\tconst massFraction = initialMass/finalMass;\treturn {exhaustVelocity: exhaustVelocity, massFraction: massFraction}}PrzykÅ‚ad drugifunction aggregateStarsData(stars){    let highestTemperature = stars[0] ? stars[0].temperature : 0;    let totalMass = 0;    for (const s of stars) {\t    if (s.temperature &amp;gt; highestTemperature) {\t\thighestTemperature = s.temperature\t    }\ttotalMass += s.mass    }    return {highestTemperature: highestTemperature, totalMass: totalMass}}W powyÅ¼szym przykÅ‚adzie obliczamy Å‚Ä…cznÄ… masÄ™ gwiazd oraz znajdujemy gwiazdÄ™, ktÃ³rej temperatura jest najwyÅ¼sza. Wyliczenia te przetwarzane sÄ… w tej samej pÄ™tli, chociaÅ¼ sÄ… od siebie niezaleÅ¼ne. Minusem tego podejÅ›cia jest to, Å¼e za kaÅ¼dym razem, gdy bÄ™dziemy chcieli takÄ… pÄ™tlÄ™ zmodyfikowaÄ‡, bÄ™dziemy musieli zrozumieÄ‡ obie te rzeczy. Podzielmy jÄ… wiÄ™c na dwie, tak abyÅ›my mogli prÃ³bowaÄ‡ zrozumieÄ‡ tylko tÄ™ czÄ™Å›Ä‡, ktÃ³rÄ… musimy zmodyfikowaÄ‡ (Split Loop).function aggregateStarsData(stars){    let highestTemperature = stars[0] ? stars[0].temperature : 0;    for (const s of stars) {\t    if (s.temperature &amp;gt; highestTemperature) {\t\t    highestTemperature = s.temperature\t    }    }    let totalMass = 0;        for (const s of stars) {\t        totalMass += s.mass    }    return {highestTemperature: highestTemperature, totalMass: totalMass}}NastÄ™pnie powydzielajmy metody (Extract Function).function aggregateStarsData(stars){\treturn {highestTemperature: highestTemperature(stars), totalMass: totalMass(stars)}}function highestTemperature(stars){\tlet highestTemperature = stars[0] ? stars[0].temperature : 0;\tfor (const s of stars) {\t\tif (s.temperature &amp;gt; highestTemperature) {\t\t\thighestTemperature = s.temperature\t\t}\t}\treturn highestTemperature;}function totalMass(stars){\tlet totalMass = 0;\tfor (const s of stars) {\t\ttotalMass += s.mass\t}\treturn totalMass;}I uÅ¼yjmy jeszcze dwÃ³ch metod refaktoryzacji: Replace Loop with Pipeline oraz Subsitute Algorithm.function aggregateStarsData(stars){\treturn {highestTemperature: highestTemperature(stars), totalMass: totalMass(stars)}}function highestTemperature(stars){    return Math.max(...stars.map(s=&amp;gt; s.temperature))}function totalMass(stars){    return stars.reduce((totalMass, s) =&amp;gt; totalMass += s.mass, 0);}Podsumowanieâ€œRefactoringâ€ Fowlera i Becka to ksiÄ…Å¼ka, ktÃ³rÄ… na pewno doceniÄ… osoby, ktÃ³re pracujÄ… przy duÅ¼ych i dÅ‚ugofalowych projektach. Wtedy bowiem potrzeba refaktorowania jest bezdyskusyjna, jednak jest on czasochÅ‚onny i ryzykowny. Åatwo wpaÅ›Ä‡ w puÅ‚apkÄ™, w ktÃ³rej zmiany, ktÃ³re dodajemy, wprowadzajÄ… baÅ‚agan do kodu i tÅ‚umaczone sÄ… poÅ›piechem. Jednak czas, ktÃ³ry zaoszczÄ™dzimy przy jej dodawaniu, zostanie zjedzony w caÅ‚oÅ›ci, a pewnie i przekroczony, gdy kolejna osoba bÄ™dzie musiaÅ‚a wejÅ›Ä‡ w nasze klasy i zrozumieÄ‡, jak to wÅ‚aÅ›ciwie dziaÅ‚a.PodejdÅºmy wiÄ™c do problemu zdrowo i po prostu - zawsze zostawiajmy kod choÄ‡ odrobinÄ™ lepszym, niÅ¼ ten ktÃ³ry zastaliÅ›my;)",
"url": "/2019/05/06/refactoring.html",
"author": "Sylwia ÃœÃ§Ã¼ncÃ¼",
"authorUrl": "/authors/sucuncu.html",
"image": "sucuncu.jpg",
"highlight": "/assets/img/posts/2019-05-06-refactoring/refactoring.jpg",
"date": "06-05-2019",
"path": "pl/2019-05-06-refactoring"
}
,


"2019-03-27-custom-elements-html": {
"title": "KrÃ³tkie wprowadzenie do Custom Elements",
"lang": "pl",
"tags": "frontend custom elements web",
"content": "Custom element, co to takiego?Custom Elements to jedna z zestawu czterech specyfikacji wystÄ™pujÄ…cych pod wspÃ³lnÄ… nazwÄ… Web Components - wspÃ³lnie pozwalajÄ… one na tworzenie wÅ‚asnych typÃ³w elementÃ³w DOM.Na Web Components skÅ‚adajÄ… sie nastÄ™pujÄ…ce specyfikacje:  Templates - wprowadza element &amp;lt;template&amp;gt;, ktÃ³ry pozwala na wyrenderowanie jego zawartoÅ›ci dopiero na Å¼Ä…danie stworzenia kopii. DziÄ™ki temu problem z przedwczesnym Å‚adowaniem danych nie wystÄ™puje,  HTML imports - tworzone komponenty mogÄ… zawieraÄ‡ szablony (Templates) i kod (Custom elements), specyfikacja ta pozwala wydzieliÄ‡ obie te czÄ™Å›ci do oddzielnego pliku HTML i importowaÄ‡ go za pomocÄ… &amp;lt;link rel=&quot;import&quot; href=&quot;plik-komponentu.html&quot; /&amp;gt;,  Shadow DOM - specyfikacja ta pozwala na enkapsulacjÄ™ DOMâ€™u oraz styli. KaÅ¼dy element moÅ¼e mieÄ‡ swÃ³j shadow root, ktÃ³ry jest wyÅ›wietlany jako jego zawartoÅ›Ä‡, przy czym zawartoÅ›Ä‡ ta jest odseparowana logicznie od pozostaÅ‚ych elementÃ³w DOM,  Custom Elements - specyfikuje sposÃ³b tworzenia wÅ‚asnych elementÃ³w DOM oraz dostarcza obiekty do kontrolowania cyklu Å¼ycia elementu.W tym artykule skupimy siÄ™ jedynie na Custom Elements (oraz w mniejszym stopniu na Shadow DOM), ktÃ³ry jest minimalnym zestawem narzÄ™dzi pozwalajÄ…cym na dodanie wÅ‚asnego elementu HTML niezaleÅ¼nego od wykorzystywanych (lub nie) frameworkÃ³w czy bibliotek.Wsparcie przez gÅ‚Ã³wne przeglÄ…darkiWsparcie custom components przez gÅ‚Ã³wne przeglÄ…darkiÅºrÃ³dÅ‚o: www.webcomponents.org - dostÄ™p: 2019-03-16Custom Elements jest wspierany przez wiÄ™kszoÅ›Ä‡ najpopularniejszych przeglÄ…darek. Na pozostaÅ‚ych implementacjÄ™ zapewniajÄ… polyfille:  https://github.com/webcomponents/custom-elements lub  https://github.com/webcomponents/webcomponentsjsCustomElementRegistryObiekt typu CustomElementRegistry zapewnia metody pozwalajÄ…ce na rejestrowanie oraz pobierania juÅ¼ zarejestrowanych elementÃ³w. InstancjÄ™ klasy CustomElementRegistry otrzymamy odwoÅ‚ujÄ…c siÄ™ do window.customElements. W klasie tej znajdziemy nastÄ™pujÄ…ce metody:CustomElementRegistry.define(localName: string, constructor: Function, options?: {extends: string}): voidPozwala na zdefiniowanie elementu. Pierwszym parametrem jest nazwa tagu, drugim konstruktor klasy elementu. Dodatkowo, moÅ¼na podaÄ‡ trzeci parametr, ktÃ³ry zawiera opcje komponentu. W aktualnej wersji specyfikacji dostÄ™pna jest jedynie opcja extends, ktÃ³rej wartoÅ›ciÄ… jest nazwa rozszerzanego elementu (wykorzystujemy jÄ… wyÅ‚acznie w przypadku rozszerzania juÅ¼ istniejÄ…cego elementu).PrzykÅ‚adowe zastosowanie:customElements.define(&#39;my-element&#39;, class extends HTMLElement {    connectedCallback() {        this.innerHTML = &#39;&amp;lt;strong&amp;gt;hello world&amp;lt;/strong&amp;gt;&#39;;    }});Tak zdefiniowanego elementu moÅ¼na uÅ¼yÄ‡ w nastÄ™pujÄ…cy sposÃ³b:&amp;lt;my-element&amp;gt;&amp;lt;/my-element&amp;gt;Ograniczenia nazwy taguNazwa naszego elementu musi speÅ‚niaÄ‡ nastÄ™pujÄ…ce wyraÅ¼enie regularne:^[a-z][.0-9_a-z]*-[\\-.0-9_a-z]*$Innymi sÅ‚owy tag musi zaczynaÄ‡ siÄ™ od litery, musi zawieraÄ‡ przynajmniej jeden myÅ›lnik, a poza tym moÅ¼e zawieraÄ‡ jedynie litery alfabetu Å‚aiÅ„skiego oraz nastÄ™pujace znaki: _, . i -. Taka reguÅ‚a sugeruje aby stosowaÄ‡ konwencjÄ™ nazewniczÄ… kebab-case.Dodatkowo, nazwa nie moÅ¼e kolidowaÄ‡ z Å¼adnÄ… nazw z nastÄ™pujÄ…cej listy:  annotation-xml,  color-profile,  font-face,  font-face-src,  font-face-uri,  font-face-format,  font-face-name,  missing-glyph.CustomElementRegistry.get(name: string): Function|undefinedMetoda get zwraca constructor utworzonego custom elementu lub undefined, jeÅ¼eli taki nie zostaÅ‚ znaleziony.PrzykÅ‚ad:const myElement = customElements.get(&#39;my-element&#39;);CustomElementRegistry.upgrade(root: Node): voidMetoda upgrade pozwala zainicjowaÄ‡ element znajdujÄ…cy siÄ™ w DOM po tym jak custom element zostaÅ‚ zarejestrowany.PrzykÅ‚ad:const el = document.createElement(&quot;my-element&quot;);class MyElement extends HTMLElement {}customElements.define(&quot;my-element&quot;, MyElement);console.assert(!(el instanceof MyElement)); // not yet upgradedcustomElements.upgrade(el);console.assert(el instanceof MyElement);    // upgraded!CustomElementRegistry.whenDefined(): Promise&amp;lt;undefined&amp;gt;Zwraca Promise, ktÃ³ry rozwiÄ…zany jest w momencie, gdy element zostanie zarejestrowany.PrzykÅ‚ad:customElements.whenDefined(&#39;my-element&#39;).then(() =&amp;gt; {    // ...});ZarzÄ…dzanie cyklem Å¼ycia custom elementuW kaÅ¼dym custom elemencie moÅ¼emy wykorzystaÄ‡ jeden z predefiniowanych callbackÃ³w:  connectedCallback - wywoÅ‚ywany za kaÅ¼dym razem, gdy custom element jest doÅ‚Ä…czany do dokumentu,  disconnectedCallback - wywoÅ‚ywany zawsze po odÅ‚Ä…czeniu custom elementu z DOM,  adoptedCallback - wywoÅ‚ywany po przeniesieniu custom elementu do innego dokumentu,  attributeChangedCallback - wywoÅ‚ywany, gdy atrybuty elementu zostanÄ… dodane, usuniÄ™te lub zmodyfikowane - jest wywoÅ‚ywany jedynie dla atrybutÃ³w, ktÃ³rych nazwy zostanÄ… zwrÃ³cone ze statycznego pola observedAttributes.Custom elementy w akcjiPrzykÅ‚adowy prosty custom elementZaÅ‚Ã³Å¼my, Å¼e w naszej aplikacji chcemy stworzyÄ‡ komponent obrazka z podpisem. Do tej pory uÅ¼ywaliÅ›my HTMLa o takiej strukturze:&amp;lt;div class=&quot;image-with-caption&quot;&amp;gt;    &amp;lt;img class=&quot;image&quot; src=&quot;obrazek.jpg&quot; /&amp;gt;    &amp;lt;div class=&quot;image-caption&quot;&amp;gt;Podpis obrazka&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;style&amp;gt;img.image {   max-width: 100%;   max-height: 500px;}.image-caption {   font-size: 10px;}&amp;lt;/style&amp;gt;ChcielibyÅ›my wydzieliÄ‡ taki fragment kodu, do elementu, ktÃ³ry bÄ™dziemy definiowaÄ‡ w nastÄ™pujÄ…cy sposÃ³b:&amp;lt;image-with-caption src=&quot;obrazek.jpg&quot;&amp;gt;Podpis obrazka&amp;lt;/image-with-caption&amp;gt;Zacznijmy od stworzenia i zarejestrowania komponentu:class ImageWithCaption extends HTMLElement {    constructor() {        super();    }}window.customElements.define(&#39;image-with-caption&#39;, ImageWithCaption);Na tym etapie po dodaniu &amp;lt;image-with-caption /&amp;gt; zostanie na nim zainicjowany element ImageWithCaption. Zajmijmy siÄ™ dodaniem obrazka.Dodajmy do klasy pole img typu HTMLImageElement:class ImageWithCaption extends HTMLElement {    private readonly img: HTMLImageElement;    // ...}NastÄ™pnie do konstruktora dopiszmy:constructor() {    // ...    this.img = document.createElement(&#39;img&#39;);        this.attachShadow({mode: &#39;open&#39;});    this.shadowRoot.appendChild(this.img);}W ten sposÃ³b dodaliÅ›my do elementu shadow root (dziÄ™ki temu style elementu bÄ™dÄ… odseparowane od dokumentu).A potem dodajmy metodÄ™ connectedCallback:connectedCallback(): void {    this.img.src = this.getAttribute(&#39;src&#39;);}W ten sposÃ³b przypiszemy ÅºrÃ³dÅ‚o obrazka z atrybutu src elementu &amp;lt;image-with-caption src=&quot;...&quot;&amp;gt;. Na tym etapie po osadzeniu naszego elementu pojawi siÄ™ obrazek, ktÃ³ry wskaÅ¼emy w atrybucie src. Niestety jego wartoÅ›Ä‡ nie bÄ™dzie mogÅ‚a siÄ™ zmieniaÄ‡ po inicjalizacji elementu. Aby nasÅ‚uchiwaÄ‡ na zmiany po inicjalizacji naleÅ¼y zadeklarowaÄ‡, Å¼e bÄ™dziemy nasÅ‚uchiwaÄ‡ na zmiany atrybutu src:static get observedAttributes(): string[] {    return [&#39;src&#39;];}NastÄ™pnie naleÅ¼y zdefiniowaÄ‡ metodÄ™ attributeChangedCallback, ktÃ³ra posÅ‚uÅ¼y do obsÅ‚ugi zmian atrybutu src:attributeChangedCallback(name: string, oldValue: string, newValue: string): void {    if (name === &#39;src&#39;) {        this.img.src = newValue;    }}DziÄ™ki temu moÅ¼emy zmieniaÄ‡ wartoÅ›Ä‡ atrybutu src po zainicjowaniu komponentu. Zajmijmy siÄ™ teraz dodaniem etykiety do obrazka. Do konstruktora dopiszmy nastÄ™pujÄ…cy kod:const caption: HTMLDivElement = document.createElement(&#39;div&#39;);caption.innerHTML = &#39;&amp;lt;slot&amp;gt;&amp;lt;/slot&amp;gt;&#39;;this.shadowRoot.appendChild(caption);DodaliÅ›my do naszego shadow DOM element &amp;lt;div&amp;gt;, ktÃ³rego zawartoÅ›Ä‡ zdefiniowaliÅ›my jako &amp;lt;slot&amp;gt;&amp;lt;/slot&amp;gt;. Podczas dziaÅ‚ania aplikacji &amp;lt;slot&amp;gt;&amp;lt;/slot&amp;gt; zostanie zastÄ…pione zawartoÅ›ciÄ… elementu &amp;lt;image-with-caption&amp;gt;&amp;lt;/image-with-caption&amp;gt;.ZostaÅ‚o nam dodanie styli do naszego komponentu. Dopiszmy do konstruktora:const style: HTMLStyleElement = document.createElement(&#39;style&#39;);style.innerHTML = `    img {        max-width: 100%;        max-height: 500px;    }    div {        font-size: 10px;    }`;this.shadowRoot.appendChild(style);DziÄ™ki uÅ¼yciu Shadow DOM style, ktÃ³re wÅ‚aÅ›nie dodaliÅ›my nie wypÅ‚ywajÄ… poza element.VoilÃ !MaÅ‚y bonus - Rozszerzanie istniejÄ…cych elementÃ³wPoza moÅ¼liwoÅ›ciÄ… zdefiniowania nowego elementu specyfikacja Custom Elements pozwala na rozszerzenie juÅ¼ istniejÄ…cych elementÃ³w. ZaÅ‚Ã³Å¼my, Å¼e chcemy dokonaÄ‡ prostej modyfikacji elementu &amp;lt;a&amp;gt; polegajÄ…cej na tym, Å¼e przejÅ›cie do Å‚Ä…cza nastÄ…pi dopiero po potwierdzeniu przez uÅ¼ytkownika. PoniÅ¼ej kod przykÅ‚adowego elementu:class LinkWithConfirmation extends HTMLAnchorElement {    constructor() {        super();    }        connectedCallback(): void {        this.addEventListener(&#39;click&#39;, (event: MouseEvent) =&amp;gt; {            if (!confirm(&#39;Are you sure?&#39;)) {                event.preventDefault();            }        });    }}customElements.define(&#39;link-with-confirmation&#39;, LinkWithConfirmation, { extends: &#39;a&#39; });ZwrÃ³Ä‡my uwagÄ™, Å¼e w ostatnim parametrze metody define przekazaliÅ›my obiekt { extends: &#39;a&#39; }, ktÃ³ry informuje, Å¼e bÄ™dziemy rozszerzaÄ‡ element &amp;lt;a&amp;gt;.Aby skorzystaÄ‡ z napisanego elementu musimy uÅ¼yÄ‡ elementu &amp;lt;a&amp;gt; z atrybutem is o wartoÅ›ci link-with-confirmation, a nie &amp;lt;link-with-confirmation&amp;gt;:&amp;lt;a is=&quot;link-with-confirmation&quot; href=&quot;https://consdata.com&quot;&amp;gt;consdata.com&amp;lt;/a&amp;gt;Przydatne linki  www.webcomponents.org  Wsparcie dla custom elements  Dobre praktyki z przykÅ‚adami  O Custom elements na MDN",
"url": "/2019/03/27/custom-elements.html",
"author": "Mateusz Pogorzelski",
"authorUrl": "/authors/mpogorzelski.html",
"image": "mpogorzelski.jpg",
"highlight": "/assets/img/posts/2019-03-27-custom-elements/custom-elements.png",
"date": "27-03-2019",
"path": "pl/2019-03-27-custom-elements"
}
,


"2019-03-27-java-darmowa-czy-nie-html": {
"title": "Java darmowa, czy nie?",
"lang": "pl",
"tags": "java",
"content": "End of Public Updates for Oracle JDK 8Oracle will not post further updates of Java SE 8 to its public download sites for commercial use after January 2019. Customers who need continued access to critical bug fixes and security fixes as well as general maintenance for Java SE 8 or previous versions can get long term support through Oracle Java SE Subscription or Oracle Java SE Desktop Subscription. For more information, and details on how to receive longer term support for Oracle JDK 8, please see the Oracle Java SE Support Roadmap.https://www.oracle.com/technetwork/java/javase/overview/index.html15 stycznia tego roku Å›wiatÅ‚o dzienne ujrzaÅ‚ JDK 8u202 - ostatni darmowy update JDK 8. Darmowy do zastosowaÅ„ komercyjnych. Wersja JDK 8 byÅ‚a pierwszÄ… wersjÄ… LTS (Long-Term-Support) i byÅ‚a z nami od marca 2014 roku. Co dalej? Czy moÅ¼na zostaÄ‡ na JDK 8? Czy przesiadaÄ‡ siÄ™Â na kolejnÄ…Â wersjÄ™?Oracle JDK vs OpenJDKW obecnej sytuacji szczegÃ³lnego znaczenia nabierajÄ… rÃ³Å¼nice pomiÄ™dzy JDK releasowanym przez Oracle a OpenJDK.  OpenJDK jest projektem open source dostarczajÄ…cym implementacjÄ™Â  Java Platform, Standard Edition. Projekt dziaÅ‚a od 2007 roku, a jednym z gÅ‚Ã³wnych kontrybutorÃ³w jest Oracle.  Oracle JDK natomiast to dystrybucja JDK dostarczana i supportowana przez Oracle w ramach OTN (Oracle Technology Network).Obydwie wersjÄ™ majÄ… w zasadzie ten sam code base. Techniczne rÃ³Å¼nice sÄ… niewielkie i dotyczÄ… gÅ‚Ã³wnie narzÄ™dzi i deploymentu. RÃ³Å¼nice, ktÃ³re z punktu widzenia ostatnich zmian sÄ… najbardziej istotnie to licencjonowanie i cykl wydawniczy.Licencjonowanie i opÅ‚atyOpenJDK jest projektem open source licencjonowanym w oparciu o GNU General Public License, version 2 with CE.W Oracle JDK model licencjonowania rÃ³Å¼ni siÄ™Â w zaleÅ¼noÅ›ci od wersji. Wersje sprzed wersji 11 licencjonowane sÄ… w oparciu o Oracle BCL (Binary Code Licence). Od wersji 11 Oracle JDK licencjonowane jest w oparciu o Oracle Java SE OTN License, ktÃ³ry nie pozwala na komercyjne uÅ¼ycie. JeÅ¼eli chcemy uÅ¼ywaÄ‡ tej wersji do zastosowaÅ„ komercyjnych musimy wykupiÄ‡ subskrypcjÄ™ â€œOracle Java SE subscriptionâ€. Subskrypcja jest rozliczana w cyklu miesiÄ™cznym, a koÅ„cowa cena zaleÅ¼y od:  sposobu uÅ¼ycia (desktop/serwer),  liczby rdzeni,  mnoÅ¼nika Oracle Processor Core Factor.WedÅ‚ug aktualnego cennika za jeden, obliczony na podstawie mnoÅ¼nika, core zapÅ‚acimy 25$ przy zaÅ‚oÅ¼eniu, Å¼e corÃ³w jest mniej niÅ¼ 99.Cykl wydawniczyBiorÄ…c pod uwagÄ™Â powyÅ¼sze informacje wydaje siÄ™, Å¼e naturalnym krokiem dla tych, ktÃ³rzy nie chcÄ… pÅ‚aciÄ‡ za support jest przesiadka na wersjÄ™ OpenJDK, jest tu jednak pewien haczyk. Aby go odkryÄ‡ musimy wiedzieÄ‡ jaki jest cykl wydawniczy poszczegÃ³lnych wersji.JakiÅ› czas temu Oracle postanowiÅ‚ nadaÄ‡ pewien rygor czasowy kolejnym wydawanym wersjom. Kolejne wersje Javy bÄ™dÄ… ukazywaÅ‚y siÄ™Â co pÃ³Å‚ roku. NiektÃ³re z nich bÄ™dÄ… wersjami LTS, a pozostaÅ‚e bÄ™dÄ… zastÄ™powane kolejnymi i nie bÄ™dÄ… dalej rozwijane. Aktualnie wersje LTS to:  wersja 8 - wspierana do marca 2025 roku,  wersja 11 - wspierana do wrzeÅ›nia 2026 roku.Oracle bÄ™dzie publikowaÅ‚ nowe wydania wersji raz na kwartaÅ‚. Dotyczy to zarÃ³wno wersji LTS jak i non-LTS. Niestety w przypadku OpenJDK Oracle nie bÄ™dzie wydawaÅ‚ wiÄ™cej niÅ¼ dwÃ³ch wersji rÃ³wnieÅ¼ dla wersji LTS. Oznacza to, Å¼e jeÅ¼eli wybieramy wersjÄ™ LTS oczekujÄ…c dÅ‚ugiego czasu wsparcia nie moÅ¼emy polegaÄ‡ na releasach OpenJDK dostarczanych przez Oracle (https://openjdk.java.net/).SkÄ…d wziÄ…Ä‡ darmowÄ… wersjÄ™?Czy zatem wybierajÄ…c wersjÄ™Â LTS jesteÅ›my skazani na â€œwÅ‚asnorÄ™czneâ€ budowanie OpenJDK? Na szczÄ™Å›cie nie. Istnieje jeszcze kilku dostawcÃ³w, ktÃ³rzy bÄ™dÄ… publikowaÄ‡ kolejne wydania bazujÄ…ce na OpenJDK. Z tych bardziej obiecujÄ…cych warto wymieniÄ‡:  AdoptOpenJDK - warte zainteresowania chociaÅ¼by ze wzglÄ™du na zrÃ³Å¼nicowany zbiÃ³r sponsorÃ³w (IBM, Microsoft Azure, Azul Systems),  Amazon Corretto - ta wersja bÄ™dzie uÅ¼ywana w chmurze AWS moÅ¼na wiÄ™c liczyÄ‡ na solidny support,  Azul - dostarczajÄ… darmowÄ… implementacjÄ™ JDK z opcjÄ… pÅ‚atnego wsparcia,  RedHat - planuje dostarczaÄ‡ pakiety z aktualizacjami JDK dla wersji 8 na RHEL 6 i RHEL7 do 2023 roku, a dla wersji 11 na RHEL7 do 2024 roku.Przydatne linki  Java is still free  Oracle Java SE Support Roadmap  Update and FAQ on the Java SE Release Cadence",
"url": "/2019/03/27/java-darmowa-czy-nie.html",
"author": "Jakub Wilczewski",
"authorUrl": "/authors/jwilczewski.html",
"image": "jwilczewski.jpg",
"highlight": "/assets/img/posts/2019-03-22-java-darmowa-czy-nie/java-darmowa.png",
"date": "27-03-2019",
"path": "pl/2019-03-22-java-darmowa-czy-nie"
}
,


"2019-02-26-pozycjonowanie-zale-ne-od-scrolla-html": {
"title": "Pozycjonowanie zaleÅ¼ne od scrolla",
"lang": "pl",
"tags": "frontend javascript",
"content": "Czasem zachodzi potrzeba uzaleÅ¼nienia pozycji elementu od scrolla okna, czy to na potrzeby przyklejenia w widocznym obszarze, czy teÅ¼ stworzenia efektu paralaksy lub niestandardowego flow nawigacji. Temat wydawaÅ‚by siÄ™ oczywisty, gdyby nie to, Å¼e celowo wprowadzimy sobie dodatkowe ograniczenia (co wcale nie jest takie niecodziennie, uwzglÄ™dniajÄ…c fantazjÄ™ dziaÅ‚Ã³w UI/UX ;-)).PodejÅ›cie 1: tylko CSSMamy dwa sposoby przyklejenia elementu do ekranu wykorzystujÄ…ce tylko CSS. Oba opierajÄ… siÄ™ o zmianÄ™ pozycjonowania:  position: fixed,  position: sticky.Oba teÅ¼ majÄ… swoje problemy i ograniczenia.StosujÄ…c pozycjonowanie fixed:  musimy uwzglÄ™dniÄ‡ pozostawione przez niego miejsce w oryginalnym fragmencie drzewa DOM,  jeÅ¼eli element bÄ™dzie wyÅ¼szy niÅ¼ viewport to nie bÄ™dziemy mieli moÅ¼liwoÅ›ci obejrzeÄ‡ niemieszczÄ…cej siÄ™ zawartoÅ›ci,  fixed zawsze tworzy nowy stacking context.StosujÄ…c pozycjonowanie sticky:  jeÅ¼eli element bÄ™dzie wyÅ¼szy niÅ¼ viewport, to nie bÄ™dziemy mieli moÅ¼liwoÅ›ci obejrzeÄ‡ niemieszczÄ…cej siÄ™ zawartoÅ›ci,  sticky zawsze tworzy nowy stacking context,  sticky czasem moÅ¼e zaskoczyÄ‡ swoim dziaÅ‚aniem (przykÅ‚adowo issue w3c).O ile uwzglÄ™dnienie oderwanego przez fixed elementu w layoucie nie stanowi wyzwania, o tyle brak wsparcia dla przewijania treÅ›ci i zmiana stacking context (co wpÅ‚ynie np. na liczenie kolejnoÅ›ci na osi z) mogÄ… stanowiÄ‡ juÅ¼ zbyt duÅ¼e ograniczenia.W wielu przypadkach fixed lub sticky zaÅ‚atwiÄ… problem. JeÅ›li jednak potrzebujesz czegoÅ› wiÄ™cej, czytaj dalej.PodejÅ›cie 2: JavaScriptâ€Nie ma takiej rzeczy, ktÃ³rej bym nie napisaÅ‚ w JavaScript.â€ ğŸ˜‰PrzeglÄ…darki oferujÄ… nam zdarzenie zwiÄ…zane ze scrollowaniem treÅ›ci. Na zdarzenie moÅ¼emy nasÅ‚uchiwaÄ‡ przez zdefiniowanie wÅ‚asnoÅ›ci target.onscroll, czy teÅ¼ bardziej elastycznie, dodajÄ…c listener przez target.addEventListner(â€™scrollâ€™). Teoretycznie wystarczyÅ‚oby juÅ¼ tylko przeliczaÄ‡ pozycjÄ™ przyklejanego elementu, obsÅ‚uÅ¼yÄ‡ przewijanie w dwÃ³ch kierunkach i nie zapomnieÄ‡ o uÅ¼yciu najmniej obciÄ…Å¼ajÄ…cej metody przesuwania elementÃ³w po ekranie. Co moÅ¼e pÃ³jÅ›Ä‡ Åºle? SprawdÅºmy prosty przykÅ‚ad.Implementujemy proste przeliczanie pozycji nasÅ‚uchujÄ…c na zdarzenie scroll:Uzyskany efekt:Okazuje siÄ™, Å¼e funkcjonalnie moÅ¼emy uzyskaÄ‡ wszystko, czego potrzebujemy, jednak jakoÅ›Ä‡ rozwiÄ…zania nie jest zadowalajÄ…ca. Gdy przyjrzymy siÄ™ sprawie bliÅ¼ej, zauwaÅ¼ymy, Å¼e na rÃ³Å¼nych przeglÄ…darkach mamy rÃ³Å¼ne problemy z pÅ‚ynnym rysowaniem UI. Obserwujemy lekki poÅ›cig naszego elementu wzglÄ™dem reszty strony - to stanowczo nie jest efekt, z ktÃ³rym chcemy byÄ‡ kojarzeni.MoÅ¼emy jeszcze raz przeanalizowaÄ‡ nasze kody, przekonaÄ‡ siÄ™, Å¼e ani throttlowanie zdarzeÅ„, ani przesuwanie transformem, ani nawet wymyÅ›lne funkcje wygÅ‚adzajÄ…ce nic nie dajÄ…. Okazuje siÄ™, Å¼e odpowiedÅº jest rÃ³wnoczeÅ›nie dobra i zÅ‚a, dobra - bo z naszym kodem nie ma wiÄ™kszych problemÃ³w; zÅ‚a - bo tak po prostu dziaÅ‚ajÄ… przeglÄ…darki, na co niespecjalnie mamy wpÅ‚yw!CaÅ‚e zamieszanie wynika z tego, Å¼e wiÄ™kszoÅ›Ä‡ nowoczesnych przeglÄ…darek obsÅ‚uguje rysowanie oraz scrollowanie w osobnych wÄ…tkach. W praktyce oznacza to, Å¼e pozycja strony oraz jej zawartoÅ›Ä‡ liczone sÄ… w rÃ³Å¼nych momentach. Brak synchronizacji na tych operacjach objawia siÄ™ skakaniem przesuwanego elementu. O ile takie rozwiÄ…zanie uÅ‚atwia przeglÄ…darkom uzyskiwaÄ‡ upragnione 60 fps przy renderowaniu, o tyle dla nas oznacza skreÅ›lenie tego rozwiÄ…zania z listy wartoÅ›ciowych.Co dalej?Czy to oznacza, Å¼e jeÅ›li rozwiÄ…zanie z pozycjonowaniem CSS oferuje za maÅ‚o funkcjonalnoÅ›ci, a na lag przy rysowaniu z JavaScript nie moÅ¼emy sobie pozwoliÄ‡, to musimy rozÅ‚oÅ¼yÄ‡ rÄ™ce? OczywiÅ›cie, Å¼e nie! Na poczÄ…tek chwyÄ‡my siÄ™ wyjaÅ›nienia z poprzednich akapitÃ³w - problemem jest, Å¼e scroll viewportu i DOM strony rysowane sÄ… niezaleÅ¼nie, w rÃ³Å¼nych momentach czasu. GdybyÅ›my jednak potrafili zapewniÄ‡, Å¼e obie te rzeczy bÄ™dÄ… siÄ™ dziaÅ‚y synchronicznie? O ile nie moÅ¼emy do tego zmusiÄ‡ przeglÄ…darki, o tyle moÅ¼emy jÄ… oszukaÄ‡ ğŸ˜‰ZaÅ‚Ã³Å¼my Å¼e:  to nie przeglÄ…darka odpowiada za przewijanie treÅ›ci strony,  scroll przeglÄ…darki wyraÅ¼a jedynie intencjÄ™, w ktÃ³rym miejscu strona ma siÄ™ znajdowaÄ‡,  faktyczne przesuwanie treÅ›ci odbywa siÄ™ w naszym kodzie,  rÃ³wnieÅ¼ w naszym kodzie znajduje siÄ™ obsÅ‚uga przesuwania przyklejonych elementÃ³w,  obliczenia wykonujemy co Å¼Ä…danie klatki animacji.Przy takich zaÅ‚oÅ¼eniach moÅ¼liwe okazuje siÄ™ uzyskanie pÅ‚ynnego przewijania i przyklejania elementÃ³w. Dodatkowo, proponowane rozwiÄ…zanie poza przyklejaniem pierwszy raz oferuje opcjÄ™ realizacji paralaksy czy niestandardowych przejÅ›Ä‡ strony (kto powiedziaÅ‚, Å¼e kolejne ekrany nie majÄ… byÄ‡ po skosie lub na spirali ;-)).RozwiÄ…zaniePrzykÅ‚adowe rozwiÄ…zanie moÅ¼e wyglÄ…daÄ‡ nastÄ™pujÄ…co:  dotychczasowÄ… strukturÄ™ DOM opakowujemy we wrapper,  wrapper pozycjonujemy jako fixed na caÅ‚y ekran (top, bottom, left, right na 0),          to bÄ™dzie nadrzÄ™dny element strony odpowiedzialny za prezentowanie viewport, w tym obsÅ‚ugÄ™ przewijania,        obok wrappera definiujemy sztuczny element replikujÄ…cy wysokoÅ›Ä‡ wrappera,          to bÄ™dzie element odpowiedzialny za symulowanie wysokoÅ›ci strony, dziÄ™ki niemu przeglÄ…darka bÄ™dzie wyÅ›wietlaÅ‚a prawidÅ‚owy pasek przewijania i poprawnie rozgÅ‚aszaÅ‚a zwiÄ…zane z nim zdarzenia,        definiujemy metodÄ™ renderujÄ…cÄ… ekran co klatkÄ™ animacji,          odpowiada za faktycznie rysowanie pozycji elementÃ³w, zarÃ³wno standardowo przewijanej zawartoÅ›ci, jak i przyklejonych elementÃ³w,        zawartoÅ›Ä‡ wrappera przewijamy zgodnie z bieÅ¼Ä…cym scrollem,  przyklejony element przewijamy odwrotnie, kompensujÄ…c przesuniÄ™cie wrappera.PrzykÅ‚adowa implementacjaPrzedstawione rozwiÄ…zanie jest najprostszym z moÅ¼liwych potwierdzajÄ…cych teoretyczne zaÅ‚oÅ¼enia.W docelowym rozwiÄ…zaniu na pewno warto pomyÅ›leÄ‡ o rozdzieleniu funkcji pÄ™tli od faktycznego rysowania, wygÅ‚adzaniu przesuniÄ™cia scrolla, dorzuceniu wskazÃ³wki will-change dla przesuwanych elementÃ³w, czy ogÃ³lnym sposobie na nasÅ‚uchiwanie na zmiany scrolla globalnie.Po wprowadzeniu zmian nasz rozwiÄ…zanie prezentuje siÄ™ znacznie lepiej:Sukces?Samodzielna obsÅ‚uga scrollowania moÅ¼e byÄ‡ kuszÄ…ca przy realizacji niestandardowych przepÅ‚ywÃ³w ekranÃ³w, animacji, czy skomplikowanych interfejsÃ³w uÅ¼ytkownika. Zawsze jednak naleÅ¼y pamiÄ™taÄ‡, Å¼e przerzucamy na siebie ciÄ™Å¼ar obsÅ‚ugi czegoÅ›, co jest robione dobrze przez kaÅ¼dÄ… przeglÄ…darkÄ™. Czasem lepszym rozwiÄ…zaniem bÄ™dzie znalezienie uproszczeÅ„ w wymaganiach, a czasem bÄ™dziemy mogli wziÄ…Ä‡ na siebie taki trade-off ğŸ™‚Czy ktoÅ› stosuje takie podejÅ›cia? Tak, przykÅ‚adem niech bÄ™dzie apple.com, gdzie przewijane poczÄ…tkowo jest pionowe, nastÄ™pnie poziome i na koÅ„cu znowu pionowe ğŸ˜‰Przydatne linki  Scroll-linked effects @ MDN  The stacking context  WÅ‚asnoÅ›ci pozycjonowania elementÃ³w drzewa DOM @ MDN  What No One Told You About Z-Index",
"url": "/2019/02/26/pozycjonowanie-zale-ne-od-scrolla.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2019-02-26-pozycjonowanie-zale-ne-od-scrolla/pozycjonowanie-scroll.jpeg",
"date": "26-02-2019",
"path": "pl/2019-02-26-pozycjonowanie-zale-ne-od-scrolla"
}
,


"2018-12-13-podsumowanie-consdata-tech-odpowiedzi-na-pytanie-html": {
"title": "Podsumowanie Consdata Tech - odpowiedzi na pytania",
"lang": "pl",
"tags": "consdata.tech event sourcing",
"content": "Czy uÅ¼ywacie platformy Kafka Connect? JeÅ›li tak, czy pozwalacie connectorowi na sterowanie schematem bazy danych? JeÅ›li nie, jakie macie podejÅ›cie do ewolucji schematÃ³w?Nie uÅ¼ywamy platformy Kafka Connect, w zwiÄ…zku z czym nie jestem w stanie odnieÅ›Ä‡ siÄ™ do pierwszej czÄ™Å›ci drugiego pytania. OdnoÅ›nie czÄ™Å›ci drugiej, schemat naszej bazy danych ewoluuje wyÅ‚Ä…cznie przyrostowo. Nigdy nie usuwamy pÃ³l ze schematu, a jedynie dodajemy nowe, niewymagane pola - dziÄ™ki temu nie Å‚amiemy wstecznej kompatybilnoÅ›ci z istniejÄ…cymi juÅ¼ eventami oraz obiektami znajdujÄ…cymi siÄ™ na state storze. Nasza domena pozwala na taki rozwÃ³j schematu, jednak oczywiÅ›cie naleÅ¼y mieÄ‡ na uwadze, Å¼e nie zawsze bÄ™dzie to moÅ¼liwe. W takich sytuacjach naleÅ¼y rozwaÅ¼yÄ‡ na przykÅ‚ad wersjonowanie eventÃ³w.Czy nowe podejÅ›cie w oparciu o ES miaÅ‚o wpÅ‚yw na wydajnoÅ›Ä‡ systemu?PoÅ›rednio tak, jednak naleÅ¼y w pierwszej kolejnoÅ›ci zaznaczyÄ‡, Å¼e wydajnoÅ›Ä‡ nie byÅ‚a dla nas celem samym w sobie, gdyÅ¼ ta, ktÃ³rÄ… osiÄ…galiÅ›my jeszcze przed wprowadzeniem Event Sourcingu byÅ‚a w zupeÅ‚noÅ›ci wystarczajaca. Co wiÄ™cej, w systemach, w ktÃ³rych event store (np. Kafka) staje siÄ™ ÅºrÃ³dÅ‚em prawdy, a state store zasilany jest wyÅ‚Ä…cznie za jego pomocÄ…, bezpoÅ›redni wpÅ‚yw na wydajnoÅ›Ä‡ ma gÅ‚Ã³wnie state store, a wiÄ™c na ogÃ³Å‚ baza danych - gdyÅ¼ to na niej wykonywana jest wiÄ™kszoÅ›Ä‡ operacyjnych zapytaÅ„ w systemie. Natomiast nie wprost, ale Kafka pozwoliÅ‚a nam poprawiÄ‡ utylizacjÄ™ zasobÃ³w, poÅ›rednio przyczyniajÄ…c siÄ™ do ogÃ³lnej poprawy wydajnoÅ›ci - w szczegÃ³lnoÅ›ci poprzez asynchronicznÄ… obsÅ‚ugÄ™ wywoÅ‚aÅ„ zmieniajÄ…cych stan systemu, co pozwoliÅ‚o na znacznie lepsze gospodarowanie pulami wÄ…tkÃ³w w systemie.Czy Kafka to na pewno dobry wybÃ³r do ES?Na dokÅ‚adnie to pytanie odpowiada wczeÅ›niejszy artykuÅ‚ na naszym blogu: Czy Apache Kafka nadaje siÄ™ do Evnet Sourcingu?Final, Mass oraz External to faktyczne topici, czy tylko kategorie topicÃ³w z jakimi pracujecie?SÄ… to rozÅ‚Ä…czne topiki - kaÅ¼dy ze specyficznÄ… dla siebie konfiguracjÄ… partycjonowania, retencji, obsÅ‚ugi bÅ‚Ä™dÃ³w itp.Kafka jako event store. Jak duÅ¼o danych ma Kafka w waszym mailboxie?DziaÅ‚amy w skali okoÅ‚o miliarda eventÃ³w, co przekÅ‚ada siÄ™ to w tej chwili na okoÅ‚o kilka terabajtÃ³w danych, biorÄ…c oczywiÅ›cie pod uwagÄ™ replikacjÄ™.Czy topic final to trochÄ™ taki ESB?W tym konkretnym ujÄ™ciu - nie. Topic final jest dla nas wyÅ‚Ä…cznie ÅºrÃ³dÅ‚em prawdy w systemie, a nie elementem integrujÄ…cym rÃ³Å¼ne jego moduÅ‚y.Jak duÅ¼o macie sytuacji, w ktÃ³rych trzeba rÄ™cznie obsÅ‚ugiwaÄ‡ DLQ na produkcji?Jak dotÄ…d, po kilkumiesiÄ™cznym dziaÅ‚aniu na produkcji, trafiliÅ›my tylko na jeden przypadek, kiedy wiadomoÅ›ci trafiÅ‚y na DLQ. WiÄ™kszoÅ›Ä‡ bÅ‚Ä™dÃ³w, ktÃ³re finalnie mogÅ‚yby trafiÄ‡ do DLQ wyÅ‚apaliÅ›my na poziomie topicÃ³w Retry, skÄ…d automatycznie schodziÅ‚y w wyniku udroÅ¼nienia zaleÅ¼nych komponentÃ³w lub systemÃ³w.Co zrobiÄ‡, gdy trzeba usunÄ…Ä‡ eventy np. Å¼e wzglÄ™du na RODO? Event store, jako audyt jest niezmienny. JeÅ¼eli usuniemy eventy, to moÅ¼emy teÅ¼ straciÄ‡ ciÄ…gÅ‚oÅ›Ä‡ stanUsuwanie eventÃ³w nie jest jedynym sposobem na speÅ‚nienie wymagaÅ„ narzuconych przez RODO. Jednym z moÅ¼liwych rozwiÄ…zaÅ„, bardzo naturalnie wynikajÄ…cym z idei Event Sourcingu, jest dodanie kolejnych eventÃ³w wyraÅ¼ajÄ…cych usuniÄ™cie newralgicznych danych. W ten sposÃ³b, na aktualnym state storze newralgiczne dane zostanÄ… usuniÄ™te, a tym samym przestanÄ… byÄ‡ dostÄ™pne w ramach operacyjnego dziaÅ‚ania aplikacji. Natomiast w przypadku odtwarzania stanu systemu ze strumienia zdarzeÅ„ zostanÄ… one ponownie przetworzone w ten sposÃ³b, a wiÄ™c finalnie usuniÄ™te - speÅ‚niajÄ…c tym samym zasadÄ™ utrzymywania listy wyjÄ…tkÃ³w (1).JeÅ›li zaciekawiÅ‚ CiÄ™ temat Event Sourcingu koniecznie zapoznaj siÄ™ z naszymi materiaÅ‚ami na YouTube, a jeÅ›li chcesz zobaczyÄ‡ jak wyglÄ…daÅ‚a ta edycja w praktyce lub wziÄ…Ä‡ udziaÅ‚ w kolejnej edycji Consdata Tech to koniecznie doÅ‚Ä…cz do grupy Consdata Tech, gdzie opublikujemy informacjÄ™ o terminie kolejnego spotkania.",
"url": "/2018/12/13/podsumowanie-consdata-tech-odpowiedzi-na-pytanie.html",
"author": "Marcin Mergo",
"authorUrl": "/authors/mmergo.html",
"image": "mmergo.webp",
"highlight": "/assets/img/posts/2018-12-13-podsumowanie-consdata-tech-odpowiedzi-na-pytanie/consdatatech.jpg",
"date": "13-12-2018",
"path": "pl/2018-12-13-podsumowanie-consdata-tech-odpowiedzi-na-pytanie"
}
,


"2018-11-15-czy-apache-kafka-nadaje-sie-do-event-sourcingu-html": {
"title": "Czy Apache Kafka nadaje siÄ™ do Event Sourcingu?",
"lang": "pl",
"tags": "event sourcing apache kafka",
"content": "Nietrudno jest natknÄ…Ä‡ siÄ™ na gÅ‚osy mÃ³wiÄ…ce, Å¼e Apache Kafka nie nadaje siÄ™ do implementacji wzorca, jakim jest Event Sourcing [1]. Czy jest tak w istocie? W artykule tym postaram siÄ™ przedstawiÄ‡ swÃ³j punkt widzenia na tÄ™ sprawÄ™.Aby mÃ³c debatowaÄ‡ nad przydatnoÅ›ciÄ… (bÄ…dÅº nie) Apache Kafki do implementacji Event Sourcingu naleÅ¼y najpierw odpowiedzieÄ‡ na pytanie - czym tak wÅ‚aÅ›ciwie jest Event Sourcing? Z miejsca natrafiamy na problem, bowiem nie istnieje jedna, uniwersalna definicja Event Sourcingu. W zaleÅ¼noÅ›ci od ÅºrÃ³dÅ‚a, natrafimy na rÃ³Å¼ne definicje, nierzadko kÅ‚adÄ…ce nacisk na zupeÅ‚nie odmienne aspekty tego modelu. W tej sytuacji najlepszym wyjÅ›ciem bÄ™dzie zwrÃ³cenie siÄ™ do uznanych autorytetÃ³w, a konkretniej niezawodnego Martina Fowlera. W wolnym tÅ‚umaczeniu definiuje on Event Sourcing nastÄ™pujÄ…co:  KaÅ¼da zmiana stanu systemu reprezentowana jest przez ciÄ…g uszeregowanych eventÃ³w. [2]Z czym to siÄ™ je?Jednak na pierwszy rzut oka definicja ta moÅ¼e wydawaÄ‡ siÄ™ co najmniej enigmatyczna. Czym jest stan systemu? Czym sÄ…, i jak majÄ… siÄ™ do niego eventy?W tym ujÄ™ciu jako stan systemu naleÅ¼y rozumieÄ‡ aktualnÄ… postaÄ‡ obiektÃ³w domenowych, utrwalonÄ… w specyficzny dla danej aplikacji sposÃ³b - w pamiÄ™ci, na dysku w postaci plikÃ³w, w bazie danych. W praktyce stan systemu najczÄ™Å›ciej przechowywany jest w bazie danych.Jak wobec tego eventy majÄ… siÄ™ do stanu? WeÅºmy na warsztat klasyczny przykÅ‚ad sklepu internetowego, w ramach ktÃ³rego istnieje obiekt zamÃ³wienia, na chwilÄ™ zapominajÄ…c o Event Sourcingu.Standardowy przepÅ‚yw w takim przykÅ‚adzie mÃ³gÅ‚by wyglÄ…daÄ‡ nastÄ™pujÄ…co:  klient rozpoczyna skÅ‚adanie zamÃ³wienia - na bazie danych tworzona jest krotka zamÃ³wienia - przy pomocy bezpoÅ›redniego bazodanowego inserta,  klient finalizuje zamÃ³wienie - aktualizujemy krotkÄ™ zamÃ³wienia na bazie, zmieniajÄ…c status zamÃ³wienia - przy pomocy bazodanowego updateâ€™a,  klient porzuca zamÃ³wienie - usuwamy obiekt zamÃ³wienia z bazy - bezpoÅ›rednio na bazie wywoÅ‚ujÄ…c deleteâ€™a.Jest to do bÃ³lu klasyczny przepÅ‚yw, ktÃ³ry moÅ¼na odnieÅ›Ä‡ do wiÄ™kszoÅ›ci systemÃ³w webowych. Jak jednak wyglÄ…daÅ‚oby to w Å›wiecie Event Sourcingu? KaÅ¼da z powyÅ¼szych akcji nie koÅ„czyÅ‚aby siÄ™ bezpoÅ›rednim uderzeniem do bazy danych. Zamiast tego, generowany byÅ‚by odpowiedni event. A wiÄ™c:  klient rozpoczyna skÅ‚adanie zamÃ³wienia - tworzony jest event mÃ³wiÄ…cy, Å¼e klient utworzyÅ‚ zamÃ³wienie,  klient finalizuje zamÃ³wienie - tworzony jest event mÃ³wiÄ…cy, Å¼e klient sfinalizowaÅ‚ zamÃ³wienie,  klient porzuca zamÃ³wienie - tutaj analogicznie tworzymy event wyraÅ¼ajÄ…cy akcjÄ™ biznesowÄ….Jak wobec tego, dysponujÄ…c jedynie eventami, poznaÄ‡ aktualny stan obiektu zamÃ³wienia?WyrÃ³Å¼niamy tutaj dwa podejÅ›cia:  pierwsze z nich mÃ³wi, Å¼e chcÄ…c poznaÄ‡ stan danego obiektu, naleÅ¼y zebraÄ‡ wszystkie dotyczÄ…ce go eventy i je zagregowaÄ‡ - to znaczy przetworzyÄ‡ po kolei, â€œnaÅ‚oÅ¼yÄ‡ na siebieâ€, aÅ¼ do uzyskania wynikowego stanu obiektu. Takie podejÅ›cie w praktyce jest jednak czÄ™sto niepraktyczne, szczegÃ³lnie w duÅ¼ych systemach, przetwarzajÄ…cych duÅ¼Ä… liczbÄ™ eventÃ³w;  w praktyce czÄ™Å›ciej wykorzystuje siÄ™ rozwiÄ…zanie zwane state storage lub state store. Jest to odzwierciedlenie aktualnego stanu systemu, np. w formie bazy danych. PowyÅ¼sze eventy byÅ‚yby w zwiÄ…zku z tym â€œtÅ‚umaczoneâ€ na odpowiednie wywoÅ‚ania na bazie - odpowiednio insert, update oraz delete.NaleÅ¼y tutaj zwrÃ³ciÄ‡ uwagÄ™ na dwie bardzo waÅ¼ne cechy eventÃ³w. Po pierwsze, eventy powinny byÄ‡ domenowe, a wiÄ™c abstrahowaÄ‡ od technicznych szczegÃ³Å‚Ã³w wybranego przez nas state storeâ€™a. StÄ…d teÅ¼ eventy niosÄ… za sobÄ… informacjÄ™ domenowÄ… - â€œzamÃ³wienie zostaÅ‚o sfinalizowaneâ€, a nie - â€œwykonaj w bazie danych update na polu status, ustawiajÄ…c je na finalâ€. Po drugie, eventy powinny byÄ‡ idempotentne, tj. niezaleÅ¼nie od tego ile razy dany event zostanie przetworzony (o ile nie zostanie utracona kolejnoÅ›Ä‡ eventÃ³w) system powinien znajdywaÄ‡ siÄ™ w tym samym stanie.WracajÄ…c do przykÅ‚adu sklepu - po odzwierciedleniu eventÃ³w na bazie danych, bÄ™dÄ…cej naszym state storem, otrzymujemy w wyniku identyczny stan bazy danych jak w przykÅ‚adzie bez event sourcingu - obiekt zamÃ³wienia nie istnieje na bazie, poniewaÅ¼ zostaÅ‚ usuniÄ™ty. Na usta ciÅ›nie siÄ™ wiÄ™c pytanie: jaki jest wobec tego sens Event Sourcingu? Po co zaprzÄ…taÄ‡ sobie gÅ‚owÄ™ kolejnÄ… abstrakcjÄ… i dokÅ‚adaÄ‡ kolejne elementy do systemu, kiedy finalnie dochodzimy do identycznego stanu?Na szczÄ™Å›cie, istnieje szereg zalet takiego podejÅ›cia:  ponowne przetworzenia strumienia zdarzeÅ„ - poniewaÅ¼ kaÅ¼da zmiana stanu systemu reprezentowana jest przez event, moÅ¼emy w bardzo prosty sposÃ³b ponownie ten strumieÅ„ przetworzyÄ‡ - kiedy chcemy wymieniÄ‡ state store (np. zamieniÄ‡ jednÄ… bazÄ™ danych na innÄ…), doÅ‚oÅ¼yÄ‡ nowy mechanizm raportowy do systemu, ktÃ³ry musi od nowa przeanalizowaÄ‡ aktywnoÅ›Ä‡ naszej aplikacji, czy po prostu naprawiÄ‡ bÅ‚Ä™dy lub rozbieÅ¼noÅ›ci, ktÃ³re wkradÅ‚y siÄ™ do state storeâ€™a. W ujÄ™ciu tym strumieÅ„ eventÃ³w staje siÄ™ ÅºrÃ³dÅ‚em prawdy w systemie,  Å‚atwe odpytanie o stan kaÅ¼dego z obiektÃ³w w dowolnym momencie - nietrudno jest sobie wyobraziÄ‡ sytuacjÄ™, w ktÃ³rej chcemy poznaÄ‡ stan jednego z obiektÃ³w w systemie w konkretnym punkcie czasu. Bez Event Sourcingu mamy do dyspozycji jedynie aktualny stan obiektu lub jesteÅ›my skazani na analizÄ™ logÃ³w w celu odtworzenia cyklu Å¼ycia obiektu. WykorzystujÄ…c Event Sourcing staje siÄ™ to proste i bezproblemowe,  moÅ¼liwoÅ›Ä‡ zrzutu stanu z dowolnego momentu - chcÄ…c przeanalizowaÄ‡ aplikacjÄ™ w konkretnym momencie jej dziaÅ‚ania wystarczy przetworzyÄ‡ eventy aÅ¼ do tego momentu w czasie, â€œzrzucajÄ…câ€ je do stojÄ…cej na boku bazy danych - tym samym, nie przeszkadzajÄ…c w Å¼aden sposÃ³b produkcyjnej bazie danych, moÅ¼na wÅ‚Ä…czyÄ‡ oraz zdebugowaÄ‡ aplikacjÄ™ znajdujÄ…cÄ… siÄ™ w perfekcyjnie tym samym stanie co np. w momencie wystÄ…pienia bÅ‚Ä™du na produkcji,  wiele rÃ³Å¼nych odzwierciedleÅ„ stanu aplikacji - pewne reprezentacje stanu aplikacji sÄ… lepsze do konkretnych zastosowaÅ„ niÅ¼ inne. Np. chcÄ…c Å‚atwo przeszukiwaÄ‡ nasze obiekty pod kÄ…tem tekstu wybierzemy Solra lub Elastic Search. Jednak chcÄ…c wykonywaÄ‡ klasyczne zapytania bazodanowe na naszym stanie, lepszy bÄ™dzie PostgreSQL. DziÄ™ki Event Sourcingowi Å‚atwe staje siÄ™ odzwierciedlanie stanu w rÃ³Å¼nych technologiach - sprowadza siÄ™ to jedynie do â€œprzetÅ‚umaczeniaâ€ eventÃ³w na odpowiedniÄ… technologiÄ™ i ponownego przetworzenia strumienia zdarzeÅ„,  prostsze debugowanie oraz audyt systemu - majÄ…c jawnie zdefiniowanÄ… i zapisanÄ… kaÅ¼dÄ… zmianÄ™ kaÅ¼dego obiektu, debugowanie oraz audyt systemu stajÄ… siÄ™ prostsze - przeÅ›ledzenie zmian sprowadza siÄ™ do przeÅ›ledzenia eventÃ³w, bez koniecznoÅ›ci odszyfrowywania nierzadko zawiÅ‚ych logÃ³w aplikacji.PozostawiajÄ…c za nami przykÅ‚ad ze sklepem internetowym, Å›wietnÄ… ilustracjÄ… Event Sourcingu oraz jego zalet sÄ… systemy kontroli wersji, np. git:  kaÅ¼da zmiana reprezentowana jest w postaci eventu (commit),  mamy moÅ¼liwoÅ›Ä‡ powrotu do dowolnego punktu na strumieniu zdarzeÅ„,  jeÅ›li przydarzy nam siÄ™ pomyÅ‚ka w kodzie, moÅ¼emy w kaÅ¼dej chwili powrÃ³ciÄ‡ do poprawnego stanu,  tworzenie wynikowego stanu (w postaci plikÃ³w) jest niczym innym jak agregacjÄ… pojedynczych eventÃ³w,  debugowanie jest uproszczone, dziÄ™ki moÅ¼liwoÅ›ci przeÅ›ledzenia zmian kaÅ¼dej linijki kodu.WejÅ›cie KafkiPozostaje wiÄ™c pytanie - gdzie przechowywaÄ‡ eventy? JednÄ… z moÅ¼liwych opcji jest wykorzystanie Apache Kafki jako event storeâ€™a, a wiÄ™c skÅ‚adnicy eventÃ³w.Czym jednak jest Kafka? U absolutnych podstaw moÅ¼na o Kafce myÅ›leÄ‡ jako o brokerze komunikatÃ³w - o funkcjonalnoÅ›ci zbliÅ¼onej do ActiveMQ lub RabbitMQ. Po bliÅ¼szym przyjrzeniu siÄ™ tym technologiom okazuje siÄ™ jednak, Å¼e Kafka jest brokerem o diametralnie innej filozofii dziaÅ‚ania niÅ¼ te wczeÅ›niej wspomniane.Klasyczne systemy, jak ActiveMQ, dostarczajÄ…c wiadomoÅ›ci do konsumentÃ³w wykorzystujÄ… model Smart Broker / Dumb Consumer. Oznacza to, Å¼e broker bierze na siebie ciÄ™Å¼ar obsÅ‚ugi dostarczania wiadomoÅ›ci do konsumentÃ³w - a wiÄ™c wybiera i przesyÅ‚a wiadomoÅ›ci do odpowiednich konsumentÃ³w, oczekuje na ACK, a w przypadku bÅ‚Ä™dÃ³w zajmuje siÄ™ obsÅ‚ugÄ… DLQ. Kafka jednak wychodzi z dokÅ‚adnie odwrotnego zaÅ‚oÅ¼enia, przyjmujÄ…c filozofiÄ™ Dumb Broker / Smart Consumer, przerzucajÄ…c na konsumentÃ³w koniecznoÅ›Ä‡ obsÅ‚ugi dostarczania wiadomoÅ›ci.Jak dziaÅ‚a to w praktyce? Kiedy do Kafki wpÅ‚ywa nowy rekord, zostaje on umieszczony na topiku, gdzie otrzymuje swÃ³j offset - w najprostszym ujÄ™ciu jest to numer porzÄ…dkowy danego rekordu na topiku. Kiedy konsument chce skonsumowaÄ‡ jeden z rekordÃ³w musi, w uproszczeniu, wskazaÄ‡ konkretny offset tego rekordu - jest to wiÄ™c zupeÅ‚ne odwrÃ³cenie klasycznego modelu, w ktÃ³rym to broker decyduje, ktÃ³ry rekord naleÅ¼y dostarczyÄ‡ do konsumenta. Takie odwrÃ³cenie kontroli jest niezwykle istotne z punktu widzenia Event Sourcingu, ktÃ³rego jednÄ… z podstaw jest moÅ¼liwoÅ›Ä‡ ponownego przetworzenia strumienia zdarzeÅ„. PoniewaÅ¼ to konsument wskazuje, ktÃ³ry rekord chce odczytaÄ‡, moÅ¼e ustawiÄ‡ siÄ™ na poczÄ…tku strumienia i przetworzyÄ‡ ten strumieÅ„ od nowa. Jednak moÅ¼liwoÅ›ci sÄ… zdecydowanie wiÄ™ksze, na przykÅ‚ad konsument moÅ¼e rozpoczÄ…Ä‡ przetwarzanie od poÅ‚owy strumienia w dowolnym kierunku. Co wiÄ™cej, z punktu widzenia Kafki pobranie dowolnego rekordu, niekoniecznie w naturalnej kolejnoÅ›ci, jest bardzo taniÄ… operacjÄ…. Jest to pierwsza duÅ¼a zaleta Kafki w kontekÅ›cie Event Sourcingu - natywne wsparcie dla ponownego przetwarzania strumienia zdarzeÅ„.KolejnÄ… zaletÄ… jest obsÅ‚uga pokaÅºnych wolumenÃ³w danych. DuÅ¼e systemy mogÄ… generowaÄ‡ miliardy eventÃ³w. Nawet jeÅ›li rozmiar pojedynczych eventÃ³w jest bardzo maÅ‚y, to efekt skali powoduje, Å¼e ich sumaryczna wielkoÅ›Ä‡ moÅ¼e swobodnie przekraczaÄ‡ terabajty. RÃ³wnieÅ¼ tutaj Kafka nie zawodzi, obsÅ‚ugujÄ…c liniowo zarÃ³wno wolumen danych o wielkoÅ›ci 50 KB jak i 50 TB [3]. Jest to kolejna duÅ¼a zaleta bezpoÅ›rednio zwiÄ…zana z Event Sourcingiem - Kafka Å›wietnie sprawdza siÄ™ w charakterze event storeâ€™a.Na tym zalety Kafki siÄ™ nie koÅ„czÄ…, a jednÄ… z najwiÄ™kszych jest ujednolicenie modeli kolejek oraz publisher-subscriber. Niestety, jest to juÅ¼ poza zakresem niniejszego artykuÅ‚u.ZarzutyJak wobec tego prezentujÄ… siÄ™ zarzuty wobec Kafki w kontekÅ›cie Event Sourcingu?Pierwszy z nich dotyczy trudnoÅ›ci z odczytem eventÃ³w dla konkretnego obiektu. Postuluje on koniecznoÅ›Ä‡ przetworzenia caÅ‚ego strumienia zdarzeÅ„ celem odnalezienia eventÃ³w dotyczÄ…cych interesujÄ…cej nas instancji obiektu [1]. Jest to jednak bÅ‚Ä™dny argument - z co najmniej kilku powodÃ³w. Po pierwsze, w dobie rozwiÄ…zaÅ„ takich jak KSQL, odczytanie konkretnych eventÃ³w jest jak najbardziej moÅ¼liwe [4]. Po drugie, argument ten rozmija siÄ™ z faktycznÄ… ideÄ… Event Sourcingu, ktÃ³rego podstawÄ… nie jest sposÃ³b wyznaczania wynikowego stanu, a sam fakt odzwierciedlania wszystkich zmian stanu w postaci eventÃ³w. Kwestia agregacji eventÃ³w do wynikowego (lub poÅ›redniego) stanu jest juÅ¼ drugorzÄ™dna, w sporej mierze zaleÅ¼y od konkretnego rozwiÄ…zania i jako taka nie definiuje Event Sourcingu.Kolejne zarzuty dotyczÄ… spÃ³jnoÅ›ci zapisu [1] - kiedy po odczytaniu stanu konkretnego obiektu w wyniku logiki biznesowej generujemy kolejny event zmieniajÄ…cy stan tego obiektu, moÅ¼e dojÅ›Ä‡ do sytuacji, w ktÃ³rej inny wÄ…tek w miÄ™dzyczasie nadpisze lub usunie obiekt, na ktÃ³rym dziaÅ‚amy. Zarzut dotyczy w praktyce braku blokad na obiektach, znanych z klasycznych baz danych. W ogÃ³lnoÅ›ci rozwiÄ…zaniem tego problemu jest zapewnienie jednowÄ…tkowych zapisÃ³w, jednak autor przywoÅ‚anego artykuÅ‚u sugeruje, Å¼e bÄ™dzie to miaÅ‚o drastyczny wpÅ‚yw na wydajnoÅ›Ä‡ zapisu. I tutaj Kafka przychodzi nam z pomocÄ… - topiki na Kafce mogÄ… zostaÄ‡ podzielone na partycje, co w poÅ‚Ä…czeniu z Å‚atwym umieszczaniem eventÃ³w dotyczÄ…cych pojedynczego obiektu na jednej partycji, pozwala bezproblemowo zrÃ³wnolegliÄ‡ przetwarzanie, nie naruszajÄ…c zasady jednowÄ…tkowego zapisu - tym samym obalajÄ…c niniejszy zarzut.PodsumowujÄ…c, nie mam wÄ…tpliwoÅ›ci, Å¼e Kafka nadaje siÄ™ do implementacji Event Sourcingu. Z jednej strony, dziÄ™ki natywnemu wsparciu dla ponownego przetwarzania eventÃ³w oraz radzeniu sobie z duÅ¼ym wolumenem danych, jest to naturalny wybÃ³r jako event store. ProstÄ… pochodnÄ… tych dwÃ³ch wÅ‚aÅ›ciwoÅ›ci sÄ… pozostaÅ‚e zalety Event Sourcingu - zrzuty stanu z dowolnego momentu, Å‚atwe odzwierciedlanie stanu w innej technologii, czy teÅ¼ prostsze debugowanie. Z drugiej strony, dziÄ™ki bardziej zaawansowanym moÅ¼liwoÅ›ciom przetwarzania eventÃ³w - jak streamy, KSQL, czy zrÃ³wnoleglanie przetwarzania topikÃ³w - Kafka staje siÄ™ Å›wietnÄ… podstawÄ… do implementacji szeroko rozumianego Event Sourcingu.Na zakoÅ„czenie naleÅ¼y jeszcze zauwaÅ¼yÄ‡, Å¼e Event Sourcing jest wzorcem technologicznie agnostycznym - nieprzywiÄ…zanym do Å¼adnej konkretnej technologii. IstniejÄ… rozwiÄ…zania, jak Apache Kafka, ktÃ³re znaczÄ…co uÅ‚atwiajÄ… implementacjÄ™ Event Sourcingu, jednak nic nie stoi na przeszkodzie, Å¼eby zaimplementowaÄ‡ go w oparciu o MySQL, MongoDB lub jeszcze innÄ… technologiÄ™ pozwalajÄ…cÄ… na przechowywanie uszeregowanych eventÃ³w. Ostatecznie idea Event Sourcingu jest prosta: kaÅ¼da zmiana stanu systemu reprezentowana jest przez ciÄ…g uszeregowanych eventÃ³w - a technologia jest juÅ¼ sprawÄ… drugorzÄ™dnÄ….JeÅ›li chcecie dowiedzieÄ‡ siÄ™ wiÄ™cej na temat Event Sourcingu, zapraszamy na pierwszÄ… edycjÄ™ Consdata Tech! WiÄ™cej informacji na temat caÅ‚ego wydarzenia znajdziecie pod tym linkiem: https://consdata.tech/. Co waÅ¼ne, podczas tego meetupu bÄ™dzie streaming, na ktÃ³rym warto byÄ‡: http://consdata.tech/streaming.Å¹rÃ³dÅ‚a:  [1] https://medium.com/serialized-io/apache-kafka-is-not-for-event-sourcing-81735c3cf5c  [2] https://martinfowler.com/eaaDev/EventSourcing.html  [3] https://kafka.apache.org/intro  [4] https://www.confluent.io/product/ksql/",
"url": "/2018/11/15/czy-apache-kafka-nadaje-sie-do-event-sourcingu.html",
"author": "Marcin Mergo",
"authorUrl": "/authors/mmergo.html",
"image": "mmergo.webp",
"highlight": "/assets/img/posts/2018-11-15-czy-apache-kafka-nadaje-sie-do-event-sourcingu/kafka-apache.png",
"date": "15-11-2018",
"path": "pl/2018-11-15-czy-apache-kafka-nadaje-sie-do-event-sourcingu"
}
,


"2018-08-07-algorytmy-rekomendacyjne-przyklad-implementacji-w-pythonie-html": {
"title": "Algorytmy rekomendacyjne - przykÅ‚ad implementacji w Pythonie",
"lang": "pl",
"tags": "algorytmy rekomendacyjne python",
"content": "Gdy robimy zakupy w internecie, czÄ™sto zdarza siÄ™, Å¼e przez kolejne dni pokazujÄ… nam siÄ™ propozycje produktÃ³w, podobnych do tych, ktÃ³re wczeÅ›niej oglÄ…daliÅ›my. Atrakcyjne ceny powodujÄ…, iÅ¼ czasem ulegamy presji reklamy, decydujemy siÄ™ na zapoznanie siÄ™ z ofertÄ… iâ€¦dokonujemy zakupu. Jak to siÄ™ dzieje, Å¼e przeglÄ…darka wie, co chcemy kupiÄ‡, zobaczyÄ‡ czy posÅ‚uchaÄ‡? Za to wszystko odpowiadajÄ… systemy rekomendacyjne.Systemy rekomendacyjne widzimy wszÄ™dzie tam, gdzie uÅ¼ytkownik ma stycznoÅ›Ä‡ z ogromnymi katalogami danych, np. Amazon podpowiada nam, jakie produkty powinniÅ›my kupiÄ‡, Netflix - jakie filmy oglÄ…daÄ‡, a Spotify - ktÃ³re utwory na pewno nam siÄ™ spodobajÄ…. Wykorzystywane sÄ… przez coraz wiÄ™kszÄ… iloÅ›Ä‡ usÅ‚ug, a ich popularnoÅ›Ä‡ stale roÅ›nie. Odpowiada za to koncepcja â€œLong Tailâ€.W 1988 roku brytyjski alpinista Joe Simpson napisaÅ‚ ksiÄ…Å¼kÄ™ pod tytuÅ‚em â€Touching the Voidâ€, w ktÃ³rej opisaÅ‚ swoje zmagania w peruwiaÅ„skich Alpach. Publikacja cieszyÅ‚a siÄ™ zainteresowaniem, wkrÃ³tce jednak zostaÅ‚aby zapomniana, gdyby nie Jon Krakauer, ktÃ³ry dekadÄ™ pÃ³Åºniej napisaÅ‚ â€Into Thin Airâ€, czyli kolejnÄ… pozycjÄ™ o wspinaczkowych starciach. Po jej wydaniu ksiÄ…Å¼ka Joe Simspona nagle wrÃ³ciÅ‚a do sprzedaÅ¼y, nastÄ…piÅ‚y dodruki, aby nadÄ…Å¼yÄ‡ za popytem. Co wiÄ™cej, przez czternaÅ›cie tygodni znajdowaÅ‚a siÄ™ na liÅ›cie bestsellerÃ³w NewYork Times i sprzedano jej dwukrotnie wiÄ™cej niÅ¼ dzieÅ‚o Krakauera! Dlaczego tak siÄ™ staÅ‚o? OtÃ³Å¼ Amazon zarekomendowaÅ‚ ksiÄ…Å¼kÄ™ â€Touching the Voidâ€ podczas zakupu â€Into Thin Airâ€, jako ksiÄ…Å¼kÄ™, ktÃ³ra rÃ³wnieÅ¼ moÅ¼e spodobaÄ‡ siÄ™ kupujÄ…cemu. Teoria Long Tail sugeruje, Å¼e na rynku internetowym sumaryczny dochÃ³d ze sprzedaÅ¼y pojedynczych towarÃ³w niszowych, moÅ¼e generowaÄ‡ wyÅ¼sze zyski, niÅ¼ oferowane masowo produkty popularne, tzw. bestsellery.Najciekawszym rodzajem rekomendacji sÄ… te bazujÄ…ce na danych o konkretnych uÅ¼ytkownikach. MoÅ¼emy tu wyrÃ³Å¼niÄ‡ dwa podejÅ›cia:  Content Based Filtering, ktÃ³ry opiera siÄ™ na cechach, typach produktÃ³w, szukajÄ…c podobnych do tych, ktÃ³re uÅ¼ytkownik juÅ¼ oceniÅ‚ pozytywnie lub kupiÅ‚,  Collaborative Filtering, czyli rekomendacje na podstawie ocen i zakupÃ³w uÅ¼ytkownika. Gdy dwÃ³ch uÅ¼ytkownikÃ³w kupuje podobne produkty, moÅ¼emy stwierdziÄ‡, Å¼e majÄ… zbliÅ¼one upodobania i polecaÄ‡ im wzajemnie sprawdzone dla nich artykuÅ‚y.Collaborative Filtering â€“ przykÅ‚ad implementacjiCollaborative Filtering dzieli siÄ™ na jeszcze dwa rodzaje:  Item-based, ktÃ³ry bazujÄ…c tylko na ocenach, wyszukuje podobne przedmioty i je rekomenduje,  User-based, ktÃ³rego przykÅ‚ad implementacji szerzej omÃ³wimy.Zasada jest prosta. WyobraÅºmy sobie, Å¼e mamy uÅ¼ytkownika X. Dla tego uÅ¼ytkownika znajdujemy grupÄ™ innych uÅ¼ytkownikÃ³w, ktÃ³rzy sÄ… do siebie podobni, np. zgodnie oceniajÄ… te same filmy. Jest to tzw. sÄ…siedztwo uÅ¼ytkownika X. W tej grupie znajdujemy zbiÃ³r filmÃ³w, ktÃ³re rÃ³wnieÅ¼ sÄ… przez niÄ… wysoko oceniane, a uÅ¼ytkownik X ich nie oglÄ…daÅ‚ i rekomendujemy mu je. Dane, z ktÃ³rych skorzystaÅ‚am, pochodzÄ… ze strony MovieLens. W zbiorze danych znajduje siÄ™ m.in. 100.000 ocen uÅ¼ytkownikÃ³w w skali 1-5.import pandas as pdratings_columns = [&#39;user_id&#39;, &#39;movie_id&#39;, &#39;rating&#39;, &#39;timestamp&#39;]ratings = pd.read_csv(&#39;u.data&#39;, sep=&#39;\\t&#39;, names=ratings_columns, encoding=&#39;latin-1&#39;)ratings.drop( &quot;timestamp&quot;, inplace = True, axis = 1 )print ratings.shaperatings.head(10)Na podstawie tej tabelki utworzymy macierz ocen filmÃ³w userId x movieId.user_movies = ratings.pivot( index=&#39;user_id&#39;, columns=&#39;movie_id&#39;, values = &quot;rating&quot; ).reset_index(drop=True)user_movies.fillna( 0, inplace = True )user_movies=pd.DataFrame(user_movies)print user_movies.shapeuser_movies.head()Kolejnym krokiem jest wyznaczenie n-tego sÄ…siedztwa uÅ¼ytkownika X, czyli grupy najbardziej podobnych mu osÃ³b. Aby to zrobiÄ‡, potrzebujemy miary podobieÅ„stwa miÄ™dzy uÅ¼ytkownikami, ktÃ³rych istnieje mnogoÅ›Ä‡, m.in. miarÄ™ cosinusowÄ…, wspÃ³Å‚czynnik Jaccarda. Ja uÅ¼yjÄ™ wspÃ³Å‚czynnika korelacji Pearsona. Miara ta mieÅ›ci siÄ™ w przedziale zamkniÄ™tym [-1, 1], gdzie 1 bÄ™dzie oznaczaÅ‚a stuprocentowe podobieÅ„stwo.Nie pokuszÄ™ siÄ™ jednak o implementacjÄ™ tego wzoru, a wykorzystam gotowÄ… funkcjÄ™ z biblioteki SciPy.from sklearn.metrics.pairwise import pairwise_distancesusers_similarity = 1 - pairwise_distances( user_movies.as_matrix(), metric=&quot;correlation&quot; )users_similarity_df = pd.DataFrame( users_similarity )print users_similarity.shapeusers_similarity_df.head()OtrzymaliÅ›my macierz userId x userId z wyliczonymi wartoÅ›ciami podobieÅ„stwa miÄ™dzy kaÅ¼dym uÅ¼ytkownikiem. MoÅ¼emy teÅ¼ z niej zauwaÅ¼yÄ‡, Å¼e uÅ¼ytkownicy sÄ… najbardziej podobni doâ€¦ samych siebie (wartoÅ›Ä‡ 1 po przekÄ…tnej macierzy). Do dalszych obliczeÅ„ wypeÅ‚nilibyÅ›my przekÄ…tnÄ… macierzy zerami, aby nie zakÅ‚amywaÄ‡ wynikÃ³w. Tak to wyglÄ…da krok po kroku. Tak naprawdÄ™ Python uÅ‚atwia nam obliczenia jeszcze bardziej, oferujÄ…c metodÄ™ NearestNeighbors z biblioteki sklearn, w ktÃ³rej to moÅ¼emy podaÄ‡ np. wielkoÅ›Ä‡ szukanego sÄ…siedztwa, czy metodÄ™ obliczania podobieÅ„stwa.from sklearn.neighbors import NearestNeighborsdef find_neighborhood(user_id, n):    model_knn = NearestNeighbors(metric = &quot;correlation&quot;, algorithm = &quot;brute&quot;)    model_knn.fit(user_movies)    distances, indices = model_knn.kneighbors(user_movies.iloc[user_id-1, :].values.reshape(1, -1), n_neighbors = n+1)    similarities = 1-distances.flatten()    print &#39;{0} most similar users for user with id {1}:\\n&#39;.format(n, user_id)    for i in range(0, len(indices.flatten())):        # pomiÅ„, jeÅ›li ten sam uÅ¼ytkownik        if indices.flatten()[i]+1 == user_id:            continue;        else:            print &#39;{0}: User {1}, with similarity of {2}&#39;.format(i, indices.flatten()[i]+1, similarities.flatten()[i])    return similarities,indicesPowyÅ¼sza funkcja posÅ‚uÅ¼y nam do wylistowania sÄ…siedztwa danego uÅ¼ytkownika. Przyjmuje ona id uÅ¼ytkownika, ktÃ³rego sÄ…siedztwa szukamy oraz jego rozmiar. WykorzystujÄ…c wspÃ³Å‚czynnik korelacji Pearsona, na podstawie naszej pierwszej tabelki z ocenami uÅ¼ytkownikÃ³w otrzymamy odlegÅ‚oÅ›ci miÄ™dzy uÅ¼ytkownikiem â€wejÅ›ciowymâ€ a kaÅ¼dym pozostaÅ‚ym oraz odpowiadajÄ…ce im id userÃ³w. NastÄ™pnie w pÄ™tli moÅ¼emy wylistowaÄ‡ sÄ…siedztwo uÅ¼ytkownika, pomijajÄ…c przy tym jego samego.NastÄ™pnym krokiem bÄ™dzie przywidywanie ocen uÅ¼ytkownika.import numpy as npdef predict_rate(user_id, item_id, n):    similarities, indices=find_neighborhood(user_id, n)    neighborhood_ratings =[]    for i in range(0, len(indices.flatten())):        if indices.flatten()[i]+1 == user_id:            continue;        else:            neighborhood_ratings.append(user_movies.iloc[indices.flatten()[i],item_id-1])    weights = np.delete(indices.flatten(), 0) #delete weight for input user    prediction = round((neighborhood_ratings * weights).sum() / weights.sum())    print &#39;\\nPredicted rating for user {0} -&amp;gt; item {1}: {2}&#39;.format(user_id,item_id,prediction)Za pomocÄ… funkcji find_neighborhood znajdziemy dla niego sÄ…siedztwo n uÅ¼ytkownikÃ³w, ktÃ³rzy ocenili film, ktÃ³rego ocenÄ™ bÄ™dziemy przewidywaÄ‡. Z takÄ… wiedzÄ…, w pÄ™tli tworzymy listÄ™ ocen danego filmu przez podobnych mu uÅ¼ytkownikÃ³w. Jak teraz obliczyÄ‡ prawdopodobnÄ… ocenÄ™? Najprostszym z rozwiÄ…zaÅ„ jest policzenie Å›redniej ocen caÅ‚ego sÄ…siedztwa uÅ¼ytkownika dla tego filmu i zaprezentowaÄ‡ to jako nasze przewidywanie. Niestety to rozwiÄ…zanie ignoruje wartoÅ›Ä‡ podobieÅ„stwa miÄ™dzy uÅ¼ytkownikami, wiÄ™c lepszym podejÅ›ciem policzenie Å›redniej waÅ¼onej. Jako wagi przyjmiemy â€odlegÅ‚oÅ›ciâ€ miÄ™dzy uÅ¼ytkownikami, ktÃ³re zwrÃ³ciÅ‚a nam funkcja w zmiennej indices. OtrzymujÄ…c spodziewany oceny uÅ¼ytkownikÃ³w dla danych filmÃ³w, moÅ¼emy zarekomendowaÄ‡ mu listÄ™ filmÃ³w, ktÃ³re bÄ™dÄ… bliskie jego upodobaniom.PodsumowaniePowyÅ¼szy przykÅ‚ad implementacji jest oczywiÅ›cie bardzo podstawowym. DuÅ¼e portale korzystajÄ… raczej z hybrydowych rozwiÄ…zaÅ„, prÃ³bujÄ…c jak najbardziej trafnie oszacowaÄ‡ nasze upodobania. Ich metody rekomendacji bazujÄ… na tak duÅ¼ych danych i sÄ… tak czasochÅ‚onne, Å¼e rekomendacje nie sÄ… obliczane na bieÅ¼Ä…co, po kaÅ¼dej ocenie uÅ¼ytkownika, czy po kaÅ¼dym zakupie, a sÄ… uaktualniane raz na kilka dni.",
"url": "/2018/08/07/algorytmy-rekomendacyjne-przyklad-implementacji-w-pythonie.html",
"author": "Sylwia ÃœÃ§Ã¼ncÃ¼",
"authorUrl": "/authors/sucuncu.html",
"image": "sucuncu.jpg",
"highlight": "/assets/img/posts/2018-08-07-algorytmy-rekomendacyjne-przyklad-implementacji-w-pythonie/algorytmy-rekomendacyjne.jpg",
"date": "07-08-2018",
"path": "pl/2018-08-07-algorytmy-rekomendacyjne-przyklad-implementacji-w-pythonie"
}
,


"2018-04-23-practical-applications-of-webhooks-html": {
"title": "Practical applications of webhooks",
"lang": "en",
"tags": "sonarqube webhook",
"content": "Sooner or later every developer will have to deal with some form of API - an interface through which two independent applications can communicate. In this article I will present an approach to this type of communication that is a bit different from the traditional one.What are webhooks?Letâ€™s assume you have written some application A and you want it to be able to display some data from application B, e.g. a list of active users. For this purpose, application B gives you access to an API that enables downloading the list of active users. In a conventional approach you would need to request application B for an up-to-date list of active users, but it would be much more convenient if application B informed your application about any changes in the list. This is what webhooks can help you achieve.Webhooks enable a different approach to communication between applications. The webhook mechanism is often called Reverse API because it usually does not require interaction from the client side (in our example, application A). In simpler terms, webhooks allow the client application to be notified when certain events occur.Webhooks are easy to implement because they actually consist in sending a request with a defined structure, to a defined address, as a result of some event. Integrating the client application comes down to defining the address to which the request is to be sent.Summing up, webhooks are very useful in situations when you expect information from an external application in the case of an event as they allow you to avoid active waiting on your applicationâ€™s side.However, there are two disadvantages of webhooks that should be mentioned:  when an error occurs in the application, external data can be lost because there is no certainty that the external application will in any way respond to the error that you report - in the case of a classic API you could retry to query the external application;  when handling webhooks, you must take into account that the events which you are notified about may occur very frequently - usually you do not have control over it.Integration exampleUsing our open-source project, SonarQube Companion, as an example, I will explain how several applications can be easily integrated with webhooks.Letâ€™s integrate SonarQube Companion with the Slack messenger. The result of the integration will be a message on a Slack channel stating how the number of a teamâ€™s violations has changed over the last day.Prerequisites:  familiarize yourself with the article about SonarQube Companion,  configure SonarQube Companion,  get Slack.First, you need to configure a webhook on Slackâ€™s side. To do this, go to the messengerâ€™s integration settings, add the â€œIncoming WebHooksâ€ app configuration and define which channel you want to send messages to:After a successful configuration, you should see a notification in the channel:The next step is to configure the webhook on SonarQube Companionâ€™s side, which is a little bit more complex. Each of the defined groups may contain its own definition of webhooks. The definition of a webhook consists of three basic elements:  action â€“ a certain event/behavior that is to be executed,  trigger â€“ defines when an action is to be executed,  callback â€“ determines in what way the client application is to be informed about the actionâ€™s results.A full documentation of available actions, triggers and callbacks is located in this GitHub repositoryAs an example, letâ€™s define a webhook that will check how the number of violations within a team has changed over the last day. Depending on the result, an appropriate message will be sent to the messengerâ€™s channel.First, define what action should result in sending the message. To do this, define an action for a new webhook in the webhooks node:&quot;webhooks&quot;: [{    &quot;action&quot;: {    &quot;type&quot;: &quot;NO_IMPROVEMENT&quot;,    &quot;period&quot;: &quot;DAILY&quot;,    &quot;severity&quot;: [&quot;blockers&quot;, &quot;criticals&quot;, &quot;majors&quot;]    }}]In this way, you have defined an action that will check whether the number of violations in the groupâ€™s projects has improved during the last day. Additionally, it will take into account only the violations with the following priorities: blocker, critical and major.The next step is to define an action trigger. In our example, for simplicity, we would like the action to be executed every minute. To achieve that, define a CRON-type trigger:&quot;trigger&quot;: {    &quot;type&quot;: &quot;CRON&quot;,    &quot;definition&quot;: &quot;0 */1 * * * *&quot;}Finally, you need to define the actual integration with the messenger. To do that, define a POST-type callback, including the URL obtained from the â€œWebhook URLâ€ field of Slackâ€™s configuration panel.&quot;callbacks&quot;: [    {        &quot;type&quot;: &quot;POST&quot;,        &quot;url&quot;: &quot;https://hooks.slack.com/services/*/*&quot;,        &quot;body&quot; : {            &quot;no_improvement&quot;: &quot;{ &#39;text&#39;: &#39;http://gph.is/1RFg2r3 Brak poprawy&#39;}&quot;,            &quot;improvement&quot;: &quot;{ &#39;text&#39;: &#39;http://gph.is/1a7RlDR Poprawiono ${diff}&#39;&quot;,            &quot;clean&quot;: &quot;{ &#39;text&#39;: &#39;https://gph.is/1IH3RW6 Czysto&#39;}&quot;        }    }]In the body section you need to define the content of the message to be sent depending on the state of the group. For example, if the state of violations has improved (the â€œimprovementâ€ response), a gif will be sent along with a short comment containing a predefined action variable - ${diff}. In this way, the channel will show information about the number of corrected violations during the last day.The whole configuration looks as follows:&quot;webhooks&quot;: [    {        &quot;action&quot;: {        &quot;type&quot;: &quot;NO_IMPROVEMENT&quot;,        &quot;period&quot;: &quot;DAILY&quot;,        &quot;severity&quot;: [&quot;blockers&quot;, &quot;criticals&quot;, &quot;majors&quot;]        },        &quot;trigger&quot;: {            &quot;type&quot;: &quot;CRON&quot;,            &quot;definition&quot;: &quot;0 */1 * * * *&quot;        },        &quot;callbacks&quot;: [{            &quot;type&quot;: &quot;POST&quot;,            &quot;url&quot;: &quot;https://hooks.slack.com/services/*/*&quot;,            &quot;body&quot; : {                &quot;no_improvement&quot;: &quot;{ &#39;text&#39;: &#39;http://gph.is/1RFg2r3 Brak poprawy&#39;}&quot;,                &quot;improvement&quot;: &quot;{ &#39;text&#39;: &#39;http://gph.is/1a7RlDR Poprawiono ${diff}&#39;&quot;,                &quot;clean&quot;: &quot;{ &#39;text&#39;: &#39;https://gph.is/1IH3RW6 Czysto&#39;}&quot;            }        }]    }]In this way, SonarQube Companion will check the state of the groupâ€™s violations every minute and, depending on the result, will send the relevant message to the messengerâ€™s channel.As a result, a message about the lack of improvement of any violations appears in the channel:After one violation has been corrected, the relevant message will be generated in the next minute:In this way, you have integrated two independent applications using the webhooks mechanism, without having to write a single line of code.SummaryIn this article I presented the concept of webhooks and showed you how to integrate two independent applications in a simple and quick way. We are going to gradually extend SonarQube Companion with new actions, e.g. sending weekly reports about violations to particular users so I recommend staying tuned to the projectâ€™s website.Useful links:  https://github.com/Consdata/sonarqube-companion  https://github.com/Consdata/sonarqube-companion/wiki/Webhooks",
"url": "/2018/04/23/practical-applications-of-webhooks.html",
"author": "Bartosz RadliÅ„ski",
"authorUrl": "/authors/bradlinski.html",
"image": "bradlinski.webp",
"highlight": "/assets/img/posts/2018-04-23-praktyczne-zastosowanie-webhook/webhook.png",
"date": "23-04-2018",
"path": "en/2018-04-23-practical-applications-of-webhooks"
}
,


"2018-03-26-terraform-czyli-o-tym-jak-okielznac-chmure-od-amazona-html": {
"title": "Terraform - czyli o tym, jak okieÅ‚znaÄ‡ chmurÄ™ od Amazona",
"lang": "pl",
"tags": "terraform aws",
"content": "â€œGet your clouds right.â€ Dwight Schrute, The OfficeNie tak dawno temu, Jakub Wilczewski opublikowaÅ‚ wyczerpujÄ…cy wstÄ™p do programowania w AWS. Jakub uÅ¼yÅ‚ webowej konsoli AWS do definiowania zasobÃ³w. Jest to metoda, ktÃ³ra sprawdza siÄ™ w przypadku prezentacji oraz nauki. Jednak w przypadku regularnej pracy z kodem, potrzebujemy narzÄ™dzi, ktÃ³re umoÅ¼liwiÄ… nam zautomatyzowanie procesu tworzenia a takÅ¼e niszczenia zasobÃ³w AWS. Wykorzystam zaproponowanÄ… przez niego aplikacjÄ™, aby pokazaÄ‡, jak moÅ¼na to zrobiÄ‡, korzystajÄ…c z rozwiÄ…zania Terraform od firmy Hashicorp.Konfiguracja i pierwsza terraformacja chmuryFirmÄ™ Hashicorp powinni kojarzyÄ‡ wszyscy, ktÃ³rzy mieli do czynienia z rozwiÄ…zaniami chmurowymi. Stoi ona za takimi rozwiÄ…zaniami jak Vault, Consul czy Vagrant. Terraform jest ich odpowiedziÄ… na jeden z paradygmatÃ³w kultury devops, jakim jest â€œinfrastructure as codeâ€.Zanim przystÄ…pimy do terraformacji chmury AWS potrzebne bÄ™dÄ… dwie binarki:  https://aws.amazon.com/cli/  https://www.terraform.io/downloads.htmlAWS CLI jest co prawda opcjonalny, ale pozwala uwolniÄ‡ skrypty Terraform od danych logowania uÅ¼ytkownika. Å»eby to osiÄ…gnÄ…Ä‡, wystarczy jednorazowo zalogowaÄ‡ siÄ™ do konsoli AWS, wydajÄ…c polecenie:$ aws configureAWS Access Key ID [None]: xxxAWS Secret Access Key [None]: xxxDefault region name [None]: eu-central-1Default output format [None]:JednÄ… z najbardziej elementarnych czynnoÅ›ci zwiÄ…zanych z pracÄ… z chmurÄ… Amazonu jest utworzenie nowej â€œwirtualkiâ€, czyli instancji usÅ‚ugi EC2. Oto minimalny skrypt Terraform, ktÃ³ry tÄ™ czynnoÅ›Ä‡ automatyzuje:provider &quot;aws&quot; {  version = &quot;~&amp;gt; 0.1&quot;  region = &quot;eu-central-1&quot;}resource &quot;aws_instance&quot; &quot;step0&quot; {  ami = &quot;ami-13b8337c&quot;  instance_type = &quot;t2.micro&quot;}Pierwsza sekcja wskazuje dostawcÄ™ usÅ‚ug, druga jest dyrektywÄ… uruchomienia instancji EC2 z obrazu o identyfikatorze ami-13b8337c. Numer taki moÅ¼na podejrzeÄ‡ w konsoli webowej AWS albo u autora konkretnej dystrybucji systemu operacyjnego, na przykÅ‚ad Ubuntu.W celu uruchomienia procesu tworzenia zasobÃ³w, naleÅ¼y wykonaÄ‡ sekwencje poleceÅ„$ terraform init$ terraform plan$ terraform applyPierwsze polecenie uruchamiamy raz w katalogu ze skryptem i spowoduje ono pobranie bibliotek koniecznych do komunikacji z dostawcÄ… usÅ‚ug. Drugie polecenie wydrukuje na wyjÅ›ciu plan wykonania skryptu, ktÃ³ry zostanie uruchomiony trzecim poleceniem. Po kilkunastu sekundach, instancja powinna byÄ‡ uruchomiona i gotowa do pracy. Na zakoÅ„czenie polecenie, ktÃ³re jest wisienkÄ… na torcie, czyli wycofanie wszystkich zmian wprowadzonych w poprzednim kroku.$ terraform destroyW tym miejscu warto siÄ™ na chwilÄ™ zatrzymaÄ‡ i wyjaÅ›niÄ‡, w jaki sposÃ³b Terraform Å›ledzi stan zmian. Po wykonaniu polecenia â€˜applyâ€™, w katalogu bieÅ¼Ä…cym powstanie plik terraform.tfstate oraz jego kopia terraform.tfstate.backup. Plik ten jest zapisem stanu Å›rodowiska i od tego momentu moÅ¼liwe jest wprowadzanie zmian wyÅ‚Ä…cznie za pomocÄ… Terraforma. JeÅ›li wprowadzimy zmiany z konsoli AWS, to Terraform nie bÄ™dzie ich Å›ledziÅ‚. Nie ma Å¼adnego mechanizmu odpytywania aktualnego stanu chmury. Warto o tym pamiÄ™taÄ‡, pracujÄ…c z Terraformem.Skrypt dla kompletnej aplikacjiPo tym krÃ³tkim wstÄ™pie mamy niezbÄ™dnÄ… wiedzÄ™ pozwalajÄ…cÄ… nam rozpoczÄ…Ä‡ pracÄ™ z automatyzacjÄ… konfiguracji usÅ‚ug w chmurze. Na stronach HashiCorp dokumentujÄ…cych Terraform, moÅ¼na znaleÅºÄ‡ wyczerpujÄ…cy opis wszystkich dyrektyw.Teraz moÅ¼emy przejÅ›Ä‡ do opisu automatyzacji przykÅ‚adowej aplikacji opisanej przez Jakuba. ZdajÄ™ sobie sprawÄ™, Å¼e niektÃ³re elementy mogÄ… byÄ‡ doÅ›Ä‡ skomplikowane na pierwszy rzut oka. Musicie mi jednak uwierzyÄ‡ na sÅ‚owo, Å¼e jak tylko zaczniecie korzystaÄ‡ z tego sposobu konfiguracji, nigdy nie wrÃ³cicie juÅ¼ do rÄ™cznego wyklikiwania z konsoli AWS. Postaram siÄ™ zachowaÄ‡ kolejnoÅ›Ä‡, w ktÃ³rej Jakub dodawaÅ‚ zasoby za pomocÄ… konsoli. ZrezygnujÄ™ jednak z rozbicia na poszczegÃ³lne przepÅ‚ywy, czyli odczyt i zapis notatek bÄ™dÄ™ realizowaÅ‚ rÃ³wnoczeÅ›nie. Zaczynamy zatem od kodu ÅºrÃ³dÅ‚owego, ktÃ³ry umieszczamy w plikach note-find-lambda.js i note-add-lambda.js. PrzygotujÄ™ sobie takÅ¼e pomocniczny skrypt w Bash, ktÃ³ry spakuje kod do archiwum:#!/usr/bin/env bashrm *.zipzip -R note-add-lambda.zip ./note-add-lambda.jszip -R note-find-lambda.zip ./note-find-lambda.jsZaczynamy od zdefiniowania dostawcy, tabeli DynamoDB oraz dwÃ³ch Lambd:provider &quot;aws&quot; {  version = &quot;~&amp;gt; 0.1&quot;  region = &quot;eu-central-1&quot;}resource &quot;aws_dynamodb_table&quot; &quot;notes-table&quot; {  name = &quot;notes&quot;  read_capacity = 1  write_capacity = 1  hash_key = &quot;userName&quot;  range_key = &quot;timestamp&quot;  attribute {    name = &quot;userName&quot;    type = &quot;S&quot;  }  attribute {    name = &quot;timestamp&quot;    type = &quot;N&quot;  }}resource &quot;aws_lambda_function&quot; &quot;note-add-lambda&quot; {  filename = &quot;note-add-lambda.zip&quot;  function_name = &quot;note-add-lambda&quot;  role = &quot;${aws_iam_role.iam_for_lambda.arn}&quot;  handler = &quot;note-add-lambda.handler&quot;  source_code_hash = &quot;${base64sha256(file(&quot;note-add-lambda.zip&quot;))}&quot;  runtime = &quot;nodejs6.10&quot;  timeout = &quot;10&quot;  memory_size = &quot;256&quot;}resource &quot;aws_lambda_function&quot; &quot;note-find-lambda&quot; {  filename = &quot;note-find-lambda.zip&quot;  function_name = &quot;note-find-lambda&quot;  role = &quot;${aws_iam_role.iam_for_lambda.arn}&quot;  handler = &quot;note-find-lambda.handler&quot;  source_code_hash = &quot;${base64sha256(file(&quot;note-find-lambda.zip&quot;))}&quot;  runtime = &quot;nodejs6.10&quot;  timeout = &quot;10&quot;  memory_size = &quot;256&quot;}NastÄ™pnie musimy wprost zdefiniowaÄ‡ coÅ›, co w przypadku tworzenia z poziomu konsoli web zadziaÅ‚o siÄ™ â€œautomagicznieâ€, czyli uprawnienie dla Lambd do korzystania z tabeli w DynamoDB. MoÅ¼emy zrobiÄ‡ to w nastÄ™pujÄ…cy sposÃ³b.resource &quot;aws_iam_role&quot; &quot;iam_for_lambda&quot; {  name = &quot;iam_for_lambda&quot;  assume_role_policy = EOF{  &quot;Version&quot;: &quot;2012-10-17&quot;,  &quot;Statement&quot;: [    {      &quot;Action&quot;: &quot;sts:AssumeRole&quot;,      &quot;Principal&quot;: {        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;      },      &quot;Effect&quot;: &quot;Allow&quot;,      &quot;Sid&quot;: &quot;&quot;    }  ]}EOF}resource &quot;aws_iam_role_policy&quot; &quot;role_policy_for_dynamodb_access&quot; {  name = &quot;role_policy_for_dynamodb_access&quot;  role = &quot;${aws_iam_role.iam_for_lambda.id}&quot;  policy = EOF{    &quot;Version&quot;: &quot;2012-10-17&quot;,    &quot;Statement&quot;: [        {            &quot;Sid&quot;: &quot;AccessAllNotes&quot;,            &quot;Effect&quot;: &quot;Allow&quot;,            &quot;Action&quot;: [                &quot;dynamodb:*&quot;            ],            &quot;Resource&quot;: [                &quot;*&quot;            ]        }    ]}EOF}Na tym etapie skrypt jest gotowy do uruchomienia i testowania z poziomu samych Lambd. Kolejnym elementem bÄ™dzie wystawienie usÅ‚ug na Å›wiat, czyli wygenerowanie caÅ‚ej otoczki zwiÄ…zanej z usÅ‚ugÄ… API Gateway. ElementÃ³w jest niemaÅ‚o, ale wszystkie one skÅ‚adajÄ… siÄ™ na elegancki opis API wystawionego w przypadku prostej aplikacji zarzÄ…dzajÄ…cej notatkami.W pierwszej kolejnoÅ›ci tworzymy elementy Å›cieÅ¼ki URI://COMMON APIresource &quot;aws_api_gateway_rest_api&quot; &quot;NotesAPI&quot; {  name = &quot;NotesAPI&quot;}resource &quot;aws_api_gateway_resource&quot; &quot;notes-resource&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  parent_id = &quot;${aws_api_gateway_rest_api.NotesAPI.root_resource_id}&quot;  path_part = &quot;notes&quot;}resource &quot;aws_api_gateway_resource&quot; &quot;notes-userName-resource&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  parent_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  path_part = &quot;{userName}&quot;}Teraz kolej na usÅ‚ugÄ™ GET oraz jej integracjÄ™ z note-find-lambda://GET IMPLEMENTATIONresource &quot;aws_api_gateway_method&quot; &quot;notes-get-method&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;GET&quot;  authorization = &quot;NONE&quot;  api_key_required = true}resource &quot;aws_api_gateway_method_response&quot; &quot;notes-get-method-response-ok-200&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-get-method.http_method}&quot;  status_code = &quot;200&quot;}resource &quot;aws_api_gateway_method_response&quot; &quot;notes-get-method-response-not-found-error-404&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-get-method.http_method}&quot;  status_code = &quot;404&quot;}resource &quot;aws_api_gateway_integration&quot; &quot;notes-get-integration&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-get-method.http_method}&quot;  integration_http_method = &quot;POST&quot;  type = &quot;AWS&quot;  uri = &quot;arn:aws:apigateway:eu-central-1:lambda:path/2015-03-31/functions/${aws_lambda_function.note-find-lambda.arn}/invocations&quot;  request_templates {    &quot;application/json&quot; = EOF    {       &quot;userName&quot;: &quot;$input.params(&#39;userName&#39;)&quot;    }    EOF  }}resource &quot;aws_api_gateway_integration_response&quot; &quot;notes-get-integration-response&quot; {  depends_on = [    &quot;aws_api_gateway_integration.notes-get-integration&quot;]  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-get-method.http_method}&quot;  status_code = &quot;${aws_api_gateway_method_response.notes-get-method-response-ok-200.status_code}&quot;  response_templates {    &quot;application/json&quot; = EOF#set($inputRoot = $input.path(&#39;$&#39;))$inputRoot.ItemsEOF  }}resource &quot;aws_api_gateway_integration_response&quot; &quot;notes-get-integration-response-user-does-not-exist&quot; {  depends_on = [    &quot;aws_api_gateway_integration.notes-get-integration&quot;]  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-userName-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-get-method.http_method}&quot;  status_code = &quot;${aws_api_gateway_method_response.notes-get-method-response-not-found-error-404.status_code}&quot;  selection_pattern = &quot;.*errorCode\\&quot;:\\&quot;USER_DOES_NOT_EXIST.*&quot;  response_templates {    &quot;application/json&quot; = EOF#set ($errorMessageObj = $util.parseJson($input.path(&#39;$.errorMessage&#39;))){  &quot;errorCode&quot; : &quot;$errorMessageObj.errorCode&quot;,  &quot;message&quot; : &quot;$errorMessageObj.message&quot;}EOF  }}resource &quot;aws_lambda_permission&quot; &quot;notes-get-lambda-permision&quot; {  statement_id = &quot;AllowExecutionFromAPIGatewayNotesGet&quot;  action = &quot;lambda:InvokeFunction&quot;  function_name = &quot;${aws_lambda_function.note-find-lambda.arn}&quot;  principal = &quot;apigateway.amazonaws.com&quot;}analogicznie dla POST://POST IMPLEMENTATIONresource &quot;aws_api_gateway_request_validator&quot; &quot;notes-request-validator&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  name = &quot;NotesRequestValidator&quot;  validate_request_body = true}resource &quot;aws_api_gateway_model&quot; &quot;notes-model&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  name = &quot;NotesRequestModel&quot;  content_type = &quot;application/json&quot;  schema = EOF{  &quot;$schema&quot;: &quot;http://json-schema.org/draft-04/schema#&quot;,  &quot;description&quot;: &quot;&quot;,  &quot;type&quot;: &quot;object&quot;,  &quot;properties&quot;: {    &quot;userName&quot;: {      &quot;type&quot;: &quot;string&quot;,      &quot;minLength&quot;: 1    },    &quot;content&quot;: {      &quot;type&quot;: &quot;string&quot;,      &quot;minLength&quot;: 1    }  },  &quot;required&quot;: [    &quot;userName&quot;,    &quot;content&quot;  ]}EOF}resource &quot;aws_api_gateway_method&quot; &quot;notes-post-method&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;POST&quot;  authorization = &quot;NONE&quot;  api_key_required = true  request_models = {    &quot;application/json&quot; = &quot;NotesRequestModel&quot;  }  request_validator_id = &quot;${aws_api_gateway_request_validator.notes-request-validator.id}&quot;  depends_on = [    &quot;aws_api_gateway_model.notes-model&quot;]}resource &quot;aws_api_gateway_method_response&quot; &quot;notes-post-method-response-created-201&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-post-method.http_method}&quot;  status_code = &quot;201&quot;}resource &quot;aws_api_gateway_method_response&quot; &quot;notes-post-method-response-create-400&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-post-method.http_method}&quot;  status_code = &quot;400&quot;}resource &quot;aws_api_gateway_integration&quot; &quot;notes-post-integration&quot; {  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-post-method.http_method}&quot;  integration_http_method = &quot;POST&quot;  type = &quot;AWS&quot;  uri = &quot;arn:aws:apigateway:eu-central-1:lambda:path/2015-03-31/functions/${aws_lambda_function.note-add-lambda.arn}/invocations&quot;  request_templates {    &quot;application/json&quot; = EOF{  &quot;userName&quot; : $input.json(&#39;$.userName&#39;),  &quot;content&quot; : $input.json(&#39;$.content&#39;)}EOF  }}resource &quot;aws_api_gateway_integration_response&quot; &quot;notes-post-integration-response&quot; {  depends_on = [    &quot;aws_api_gateway_integration.notes-post-integration&quot;]  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-post-method.http_method}&quot;  status_code = &quot;${aws_api_gateway_method_response.notes-post-method-response-created-201.status_code}&quot;  response_templates {    &quot;application/json&quot; = EOF#set($inputRoot = $input.path(&#39;$&#39;))$inputRootEOF  }}resource &quot;aws_api_gateway_integration_response&quot; &quot;notes-post-integration-response-error-400&quot; {  depends_on = [    &quot;aws_api_gateway_integration.notes-post-integration&quot;]  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  resource_id = &quot;${aws_api_gateway_resource.notes-resource.id}&quot;  http_method = &quot;${aws_api_gateway_method.notes-post-method.http_method}&quot;  status_code = &quot;${aws_api_gateway_method_response.notes-post-method-response-create-400.status_code}&quot;  selection_pattern = &quot;.*errorCode.*&quot;  response_templates {    &quot;application/json&quot; = EOF#set ($errorMessageObj = $util.parseJson($input.path(&#39;$.errorMessage&#39;))){  &quot;errorCode&quot; : &quot;$errorMessageObj.errorCode&quot;,  &quot;message&quot; : &quot;$errorMessageObj.message&quot;}EOF  }}resource &quot;aws_lambda_permission&quot; &quot;notes-post-lambda-permision&quot; {  statement_id = &quot;AllowExecutionFromAPIGatewayNotesPost&quot;  action = &quot;lambda:InvokeFunction&quot;  function_name = &quot;${aws_lambda_function.note-add-lambda.arn}&quot;  principal = &quot;apigateway.amazonaws.com&quot;}Na zakoÅ„czenie sekcja zwiÄ…zana z osadzeniem API i wystawieniem na zewnÄ…trz. PoniewaÅ¼ API w chwili zakoÅ„czenia wykonywania skryptu zostanie wystawione na Å›wiat, warto zatroszczyÄ‡ siÄ™ o jego podstawowe chociaÅ¼ zabezpieczenia. W dyrektywie aws_api_gateway_api_key moÅ¼emy wskazaÄ‡ token, ktÃ³ry bÄ™dzie niezbÄ™dny do korzystania z usÅ‚ug. W poniÅ¼szym przykÅ‚adzie jest on ustawiony na staÅ‚e, ale nic nie stoi na przeszkodzie, Å¼eby go przekazaÄ‡ w parametrach.resource &quot;aws_api_gateway_deployment&quot; &quot;notes-deployment&quot; {  depends_on = [    &quot;aws_api_gateway_integration.notes-get-integration&quot;,    &quot;aws_api_gateway_integration.notes-post-integration&quot;  ]  rest_api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;  stage_name = &quot;test&quot;}resource &quot;aws_api_gateway_usage_plan&quot; &quot;notes-usage-plan&quot; {  name         = &quot;NotesUsagePlan&quot;  description  = &quot;Notes usage plan&quot;  api_stages {    api_id = &quot;${aws_api_gateway_rest_api.NotesAPI.id}&quot;    stage  = &quot;${aws_api_gateway_deployment.notes-deployment.stage_name}&quot;  }}resource &quot;aws_api_gateway_api_key&quot; &quot;notes-api-key&quot; {  name = &quot;NotesApiKey&quot;  value = &quot;NtMLWD6CG49mgtbpcWTmd5jCtkSyUvow9LMV5KMf&quot;}resource &quot;aws_api_gateway_usage_plan_key&quot; &quot;notes-usage-plan-key&quot; {  key_id        = &quot;${aws_api_gateway_api_key.notes-api-key.id}&quot;  key_type      = &quot;API_KEY&quot;  usage_plan_id = &quot;${aws_api_gateway_usage_plan.notes-usage-plan.id}&quot;}Tym samym dotarliÅ›my do koÅ„ca przykÅ‚adu. Uruchomienie skryptu spowoduje wygenerowanie caÅ‚ego Å›rodowiska w przeciÄ…gu sekund. Warto rÃ³wnieÅ¼ przypomnieÄ‡, Å¼e jednym poleceniem moÅ¼emy posprzÄ…taÄ‡ po sobie, usuwajÄ…c wszystkie zasoby z chmury.UwaÅ¼ny czytelnik mÃ³gÅ‚by w tym momencie zapytaÄ‡ - â€œa co w przypadku, gdy mamy wiele Å›rodowisk?â€. I bÄ™dzie to sÅ‚uszne pytanie - powyÅ¼szy przykÅ‚ad nie zadziaÅ‚a poprawnie w takiej sytuacji. Podobnie jak w przypadku wielu developerÃ³w wspÃ³Å‚dzielÄ…cych jedno konto AWS. Albo, co jest najczÄ™stszym przypadkiem, kombinacjÄ… obu powyÅ¼szych. W tej sytuacji, z pomocÄ… przychodzi nam mechanizm zmiennych Å›rodowiskowych, wspierany przez Terraforma. Wystarczy takÄ… zmiennÄ… zdefiniowaÄ‡, a nastÄ™pnie uÅ¼yÄ‡ w nazwach wszystkich nazwanych zasobÃ³w. Trzeba takÅ¼e przekazaÄ‡ jÄ… do wnÄ™trza funkcji Lambda tak, aby funkcja wiedziaÅ‚a, z ktÃ³rÄ… tabelÄ… DynamoDB ma rozmawiaÄ‡. Å»eby nie powielaÄ‡ i tak dÅ‚ugiego skryptu, pozwolÄ™ sobie zastosowaÄ‡ tryb zmian, Å¼eby zobrazowaÄ‡ sposÃ³b wprowadzania takiej zmiennej:--- a/instance.tf+++ b/instance.tf+variable &quot;env&quot; {+  default = &quot;&quot;+}+-  name = &quot;notes&quot;+  name = &quot;${var.env}-notes&quot;-  name = &quot;iam_for_lambda&quot;+  name = &quot;${var.env}-iam_for_lambda&quot;-  name = &quot;role_policy_for_dynamodb_access&quot;+  name = &quot;${var.env}-role_policy_for_dynamodb_access&quot;-  function_name = &quot;note-add-lambda&quot;+  function_name = &quot;${var.env}-note-add-lambda&quot;+  environment {+    variables = {+      environment_name = &quot;${var.env}&quot;+    }+  }-  function_name = &quot;note-find-lambda&quot;+  function_name = &quot;${var.env}-note-find-lambda&quot;+  environment {+    variables = {+      environment_name = &quot;${var.env}&quot;+    }+  }-  name = &quot;NotesAPI&quot;+  name = &quot;${var.env}-NotesAPI&quot;-  stage_name = &quot;test&quot;+  stage_name = &quot;${var.env}&quot;-  name         = &quot;NotesUsagePlan&quot;+  name         = &quot;${var.env}-NotesUsagePlan&quot;-  name = &quot;NotesApiKey&quot;-  value = &quot;NtMLWD6CG49mgtbpcWTmd5jCtkSyUvow9LMV5KMf&quot;+  name = &quot;${var.env}-NotesApiKey&quot;+  value = &quot;${var.env}-NtMLWD6CG49mgtbpcWTmd5jCtkSyUvow9LMV5KMf&quot;--- a/note-add-lambda.js+++ b/note-add-lambda.js+const env = process.env.environment_name;-        TableName: &#39;notes&#39;,+        TableName: env + &#39;-notes&#39;,--- a/note-find-lambda.js+++ b/note-find-lambda.js+const env = process.env.environment_name;-        TableName: &#39;notes&#39;,+        TableName: env + &#39;-notes&#39;,PodsumowanieAutomatyzacja procesÃ³w tworzenia Å›rodowiska wykonywalnego dla naszych komponentÃ³w w chmurze, nie tylko pozwala zaszczÄ™dziÄ‡ czas, ale stanowi Å¼ywÄ… dokumentacjÄ™ oraz przepis na to, jak takie Å›rodowisko powieliÄ‡ w razie potrzeb. Mam nadziejÄ™, Å¼e wpis ten, wraz z artykuÅ‚em Jakuba, stanowiÄ… wystarczajÄ…ce wprowadzenie do pracy w Å›rodowisku Amazon AWS.Bibliografia  https://www.terraform.io/docs/index.html",
"url": "/2018/03/26/terraform-czyli-o-tym-jak-okielznac-chmure-od-amazona.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2018-03-26-terraform-czyli-o-tym-jak-okielznac-chmure-od-amazona/terraform.png",
"date": "26-03-2018",
"path": "pl/2018-03-26-terraform-czyli-o-tym-jak-okielznac-chmure-od-amazona"
}
,


"2018-02-22-monitorowanie-zespolowych-trendow-jakosci-kodu-html": {
"title": "Monitorowanie zespoÅ‚owych trendÃ³w jakoÅ›ci kodu",
"lang": "pl",
"tags": "sonarqube sonarqube companion jakoÅ›Ä‡ kodu",
"content": "W jednym z wczeÅ›niejszych wpisÃ³w omawialiÅ›my juÅ¼ zalety i zasadnoÅ›Ä‡ statycznej analizy kodu z pomocÄ… SonarQube (tutaj).Przyjmijmy wiÄ™c, Å¼e jesteÅ›my juÅ¼ przekonani do caÅ‚ego przedsiÄ™wziÄ™cia, inwestujemy w infrastrukturÄ™ i zaczynamy mierzyÄ‡. Pierwsze sukcesy zapewne juÅ¼ sÄ… na naszym koncie, jakoÅ›Ä‡ projektÃ³w wzrosÅ‚a, naruszeÅ„ o krytycznych priorytetach mamy coraz mniej, a caÅ‚y zespÃ³Å‚ jest zadowolony z dbania o wÅ‚asne podwÃ³rko. Powstaje jednak pytanie, jak monitorowaÄ‡ trend zmian? Jak oceniÄ‡ czy prowadzone przez nas prace przynoszÄ… faktyczne efekty? Dodatkowo powstaje problem, jak monitorowaÄ‡ statystyki naruszeÅ„ na poziomie zespoÅ‚u utrzymujÄ…cego wiele projektÃ³w?SonarQube CompanionW odpowiedzi na zadane pytania, stworzyliÅ›my aplikacjÄ™ dashboardu dla SonarQube i udostÄ™pniliÅ›my jÄ… wszystkim na GitHub!Projekt na pierwszym miejscu stawia zespoÅ‚y i ich potrzeby. Monitorowane projekty sÄ… agregowane w zespoÅ‚y, zgodnie ze strukturÄ… firmy. Dodatkowo naruszenia moÅ¼emy Å›ledziÄ‡ na wykresach z konfigurowalnymi zakresami sprintÃ³w, czy nawet naniesionymi waÅ¼nymi datami z Å¼ycia zespoÅ‚u.W zaleÅ¼noÅ›ci od oczekiwaÅ„, moÅ¼esz Å›ledziÄ‡ stan bazy kodu na rÃ³Å¼nych poziomach. PrzykÅ‚adowo, drzewo projektÃ³w pokazuje szybki rzut na stan wszystkich projektÃ³w oraz sumaryczny stan firmy / zespoÅ‚u. Alternatywnie, przeglÄ…dajÄ…c ekran konkretnego zespoÅ‚u, czy nawet projektu, widzisz obszary na ktÃ³re warto zwrÃ³ciÄ‡ uwagÄ™ przy codziennej pracy.Drzewo zespoÅ‚Ã³wDrzewo zespoÅ‚Ã³w przedstawia hierarchicznÄ… reprezentacjÄ™ organizacji na projekty oraz pracujÄ…ce nad nimi zespoÅ‚y.PoszczegÃ³lne kafle projektÃ³w/zespoÅ‚Ã³w przedstawiajÄ… ich bieÅ¼Ä…cÄ… kondycjÄ™ oraz krÃ³tkie podsumowanie statystyk. Celem nadrzÄ™dnym jest dÄ…Å¼yÄ‡ do bezwzglÄ™dnej zielenie na caÅ‚ym ekranie ;-)PoszczegÃ³lne kolory sÄ… ustalane zgodnie z zasadÄ…:  kolor czerwony (unhealthy) - wystÄ™pujÄ… naruszenia o priorytecie bloker, bezpoÅ›rednio w grupie lub jednej z podgrup, wymagana natychmiastowa akcja,  kolor pomaraÅ„czowy (warning) - wystÄ™pujÄ… naruszenia o priorytecie krytyczny, bezpoÅ›rednio w grupie lub jednej z podgrup, naleÅ¼y planowaÄ‡ rozwiÄ…zanie problemÃ³w,  kolor zielony (healthy) - brak naruszeÅ„ o priorytecie bloker oraz krytyczny, mogÄ… znajdowaÄ‡ siÄ™ naruszenia o niÅ¼szych priorytetach, wystarczajÄ…ce sÄ… codzienne akcje porzÄ…dkowe.Zasady kolorystyczne bÄ™dÄ… siÄ™ powtarzaÅ‚y przy takich samych ograniczeniach na innych ekranach. Same akcje/interakcje to juÅ¼ wypracowana przez nas indywidualnie polityka i w rÃ³Å¼nych zespoÅ‚ach moÅ¼e zostaÄ‡ zrealizowana inaczej.Dodatkowo, dla kaÅ¼dego kafla widzimy szybkÄ… statystykÄ™ liczby projektÃ³w, ogÃ³lnej oceny zdrowia i podsumowanie liczby naruszeÅ„.PrzeglÄ…d zespoÅ‚uStrona zespoÅ‚u pozwala na bieÅ¼Ä…co Å›ledziÄ‡ stan projektÃ³w nad ktÃ³rymi pracuje zespÃ³Å‚, bez dodatkowych rozproszeÅ„ zwiÄ…zanych z dziaÅ‚alnoÅ›ciÄ… innych zespoÅ‚Ã³w.W ramach ekranu zespoÅ‚u moÅ¼emy Å›ledziÄ‡:  szybki przeglÄ…d stanu projektu, liczbÄ™ projektÃ³w, podgrup, itp,  wykres zmian liczby naruszeÅ„ w wybranym przedziale czasu:          uwzglÄ™dniajÄ…cy filtrowanie po rÃ³Å¼nych typach naruszeÅ„,      zaznaczanie na osi wykresu dat i nanoszenie sprintÃ³w zespoÅ‚u,        przeglÄ…d grup, z ktÃ³rych skÅ‚ada siÄ™ bieÅ¼Ä…ca grupa (w przypadku gÅ‚Ä™bszych hierarchii z dodatkowymi grupami agregujÄ…cymi),  listÄ™ projektÃ³w skÅ‚adajÄ…cych siÄ™ na grupÄ™:          w grupie znajdujÄ… siÄ™ projekty zdefiniowane w niej oraz w grupach pod niÄ… w drzewie,      listÄ™ projektÃ³w moÅ¼na filtrowaÄ‡ na podstawie ich statusu, tj. zmiany liczby naruszeÅ„, poprawienia, pogorszenia jakoÅ›ci projektÃ³w      dla kaÅ¼dego projektu, kolorem zaprezentowana jest jego bieÅ¼Ä…ca kondycja,      dla kaÅ¼dego projektu prezentowana jest bieÅ¼Ä…ca liczba naruszeÅ„ oraz zmian tej wartoÅ›ci w oknie czasowym wybranym na wykresie.      PrzeglÄ…d projektuMoÅ¼liwe jest rÃ³wnieÅ¼ przeglÄ…danie stanu konkretnego projektu, niezaleÅ¼nie od jego przynaleÅ¼noÅ›ci do grup czy zespoÅ‚Ã³w.Widok pojedynczego projektu jest uproszczonym widokiem zespoÅ‚u prezentujÄ…cym jedynie podzbiÃ³r danych zasadnych dla tego projektu.Realny wpÅ‚yw na pracÄ™ zespoÅ‚Ã³wWprowadzenie dodatkowych narzÄ™dzi historycznego Å›ledzenia jakoÅ›ci projektÃ³w pozwoliÅ‚o utrzymaÄ‡ motywacjÄ™ zespoÅ‚Ã³w do zmniejszania liczby naruszeÅ„.MiÅ‚y dla oka interfejs i moÅ¼liwoÅ›Ä‡ szybkiego porÃ³wnania wprowadziÅ‚y maÅ‚y aspekt rywalizacji oraz pogoni za zielonym wÅ›rÃ³d programistÃ³w.Wszystko to pozytywnie przeÅ‚oÅ¼yÅ‚o siÄ™ zarÃ³wno na poprawÄ™ istniejÄ…cych, jak i zwiÄ™kszenie Å›wiadomoÅ›ci i zmniejszenie liczby nowych naruszeÅ„.Wprowadzone narzÄ™dzie pozwoliÅ‚o nam dÅ‚ugofalowo monitoroawÄ‡ zespoÅ‚y pracujÄ…ce nad wieloma maÅ‚ymi projektami (co jest nieuniknione przy architekturach typu microservices), jak i utrzymaÄ‡ zaangaÅ¼owanie oraz zainteresowanie programistÃ³w ponad poczÄ…tkowÄ… euforiÄ™, rÃ³wnieÅ¼ w kolejnych, bardziej mozolnych miesiÄ…cach.Uruchomienie aplikacjiKompletne kody projektu dostÄ™pne sÄ… dla kaÅ¼dego na GitHub. Dodatkowo, zbudowane wersje kodÃ³w wrzucamy w postaci gotowego do uÅ¼ycia obrazu na Docker Hub.Nic nie stoi na przeszkodzie, Å¼ebyÅ› teÅ¼ skorzystaÅ‚ z naszych doÅ›wiadczeÅ„. SzczegÃ³Å‚owe informacje, jak uruchomiÄ‡ projekt, zarÃ³wno produkcyjnie, jak i lokalnie, znajdujÄ… siÄ™ w README projektu na GitHub.ZachÄ™camy do skorzystania, zgÅ‚aszania uwag i wsparcia przy dalszych pracach rozwojowo/utrzymaniowych.Przydatne linki:  Projekt GitHub  Obraz w Docker Hub",
"url": "/2018/02/22/monitorowanie-zespolowych-trendow-jakosci-kodu.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2018-02-22-monitorowanie-zespolowych-trendow-jakosci-kodu/monitorowanie-kodu.jpg",
"date": "22-02-2018",
"path": "pl/2018-02-22-monitorowanie-zespolowych-trendow-jakosci-kodu"
}
,


"2018-01-17-aws-serverless-programming-html": {
"title": "AWS - serverless programming",
"lang": "pl",
"tags": "aws serverless",
"content": "Trudno dziÅ› wyobraziÄ‡ sobie branÅ¼Ä™ IT bez chmury obliczeniowej. Przeniesienie naszych serwerÃ³w do clouda i zastosowanie Infrastructure as Code (IaC) pozwala czÄ™sto na zoptymalizowanie kosztÃ³w, a takÅ¼e na zapewnienie lepszej dostÄ™pnoÅ›ci i skalowalnoÅ›ci rozwiÄ…zania. Architektura serverless przenosi nas jeszcze poziom wyÅ¼ej - przestajemy myÅ›leÄ‡ o maszynach wirtualnych, skupiamy siÄ™ na kodzie rozwiÄ…zujÄ…cym konkretne potrzeby biznesowe. Wymusza ona rÃ³wnieÅ¼ pewnÄ… zmianÄ™ mentalnÄ… w Å›rodowisku inÅ¼ynierÃ³w IT - praca z arkuszem kalkulacyjnym i liczenie kosztÃ³w przygotowywanego rozwiÄ…zania staje siÄ™ nieodÅ‚Ä…cznÄ… czÄ™Å›ciÄ… procesu produkcji. Wraz z wprowadzeniem przez Amazon usÅ‚ugi AWS Lambda w 2014 roku programowanie w architekturze serverless staÅ‚o siÄ™ jeszcze prostsze. W artykule przedstawiÄ™ przykÅ‚ad serwisu do przechowywania notatek, przygotowany w oparciu o architekturÄ™ serverless, dostarczanÄ… przez AWS. PokaÅ¼Ä™ rÃ³wnieÅ¼ koszty takiego rozwiÄ…zania.Wymagania biznesowe:  UÅ¼ytkownik moÅ¼e zapisywaÄ‡ notatki tekstowe.  UÅ¼ytkownik moÅ¼e pobraÄ‡ zapisane wczeÅ›niej notatki tekstowe.Åšrodowisko deweloperskie:  Potrzebne bÄ™dzie aktywne konto w Amazon AWS. ZaÅ‚oÅ¼enie takiego konta jest doÅ›Ä‡ proste i dla wiÄ™kszoÅ›ci usÅ‚ug darmowe przez pierwszy rok uÅ¼ytkowania. Konto moÅ¼emy zaÅ‚oÅ¼yÄ‡ tutaj: https://aws.amazon.com/free. Podczas tworzenia konta konieczne jest podanie danych karty kredytowej, ale przy okazji tworzenia opisanego tu serwisu bÄ™dziemy uÅ¼ywali jedynie usÅ‚ug wchodzÄ…cych w skÅ‚ad rocznego free tier. W kaÅ¼dym momencie istnieje rÃ³wnieÅ¼ moÅ¼liwoÅ›Ä‡ sprawdzenia jakie sÄ… nasze naleÅ¼noÅ›ci dla Amazona. Niestety nie ma moÅ¼liwoÅ›ci ustalenia granicy kwotowej, ktÃ³rej nie chcemy przekroczyÄ‡, po ktÃ³rej nastÄ…pi wyÅ‚Ä…czenie naszej usÅ‚ugi. MoÅ¼na za to zdefiniowaÄ‡ alerty, ktÃ³re powiadomiÄ… nas w przypadku przekroczenia ustalonej naleÅ¼noÅ›ci. KonfigurujÄ…c konto w AWS warto wÅ‚Ä…czyÄ‡ Multi-Factor Authentication (MFA), ustrzeÅ¼e nas to przed najgorszym moÅ¼liwym scenariuszem, czyli przejÄ™ciem konta przez nieuprawnionÄ… osobÄ™. To moÅ¼e pociÄ…gnÄ…Ä‡ za sobÄ… spore koszty obciÄ…Å¼ajÄ…ce nasz rachunek.Implementacja odczytu notatekWarstwa persystencjiAby zaimplementowaÄ‡ odczyt notatek bÄ™dziemy potrzebowali jakÄ…Å› warstwÄ™ persystencji, gdzie przechowywane bÄ™dÄ… dane naszych notatek, komponent ktÃ³ry wystawi nam restowe API i coÅ› w czym zaimplementujemy â€œlogikÄ™ biznesowÄ…â€ reagujÄ…cÄ… na wywoÅ‚anie API pobraniem danych z warstwy persystencji.AWS udostÄ™pnia warstwÄ™ persystencji na rÃ³Å¼ne sposoby. Mamy do dyspozycji storage plikowy S3, bazy relacyjne RDS a takÅ¼e bazÄ™ NoSql DynamoDB. JeÅ¼eli chcemy byÄ‡ w 100% serverless, nie uÅ¼ywamy RDS, gdyÅ¼ wymaga ona utrzymywania ciÄ…gle dziaÅ‚ajÄ…cej instancji (nadal nie musimy siÄ™ w tym przypadku przejmowaÄ‡ vmâ€™kami - baza jest uruchamiana jako niezaleÅ¼ny serwis, ale pÅ‚acimy za caÅ‚y czas, w ktÃ³rym dostÄ™pna jest baza). Do naszego zastosowania dobrze nadaje siÄ™ baza DynamoDB. Aby utworzyÄ‡ instancjÄ™ bazy, logujemy siÄ™ do konsoli AWS https://aws.amazon.com/console/ i przechodzimy do serwisu DynamoDB. Zanim utworzymy jakikolwiek zasÃ³b w konsoli AWS waÅ¼ne jest okreÅ›lenie regionu, w ktÃ³rym chcemy dziaÅ‚aÄ‡. Mapa przedstawia jakie regiony sÄ… dostÄ™pne (pomaraÅ„czowe okrÄ™gi) i ile â€œavailability zonesâ€ znajduje siÄ™ w kaÅ¼dym regionie. Zielone okrÄ™gi oznaczajÄ… dodatkowe regiony, ktÃ³re bÄ™dÄ… dostÄ™pne w przyszÅ‚oÅ›ci.Najlepiej wybraÄ‡ region, znajdujÄ…cy siÄ™ najbliÅ¼ej lokalizacji, dla ktÃ³rej oferujemy nasze rozwiÄ…zanie (mniejsze opÃ³Åºnienia w komunikacji). Wszystkie komponenty skÅ‚adajÄ…ce siÄ™ na nasze rozwiÄ…zanie powinny w miarÄ™ moÅ¼liwoÅ›ci znajdowaÄ‡ siÄ™ w tym samym regionie. MoÅ¼liwa jest oczywiÅ›cie komunikacja, miÄ™dzy rÃ³Å¼nymi regionami, ale pociÄ…ga to za sobÄ… dodatkowe koszty. Region wybieramy klikajÄ…c nazwÄ™ miasta w prawym gÃ³rnym rogu konsoli:Po wybraniu regionu klikamy przycisk â€œCreate tableâ€ i przechodzimy do widoku tworzenia tabeli. Tutaj musimy okreÅ›liÄ‡ nazwÄ™ tabeli, np.: â€œnotesâ€ oraz klucz. Klucz tabeli DynamoDB moÅ¼e skÅ‚adaÄ‡ siÄ™ z jednej lub dwÃ³ch kolumn. Pojedynczy klucz zawiera tylko tzw. partition key - kolumna, ktÃ³rÄ… wybierzemy bÄ™dzie uÅ¼ywana do rozkÅ‚adu danych w rÃ³Å¼nych partycjach bazy danych. WybierajÄ…c partition key pamiÄ™tajmy, Å¼e poÅ¼Ä…dane jest, aby podczas dziaÅ‚ania systemu odwoÅ‚ywaÄ‡ siÄ™ do rÃ³Å¼nych partycji - to zapewnia lepsze skalowanie. W przypadku aplikacji do przechowywania notatek dobrym wyborem wydaje siÄ™ nazwa uÅ¼ytkownika. Nie moÅ¼emy jednak poprzestaÄ‡ na jednoczÄ™Å›ciowym kluczu, gdyÅ¼ moglibyÅ›my zapisaÄ‡ tylko jednÄ… notatkÄ™ dla uÅ¼ytkownika - podobnie jak w RDS wartoÅ›ci klucza muszÄ… byÄ‡ unikalne. Dodamy wiÄ™c drugÄ… czÄ™Å›Ä‡ klucza tzw. sort key. W naszym przypadku bÄ™dzie to timestamp dodania notatki:WybÃ³r klucza tabeli jest bardzo istotnym krokiem - decyzja jest wiÄ…Å¼Ä…ca i pÃ³Åºniej nie moÅ¼na zmieniÄ‡ juÅ¼ klucza. Co waÅ¼ne, wyszukiwanie w tabeli DynamoDB moÅ¼liwe jest jedynie po kluczu lub indeksie. W innym przypadku wyszukiwanie realizowane jest jako scan tabeli. Warto tu napisaÄ‡, Å¼e indeksy wyglÄ…dajÄ… inaczej niÅ¼ indeksy w relacyjnej bazie danych. Indeks w DynamoDB jest de facto kopiÄ… tabeli (okreÅ›lamy nawet jakie kolumny znajdÄ… siÄ™ w kopii i jedynie one bÄ™dÄ… dostÄ™pne dla wyszukanego rekordu). Kopia ta jest synchronizowana w sposÃ³b asynchroniczny! z oryginalnÄ… tabelÄ…. Przy okazji: DynamoDB zapewnia transakcyjnoÅ›Ä‡ jedynie na poziomie pojedynczego wiersza tabeli - moÅ¼liwe sÄ… tzw. conditional updates, czyli modyfikacja wiersza jeÅ¼eli speÅ‚nia on okreÅ›lone kryteria. Klasyczna transakcyjnoÅ›Ä‡ typu przelew z konta A na konto B nie jest wspierana!W tej chwili dodamy kilka rekordÃ³w do naszej tabeli, aby moÅ¼liwe byÅ‚o przetestowanie funkcjonalnoÅ›ci odczytu notatek. Przechodzimy na zakÅ‚adkÄ™ items i klikamy przycisk â€œCreate itemâ€. Wpisujemy nazwÄ™ uÅ¼ytkownika oraz timestamp. Dodajemy rÃ³wnieÅ¼ nowÄ… kolumnÄ™ o nazwie â€œcontentâ€ i typie â€œStringâ€:Wpisujemy przykÅ‚adowÄ… treÅ›Ä‡ notatki. Dodajmy jeszcze kilka przykÅ‚adowych notatek:Logika biznesowaWarstwÄ™ persystencji mamy gotowÄ…, zajmiemy siÄ™ teraz czÄ™Å›ciÄ… biznesowÄ…. Zaimplementujemy jÄ… w postaci lambd udostÄ™pnianych przez AWS. Wybieramy w lewym gÃ³rnym rogu konsoli Services i przechodzimy do serwisu Lambda. Tutaj klikamy przycisk â€œCreate a functionâ€ i przechodzimy do okreÅ›lania parametrÃ³w naszej lambdy. OkreÅ›lamy nazwÄ™ funkcji np.:â€getNotesâ€ oraz wybieramy jÄ™zyk, w ktÃ³rym tworzona jest nasza funkcja. Do wyboru mamy C#, JavÄ™ 8, Node.js 4.3, Node.js 6.10, Python 2.7, Python 6.10. Wybieramy Node.js 6.10.Za wyborem jÄ™zyka idÄ… nie tylko okreÅ›lone cechy danego jÄ™zyka, ale takÅ¼e sposÃ³b jego dziaÅ‚ania w AWS. PrzykÅ‚adowo implementacja w Javie bÄ™dzie zdecydowanie najszybciej dziaÅ‚ajÄ…cym kodem na AWS, z drugiej jednak strony powoÅ‚anie nowej instancji lambdy napisanej w Javie bÄ™dzie trwaÅ‚o doÅ›Ä‡ dÅ‚ugo, bo aÅ¼ kilka sekund. Przy zaÅ‚oÅ¼eniu, Å¼e nasz system bÄ™dzie doÅ›wiadczaÅ‚ peekâ€™Ã³w wywoÅ‚aÅ„ moÅ¼e to oznaczaÄ‡, Å¼e w jednym momencie AWS bÄ™dzie prÃ³bowaÅ‚ zainstancjonowaÄ‡ tysiÄ…c (w zaleÅ¼noÅ›ci od liczby jednoczesnych wywoÅ‚aÅ„) lambd w tym samym czasie, a dalej przeÅ‚oÅ¼y siÄ™ to na kilkusekundowe opÃ³Åºnienie w realizacji tych requestÃ³w. BÄ™dziemy musieli rÃ³wnieÅ¼ ponieÅ›Ä‡ koszt za czas jaki zostaÅ‚ poÅ›wiÄ™cony na wystartowanie kaÅ¼dej instancji lambdy. Analogiczny przypadek dla lambd zaimplementowanych w ktÃ³rymÅ› z jÄ™zykÃ³w skryptowych moÅ¼e mymagaÄ‡ znaczÄ…co mniejszej liczby instancji, gdyÅ¼ lambdy bÄ™dÄ… wczeÅ›niej dostÄ™pne do obsÅ‚ugi requestÃ³w (kilkaset milisekund w porÃ³wnaniu do kilku sekund). Ciekawe porÃ³wnianie szybkoÅ›ci dziaÅ‚ania dla poszczegÃ³lnych jÄ™zykÃ³w moÅ¼na znaleÅºÄ‡ na stronie: https://read.acloud.guru/comparing-aws-lambda-performance-when-using-node-js-java-c-or-python-281bef2c740f.W polu Role wybieramy â€œCreate a custom roleâ€ i przechodzimy do tworzenia nowej roli dla tworzonej przez nas lambdy. Rola ta bÄ™dzie przydatna do definiowania uprawnieÅ„, ktÃ³re umoÅ¼liwiÄ… lambdzie dostÄ™p do rÃ³Å¼nych serwisÃ³w AWS. Pozostawiamy domyÅ›lnie wypeÅ‚nione wartoÅ›ci i klikamy przycisk Allow. NastÄ™pnie na ekranie tworzenia lambdy wybieramy w polu Existing role* utworzonÄ… przez nas rolÄ™, powinna to byÄ‡ rola o nazwie â€œlambda_basic_executionâ€:Klikamy przycisk â€œCreate functionâ€. Funkcja zostaje utworzona, a my widzimy ekran konfiguracji utworzonej przez nas funkcji. W polu â€œFunction codeâ€ znajduje siÄ™ inlineâ€™owy edytor, w ktÃ³rym moÅ¼emy edytowaÄ‡ kod naszej lambdy.OczywiÅ›cie tworzenie kodu w konsoli pozwala jedynie na tworzenie prostych funkcji. Bardziej skomplikowane lambdy tworzymy w zewnÄ™trznych narzÄ™dziach i uploadâ€™ujemy w postaci archiwÃ³w zip. W polu â€œCode entry typeâ€ wybieramy â€œUpload a .ZIP fileâ€.Implementacja lambdy w Node.js 6.10 polega na implementacji trÃ³j-argumentowej funkcji. Pierwszy argument zawiera dane eventâ€™a, ktÃ³ry uruchomiÅ‚ lambdÄ™, drugi to informacje kontekstowe dot. Å›rodowiska uruchomieniowego, trzeci to metoda callbackowa pozwalajÄ…ca na zwrÃ³cenie wyniku lub zaraportowanie bÅ‚Ä™du. PoniÅ¼ej znajduje siÄ™ kod lambdy umoÅ¼liwiajÄ…cy pobieranie notatek z DynamoDB dla uÅ¼ytkownika przekazanego w argumencie event:// doÅ‚Ä…czamy sdk AWSconst AWS = require(&#39;aws-sdk&#39;);exports.handler = (event, context, callback) =&amp;gt; {    console.log(&quot;event=&quot;, event);    // tworzymy instancjÄ™ DocumentClient, ktÃ³ra umoÅ¼liwia zapytanie bazy danych    let documentClient = new AWS.DynamoDB.DocumentClient();    // definicja parmetrÃ³w zapytania do bazy danych    // szukamy rekordÃ³w, dla ktÃ³rych userName jest rÃ³wne userName przekazanemu w event    let params = {        TableName: &#39;notes&#39;,        KeyConditionExpression: &#39;userName = :userName&#39;,        ExpressionAttributeValues: {            &#39;:userName&#39;: event.userName        }    }    // wykonanie zapytania do bazy    documentClient.query(params, (err, data) =&amp;gt; {        if (err) {            // w przypdaku bÅ‚Ä™du logujemy bÅ‚Ä…d i zwracamy bÅ‚Ä…d w funkcji callback            console.log(err);            callback(err);        } else {            // logujemy odpowiedÅº z bazy u zwracamy odpowiedÅº w funkcji callback            console.log(data);            callback(null, data);        }    });};Po dodaniu kodu okreÅ›limy jeszcze kilka parametrÃ³w konfiguracyjnych lambdy. W polu â€œBasic settingâ€ okreÅ›lamy timeout dla wywoÅ‚ania lambdy, warto zauwaÅ¼yÄ‡, Å¼e maksymalny timeout to 5 minut, co oznacza, Å¼e Å¼adna lambda nie moÅ¼e wykonywaÄ‡ siÄ™ dÅ‚uÅ¼ej niÅ¼ 5 minut. Dodatkowo moÅ¼emy okreÅ›liÄ‡ rozmiar pamiÄ™ci i co ciekawe przekÅ‚ada siÄ™ to rÃ³wnieÅ¼ na moc procesora, ktÃ³rÄ… dostanie nasza lambda (rozmiar pamiÄ™ci przekÅ‚ada siÄ™ oczywiÅ›cie na koszt usÅ‚ugi). W polu concurrency moÅ¼emy okreÅ›liÄ‡ maksymalnÄ… liczbÄ™ instancji naszej lambdy.Ten wprowadzony niedawno parametr ma bardzo waÅ¼ne znaczenie dla lambd napisanych w jÄ™zyku Java. Pozwala bowiem obejÅ›Ä‡ problem uruchomienia bardzo duÅ¼ej liczby instancji lambdy w przypadku peekâ€™u - spowolni obsÅ‚ugÄ™ wszystkich requestÃ³w (co i tak by nastÄ…piÅ‚o ze wzglÄ™du na dÅ‚ugi czas tworzenia nowej instancji lambdy w Javie), ale jednoczeÅ›nie pozwoli na zmniejszenie kosztÃ³w usÅ‚ugi - nastÄ™pne wywoÅ‚ania bÄ™dÄ… juÅ¼ dziaÅ‚aÅ‚y na zainstancjonowanych lambdach i bÄ™dÄ… szybkie.Zapisujemy lambdÄ™ przyciskiem â€œSaveâ€. Teraz moÅ¼emy przetestowaÄ‡ napisany przez nas kod. Klikamy przycisk â€œTestâ€ i definiujemy jsonâ€™a, ktÃ³ry zostanie przekazany w evencie podczas uruchamiania naszej lambdy.{    &quot;userName&quot;: &quot;user1&quot;}Po uruchomieniu testu powinniÅ›my otrzymaÄ‡ bÅ‚Ä…d oznaczajÄ…cy brak autoryzacji zdefiniowanej przez nas lambdy do odczytu danych z bazy DynamoDB:Aby nadaÄ‡ odpowiednie uprawnienia musimy przejÅ›Ä‡ do usÅ‚ugi IAM (Services-&amp;gt;IAM). WybraÄ‡ z menu po lewej stronie â€œRolesâ€, a nastÄ™pnie wybraÄ‡ rolÄ™, ktÃ³rÄ… zdefiniowaliÅ›my podczas tworzenia lambdy (lambda_basic_execution). Klikamy przycisk â€œAttach policyâ€:W polu wyszukiwania â€œpolicy typeâ€ wpisujemy DynamoDB i po wyszukaniu doÅ‚Ä…czamy policy â€œAmazonDynamoDBFullAccessâ€:Po ponownym wywoÅ‚aniu testu lambdy powinniÅ›my otrzymaÄ‡ w wyniku dane pobrane z bazy DanamoDB:Rest APIPozostaje nam udostÄ™pnienie naszego serwisu do notatek w formie API restowego. Komponent AWS, ktÃ³ry umoÅ¼liwi nam zrobienie tego to API Gateway. W konsoli AWS przechodzimy do Serices-&amp;gt;API Gateway i po zaÅ‚adowaniu strony klikamy przycisk â€œGet startedâ€. W polu wyboru wybieramy New API i wpisujemy nazwÄ™ np.: â€œnotesâ€:Klikamy przycik â€œCreate APIâ€. W polu â€œActionsâ€ wybieramy â€œCreate Resourceâ€:W polu â€œResource Nameâ€ wpisujemy â€œuserNameâ€, a w â€œResource Pathâ€ â€œ{username}â€:Klikamy przycisk â€œCreate Resourceâ€. BÄ™dÄ…c na nowoutworzonym resource z menu â€œActionsâ€ wybieramy â€œCreate Methodâ€:Z listy rozwijanej wybieramy metodÄ™ GET i zatwierdzamy:W polu wyboru â€œIntegration typeâ€ wybieramy â€œLambda functionâ€. PoniÅ¼ej w polu â€œLambda regionâ€ wybieramy region, w ktÃ³rym utworzyliÅ›my lambdÄ™ getNotes. W polu â€œLambda Functionâ€ podajemy nazwÄ™ funkcji np.: â€œgetNotesâ€ (po wpisaniu pierwszej litery nazwa powinna siÄ™ podpowiedzieÄ‡):Klikamy przycisk â€œSaveâ€ i zatwierdzamy nadanie uprawnienia wykonywania lambdy (popup). PoniewaÅ¼ chcemy, aby nazwa uÅ¼ytkownika, dla ktÃ³rego chcemy pobraÄ‡ notatki przekazywana byÅ‚a w Å›cieÅ¼ce potrzebujemy jeszcze dodatkowej konfiguracji. Kliknij na link â€œIntegration Requestâ€. RozwiÅ„ â€œURL Path Parametersâ€ i kliknij â€œAdd pathâ€. W polu name wpisz â€œusernameâ€, w â€œmapped fromâ€ â€œmethod.request.path.usernameâ€ i zatwierdÅº:RozwiÅ„ â€œBody Mapping Templatesâ€ i kliknij â€œAdd mapping templateâ€. W polu â€œContent-Typeâ€ wpisz â€œapplication/jsonâ€ i zatwierdÅº. W polu edycji dodaj mapowanie:{   &quot;userName&quot;: &quot;$input.params(&#39;username&#39;)&quot;}Zapisz mapowanie przyciskiem â€œSaveâ€.Kliknij w drzewie â€œResourcesâ€ metodÄ™ â€œGETâ€. Po prawej stronie powinien pojawiÄ‡ siÄ™ przepÅ‚yw danych Å‚Ä…czÄ…cy API Gateway i lambdÄ™. Kliknij przycisk â€œTestâ€ aby przetestowaÄ‡ konfiguracjÄ™ API Gateway. Jako parametr â€œ{username}â€ podaj â€œuser1â€ i kliknij przycisk â€œTestâ€:API Gateway powinno zwrÃ³ciÄ‡ notatki znajdujÄ…ce siÄ™ w bazie danych DynamoDB:Aby wystawiÄ‡ naszÄ… usÅ‚ugÄ™ na Å›wiat musimy jeszcze wdroÅ¼yÄ‡ konfiguracjÄ™ API Gateway. W tym celu z menu â€œActionsâ€ wybieramy â€œDeploy APIâ€. W polu â€œDeployment stageâ€ wybieramy â€œ[New Stage]â€, w polu â€œStage nameâ€ wpisujemy nazwÄ™ naszego Å›rodowiska np.: â€œtestâ€ i klikamy przycisk â€œDeployâ€:Od tej chwili nasz serwis dostÄ™pny jest w sieci. Aktualnie nie jest on niczym zabezpieczony, wiÄ™c kaÅ¼dy znajÄ…cy jego adres moÅ¼e go wywoÅ‚aÄ‡. Aby sprawdziÄ‡ dziaÅ‚anie z zewnÄ™trznej aplikacji, przechodzimy na zakÅ‚adkÄ™ â€œExportâ€ i pobieramy jsonâ€™a dla postmana:PobranÄ… kolekcjÄ™ importujemy do Postmana. W Å›cieÅ¼ce wywoÅ‚ania zamieniamy â€œ:usernameâ€ na faktycznÄ… nazwÄ™ uÅ¼ytkownika i wysyÅ‚amy Å¼Ä…danie. W odpowiedzi powinniÅ›my dostaÄ‡ dane z bazy DynamoDB:DostÄ™p do logÃ³w moÅ¼liwy jest za pomocÄ… serwisu CloudWatch. Aby dotrzeÄ‡ do logÃ³w konkretnej lambdy naleÅ¼y wejÅ›Ä‡ na jej konfiguracjÄ™, np.: Lambda-&amp;gt;Functions-&amp;gt;getNotes i przejÅ›Ä‡ na zakÅ‚adkÄ™ â€œMonitoringâ€. Dalej na jednym z paneli klikamy link â€œJump to Logsâ€. W to samo miejsce moÅ¼emy rÃ³wnieÅ¼ dotrzeÄ‡ z poziomu serwisÃ³w: Services-&amp;gt;CloudWatch-&amp;gt;Logs.Implementacja zapisu notatekWarstwÄ™ persystencji mamy juÅ¼ przygotowanÄ… i ona nie wymaga Å¼adnych modyfikacji. Aby umoÅ¼liwiÄ‡ zapis notatek, musimy zaimplementowaÄ‡ dodatkowÄ… lambdÄ™. Tworzymy jÄ… w taki sam sposÃ³b jak lambdÄ™ do odczytu podajÄ…c innÄ… nazwÄ™, np.: addNote i wybierajÄ…c utworzonÄ… wczeÅ›niej rolÄ™ â€œlambda_basic_executionâ€. Kod lambdy powinien wyglÄ…daÄ‡ mniej wiÄ™cej tak:const AWS = require(&#39;aws-sdk&#39;);exports.handler = (event, context, callback) =&amp;gt; {    console.log(&quot;event=&quot;, event);    // tworzymy instancjÄ™ DocumentClient, ktÃ³ra umoÅ¼liwia wstawienie do bazy danych    let documentClient = new AWS.DynamoDB.DocumentClient();    // definicja parmetrÃ³w wstawienia do bazy    // nazwÄ™ uÅ¼ytkownika i treÅ›Ä‡ notatki pobieramy z przekazanego event&#39;a    let params = {        TableName: &#39;notes&#39;,        Item: {            userName: event.userName,            timestamp: Date.now(),            content: event.content        }    }    // prÃ³ba wstawienia do bazy    documentClient.put(params, (err, data) =&amp;gt; {        if (err) {            console.log(err);            callback(err);        } else {            console.log(data);            callback(null, data);        }    });};Aby przetestowaÄ‡ lambdÄ™ definiujemy nowy event testowy w formie jsonâ€™a:{  &quot;userName&quot;: &quot;user1&quot;,  &quot;content&quot;: &quot;nowo dodana notatka&quot;}i klikamy przycisk test. Notatka powinna byÄ‡ zwrÃ³cona podczas pobierania notatek uÅ¼ytkownika â€œuser1â€.Pozostaje jeszcze konfiguracja API Gateway. W tym celu wchodzimy na Services-&amp;gt;API Gateway i odnajdujemy utworzone wczeÅ›niej API â€œnotesâ€. W drzewie â€œResourcesâ€ wybieramy â€œ/â€ i w menu â€œActionsâ€ wybieramy akcjÄ™ â€œCreate Methodâ€.Z listy metod wybierramy â€œPOSTâ€ i zatwierdzamy wybÃ³r. W polu â€œIntegration typeâ€ wybieramy â€œLambda Functionâ€. OkreÅ›lamy region naszej lambdy i podajemy jej nazwÄ™ w polu â€œLambda Functionâ€:Klikamy przycisk â€œSaveâ€ i zatwierdzamy dodanie uprawnienia do funkcji. I to tyle z konfiguracji API Gateway. Podobnie jak w przypadku odczytu rÃ³wnieÅ¼ na zapisie moÅ¼emy przetestowaÄ‡ konfiguracjÄ™ API Gateway. Klikamy przycisk â€œTestâ€ i w polu â€œRequest Bodyâ€ podajemy treÅ›Ä‡ eventa:W odpowiedzi powinniÅ›my otrzymaÄ‡ status http 200, a nowododana notatka powinna byÄ‡ widoczna w pobieranych notatkach uÅ¼ytkownika â€œuser1â€. Aby nowa metoda byÅ‚a dostÄ™pna z zewnÄ…trz, naleÅ¼y zdeployowaÄ‡ jeszcze raz nasze api wybierajÄ…c z menu â€œActionsâ€ â€œDeploy APIâ€ i podaÄ‡ utworzony wczeÅ›niej stage â€œtestâ€. Teraz ponownie moÅ¼emy wyeksportowaÄ‡ konfiguracjÄ™ do postmana i wykonaÄ‡ test:Diagram uÅ¼ytych przez nas komponentÃ³w AWS wyglÄ…da nastÄ™pujÄ…co:Ile to kosztujePraca w cloudzie AWS daje nam moÅ¼liwoÅ›Ä‡ dokÅ‚adnego policzenia kosztÃ³w naszego rozwiÄ…zania. Trzeba przy tym pamiÄ™taÄ‡ rÃ³wnieÅ¼ o tym, Å¼e AWS daje nam tzw. â€œFree tierâ€ czyli pewnÄ… pulÄ™ zasobÃ³w, ktÃ³ra jest dostÄ™pna bezkosztowo.Koszty DynamoDBI tak zaczynajÄ…c od warstwy persystencji na koszty DynamoDB skÅ‚adajÄ… siÄ™ koszty przestrzeni, ktÃ³re zajmujÄ… dane oraz koszty operacji odczytu i zapisu wykonywane w jednostce czasu. Przy kosztach zapisu i odczytu AWS posÅ‚uguje siÄ™ jednostkami:  RCU (read capacity unit) - jeden RCU umoÅ¼liwia wykonywanie dwÃ³ch odczytÃ³w na sekundÄ™,  WCU (write capacity unit) - jeden WCU umoÅ¼liwia wykonywanie jednego zapisu na sekundÄ™.JeÅ¼eli nasza aplikacja obsÅ‚uguje ruch, w ktÃ³rym maksymalnie wykonywane sÄ… 2 odczyty na sekundÄ™ przez caÅ‚y czas jej dziaÅ‚ania to AWS naliczy opÅ‚atÄ™ za 1 RCU.W przypadku DynamoDB Free Tier wynosi:  25 RCU,  25 WCU,  25 GB zaindeksowanych danych.Oznacza to, Å¼e aplikacja generujÄ…ca 25 zapisÃ³w na sekundÄ™ i 50 odczytÃ³w na sekundÄ™, ktÃ³rej dane mieszczÄ… siÄ™ w 25 GB nie generuje kosztÃ³w. Free tier dla DynamoDB jest staÅ‚y, nie ma ograniczenia czasowego. Po przekroczeniu wartoÅ›ci Free tier koszt wynosi odpowiednio:  1 RCU: $0.09 miesiÄ™cznie,  1 WCU: $0.47 miesiÄ™cznie,  1 GB: $0.25 miesiÄ™cznie.SzczegÃ³Å‚y naliczania kosztÃ³w dla DynamoDB moÅ¼na znaleÅºÄ‡ na stronie https://aws.amazon.com/dynamodb/pricing/.Koszty LambdyW przypadku lambd pÅ‚acimy za liczbÄ™ wykonanych Å¼Ä…daÅ„ oraz za tzw. gigabajto-sekundy (GB-seconds). W konfiguracji lambdy moÅ¼emy okreÅ›liÄ‡ ile maksymalnie pamiÄ™ci chcemy jej przydzieliÄ‡. Minimalnie to 128 MB, maksimum 3008 MB. LiczbÄ™ GB-s zuÅ¼ytych przez lambdÄ™ okreÅ›lamy jako:-liczba skonfigurowanej pamiÄ™ci w MB / 1024 * czas wykonania lambdy w sekundach (zaokrÄ…glony do 100 ms w gÃ³rÄ™).Czas wykonania lambdy, za ktÃ³ry AWS naliczy nam opÅ‚atÄ™ jest zawsze podawany w logu po wykonaniu danej lambdy, np.:REPORT RequestId: 31aaeaec-ef26-11e7-9892-57823db0c303    Duration: 316.42 ms    Billed Duration: 400 ms Memory Size: 128 MB    Max Memory Used: 34 MBW tym przypadku nasza lambda zuÅ¼yÅ‚a 128/1024 GB * 0.4 s = 0.125 GB * 0.4 s = 0.05 GB-s. Free tier dla lambd wynosi:  1 000 000 Å¼Ä…daÅ„ miesiÄ™cznie,  400 000 GB-s miesiÄ™cznie.Po przekroczeniu tych wartoÅ›ci pÅ‚acimy:  za kaÅ¼de 1 000 000 Å¼Ä…daÅ„ $0.20,  za 1 GB-s $0.00001667.SzczegÃ³Å‚y moÅ¼emy znaleÅºÄ‡ na stronie https://aws.amazon.com/lambda/pricing/.Koszty API-GatewayZdecydowanie najdroÅ¼szym komponentem, ktÃ³rego uÅ¼yliÅ›my w naszym przykÅ‚adzie jest API-Gateway. W tym przypadku pÅ‚acimy za liczbÄ™ Å¼Ä…daÅ„ oraz dane, ktÃ³re transferujemy przez api. Warstwa darmowa obejmuje 1 000 000 Å¼Ä…daÅ„ miesiÄ™cznie, ale jest dostÄ™pna przez pierwsze 12 miesiÄ™cy uÅ¼ywania API-Gateway. Po tym czasie koszty wyglÄ…dajÄ… nastÄ™pujÄ…co:  1 000 000 Å¼Ä…daÅ„: $3.70,  pierwsze 10 TB transferowanych danych $0.09 za 1 GB,  kolejne 40 TB transferowanych danych $0.085 za 1 GB,  kolejne 100 TB transferowanych danych $0.07 za 1 GB,  kolejne 350 TB transferowanych danych $0.05 za 1 GB.SzczegÃ³Å‚y dot. kosztÃ³w API-Gateway dostÄ™pne sÄ… na stronie https://aws.amazon.com/api-gateway/pricing/.Koszty przykÅ‚adowej aplikacjiProponujÄ™ teraz Ä‡wiczenie polegajÄ…ce na policzeniu kosztÃ³w przygotowanej przez nas aplikacji. ZaÅ‚Ã³Å¼my, Å¼e chcemy obsÅ‚ugiwaÄ‡ milion uÅ¼ytkownikÃ³w i kaÅ¼dy z nich bÄ™dzie zapisywaÅ‚ 10 notatek dziennie i odczytywaÅ‚ 30. ZakÅ‚adamy Å¼e jedna notatka ma wielkoÅ›Ä‡ 1 KB.Koszty DynamoDBMamy wiÄ™c 1 000 000 uÅ¼ytkownikÃ³w zapisujÄ…cych 10 notatek kaÅ¼dego dnia. Policzmy ile zapisÃ³w na sekundÄ™ potrzebujemy:  1 000 000 uÅ¼ytkownikÃ³w * 10 notatek * 31 dni = 310 000 000 zapisywanych notatek miesiÄ™cznie,  310 000 000 / (31 dni * 24h * 60m * 60s) = 310 000 000 / 2678400s = 116 zapisÃ³w na sekundÄ™,czyli potrzebujemy 116 WCU.KaÅ¼dy z uÅ¼ytkownikÃ³w odczytuje 30 notatek kaÅ¼dego dnia:  1 000 000 uÅ¼ytkownikÃ³w * 30 notatek * 31 dni = 930 000 000 odczytywanych notatek miesiÄ™cznie,  930 000 000 / (31 dni * 24h * 60m * 60s) = 930 000 000 / 2678400s = 348 odczytÃ³w na sekundÄ™,poniewaÅ¼ jeden RCU pozwala na 2 odczyty na sekundÄ™ potrzebujemy 348 / 2 = 174 RCU.Maksymalna liczba notatek jakÄ… bÄ™dziemy przechowywaÄ‡ w systemie po upÅ‚ywie 1 roku to:  12 miesiÄ™cy * 310 000 000 notatek = 3 720 000 000 * 1 KB = 3720 GB danych.Koszty wyniosÄ… odpowiednio:  koszt zapisÃ³w, czyli WCU to 116 - 25 (free tier) = 91 WCU * $0.47 = $42.77 miesiÄ™cznie,  koszt odczytÃ³w, czyli RCU to 174 - 25 (free tier) = 149 RCU * $0.09 = $13.41 miesiÄ™cznie,  koszt przechowywania danych to 3720 GB * $0.25 = $930 miesiÄ™cznie.W sumie za uÅ¼ycie DynamoDB zapÅ‚acimy miesiÄ™cznie $986.18.Koszty lambdLambda getNotes:  bÄ™dzie wywoÅ‚ywana 930 000 000 razy miesiÄ™cznie,  moÅ¼emy odjÄ…Ä‡ od tej liczby 1 000 000 requestÃ³w (free tier),  zostaje 929 000 000 requestÃ³w,  za kaÅ¼dy 1 000 000 requestÃ³w pÅ‚acimy $0.20,  w sumie mamy wiÄ™c 929 * $0.20 = $185.8 miesiÄ™cznie.Lambda addNote:  bÄ™dzie wywoÅ‚ywana 310 000 000 razy miesiÄ™cznie,  koszt wynosi wiÄ™c 310 * $0.20 = $62 miesiÄ™cznie.OprÃ³cz opÅ‚at za liczbÄ™ requestÃ³w pÅ‚acimy jeszcze za gigabajto-sekundy. ZaÅ‚Ã³Å¼my w przybliÅ¼eniu, Å¼e wywoÅ‚anie lambdy odczytujÄ…cej bÄ™dzie mieÅ›ciÅ‚o siÄ™ w 100 ms, a lambdy zapisujÄ…cej w 200 ms.Dla getNotes mamy wiÄ™c:  930 000 000 * 0.1s * 128 / 1024 MB = 11 625 000 GB-s,  od tej wartoÅ›ci moÅ¼emy odjÄ…Ä‡ 400 000 GB-s (free tier),  koszt wynosi: 11 225 000 GB-s * $0.00001667 = $187.12 miesiÄ™cznie.Odpowiednio dla addNote:  310 000 000 * 0.2s * 128 / 1024 MB = 7 750 000 GB-s,  koszt wynosi 7 750 000 * $0.00001667 = $129.19 miesiÄ™cznie.Sumaryczny koszt lambd wynosi $316.31 miesiÄ™cznie.Koszty API-GatewayKoszty API-Gateway podzielone sÄ… na koszty wykonanych Å¼Ä…daÅ„ oraz koszty transferu danych. MiesiÄ™cznie wykonujemy:  1 000 000 uÅ¼ytkownikÃ³w * (10 zapisÃ³w + 30 odczytÃ³w) * 31 dni = 1 240 000 000 wywoÅ‚aÅ„ API-Gateway,  za 1 000 000 wywoÅ‚aÅ„ pÅ‚acimy $3.70, koszt wynosi wiÄ™c 1 240 * $3.70 = $4 588.Przy zaÅ‚oÅ¼eniu, Å¼e pojedyncza notatka ma Å›rednio 1 KB transferujemy:  1 000 000 uÅ¼ytkownikÃ³w * (10 zapisÃ³w + 30 odczytÃ³w) * 31 dni * 1KB = 1.24 TB danych,  koszt transferu dla pierwszy 10 TB to $0.09 za 1 GB,  koszt wynosi wiÄ™c 1 240 GB * $0.09 = $111.6 miesiÄ™cznie.W sumie koszty API-Gateway to $4 699.6 miesiÄ™cznie.PodsumowaniePrzy przyjÄ™tych zaÅ‚oÅ¼eniach caÅ‚kowity koszt naszej przykÅ‚adowej aplikacji wyniesie $6 002.09 miesiÄ™cznie. Wydaje siÄ™ to sporÄ… kwotÄ…, jeÅ¼eli jednak podzielimy to przez liczbÄ™ uÅ¼ytkownikÃ³w, dostajemy koszt okoÅ‚o $0.006 na jednego uÅ¼ytkownika miesiÄ™cznie. Wynika z tego, Å¼e roczne utrzymanie jednego uÅ¼ytkownika zamknie siÄ™ w $0.08 - jeÅ¼eli zaoferujemy uÅ¼ytkownikom cenÄ™ $0.99 za roczny dostÄ™p do usÅ‚ugi na jednym uÅ¼ytkowniku zarobimy $0.91 rocznie :-)Wady i zalety rozwiÄ…zaniaRozwiÄ…zanie oparte o AWS wydaje siÄ™ byÄ‡ doÅ›Ä‡ proste do wykonania, a takÅ¼e atrakcyjne cenowo. PÅ‚acimy tylko za faktyczne zuÅ¼ycie zasobÃ³w nie ma wiÄ™c niebezpieczeÅ„stwa, Å¼e w przypadku maÅ‚ego zainteresowania naszÄ… aplikacjÄ… poniesiemy straty zwiÄ…zane z kosztami utrzymania infrastruktury. Dodatkowo w standardzie dostajemy duÅ¼Ä… skalowalnoÅ›Ä‡ rozwiÄ…zania. Wady? - W takiej implementacji bardzo mocno uzaleÅ¼niamy siÄ™ od komponentÃ³w AWS, przeniesienie rozwiÄ…zania na innÄ… infrastrukturÄ™ wiÄ…Å¼e siÄ™ praktycznie z jego przepisaniem.JuÅ¼ wkrÃ³tce na naszym blogu pojawi siÄ™ artykuÅ‚ omawiajÄ…cy automatyzacjÄ™ tworzenia zasobÃ³w na AWS w oparciu o narzÄ™dzie terraform. Zapraszamy.",
"url": "/2018/01/17/aws-serverless-programming.html",
"author": "Jakub Wilczewski",
"authorUrl": "/authors/jwilczewski.html",
"image": "jwilczewski.jpg",
"highlight": "/assets/img/posts/2018-01-17-aws-serverless-programming/aws.jpg",
"date": "17-01-2018",
"path": "pl/2018-01-17-aws-serverless-programming"
}
,


"2017-12-01-monitoring-serwerow-i-uslug-html": {
"title": "Jak szybko stworzyÄ‡ system monitoringu serwerÃ³w i usÅ‚ug",
"lang": "pl",
"tags": "monitoring icinga2 grafana influxdb",
"content": "BieÅ¼Ä…ce informacje o stanie serwerÃ³w i dziaÅ‚ajÄ…cych na nich usÅ‚ug sÄ… waÅ¼ne dla kaÅ¼dego dostawcy rozwiÄ…zaÅ„ IT, z ktÃ³rego korzysta szersza rzesza uÅ¼ytkownikÃ³w. NajwaÅ¼niejsze oczywiÅ›cie jest zapewnienie, Å¼e wszystkie usÅ‚ugi dziaÅ‚ajÄ…. Jednak samo dziaÅ‚anie to jeszcze nie wszystko. WaÅ¼ny jest takÅ¼e czas odpowiedzi z tych usÅ‚ug. JeÅ›li czas odpowiedzi wzrÃ³sÅ‚, lub nawet usÅ‚uga przestaÅ‚a odpowiadaÄ‡, przydatna moÅ¼e okazaÄ‡ siÄ™ znajomoÅ›Ä‡ stanu maszyny w zadanym czasie. W tym celu przydatne bÄ™dÄ… takie dane, jak obciÄ…Å¼enie procesora w danym momencie, zuÅ¼ycie pamiÄ™ci RAM oraz wolnej przestrzeni na dysku. Aby moÅ¼liwie szybko zareagowaÄ‡, a byÄ‡ moÅ¼e takÅ¼e uniknÄ…Ä‡ sytuacji, w ktÃ³rej usÅ‚uga przestaje odpowiadaÄ‡, istotne sÄ… ostrzeÅ¼enia, ktÃ³re pozwolÄ… zareagowaÄ‡ na czas. Niniejszy artykuÅ‚ ma na celu zaprezentowaÄ‡ rozwiÄ…zanie, ktÃ³re pozwoli w miarÄ™ szybko stworzyÄ‡ system monitoringu oraz ostrzegania na systemach wyposaÅ¼onych w system Linux, oparty o takie narzÄ™dzia jak â€œGrafanaâ€, â€œIcinga2â€ oraz â€œInfluxDBâ€.PrzykÅ‚adowy dashboard prezentujÄ…cy stan maszyny (obciÄ…Å¼enie, zuÅ¼ycie ramu i dysku), jak i dziaÅ‚ajÄ…cych na nim usÅ‚ugWymagania wstÄ™pneNa maszynie, ktÃ³ra peÅ‚niÄ‡ bÄ™dzie rolÄ™ serwera monitoringu naleÅ¼y:  ZainstalowaÄ‡ Dockera (https://docs.docker.com/engine/installation/)  ZainstalowaÄ‡ Docker-Compose (https://docs.docker.com/compose/install/)  NaleÅ¼y upewniÄ‡ siÄ™, Å¼e sieci tworzone przez Dockera bÄ™dÄ… miaÅ‚y dostÄ™p do maszyn, ktÃ³re chcemy monitorowaÄ‡. Przypadkiem kiedy takiego dostÄ™pu moÅ¼e nie byÄ‡, jest sytuacja w ktÃ³rej monitorowane maszyny znajdujÄ… siÄ™ za sieciÄ… VPN. Jednym z rozwiÄ…zaÅ„ w takim przypadku, ktÃ³re odbywa siÄ™ kosztem sÅ‚abszej separacji kontenera od hosta, jest edycja pliku docker-compose.yml z punktu piÄ…tego niniejszego rozdziaÅ‚u, tak aby kontenery korzystaÅ‚y z sieci hosta.  W kolejnym kroku powinniÅ›my wygenerowaÄ‡ parÄ™ kluczy SSH, ktÃ³ra posÅ‚uÅ¼y do uwierzytelniania siÄ™ na monitorowanych maszynach.  Na sam koniec pozostaje pobranie nastÄ™pujÄ…cego projektu: https://github.com/aswarcewicz/monitoringNa maszynach, ktÃ³re bÄ™dÄ… monitorowane naleÅ¼y dodaÄ‡ do zaufanych klucz publiczny SSH wygenerowany na serwerze monitoringu w kroku czwartym, tak aby serwer monitorujÄ…cy mÃ³gÅ‚ logowaÄ‡ siÄ™ przez SSH bez podawania hasÅ‚a. Logowanie przez SSH wykonywane jest celem pobrania stanu maszyny (obciÄ…Å¼enie, zuÅ¼ycie RAMu oraz dysku).Uruchamiamy kontenery  Po pobraniu projektu z githuba, naleÅ¼y umieÅ›ciÄ‡ klucz prywatny serwera wewnÄ…trz struktury pobranego projektu w katalogu â€œicinga2/ssh_keysâ€. Klucz prywatny zazwyczaj nosi nazwÄ™ id_rsa i nie posiada rozszerzenia *.pub.  Tworzymy i uruchamiamy wszystkie kontenery nastÄ™pujÄ…cym poleceniem wykonanym wewnÄ…trz pobranego projektu: â€œdocker-compose upâ€  W terminalu obok wykonujemy polecenie â€œdocker exec -it influxdb bashâ€, dziÄ™ki ktÃ³remu znajdziemy siÄ™ wewnÄ…trz kontenera influxdb.          W celu utworzenia bazy danych pod zbierane metryki uruchamiamy w kontenerze nastÄ™pujÄ…cy program â€œ/opt/influxdb/usr/bin/influxâ€      NastÄ™pnie wykonujemy polecenie tworzÄ…ce bazÄ™ danych, ktÃ³ra bÄ™dzie przechowywaÅ‚a dane przez dwa tygodnie. DÅ‚ugoÅ›Ä‡ przechowywania danych moÅ¼na dobraÄ‡ dowolnie, w tym takÅ¼e pominÄ…Ä‡ ich usuwanie po zadanym czasie. â€œCREATE DATABASE icinga2 WITH DURATION 2wâ€. Po wykonaniu tego polecenia moÅ¼na juÅ¼ opuÅ›ciÄ‡ kontener influxdb.        W tym kroku naleÅ¼y przejÅ›Ä‡ do konfiguracji Icinga2, tak aby zapisywaÅ‚a zebrane dane do wczeÅ›niej utworzonej bazy InfluxDB. Uruchomienie polecenia z punktu drugiego stworzyÅ‚o w katalogu projektu folder o nazwie â€œdataâ€, wewnÄ…trz ktÃ³rego znajdujÄ… siÄ™ niezbÄ™dne konfiguracje oraz bazy danych. W celu konfiguracji Icinga2 naleÅ¼y wyedytowaÄ‡ plik â€œ./data/config/icinga2/features-enabled/influxdb.confâ€ tak, aby wskazywaÅ‚ na wÅ‚aÅ›ciwÄ… bazÄ™ danych. JeÅ›li korzystamy z sieci utworzonej przez dockera, w linijce odpowiedzialnej za hosta powinien znaleÅºÄ‡ siÄ™ wpis â€œinfluxdbâ€, gdyÅ¼ pod takim aliasem dostÄ™pny bÄ™dzie kontener z bazÄ…. Natomiast, jeÅ›li korzystamy z sieci hostâ€™a, w tej samej linijce powinien znaleÅºÄ‡ siÄ™ wpis localhost. PozostaÅ‚e linijki wystarczy odkomentowaÄ‡.  Uruchamiamy ponownie caÅ‚oÅ›Ä‡. MoÅ¼na dokonaÄ‡ tego poprzez uÅ¼ycie kombinacji klawiszy â€œCTRL+Câ€ na terminalu z uruchomionym poleceniem â€œdocker-compose upâ€ lub poprzez uruchomienie innego terminala w katalogu projektu oraz wykonanie polecenia â€œdocker-compose stopâ€. Po zatrzymaniu kontenerÃ³w naleÅ¼y oczywiÅ›cie uruchomiÄ‡ je ponownie za pomocÄ… â€œdocker-compose upâ€ lub w tle â€œdocker-compose startâ€.Konfiguracja zbierania danychW tej czÄ™Å›ci skonfigurujemy IcingÄ™ tak, aby zbieraÅ‚a dane potrzebne dla naszego monitoringu. Wszystkie konfiguracje powinny znaleÅºÄ‡ siÄ™ w katalogu projektu â€œ./data/config/icinga2/conf.dâ€ lub w jego podkatalogach, aby zostaÅ‚y zaczytane przez IcingÄ™. Warto zwrÃ³ciÄ‡ uwagÄ™ na domyÅ›lnÄ… konfiguracjÄ™ komend zbierajÄ…cych dane o obciÄ…Å¼eniu, zuÅ¼yciu pamiÄ™ci RAM czy dysku. Komendy te domyÅ›lnie wykorzystujÄ… uÅ¼ytkownika â€œrootâ€ do logowania po SSH, jeÅ›li klucze wygnerowane w podpunkcie 4. â€œwymagaÅ„ wstÄ™pnychâ€ przeznaczone sÄ… dla innego uÅ¼ytkownika, to warto dokonaÄ‡ tej zmiany globalnie juÅ¼ w samej konfiguracji komend.Aby rozpoczÄ…Ä‡ zbierane danych przez IcingÄ™ naleÅ¼y najpierw skonfigurowaÄ‡ usÅ‚ugi, przykÅ‚adowa konfiguracja poniÅ¼ej:apply Service &quot;router_version_https&quot; {  import &quot;generic-service&quot;  display_name = &quot;Router (version) - HTTPS&quot;  assign where &quot;router&quot; in host.vars.services  ignore where host.vars.router.https.port == &quot;&quot;  check_command = &quot;http&quot;  vars.http_uri = &quot;/router/version/getVersionNumber&quot;  vars.http_vhost =   vars.http_port =   vars.http_ssl = &quot;true&quot;}apply Service &quot;servicemix_tcp_https&quot; {  import &quot;generic-service&quot;  display_name = &quot;ServiceMix - TCP (https)&quot;  assign where &quot;router&quot; in host.vars.services  ignore where host.vars.router.https.port == &quot;&quot;  check_command = &quot;tcp&quot;  vars.tcp_address =   vars.tcp_port = }A nastÄ™pnie dodaÄ‡ konfiguracjÄ™ maszyn (hostÃ³w), ktÃ³re z tych usÅ‚ug korzystajÄ…, przykÅ‚ad poniÅ¼ej:object Host &quot;Consdata (formdev)&quot; {    import &quot;generic-host&quot;    address = &quot;formdev.eximee.consdata.local&quot;    vars.os = &quot;Linux&quot;    vars.services = [&quot;check-load&quot;, &quot;check-memory&quot;, &quot;check-disk-space&quot;, &quot;router&quot;]    /* Router */    vars.router.https.port = &quot;9002&quot;}Po ponownym uruchomieniu Icinga powinna zaczytaÄ‡ konfiguracjÄ™ i co okoÅ‚o 30 sekund zapisywaÄ‡ metryki do InfluxDB. Ewentualne problemy powinny znaleÅºÄ‡ siÄ™ w logach, do ktÃ³rych dostÄ™p moÅ¼na uzyskaÄ‡ poprzez komendÄ™ â€œdocker logs -f icinga2â€.Wizualizacja danychKolejnym etapem jest skonfigurowanie Grafany, aby zaczÄ™Å‚a wyÅ›wietlaÄ‡ dane zbierane przez IcingÄ™. GrafanÄ™ znajdziemy na porcie 3000 na maszynie, na ktÃ³rej uruchomiono pobrany z GitHuba projekt. DomyÅ›lny login to admin, domyÅ›lne hasÅ‚o to takÅ¼e admin. Po zalogowaniu, podobnie jak w przypadku Icingi, konfigurujemy najpierw ÅºrÃ³dÅ‚o danych, jeÅ›li korzystamy z sieci Dockerâ€™a ÅºrÃ³dÅ‚o danych bÄ™dzie znajdowaÅ‚o siÄ™ na hoÅ›cie o nazwie influxdb, w przypadku korzystania z sieci hosta bÄ™dzie to localhost. NastÄ™pnie moÅ¼emy przejÅ›Ä‡ do konfiguracji Dashboardâ€™Ã³w czyli tablic agregujÄ…cych wykresy. Najpierw dodajemy wiersz, pÃ³Åºniej wykres, a nastÄ™pnie przechodzimy do edycji (konfiguracji) wykresu.Konfiguracja wyÅ›wietlania metryk dla wykresuTak naprawdÄ™ wszystko tutaj powinno daÄ‡ siÄ™ wyklikaÄ‡, jeÅ›li brakuje jakiejÅ› metryki, a minÄ™Å‚o wiÄ™cej niÅ¼ 30-60 sekund od startu Icingi z nowÄ… konfiguracjÄ…, oznacza to bÅ‚Ä…d w konfiguracji. W takim przypadku istnieje szansa, Å¼e znajdziemy jakieÅ› informacje po wykonaniu komendy â€œdocker logs -f icinga2â€. W przypadku konfiguracji alertÃ³w istotne moÅ¼e okazaÄ‡ siÄ™ wypeÅ‚nienie miejsc, w ktÃ³rych brakuje danych. Na powyÅ¼szym screenie wybrano â€œnoneâ€ i takÄ… opcjÄ™ zalecaÅ‚bym na poczÄ…tek.Powiadomienia w przypadku problemu z usÅ‚ugamiKolejnym etapem bÄ™dzie konfiguracja powiadomieÅ„. Dla odmiany od najczÄ™Å›ciej wykorzystywanych powiadomieÅ„ mailowych w tym przypadku skorzystamy z komunikatora Slack.  Na poczÄ…tku musimy skonfigurowaÄ‡ SlackBota, a dokÅ‚adniej â€œIncoming Webhookâ€. W przypadku Consdaty moÅ¼na tego dokonaÄ‡ pod nastÄ™pujÄ…cym adresem: https://consdata.slack.com/apps/manage/custom-integrations  Po otrzymaniu adresu URL naleÅ¼y go dodaÄ‡ w Menu â€œAlerting-&amp;gt;Notification Channelsâ€. W razie potrzeb moÅ¼na swobodnie wykorzystaÄ‡ jeden URL, aby skonfigurowaÄ‡ kilka kanaÅ‚Ã³w:    Ekran edycji kanaÅ‚u powiadomieÅ„. W tym przypadku jako kanaÅ‚ dostarczania powiadomieÅ„ wybrano komunikator Slack    Po tym pozostaje juÅ¼ tylko konfiguracja powiadomieÅ„ dla kaÅ¼dego z wykresÃ³w z osobna    Konfiguracja wywoÅ‚ania powiadomienia na wykresie, dla ktÃ³rego wczeÅ›niej skonfigurowano zbieranie metryk    Konfiguracja wywoÅ‚ania powiadomienia na wykresie - wybÃ³r sposobu wysyÅ‚ki alertu    Od tej chwili, w przypadku wystÄ…pienia problemÃ³w, moÅ¼emy spodziewaÄ‡ siÄ™ komunikatÃ³w podobnych do tego poniÅ¼ej    PrzykÅ‚adowy alert dostarczany na komunikator Slack  PodsumowaniePoÅ‚Ä…czenie Grafany, jako warstwy prezentacji i ostrzegania, oraz Icingi, jako narzÄ™dzia do zbierania metryk, jest dosyÄ‡ Å‚atwym i szybkim w zestawieniu systemem do monitorowania serwerÃ³w. Warto zwrÃ³ciÄ‡ uwagÄ™ takÅ¼e na wiele opcji budowania wÅ‚asnych tablic z wykresami. Poza grupowaniem wykresÃ³w w wiersze z opcjami zwijania, ustalania rÃ³Å¼nych rozmiarÃ³w czy umieszczania na tablicach kontrolek, ktÃ³re prezentujÄ… dane w innych formach niÅ¼ wykresy (np. w formie tabel lub pojedynczych wartoÅ›ci), wartÄ… uwagi jest funkcjonalnoÅ›Ä‡ zmiennych, ktÃ³rych moÅ¼na uÅ¼ywaÄ‡ na wykresach. Zmienne moÅ¼na definiowaÄ‡ za pomocÄ… wartoÅ›ci wpisanych na staÅ‚e, lub w formie zapytaÅ„. Jednym z zastosowaÅ„ takiej funkcjonalnoÅ›ci jest dynamiczna tablica zasilana metrykami z rÃ³Å¼nych serwerÃ³w w zaleÅ¼noÅ›ci od wybranej opcji.Dashboard, na ktÃ³rym zaprezentowano przykÅ‚adowe uÅ¼ycie zmiennych. W tym wypadku jeden Dashboard jest w stanie przeÅ‚Ä…czaÄ‡ serwer, z ktÃ³rego wyÅ›wietlane sÄ… metrykiNiestety opcja ta nie jest pozbawiona wad i w bieÅ¼Ä…cej wersji Grafany (4.6.2), chcÄ…c skorzystaÄ‡ ze zmiennych, pozbawiamy siÄ™ moÅ¼liwoÅ›ci definiowania powiadomieÅ„.",
"url": "/2017/12/01/monitoring-serwerow-i-uslug.html",
"author": "Adrian Swarcewicz",
"authorUrl": "/authors/aswarcewicz.html",
"image": "aswarcewicz.jpg",
"highlight": "/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/monitoring-systemow.jpg",
"date": "01-12-2017",
"path": "pl/2017-12-01-monitoring-serwerow-i-uslug"
}
,


"2017-08-01-gatling-html": {
"title": "Gatling! â€œOdÅ‚amkowym Å‚aduj!â€, czyli jak strzelaÄ‡ do aplikacji",
"lang": "pl",
"tags": "gatling tests",
"content": "W kaÅ¼dym projekcie pojawia siÄ™ moment, w ktÃ³rym pada stwierdzenie: â€œA co z wydajnoÅ›ciÄ…? Damy radÄ™ na produkcji?â€. I wtedy caÅ‚y zespÃ³Å‚ zastanawia siÄ™, ile tak naprawdÄ™ zniesie owoc ich wielomiesiÄ™cznych prac. Kod po wnikliwych review, poprawkach architektonicznych i projektowych wyglÄ…da wspaniale w repozytorium, ale analizujÄ…c go, trudno stwierdziÄ‡ czy aplikacja wytrzyma ruch na produkcji oraz gdzie sÄ… najsÅ‚absze ogniwa. Trzeba to sprawdziÄ‡ w praktyce. Przygotowujemy Å›rodowisko zasobami zbliÅ¼one do produkcji albo odpowiednio wyskalowane i klikamy. A co tam, zespÃ³Å‚ duÅ¼y, zaciÄ™cie klika i osiÄ…gamy ruch 5 uÅ¼ytkownikÃ³w. Szybka analiza logÃ³w i wszystko jest OK. Ale zaraz, to nic nam nie daje. Nadal nie zidentyfikowaliÅ›my najsÅ‚abszego ogniwa. Zautomatyzujmy zatem uÅ¼ytkownikÃ³w w systemie i wykonajmy symulacjÄ™ bardzo duÅ¼ej liczby uÅ¼ytkownikÃ³w. Pierwsze co przychodzi na myÅ›l, toâ€¦Nasz stary znajomy - Apache JMeter. Aplikacja bardzo rozbudowana, gdzie moÅ¼na tworzyÄ‡ skomplikowane przepÅ‚ywy uÅ¼ytkownikÃ³w. NarzÄ™dzie bogate w liczne funkcje, ale jak dla mnie doÅ›Ä‡ toporne. Pisanie w nim nowych scenariuszy zawsze idzie jakoÅ› ciÄ™Å¼ko. Praca jest lÅ¼ejsza, jeÅ›li moÅ¼na oprzeÄ‡ siÄ™ na starych testach. Trudno jednak czepraÄ‡ przyjemnoÅ›Ä‡ z pracy tym narzÄ™dziem.RÃ³wnieÅ¼ w moim zespole, gdy pojawiÅ‚a siÄ™ kwestia testÃ³w wydajnoÅ›ciowych, pierwszÄ… sugestiÄ… byÅ‚o uÅ¼ycie JMeterâ€™a. GÅ‚Ã³wnie z racji dostÄ™pnych scenariuszy dla podobnego przepÅ‚ywu uÅ¼ytkownika. W trakcie dyskusji na temat wydajnoÅ›ci padÅ‚o, Å¼e w firmie, jeden z zespoÅ‚Ã³w uÅ¼yÅ‚ narzÄ™dzia Gatling, ktÃ³re sprawdziÅ‚o siÄ™ duÅ¼o lepiej, niÅ¼ narzÄ™dzie Apacha. PowÃ³d byÅ‚ bardzo prosty, scenariusze siÄ™ programuje, a nie klika w GUI. Przez co sÄ… czytelniejsze i Å‚atwiejsze do utrzymania w repo. Co prawda, w Gatlingu koduje siÄ™ w jÄ™zyku scala, ale nawet jeÅ›li, ktoÅ› nigdy nie programowaÅ‚ w tym jÄ™zyku, to bez problemu sobie poradzi. Podstawy w zupeÅ‚noÅ›ci wystarczÄ…. Nie jest potrzebna skomplikowana wiedza, o czym przekonujÄ… nawet twÃ³rcy na swojej stronie.PoniÅ¼ej sprÃ³bujÄ™ przybliÅ¼yÄ‡ owe narzÄ™dzie posÅ‚ugujÄ…c siÄ™ prostym przykÅ‚adem.Co by tu potestowaÄ‡?Na poczÄ…tku musimy przygotowaÄ‡ Å›rodowisko do testÃ³w. Wystawimy jakiÅ› prosty serwis z kilkoma metodami. Najszybciej bÄ™dzie skorzystaÄ‡ ze springbootâ€™a i zainicjowaÄ‡ projekt. Wchodzimy na https://start.spring.io, klikamy co nas interesuje i Å›ciÄ…gamy projekt. Importujemy i moÅ¼emy zaczynaÄ‡. Dodajemy prosty serwis.package pl.consdata.server.controller;import org.springframework.web.bind.annotation.*;import java.security.SecureRandom;@RestControllerpublic class SimpleWaitController {  private final String GENERIC_RESPONSE = &quot;{\\&quot;result\\&quot;: %1$d}&quot;;  @GetMapping(path = &quot;/getWaitTime&quot;)  @ResponseBody  public String getWaitTime() {     SecureRandom random = new SecureRandom();     return String.format(GENERIC_RESPONSE, 5000 + random.nextInt(5500));  }  @PostMapping(path = &quot;/wait&quot;)  @ResponseBody  public String waitForNextStep(Integer waitTime) {     try {        Thread.sleep(waitTime);     } catch (InterruptedException e) {        e.printStackTrace();     }     return String.format(GENERIC_RESPONSE, waitTime);  }  @GetMapping(path = &quot;/stop/{waitTime}&quot;)  public String stop(@PathVariable Integer waitTime) {     return &quot;user end after: &quot; + waitTime;  }}FunkcjonalnoÅ›Ä‡ poszczegÃ³lnych metod nie jest skomplikowana, ale do testu wystarczy. ZakÅ‚adamy nastÄ™pujÄ…cy przepÅ‚yw uÅ¼ytkownika (kaÅ¼dy uÅ¼ytkownik postÄ™puje tak samo):  Pobiera czas przetwarzania  WywoÅ‚uje przetwarzanie  Czeka 5 sekund - po stronie uÅ¼ytkownika  Opuszcza ten skomplikowany procesSkoro aplikacja jest gotowa, to sprÃ³bujmy zastanowiÄ‡ siÄ™: co jest sÅ‚abym ogniwem? Bystre oko zauwaÅ¼y, Å¼e endpoint â€˜/waitâ€™ moÅ¼e sprawiaÄ‡ problemy, gdyÅ¼ zawiera metodÄ™ â€˜sleepâ€™. OK, zgodzÄ™ siÄ™, ale pomimo tego - jaki ruch ta aplikacja wytrzyma i co pierwsze padnie? Tutaj odpowiedÅº juÅ¼ nie jest juÅ¼ taka oczywista. Przygotujmy zatem test wydajnoÅ›ciowy i sprawdÅºmy.Zaprogramujmy scenariusz wydajnoÅ›ciowyPrzejdÅºmy zatem do naszego zadania, czyli napisania scenariusza pokrywajÄ…cego flow uÅ¼ytkownika. Zanim jednak do tego przystÄ…pimy, musimy pobraÄ‡ naszego frameworka. Skorzystamy z mojego ulubionego sposobu, czyli zaprzÄ™gniemy mavena, aby siÄ™ tym zajÄ…Å‚. W gÅ‚Ã³wnym pomâ€™ie dodajemy nastÄ™pujÄ…ce konfiguracje:  biblioteka wykorzystywana przez Gatlinga      &amp;lt;dependencies&amp;gt;     &amp;lt;dependency&amp;gt;         &amp;lt;groupId&amp;gt;io.gatling.highcharts&amp;lt;/groupId&amp;gt;         &amp;lt;artifactId&amp;gt;gatling-charts-highcharts&amp;lt;/artifactId&amp;gt;         &amp;lt;version&amp;gt;2.2.4&amp;lt;/version&amp;gt;         &amp;lt;scope&amp;gt;test&amp;lt;/scope&amp;gt;     &amp;lt;/dependency&amp;gt;  &amp;lt;/dependencies&amp;gt;        plugin odpowiedzialny za uruchamianie z poziomu mavena      &amp;lt;plugin&amp;gt;     &amp;lt;groupId&amp;gt;io.gatling&amp;lt;/groupId&amp;gt;     &amp;lt;artifactId&amp;gt;gatling-maven-plugin&amp;lt;/artifactId&amp;gt;     &amp;lt;version&amp;gt;2.2.4&amp;lt;/version&amp;gt;     &amp;lt;configuration&amp;gt;         &amp;lt;simulationsFolder&amp;gt;src/main&amp;lt;/simulationsFolder&amp;gt;         &amp;lt;simulationClass&amp;gt;scala.simulation.SimpleWaitSimulation&amp;lt;/simulationClass&amp;gt;     &amp;lt;/configuration&amp;gt;     &amp;lt;executions&amp;gt;         &amp;lt;execution&amp;gt;             &amp;lt;goals&amp;gt;                 &amp;lt;goal&amp;gt;execute&amp;lt;/goal&amp;gt;             &amp;lt;/goals&amp;gt;         &amp;lt;/execution&amp;gt;     &amp;lt;/executions&amp;gt;  &amp;lt;/plugin&amp;gt;      Dodatkowo, w konfiguracji dodajemy Å›cieÅ¼kÄ™ ze ÅºrÃ³dÅ‚ami oraz domyÅ›lnÄ… klasÄ™ naszej symulacji. Klasa ta musi dziedziczyÄ‡ po obiekcie â€˜Simulationâ€™ z pakietu Gatlinga. Po stworzeniu klasy â€˜SimpleWaitSimulationâ€™, uruchamiamy symulacjÄ™ w konsoli poleceniem:mvn gatling:executePowinniÅ›my dostaÄ‡ bÅ‚Ä…d:Caused by: java.lang.IllegalArgumentException: requirement failed: No scenario set upBÅ‚Ä…d ten informuje nas, Å¼e nasza symulacja nie zawiera scenariusza, co oczywiÅ›cie jest prawdÄ… na tym etapie, ale potwierdza nam dziaÅ‚anie szkieletu symulacji. MoÅ¼emy zatem przejÅ›Ä‡ dalej i skupiÄ‡ siÄ™ na zakodowaniu naszego testu. Uruchamiamy wczeÅ›niej napisanÄ… aplikacjÄ™ do testowania i ruszamy.W pierwszej kolejnoÅ›ci definiujemy podstawy komunikacji naszego testu z serwerem.Aplikacja uruchamia siÄ™ na standardowym adresie i porcie, zatem takie wartoÅ›ci przekazujemy. W Gatlingu za konfiguracjÄ™ komunikacji odpowiada klasa â€˜httpâ€™. Ustawiamy adres bazowy, pod ktÃ³rym szukaÄ‡ naleÅ¼y naszej aplikacji. Nasz test bÄ™dzie symulowaÅ‚ uderzenia z przeglÄ…darki, zatem ustawiamy odpowiednie nagÅ‚Ã³wki wykorzystywane przy requestach. Powstaje nastÄ™pujÄ…cy kod:val httpConf = http    .baseURL(&quot;http://localhost:8080&quot;)    .acceptHeader(&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;)    .acceptEncodingHeader(&quot;gzip, deflate&quot;)    .acceptLanguageHeader(&quot;en-US,en;q=0.5&quot;)    .userAgentHeader(&quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:50.0) Gecko/20100101 Firefox/50.0&quot;)Teraz moÅ¼emy zaprogramowaÄ‡ scenariusz, czyli krok po kroku wykonaÄ‡ to, co wykonuje symulowany uÅ¼ytkownik. Za tworzenie scenariusza odpowiada polecenie â€˜scenarioâ€™. Na poczÄ…tku powoÅ‚ajmy instancjÄ™ tego obiektu.val scn = scenario(&quot;Simple Wait simulation&quot;)W tym momencie mamy zalÄ…Å¼ek scenariusza i moÅ¼emy zaczÄ…Ä‡ dodawaÄ‡ poszczegÃ³lne wywoÅ‚ania. W pierwszym kroku uÅ¼ytkownik wywoÅ‚uje metodÄ… GET endpointa â€˜/getWaitTimeâ€™, a w odpowiedzi otrzymuje dane, ktÃ³re musi zapamiÄ™taÄ‡ i wykorzystaÄ‡ w kolejnym etapie. Praca z Gatlingiem jest bardzo wygodna. Dostajemy masÄ™ uÅ¼ytecznych poleceÅ„, dziÄ™ki ktÃ³rym moÅ¼emy wykonywaÄ‡ rÃ³Å¼ne operacje. ZarÃ³wno na wejÅ›ciowych, jak i wyjÅ›ciowych danych z testu. Na poczÄ…tku dodajemy wywoÅ‚anie GET:.exec(http(&quot;Take waiting time&quot;)    .get(&quot;/getWaitTime&quot;))CaÅ‚kiem proste. PowyÅ¼szy kod wywoÅ‚a tylko wskazanego endpointa. Brakuje nam pobrania odpowiedzi i zapamiÄ™tania wartoÅ›ci. Dodatkowo powinniÅ›my dostaÄ‡ kod statusu http rÃ³wny 200. W naszym przypadku oznacza to, Å¼e wywoÅ‚anie powiodÅ‚o siÄ™, a serwer wyÅ›le do nas jsona z polem o nazwie â€˜resultâ€™. WartoÅ›Ä‡ tÄ™ musimy zapamiÄ™taÄ‡ i wykorzystaÄ‡ do dalszego procesowania uÅ¼ytkownika. UzupeÅ‚nijmy nasze proste wywoÅ‚anie o niezbÄ™dne elementy:val scn = scenario(&quot;Simple Wait simulation&quot;)    .exec(http(&quot;Take waiting time&quot;)        .get(&quot;/getWaitTime&quot;)        .check(status.is(200))        .check(jsonPath(&quot;$.result&quot;).saveAs(&quot;waitTime&quot;))    )Podobnie jak wczeÅ›niej skorzystaliÅ›my z wbudowanych narzÄ™dzi Gatlinga. â€˜Checkâ€™ operuje na odpowiedzi wszystkich requestÃ³w. MetodÄ… â€˜statusâ€™ sprawdzamy kod odpowiedzi, czyli oczekujemy wartoÅ›ci 200. Metodami â€˜jsonPathâ€™ wyciÄ…gamy niezbÄ™dne informacje z odpowiedzi, a poleceniem â€˜saveAsâ€™ zapamiÄ™tamy te dane. Warto wspomnieÄ‡, iÅ¼ Gatling do kaÅ¼dego uÅ¼ytkownika tworzy sesjÄ™ uÅ¼ytkownika, do ktÃ³rej moÅ¼emy zarÃ³wno zapisywaÄ‡, jak i odczytywaÄ‡ wartoÅ›ci. Istnieje takÅ¼e moÅ¼liwoÅ›Ä‡ odczytywania wielu wartoÅ›ci w ramach jednego Å¼Ä…dania, wÃ³wczas musimy tylko skopiowaÄ‡ polecenie â€˜checkâ€™ i odpowiednio ustawiÄ‡, co i jak chcemy zapisaÄ‡.IdÄ…c dalej, uÅ¼ytkownik wywoÅ‚uje endpoint â€˜/waitâ€™ przekazujÄ…c wartoÅ›Ä‡ z pierwszego Å¼Ä…dania, a otrzymujÄ…c innÄ… wartoÅ›Ä‡, ktÃ³rÄ… takÅ¼e zapamiÄ™tujemy. PostÄ™pujÄ…c zgodnie z opisem, kodujemy:.exec(http(&quot;Wait for&quot;)    .post(&quot;/wait&quot;)    .formParam(&quot;&quot;&quot;waitTime&quot;&quot;&quot;, &quot;${waitTime}&quot;)    .check(status.is(200))    .check(jsonPath(&quot;$.result&quot;).saveAs(&quot;realWaitTime&quot;))    )Nowym elementem, jaki tutaj wykorzystaliÅ›my, jest polecenie â€˜formParamâ€™. Jak nazwa sugeruje, sÅ‚uÅ¼y ono do przekazywania parametrÃ³w do wywoÅ‚ania. Poza nazwÄ…, w formularzu podajemy wartoÅ›Ä‡: bezpoÅ›rednio lub za pomocÄ… zmiennej. W tym przypadku odczytaliÅ›my z sesji wczeÅ›niej zapisanÄ… wartoÅ›Ä‡.W kolejnym etapie uÅ¼ytkownik czeka kilka sekund, zanim wywoÅ‚a nastÄ™pnÄ… operacjÄ™. Aby to osiÄ…gnÄ…Ä‡, w prosty sposÃ³b moÅ¼emy wykorzystaÄ‡ wbudowanÄ… metodÄ™ â€˜pauseâ€™. Jako parametr przyjmujemy wartoÅ›Ä‡, oznaczajÄ…cÄ… iloÅ›Ä‡ czasu, ktÃ³rÄ… symulowany uÅ¼ytkownik ma czekaÄ‡ przed wykonaniem nastÄ™pnego kroku. Polecenie proste, ale uÅ¼yteczne. MoÅ¼emy w ten sposÃ³b symulowaÄ‡ np. wypeÅ‚nianie formularza czy klikanie w jakiÅ› przycisk..pause(5 seconds)W ostatnim kroku uÅ¼ytkownik wywoÅ‚uje tak, jak na poczÄ…tku polecenie GET, ale tym razem przekazujÄ…c wartoÅ›Ä‡. W odpowiedzi nie otrzymuje JSONa, ale prosty ciÄ…g znakÃ³w. Rezultat odpowiedzi sprawdzimy czy zawiera interesujÄ…cÄ… nas wartoÅ›Ä‡ przekazanÄ… w Å¼Ä…daniu..exec(http(&quot;User stop&quot;)    .get(&quot;/stop/${realWaitTime}&quot;)    .check(status.is(200), bodyBytes.saveAs(&quot;endMessageBody&quot;))    .check(substring(&quot;${realWaitTime}&quot;).exists))Poza wykorzystywanymi poprzednio poleceniami, uÅ¼yliÅ›my tutaj kolejnej metody Gatlinga, tym razem do operacji na stringach. â€˜Substringâ€™ pozwala w prosty sposÃ³b operowaÄ‡ na ciÄ…gach znakÃ³,w np. znajdujÄ…c podanÄ… na wejÅ›ciu frazÄ™. Serwer powinien wysÅ‚aÄ‡ nam â€œstringaâ€ zawierajÄ…cego przekazany na wejÅ›ciu parametr. Dlatego teÅ¼ weryfikujemy, czy otrzymana odpowiedÅº zawiera Ã³w wartoÅ›Ä‡.CaÅ‚y przepÅ‚yw uÅ¼ytkownika mamy juÅ¼ zakodowany. Na koÅ„cu, zbierzmy wszystkie kroki w jednym miejscu. KaÅ¼de polecenie do wykonania operacji uÅ¼ytkownika zwraca instancjÄ™ scenariusza, zatem w prosty sposÃ³b moÅ¼emy agregowaÄ‡ polecenia. W efekcie nasz wynikowy scenariusz wyglÄ…da nastÄ™pujÄ…co:val scn = scenario(&quot;Simple Wait simulation&quot;)    .exec(http(&quot;Take waiting time&quot;)        .get(&quot;/getWaitTime&quot;)        .check(status.is(200))        .check(jsonPath(&quot;$.result&quot;).saveAs(&quot;waitTime&quot;))    )    .exec(http(&quot;Wait for&quot;)        .post(&quot;/wait&quot;)        .formParam(&quot;&quot;&quot;waitTime&quot;&quot;&quot;, &quot;${waitTime}&quot;)        .check(status.is(200))        .check(jsonPath(&quot;$.result&quot;).saveAs(&quot;realWaitTime&quot;)))        .pause(5 seconds)    )    .exec(http(&quot;User stop&quot;)        .get(&quot;/stop/${realWaitTime}&quot;)        .check(status.is(200), bodyBytes.saveAs(&quot;endMessageBody&quot;))        .check(substring(&quot;${realWaitTime}&quot;).exists)    )W nastÄ™pnym kroku zajmiemy siÄ™ konfiguracjÄ… i przygotowaniem ruchu uÅ¼ytkownikÃ³w.Pierwsze strzaÅ‚yMamy gotowy scenariusz, aby jednak nasza symulacja zostaÅ‚a poprawnie uruchomiona, trzeba jÄ… jeszcze skonfigurowaÄ‡. W tym celu musimy wywoÅ‚aÄ‡ metodÄ™ â€˜setUp()â€™, ktÃ³ra poÅ‚Ä…czy nam wszystkie elementy tzn.: komunikacjÄ™, scenariusz i ruch uÅ¼ytkownikÃ³w. Nie jest to skomplikowana operacja. W jej efekcie powstanie jedna linijka kodu:setUp(scn.inject(atOnceUsers(1)).protocols(httpConf))Na poczÄ…tek, w celu sprawdzenia czy wszystko poprawnie dziaÅ‚a, uruchomimy test tylko z jednym uÅ¼ytkownikiem. UÅ¼yjemy tutaj polecenia â€˜atOnceUsers(1)â€™, ktÃ³re symuluje wÅ‚aÅ›nie okreÅ›lonÄ… liczbÄ™ uÅ¼ytkownikÃ³w na start testu. Wszystko gotowe, zatem moÅ¼emy uruchamiaÄ‡. Odpalamy konsolÄ™ i uruchamiamy polecenie:mvn gatling:executeJeÅ›li wszystko poszÅ‚o OK, to dostajemy:[INFO] BUILD SUCCESSPrzeglÄ…damy logi i weryfikujemy czy otrzymaliÅ›my nastÄ™pujÄ…ce wyniki:--- Requests ------------------------------------------------------------------Global (OK=3 KO=0 )Take waiting time (OK=1 KO=0 )Wait for (OK=1 KO=0 )User stop (OK=1 KO=0 )JeÅ›li mamy takie wypiski, to wszystko jest w jak najlepszym porzÄ…dku.Przy takiej konfiguracji testu mamy w sumie 3 uderzenia do aplikacji, zatem ciÄ™Å¼ko wnioskowaÄ‡ i mÃ³wiÄ‡ tu o jakichÅ› wynikach do analizy. Testowo moÅ¼emy spojrzeÄ‡ sobie na raport, ktÃ³ry wygenerowany zostaÅ‚ automatycznie na koniec testu. Wystarczy poszukaÄ‡ â€˜Please open the following file:â€™ gdzie znajduje siÄ™ strona html z wszystkimi wynikami naszego testu. DokÅ‚adniej przyjrzymy siÄ™ temu, gdy uderzeÅ„ bÄ™dzie o wiele wiÄ™cej. Ustalmy zatem wiÄ™kszy ruch.â€œOch, ilu tych uÅ¼ytkownikÃ³wâ€Ruch jednego uÅ¼ytkownika nie jest w stanie zbadaÄ‡ nam wydajnoÅ›ci aplikacji. Dlatego musimy zastanowiÄ‡ siÄ™, jaki ruch chcemy wygenerowaÄ‡. OczywiÅ›cie, jeÅ›li mowa o prawdziwych aplikacjac,h to musimy wziÄ…Ä‡ pod uwagÄ™ charakterystykÄ™ dziaÅ‚ania naszej aplikacji w Å›rodowisku produkcyjnym. Czy jest to ruch liniowy, skokowy, impulsowy itp. I to wÅ‚aÅ›nie rozkÅ‚ad ruchu na produkcji powinien determinowaÄ‡, w jaki sposÃ³b generujemy ruch uÅ¼ytkownikÃ³w w systemie w trakcie testu.Gatling ma kilka sposobÃ³w generowania ruchu. PoniewaÅ¼ metod jest wiele, warto spojrzeÄ‡ do dokumentacji - http://gatling.io/docs/current/general/simulation_setup/. My zakÅ‚adamy, Å¼e w kaÅ¼dej sekundzie do systemu bÄ™dzie wpadaÄ‡ okreÅ›lona liczba nowych uÅ¼ytkownikÃ³w, postÄ™pujÄ…cych wedÅ‚ug poprzednio opisanego scenariusza. Przy konfiguracji symulacji wykorzystamy dwie metody:  â€™nothingFor()â€™ - do rozÅ‚adowania poprzedniego ruchu  â€˜constantUsersPerSec() during() randomizedâ€™ - do symulowania okreÅ›lonej liczby uÅ¼ytkownikÃ³w przez ustalony czas.W poczÄ…tkowej fazie naleÅ¼y wykonaÄ‡ wstÄ™pne testy i okreÅ›liÄ‡ wartoÅ›ci w jakich bÄ™dziemy siÄ™ poruszaÄ‡. Nie ma sensu przeprowadzaÄ‡ godzinnego testu, jeÅ›li aplikacja â€œwywali siÄ™â€ w ciÄ…gu pierwszych sekund. Po wykonaniu takich szybkich testÃ³w, moÅ¼emy przystÄ…piÄ‡ do finalnej konfiguracji.Dobrym rozwiÄ…zaniem jest przeprowadzanie testÃ³w w ramach kilku iteracji. KaÅ¼da z nich skÅ‚ada siÄ™ z fazy obciÄ…Å¼enia aplikacji uÅ¼ytkownikami, a nastÄ™pnie czasu potrzebnego na zakoÅ„czenie przetwarzania wszystkich uÅ¼ytkownikÃ³w. WÃ³wczas moÅ¼emy uruchomiÄ‡ nastÄ™pne powtÃ³rzenie, ale zwiÄ™kszajÄ…c liczbÄ™ uÅ¼ytkownikÃ³w. O tym jak przeprowadzaÄ‡ testy wydajnoÅ›ciowe, moÅ¼na by napisaÄ‡ nastÄ™pny artykuÅ‚ czy nawet ksiÄ…Å¼kÄ™.WrÃ³Ä‡my zatem do naszej symulacji. Wykonamy piÄ™Ä‡ iteracji, kaÅ¼da bÄ™dzie siÄ™ skÅ‚adaÄ‡ z obciÄ…Å¼enia uÅ¼ytkownikami trwajÄ…cym 100 sekund, nastÄ™pnie przez 60 sekund bÄ™dziemy czekaÄ‡ zanim uruchomimy nastÄ™pne powtÃ³rzenie. Zaczniemy od 20 nowych uÅ¼ytkownikÃ³w na sekundÄ™ i bÄ™dziemy zwiÄ™kszaÄ‡ ich liczbÄ™ o kolejnych 10 w nastÄ™pnych iteracjach. Podobnie jak w przypadku scenariusza, moÅ¼emy agregowaÄ‡ poszczegÃ³lne fazy testu. Dla powyÅ¼szych zaÅ‚oÅ¼eÅ„ mamy nastÄ™pujÄ…cÄ… konfiguracjÄ™:setUp(scn.inject(constantUsersPerSec(20) during(100 seconds) randomized,nothingFor(60 seconds),constantUsersPerSec(30) during(100 seconds) randomized,nothingFor(60 seconds),constantUsersPerSec(40) during(100 seconds) randomized,nothingFor(60 seconds),constantUsersPerSec(50) during(100 seconds) randomized,nothingFor(60 seconds),constantUsersPerSec(60) during(100 seconds) randomized).protocols(httpConf))Konfiguracja gotowa, czas na uruchomienie.Wielkie strzelanieW koÅ„cu dotarliÅ›my do momentu, w ktÃ³rym moÅ¼emy sprawdziÄ‡, jak zachowuje siÄ™ nasza aplikacja przy duÅ¼ym obciÄ…Å¼eniu. Wszystko gotowe, uruchamiamy symulacjÄ™ i idziemy na kawÄ™. Jak juÅ¼ wypijemy, jest szansa, Å¼e nasz test siÄ™ zakoÅ„czyÅ‚. WÃ³wczas w logach, tak jak poprzednio, otrzymamy:[INFO] BUILD SUCCESSNastÄ™pnie szukamy, gdzie wygenerowany zostaÅ‚ raport: â€˜Please open the following file:â€™. Odpalamy i naszym oczom pojawia siÄ™ automatycznie wygenerowany raport.Przejrzyjmy otrzymane wyniki. Pierwsze bÅ‚Ä™dy zaczÄ™Å‚y siÄ™ pojawiaÄ‡ przy ruchu 50 nowych uÅ¼ytkownikÃ³w na sekundÄ™. CaÅ‚kiem nieÅºle. WidaÄ‡ jednak, Å¼e aplikacja przetwarzaÅ‚a caÅ‚y ruch tylko przy 20 nowych uÅ¼ytkownikach na sekundÄ™. JuÅ¼ przy kolejnej iteracji widaÄ‡ tendencjÄ™ wzrostowÄ… aktywnych uÅ¼ytkownikÃ³w. Oznacza to, Å¼e aplikacja nie radziÅ‚a sobie z caÅ‚ym ruchem, jaki byÅ‚ generowany i czÄ™Å›Ä‡ Å¼Ä…daÅ„ byÅ‚a kolejkowana. Przy kolejnych fazach widaÄ‡, Å¼e tendencja siÄ™ jeszcze zaostrzaÅ‚a i przy 50 uÅ¼ytkownikach czas oczekiwania na aplikacjÄ™ byÅ‚ tak dÅ‚ugi, Å¼e â€œleciaÅ‚yâ€ timeouty. Wiemy oczywiÅ›cie z czego to wynika. UÅ¼ycie â€œsleepâ€ z duÅ¼ymi wartoÅ›ciami jest maÅ‚o wydajne. JeÅ›li to usuniemy, otrzymamy duÅ¼o wiÄ™ksze wartoÅ›ci.Czy nie jest wspaniaÅ‚e, Å¼e Gatling wygenerowaÅ‚ za nas wyniki i pokazaÅ‚ w graficznej formie? Jak dla mnie super. MoÅ¼emy sprawdziÄ‡ podstawowe dane, takie jak liczbÄ™ aktywnych uÅ¼ytkownikÃ³w, czasy odpowiedzi, liczbÄ™ Å¼Ä…daÅ„ i odpowiedzi w czasie. Dodatkowo, moÅ¼emy wybraÄ‡ jeden krok i przeanalizowaÄ‡ w izolacji w ten sam sposÃ³b. Poza tym, przedstawione mamy statystyki w liczbach, takie jak, minimalny i maksymalny czas, Å›rednia, odchylenie standardowe czy liczba requestÃ³w z podziaÅ‚em na zakoÅ„czone sukcesem i bÅ‚Ä™dem. Gatling przedstawia takÅ¼e czasy poszczegÃ³lnych udziaÅ‚Ã³w procentowych obsÅ‚ugi Å¼Ä…daÅ„. Dostajemy zatem informacje ile trwaÅ‚o 50%, 75%, 95% i 99% wywoÅ‚aÅ„. Ten prosty raport naprawdÄ™ sprawia, Å¼e praca z Gatlingiem i testami wydajnoÅ›ciowymi jest przyjemnoÅ›ciÄ….Testowanie wydajnoÅ›ci poprzez GatlingPodsumowujÄ…c moje doÅ›wiadczenia w pracy z Gatlingiem, mogÄ™ stwierdziÄ‡, Å¼e wybÃ³r tego narzÄ™dzia byÅ‚ â€œstrzaÅ‚em w dziesÄ…tkÄ™â€. Jego istotnÄ… zaletÄ… jest to, Å¼e scenariusze testowe sÄ… pisane jako zwykÅ‚y kod. Nie ma problemu, aby scenariusz przygotowywaÅ‚o wiÄ™cej osÃ³b. Problemy z â€œmergowaniemâ€ zazwyczaj sÄ… minimalne. Kod jest czytelny i nie ma potrzeby pisania dodatkowej dokumentacji.Gatling zawiera ponadto masÄ™ pomocniczych poleceÅ„. Na stronie http://gatling.io/ dostÄ™pna jest uÅ¼yteczna dokumentacja, w ktÃ³rej w przejrzysty sposÃ³b wyjaÅ›niono dostÄ™pne funkcje. MoÅ¼emy korzystaÄ‡ bezpoÅ›rednio z poleceÅ„ JMXâ€™a naszego serwera, czy tworzyÄ‡ komunikaty na kolejkach JMS. Produkt jest rozwijany. PowstajÄ… nowe wersje, a bÅ‚Ä™dy sÄ… rozwiÄ…zywane. W przypadku problemÃ³w, moÅ¼na skorzystaÄ‡ z pomocy spoÅ‚ecznoÅ›ci odpowiedzialnej za rozwÃ³j narzÄ™dzia.Jak kaÅ¼de narzÄ™dzie, rÃ³wnieÅ¼ Gatling ma ograniczonÄ… liczbÄ™ funkcji. JeÅ›li w dokumentacji nie znajdziemy potrzebnych poleceÅ„, moÅ¼emy sprÃ³bowaÄ‡ zapisaÄ‡ np. dane w sesji i posiÅ‚kowaÄ‡ siÄ™ kodem napisanym przez nas w scali. Daje nam to ogrom moÅ¼liwoÅ›ci. Zapewnia elastycznoÅ›Ä‡ w rozwiÄ…zywaniu specyficznych przypadkÃ³w, ktÃ³re niestety spotykamy praktycznie codziennie.Kolejnym waÅ¼nym uÅ‚atwieniem wykonywania testÃ³w jest raport koÅ„cowy. Automatycznie generowane wykresy i podstawowe statystyki bardzo przydajÄ… siÄ™ w poczÄ…tkowej i koÅ„cowej fazie testu. JeÅ›li chcemy, szybko przetestowaÄ‡ aplikacjÄ™ z ogromnym ruchem, nie ma problemu -zmieniamy 2-3 linijki i odpalamy. Po kilku chwilach mamy dostÄ™pne wyniki i wiemy, czy aplikacja daje radÄ™, czy juÅ¼ nie. Tej funkcjonalnoÅ›ci mi zawsze brakowaÅ‚o np. w JMeterze, gdzie raportem byÅ‚o trzeba zajÄ…Ä‡ siÄ™ samemu po testach. W przypadku Gatlinga wyniki moÅ¼emy bez problemu doÅ‚Ä…czyÄ‡ do dokumentacji produktu, jako potwierdzenie naszej ciÄ™Å¼kiej i dobrze wykonanej pracy przy pisaniu aplikacji i testach wydajnoÅ›ciowych. Polecam kaÅ¼demu wyprÃ³bowanie Gatlinga do testÃ³w wydajnoÅ›ciowych. Mi narzÄ™dzie to bardzo mocno przypadÅ‚o do gustu.",
"url": "/2017/08/01/gatling.html",
"author": "BÅ‚aÅ¼ej Baron",
"authorUrl": "/authors/bbaron.html",
"image": "bbaron.jpg",
"highlight": "/assets/img/posts/2017-08-01-gatling/wydajnosc_aplikacji.jpg",
"date": "01-08-2017",
"path": "pl/2017-08-01-gatling"
}
,


"2017-02-17-absolutne-importowanie-zaleznosci-w-angular-cli-html": {
"title": "Absolutne importowanie zaleÅ¼noÅ›ci w Angular CLI",
"lang": "pl",
"tags": "angular",
"content": "Odpowiedzialny programista tworzÄ…c aplikacje przestrzega powszechnie uznanych zasad tworzenia oprogramowania. JednÄ… z takich zasad jest Single Responsibility Principle, ktÃ³ra uczy nas, Å¼e kaÅ¼dy moduÅ‚ powinien mieÄ‡ jedno, jasno zdefiniowane zadanie. PrzenoszÄ…c tÄ™ zasadÄ™ na strukturÄ™ aplikacji powinniÅ›my, co najmniej, wydzieliÄ‡ kaÅ¼dÄ… tworzonÄ… klasÄ™ do osobnego pliku. O ile Å›wiat JavaScriptâ€™u prÃ³bowaÅ‚ wielokrotnie zmierzyÄ‡ siÄ™ z problemem modularyzacji aplikacji, to jednak dopiero standard ES6 pozwoliÅ‚ w peÅ‚ni zaadaptowaÄ‡ takie podejÅ›cie.Modularyzacja w ES6W ramach standardu ES6 wprowadzono pojÄ™cie moduÅ‚u oraz standardowego sposobu wyraÅ¼ania zaleÅ¼noÅ›ci za pomocÄ… polecenia import.Za moduÅ‚ przyjmuje siÄ™ pojedyczny plik. Wszystkie elementy w nim zdefiniowane sÄ… jego wÅ‚asnoÅ›ciÄ… i nie zabrudzajÄ… globalnej przestrzeni aplikacji. Elementy, ktÃ³re chcemy udostÄ™pniÄ‡ innym moduÅ‚om naleÅ¼y jawnie wskazaÄ‡ przez oznaczenie ich poleceniem export. Wyeksportowane elementy moÅ¼emy importowaÄ‡ i uÅ¼ywaÄ‡ w moduÅ‚ach zaleÅ¼nych poleceniem import.PrzykÅ‚adowo, moÅ¼emy zdefiniowaÄ‡ zaleÅ¼noÅ›Ä‡ pomiÄ™dzy moduÅ‚ami:service.tsexport class Service {}component.tsimport {Service} from &#39;./service&#39;;export class Component {\tprivate service: Service;}Problemy z importowaniem zaleÅ¼noÅ›ciStandardowo importowane moduÅ‚y sÄ… wyszukiwane wzglÄ™dem importujÄ…cego pliku. W przypadku nietrywialnej struktury moÅ¼e to doprowadziÄ‡ do pogroszenia czytelnoÅ›ci aplikacji.WyobraÅºmy sobie strukturÄ™ kodu:src  \\- user    \\- details      user-details.component.ts  \\- authentication    \\- authentication.service.tsWÃ³wczas zawartoÅ›Ä‡ pliku user-details.component.ts mogÅ‚aby wyglÄ…daÄ‡:component.tsimport {AuthenticationService} from &#39;../../authentication/authentication.service&#39;;export class UserDetailsService {\tprivate service: AuthenticationService;}Utrzymywanie wzglÄ™dnych Å›cieÅ¼ek importowanych moduÅ‚Ã³w jest trudne. CzytelnoÅ›Ä‡ istniejÄ…cych importÃ³w jest wÄ…tpliwa, a dopisywanie nowych niewygodne. RozwiÄ…zaniem tego problemu moÅ¼e byÄ‡ stosowanie absolutnych Å›cieÅ¼ek do moduÅ‚Ã³w, liczonych wzglÄ™dem gÅ‚Ã³wnego katalogu ze ÅºrÃ³dÅ‚ami. Przy takim podejÅ›ciu dopisywanie nowych importÃ³w jest proste (widzÄ…c strukturÄ™ aplikacji), a czytajÄ…c jesteÅ›my w stanie szybko siÄ™ zorientowaÄ‡ jakie zaleÅ¼noÅ›ci wÅ‚aÅ›ciwie wciÄ…gamy.UÅ¼ycie absolutnych Å›cieÅ¼ek zaleÅ¼noÅ›ciNa szczÄ™Å›cie zalecane podejÅ›cie do pisania aplikacji w Angular 2 zakÅ‚ada stosowanie kompilatora TypeScript, a ten od dÅ‚uÅ¼szego czasu wspiera stosowanie absolutnych Å›cieÅ¼ek przy importowaniu zaleÅ¼noÅ›ci. Dodatkowo, rÃ³wnieÅ¼ Angular CLI prawidÅ‚owo obsluguje bundlowanie zasobÃ³w zbudowanych z wykorzystaniem absolutnych Å›cieÅ¼ek.W tym celu naleÅ¼y zmodyfikowaÄ‡ plik konfiguracyjny kompilatora TypeScript. W pliku tsconfig.json dopisujemy atrybut baseUrl: â€œ.â€{  &quot;compilerOptions&quot;: {    &quot;baseUrl&quot;: &quot;.&quot;  }}Od teraz moÅ¼emy we wszystkich miejscach importowaÄ‡ zaleÅ¼noÅ›ci podajÄ…c ich absolutne Å›cieÅ¼ki:import {AuthenticationService} from &#39;authentication/authentication.service&#39;;export class UserDetailsService {\tprivate service: AuthenticationService;}PodsumowanieWprowdzenie modularyzacji do standardu ES6 to ogromny krok w stronÄ™ poprawy jakoÅ›ci aplikacji. Jednak podawanie wzglÄ™dnych Å›cieÅ¼ek do zaleÅ¼noÅ›ci moÅ¼e szybko doprowadziÄ‡ do pogorszenia czytelnoÅ›ci kodu i przyprawiÄ‡ niejednego programistÄ™ o bÃ³l gÅ‚owy. Na szczÄ™Å›ciÄ™ kompilator TypeScript pozawala definiowaÄ‡ zaleÅ¼noÅ›ci wskazujÄ…c absolutne Å›cieÅ¼ki - wystarczy za pomocÄ… atrybutu baseUrl kompilatora zdefiniowaÄ‡ katalog, wzglÄ™dem ktÃ³rego chcemy wyszukiwaÄ‡ plikÃ³w do importowania.  Wsparcie dla absolutnych importÃ³w w kompilatorze TypeScript  Wsparcie dla konfiguracji baseUrl w Angular CLI",
"url": "/2017/02/17/absolutne-importowanie-zaleznosci-w-angular-cli.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2017-02-17-absolutne-importowanie-zaleznosci-w-angular-cli/angular-cli.jpg",
"date": "17-02-2017",
"path": "pl/2017-02-17-absolutne-importowanie-zaleznosci-w-angular-cli"
}
,


"2017-02-03-dynamiczne-dodawanie-komponentow-w-angular-2-html": {
"title": "Dynamiczne dodawanie komponentÃ³w w Angular 2",
"lang": "pl",
"tags": "angular",
"content": "Od pewnego czasu pracujÄ™ nad Å›wieÅ¼ym projektem opartym o Angular 2. CzÄ™Å›ciÄ… projektu jest prezentowanie uÅ¼ytkownikowi dynamicznie generowanych elementÃ³w interfejsu. Nie jesteÅ›my w stanie zaprojektowaÄ‡ z wyprzedzeniem ekranÃ³w, nie znajÄ…c ani ich struktury, ani konkretnych kontrolek.Standardowo aplikacjÄ™ budujemy korzystajÄ…c z komponentÃ³w uÅ¼ywajÄ…cych komponentÃ³w, ktÃ³re uÅ¼ywajÄ… komponentÃ³w, i tak dalejâ€¦ Komponenty okreÅ›lajÄ… selektory, ktÃ³rymi moÅ¼emy je osadzaÄ‡ oraz szablony HTML opisujÄ…ce sposÃ³b prezentacji. KorzystajÄ…c z tego zestawu, w kolejnych szablonach osadzamy kolejne komponenty wykorzystujÄ…c ich selektory, zupeÅ‚nie jakby byÅ‚y to natywne elementy HTMLa.Co jednak, jeÅ¼eli nie jesteÅ›my w stanie ustaliÄ‡ konkretnego komponentu na etapie pisania aplikacji, a dopiero w trakcie jej wykonania? Musimy wymyÅ›liÄ‡ coÅ› kreatywnego :wink:Szybkie rozwiÄ…zaniePierwsze, co moÅ¼e nam przyjÅ›Ä‡ do gÅ‚owy, to wykorzystanie ngIf i opisanie widoku w formie frontendowego switchâ€™a.SpÃ³jrzmy na przykÅ‚ad:@Component({    selector: &#39;app&#39;,    template: `        &amp;lt;div&amp;gt;            &amp;lt;book-details  *ngIf=&quot;model.type === &#39;book&#39;&quot;&amp;gt;&amp;lt;/book-details&amp;gt;            &amp;lt;movie-details *ngIf=&quot;model.type === &#39;movie&#39;&quot;&amp;gt;&amp;lt;/movie-details&amp;gt;            &amp;lt;comic-details *ngIf=&quot;model.type === &#39;comic&#39;&quot;&amp;gt;&amp;lt;/comic-details&amp;gt;        &amp;lt;/div&amp;gt;    `})class AppComponent {}Na pierwszy rzut oka wszystko wyglÄ…da nieÅºle - w zaleÅ¼noÅ›ci od typu prezentowanego obiektu potrafimy wyÅ›wietliÄ‡ odpowiedni komponent prezentujÄ…cy szczegÃ³Å‚y. Nawet jesteÅ›my z siebie zadowoleni, w koÅ„cu mamy komponenty, a przecieÅ¼ mogliÅ›my zaszyÄ‡ prezentacjÄ™ typÃ³w bezpoÅ›rednio w szablonie :wink:SpÃ³jrzmy jednak krytycznie na nasz twÃ³r, a zauwaÅ¼ymy potencjalne problemy.Po pierwsze, dodanie nowego typu komponentu za kaÅ¼dym razem wiÄ…Å¼e siÄ™ z modyfikacjÄ… wszystkich szablonÃ³w komponentÃ³w zaleÅ¼nych. DodajÄ…c nowÄ… funkcjonalnoÅ›Ä‡ do systemu, bÄ™dziemy musieli zmieniÄ‡ wiele, teoretycznie niezaleÅ¼nych, fragmentÃ³w kodu. W praktyce, podÄ…Å¼ajÄ…c tÄ… drogÄ…, szybko dotrzemy do wzorca Copyâ€™ego i Pasteâ€™a. StÄ…d juÅ¼ blisko, Å¼eby trafiÄ‡ na projektowy wall of shame za klasyczny Shotgun surgery.Kolejny, byÄ‡ moÅ¼e nawet bardziej narzucajÄ…cy siÄ™ problem, to wypÅ‚yniÄ™cie warstwy logiki do warstwy prezentacji. Mieszanie logiki z prezentacjÄ… to nigdy nie jest dobry pomysÅ‚. W szczegÃ³lnoÅ›ci w Å›wiecie frontendu, gdzie szukanie referencji czy refaktoryzacja pomiÄ™dzy HTMLem a JS/TSem to zawsze loteria.Lepsze podejÅ›cieA co gdybyÅ›my mogli przenieÅ›Ä‡ logikÄ™ wyboru komponentu do klasy? I dodatkowo wskazaÄ‡ w szablonie, gdzie komponent ma zostac wyrenderowany? Nadal nie tracÄ…c niczego z komponentowego podejÅ›cia, w tym wstrzykiwania zaleÅ¼noÅ›ci? DokÅ‚adnie tak moÅ¼emy to zrobiÄ‡ :wink:Przygotowanie szablonu widokuW pierwszym kroku przerobimy szablon komponentu:@Component({    selector: &#39;app&#39;,    template: `        &amp;lt;div&amp;gt;            &amp;lt;div #details&amp;gt;&amp;lt;/div&amp;gt;        &amp;lt;/div&amp;gt;    `})class AppComponent {}Dotychczasowe definicje konkretnych komponentÃ³w zastÄ™pujemy pojedynczym divâ€™em peÅ‚niÄ…cym funkcjÄ™ placeholdera. Dodatowo oznaczamy go jako zmiennÄ… lokalnÄ… o nazwie details. DziÄ™ki temu w kolejnym kroku bÄ™dziemy mogli odnieÅ›Ä‡ siÄ™ do niego z kontrolera komponentu.@Component(...)class AppComponent {    @ViewChild(&#39;details&#39;, {read: ViewContainerRef})    private placeholder: ViewContainerRef;}StosujÄ…c dekorator @ViewChild wstrzykujemy element DOMu do kontrolera komponentu. Pierwszy parametr moÅ¼e przyjÄ…Ä‡ klasÄ™ oczekiwanego elementu lub selektor. Dodatkowo przekazujemy, jakiej klasy element nas interesuje. W przypadku wstrzykiwania po selektorze standardowo jest to obiekt klasy ElementRef, nas jednak interesuje obiekt typu ViewContainerRef.Tworzenie komponentÃ³w w locieKlasa ViewContainerRef jest o tyle ciekawa, Å¼e dostarcza metodÄ™ pozwalajÄ…cÄ… tworzyÄ‡ komponenty w locie na podstawie dostarczonej fabryki:createComponent(\tcomponentFactory: ComponentFactory&amp;lt;C&amp;gt;,    index?: number,    injector?: Injector,    projectableNodes?: any[][]) : ComponentRef&amp;lt;C&amp;gt;Zmienna oznaczona dekoratorem @ViewChild zostanie uzupeÅ‚niona w trakcie tworzenia widoku - to znaczy, Å¼e moÅ¼emy siÄ™ niÄ… posÅ‚ugiwaÄ‡ dopiero w fazie ngAfterViewInit. W efekcie moÅ¼emy napisaÄ‡ kolejny kawaÅ‚ek naszego komponentu:@Component(...)class AppComponent implements AfterViewInit {    @ViewChild(&#39;details&#39;, {read: ViewContainerRef})    private placeholder: ViewContainerRef;    private componentRef: ComponentRef&amp;lt;any&amp;gt;;    ngAfterViewInit():void {        this.componentRef = this.placeholder.createComponent(this.componentFactory);    }}Pobieranie fabryki komponentÃ³wTeraz pozostaje nam juÅ¼ tylko uzyskanie fabryki komponentÃ³w. GotowÄ… do dziaÅ‚ania fabrykÄ™ najlepiej uzyskaÄ‡ z obiektu ComponentFactoryResolver. Sam komponent moÅ¼emy bez problemu wstrzyknÄ…Ä‡ z kontekstu DI, a nastÄ™pnie wywoÅ‚aÄ‡ na nim metodÄ™ resolveComponentFactory, podajÄ…c interesujÄ…cÄ… nas klasÄ™ komponentu.@Component(...)class AppComponent implements OnInit {    private componentFactory: ComponentFactory&amp;lt;any&amp;gt;;    constructor(private componentFactoryResolver: ComponentFactoryResolver) {    }    ngOnInit():void {        this.componentFactory = this.componentFactoryResolver.resolveComponentFactory(this.componentClass);    }}W ten sposÃ³b moÅ¼liwe jest stworzenie dowolnego komponentu osiÄ…galnego z kontekstu DI aplikacji.SprzÄ…tanie po komponenciePrzy rÄ™cznym tworzeniu komponentÃ³w warto teÅ¼ pamiÄ™taÄ‡ o poprawnym zamkniÄ™ciu utworzonych obiektÃ³w. W tym celu moÅ¼emy wykorzystaÄ‡ fazÄ™ ngOnDestroy cyklu Å¼ycia komponentu.@Component(...)class AppComponent implements OnDestroy {    private componentRef: ComponentRef&amp;lt;any&amp;gt;;    ngOnDestroy(): void {        this.componentRef.destroy();    }}Definiowanie dynamicznych komponentÃ³w w kontekÅ›cie DIKolejna rzecz, o ktÃ³rej musimy pamiÄ™taÄ‡, to odpowiednie oznaczenie komponentÃ³w tworzonych dynamicznie na poziomie definicji kontekstu DI. Standardowo Angular generuje kod jedynie dla tych komponentÃ³w, dla ktÃ³rych zostaÅ‚y zdefiniowane referencje w kodzie. Takie referencje sÄ… tworzone automatycznie dla komponentÃ³w uÅ¼ytych w ramach metody bootstrap, w routingu, czy teÅ¼ po uÅ¼yciu w szablonach widokÃ³w. Wszystkie pozostaÅ‚e komponenty, nawet jeÅ¼eli zostaÅ‚y zdefiniowane w sekcji declarations, zostanÄ… pominiÄ™te - dziÄ™ki temu mechanizm tree shaking bÄ™dzie miaÅ‚ moÅ¼liwoÅ›Ä‡ pominÄ…Ä‡ je przy budowaniu produkcyjnej wersji kodu. Komponenty dodawane dynamicznie musimy sami wskazaÄ‡ jawnie, na poziomie definicji moduÅ‚u. W tym celu uÅ¼ywamy pola entryComponents dekoratora @NgModule.@NgModule({    imports: [...],    declarations: [BookDetails, MovieDetails, ComicDetails],    exports: [...],    entryComponents: [BookDetails, MovieDetails, ComicDetails]})export class ItemDetailsModule {}Przekazywanie wartoÅ›ci do i z dynamicznego komponentuOstatniÄ… rzeczÄ…, na ktÃ³rÄ… warto zwrÃ³ciÄ‡ uwagÄ™, jest przekazywanie wartoÅ›ci do i z komponentu. W przypadku rÄ™cznego dodawania komponentÃ³w do DOM nie moÅ¼emy skorzystaÄ‡ ze standardowego przekazywania wartoÅ›ci przez dekoratory @Input() i @Output(). KomunikacjÄ™ z komponentem musimy oprogramowaÄ‡ rÄ™cznie. Jednak nie jest to trudne, bo obiekt ComponentRef zawiera referencjÄ™ na faktycznÄ… instancjÄ™ stworzonego komponentu. WykorzystujÄ…c jÄ… moÅ¼emy zarÃ³wno ustawiÄ‡ wartoÅ›ci, jak i nasÅ‚uchiwaÄ‡ na zmiany.@Component(...)class AppComponent implements AfterViewInit {    private componentRef: ComponentRef&amp;lt;any&amp;gt;;    ngAfterViewInit():void {        this.componentRef = this.placeholder.createComponent(this.componentFactory);        this.componentRef.instance.inputVal = &#39;Hello world&#39;;        this.componentRef.instance.outputVal.subscribe((...) =&amp;gt; { ... });    }}Kompletny przykÅ‚adNa koniec kompletny kod ÅºrÃ³dÅ‚owy omawianego przykÅ‚adu.Komponent wrappera kontrolekimport {    Component, Input, OnInit, ViewContainerRef, ViewChild, ComponentFactoryResolver, Type, AfterViewInit,    OnDestroy, ComponentRef} from &#39;@angular/core&#39;;@Component({    selector: &#39;control-wrapper&#39;,    template: `        &amp;lt;div *ngIf=&quot;componentClass&quot;&amp;gt;            &amp;lt;div #componentHolder&amp;gt;&amp;lt;/div&amp;gt;        &amp;lt;/div&amp;gt;    `})export class ControlWrapper implements OnInit, AfterViewInit, OnDestroy {    private model: any;    @Input()    private controlFactory: IControlFactory;    @ViewChild(&#39;componentHolder&#39;, {read: ViewContainerRef})    private componentHolder: ViewContainerRef;    private componentClass: Type&amp;lt;IControl&amp;gt;;    private componentRef: ComponentRef&amp;lt;IControl&amp;gt;;    constructor(private componentFactoryResolver: ComponentFactoryResolver) {    }    ngOnInit(): void {        this.componentClass = this.controlFactory.getControlClass(this.model.type);    }    ngOnDestroy(): void {        if (this.componentRef) {            this.componentRef.destroy();        }    }    ngAfterViewInit(): void {        if (this.componentClass &amp;amp;&amp;amp; this.componentHolder) {            let componentFactory = this.componentFactoryResolver.resolveComponentFactory(this.componentClass);            this.componentRef = this.componentHolder.createComponent(componentFactory);            this.updateControlModel();        }    }    private updateControlModel() {        this.componentRef.instance.setModel(this.model);    }}PrzykÅ‚adowa fabryka klas komponentÃ³w na podstawie modeluexport class ItemDetailsControlFactory implements IControlFactory {    getControlClass(type: string): Type&amp;lt;IControlFactory&amp;gt; {        if (type === &#39;movie&#39;) {            return BookDetails;        } else if (type === &#39;book&#39;) {            return MovieDetails;        } else if (type === &#39;comic&#39;) {            return ComicDetails;        } else {            return null;        }    }}Definicja moduÅ‚u dynamicznych komponentÃ³wimport {NgModule} from &#39;@angular/core&#39;;@NgModule({    imports: [...],    declarations: [BookDetails, MovieDetails, ComicDetails],    exports: [BookDetails, MovieDetails, ComicDetails],    entryComponents: [BookDetails, MovieDetails, ComicDetails]})export class ItemDetailsModule {}tl;drWykorzystujÄ…c najnowszÄ… wersjÄ™ frameworka Angular 2 moÅ¼emy bez problemu tworzyÄ‡ elementy interfejsu w locie, w trakcie dziaÅ‚ania aplikacji. Serwis ComponentFactoryResolver i adnotacja @ViewChild pozwalajÄ… programowo tworzyÄ‡ i dodawaÄ‡ komponenty do drzewa DOM, bez potrzeby zmieniania szablonÃ³w HTML komponentÃ³w.Å¹rÃ³dÅ‚a  Komunikacja pomiÄ™dzy komponentami, w tym oznaczanie jako zmienne lokalne i odwoÅ‚ania z kontrolerÃ³w.  Dokumentacja dekoratora @ViewChild  Dokumentacja klasy ViewContainerRef  Cykl Å¼ycia komponentu  FAQ na temat koniecznoÅ›ci uÅ¼ywania entryComponents",
"url": "/2017/02/03/dynamiczne-dodawanie-komponentow-w-angular-2.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2017-02-03-dynamiczne-dodawanie-komponentow-w-angular-2/angular-2.jpg",
"date": "03-02-2017",
"path": "pl/2017-02-03-dynamiczne-dodawanie-komponentow-w-angular-2"
}
,


"2017-01-19-wireshark-czy-to-gryzie-html": {
"title": "Wireshark - czy to gryzie?",
"lang": "pl",
"tags": "wireshark networks",
"content": "Z programem Wireshark pierwszy raz zetknÄ…Å‚em siÄ™ w czasie studiÃ³w na zajÄ™ciach z sieci komputerowych (dla niewtajemniczonych: Wireshark to aplikacja ktÃ³ra umoÅ¼liwia przechwytywanie i nagrywanie pakietÃ³w danych, a takÅ¼e ich dekodowanie i analizowanie). WÃ³wczas odniosÅ‚em wraÅ¼enie Å¼e jest to narzÄ™dzie stricte dla administratorÃ³w sieci i nie ma wiÄ™kszego zastosowania w obszarze wytwarzania i utrzymywania oprogramowania.Z upÅ‚ywem czasu zrozumiaÅ‚em Å¼e tworzenie systemÃ³w to nie tylko pisanie piÄ™knego i czystego kodu, ale takÅ¼e dÅ‚ugie godziny spÄ™dzone na debugowaniu bÅ‚Ä™dÃ³w i analizowaniu problemÃ³w. W wielu sytuacjach kluczowa jest moÅ¼liwoÅ›Ä‡ podejrzenia komunikatÃ³w przesyÅ‚anych miÄ™dzy elementami systemu. Do tego wÅ‚aÅ›nie Å›wietnie sprawdziÅ‚o siÄ™ narzÄ™dzie poznane na studiach.PoniÅ¼ej pokaÅ¼Ä™ przykÅ‚adowe sytuacje w ktÃ³rych wykorzystaÅ‚em Wiresharka, Å¼eby dotrzeÄ‡ do sedna analizowanego problemu.â€œDlaczego serwisy siÄ™ nie dogadujÄ…?â€JakiÅ› czas temu pracowaÅ‚em przy utrzymaniu systemu zrealizowanego w architekturze rozproszonej, ktÃ³rego moduÅ‚y komunikowaÅ‚y siÄ™ za pomocÄ… RESTa. Niestety logi aplikacyjne nie zawsze byÅ‚y wystarczajÄ…co szczegÃ³Å‚owe. W pewnym przypadku dostawaliÅ›my w logach wpisy postaci:12:33:52.823 [main] DEBUG org.springframework.web.client.RestTemplate - GET request for &quot;http://172.19.57.4:8080/fin2/acc/balance?accNum=93%201090%200088%205180%205697%201019%203200&quot; resulted in 500 (null); invoking error handlerException in thread &quot;main&quot; org.springframework.web.client.HttpServerErrorException: 500 null    at org.springframework.web.client.DefaultResponseErrorHandler.handleError(DefaultResponseErrorHandler.java:94)    at org.springframework.web.client.RestTemplate.handleResponse(RestTemplate.java:667)    at org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:620)    at org.springframework.web.client.RestTemplate.execute(RestTemplate.java:580)    at org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:287)    at com.brdg.fin2.acc.AccClient.getBalance(AccClient.java:175)Same logi niewiele mÃ³wiÅ‚y, poza tym Å¼e serwer nie radzi sobie z obsÅ‚ugÄ… Å¼Ä…dania. Serwer raportowaÅ‚ konkretnÄ… przyczynÄ™ niepowodzenia w treÅ›ci odpowiedzi, jednak ta nie byÅ‚a logowana na kliencie. W takiej sytuacji analiza Wiresharkiem pozwoliÅ‚a szybko ustaliÄ‡ co faktycznie byÅ‚o nie tak:GET /fin2/acc/balance?accNum=93%201090%200088%205180%205697%201019%203200 HTTP/1.1Accept: text/plain, application/json, application/*+json, */*User-Agent: Java/1.8.0_111Host: 172.19.57.4:8080Connection: keep-aliveHTTP/1.1 500X-Application-Context: application:8080Content-Type: application/json;charset=UTF-8Transfer-Encoding: chunkedConnection: closeb5{&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;exception&quot;:&quot;java.lang.NumberFormatException&quot;,&quot;message&quot;:&quot;For input string: \\&quot;93 10\\&quot;&quot;,&quot;path&quot;:&quot;/fin2/acc/balance&quot;}0W tym przypadku usuniÄ™cie spacji z numeru rachunku pozwoliÅ‚o wyeliminowaÄ‡ problem.â€œPrzecieÅ¼ podajÄ™ ten parametr, o tu!â€Zdarza siÄ™, Å¼e pisanie nowego kodu idzie gÅ‚adko, aÅ¼ napotykamy na sytuacjÄ™, w ktÃ³rej wydaje nam siÄ™ Å¼e wszystko dobrze zakodowaliÅ›my, a jednak serwer twierdzi Å¼e wysyÅ‚ane przez nas Å¼Ä…danie jest niepoprawne. PrzykÅ‚ad kodu klienta RESTowej usÅ‚ugi, ktÃ³ry wydawaÅ‚ mi siÄ™ poprawny:WebTarget webTarget = createWebTarget();webTarget.queryParam(&quot;statementNo&quot;, statementNumber);Response response = webTarget.request().get();A jednak serwer uporczywie twierdziÅ‚ Å¼e:Required String parameter &#39;statementNo&#39; is not present.WyglÄ…daÅ‚o jakby serwer nie potrafiÅ‚ odczytaÄ‡ wysyÅ‚anego przeze mnie parametru. Zanim jednak zaczÄ…Å‚em obwiniaÄ‡ stronÄ™ serwerowÄ…, postanowiÅ‚em upewniÄ‡ siÄ™ Å¼e Å¼Ä…danie HTTP w istocie jest poprawne. Szybka analiza Wiresharkiem pokazaÅ‚a:GET /crwr/statement HTTP/1.1User-Agent: Jersey/2.23.2 (HttpUrlConnection 1.8.0_79)Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2Connection: keep-aliveHTTP/1.1 400...Chwila, a gdzie mÃ³j parametr? MajÄ…c pewnoÅ›Ä‡, Å¼e problem leÅ¼y jednak po stronie klienckiej, zaczÄ…Å‚em wnikliwiej analizowaÄ‡ kod linijka po linijce (tym razem czytajÄ…c javadoki JAX-RS :) ) :/*** Create a new {@code WebTarget} instance by configuring a query parameter on the URI* of the current target instance.* ...* @return a new target instance.* ...*/public WebTarget queryParam(String name, Object... values);No cÃ³Å¼, przynajmniej mam teraz o czym pisaÄ‡ na blogu ;). Ten klient dziaÅ‚aÅ‚ zdecydowanie lepiej:WebTarget webTarget = createWebTarget();Response response = webTarget.queryParam(&quot;statementNo&quot;, statementNumber).webTarget.request().get();Jak zaczÄ…Ä‡ z Wiresharkiem?Podobnych przykÅ‚adÃ³w mÃ³gÅ‚bym przywoÅ‚aÄ‡ wiÄ™cej, a kaÅ¼dy z nich utwierdza mnie w przekonaniu Å¼e warto nauczyÄ‡ siÄ™ korzystaÄ‡ z Wiresharka. Tym bardziej Å¼e jest to narzÄ™dzie niezaleÅ¼ne od zastosowanego stosu technologicznego, wiÄ™c jego znajomoÅ›Ä‡ moÅ¼e przydaÄ‡ siÄ™ w rÃ³Å¼nych projektach.Instalacja na Ubuntu sprowadza siÄ™ do wykonania standardowych poleceÅ„:sudo apt-add-repository universesudo apt-get updatesudo apt-get install wiresharkDodatkowo Wireshark uÅ¼ywa biblioteki dumpcap, ktÃ³ra musi dostaÄ‡ uprawnienia do dziaÅ‚ania na uÅ¼ytkowniku root. Sprawdzamy jej lokalizacjÄ™:sudo which dumpcapa nastÄ™pnie:sudo chmod 4711 [lokalizacja]Po uruchomieniu Wiresharka wybieramy opcjÄ™ â€œCapture/Optionsâ€, a nastÄ™pnie interfejs sieciowy, na ktÃ³rym chcemy nasÅ‚uchiwaÄ‡ - w wiÄ™kszoÅ›ci przypadkÃ³w najwygodniej jest wybraÄ‡ opcjÄ™ â€œanyâ€, czyli nasÅ‚uchiwaÄ‡ na wszystkich interfejsach sieciowych. NastÄ™pnie wpisujemy filtr przechwytywania okreÅ›lajÄ…cy jaki ruch sieciowy nas interesuje. CzÄ™sto wystarczy ograniczyÄ‡ przechwytywanie do okreÅ›lonego portu, na ktÃ³rym chcemy obejrzeÄ‡ Å¼Ä…dania:Pozostaje juÅ¼ tylko uruchomiÄ‡ przechwytywanie i wykonaÄ‡ akcjÄ™ ktÃ³rÄ… chcemy przeanalizowaÄ‡. W oknie Wiresharka powinniÅ›my zobaczyÄ‡ zarejestrowany ruch sieciowy:AnalizujÄ…c komunikacjÄ™ HTTP najÅ‚atwiej jest wybraÄ‡ opcjÄ™ â€œFollow TCP Streamâ€, co pozwoli nam w przystÄ™pny sposÃ³b obejrzeÄ‡ nastÄ™pujÄ…ce po sobie Å¼Ä…dania i odpowiedzi na poziomie HTTP:KoÅ„cowe przemyÅ›lenia  PowyÅ¼ej przedstawiÅ‚em oczywiÅ›cie tylko podstawowe moÅ¼liwoÅ›ci uÅ¼ycia narzÄ™dzia (aczkolwiek pokrywajÄ…ce 80% moich deweloperskich potrzeb). Oferuje ono dodatkowo wiele zaawansowanych ficzerÃ³w, jak choÄ‡by zaawansowane filtrowanie na poziomie przechwytywania i wyÅ›wietlania, kolorowanie pakietÃ³w, czy statystyki sieci.  Wireshark nie zawsze moÅ¼e byÄ‡ wykorzystany bezpoÅ›rednio na danym hoÅ›cie, bo np. ten nie posiada graficznego interfejsu, co najczÄ™Å›ciej ma miejsce w Å›rodowisku serwerowym. WÃ³wczas moÅ¼na posiÅ‚kowaÄ‡ siÄ™ narzÄ™dziem tcpdump, ktÃ³rym moÅ¼emy zarejestrowaÄ‡ ruch sieciowy do pliku na docelowym Å›rodowisku, a nastÄ™pnie plik ten wczytaÄ‡ do analizy w programie Wireshark.  Istnieje wiele innych narzÄ™dzi potrafiÄ…cych rejestrowaÄ‡ ruch HTTP, m.in. Fiddler czy Live HTTP Headers. Wydaje siÄ™ jednak Å¼e Wireshark jest bardziej wszechstronny i jego znajomoÅ›Ä‡ moÅ¼na wykorzystaÄ‡ rÃ³wnieÅ¼ w innych poza HTTP obszarach, np. dlaczego mÃ³j klient LDAP nie dziaÅ‚a, a inny tak?  UÅ¼ywajÄ…c Wireshark/tcpdump moÅ¼emy analizowaÄ‡ ruch nie tylko na hoÅ›cie gdzie mamy uruchomione to narzÄ™dzie. Poprzez rÃ³Å¼ne techniki, takie jak port mirroring czy ARP poisoning, moÅ¼emy podsÅ‚uchiwaÄ‡ pakiety nie przechodzÄ…ce bezpoÅ›rednio przez naszego hosta.",
"url": "/2017/01/19/wireshark-czy-to-gryzie.html",
"author": "Tomasz Lewandowski",
"authorUrl": "/authors/tlewandowski.html",
"image": "tlewandowski.jpg",
"highlight": "/assets/img/posts/2017-01-19-wireshark-czy-to-gryzie/wireshark.jpeg",
"date": "19-01-2017",
"path": "pl/2017-01-19-wireshark-czy-to-gryzie"
}
,


"2017-01-05-budowanie-aplikacji-angular-cli-spring-boot-html": {
"title": "Budowanie aplikacji Angular CLI + Spring Boot",
"lang": "pl",
"tags": "angular spring boot",
"content": "KaÅ¼da nietrywialna aplikacja potrzebuje backendu. O ile obecnie to nie jest prawda, to na potrzeby tego artykuÅ‚u przyjmijmy, Å¼e tak jest. A jak backend wspÃ³Å‚pracujÄ…cy z aplikacjÄ… webowÄ… to REST, a jak REST to Spring i Spring Boot. W kilku kolejnych akapitach stworzymy i z sukcesem przygotujemy gotowy do wdroÅ¼enia artefakt skÅ‚adajÄ…cy siÄ™ z aplikacji webowej w Angular 2 i backendu usÅ‚ugowego wykorzystujÄ…cego Spring Boot.ArtykuÅ‚ zakÅ‚ada podstawowÄ… znajomoÅ›Ä‡ Angular CLI, Spring Boot i Maven.Wszystkie przedstawione kroki sÄ… commitami do testowego repozytorium, dziÄ™ki temu sam moÅ¼esz przeÅ›ledziÄ‡ proces tworzenia aplikacji oraz rozwiaÄ‡ wszelkie wÄ…tpliwoÅ›ci. Link do repozytorium: demo@github.Stworzenie minimalnego projektuNowy projekt najÅ‚atwiej stworzymy wykorzystujÄ…c Spring Initializer, moÅ¼emy to zrobiÄ‡ wchodzÄ…c http://start.spring.io/ i wyklikujÄ…c konfiguracjÄ™ projektu, lub moÅ¼emy to zrobiÄ‡ w stylu prawdziwego geeka - curlem.$ cd demo$ curl https://start.spring.io/starter.tgz \\  -d groupId=net.lipecki.demo \\  -d packageName=net.lipecki.demo \\  -d artifactId=demo \\  -d dependencies=web \\  | tar -xzvf -  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed100 50190  100 50104  100    86  54925     94 --:--:-- --:--:-- --:--:-- 54878x mvnwx .mvn/x .mvn/wrapper/x src/x src/main/x src/main/java/x src/main/java/net/x src/main/java/net/lipecki/x src/main/java/net/lipecki/demo/x src/main/resources/x src/main/resources/static/x src/main/resources/templates/x src/test/x src/test/java/x src/test/java/net/x src/test/java/net/lipecki/x src/test/java/net/lipecki/demo/x .gitignorex .mvn/wrapper/maven-wrapper.jarx .mvn/wrapper/maven-wrapper.propertiesx mvnw.cmdx pom.xmlx src/main/java/net/lipecki/demo/DemoApplication.javax src/main/resources/application.propertiesx src/test/java/net/lipecki/demo/DemoApplicationTests.javaW efekcie dostajemy minimalnÄ… aplikacjÄ™ Spring Boot, ktÃ³rÄ… moÅ¼emy zbudowaÄ‡ i uruchomiÄ‡. Do testÃ³w dorzuÄ‡my prosty kontroler.$ curl -L https://goo.gl/MbWM8s -o src/main/java/net/lipecki/demo/GreetingRestController.java$ cat src/main/java/net/lipecki/demo/GreetingRestController.javapackage net.lipecki.demo;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;@RestControllerpublic class GreetingRestController {\t@RequestMapping(&quot;/greeting&quot;)\tpublic String greeting() {\t\treturn &quot;Welcome!&quot;;\t}}CaÅ‚oÅ›Ä‡ moÅ¼emy zbudowaÄ‡ wykorzystujÄ…c Maven. W zaleÅ¼noÅ›ci od preferencji moÅ¼emy zbudowaÄ‡ aplikacjÄ™ wykorzystujÄ…c globalnie zainstalowanÄ… w systemie instancjÄ™ lub skorzystaÄ‡ z dostarczanego ze szkieletem Maven Wrappera. Stosowanie Wrappera pozwala pracowaÄ‡ z aplikacjÄ… nie zmieniajÄ…c zainstalowanych w systemie pakietÃ³w oraz zapewnia, Å¼e moÅ¼emy rÃ³Å¼ne projekty budowaÄ‡ rÃ³Å¼nymi wersjami Mavena. Wrapper w razie potrzeby Å›ciÄ…gnie odpowiedniÄ… wersjÄ™ bibliotek przy pierwszym uruchomieniu../mvnw clean package . . .[INFO] --- spring-boot-maven-plugin:1.4.2.RELEASE:repackage (default) @ demo ---[INFO] ------------------------------------------------------------------------[INFO] BUILD SUCCESS[INFO] ------------------------------------------------------------------------[INFO] Total time: 4.929 s[INFO] Finished at: 2016-12-07T20:43:32+01:00[INFO] Final Memory: 28M/325M[INFO] ------------------------------------------------------------------------uruchomiÄ‡$ java -jar target/demo-0.0.1-SNAPSHOT.jar . . .2016-12-07 20:44:13.392  INFO 70743 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)2016-12-07 20:44:13.397  INFO 70743 --- [           main] net.lipecki.demo.DemoApplication         : Started DemoApplication in 2.271 seconds (JVM running for 2.643)i przetestowaÄ‡$ curl http://localhost:8080/greeting &amp;amp;&amp;amp; echoWelcome!Docelowa struktura projektuW przypadku najprostszego podejÅ›cia wystarczajÄ…ce byÅ‚oby dorzucenie tylko kodÃ³w czÄ™Å›ci webowej do aktualnego szkieletu i zadbania o jego poprawne budowanie. Jednak dla nas wystarczajÄ…ce to za maÅ‚o, od razu przygotujemy strukturÄ™ ktÃ³ra bÄ™dzie miaÅ‚a szansÄ™ wytrzymaÄ‡ prÃ³bÄ™ czasu.Minimalny sensowny podziaÅ‚ to przygotowanie dwÃ³ch moduÅ‚Ã³w:  artefaktu wdroÅ¼eniowego z usÅ‚ugami REST,  aplikacji webowej.Taki podziaÅ‚ aplikacja pozwala nam na dodatkowÄ… separacjÄ™ czÄ™Å›ci backend i frontend (w pogoni za ideaÅ‚em moÅ¼emy przygotowaÄ‡ jeszcze ciekawszÄ… strukturÄ™, szczegÃ³Å‚y w jednym z ostatnich akapitÃ³w wpisu).W tym celu:  dodajemy do projektu dwa moduÅ‚y,          demo-app,      demo-web,        przenosimy dotychczasowÄ… konfiguracjÄ™ budowania i kody do demo-app.CaÅ‚oÅ›Ä‡ zmian moÅ¼emy zweryfikowaÄ‡ w commicie do testowego repozytorium GitHub: commit.Po tych zmianach, nadal moÅ¼emy budowaÄ‡ i uruchamiaÄ‡ aplikacjÄ™, jednak tym razem z poziomu moduÅ‚u demo-app.$ ./mvnw clean package . . .[INFO] Reactor Summary:[INFO][INFO] demo ............................................... SUCCESS [  0.141 s][INFO] demo-app ........................................... SUCCESS [  4.909 s][INFO] demo-web ........................................... SUCCESS [  0.002 s][INFO] ------------------------------------------------------------------------[INFO] BUILD SUCCESS[INFO] ------------------------------------------------------------------------[INFO] Total time: 5.329 s[INFO] Finished at: 2016-12-07T21:15:51+01:00[INFO] Final Memory: 30M/309M[INFO] ------------------------------------------------------------------------$ java -jar demo-app/target/demo-app-0.0.1-SNAPSHOT.jar . . .2016-12-07 21:16:30.569  INFO 71306 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)2016-12-07 21:16:30.574  INFO 71306 --- [           main] net.lipecki.demo.DemoApplication         : Started DemoApplication in 2.732 seconds (JVM running for 3.117)Dodanie i budownie czÄ™Å›ci webProjekt czÄ™Å›ci webowej najÅ‚atwiej stworzyÄ‡ z wykorzystaniem Angular CLI, w tym celu wykonujemy:$ pwd/tmp/demo/demo-web/$ rm -rf src$ ng init --style=scss . . .Installing packages for tooling via npm.Installed packages for tooling via npm.Standardowy Angular CLI bÄ™dzie budowaÅ‚ aplikacjÄ™ do folderu dist. Jednak konwencja budowania przez Maven zakÅ‚ada, Å¼e wszystkie zasoby, czy to poÅ›rednie, czy docelowe, wygenerowane w trakcie procesu budowania trafiÄ… do odpowiednich podfolderÃ³w katalogu target. Preferowanie konwencji ponad konfiguracjÄ™ to zawsze dobry pomysÅ‚. W tym celu zmieniamy standardowÄ… konfiguracjÄ™ folderu budowania z dist na target/webapp w angular-cli.json: commit.W tym momencie moÅ¼emy juÅ¼ swobodnie pracowaÄ‡ z aplikacjÄ… uruchamiajÄ…c jÄ… za pomocÄ… ng serve. Kolejnym krokiem bÄ™dzie zintegrowanie procesu budowania ng build z budowaniem moduÅ‚u Maven. W tym celu wykorzystamy plugin frontend-maven-plugin.Plugin frontend-maven-plugin pozwala:  zainstalowaÄ‡ niezaleÅ¼nÄ… od systemowej wersjÄ™ node i npm,  uruchomiÄ‡ instalacjÄ™ zaleÅ¼noÅ›ci npm,  uruchomiÄ‡ budowanie aplikacji za pomocÄ… ng.CaÅ‚oÅ›Ä‡ konfiguracji wprowadzamy definiujÄ…c dodatkowe elementy execution konfiguracji pluginu.Przed dodaniem konfiguracji poszczegÃ³lnych krokÃ³w dodajemy do sekcji build.plugins definicjÄ™ samego pluginu:&amp;lt;plugin&amp;gt;  &amp;lt;groupId&amp;gt;com.github.eirslett&amp;lt;/groupId&amp;gt;  &amp;lt;artifactId&amp;gt;frontend-maven-plugin&amp;lt;/artifactId&amp;gt;  &amp;lt;version&amp;gt;1.3&amp;lt;/version&amp;gt;  &amp;lt;configuration&amp;gt;    &amp;lt;installDirectory&amp;gt;target&amp;lt;/installDirectory&amp;gt;  &amp;lt;/configuration&amp;gt;  &amp;lt;executions&amp;gt;    &amp;lt;!-- tutaj bÄ™dÄ… konfiguracje krokÃ³w budowaia --&amp;gt;  &amp;lt;/executions&amp;gt;&amp;lt;/plugin&amp;gt;W pierwszym kroku instalujemy wskazanÄ… wersjÄ™ runtime node i menadÅ¼era pakietÃ³w npm. CaÅ‚oÅ›Ä‡ jest instalowana lokalnie w folderze target. DziÄ™ki lokalnej instalacji minimalizujemy listÄ™ wymagaÅ„ wstÄ™pnych do pracy z naszym projektem, co jest szczegÃ³lnie waÅ¼ne przy wykorzystaniu systemÃ³w CI/CD.&amp;lt;execution&amp;gt;  &amp;lt;id&amp;gt;install node and npm&amp;lt;/id&amp;gt;  &amp;lt;goals&amp;gt;    &amp;lt;goal&amp;gt;install-node-and-npm&amp;lt;/goal&amp;gt;  &amp;lt;/goals&amp;gt;  &amp;lt;configuration&amp;gt;    &amp;lt;nodeVersion&amp;gt;v6.9.1&amp;lt;/nodeVersion&amp;gt;  &amp;lt;/configuration&amp;gt;&amp;lt;/execution&amp;gt;W drugim kroku plugin za pomocÄ… npm instaluje wszystkie zdefiniowane w package.json zaleÅ¼noÅ›ci naszego projektu. Jest to odpowiednik wykonania npm install w katalogu gÅ‚Ã³wnym projektu.&amp;lt;execution&amp;gt;  &amp;lt;id&amp;gt;npm install&amp;lt;/id&amp;gt;  &amp;lt;goals&amp;gt;    &amp;lt;goal&amp;gt;npm&amp;lt;/goal&amp;gt;  &amp;lt;/goals&amp;gt;&amp;lt;/execution&amp;gt;Ostatni krok to wykonanie wÅ‚aÅ›ciwego procesu budowania aplikacji z wykorzystaniem Angular CLI.W celu uproszczenia konfiguracji dodajemy nowy task o nazwie build w pliku package.json. RÄ™czne zdefiniowanie taska jest o tyle waÅ¼ne, Å¼e w ten sposÃ³b bÄ™dziemy siÄ™ mogli uniezaleÅ¼niÄ‡ od systemowej instancji Angular CLI i stosowaÄ‡ lokalnÄ… wersjÄ™ zainstalowanÄ… na podstawie definicji w package.json.&quot;scripts&quot;: {  &quot;build&quot;: &quot;node node_modules/angular-cli/bin/ng build&quot;}Oraz dodajemy wykonanie nowo utworzonego tasku przez plugin.&amp;lt;execution&amp;gt;  &amp;lt;id&amp;gt;node build app&amp;lt;/id&amp;gt;  &amp;lt;phase&amp;gt;prepare-package&amp;lt;/phase&amp;gt;  &amp;lt;goals&amp;gt;    &amp;lt;goal&amp;gt;npm&amp;lt;/goal&amp;gt;  &amp;lt;/goals&amp;gt;  &amp;lt;configuration&amp;gt;    &amp;lt;arguments&amp;gt;run-script build&amp;lt;/arguments&amp;gt;  &amp;lt;/configuration&amp;gt;&amp;lt;/execution&amp;gt;  Nazwa tasku build jest czysto umowna, jedyne wymaganie to uÅ¼ywanie tej samej w package.json i pom.xml. Jednak trzymanie siÄ™ konkretnej konwencji, np. build, uÅ‚atwi pracÄ™ pomiÄ™dzy rÃ³Å¼nymi projektami.Tak przygotowana konfiguracja pozwala zintegrowaÄ‡ budowanie aplikacji web z fazami cyklu Å¼ycia Maven. Dodatkowo dostajemy uspÃ³jniony sposÃ³b uruchomienia za pomocÄ… polecenia npm build. DziÄ™ki wykorzystaniu frontend-maven-plugin uniezaleÅ¼niamy proces budowania od Å›rodowiska, wszystkie wymagane biblioteki (node, npm, angular-cli) sÄ… instalowane i wykonywane lokalnie w folderze projektu.CaÅ‚oÅ›Ä‡ zmian z tego kroku moÅ¼emy obejrzeÄ‡ w commicie GitHub: commit.SkÅ‚adanie artefaktu z czÄ™Å›ciÄ… webKolejnym krokiem jest umoÅ¼liwienie spakowania moduÅ‚u odpowiedzialnego za czÄ™Å›Ä‡ web do pojedynczego artefaktu, gotowego do wykorzystania jako zaleÅ¼noÅ›Ä‡ lub przesÅ‚ania do repozytorium artefaktÃ³w.Standardowo Maven obsÅ‚uguje najpopularniejsze typy artefaktÃ³w, np. jar, war, ear. Dla tych typÃ³w znany jest sposÃ³b ich budowania, struktura archiwÃ³w jest odgÃ³rnie ustalona i niezmienna pomiÄ™dzy projektami. Jednak my chcemy przygotowaÄ‡ archiwum w postaci pliku zip, wiÄ™c wykorzystujÄ…c maven-assembly-plugin bÄ™dziemy mogli sami okreÅ›liÄ‡ jakie pliki i w jaki sposÃ³b zbieraÄ‡ budujÄ…c wynikowy artefakt.Do pom.xml moduÅ‚u demo-web dodajemy definicjÄ™ maven-assembly-plugin zawierajÄ…cÄ… docelowÄ… nazwÄ™ artefaktu oraz plik assembly opisujÄ…cy sposÃ³b jego skÅ‚adania.W sekcji build.plugins dopisujemy:&amp;lt;plugin&amp;gt;  &amp;lt;groupId&amp;gt;org.apache.maven.plugins&amp;lt;/groupId&amp;gt;  &amp;lt;artifactId&amp;gt;maven-assembly-plugin&amp;lt;/artifactId&amp;gt;  &amp;lt;configuration&amp;gt;    &amp;lt;descriptor&amp;gt;assembly.xml&amp;lt;/descriptor&amp;gt;    &amp;lt;finalName&amp;gt;demo-web-${project.version}&amp;lt;/finalName&amp;gt;    &amp;lt;appendAssemblyId&amp;gt;false&amp;lt;/appendAssemblyId&amp;gt;  &amp;lt;/configuration&amp;gt;  &amp;lt;executions&amp;gt;    &amp;lt;execution&amp;gt;      &amp;lt;phase&amp;gt;package&amp;lt;/phase&amp;gt;      &amp;lt;goals&amp;gt;        &amp;lt;goal&amp;gt;single&amp;lt;/goal&amp;gt;      &amp;lt;/goals&amp;gt;    &amp;lt;/execution&amp;gt;  &amp;lt;/executions&amp;gt;&amp;lt;/plugin&amp;gt;NastÄ™pnie dodajemy plik assembly.xml (obok pliku pom.xml), w ktÃ³rym okreÅ›lamy docelowy format (zip) oraz ktÃ³re pliki, z ktÃ³rego katalogu spakowaÄ‡ do artefaktu (wszystkie z folder target/webapp).&amp;lt;assembly&amp;gt;  &amp;lt;id&amp;gt;zip&amp;lt;/id&amp;gt;  &amp;lt;formats&amp;gt;    &amp;lt;format&amp;gt;zip&amp;lt;/format&amp;gt;  &amp;lt;/formats&amp;gt;  &amp;lt;includeBaseDirectory&amp;gt;false&amp;lt;/includeBaseDirectory&amp;gt;  &amp;lt;fileSets&amp;gt;    &amp;lt;fileSet&amp;gt;      &amp;lt;directory&amp;gt;target/webapp&amp;lt;/directory&amp;gt;      &amp;lt;outputDirectory&amp;gt;&amp;lt;/outputDirectory&amp;gt;      &amp;lt;includes&amp;gt;        &amp;lt;include&amp;gt;**&amp;lt;/include&amp;gt;      &amp;lt;/includes&amp;gt;    &amp;lt;/fileSet&amp;gt;  &amp;lt;/fileSets&amp;gt;&amp;lt;/assembly&amp;gt;CaÅ‚oÅ›Ä‡ moÅ¼emy przetestowaÄ‡ wykonujÄ…c:$ pwd/tmp/demo$ ./mvnw clean package . . .$ ls demo-web/target/demo-web-0.0.1-SNAPSHOT.zipdemo-web/target/demo-web-0.0.1-SNAPSHOT.zipCommit zawierajÄ…cy zmiany: commit.SkÅ‚adanie artefaktu wdroÅ¼eniowegoOstatnie co musimy zrobiÄ‡ Å¼eby nasza aplikacja skÅ‚adaÅ‚a siÄ™ w pojedynczy wykonywalny artefakt to skonfigurowaÄ‡ moduÅ‚ demo-web jako zaleÅ¼noÅ›Ä‡ w projekcie demo-app oraz skonfigurowanie pluginu maven-dependency-plugin, ktÃ³ry bÄ™dzie odpowiadaÅ‚ za odpowiednie rozpakowanie zasobÃ³w.Definiujemy zaleÅ¼noÅ›Ä‡ na moduÅ‚ demo-web w pom.xml w sekcji dependencies:&amp;lt;dependency&amp;gt;  &amp;lt;groupId&amp;gt;net.lipecki.demo&amp;lt;/groupId&amp;gt;  &amp;lt;artifactId&amp;gt;demo-web&amp;lt;/artifactId&amp;gt;  &amp;lt;version&amp;gt;${project.version}&amp;lt;/version&amp;gt;  &amp;lt;type&amp;gt;zip&amp;lt;/type&amp;gt;&amp;lt;/dependency&amp;gt;  Standardowo Maven szuka zaleÅ¼noÅ›ci typu jar, jednak nasz moduÅ‚ web jest typu zip, co moÅ¼emy jawnie wskazaÄ‡ definiujÄ…c zaleÅ¼noÅ›Ä‡.Aplikacja Spring Boot poza serwowaniem zdefiniowany servletÃ³w i usÅ‚ug REST hostuje rÃ³wnieÅ¼ wszystkie zasoby, ktÃ³re znajdujÄ… siÄ™ na zdefiniowanych Å›cieÅ¼kach zasobÃ³w statycznych. W standardowej konfiguracji, jednÄ… z takich Å›cieÅ¼ek sÄ… zasoby wewnÄ…trz samego jara aplikacji. KorzystajÄ…c z tej wiedzy skonfigurujemy plugin maven-dependency-plugin w taki sposÃ³b, Å¼eby rozpakowywaÅ‚ archiwum moduÅ‚u web do odpowiedniego katalogu budowania.W sekcji build.plugins dodajemy:&amp;lt;plugin&amp;gt;  &amp;lt;groupId&amp;gt;org.apache.maven.plugins&amp;lt;/groupId&amp;gt;  &amp;lt;artifactId&amp;gt;maven-dependency-plugin&amp;lt;/artifactId&amp;gt;  &amp;lt;executions&amp;gt;    &amp;lt;execution&amp;gt;      &amp;lt;id&amp;gt;unpack&amp;lt;/id&amp;gt;      &amp;lt;phase&amp;gt;generate-resources&amp;lt;/phase&amp;gt;      &amp;lt;goals&amp;gt;        &amp;lt;goal&amp;gt;unpack&amp;lt;/goal&amp;gt;      &amp;lt;/goals&amp;gt;      &amp;lt;configuration&amp;gt;        &amp;lt;artifactItems&amp;gt;          &amp;lt;artifactItem&amp;gt;            &amp;lt;groupId&amp;gt;net.lipecki.demo&amp;lt;/groupId&amp;gt;            &amp;lt;artifactId&amp;gt;demo-web&amp;lt;/artifactId&amp;gt;            &amp;lt;version&amp;gt;${project.version}&amp;lt;/version&amp;gt;            &amp;lt;type&amp;gt;zip&amp;lt;/type&amp;gt;          &amp;lt;/artifactItem&amp;gt;        &amp;lt;/artifactItems&amp;gt;        &amp;lt;outputDirectory&amp;gt;${project.build.directory}/classes/resources&amp;lt;/outputDirectory&amp;gt;      &amp;lt;/configuration&amp;gt;    &amp;lt;/execution&amp;gt;  &amp;lt;/executions&amp;gt;&amp;lt;/plugin&amp;gt;W tym momencie mamy juÅ¼ kompletny proces budowania aplikacji. Po jego wykonaniu i uruchomieniu aplikacji moÅ¼emy zarÃ³wno wywoÅ‚aÄ‡ testowÄ… usÅ‚ugÄ™ REST, jak i obejrzeÄ‡ szkielet Angular 2.$ ./mvnw clean package . . .[INFO] ------------------------------------------------------------------------[INFO] Reactor Summary:[INFO][INFO] demo ............................................... SUCCESS [  0.120 s][INFO] demo-web ........................................... SUCCESS [ 18.459 s][INFO] demo-app ........................................... SUCCESS [  5.797 s][INFO] ------------------------------------------------------------------------[INFO] BUILD SUCCESS[INFO] ------------------------------------------------------------------------[INFO] Total time: 24.644 s[INFO] Finished at: 2016-12-07T22:06:14+01:00[INFO] Final Memory: 37M/346M[INFO] ------------------------------------------------------------------------$ java -jar demo-app/target/demo-app-0.0.1-SNAPSHOT.jar . . .2016-12-07 22:08:02.937  INFO 72316 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)2016-12-07 22:08:02.942  INFO 72316 --- [           main] net.lipecki.demo.DemoApplication         : Started DemoApplication in 2.681 seconds (JVM running for 3.077)$ curl http://localhost:8080/greeting &amp;amp;&amp;amp; echoWelcome!$ curl http://localhost:8080/&amp;lt;!doctype html&amp;gt;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;  &amp;lt;meta charset=&quot;utf-8&quot;&amp;gt;  &amp;lt;title&amp;gt;DemoWeb&amp;lt;/title&amp;gt;  &amp;lt;base href=&quot;/&quot;&amp;gt;  &amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&amp;gt;  &amp;lt;link rel=&quot;icon&quot; type=&quot;image/x-icon&quot; href=&quot;favicon.ico&quot;&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;  &amp;lt;app-root&amp;gt;Loading...&amp;lt;/app-root&amp;gt;&amp;lt;script type=&quot;text/javascript&quot; src=&quot;inline.bundle.js&quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script type=&quot;text/javascript&quot; src=&quot;styles.bundle.js&quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script type=&quot;text/javascript&quot; src=&quot;vendor.bundle.js&quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script type=&quot;text/javascript&quot; src=&quot;main.bundle.js&quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;Komplet dotychczasowych zmian moÅ¼emy podsumowaÄ‡ w repozytorium GitHub: repozytorium.ObsÅ‚uga routingu z wykorzystaniem history.pushState (html5 url style)Poza samym budowaniem i uruchamianiem aplikacji, warto jeszcze zadbaÄ‡ o wsparcie dla nowych sposobÃ³w nawigacji. CaÅ‚oÅ›Ä‡ moÅ¼na Å‚atwo zrealizowaÄ‡ wykorzystujÄ…c mechanizmy generowania stron bÅ‚Ä™dÃ³w w Springu. Zanim przejdziemy do kodu, kilka sÅ‚Ã³w wprowadzenia teoretycznego.Dotychczas aplikacje web moÅ¼na byÅ‚o Å‚atwo rozpoznaÄ‡ po routingu opartym o #â€¦ w url. Taki sposÃ³b nawigacji nie narzuca Å¼adnych ograniczeÅ„ na stronÄ™ serwerowÄ… aplikacji, jednak tworzy kilka niemoÅ¼liwych do rozwiÄ…zania problemÃ³w, np. renderowanie po stronie serwerowej, czy wsparcie dla SEO.Obecnie, wiÄ™kszoÅ›Ä‡ nowoczesnych przeglÄ…darek dostarcza nowe API history.pushState pozwalajÄ…ce zrealizowaÄ‡ nawigacjÄ™ z pominiÄ™ciem znaku #. Po szczegÃ³Å‚y odsyÅ‚am do oficjalnej dokumentacji Angular, natomiast w kolejnych akapitach zajmiemy siÄ™ konfiguracjÄ… Spring Boot wspierajÄ…cÄ… tÄ™ strategiÄ™.CaÅ‚oÅ›Ä‡ jest o tyle waÅ¼na, Å¼e nawigacja bez # jest zalecanÄ… przez zespÃ³Å‚ Angular 2 konfiguracjÄ…. Przez to jest stosowana zarÃ³wna w dokumentacji, oficjalnym guide oraz wszystkich szablonach projektÃ³w, w tym rÃ³wnieÅ¼ Angular CLI. To jednak oznacza, Å¼e do serwera usÅ‚ug bÄ™dÄ… generowane Å¼Ä…dania oparte o Å›cieÅ¼ki, ktÃ³re fizycznie nie sÄ… nigdzie zdefiniowane, co zakoÅ„czy siÄ™ bÅ‚Ä™dami 404. W tej sytuacji, bez dostosowania naszego projektu, nie bÄ™dziemy w stanie w ogÃ³le uruchomiÄ‡ aplikacji oferujÄ…cej nawigacjÄ™ opartÄ… o routing.W zaÅ‚oÅ¼eniu przedstawiony problem moÅ¼emy uproÅ›ciÄ‡ do zwracania treÅ›ci index.html zawsze wtedy, kiedy standardowo zwrÃ³cilibyÅ›my bÅ‚Ä…d 404. RozwiÄ…zanie powinno uwzglÄ™dniaÄ‡ zarÃ³wno istnienie zdefiniowanych w aplikacji mapowaÅ„, jak i pobieranie zasobÃ³w dostÄ™pnych w lokalizacjach zasobÃ³w statycznych.Najprostszym rozwiÄ…zaniem jest zdefiniowanie wÅ‚asnego ErrorViewResolver, ktÃ³ry dla bÅ‚Ä™dÃ³w 404 wykona przekierowanie na zasÃ³b /index.html.W tym celu dodajemy do kontekstu beana customErrorViewResolver, ktÃ³ry wszystkie Å¼Ä…dania standardowo zwracajÄ…c HttpStatus.NOT_FOUND przekieruje na index.html.@Beanpublic ErrorViewResolver customErrorViewResolver() {  final ModelAndView redirectToIndexHtml = new ModelAndView(&quot;forward:/index.html&quot;, Collections.emptyMap(), HttpStatus.OK);    return (request, status, model) -&amp;gt; status == HttpStatus.NOT_FOUND ? redirectToIndexHtml : null;}Przy takim podejÅ›ciu warto zadbaÄ‡ o to, Å¼eby zawsze jakiÅ› index.html mÃ³gÅ‚ siÄ™ rozwiÄ…zaÄ‡!SposÃ³b wprowadzenia zmiany moÅ¼na przeÅ›ledziÄ‡ w commicie GitHub: 57149a4.Wykorzystanie wÅ‚asnego ErrorViewResolver dodatkowo zapewnia nam wsparcie dla rozrÃ³Å¼niania Å¼Ä…daÅ„ na podstawie nagÅ‚Ã³wka HTTP produces. To znaczy, Å¼e Å¼Ä…dania z przeglÄ…darek (zawierajÄ…ce produces = â€œtext/htmlâ€) zostanÄ… obsÅ‚uÅ¼one zawartoÅ›ciÄ… zasobu /index.html, natomiast pozostaÅ‚e (np. curl) odpowiedzÄ… standardowym bÅ‚Ä™dem 404.MoÅ¼liwe rozszerzeniaWartym rozwaÅ¼enia rozszerzeniem projektu moÅ¼e byÄ‡ wydzielenie trzeciego moduÅ‚u i dodatkowe podzielenie aplikacji:demo\\-- demo-rest\\-- demo-app\\-- demo-webGdzie moduÅ‚y:  demo-web - zawiera zasoby aplikacji web,  demo-rest - zawiera samodzielnie uruchamialnÄ… aplikacjÄ™ dostarczajÄ…cÄ… komplet usÅ‚ug REST,  demo-app - jest zÅ‚Ä…czeniem moduÅ‚Ã³w web i rest w jeden wykonywalny artefakt.Przy takim podziale uzyskujemy duÅ¼Ä… separacjÄ™ pomiÄ™dzy moduÅ‚ami. CzÄ™Å›Ä‡ backend odpowiedzialna ze udostÄ™pnienie usÅ‚ug REST i jest caÅ‚kowicie niezaleÅ¼na od moduÅ‚u demo-web. ModuÅ‚ demo-web takÅ¼e nie ma Å¼adnej zaleÅ¼noÅ›ci. To oznacza, Å¼e moÅ¼emy je rozwijaÄ‡, wersjonowaÄ‡ oraz osadzaÄ‡ rozdzielnie. Dodatkowo wprowadzenie moduÅ‚u app pozwala pisaÄ‡ usÅ‚ugi REST w oderwaniu od produkcyjnego osadzania, np. moÅ¼liwe jest lokalne uruchamianie moduÅ‚u demo-rest jako fat jar z Jetty, podczas gdy produkcyjnie moduÅ‚ demo-app bÄ™dzie osadzany jako war na Tomcat.Codzienna praca z aplikacjÄ…PeÅ‚niÄ™ moÅ¼liwoÅ›ci duetu Spring Boot i Angular CLI poczujemy dopiero odpowiednio przygotowujÄ…c Å›rodowisko codziennej pracy.CzÄ™Å›Ä‡ klienckÄ… uruchamiamy przez ng serve, dziÄ™ki temu dostajemy kompilacjÄ™ i budowanie aplikacji po kaÅ¼dej zmianie kodÃ³w ÅºrÃ³dÅ‚owych oraz dodatkowo powiadomienia live reload i odÅ›wieÅ¼anie aplikacji w przeglÄ…darce. CzÄ™Å›Ä‡ serwerowÄ… uruchamiamy w IDE wspierajÄ…cym hot swap kodÃ³w.Przy takiej konfiguracji aplikacja webowa jest dostÄ™pna na porcie 4200, a backend REST na porcie 8080. Musimy jeszcze umoÅ¼liwiÄ‡ dostÄ™p do usÅ‚ug REST w sposÃ³b identyczny z docelowym, w tym celu na porcie 4200 skonfigurujemy proxy do usÅ‚ug.Dla wygody konfiguracji przenosimy wystawione usÅ‚ugi pod prefix /api i tworzymy plik mapowaÅ„ proxy w demo-web/proxy.conf.json:{  &quot;/api&quot;: {    &quot;target&quot;: &quot;http://localhost:8080&quot;,    &quot;secure&quot;: false  }}We wszystkich zdefiniowanych adnotacjach @RequestMapping dopisaÅ‚em prefix /api w mapowanym url.CzÄ™Å›Ä‡ serwerowÄ… uruchamiamy w IDE (lub dowolny inny sposobÃ³w), natomiast czÄ™Å›Ä‡ web uruchamiamy przez Angular CLI:$ ng serve --proxy-config proxy.conf.json . . .webpack: bundle is now VALID.$ curl http://localhost:8080/api/greeting &amp;amp;&amp;amp; echoWelcome!$ curl http://localhost:4200/api/greeting &amp;amp;&amp;amp; echoWelcome!Dodakowo konfiguracjÄ™ uruchomienia wspierajÄ…cÄ… proxy usÅ‚ug warto zdefiniowaÄ‡ w pliku package.json, w sekcji scripts modyfikujemy polecenie skrypt start:&quot;scripts&quot;: {  &quot;start&quot;: &quot;ng serve --proxy-config proxy.conf.json&quot;,}DziÄ™ki temu nie musimy pamiÄ™taÄ‡ przeÅ‚Ä…czikÃ³w i parametrÃ³w, a caÅ‚oÅ›Ä‡ moÅ¼emy uruchamiaÄ‡ jednym poleceniem:$ npm start . . .webpack: bundle is now VALID.W ten sposÃ³b pracujemy z aplikacjÄ… wystawionÄ… pod adresem http://localhost:4200/, a wszystkie zmiany w czÄ™Å›ci serwerowej i webowej moÅ¼emy mieÄ‡ odÅ›wieÅ¼ane na bieÅ¼Ä…co, zaraz po ich wprowadzeniu.Commit opisujÄ…cy wprowadzone zmiany.PodsumowanieJeÅ¼eli na co dzieÅ„ pracujesz z projektami opartymi o Spring Boot i Maven ich integracja z aplikacjami pisanymi w Angular CLI nie bÄ™dzie stanowiÄ‡ duÅ¼ego wyzwania. W podstawowej realizacji pomoÅ¼e Ci plugin maven-frontend-plugin, natomiast wykorzystujÄ…c dodatkowo maven-assembly-plugin i maven-dependency-plugin moÅ¼liwe jest przygotowanie duÅ¼o bardziej zÅ‚oÅ¼onych procesÃ³w budowania aplikacji.OstatecznÄ… wersjÄ™ aplikacji moÅ¼emy obejrzeÄ‡ na GitHub: demo@github.Na sam koniec chciaÅ‚bym podziÄ™kowaÄ‡ Krysi, Jackowi i Marcinowi. Bez Was nie byÅ‚oby tego wpisu, dziÄ™ki!MateriaÅ‚y  https://github.com/glipecki/spring-with-angular-cli-demo  http://www.consdata.pl/blog/7-szybki-start-z-angular-cli  https://angular.io/docs/ts/latest/guide/router.html#!#browser-url-styles  http://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/htmlsingle/#common-application-properties",
"url": "/2017/01/05/budowanie-aplikacji-angular-cli-spring-boot.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2017-01-05-budowanie-aplikacji-angular-cli-spring-boot/angular-spring-boot.jpeg",
"date": "05-01-2017",
"path": "pl/2017-01-05-budowanie-aplikacji-angular-cli-spring-boot"
}
,


"2016-12-22-hystrix-praktyczne-uzycie-circuit-breakera-html": {
"title": "Hystrix - praktyczne uÅ¼ycie circuit breaker'a",
"lang": "pl",
"tags": "hystrix circuit breaker",
"content": "Awaria:Do katastrofy prowadzi czÄ™sto splot rÃ³Å¼nych czynnikÃ³w, ktÃ³re w pojedynkÄ™ nie stanowiÄ… wiÄ™kszego zagroÅ¼enia. WymieÅ„my wiÄ™c:  system, z ktÃ³rym siÄ™ komunikujemy miewa od czasu do czasu dÅ‚ugi czas odpowiedzi - no, cÃ³Å¼ zdarza siÄ™, cztery dziewiÄ…tki to wciÄ…Å¼ 0,01% moÅ¼liwych faili, przy 0.5 miliona requestÃ³w dziennie, wychodzi jakieÅ› 5000 - rozwiÄ…zanie: dÅ‚uÅ¼sze timeouty;  zdarzajÄ… siÄ™ dÅ‚uÅ¼sze przerwy, np. system nie dziaÅ‚a parÄ™ minut - brak bezprzerwowych wdroÅ¼eÅ„, problemy ze stabilnoÅ›ciÄ… Å›rodowiska - pÃ³ki nie wpÅ‚ywa to bezpoÅ›rednio na user experience jest do ogrania, np. za pomocÄ… kolejek;  ograniczona liczba wÄ…tkÃ³w w kontenerze aplikacji - sprzÄ™t kosztuje czy to w chmurze czy we wÅ‚asnej serwerowni.CaÅ‚kiem prawdopodobny scenariusz awarii: System zewnÄ™trzny przestaje odpowiadaÄ‡. Z racji tego, Å¼e timeouty mamy dosyÄ‡ wysokie do obsÅ‚ugi rosnÄ…cej liczby requestÃ³w w naszej aplikacji przydzielane sÄ… kolejne wÄ…tki kontenera. Dochodzimy do momentu, w ktÃ³rym wszystkie wÄ…tki sÄ… w uÅ¼yciu (np. w Tomcacie domyÅ›lnie jest 100). JeÅ¼eli w tym samym kontenerze dziaÅ‚ajÄ… inne usÅ‚ugi to obsÅ‚uga requesta w kaÅ¼dej z nich czeka na wolny wÄ…tek. Co za tym idzie wywoÅ‚ania usÅ‚ug, ktÃ³re do tej pory odpowiadaÅ‚y bardzo szybko i nie potrzebujÄ… do swojego dziaÅ‚ania systemu zewnÄ™trznego sÄ… de facto od niego zaleÅ¼ne. Awaria wystÄ™puje dosyÄ‡ szybko do wykorzystania 100 wÄ…tkÃ³w wystarczy ruch 50 requestÃ³w/s i timeout 2000 ms.PoniÅ¼ej filmik z przykÅ‚adowego scenariusza takiej awarii. W lewym oknie widzimy czasy odpowiedzi aplikacji niezaleÅ¼nej od systemu zewnÄ™trznego, w prawej aplikacja korzystajÄ…ce z tego systemu z timeoutem 800 ms. W celach przykÅ‚adu liczba wÄ…tkÃ³w serwera webowego zostaÅ‚a ograniczona do piÄ™ciu. W 25 sekundzie zewnÄ™trzny system zostaje wyÅ‚Ä…czony. Aplikacja korzystajÄ…ca z niego, co zrozumiaÅ‚e zwiÄ™ksza czasy odpowiedzi do 800 ms. Niestety z powodu zajÄ™toÅ›ci wÄ…tkÃ³w serwera aplikacja niezaleÅ¼Ä…ca od zewnÄ™trznego systemu (lewe okno) zwiÄ™ksza czasy odpowiedzi z 12 ms do prawie 50 ms. Czyli czas odpowiedzi wydÅ‚uÅ¼a siÄ™ 4 krotnie.Czy moÅ¼na jakoÅ› takiej sytuacji zaradziÄ‡? Co chcielibyÅ›my osiÄ…gnÄ…Ä‡?PrÃ³ba ograniczenia skutkÃ³w:Po pierwsze: SprÃ³bujmy ograniczyÄ‡ propagacjÄ™ awarii na pozostaÅ‚e komponenty systemu. Skoro system zewnÄ™trzny nie odpowiada w przewidzianym przez nas czasie nie ma sensu bombardowania go kolejnymi requestami. MoÅ¼e jeÅ¼eli damy mu trochÄ™ czasu dojdzie do Å‚adu. ZaÅ‚Ã³Å¼my, Å¼e system nie dziaÅ‚a i nie czekajmy 800 ms na odpowiedÅº. Co jakiÅ› czas sprawdÅºmy czy czasem nie wstaÅ‚.Taki model dziaÅ‚ania realizuje circuit breaker opisany przez Martina Fowlera. ImplementacjÄ™ moÅ¼emy znaleÅºÄ‡ np. w hystrixie, bibliotece wchodzÄ…cej w skÅ‚ad stacka Netflixâ€™a.W testowanym przykÅ‚adzie posÅ‚ugujemy siÄ™ prostÄ… spring bootâ€™owÄ… aplikacjÄ… skÅ‚adajÄ…cÄ… siÄ™ z kontrolera:package pl.consdata.hystrix.example.hystrixservice;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;@RestControllerpublic class RandomGeneratorController {    private final RandomGeneratorServiceClient randomGeneratorServiceClient;    public RandomGeneratorController(RandomGeneratorServiceClient randomGeneratorServiceClient) {        this.randomGeneratorServiceClient = randomGeneratorServiceClient;    }    @RequestMapping(&quot;/random&quot;)    String getRandom() throws InterruptedException {        return randomGeneratorServiceClient.getRandom();    }}klienta serwisu zewnÄ™trznego:package pl.consdata.hystrix.example.hystrixservice;import org.springframework.cloud.netflix.feign.FeignClient;import org.springframework.web.bind.annotation.RequestMapping;@FeignClient(name = &quot;random-generator-service&quot;, url = &quot;http://localhost:8080&quot;)public interface RandomGeneratorServiceClient {    @RequestMapping    String getRandom();}Sama klasa aplikacji spring boot wyglÄ…da tak:package pl.consdata.hystrix.example.hystrixservice;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.netflix.feign.EnableFeignClients;@EnableFeignClients@SpringBootApplicationpublic class HystrixApplication {    public static void main(String[] args) throws Exception {        SpringApplication.run(HystrixApplication.class, args);    }}UÅ¼ywamy klienta Feign pochodzÄ…cego rÃ³wnieÅ¼ z biblioteki Netflixa. Feign zawiera w sobie wiele predefiniowanych konfiguracji co znacznie upraszcza powstajÄ…cy kod, aczkolwiek czasami utrudnia nieco zrozumienie co siÄ™ dzieje w programie ;-) - szczegÃ³Å‚y poniÅ¼ej.W przykÅ‚adowej aplikacji potrzebny jest jeszcze plik application.properties zawierajÄ…cy nastÄ™pujÄ…ce ustawienia:server.port=8090                #zmiana portu serwera webowegofeign.hystrix.enabled=false     #wyÅ‚Ä…czenie domyÅ›lnej konfiguracji hystrixaserver.tomcat.max-threads=5     #ograniczenie liczby wÄ…tkÃ³w serwera dla celÃ³w naukowych (NIE UÅ»YWAJ NA PRODUKCJI!!!)Dodajemy circuit breakerâ€™a:Aby dodaÄ‡ circuit breakera do naszej aplikacji naleÅ¼y:  DodaÄ‡ klasÄ™ opakowujÄ…cÄ… klienta serwisu zewnÄ™trznego komendÄ… hystrixowÄ… (adnotacje dostarczane sÄ… przez bibliotekÄ™ javanica):      package pl.consdata.hystrix.example.hystrixservice;  import org.springframework.beans.factory.annotation.Autowired;  import org.springframework.stereotype.Service;  import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;  @Service  public class RandomGeneratorServiceClientHystrixAware {      final private RandomGeneratorServiceClient randomGeneratorServiceClient;      @Autowired      public RandomGeneratorServiceClientHystrixAware(RandomGeneratorServiceClient randomGeneratorServiceClient) {          this.randomGeneratorServiceClient = randomGeneratorServiceClient;      }      @HystrixCommand(commandKey = &quot;randomCommand&quot;)      public String getRandom() {          return randomGeneratorServiceClient.getRandom();      }  }        W kontrolerze zastÄ…piÄ‡ wywoÅ‚ania RandomGeneratorServiceClientâ€™a wywoÅ‚aniami RandomGeneratorServiceClientHystrixAware:      package pl.consdata.hystrix.example.hystrixservice;  import org.springframework.web.bind.annotation.RequestMapping;  import org.springframework.web.bind.annotation.RestController;  @RestController  public class RandomGeneratorController {      private final RandomGeneratorServiceClientHystrixAware randomGeneratorServiceClient;      public RandomGeneratorController(RandomGeneratorServiceClientHystrixAware randomGeneratorServiceClient) {          this.randomGeneratorServiceClient = randomGeneratorServiceClient;      }      @RequestMapping(&quot;/random&quot;)      String getRandom() throws InterruptedException {          return randomGeneratorServiceClient.getRandom();      }  }        DodaÄ‡ adnotacjÄ™ @EnableCircuitBreaker do konfiguracji aplikacji:      package pl.consdata.hystrix.example.hystrixservice;  import org.springframework.boot.SpringApplication;  import org.springframework.boot.autoconfigure.SpringBootApplication;  import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;  import org.springframework.cloud.netflix.feign.EnableFeignClients;  @EnableCircuitBreaker  @EnableFeignClients  @SpringBootApplication  public class HystrixApplication {      public static void main(String[] args) throws Exception {          SpringApplication.run(HystrixApplication.class, args);      }  }        DodaÄ‡ konfiguracjÄ™ hystrixa w pliku application.properties:      server.port=8090  feign.hystrix.enabled=false  server.tomcat.max-threads=5  hystrix.command.randomCommand.execution.isolation.thread.timeoutInMilliseconds=800  #timeout komendy hystrixowej &quot;randomCommand&quot; zdefinowanej w klasie RandomGeneratorServiceClientHystrixAware adnotacjÄ… @HystrixCommand(commandKey = &quot;randomCommand&quot;)  hystrix.command.randomCommand.circuitBreaker.requestVolumeThreshold=10              #liczba requestÃ³w, dla ktÃ³rych musi wystÄ…piÄ‡ timeout w 10 sekundowym oknie, aby circuit breaker otworzyÅ‚ obwÃ³d  hystrix.command.randomCommand.metrics.rollingStats.timeInMilliseconds=10000         #czas okna, w ktÃ³rym zliczane sÄ… bÅ‚Ä™dne requesty        DodaÄ‡ zaleÅ¼noÅ›Ä‡ na biblioteki hystrixowe:      &amp;lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&amp;gt;      &amp;lt;modelVersion&amp;gt;4.0.0&amp;lt;/modelVersion&amp;gt;      &amp;lt;groupId&amp;gt;pl.consdata.hystrix.example&amp;lt;/groupId&amp;gt;      &amp;lt;artifactId&amp;gt;hystrixservice&amp;lt;/artifactId&amp;gt;      &amp;lt;version&amp;gt;1.0-SNAPSHOT&amp;lt;/version&amp;gt;      &amp;lt;dependencies&amp;gt;          &amp;lt;dependency&amp;gt;              &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;              &amp;lt;artifactId&amp;gt;spring-boot-starter-web&amp;lt;/artifactId&amp;gt;          &amp;lt;/dependency&amp;gt;          &amp;lt;dependency&amp;gt;              &amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;              &amp;lt;artifactId&amp;gt;spring-cloud-starter-feign&amp;lt;/artifactId&amp;gt;              &amp;lt;version&amp;gt;1.2.2.RELEASE&amp;lt;/version&amp;gt;          &amp;lt;/dependency&amp;gt;          &amp;lt;dependency&amp;gt;              &amp;lt;groupId&amp;gt;org.springframework.cloud&amp;lt;/groupId&amp;gt;              &amp;lt;artifactId&amp;gt;spring-cloud-starter-hystrix&amp;lt;/artifactId&amp;gt;              &amp;lt;version&amp;gt;1.2.3.RELEASE&amp;lt;/version&amp;gt;          &amp;lt;/dependency&amp;gt;      &amp;lt;/dependencies&amp;gt;      &amp;lt;dependencyManagement&amp;gt;          &amp;lt;dependencies&amp;gt;              &amp;lt;dependency&amp;gt;                  &amp;lt;groupId&amp;gt;org.springframework.boot&amp;lt;/groupId&amp;gt;                  &amp;lt;artifactId&amp;gt;spring-boot-dependencies&amp;lt;/artifactId&amp;gt;                  &amp;lt;version&amp;gt;1.4.2.RELEASE&amp;lt;/version&amp;gt;                  &amp;lt;type&amp;gt;pom&amp;lt;/type&amp;gt;                  &amp;lt;scope&amp;gt;import&amp;lt;/scope&amp;gt;              &amp;lt;/dependency&amp;gt;          &amp;lt;/dependencies&amp;gt;      &amp;lt;/dependencyManagement&amp;gt;  &amp;lt;/project&amp;gt;      PoniÅ¼szy film pokazuje jak zachowuje siÄ™ zmodyfikowana aplikacja. W lewym oknie czas odpowiedzi aplikacji niekorzystajÄ…cej z systemu zewnÄ™trznego. W prawej tak jak poprzednio czasy aplikacji korzystajÄ…cej z tego systemu.W 20 sekundzie filmu wyÅ‚Ä…czony zostaje system zewnÄ™trzny. Skutkuje to wzrostem czasÃ³w odpowiedzi aplikacji z niego korzystajÄ…cej do 800 ms. Czasy odpowiedzi aplikacji niezaleÅ¼nej rÃ³wnieÅ¼ wzrastajÄ… - do tej pory jeszcze nic siÄ™ nie zmieniÅ‚o wzglÄ™dem pierwotnego zachowania. Po okoÅ‚o 10 sekundach circuit breaker otwiera obwÃ³d i klient od razu odpowiada, Å¼e system jest niedostÄ™pny - czasy wywoÅ‚ania spadajÄ…, czasy wywoÅ‚ania niezaleÅ¼nej aplikacji wracajÄ… do normy. Co jakiÅ› czas widaÄ‡ w prawym oknie nieco dÅ‚uÅ¼sze czasy wywoÅ‚ania - to hystrix sprawdza czy system zewnÄ™trzny jest juÅ¼ dostÄ™pny. OkoÅ‚o 50 sekundy system zewnÄ™trzny zostaje ponownie wÅ‚Ä…czony.PrÃ³ba zachowania funkcjonalnoÅ›ci:Hystrix umoÅ¼liwia nam podjÄ™cie akcji naprawczej w momencie wystÄ…pienia bÅ‚Ä™du. Aby skonfigurowaÄ‡ takÄ… akcjÄ™ naleÅ¼y uzupeÅ‚niÄ‡ pole fallbackMethod w adnotacji HystrixCommand:package pl.consdata.hystrix.example.hystrixservice;import java.util.Random;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;@Servicepublic class RandomGeneratorServiceClientHystrixAware {    final private RandomGeneratorServiceClient randomGeneratorServiceClient;    @Autowired    public RandomGeneratorServiceClientHystrixAware(RandomGeneratorServiceClient randomGeneratorServiceClient) {        this.randomGeneratorServiceClient = randomGeneratorServiceClient;    }    @HystrixCommand(commandKey = &quot;randomCommand&quot;, fallbackMethod = &quot;getRandomFallback&quot;)    public String getRandom() {        return randomGeneratorServiceClient.getRandom();    }    private String getRandomFallback() {        return String.valueOf(new Random().nextInt());    }}W tym przykÅ‚adzie jako fallbackMethod podaliÅ›my metodÄ™ prywatnÄ… getRandomFallback, ktÃ³ra bierze na siebie odpowiedzialnoÅ›Ä‡ generowania liczby losowej. Taka implementacja powoduje, Å¼e kaÅ¼dy request do naszej aplikacji zwrÃ³ci poprawnÄ… odpowiedÅº. Nawet kiedy system zewnÄ™trzny bÄ™dzie niedostÄ™pny. Od chwili wystÄ…pienia awarii do momentu otworzenia obwodu przez circuit breakera czasy odpowiedzi bÄ™dÄ… zbliÅ¼one do timeoutu skonfigurowanego dla systemu zewnÄ™trznego. Po otworzeniu obwodu metoda fallbackowa bÄ™dzie wywoÅ‚ywana od razu - co oznacza, Å¼e czasy wywoÅ‚ania powrÃ³cÄ… do standardowych lub niÅ¼szych wartoÅ›ci.Ciekawostki:Konfiguracja klienta Feign:FeignClient dostarcza wielu standardowych konfiguracji. W zasadzie wystarczy gdy w adnotacji wypeÅ‚nimy pole url. JeÅ¼eli chcemy jednak zmieniÄ‡ jakiÅ› parametr konfiguracji moÅ¼emy uzupeÅ‚niÄ‡ pole configuration podajÄ…c nazwÄ™ klasy zawierajÄ…ca springowÄ… konfiguracjÄ™ beanÃ³w. JeÅ¼eli chcemy np. zmodyfikowaÄ‡ standardowÄ… konfiguracjÄ™ timeoutÃ³w dodajemy beana:@BeanRequest.Options options() {    return new Request.Options(750, 200);}Pierwszy parametr konstruktora to connection timeout, drugi read timeout. DostarczajÄ…c takÄ… konfiguracjÄ™ spodziewalibyÅ›my siÄ™, Å¼e po 750 ms dostaniemy timeout poÅ‚Ä…czenia i tu niespodzianka, â€¦dostaniemy go po 3750 ms. A to dlatego, Å¼e FeignClient zawiera w sobie retryerâ€™a, ktÃ³ry domyÅ›lnie 5 razy powtarza wywoÅ‚anie. Aby to zmieniÄ‡ naleÅ¼y dostarczyÄ‡ w klasie konfiguracji beana:@BeanRetryer.Default retryer() {    return new Retryer.Default(10000L, 3000, 1);}Ostatni parametr to liczba powtÃ³rzeÅ„.Leniwa inicjalizacja komend hystrixa:Zainstancjonowanie komendy hystrixowej odbywa siÄ™ podczas pierwszego jej uÅ¼ycia. MoÅ¼e nieÅ›Ä‡ to ze sobÄ… pewne przykre konsekwencje, gdyÅ¼ inicjalizacja takiej komendy co ciekawe potrafi trwaÄ‡ doÅ›Ä‡ dÅ‚ugo. Hystrix prÃ³buje na rÃ³Å¼ne sposoby ustaliÄ‡ wszystkie parametry komendy (jest ich duÅ¼o). W produkcyjnej konfiguracji zdarzaÅ‚o siÄ™ czas ten wynosiÅ‚ nawet 1000 - 2000 ms. Oznacza to, Å¼e po restarcie serwera czas pierwszego wywoÅ‚ania komendy moÅ¼e siÄ™ znacznie rÃ³Å¼niÄ‡ od kolejnych i moÅ¼e to doprowadziÄ‡ do przekroczenia jakiegoÅ› ustalonego czasu odpowiedzi. ImplementujÄ…c w ten sposÃ³b usÅ‚ugi synchroniczne warto moim zdaniem rozwaÅ¼yÄ‡ wprowadzenie specjalnego â€˜pustegoâ€™ wywoÅ‚ania, ktÃ³re spowoduje zainicjalizowanie krytycznych komend. Takie rozwiÄ…zanie wydaje siÄ™ byÄ‡ nieco infantylne, ale rzeczywiÅ›cie nie ma na to rady.",
"url": "/2016/12/22/hystrix-praktyczne-uzycie-circuit-breakera.html",
"author": "Jakub Wilczewski",
"authorUrl": "/authors/jwilczewski.html",
"image": "jwilczewski.jpg",
"highlight": "/assets/img/posts/2016-12-22-hystrix-praktyczne-uzycie-circuit-breakera/hystrix.jpg",
"date": "22-12-2016",
"path": "pl/2016-12-22-hystrix-praktyczne-uzycie-circuit-breakera"
}
,


"2016-12-08-sonarqube-wprowadzenie-do-statycznej-analizy-kodu-html": {
"title": "Sonarqube - wprowadzenie do statycznej analizy kodu",
"lang": "pl",
"tags": "sonarqube jakoÅ›Ä‡ kodu",
"content": "â€œIt is not enough for code to work.â€ Robert C. Martin, Clean CodePamiÄ™tam jak kilka lat temu z uporem maniaka integrowaÅ‚em biblioteki statycznej analizy kodu do kaÅ¼dego pom.xml, ktÃ³ry wpadÅ‚ w moje rÄ™ce. Do dzisiaj wiele osÃ³b za to mnie szczerze nienawidzi. Modyfikacja pomÃ³w, konfiguracja w repozytorium kaÅ¼dego projektu i dÅ‚ugie instrukcje na wiki zwiÄ…zane z integracjÄ… IDE. PatrzÄ…c z perspektywy czasu przyznajÄ™, Å¼e byÅ‚o to doÅ›Ä‡ pracochÅ‚onne przedsiÄ™wziÄ™cie. Na szczÄ™Å›cie pojawiÅ‚o siÄ™ narzÄ™dzie, ktÃ³re nie tylko uproÅ›ciÅ‚o proces statycznej analizy kodu, ale takÅ¼e znacznie tÄ™ analizÄ™ upowszechniÅ‚o.KonfiguracjaSonarQube, bo o nim mowa, powstaÅ‚ jako system do integracji raportÃ³w z rÃ³Å¼nych bibliotek i wizualizacji wynikÃ³w. TwÃ³rcy byli rozczarowani tempem zmian w popularnych bibliotekach statycznej analizy kodu, dlatego zaczÄ™li na wÅ‚asnÄ… rÄ™kÄ™ przygotowywaÄ‡ zestaw reguÅ‚, ktÃ³re ich zdaniem powinien speÅ‚niaÄ‡ dobry kod. W wyniku tego procesu dostaliÅ›my kompleksowe narzÄ™dzie do zbierania analiz i raportowania jakoÅ›ciowych zmian projektu w czasie.W erze przeddokerowej, takie wprowadzenie zajÄ™Å‚oby pewnie kilka ekranÃ³w poleceÅ„ i czynnoÅ›ci konfiguracyjnych. Ja pokaÅ¼Ä™, Å¼e caÅ‚y proces konfiguracji i pierwszego uÅ¼ycia moÅ¼na zamknÄ…Ä‡ w 4 poleceniach, z ktÃ³rych jedno to zmiana bieÅ¼Ä…cego katalogu.ÅšciÄ…gniÄ™cie i uruchomienie serwera w domyÅ›lnej konfiguracji osiÄ…gniemy wydajÄ…c polecenie:docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqubeNastÄ™pnie potrzebujemy projekt, ktÃ³ry poddamy analizie. Dla celÃ³w pokazowych weÅºmy szkielet aplikacji, ktÃ³ry kaÅ¼dy z nas niejednokrotnie uÅ¼yÅ‚:mvn archetype:generate    -DgroupId=com.mycompany.app    -DartifactId=my-app    -DarchetypeArtifactId=maven-archetype-quickstart    -DinteractiveMode=falseNa koniec pozostaje nam zmieniÄ‡ katalog i uruchomiÄ‡ analizÄ™:cd my-appmvn sonar:sonar(Ostatnie polecenie zadziaÅ‚a w takiej formie wyÅ‚Ä…cznie na systemach operacyjnych, w ktÃ³rych Docker uruchamiany jest natywnie, czyli na chwilÄ™ powstawania tego wpisu Linux i Windows 10. W pozostaÅ‚ych przypadkach konieczne jest przekazanie w parametrach namiarÃ³w na Dockera ukrytego pod warstwÄ… wirtualizacji. WiÄ™cej szczegÃ³Å‚Ã³w znajdziecie w linkach zaÅ‚Ä…czonych na koÅ„cu wpisu.)Po zakoÅ„czeniu przechodzimy na stronÄ™ localhost:9000 i powinniÅ›my zobaczyÄ‡ gotowy raport. Tym, co nas na poczÄ…tku najbardziej interesuje sÄ… smrodki znalezione w kodzie czyli Code Smells:Code Smells w interfejsie SonarQubeJak moÅ¼emy zobaczyÄ‡, w tak niewielkim fragmencie kodu, SonarQube namierzyÅ‚ aÅ¼ trzy naruszenia! NawigujÄ…c po interfejsie moÅ¼emy przeanalizowaÄ‡ okolicznoÅ›ci, w jakich zostaÅ‚o wprowadzone kaÅ¼de naruszenie oraz zapoznaÄ‡ siÄ™ z bardzo szczegÃ³Å‚owÄ… dokumentacjÄ…. KaÅ¼dy zdiagnozowany problem ma nie tylko opisanÄ… przyczynÄ™ zakwalifikowania go jako Code Smell, ale takÅ¼e przykÅ‚ady i instrukcje, jak takie naruszenie moÅ¼na z kodu wyeliminowaÄ‡. I to wÅ‚aÅ›nie tutaj ukryte sÄ… niezgÅ‚Ä™bione pokÅ‚ady wiedzy na temat filozofii czystego kodu.NaleÅ¼y w tym momencie zaznaczyÄ‡, Å¼e przedstawiona powyÅ¼ej metoda jest odpowiednia do lokalnej metody analizy kodu. JeÅ›li zdecydujemy siÄ™ wdroÅ¼yÄ‡ w projekcie SonarQube jako narzÄ™dzie uÅ¼ywane przez wielu programistÃ³w, warto poÅ›wieciÄ‡ trochÄ™ czasu i dokonfigurowaÄ‡ takie elementy jak uwierzytelnianie, autoryzacja oraz dedykowana baza danych.Åšrodowisko developerskiePrzeglÄ…danie raportÃ³w i statystyk projektu pozostawmy jednak w gestii managerÃ³w. To, czego potrzebujÄ… programiÅ›ci, to integracji na poziomie Å›rodowiska IDE moÅ¼liwie jak najbliÅ¼ej kodu. I tutaj z pomocÄ… przychodzi nam plugin SonarLint, dostÄ™pny na wszystkie liczÄ…ce siÄ™ Å›rodowiska programistyczne. Wystarczy, Å¼e wskaÅ¼emy mu serwer:PowiÄ…Å¼emy bieÅ¼Ä…cy projekt z projektem zaÅ‚oÅ¼onym na serwerze:JeÅ›li integracja przebiegnie poprawnie, wszystkie naruszenia na serwerze powinny zostaÄ‡ naniesione na plik otwarty w edytorze:I to w zasadzie wszystko co jest nam potrzebne, aby zaczÄ…Ä‡ przygodÄ™ ze statycznÄ… analizÄ… kodu ÅºrÃ³dÅ‚owego naszych aplikacji.Uncle Bob nieprzypadkowo pojawiÅ‚ siÄ™ na poczÄ…tku tego wpisu. Opisywane tutaj narzÄ™dzia sÄ… naturalnym rozszerzeniem idei czystego kodu. Grzegorz Huber, kolega z pracy, podzieliÅ‚ siÄ™ ze mnÄ… bardzo trafnÄ… uwagÄ… - SonarQube w IDE to prawie tak, jak Uncle Bob siedzÄ…cy na krzeseÅ‚ku obok.PodsumowanieZachÄ™cam kaÅ¼dego, aby uruchomiÅ‚ lokalnie SonarQube i przeskanowaÅ‚ swoje projekty (o ile jeszcze tego nie robi). Wiedza, jaka pÅ‚ynie z takiej operacji jest nie do przecenienia. JeÅ¼eli zainteresuje was ten sposÃ³b analizy kodu, warto zgÅ‚Ä™biÄ‡ inne funkcjonalnoÅ›ci jakie posiada SonarQube. Znajdziemy tam miÄ™dzy innymi:  analizÄ™ pokrycia kodu testami  wykrywanie copyâ€™nâ€™paste  zÅ‚oÅ¼onoÅ›Ä‡ cyklomatycznÄ…Bibliografia  Robert C. Martin, Clean Code.  https://hub.docker.com/_/sonarqube/  https://about.sonarqube.com/get-started/",
"url": "/2016/12/08/sonarqube-wprowadzenie-do-statycznej-analizy-kodu.html",
"author": "Jacek Grobelny",
"authorUrl": "/authors/jgrobelny.html",
"image": "jgrobelny.jpg",
"highlight": "/assets/img/posts/2016-12-08-sonarqube-wprowadzenie-do-statycznej-analizy-kodu/sonarqube.png",
"date": "08-12-2016",
"path": "pl/2016-12-08-sonarqube-wprowadzenie-do-statycznej-analizy-kodu"
}
,


"2016-08-31-szybki-start-z-angular-cli-html": {
"title": "Szybki start z Angular CLI",
"lang": "pl",
"tags": "angular",
"content": "Wydanie stabilnej wersji Angular 2 to idealny moment, Å¼eby zaczÄ…Ä‡ swojÄ… przygodÄ™ z tym frameworkiem. Nie ma lepszego sposobu na poznanie nowej technologii niÅ¼ skok na gÅ‚Ä™bokÄ… wodÄ™ i rozpoczÄ™cie zabawy z kodem ğŸ˜‰CzÄ™stym problemem przy pierwszym zetkniÄ™ciu z nowÄ… technologiÄ… jest wysoki prÃ³g wejÅ›cia zwiÄ…zany z przygotowaniem Å›rodowiska, projektu, czy teÅ¼ samym uruchomieniem i testowaniem. Mimo Å¼e samodzielne stworzenie projektu, przygotowanie caÅ‚ej konfiguracji i uruchomienie pierwszego buildu to Å›wietna przygoda, tym razem skorzystamy z narzÄ™dzia Angular CLI i uruchomimy caÅ‚oÅ›Ä‡ w kilka minut.W ramach artykuÅ‚u dowiesz siÄ™:  jak stworzyÄ‡ od zera projekt aplikacji webowej opartej o Angular 2,  jak budowaÄ‡ i pracowaÄ‡ z projektem,  jak szybko tworzyÄ‡ skÅ‚adowe elementy projektu nie powtarzajÄ…c tworzenia boilerplate.Przed przeczytaniem artykuÅ‚u warto mieÄ‡ zgrubne pojÄ™cie o konceptach frameworka: https://angular.io/docs/ts/latest/guide/architecture.htmlUtworzenie projektuDo dziaÅ‚ania angular-cli potrzebujemy zainstalowanego nodeâ€™a (&amp;gt;= 4.x.x) z npmâ€™em (&amp;gt;= 3.x.x). Samo cli najÅ‚atwiej zainstalowaÄ‡ globalnie:npm install -g angular-cliTworzymy nowy projekt, dodatkowo wskazujÄ…c preprocesor CSSÃ³w â€“ scss:ng new sample-cli --style=scssWszystkie kolejne operacje cli wykonujemy bÄ™dÄ…c w katalogu projektu.Uruchamiamy projekt w trybie developerskim:ng serveAplikacja standardowo wystawia siÄ™ na localhost na porcie 4200:W kilku krokach dostajemy gotowy szkielet aplikacji, gotowy do rozwoju i dystrybucji.DziÄ™ki Angular CLI dostajemy za darmo:  kompletny szkielet aplikacji  dziaÅ‚ajÄ…cy projekt ze skonfigurowanÄ… najnowszÄ… wersjÄ… Angulara  kompletne skrypty budujÄ…ce z moÅ¼liwoÅ›ciÄ…  uruchomienia buildu produkcyjnego  uruchomienia aplikacji w trybie developerskim  uruchomienia testÃ³w jednostkowych i testÃ³w e2e  wsparcie dla kompilowania budowania CSSâ€™Ã³w na bazie scss/sass/less/stylusW tym zaawansowane techniki budowania aplikacji:  bundlowanie kodu, w tym obsÅ‚uga podziaÅ‚u na czÄ™Å›ci wspÃ³lne i Å‚adowane asynchronicznie  tree-shaking  uglifyingStruktura projektuWygenerowany szablon pozwala pracowaÄ‡ nad kompletnÄ… aplikacjÄ… webowÄ…. W poszczegÃ³lnych folderach znajdujÄ… siÄ™ ÅºrÃ³dÅ‚a aplikacji (kody TypeScript, htmlâ€™e i stylizacje), pliki testÃ³w (w tym e2e) oraz zasoby statyczne serwowane as-is w docelowej aplikacji.Punktem wejÅ›cia aplikacji sÄ… src/index.html oraz src/main.ts, ktÃ³rych celem jest zaÅ‚adowanie strony i osadzenie gÅ‚Ã³wnego komponentu naszej aplikacji zdefiniowanego w src/app/app.component.ts. Od tego ostatniego zaczynamy swojÄ… przygodÄ™ z frameworkiem.Generowanie kodu i praca z CLIAngular CLI, poza wygenerowaniem i budowaniem projektu, pomaga teÅ¼ w codziennej pracy, zdejmujÄ…c z programisty typowe zadania zwiÄ…zane z boilerplate.Automatycznie wygenerujemy szablony dla wszystkich skÅ‚adowych frameworka:  komponenty (component),  dyrektywy (directive),  pipeâ€™y (pipe),  seriwisy (service),  klasy i interfejsy (class, interface),  enumy (enum),  moduÅ‚y (module).UÅ¼ycie generatora pozwala szybko stworzyÄ‡ komplet zasobÃ³w.PrzykÅ‚adowo stworzenie nowego komponentu wygeneruje dla nas:  klasÄ™ komponentu (*.ts)  szablon html komponentu (*.html)  plik stylizacji komponentu (*.html)  plik z testami komponentu (*.spec.ts)  podpiÄ™cie komponentu pod moduÅ‚ aplikacjiTak wygenerowany komponent jest gotowy do uÅ¼ycia bez dodatkowych modyfikacji:ng generate component TodoListRÃ³wnie Å‚atwo moÅ¼emy stworzyÄ‡ serwis:ng generate service TodoNowo stworzone serwisy nie sÄ… standardowo podpinane pod Å¼aden moduÅ‚. MoÅ¼na to jednak Å‚atwo zrobiÄ‡, np. podpinajÄ…c w gÅ‚Ã³wnym module aplikacji, w pliku src/app/app.module.ts:import { BrowserModule } from &#39;@angular/platform-browser&#39;;import { NgModule } from &#39;@angular/core&#39;;import { FormsModule } from &#39;@angular/forms&#39;;import { HttpModule } from &#39;@angular/http&#39;;import { AppComponent } from &#39;./app.component&#39;;import { TodoListComponent } from &#39;./todo-list/todo-list.component&#39;;import { TodoService } from &#39;./todo.service&#39;;@NgModule({  declarations: [    AppComponent,    TodoListComponent  ],  imports: [    BrowserModule,    FormsModule,    HttpModule  ],  providers: [TodoService],  bootstrap: [AppComponent]})export class AppModule { }W podobny sposÃ³b moÅ¼emy tworzyÄ‡ pozostaÅ‚e elementy aplikacji, zrzucajÄ…c na narzÄ™dzie tworzenie zasobÃ³w na podstawie szablonÃ³w.Budowanie projektuWygenerowany projekt moÅ¼na zbudowaÄ‡ w finalnÄ… aplikacjÄ™:ng buildWygenerowane zasoby trafiajÄ… do folderu dist.Budowanie moÅ¼na uruchomiÄ‡ podajÄ…c dodatkowo profil. Standardowo budowana jest developerska wersja aplikacji. JeÅ¼eli chcemy zbudowaÄ‡ produkcyjnÄ… aplikacjÄ™, wykorzystujÄ…cÄ… uglifying i tree-shaking, powinniÅ›my wskazaÄ‡ profil prod:ng build --prodDodatkowo moÅ¼liwe jest podanie wartoÅ›ci Å›rodowiskowych dla buildu i np. uruchamianie warunkowo szerszego logowania czy teÅ¼ punktÃ³w debugowania. W tym celu moÅ¼na uÅ¼yÄ‡ przeÅ‚Ä…cznika â€“env nazwa.Tak ustawiony profil moÅ¼na wykorzystaÄ‡ na etapie budowania oraz w uruchomionej aplikacji, przykÅ‚adowo:if (environment.production) {  // ...}Uruchomienie testÃ³wZarÃ³wno testy jednostkowe, jak i end-to-end moÅ¼emy spokojnie uruchamiaÄ‡ za pomocÄ… CLI, wszystkie potrzebne konfiguracje sÄ… juÅ¼ dostarczone w ramach wygenerowanego szkieletu aplikacji.Standardowo testy sÄ… uruchamiane w trybie nasÅ‚uchiwania na zmiany, to znaczy Å¼e framework testowy pozostaje uruchomiony w tle i wykonuje zestaw testÃ³w za kaÅ¼dym razem gdy wprowadzimy zmianÄ™ w ÅºrÃ³dÅ‚ach.Å»eby testy uruchomiÄ‡ jednokrotnie naleÅ¼y dodaÄ‡ flagÄ™ â€“watch false.ng test --watch falseTesty funkcjonalne uruchamiamy poleceniem:ng e2ejednak przed ich uruchomieniem naleÅ¼y wczeÅ›niej uruchomiÄ‡ samÄ… aplikacjÄ™, np. przez pokazany juÅ¼ ng serve:ng serve &amp;amp; ng e2ePodsumowanieWykorzystanie narzÄ™dzia typu Angular CLI pozwala nam na:  korzystanie z najnowszych technologii,  ustandaryzowanie struktury i konfiguracji projektu,  zrzucenie utrzymania procesu budowania na community,  szybkie wsparcie dla nowych wersji frameworka przy minimalnym koszcie,  stosowanie wzorcowej/zalecanej konfiguracji,  szybkie uruchamianie nowych projektÃ³w,  stosowanie podejÅ›cia convention over configuration.",
"url": "/2016/08/31/szybki-start-z-angular-cli.html",
"author": "Grzegorz Lipecki",
"authorUrl": "/authors/glipecki.html",
"image": "glipecki.jpg",
"highlight": "/assets/img/posts/2016-08-31-szybki-start-z-angular-cli/start_z_angularem.jpg",
"date": "31-08-2016",
"path": "pl/2016-08-31-szybki-start-z-angular-cli"
}


}
